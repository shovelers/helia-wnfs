(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.ItPipe = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var ItPipe=(()=>{var d=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var P=(n,e)=>{for(var t in e)d(n,t,{get:e[t],enumerable:!0})},_=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let u of A(e))!M.call(n,u)&&u!==t&&d(n,u,{get:()=>e[u],enumerable:!(r=N(e,u))||r.enumerable});return n};var U=n=>_(d({},"__esModule",{value:!0}),n);var q={};P(q,{pipe:()=>V,rawPipe:()=>w});var a=class{constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},l=class{constructor(e={}){this.hwm=e.splitLimit??16,this.head=new a(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new a(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};function f(n={}){return j(t=>{let r=t.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function j(n,e){e=e??{};let t=e.onEnd,r=new l,u,s,o,E=async()=>r.isEmpty()?o?{done:!0}:await new Promise((i,k)=>{s=z=>{s=null,r.push(z);try{i(n(r))}catch(L){k(L)}return u}}):n(r),b=i=>s!=null?s(i):(r.push(i),u),v=i=>(r=new l,s!=null?s({error:i}):(r.push({error:i}),u)),m=i=>{if(o)return u;if(e?.objectMode!==!0&&i?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return b({done:!1,value:i})},c=i=>o?u:(o=!0,i!=null?v(i):b({done:!0})),I=()=>(r=new l,c(),{done:!0}),S=i=>(c(i),{done:!0});if(u={[Symbol.asyncIterator](){return this},next:E,return:I,throw:S,push:m,end:c,get readableLength(){return r.size}},t==null)return u;let h=u;return u={[Symbol.asyncIterator](){return this},next(){return h.next()},throw(i){return h.throw(i),t!=null&&(t(i),t=void 0),{done:!0}},return(){return h.return(),t!=null&&(t(),t=void 0),{done:!0}},push:m,end(i){return h.end(i),t!=null&&(t(i),t=void 0),u},get readableLength(){return h.readableLength}},u}function D(n){return n[Symbol.asyncIterator]!=null}function F(...n){let e=[];for(let t of n)D(t)||e.push(t);return e.length===n.length?function*(){for(let t of e)yield*t}():async function*(){let t=f({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(n.map(async r=>{for await(let u of r)t.push(u)})),t.end()}catch(r){t.end(r)}}),yield*t}()}var y=F;function V(n,...e){if(n==null)throw new Error("Empty pipeline");if(p(n)){let r=n;n=()=>r.source}else if(g(n)||x(n)){let r=n;n=()=>r}let t=[n,...e];if(t.length>1&&p(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let r=1;r<t.length-1;r++)p(t[r])&&(t[r]=W(t[r]));return w(...t)}var w=(...n)=>{let e;for(;n.length>0;)e=n.shift()(e);return e},x=n=>n?.[Symbol.asyncIterator]!=null,g=n=>n?.[Symbol.iterator]!=null,p=n=>n==null?!1:n.sink!=null&&n.source!=null,W=n=>e=>{let t=n.sink(e);if(t?.then!=null){let r=f({objectMode:!0});t.then(()=>{r.end()},o=>{r.end(o)});let u,s=n.source;if(x(s))u=async function*(){yield*s,r.end()};else if(g(s))u=function*(){yield*s,r.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return y(r,u())}return n.source};return U(q);})();
return ItPipe}));
