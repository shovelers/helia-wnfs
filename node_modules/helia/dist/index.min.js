(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Helia = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Helia=(()=>{var gT=Object.create;var Fu=Object.defineProperty;var yT=Object.getOwnPropertyDescriptor;var bT=Object.getOwnPropertyNames;var wT=Object.getPrototypeOf,ET=Object.prototype.hasOwnProperty;var y8=(r=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(r,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):r)(function(r){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});var $e=(r,e)=>()=>(r&&(e=r(r=0)),e);var F=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Pe=(r,e)=>{for(var t in e)Fu(r,t,{get:e[t],enumerable:!0})},b8=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of bT(e))!ET.call(r,i)&&i!==t&&Fu(r,i,{get:()=>e[i],enumerable:!(n=yT(e,i))||n.enumerable});return r};var de=(r,e,t)=>(t=r!=null?gT(wT(r)):{},b8(e||!r||!r.__esModule?Fu(t,"default",{value:r,enumerable:!0}):t,r)),Ku=r=>b8(Fu({},"__esModule",{value:!0}),r);var v1=F((J$,w8)=>{var ia=1e3,sa=ia*60,oa=sa*60,to=oa*24,xT=to*7,vT=to*365.25;w8.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return _T(r);if(t==="number"&&isFinite(r))return e.long?RT(r):ST(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function _T(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*vT;case"weeks":case"week":case"w":return t*xT;case"days":case"day":case"d":return t*to;case"hours":case"hour":case"hrs":case"hr":case"h":return t*oa;case"minutes":case"minute":case"mins":case"min":case"m":return t*sa;case"seconds":case"second":case"secs":case"sec":case"s":return t*ia;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function ST(r){var e=Math.abs(r);return e>=to?Math.round(r/to)+"d":e>=oa?Math.round(r/oa)+"h":e>=sa?Math.round(r/sa)+"m":e>=ia?Math.round(r/ia)+"s":r+"ms"}function RT(r){var e=Math.abs(r);return e>=to?Vu(r,e,to,"day"):e>=oa?Vu(r,e,oa,"hour"):e>=sa?Vu(r,e,sa,"minute"):e>=ia?Vu(r,e,ia,"second"):r+" ms"}function Vu(r,e,t,n){var i=e>=t*1.5;return Math.round(r/t)+" "+n+(i?"s":"")}});var x8=F((eH,E8)=>{function IT(r){t.debug=t,t.default=t,t.coerce=c,t.disable=s,t.enable=i,t.enabled=o,t.humanize=v1(),t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let f=0;for(let h=0;h<u.length;h++)f=(f<<5)-f+u.charCodeAt(h),f|=0;return t.colors[Math.abs(f)%t.colors.length]}t.selectColor=e;function t(u){let f,h=null,d,p;function m(...g){if(!m.enabled)return;let y=m,w=Number(new Date),E=w-(f||w);y.diff=E,y.prev=f,y.curr=w,f=w,g[0]=t.coerce(g[0]),typeof g[0]!="string"&&g.unshift("%O");let R=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,(v,I)=>{if(v==="%%")return"%";R++;let _=t.formatters[I];if(typeof _=="function"){let k=g[R];v=_.call(y,k),g.splice(R,1),R--}return v}),t.formatArgs.call(y,g),(y.log||t.log).apply(y,g)}return m.namespace=u,m.useColors=t.useColors(),m.color=t.selectColor(u),m.extend=n,m.destroy=t.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(d!==t.namespaces&&(d=t.namespaces,p=t.enabled(u)),p),set:g=>{h=g}}),typeof t.init=="function"&&t.init(m),m}function n(u,f){let h=t(this.namespace+(typeof f>"u"?":":f)+u);return h.log=this.log,h}function i(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let f,h=(typeof u=="string"?u:"").split(/[\s,]+/),d=h.length;for(f=0;f<d;f++)h[f]&&(u=h[f].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.slice(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function s(){let u=[...t.names.map(a),...t.skips.map(a).map(f=>"-"+f)].join(",");return t.enable(""),u}function o(u){if(u[u.length-1]==="*")return!0;let f,h;for(f=0,h=t.skips.length;f<h;f++)if(t.skips[f].test(u))return!1;for(f=0,h=t.names.length;f<h;f++)if(t.names[f].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack||u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}E8.exports=IT});var _1=F((Vr,qu)=>{Vr.formatArgs=TT;Vr.save=DT;Vr.load=CT;Vr.useColors=AT;Vr.storage=PT();Vr.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();Vr.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function AT(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function TT(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+qu.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(t++,i==="%c"&&(n=t))}),r.splice(n,0,e)}Vr.log=console.debug||console.log||(()=>{});function DT(r){try{r?Vr.storage.setItem("debug",r):Vr.storage.removeItem("debug")}catch{}}function CT(){let r;try{r=Vr.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function PT(){try{return localStorage}catch{}}qu.exports=x8()(Vr);var{formatters:kT}=qu.exports;kT.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var ro=F((dH,C8)=>{"use strict";function D8(r,e){for(let t in e)Object.defineProperty(r,t,{value:e[t],enumerable:!0,configurable:!0});return r}function QT(r,e,t){if(!r||typeof r=="string")throw new TypeError("Please pass an Error to err-code");t||(t={}),typeof e=="object"&&(t=e,e=""),e&&(t.code=e);try{return D8(r,t)}catch{t.message=r.message,t.stack=r.stack;let i=function(){};return i.prototype=Object.create(Object.getPrototypeOf(r)),D8(new i,t)}}C8.exports=QT});var o6=F((QG,s6)=>{s6.exports=i6;var n6=128,uC=127,fC=~uC,hC=Math.pow(2,31);function i6(r,e,t){e=e||[],t=t||0;for(var n=t;r>=hC;)e[t++]=r&255|n6,r/=128;for(;r&fC;)e[t++]=r&255|n6,r>>>=7;return e[t]=r|0,i6.bytes=t-n+1,e}});var l6=F((XG,c6)=>{c6.exports=Z1;var dC=128,a6=127;function Z1(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Z1.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&a6)<<i:(o&a6)*Math.pow(2,i),i+=7}while(o>=dC);return Z1.bytes=s-n,t}});var f6=F((jG,u6)=>{var pC=Math.pow(2,7),mC=Math.pow(2,14),gC=Math.pow(2,21),yC=Math.pow(2,28),bC=Math.pow(2,35),wC=Math.pow(2,42),EC=Math.pow(2,49),xC=Math.pow(2,56),vC=Math.pow(2,63);u6.exports=function(r){return r<pC?1:r<mC?2:r<gC?3:r<yC?4:r<bC?5:r<wC?6:r<EC?7:r<xC?8:r<vC?9:10}});var d6=F((ZG,h6)=>{h6.exports={encode:o6(),decode:l6(),encodingLength:f6()}});var g6=F((JG,m6)=>{"use strict";var p6=d6();m6.exports=r=>{if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let e=[];for(;r.length>0;){let t=p6.decode(r);e.push(t),r=r.slice(p6.decode.bytes)}return e}});var w6=F((uY,b6)=>{b6.exports=J1;var y6=128,_C=127,SC=~_C,RC=Math.pow(2,31);function J1(r,e,t){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw J1.bytes=0,new RangeError("Could not encode varint");e=e||[],t=t||0;for(var n=t;r>=RC;)e[t++]=r&255|y6,r/=128;for(;r&SC;)e[t++]=r&255|y6,r>>>=7;return e[t]=r|0,J1.bytes=t-n+1,e}});var v6=F((fY,x6)=>{x6.exports=ep;var IC=128,E6=127;function ep(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a||i>49)throw ep.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&E6)<<i:(o&E6)*Math.pow(2,i),i+=7}while(o>=IC);return ep.bytes=s-n,t}});var S6=F((hY,_6)=>{var AC=Math.pow(2,7),TC=Math.pow(2,14),DC=Math.pow(2,21),CC=Math.pow(2,28),PC=Math.pow(2,35),kC=Math.pow(2,42),NC=Math.pow(2,49),OC=Math.pow(2,56),LC=Math.pow(2,63);_6.exports=function(r){return r<AC?1:r<TC?2:r<DC?3:r<CC?4:r<PC?5:r<kC?6:r<NC?7:r<OC?8:r<LC?9:10}});var I6=F((dY,R6)=>{R6.exports={encode:w6(),decode:v6(),encodingLength:S6()}});var z6=F((KQ,q6)=>{"use strict";q6.exports=function(){return Date.now()}});var H6=F((VQ,$6)=>{"use strict";var a0=z6(),bp=class{constructor(e,t,n){let i=this;this._started=a0(),this._rescheduled=0,this._scheduled=t,this._args=n,this._triggered=!1,this._timerWrapper=()=>{i._rescheduled>0?(i._scheduled=i._rescheduled-(a0()-i._started),i._schedule(i._scheduled)):(i._triggered=!0,e.apply(null,i._args))},this._timer=setTimeout(this._timerWrapper,t)}reschedule(e){e||(e=this._scheduled);let t=a0();t+e-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(e)):this._triggered?this._schedule(e):(this._started=t,this._rescheduled=e)}_schedule(e){this._triggered=!1,this._started=a0(),this._rescheduled=0,this._scheduled=e,this._timer=setTimeout(this._timerWrapper,e)}clear(){clearTimeout(this._timer)}};function iP(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let r;if(arguments.length>0){r=new Array(arguments.length-2);for(var e=0;e<r.length;e++)r[e]=arguments[e+2]}return new bp(arguments[0],arguments[1],r)}$6.exports=iP});var Y6=F((qQ,G6)=>{"use strict";var{AbortController:sP}=globalThis,W6=H6(),wp=class r extends sP{constructor(e){super(),this._ms=e,this._timer=W6(()=>this.abort(),e),Object.setPrototypeOf(this,r.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=W6(()=>this.abort(),this._ms)}};G6.exports={TimeoutController:wp}});var f0=F((ZQ,Sp)=>{"use strict";var ya=typeof Reflect=="object"?Reflect:null,J6=ya&&typeof ya.apply=="function"?ya.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},l0;ya&&typeof ya.ownKeys=="function"?l0=ya.ownKeys:Object.getOwnPropertySymbols?l0=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:l0=function(e){return Object.getOwnPropertyNames(e)};function uP(r){console&&console.warn&&console.warn(r)}var t5=Number.isNaN||function(e){return e!==e};function Xe(){Xe.init.call(this)}Sp.exports=Xe;Sp.exports.once=pP;Xe.EventEmitter=Xe;Xe.prototype._events=void 0;Xe.prototype._eventsCount=0;Xe.prototype._maxListeners=void 0;var e5=10;function u0(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(Xe,"defaultMaxListeners",{enumerable:!0,get:function(){return e5},set:function(r){if(typeof r!="number"||r<0||t5(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");e5=r}});Xe.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};Xe.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||t5(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function r5(r){return r._maxListeners===void 0?Xe.defaultMaxListeners:r._maxListeners}Xe.prototype.getMaxListeners=function(){return r5(this)};Xe.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=e==="error",s=this._events;if(s!==void 0)i=i&&s.error===void 0;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[e];if(c===void 0)return!1;if(typeof c=="function")J6(c,this,t);else for(var l=c.length,u=a5(c,l),n=0;n<l;++n)J6(u[n],this,t);return!0};function n5(r,e,t,n){var i,s,o;if(u0(t),s=r._events,s===void 0?(s=r._events=Object.create(null),r._eventsCount=0):(s.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),s=r._events),o=s[e]),o===void 0)o=s[e]=t,++r._eventsCount;else if(typeof o=="function"?o=s[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),i=r5(r),i>0&&o.length>i&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=e,a.count=o.length,uP(a)}return r}Xe.prototype.addListener=function(e,t){return n5(this,e,t,!1)};Xe.prototype.on=Xe.prototype.addListener;Xe.prototype.prependListener=function(e,t){return n5(this,e,t,!0)};function fP(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function i5(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},i=fP.bind(n);return i.listener=t,n.wrapFn=i,i}Xe.prototype.once=function(e,t){return u0(t),this.on(e,i5(this,e,t)),this};Xe.prototype.prependOnceListener=function(e,t){return u0(t),this.prependListener(e,i5(this,e,t)),this};Xe.prototype.removeListener=function(e,t){var n,i,s,o,a;if(u0(t),i=this._events,i===void 0)return this;if(n=i[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(s=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,s=o;break}if(s<0)return this;s===0?n.shift():hP(n,s),n.length===1&&(i[e]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};Xe.prototype.off=Xe.prototype.removeListener;Xe.prototype.removeAllListeners=function(e){var t,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var s=Object.keys(n),o;for(i=0;i<s.length;++i)o=s[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function s5(r,e,t){var n=r._events;if(n===void 0)return[];var i=n[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?dP(i):a5(i,i.length)}Xe.prototype.listeners=function(e){return s5(this,e,!0)};Xe.prototype.rawListeners=function(e){return s5(this,e,!1)};Xe.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):o5.call(r,e)};Xe.prototype.listenerCount=o5;function o5(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}Xe.prototype.eventNames=function(){return this._eventsCount>0?l0(this._events):[]};function a5(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}function hP(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function dP(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function pP(r,e){return new Promise(function(t,n){function i(o){r.removeListener(e,s),n(o)}function s(){typeof r.removeListener=="function"&&r.removeListener("error",i),t([].slice.call(arguments))}c5(r,e,s,{once:!0}),e!=="error"&&mP(r,i,{once:!0})})}function mP(r,e,t){typeof r.on=="function"&&c5(r,"error",e,t)}function c5(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function i(s){n.once&&r.removeEventListener(e,i),t(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}});var p5=F((h5,d5)=>{"use strict";var gP=Math.exp;h5=d5.exports=function(e){if(typeof e!="number")throw new Error("must provide a timespan to the moving average constructor");if(e<=0)throw new Error("must provide a timespan > 0 to the moving average constructor");let t,n=0,i=0,s=0,o,a={};function c(l,u){return 1-gP(-(l-u)/e)}return a.push=function(u,f){if(o){let h=c(u,o),d=f-t,p=h*d;t=h*f+(1-h)*t,n=(1-h)*(n+d*p),i=Math.sqrt(n),s=t+h*d}else t=f;o=u},a.movingAverage=function(){return t},a.variance=function(){return n},a.deviation=function(){return i},a.forecast=function(){return s},a}});var Iy=F((Vj,Mp)=>{"use strict";var YP=Object.prototype.hasOwnProperty,Er="~";function ll(){}Object.create&&(ll.prototype=Object.create(null),new ll().__proto__||(Er=!1));function QP(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function Ry(r,e,t,n,i){if(typeof t!="function")throw new TypeError("The listener must be a function");var s=new QP(t,n||r,i),o=Er?Er+e:e;return r._events[o]?r._events[o].fn?r._events[o]=[r._events[o],s]:r._events[o].push(s):(r._events[o]=s,r._eventsCount++),r}function k0(r,e){--r._eventsCount===0?r._events=new ll:delete r._events[e]}function mr(){this._events=new ll,this._eventsCount=0}mr.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)YP.call(t,n)&&e.push(Er?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};mr.prototype.listeners=function(e){var t=Er?Er+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,s=n.length,o=new Array(s);i<s;i++)o[i]=n[i].fn;return o};mr.prototype.listenerCount=function(e){var t=Er?Er+e:e,n=this._events[t];return n?n.fn?1:n.length:0};mr.prototype.emit=function(e,t,n,i,s,o){var a=Er?Er+e:e;if(!this._events[a])return!1;var c=this._events[a],l=arguments.length,u,f;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,i),!0;case 5:return c.fn.call(c.context,t,n,i,s),!0;case 6:return c.fn.call(c.context,t,n,i,s,o),!0}for(f=1,u=new Array(l-1);f<l;f++)u[f-1]=arguments[f];c.fn.apply(c.context,u)}else{var h=c.length,d;for(f=0;f<h;f++)switch(c[f].once&&this.removeListener(e,c[f].fn,void 0,!0),l){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,t);break;case 3:c[f].fn.call(c[f].context,t,n);break;case 4:c[f].fn.call(c[f].context,t,n,i);break;default:if(!u)for(d=1,u=new Array(l-1);d<l;d++)u[d-1]=arguments[d];c[f].fn.apply(c[f].context,u)}}return!0};mr.prototype.on=function(e,t,n){return Ry(this,e,t,n,!1)};mr.prototype.once=function(e,t,n){return Ry(this,e,t,n,!0)};mr.prototype.removeListener=function(e,t,n,i){var s=Er?Er+e:e;if(!this._events[s])return this;if(!t)return k0(this,s),this;var o=this._events[s];if(o.fn)o.fn===t&&(!i||o.once)&&(!n||o.context===n)&&k0(this,s);else{for(var a=0,c=[],l=o.length;a<l;a++)(o[a].fn!==t||i&&!o[a].once||n&&o[a].context!==n)&&c.push(o[a]);c.length?this._events[s]=c.length===1?c[0]:c:k0(this,s)}return this};mr.prototype.removeAllListeners=function(e){var t;return e?(t=Er?Er+e:e,this._events[t]&&k0(this,t)):(this._events=new ll,this._eventsCount=0),this};mr.prototype.off=mr.prototype.removeListener;mr.prototype.addListener=mr.prototype.on;mr.prefixed=Er;mr.EventEmitter=mr;typeof Mp<"u"&&(Mp.exports=mr)});var Qe=F((OJ,u7)=>{u7.exports={options:{usePureJavaScript:!1}}});var d7=F((LJ,h7)=>{var o2={};h7.exports=o2;var f7={};o2.encode=function(r,e,t){if(typeof e!="string")throw new TypeError('"alphabet" must be a string.');if(t!==void 0&&typeof t!="number")throw new TypeError('"maxline" must be a number.');var n="";if(!(r instanceof Uint8Array))n=pk(r,e);else{var i=0,s=e.length,o=e.charAt(0),a=[0];for(i=0;i<r.length;++i){for(var c=0,l=r[i];c<a.length;++c)l+=a[c]<<8,a[c]=l%s,l=l/s|0;for(;l>0;)a.push(l%s),l=l/s|0}for(i=0;r[i]===0&&i<r.length-1;++i)n+=o;for(i=a.length-1;i>=0;--i)n+=e[a[i]]}if(t){var u=new RegExp(".{1,"+t+"}","g");n=n.match(u).join(`\r
`)}return n};o2.decode=function(r,e){if(typeof r!="string")throw new TypeError('"input" must be a string.');if(typeof e!="string")throw new TypeError('"alphabet" must be a string.');var t=f7[e];if(!t){t=f7[e]=[];for(var n=0;n<e.length;++n)t[e.charCodeAt(n)]=n}r=r.replace(/\s/g,"");for(var i=e.length,s=e.charAt(0),o=[0],n=0;n<r.length;n++){var a=t[r.charCodeAt(n)];if(a===void 0)return;for(var c=0,l=a;c<o.length;++c)l+=o[c]*i,o[c]=l&255,l>>=8;for(;l>0;)o.push(l&255),l>>=8}for(var u=0;r[u]===s&&u<r.length-1;++u)o.push(0);return typeof Buffer<"u"?Buffer.from(o.reverse()):new Uint8Array(o.reverse())};function pk(r,e){var t=0,n=e.length,i=e.charAt(0),s=[0];for(t=0;t<r.length();++t){for(var o=0,a=r.at(t);o<s.length;++o)a+=s[o]<<8,s[o]=a%n,a=a/n|0;for(;a>0;)s.push(a%n),a=a/n|0}var c="";for(t=0;r.at(t)===0&&t<r.length()-1;++t)c+=i;for(t=s.length-1;t>=0;--t)c+=e[s[t]];return c}});var At=F((BJ,y7)=>{var p7=Qe(),m7=d7(),S=y7.exports=p7.util=p7.util||{};(function(){if(typeof process<"u"&&process.nextTick&&!process.browser){S.nextTick=process.nextTick,typeof setImmediate=="function"?S.setImmediate=setImmediate:S.setImmediate=S.nextTick;return}if(typeof setImmediate=="function"){S.setImmediate=function(){return setImmediate.apply(void 0,arguments)},S.nextTick=function(a){return setImmediate(a)};return}if(S.setImmediate=function(a){setTimeout(a,0)},typeof window<"u"&&typeof window.postMessage=="function"){let a=function(c){if(c.source===window&&c.data===r){c.stopPropagation();var l=e.slice();e.length=0,l.forEach(function(u){u()})}};var o=a,r="forge.setImmediate",e=[];S.setImmediate=function(c){e.push(c),e.length===1&&window.postMessage(r,"*")},window.addEventListener("message",a,!0)}if(typeof MutationObserver<"u"){var t=Date.now(),n=!0,i=document.createElement("div"),e=[];new MutationObserver(function(){var c=e.slice();e.length=0,c.forEach(function(l){l()})}).observe(i,{attributes:!0});var s=S.setImmediate;S.setImmediate=function(c){Date.now()-t>15?(t=Date.now(),s(c)):(e.push(c),e.length===1&&i.setAttribute("a",n=!n))}}S.nextTick=S.setImmediate})();S.isNodejs=typeof process<"u"&&process.versions&&process.versions.node;S.globalScope=function(){return S.isNodejs?globalThis:typeof self>"u"?window:self}();S.isArray=Array.isArray||function(r){return Object.prototype.toString.call(r)==="[object Array]"};S.isArrayBuffer=function(r){return typeof ArrayBuffer<"u"&&r instanceof ArrayBuffer};S.isArrayBufferView=function(r){return r&&S.isArrayBuffer(r.buffer)&&r.byteLength!==void 0};function yl(r){if(!(r===8||r===16||r===24||r===32))throw new Error("Only 8, 16, 24, or 32 bits supported: "+r)}S.ByteBuffer=a2;function a2(r){if(this.data="",this.read=0,typeof r=="string")this.data=r;else if(S.isArrayBuffer(r)||S.isArrayBufferView(r))if(typeof Buffer<"u"&&r instanceof Buffer)this.data=r.toString("binary");else{var e=new Uint8Array(r);try{this.data=String.fromCharCode.apply(null,e)}catch{for(var t=0;t<e.length;++t)this.putByte(e[t])}}else(r instanceof a2||typeof r=="object"&&typeof r.data=="string"&&typeof r.read=="number")&&(this.data=r.data,this.read=r.read);this._constructedStringLength=0}S.ByteStringBuffer=a2;var mk=4096;S.ByteStringBuffer.prototype._optimizeConstructedString=function(r){this._constructedStringLength+=r,this._constructedStringLength>mk&&(this.data.substr(0,1),this._constructedStringLength=0)};S.ByteStringBuffer.prototype.length=function(){return this.data.length-this.read};S.ByteStringBuffer.prototype.isEmpty=function(){return this.length()<=0};S.ByteStringBuffer.prototype.putByte=function(r){return this.putBytes(String.fromCharCode(r))};S.ByteStringBuffer.prototype.fillWithByte=function(r,e){r=String.fromCharCode(r);for(var t=this.data;e>0;)e&1&&(t+=r),e>>>=1,e>0&&(r+=r);return this.data=t,this._optimizeConstructedString(e),this};S.ByteStringBuffer.prototype.putBytes=function(r){return this.data+=r,this._optimizeConstructedString(r.length),this};S.ByteStringBuffer.prototype.putString=function(r){return this.putBytes(S.encodeUtf8(r))};S.ByteStringBuffer.prototype.putInt16=function(r){return this.putBytes(String.fromCharCode(r>>8&255)+String.fromCharCode(r&255))};S.ByteStringBuffer.prototype.putInt24=function(r){return this.putBytes(String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r&255))};S.ByteStringBuffer.prototype.putInt32=function(r){return this.putBytes(String.fromCharCode(r>>24&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r&255))};S.ByteStringBuffer.prototype.putInt16Le=function(r){return this.putBytes(String.fromCharCode(r&255)+String.fromCharCode(r>>8&255))};S.ByteStringBuffer.prototype.putInt24Le=function(r){return this.putBytes(String.fromCharCode(r&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r>>16&255))};S.ByteStringBuffer.prototype.putInt32Le=function(r){return this.putBytes(String.fromCharCode(r&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>24&255))};S.ByteStringBuffer.prototype.putInt=function(r,e){yl(e);var t="";do e-=8,t+=String.fromCharCode(r>>e&255);while(e>0);return this.putBytes(t)};S.ByteStringBuffer.prototype.putSignedInt=function(r,e){return r<0&&(r+=2<<e-1),this.putInt(r,e)};S.ByteStringBuffer.prototype.putBuffer=function(r){return this.putBytes(r.getBytes())};S.ByteStringBuffer.prototype.getByte=function(){return this.data.charCodeAt(this.read++)};S.ByteStringBuffer.prototype.getInt16=function(){var r=this.data.charCodeAt(this.read)<<8^this.data.charCodeAt(this.read+1);return this.read+=2,r};S.ByteStringBuffer.prototype.getInt24=function(){var r=this.data.charCodeAt(this.read)<<16^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2);return this.read+=3,r};S.ByteStringBuffer.prototype.getInt32=function(){var r=this.data.charCodeAt(this.read)<<24^this.data.charCodeAt(this.read+1)<<16^this.data.charCodeAt(this.read+2)<<8^this.data.charCodeAt(this.read+3);return this.read+=4,r};S.ByteStringBuffer.prototype.getInt16Le=function(){var r=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8;return this.read+=2,r};S.ByteStringBuffer.prototype.getInt24Le=function(){var r=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2)<<16;return this.read+=3,r};S.ByteStringBuffer.prototype.getInt32Le=function(){var r=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2)<<16^this.data.charCodeAt(this.read+3)<<24;return this.read+=4,r};S.ByteStringBuffer.prototype.getInt=function(r){yl(r);var e=0;do e=(e<<8)+this.data.charCodeAt(this.read++),r-=8;while(r>0);return e};S.ByteStringBuffer.prototype.getSignedInt=function(r){var e=this.getInt(r),t=2<<r-2;return e>=t&&(e-=t<<1),e};S.ByteStringBuffer.prototype.getBytes=function(r){var e;return r?(r=Math.min(this.length(),r),e=this.data.slice(this.read,this.read+r),this.read+=r):r===0?e="":(e=this.read===0?this.data:this.data.slice(this.read),this.clear()),e};S.ByteStringBuffer.prototype.bytes=function(r){return typeof r>"u"?this.data.slice(this.read):this.data.slice(this.read,this.read+r)};S.ByteStringBuffer.prototype.at=function(r){return this.data.charCodeAt(this.read+r)};S.ByteStringBuffer.prototype.setAt=function(r,e){return this.data=this.data.substr(0,this.read+r)+String.fromCharCode(e)+this.data.substr(this.read+r+1),this};S.ByteStringBuffer.prototype.last=function(){return this.data.charCodeAt(this.data.length-1)};S.ByteStringBuffer.prototype.copy=function(){var r=S.createBuffer(this.data);return r.read=this.read,r};S.ByteStringBuffer.prototype.compact=function(){return this.read>0&&(this.data=this.data.slice(this.read),this.read=0),this};S.ByteStringBuffer.prototype.clear=function(){return this.data="",this.read=0,this};S.ByteStringBuffer.prototype.truncate=function(r){var e=Math.max(0,this.length()-r);return this.data=this.data.substr(this.read,e),this.read=0,this};S.ByteStringBuffer.prototype.toHex=function(){for(var r="",e=this.read;e<this.data.length;++e){var t=this.data.charCodeAt(e);t<16&&(r+="0"),r+=t.toString(16)}return r};S.ByteStringBuffer.prototype.toString=function(){return S.decodeUtf8(this.bytes())};function gk(r,e){e=e||{},this.read=e.readOffset||0,this.growSize=e.growSize||1024;var t=S.isArrayBuffer(r),n=S.isArrayBufferView(r);if(t||n){t?this.data=new DataView(r):this.data=new DataView(r.buffer,r.byteOffset,r.byteLength),this.write="writeOffset"in e?e.writeOffset:this.data.byteLength;return}this.data=new DataView(new ArrayBuffer(0)),this.write=0,r!=null&&this.putBytes(r),"writeOffset"in e&&(this.write=e.writeOffset)}S.DataBuffer=gk;S.DataBuffer.prototype.length=function(){return this.write-this.read};S.DataBuffer.prototype.isEmpty=function(){return this.length()<=0};S.DataBuffer.prototype.accommodate=function(r,e){if(this.length()>=r)return this;e=Math.max(e||this.growSize,r);var t=new Uint8Array(this.data.buffer,this.data.byteOffset,this.data.byteLength),n=new Uint8Array(this.length()+e);return n.set(t),this.data=new DataView(n.buffer),this};S.DataBuffer.prototype.putByte=function(r){return this.accommodate(1),this.data.setUint8(this.write++,r),this};S.DataBuffer.prototype.fillWithByte=function(r,e){this.accommodate(e);for(var t=0;t<e;++t)this.data.setUint8(r);return this};S.DataBuffer.prototype.putBytes=function(r,e){if(S.isArrayBufferView(r)){var t=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),n=t.byteLength-t.byteOffset;this.accommodate(n);var i=new Uint8Array(this.data.buffer,this.write);return i.set(t),this.write+=n,this}if(S.isArrayBuffer(r)){var t=new Uint8Array(r);this.accommodate(t.byteLength);var i=new Uint8Array(this.data.buffer);return i.set(t,this.write),this.write+=t.byteLength,this}if(r instanceof S.DataBuffer||typeof r=="object"&&typeof r.read=="number"&&typeof r.write=="number"&&S.isArrayBufferView(r.data)){var t=new Uint8Array(r.data.byteLength,r.read,r.length());this.accommodate(t.byteLength);var i=new Uint8Array(r.data.byteLength,this.write);return i.set(t),this.write+=t.byteLength,this}if(r instanceof S.ByteStringBuffer&&(r=r.data,e="binary"),e=e||"binary",typeof r=="string"){var s;if(e==="hex")return this.accommodate(Math.ceil(r.length/2)),s=new Uint8Array(this.data.buffer,this.write),this.write+=S.binary.hex.decode(r,s,this.write),this;if(e==="base64")return this.accommodate(Math.ceil(r.length/4)*3),s=new Uint8Array(this.data.buffer,this.write),this.write+=S.binary.base64.decode(r,s,this.write),this;if(e==="utf8"&&(r=S.encodeUtf8(r),e="binary"),e==="binary"||e==="raw")return this.accommodate(r.length),s=new Uint8Array(this.data.buffer,this.write),this.write+=S.binary.raw.decode(s),this;if(e==="utf16")return this.accommodate(r.length*2),s=new Uint16Array(this.data.buffer,this.write),this.write+=S.text.utf16.encode(s),this;throw new Error("Invalid encoding: "+e)}throw Error("Invalid parameter: "+r)};S.DataBuffer.prototype.putBuffer=function(r){return this.putBytes(r),r.clear(),this};S.DataBuffer.prototype.putString=function(r){return this.putBytes(r,"utf16")};S.DataBuffer.prototype.putInt16=function(r){return this.accommodate(2),this.data.setInt16(this.write,r),this.write+=2,this};S.DataBuffer.prototype.putInt24=function(r){return this.accommodate(3),this.data.setInt16(this.write,r>>8&65535),this.data.setInt8(this.write,r>>16&255),this.write+=3,this};S.DataBuffer.prototype.putInt32=function(r){return this.accommodate(4),this.data.setInt32(this.write,r),this.write+=4,this};S.DataBuffer.prototype.putInt16Le=function(r){return this.accommodate(2),this.data.setInt16(this.write,r,!0),this.write+=2,this};S.DataBuffer.prototype.putInt24Le=function(r){return this.accommodate(3),this.data.setInt8(this.write,r>>16&255),this.data.setInt16(this.write,r>>8&65535,!0),this.write+=3,this};S.DataBuffer.prototype.putInt32Le=function(r){return this.accommodate(4),this.data.setInt32(this.write,r,!0),this.write+=4,this};S.DataBuffer.prototype.putInt=function(r,e){yl(e),this.accommodate(e/8);do e-=8,this.data.setInt8(this.write++,r>>e&255);while(e>0);return this};S.DataBuffer.prototype.putSignedInt=function(r,e){return yl(e),this.accommodate(e/8),r<0&&(r+=2<<e-1),this.putInt(r,e)};S.DataBuffer.prototype.getByte=function(){return this.data.getInt8(this.read++)};S.DataBuffer.prototype.getInt16=function(){var r=this.data.getInt16(this.read);return this.read+=2,r};S.DataBuffer.prototype.getInt24=function(){var r=this.data.getInt16(this.read)<<8^this.data.getInt8(this.read+2);return this.read+=3,r};S.DataBuffer.prototype.getInt32=function(){var r=this.data.getInt32(this.read);return this.read+=4,r};S.DataBuffer.prototype.getInt16Le=function(){var r=this.data.getInt16(this.read,!0);return this.read+=2,r};S.DataBuffer.prototype.getInt24Le=function(){var r=this.data.getInt8(this.read)^this.data.getInt16(this.read+1,!0)<<8;return this.read+=3,r};S.DataBuffer.prototype.getInt32Le=function(){var r=this.data.getInt32(this.read,!0);return this.read+=4,r};S.DataBuffer.prototype.getInt=function(r){yl(r);var e=0;do e=(e<<8)+this.data.getInt8(this.read++),r-=8;while(r>0);return e};S.DataBuffer.prototype.getSignedInt=function(r){var e=this.getInt(r),t=2<<r-2;return e>=t&&(e-=t<<1),e};S.DataBuffer.prototype.getBytes=function(r){var e;return r?(r=Math.min(this.length(),r),e=this.data.slice(this.read,this.read+r),this.read+=r):r===0?e="":(e=this.read===0?this.data:this.data.slice(this.read),this.clear()),e};S.DataBuffer.prototype.bytes=function(r){return typeof r>"u"?this.data.slice(this.read):this.data.slice(this.read,this.read+r)};S.DataBuffer.prototype.at=function(r){return this.data.getUint8(this.read+r)};S.DataBuffer.prototype.setAt=function(r,e){return this.data.setUint8(r,e),this};S.DataBuffer.prototype.last=function(){return this.data.getUint8(this.write-1)};S.DataBuffer.prototype.copy=function(){return new S.DataBuffer(this)};S.DataBuffer.prototype.compact=function(){if(this.read>0){var r=new Uint8Array(this.data.buffer,this.read),e=new Uint8Array(r.byteLength);e.set(r),this.data=new DataView(e),this.write-=this.read,this.read=0}return this};S.DataBuffer.prototype.clear=function(){return this.data=new DataView(new ArrayBuffer(0)),this.read=this.write=0,this};S.DataBuffer.prototype.truncate=function(r){return this.write=Math.max(0,this.length()-r),this.read=Math.min(this.read,this.write),this};S.DataBuffer.prototype.toHex=function(){for(var r="",e=this.read;e<this.data.byteLength;++e){var t=this.data.getUint8(e);t<16&&(r+="0"),r+=t.toString(16)}return r};S.DataBuffer.prototype.toString=function(r){var e=new Uint8Array(this.data,this.read,this.length());if(r=r||"utf8",r==="binary"||r==="raw")return S.binary.raw.encode(e);if(r==="hex")return S.binary.hex.encode(e);if(r==="base64")return S.binary.base64.encode(e);if(r==="utf8")return S.text.utf8.decode(e);if(r==="utf16")return S.text.utf16.decode(e);throw new Error("Invalid encoding: "+r)};S.createBuffer=function(r,e){return e=e||"raw",r!==void 0&&e==="utf8"&&(r=S.encodeUtf8(r)),new S.ByteBuffer(r)};S.fillString=function(r,e){for(var t="";e>0;)e&1&&(t+=r),e>>>=1,e>0&&(r+=r);return t};S.xorBytes=function(r,e,t){for(var n="",i="",s="",o=0,a=0;t>0;--t,++o)i=r.charCodeAt(o)^e.charCodeAt(o),a>=10&&(n+=s,s="",a=0),s+=String.fromCharCode(i),++a;return n+=s,n};S.hexToBytes=function(r){var e="",t=0;for(r.length&!0&&(t=1,e+=String.fromCharCode(parseInt(r[0],16)));t<r.length;t+=2)e+=String.fromCharCode(parseInt(r.substr(t,2),16));return e};S.bytesToHex=function(r){return S.createBuffer(r).toHex()};S.int32ToBytes=function(r){return String.fromCharCode(r>>24&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r&255)};var bs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",ws=[62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,64,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51],g7="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";S.encode64=function(r,e){for(var t="",n="",i,s,o,a=0;a<r.length;)i=r.charCodeAt(a++),s=r.charCodeAt(a++),o=r.charCodeAt(a++),t+=bs.charAt(i>>2),t+=bs.charAt((i&3)<<4|s>>4),isNaN(s)?t+="==":(t+=bs.charAt((s&15)<<2|o>>6),t+=isNaN(o)?"=":bs.charAt(o&63)),e&&t.length>e&&(n+=t.substr(0,e)+`\r
`,t=t.substr(e));return n+=t,n};S.decode64=function(r){r=r.replace(/[^A-Za-z0-9\+\/\=]/g,"");for(var e="",t,n,i,s,o=0;o<r.length;)t=ws[r.charCodeAt(o++)-43],n=ws[r.charCodeAt(o++)-43],i=ws[r.charCodeAt(o++)-43],s=ws[r.charCodeAt(o++)-43],e+=String.fromCharCode(t<<2|n>>4),i!==64&&(e+=String.fromCharCode((n&15)<<4|i>>2),s!==64&&(e+=String.fromCharCode((i&3)<<6|s)));return e};S.encodeUtf8=function(r){return unescape(encodeURIComponent(r))};S.decodeUtf8=function(r){return decodeURIComponent(escape(r))};S.binary={raw:{},hex:{},base64:{},base58:{},baseN:{encode:m7.encode,decode:m7.decode}};S.binary.raw.encode=function(r){return String.fromCharCode.apply(null,r)};S.binary.raw.decode=function(r,e,t){var n=e;n||(n=new Uint8Array(r.length)),t=t||0;for(var i=t,s=0;s<r.length;++s)n[i++]=r.charCodeAt(s);return e?i-t:n};S.binary.hex.encode=S.bytesToHex;S.binary.hex.decode=function(r,e,t){var n=e;n||(n=new Uint8Array(Math.ceil(r.length/2))),t=t||0;var i=0,s=t;for(r.length&1&&(i=1,n[s++]=parseInt(r[0],16));i<r.length;i+=2)n[s++]=parseInt(r.substr(i,2),16);return e?s-t:n};S.binary.base64.encode=function(r,e){for(var t="",n="",i,s,o,a=0;a<r.byteLength;)i=r[a++],s=r[a++],o=r[a++],t+=bs.charAt(i>>2),t+=bs.charAt((i&3)<<4|s>>4),isNaN(s)?t+="==":(t+=bs.charAt((s&15)<<2|o>>6),t+=isNaN(o)?"=":bs.charAt(o&63)),e&&t.length>e&&(n+=t.substr(0,e)+`\r
`,t=t.substr(e));return n+=t,n};S.binary.base64.decode=function(r,e,t){var n=e;n||(n=new Uint8Array(Math.ceil(r.length/4)*3)),r=r.replace(/[^A-Za-z0-9\+\/\=]/g,""),t=t||0;for(var i,s,o,a,c=0,l=t;c<r.length;)i=ws[r.charCodeAt(c++)-43],s=ws[r.charCodeAt(c++)-43],o=ws[r.charCodeAt(c++)-43],a=ws[r.charCodeAt(c++)-43],n[l++]=i<<2|s>>4,o!==64&&(n[l++]=(s&15)<<4|o>>2,a!==64&&(n[l++]=(o&3)<<6|a));return e?l-t:n.subarray(0,l)};S.binary.base58.encode=function(r,e){return S.binary.baseN.encode(r,g7,e)};S.binary.base58.decode=function(r,e){return S.binary.baseN.decode(r,g7,e)};S.text={utf8:{},utf16:{}};S.text.utf8.encode=function(r,e,t){r=S.encodeUtf8(r);var n=e;n||(n=new Uint8Array(r.length)),t=t||0;for(var i=t,s=0;s<r.length;++s)n[i++]=r.charCodeAt(s);return e?i-t:n};S.text.utf8.decode=function(r){return S.decodeUtf8(String.fromCharCode.apply(null,r))};S.text.utf16.encode=function(r,e,t){var n=e;n||(n=new Uint8Array(r.length*2));var i=new Uint16Array(n.buffer);t=t||0;for(var s=t,o=t,a=0;a<r.length;++a)i[o++]=r.charCodeAt(a),s+=2;return e?s-t:n};S.text.utf16.decode=function(r){return String.fromCharCode.apply(null,new Uint16Array(r.buffer))};S.deflate=function(r,e,t){if(e=S.decode64(r.deflate(S.encode64(e)).rval),t){var n=2,i=e.charCodeAt(1);i&32&&(n=6),e=e.substring(n,e.length-4)}return e};S.inflate=function(r,e,t){var n=r.inflate(S.encode64(e)).rval;return n===null?null:S.decode64(n)};var c2=function(r,e,t){if(!r)throw new Error("WebStorage not available.");var n;if(t===null?n=r.removeItem(e):(t=S.encode64(JSON.stringify(t)),n=r.setItem(e,t)),typeof n<"u"&&n.rval!==!0){var i=new Error(n.error.message);throw i.id=n.error.id,i.name=n.error.name,i}},l2=function(r,e){if(!r)throw new Error("WebStorage not available.");var t=r.getItem(e);if(r.init)if(t.rval===null){if(t.error){var n=new Error(t.error.message);throw n.id=t.error.id,n.name=t.error.name,n}t=null}else t=t.rval;return t!==null&&(t=JSON.parse(S.decode64(t))),t},yk=function(r,e,t,n){var i=l2(r,e);i===null&&(i={}),i[t]=n,c2(r,e,i)},bk=function(r,e,t){var n=l2(r,e);return n!==null&&(n=t in n?n[t]:null),n},wk=function(r,e,t){var n=l2(r,e);if(n!==null&&t in n){delete n[t];var i=!0;for(var s in n){i=!1;break}i&&(n=null),c2(r,e,n)}},Ek=function(r,e){c2(r,e,null)},G0=function(r,e,t){var n=null;typeof t>"u"&&(t=["web","flash"]);var i,s=!1,o=null;for(var a in t){i=t[a];try{if(i==="flash"||i==="both"){if(e[0]===null)throw new Error("Flash local storage not available.");n=r.apply(this,e),s=i==="flash"}(i==="web"||i==="both")&&(e[0]=localStorage,n=r.apply(this,e),s=!0)}catch(c){o=c}if(s)break}if(!s)throw o;return n};S.setItem=function(r,e,t,n,i){G0(yk,arguments,i)};S.getItem=function(r,e,t,n){return G0(bk,arguments,n)};S.removeItem=function(r,e,t,n){G0(wk,arguments,n)};S.clearItems=function(r,e,t){G0(Ek,arguments,t)};S.isEmpty=function(r){for(var e in r)if(r.hasOwnProperty(e))return!1;return!0};S.format=function(r){for(var e=/%./g,t,n,i=0,s=[],o=0;t=e.exec(r);){n=r.substring(o,e.lastIndex-2),n.length>0&&s.push(n),o=e.lastIndex;var a=t[0][1];switch(a){case"s":case"o":i<arguments.length?s.push(arguments[i+++1]):s.push("<?>");break;case"%":s.push("%");break;default:s.push("<%"+a+"?>")}}return s.push(r.substring(o)),s.join("")};S.formatNumber=function(r,e,t,n){var i=r,s=isNaN(e=Math.abs(e))?2:e,o=t===void 0?",":t,a=n===void 0?".":n,c=i<0?"-":"",l=parseInt(i=Math.abs(+i||0).toFixed(s),10)+"",u=l.length>3?l.length%3:0;return c+(u?l.substr(0,u)+a:"")+l.substr(u).replace(/(\d{3})(?=\d)/g,"$1"+a)+(s?o+Math.abs(i-l).toFixed(s).slice(2):"")};S.formatSize=function(r){return r>=1073741824?r=S.formatNumber(r/1073741824,2,".","")+" GiB":r>=1048576?r=S.formatNumber(r/1048576,2,".","")+" MiB":r>=1024?r=S.formatNumber(r/1024,0)+" KiB":r=S.formatNumber(r,0)+" bytes",r};S.bytesFromIP=function(r){return r.indexOf(".")!==-1?S.bytesFromIPv4(r):r.indexOf(":")!==-1?S.bytesFromIPv6(r):null};S.bytesFromIPv4=function(r){if(r=r.split("."),r.length!==4)return null;for(var e=S.createBuffer(),t=0;t<r.length;++t){var n=parseInt(r[t],10);if(isNaN(n))return null;e.putByte(n)}return e.getBytes()};S.bytesFromIPv6=function(r){var e=0;r=r.split(":").filter(function(o){return o.length===0&&++e,!0});for(var t=(8-r.length+e)*2,n=S.createBuffer(),i=0;i<8;++i){if(!r[i]||r[i].length===0){n.fillWithByte(0,t),t=0;continue}var s=S.hexToBytes(r[i]);s.length<2&&n.putByte(0),n.putBytes(s)}return n.getBytes()};S.bytesToIP=function(r){return r.length===4?S.bytesToIPv4(r):r.length===16?S.bytesToIPv6(r):null};S.bytesToIPv4=function(r){if(r.length!==4)return null;for(var e=[],t=0;t<r.length;++t)e.push(r.charCodeAt(t));return e.join(".")};S.bytesToIPv6=function(r){if(r.length!==16)return null;for(var e=[],t=[],n=0,i=0;i<r.length;i+=2){for(var s=S.bytesToHex(r[i]+r[i+1]);s[0]==="0"&&s!=="0";)s=s.substr(1);if(s==="0"){var o=t[t.length-1],a=e.length;!o||a!==o.end+1?t.push({start:a,end:a}):(o.end=a,o.end-o.start>t[n].end-t[n].start&&(n=t.length-1))}e.push(s)}if(t.length>0){var c=t[n];c.end-c.start>0&&(e.splice(c.start,c.end-c.start+1,""),c.start===0&&e.unshift(""),c.end===7&&e.push(""))}return e.join(":")};S.estimateCores=function(r,e){if(typeof r=="function"&&(e=r,r={}),r=r||{},"cores"in S&&!r.update)return e(null,S.cores);if(typeof navigator<"u"&&"hardwareConcurrency"in navigator&&navigator.hardwareConcurrency>0)return S.cores=navigator.hardwareConcurrency,e(null,S.cores);if(typeof Worker>"u")return S.cores=1,e(null,S.cores);if(typeof Blob>"u")return S.cores=2,e(null,S.cores);var t=URL.createObjectURL(new Blob(["(",function(){self.addEventListener("message",function(o){for(var a=Date.now(),c=a+4;Date.now()<c;);self.postMessage({st:a,et:c})})}.toString(),")()"],{type:"application/javascript"}));n([],5,16);function n(o,a,c){if(a===0){var l=Math.floor(o.reduce(function(u,f){return u+f},0)/o.length);return S.cores=Math.max(1,l),URL.revokeObjectURL(t),e(null,S.cores)}i(c,function(u,f){o.push(s(c,f)),n(o,a-1,c)})}function i(o,a){for(var c=[],l=[],u=0;u<o;++u){var f=new Worker(t);f.addEventListener("message",function(h){if(l.push(h.data),l.length===o){for(var d=0;d<o;++d)c[d].terminate();a(null,l)}}),c.push(f)}for(var u=0;u<o;++u)c[u].postMessage(u)}function s(o,a){for(var c=[],l=0;l<o;++l)for(var u=a[l],f=c[l]=[],h=0;h<o;++h)if(l!==h){var d=a[h];(u.st>d.st&&u.st<d.et||d.st>u.st&&d.st<u.et)&&f.push(h)}return c.reduce(function(p,m){return Math.max(p,m.length)},0)}}});var Y0=F((MJ,b7)=>{var bl=Qe();bl.pki=bl.pki||{};var u2=b7.exports=bl.pki.oids=bl.oids=bl.oids||{};function q(r,e){u2[r]=e,u2[e]=r}function We(r,e){u2[r]=e}q("1.2.840.113549.1.1.1","rsaEncryption");q("1.2.840.113549.1.1.4","md5WithRSAEncryption");q("1.2.840.113549.1.1.5","sha1WithRSAEncryption");q("1.2.840.113549.1.1.7","RSAES-OAEP");q("1.2.840.113549.1.1.8","mgf1");q("1.2.840.113549.1.1.9","pSpecified");q("1.2.840.113549.1.1.10","RSASSA-PSS");q("1.2.840.113549.1.1.11","sha256WithRSAEncryption");q("1.2.840.113549.1.1.12","sha384WithRSAEncryption");q("1.2.840.113549.1.1.13","sha512WithRSAEncryption");q("1.3.101.112","EdDSA25519");q("1.2.840.10040.4.3","dsa-with-sha1");q("1.3.14.3.2.7","desCBC");q("1.3.14.3.2.26","sha1");q("1.3.14.3.2.29","sha1WithRSASignature");q("2.16.840.1.101.3.4.2.1","sha256");q("2.16.840.1.101.3.4.2.2","sha384");q("2.16.840.1.101.3.4.2.3","sha512");q("2.16.840.1.101.3.4.2.4","sha224");q("2.16.840.1.101.3.4.2.5","sha512-224");q("2.16.840.1.101.3.4.2.6","sha512-256");q("1.2.840.113549.2.2","md2");q("1.2.840.113549.2.5","md5");q("1.2.840.113549.1.7.1","data");q("1.2.840.113549.1.7.2","signedData");q("1.2.840.113549.1.7.3","envelopedData");q("1.2.840.113549.1.7.4","signedAndEnvelopedData");q("1.2.840.113549.1.7.5","digestedData");q("1.2.840.113549.1.7.6","encryptedData");q("1.2.840.113549.1.9.1","emailAddress");q("1.2.840.113549.1.9.2","unstructuredName");q("1.2.840.113549.1.9.3","contentType");q("1.2.840.113549.1.9.4","messageDigest");q("1.2.840.113549.1.9.5","signingTime");q("1.2.840.113549.1.9.6","counterSignature");q("1.2.840.113549.1.9.7","challengePassword");q("1.2.840.113549.1.9.8","unstructuredAddress");q("1.2.840.113549.1.9.14","extensionRequest");q("1.2.840.113549.1.9.20","friendlyName");q("1.2.840.113549.1.9.21","localKeyId");q("1.2.840.113549.1.9.22.1","x509Certificate");q("1.2.840.113549.1.12.10.1.1","keyBag");q("1.2.840.113549.1.12.10.1.2","pkcs8ShroudedKeyBag");q("1.2.840.113549.1.12.10.1.3","certBag");q("1.2.840.113549.1.12.10.1.4","crlBag");q("1.2.840.113549.1.12.10.1.5","secretBag");q("1.2.840.113549.1.12.10.1.6","safeContentsBag");q("1.2.840.113549.1.5.13","pkcs5PBES2");q("1.2.840.113549.1.5.12","pkcs5PBKDF2");q("1.2.840.113549.1.12.1.1","pbeWithSHAAnd128BitRC4");q("1.2.840.113549.1.12.1.2","pbeWithSHAAnd40BitRC4");q("1.2.840.113549.1.12.1.3","pbeWithSHAAnd3-KeyTripleDES-CBC");q("1.2.840.113549.1.12.1.4","pbeWithSHAAnd2-KeyTripleDES-CBC");q("1.2.840.113549.1.12.1.5","pbeWithSHAAnd128BitRC2-CBC");q("1.2.840.113549.1.12.1.6","pbewithSHAAnd40BitRC2-CBC");q("1.2.840.113549.2.7","hmacWithSHA1");q("1.2.840.113549.2.8","hmacWithSHA224");q("1.2.840.113549.2.9","hmacWithSHA256");q("1.2.840.113549.2.10","hmacWithSHA384");q("1.2.840.113549.2.11","hmacWithSHA512");q("1.2.840.113549.3.7","des-EDE3-CBC");q("2.16.840.1.101.3.4.1.2","aes128-CBC");q("2.16.840.1.101.3.4.1.22","aes192-CBC");q("2.16.840.1.101.3.4.1.42","aes256-CBC");q("2.5.4.3","commonName");q("2.5.4.4","surname");q("2.5.4.5","serialNumber");q("2.5.4.6","countryName");q("2.5.4.7","localityName");q("2.5.4.8","stateOrProvinceName");q("2.5.4.9","streetAddress");q("2.5.4.10","organizationName");q("2.5.4.11","organizationalUnitName");q("2.5.4.12","title");q("2.5.4.13","description");q("2.5.4.15","businessCategory");q("2.5.4.17","postalCode");q("2.5.4.42","givenName");q("1.3.6.1.4.1.311.60.2.1.2","jurisdictionOfIncorporationStateOrProvinceName");q("1.3.6.1.4.1.311.60.2.1.3","jurisdictionOfIncorporationCountryName");q("2.16.840.1.113730.1.1","nsCertType");q("2.16.840.1.113730.1.13","nsComment");We("2.5.29.1","authorityKeyIdentifier");We("2.5.29.2","keyAttributes");We("2.5.29.3","certificatePolicies");We("2.5.29.4","keyUsageRestriction");We("2.5.29.5","policyMapping");We("2.5.29.6","subtreesConstraint");We("2.5.29.7","subjectAltName");We("2.5.29.8","issuerAltName");We("2.5.29.9","subjectDirectoryAttributes");We("2.5.29.10","basicConstraints");We("2.5.29.11","nameConstraints");We("2.5.29.12","policyConstraints");We("2.5.29.13","basicConstraints");q("2.5.29.14","subjectKeyIdentifier");q("2.5.29.15","keyUsage");We("2.5.29.16","privateKeyUsagePeriod");q("2.5.29.17","subjectAltName");q("2.5.29.18","issuerAltName");q("2.5.29.19","basicConstraints");We("2.5.29.20","cRLNumber");We("2.5.29.21","cRLReason");We("2.5.29.22","expirationDate");We("2.5.29.23","instructionCode");We("2.5.29.24","invalidityDate");We("2.5.29.25","cRLDistributionPoints");We("2.5.29.26","issuingDistributionPoint");We("2.5.29.27","deltaCRLIndicator");We("2.5.29.28","issuingDistributionPoint");We("2.5.29.29","certificateIssuer");We("2.5.29.30","nameConstraints");q("2.5.29.31","cRLDistributionPoints");q("2.5.29.32","certificatePolicies");We("2.5.29.33","policyMappings");We("2.5.29.34","policyConstraints");q("2.5.29.35","authorityKeyIdentifier");We("2.5.29.36","policyConstraints");q("2.5.29.37","extKeyUsage");We("2.5.29.46","freshestCRL");We("2.5.29.54","inhibitAnyPolicy");q("1.3.6.1.4.1.11129.2.4.2","timestampList");q("1.3.6.1.5.5.7.1.1","authorityInfoAccess");q("1.3.6.1.5.5.7.3.1","serverAuth");q("1.3.6.1.5.5.7.3.2","clientAuth");q("1.3.6.1.5.5.7.3.3","codeSigning");q("1.3.6.1.5.5.7.3.4","emailProtection");q("1.3.6.1.5.5.7.3.8","timeStamping")});var El=F((UJ,E7)=>{var ot=Qe();At();Y0();var j=E7.exports=ot.asn1=ot.asn1||{};j.Class={UNIVERSAL:0,APPLICATION:64,CONTEXT_SPECIFIC:128,PRIVATE:192};j.Type={NONE:0,BOOLEAN:1,INTEGER:2,BITSTRING:3,OCTETSTRING:4,NULL:5,OID:6,ODESC:7,EXTERNAL:8,REAL:9,ENUMERATED:10,EMBEDDED:11,UTF8:12,ROID:13,SEQUENCE:16,SET:17,PRINTABLESTRING:19,IA5STRING:22,UTCTIME:23,GENERALIZEDTIME:24,BMPSTRING:30};j.create=function(r,e,t,n,i){if(ot.util.isArray(n)){for(var s=[],o=0;o<n.length;++o)n[o]!==void 0&&s.push(n[o]);n=s}var a={tagClass:r,type:e,constructed:t,composed:t||ot.util.isArray(n),value:n};return i&&"bitStringContents"in i&&(a.bitStringContents=i.bitStringContents,a.original=j.copy(a)),a};j.copy=function(r,e){var t;if(ot.util.isArray(r)){t=[];for(var n=0;n<r.length;++n)t.push(j.copy(r[n],e));return t}return typeof r=="string"?r:(t={tagClass:r.tagClass,type:r.type,constructed:r.constructed,composed:r.composed,value:j.copy(r.value,e)},e&&!e.excludeBitStringContents&&(t.bitStringContents=r.bitStringContents),t)};j.equals=function(r,e,t){if(ot.util.isArray(r)){if(!ot.util.isArray(e)||r.length!==e.length)return!1;for(var n=0;n<r.length;++n)if(!j.equals(r[n],e[n]))return!1;return!0}if(typeof r!=typeof e)return!1;if(typeof r=="string")return r===e;var i=r.tagClass===e.tagClass&&r.type===e.type&&r.constructed===e.constructed&&r.composed===e.composed&&j.equals(r.value,e.value);return t&&t.includeBitStringContents&&(i=i&&r.bitStringContents===e.bitStringContents),i};j.getBerValueLength=function(r){var e=r.getByte();if(e!==128){var t,n=e&128;return n?t=r.getInt((e&127)<<3):t=e,t}};function wl(r,e,t){if(t>e){var n=new Error("Too few bytes to parse DER.");throw n.available=r.length(),n.remaining=e,n.requested=t,n}}var xk=function(r,e){var t=r.getByte();if(e--,t!==128){var n,i=t&128;if(!i)n=t;else{var s=t&127;wl(r,e,s),n=r.getInt(s<<3)}if(n<0)throw new Error("Negative length: "+n);return n}};j.fromDer=function(r,e){e===void 0&&(e={strict:!0,parseAllBytes:!0,decodeBitStrings:!0}),typeof e=="boolean"&&(e={strict:e,parseAllBytes:!0,decodeBitStrings:!0}),"strict"in e||(e.strict=!0),"parseAllBytes"in e||(e.parseAllBytes=!0),"decodeBitStrings"in e||(e.decodeBitStrings=!0),typeof r=="string"&&(r=ot.util.createBuffer(r));var t=r.length(),n=Q0(r,r.length(),0,e);if(e.parseAllBytes&&r.length()!==0){var i=new Error("Unparsed DER bytes remain after ASN.1 parsing.");throw i.byteCount=t,i.remaining=r.length(),i}return n};function Q0(r,e,t,n){var i;wl(r,e,2);var s=r.getByte();e--;var o=s&192,a=s&31;i=r.length();var c=xk(r,e);if(e-=i-r.length(),c!==void 0&&c>e){if(n.strict){var l=new Error("Too few bytes to read ASN.1 value.");throw l.available=r.length(),l.remaining=e,l.requested=c,l}c=e}var u,f,h=(s&32)===32;if(h)if(u=[],c===void 0)for(;;){if(wl(r,e,2),r.bytes(2)===String.fromCharCode(0,0)){r.getBytes(2),e-=2;break}i=r.length(),u.push(Q0(r,e,t+1,n)),e-=i-r.length()}else for(;c>0;)i=r.length(),u.push(Q0(r,c,t+1,n)),e-=i-r.length(),c-=i-r.length();if(u===void 0&&o===j.Class.UNIVERSAL&&a===j.Type.BITSTRING&&(f=r.bytes(c)),u===void 0&&n.decodeBitStrings&&o===j.Class.UNIVERSAL&&a===j.Type.BITSTRING&&c>1){var d=r.read,p=e,m=0;if(a===j.Type.BITSTRING&&(wl(r,e,1),m=r.getByte(),e--),m===0)try{i=r.length();var g={strict:!0,decodeBitStrings:!0},y=Q0(r,e,t+1,g),w=i-r.length();e-=w,a==j.Type.BITSTRING&&w++;var E=y.tagClass;w===c&&(E===j.Class.UNIVERSAL||E===j.Class.CONTEXT_SPECIFIC)&&(u=[y])}catch{}u===void 0&&(r.read=d,e=p)}if(u===void 0){if(c===void 0){if(n.strict)throw new Error("Non-constructed ASN.1 object of indefinite length.");c=e}if(a===j.Type.BMPSTRING)for(u="";c>0;c-=2)wl(r,e,2),u+=String.fromCharCode(r.getInt16()),e-=2;else u=r.getBytes(c),e-=c}var R=f===void 0?null:{bitStringContents:f};return j.create(o,a,h,u,R)}j.toDer=function(r){var e=ot.util.createBuffer(),t=r.tagClass|r.type,n=ot.util.createBuffer(),i=!1;if("bitStringContents"in r&&(i=!0,r.original&&(i=j.equals(r,r.original))),i)n.putBytes(r.bitStringContents);else if(r.composed){r.constructed?t|=32:n.putByte(0);for(var s=0;s<r.value.length;++s)r.value[s]!==void 0&&n.putBuffer(j.toDer(r.value[s]))}else if(r.type===j.Type.BMPSTRING)for(var s=0;s<r.value.length;++s)n.putInt16(r.value.charCodeAt(s));else r.type===j.Type.INTEGER&&r.value.length>1&&(r.value.charCodeAt(0)===0&&!(r.value.charCodeAt(1)&128)||r.value.charCodeAt(0)===255&&(r.value.charCodeAt(1)&128)===128)?n.putBytes(r.value.substr(1)):n.putBytes(r.value);if(e.putByte(t),n.length()<=127)e.putByte(n.length()&127);else{var o=n.length(),a="";do a+=String.fromCharCode(o&255),o=o>>>8;while(o>0);e.putByte(a.length|128);for(var s=a.length-1;s>=0;--s)e.putByte(a.charCodeAt(s))}return e.putBuffer(n),e};j.oidToDer=function(r){var e=r.split("."),t=ot.util.createBuffer();t.putByte(40*parseInt(e[0],10)+parseInt(e[1],10));for(var n,i,s,o,a=2;a<e.length;++a){n=!0,i=[],s=parseInt(e[a],10);do o=s&127,s=s>>>7,n||(o|=128),i.push(o),n=!1;while(s>0);for(var c=i.length-1;c>=0;--c)t.putByte(i[c])}return t};j.derToOid=function(r){var e;typeof r=="string"&&(r=ot.util.createBuffer(r));var t=r.getByte();e=Math.floor(t/40)+"."+t%40;for(var n=0;r.length()>0;)t=r.getByte(),n=n<<7,t&128?n+=t&127:(e+="."+(n+t),n=0);return e};j.utcTimeToDate=function(r){var e=new Date,t=parseInt(r.substr(0,2),10);t=t>=50?1900+t:2e3+t;var n=parseInt(r.substr(2,2),10)-1,i=parseInt(r.substr(4,2),10),s=parseInt(r.substr(6,2),10),o=parseInt(r.substr(8,2),10),a=0;if(r.length>11){var c=r.charAt(10),l=10;c!=="+"&&c!=="-"&&(a=parseInt(r.substr(10,2),10),l+=2)}if(e.setUTCFullYear(t,n,i),e.setUTCHours(s,o,a,0),l&&(c=r.charAt(l),c==="+"||c==="-")){var u=parseInt(r.substr(l+1,2),10),f=parseInt(r.substr(l+4,2),10),h=u*60+f;h*=6e4,c==="+"?e.setTime(+e-h):e.setTime(+e+h)}return e};j.generalizedTimeToDate=function(r){var e=new Date,t=parseInt(r.substr(0,4),10),n=parseInt(r.substr(4,2),10)-1,i=parseInt(r.substr(6,2),10),s=parseInt(r.substr(8,2),10),o=parseInt(r.substr(10,2),10),a=parseInt(r.substr(12,2),10),c=0,l=0,u=!1;r.charAt(r.length-1)==="Z"&&(u=!0);var f=r.length-5,h=r.charAt(f);if(h==="+"||h==="-"){var d=parseInt(r.substr(f+1,2),10),p=parseInt(r.substr(f+4,2),10);l=d*60+p,l*=6e4,h==="+"&&(l*=-1),u=!0}return r.charAt(14)==="."&&(c=parseFloat(r.substr(14),10)*1e3),u?(e.setUTCFullYear(t,n,i),e.setUTCHours(s,o,a,c),e.setTime(+e+l)):(e.setFullYear(t,n,i),e.setHours(s,o,a,c)),e};j.dateToUtcTime=function(r){if(typeof r=="string")return r;var e="",t=[];t.push((""+r.getUTCFullYear()).substr(2)),t.push(""+(r.getUTCMonth()+1)),t.push(""+r.getUTCDate()),t.push(""+r.getUTCHours()),t.push(""+r.getUTCMinutes()),t.push(""+r.getUTCSeconds());for(var n=0;n<t.length;++n)t[n].length<2&&(e+="0"),e+=t[n];return e+="Z",e};j.dateToGeneralizedTime=function(r){if(typeof r=="string")return r;var e="",t=[];t.push(""+r.getUTCFullYear()),t.push(""+(r.getUTCMonth()+1)),t.push(""+r.getUTCDate()),t.push(""+r.getUTCHours()),t.push(""+r.getUTCMinutes()),t.push(""+r.getUTCSeconds());for(var n=0;n<t.length;++n)t[n].length<2&&(e+="0"),e+=t[n];return e+="Z",e};j.integerToDer=function(r){var e=ot.util.createBuffer();if(r>=-128&&r<128)return e.putSignedInt(r,8);if(r>=-32768&&r<32768)return e.putSignedInt(r,16);if(r>=-8388608&&r<8388608)return e.putSignedInt(r,24);if(r>=-2147483648&&r<2147483648)return e.putSignedInt(r,32);var t=new Error("Integer too large; max is 32-bits.");throw t.integer=r,t};j.derToInteger=function(r){typeof r=="string"&&(r=ot.util.createBuffer(r));var e=r.length()*8;if(e>32)throw new Error("Integer too large; max is 32-bits.");return r.getSignedInt(e)};j.validate=function(r,e,t,n){var i=!1;if((r.tagClass===e.tagClass||typeof e.tagClass>"u")&&(r.type===e.type||typeof e.type>"u"))if(r.constructed===e.constructed||typeof e.constructed>"u"){if(i=!0,e.value&&ot.util.isArray(e.value))for(var s=0,o=0;i&&o<e.value.length;++o)i=e.value[o].optional||!1,r.value[s]&&(i=j.validate(r.value[s],e.value[o],t,n),i?++s:e.value[o].optional&&(i=!0)),!i&&n&&n.push("["+e.name+'] Tag class "'+e.tagClass+'", type "'+e.type+'" expected value length "'+e.value.length+'", got "'+r.value.length+'"');if(i&&t&&(e.capture&&(t[e.capture]=r.value),e.captureAsn1&&(t[e.captureAsn1]=r),e.captureBitStringContents&&"bitStringContents"in r&&(t[e.captureBitStringContents]=r.bitStringContents),e.captureBitStringValue&&"bitStringContents"in r)){var a;if(r.bitStringContents.length<2)t[e.captureBitStringValue]="";else{var c=r.bitStringContents.charCodeAt(0);if(c!==0)throw new Error("captureBitStringValue only supported for zero unused bits");t[e.captureBitStringValue]=r.bitStringContents.slice(1)}}}else n&&n.push("["+e.name+'] Expected constructed "'+e.constructed+'", got "'+r.constructed+'"');else n&&(r.tagClass!==e.tagClass&&n.push("["+e.name+'] Expected tag class "'+e.tagClass+'", got "'+r.tagClass+'"'),r.type!==e.type&&n.push("["+e.name+'] Expected type "'+e.type+'", got "'+r.type+'"'));return i};var w7=/[^\\u0000-\\u00ff]/;j.prettyPrint=function(r,e,t){var n="";e=e||0,t=t||2,e>0&&(n+=`
`);for(var i="",s=0;s<e*t;++s)i+=" ";switch(n+=i+"Tag: ",r.tagClass){case j.Class.UNIVERSAL:n+="Universal:";break;case j.Class.APPLICATION:n+="Application:";break;case j.Class.CONTEXT_SPECIFIC:n+="Context-Specific:";break;case j.Class.PRIVATE:n+="Private:";break}if(r.tagClass===j.Class.UNIVERSAL)switch(n+=r.type,r.type){case j.Type.NONE:n+=" (None)";break;case j.Type.BOOLEAN:n+=" (Boolean)";break;case j.Type.INTEGER:n+=" (Integer)";break;case j.Type.BITSTRING:n+=" (Bit string)";break;case j.Type.OCTETSTRING:n+=" (Octet string)";break;case j.Type.NULL:n+=" (Null)";break;case j.Type.OID:n+=" (Object Identifier)";break;case j.Type.ODESC:n+=" (Object Descriptor)";break;case j.Type.EXTERNAL:n+=" (External or Instance of)";break;case j.Type.REAL:n+=" (Real)";break;case j.Type.ENUMERATED:n+=" (Enumerated)";break;case j.Type.EMBEDDED:n+=" (Embedded PDV)";break;case j.Type.UTF8:n+=" (UTF8)";break;case j.Type.ROID:n+=" (Relative Object Identifier)";break;case j.Type.SEQUENCE:n+=" (Sequence)";break;case j.Type.SET:n+=" (Set)";break;case j.Type.PRINTABLESTRING:n+=" (Printable String)";break;case j.Type.IA5String:n+=" (IA5String (ASCII))";break;case j.Type.UTCTIME:n+=" (UTC time)";break;case j.Type.GENERALIZEDTIME:n+=" (Generalized time)";break;case j.Type.BMPSTRING:n+=" (BMP String)";break}else n+=r.type;if(n+=`
`,n+=i+"Constructed: "+r.constructed+`
`,r.composed){for(var o=0,a="",s=0;s<r.value.length;++s)r.value[s]!==void 0&&(o+=1,a+=j.prettyPrint(r.value[s],e+1,t),s+1<r.value.length&&(a+=","));n+=i+"Sub values: "+o+a}else{if(n+=i+"Value: ",r.type===j.Type.OID){var c=j.derToOid(r.value);n+=c,ot.pki&&ot.pki.oids&&c in ot.pki.oids&&(n+=" ("+ot.pki.oids[c]+") ")}if(r.type===j.Type.INTEGER)try{n+=j.derToInteger(r.value)}catch{n+="0x"+ot.util.bytesToHex(r.value)}else if(r.type===j.Type.BITSTRING){if(r.value.length>1?n+="0x"+ot.util.bytesToHex(r.value.slice(1)):n+="(none)",r.value.length>0){var l=r.value.charCodeAt(0);l==1?n+=" (1 unused bit shown)":l>1&&(n+=" ("+l+" unused bits shown)")}}else if(r.type===j.Type.OCTETSTRING)w7.test(r.value)||(n+="("+r.value+") "),n+="0x"+ot.util.bytesToHex(r.value);else if(r.type===j.Type.UTF8)try{n+=ot.util.decodeUtf8(r.value)}catch(u){if(u.message==="URI malformed")n+="0x"+ot.util.bytesToHex(r.value)+" (malformed UTF8)";else throw u}else r.type===j.Type.PRINTABLESTRING||r.type===j.Type.IA5String?n+=r.value:w7.test(r.value)?n+="0x"+ot.util.bytesToHex(r.value):r.value.length===0?n+="[null]":n+=r.value}return n}});var h2=F((FJ,x7)=>{var Gt=Qe();At();x7.exports=Gt.cipher=Gt.cipher||{};Gt.cipher.algorithms=Gt.cipher.algorithms||{};Gt.cipher.createCipher=function(r,e){var t=r;if(typeof t=="string"&&(t=Gt.cipher.getAlgorithm(t),t&&(t=t())),!t)throw new Error("Unsupported algorithm: "+r);return new Gt.cipher.BlockCipher({algorithm:t,key:e,decrypt:!1})};Gt.cipher.createDecipher=function(r,e){var t=r;if(typeof t=="string"&&(t=Gt.cipher.getAlgorithm(t),t&&(t=t())),!t)throw new Error("Unsupported algorithm: "+r);return new Gt.cipher.BlockCipher({algorithm:t,key:e,decrypt:!0})};Gt.cipher.registerAlgorithm=function(r,e){r=r.toUpperCase(),Gt.cipher.algorithms[r]=e};Gt.cipher.getAlgorithm=function(r){return r=r.toUpperCase(),r in Gt.cipher.algorithms?Gt.cipher.algorithms[r]:null};var f2=Gt.cipher.BlockCipher=function(r){this.algorithm=r.algorithm,this.mode=this.algorithm.mode,this.blockSize=this.mode.blockSize,this._finish=!1,this._input=null,this.output=null,this._op=r.decrypt?this.mode.decrypt:this.mode.encrypt,this._decrypt=r.decrypt,this.algorithm.initialize(r)};f2.prototype.start=function(r){r=r||{};var e={};for(var t in r)e[t]=r[t];e.decrypt=this._decrypt,this._finish=!1,this._input=Gt.util.createBuffer(),this.output=r.output||Gt.util.createBuffer(),this.mode.start(e)};f2.prototype.update=function(r){for(r&&this._input.putBuffer(r);!this._op.call(this.mode,this._input,this.output,this._finish)&&!this._finish;);this._input.compact()};f2.prototype.finish=function(r){r&&(this.mode.name==="ECB"||this.mode.name==="CBC")&&(this.mode.pad=function(t){return r(this.blockSize,t,!1)},this.mode.unpad=function(t){return r(this.blockSize,t,!0)});var e={};return e.decrypt=this._decrypt,e.overflow=this._input.length()%this.blockSize,!(!this._decrypt&&this.mode.pad&&!this.mode.pad(this._input,e)||(this._finish=!0,this.update(),this._decrypt&&this.mode.unpad&&!this.mode.unpad(this.output,e))||this.mode.afterFinish&&!this.mode.afterFinish(this.output,e))}});var p2=F((KJ,v7)=>{var Yt=Qe();At();Yt.cipher=Yt.cipher||{};var ke=v7.exports=Yt.cipher.modes=Yt.cipher.modes||{};ke.ecb=function(r){r=r||{},this.name="ECB",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=new Array(this._ints),this._outBlock=new Array(this._ints)};ke.ecb.prototype.start=function(r){};ke.ecb.prototype.encrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=r.getInt32();this.cipher.encrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._outBlock[n])};ke.ecb.prototype.decrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=r.getInt32();this.cipher.decrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._outBlock[n])};ke.ecb.prototype.pad=function(r,e){var t=r.length()===this.blockSize?this.blockSize:this.blockSize-r.length();return r.fillWithByte(t,t),!0};ke.ecb.prototype.unpad=function(r,e){if(e.overflow>0)return!1;var t=r.length(),n=r.at(t-1);return n>this.blockSize<<2?!1:(r.truncate(n),!0)};ke.cbc=function(r){r=r||{},this.name="CBC",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=new Array(this._ints),this._outBlock=new Array(this._ints)};ke.cbc.prototype.start=function(r){if(r.iv===null){if(!this._prev)throw new Error("Invalid IV parameter.");this._iv=this._prev.slice(0)}else if("iv"in r)this._iv=X0(r.iv,this.blockSize),this._prev=this._iv.slice(0);else throw new Error("Invalid IV parameter.")};ke.cbc.prototype.encrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=this._prev[n]^r.getInt32();this.cipher.encrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._outBlock[n]);this._prev=this._outBlock};ke.cbc.prototype.decrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=r.getInt32();this.cipher.decrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._prev[n]^this._outBlock[n]);this._prev=this._inBlock.slice(0)};ke.cbc.prototype.pad=function(r,e){var t=r.length()===this.blockSize?this.blockSize:this.blockSize-r.length();return r.fillWithByte(t,t),!0};ke.cbc.prototype.unpad=function(r,e){if(e.overflow>0)return!1;var t=r.length(),n=r.at(t-1);return n>this.blockSize<<2?!1:(r.truncate(n),!0)};ke.cfb=function(r){r=r||{},this.name="CFB",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=null,this._outBlock=new Array(this._ints),this._partialBlock=new Array(this._ints),this._partialOutput=Yt.util.createBuffer(),this._partialBytes=0};ke.cfb.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");this._iv=X0(r.iv,this.blockSize),this._inBlock=this._iv.slice(0),this._partialBytes=0};ke.cfb.prototype.encrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var i=0;i<this._ints;++i)this._inBlock[i]=r.getInt32()^this._outBlock[i],e.putInt32(this._inBlock[i]);return}var s=(this.blockSize-n)%this.blockSize;s>0&&(s=this.blockSize-s),this._partialOutput.clear();for(var i=0;i<this._ints;++i)this._partialBlock[i]=r.getInt32()^this._outBlock[i],this._partialOutput.putInt32(this._partialBlock[i]);if(s>0)r.read-=this.blockSize;else for(var i=0;i<this._ints;++i)this._inBlock[i]=this._partialBlock[i];if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),s>0&&!t)return e.putBytes(this._partialOutput.getBytes(s-this._partialBytes)),this._partialBytes=s,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0};ke.cfb.prototype.decrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var i=0;i<this._ints;++i)this._inBlock[i]=r.getInt32(),e.putInt32(this._inBlock[i]^this._outBlock[i]);return}var s=(this.blockSize-n)%this.blockSize;s>0&&(s=this.blockSize-s),this._partialOutput.clear();for(var i=0;i<this._ints;++i)this._partialBlock[i]=r.getInt32(),this._partialOutput.putInt32(this._partialBlock[i]^this._outBlock[i]);if(s>0)r.read-=this.blockSize;else for(var i=0;i<this._ints;++i)this._inBlock[i]=this._partialBlock[i];if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),s>0&&!t)return e.putBytes(this._partialOutput.getBytes(s-this._partialBytes)),this._partialBytes=s,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0};ke.ofb=function(r){r=r||{},this.name="OFB",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=null,this._outBlock=new Array(this._ints),this._partialOutput=Yt.util.createBuffer(),this._partialBytes=0};ke.ofb.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");this._iv=X0(r.iv,this.blockSize),this._inBlock=this._iv.slice(0),this._partialBytes=0};ke.ofb.prototype.encrypt=function(r,e,t){var n=r.length();if(r.length()===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var i=0;i<this._ints;++i)e.putInt32(r.getInt32()^this._outBlock[i]),this._inBlock[i]=this._outBlock[i];return}var s=(this.blockSize-n)%this.blockSize;s>0&&(s=this.blockSize-s),this._partialOutput.clear();for(var i=0;i<this._ints;++i)this._partialOutput.putInt32(r.getInt32()^this._outBlock[i]);if(s>0)r.read-=this.blockSize;else for(var i=0;i<this._ints;++i)this._inBlock[i]=this._outBlock[i];if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),s>0&&!t)return e.putBytes(this._partialOutput.getBytes(s-this._partialBytes)),this._partialBytes=s,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0};ke.ofb.prototype.decrypt=ke.ofb.prototype.encrypt;ke.ctr=function(r){r=r||{},this.name="CTR",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=null,this._outBlock=new Array(this._ints),this._partialOutput=Yt.util.createBuffer(),this._partialBytes=0};ke.ctr.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");this._iv=X0(r.iv,this.blockSize),this._inBlock=this._iv.slice(0),this._partialBytes=0};ke.ctr.prototype.encrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize)for(var i=0;i<this._ints;++i)e.putInt32(r.getInt32()^this._outBlock[i]);else{var s=(this.blockSize-n)%this.blockSize;s>0&&(s=this.blockSize-s),this._partialOutput.clear();for(var i=0;i<this._ints;++i)this._partialOutput.putInt32(r.getInt32()^this._outBlock[i]);if(s>0&&(r.read-=this.blockSize),this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),s>0&&!t)return e.putBytes(this._partialOutput.getBytes(s-this._partialBytes)),this._partialBytes=s,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0}j0(this._inBlock)};ke.ctr.prototype.decrypt=ke.ctr.prototype.encrypt;ke.gcm=function(r){r=r||{},this.name="GCM",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=new Array(this._ints),this._outBlock=new Array(this._ints),this._partialOutput=Yt.util.createBuffer(),this._partialBytes=0,this._R=3774873600};ke.gcm.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");var e=Yt.util.createBuffer(r.iv);this._cipherLength=0;var t;if("additionalData"in r?t=Yt.util.createBuffer(r.additionalData):t=Yt.util.createBuffer(),"tagLength"in r?this._tagLength=r.tagLength:this._tagLength=128,this._tag=null,r.decrypt&&(this._tag=Yt.util.createBuffer(r.tag).getBytes(),this._tag.length!==this._tagLength/8))throw new Error("Authentication tag does not match tag length.");this._hashBlock=new Array(this._ints),this.tag=null,this._hashSubkey=new Array(this._ints),this.cipher.encrypt([0,0,0,0],this._hashSubkey),this.componentBits=4,this._m=this.generateHashTable(this._hashSubkey,this.componentBits);var n=e.length();if(n===12)this._j0=[e.getInt32(),e.getInt32(),e.getInt32(),1];else{for(this._j0=[0,0,0,0];e.length()>0;)this._j0=this.ghash(this._hashSubkey,this._j0,[e.getInt32(),e.getInt32(),e.getInt32(),e.getInt32()]);this._j0=this.ghash(this._hashSubkey,this._j0,[0,0].concat(d2(n*8)))}this._inBlock=this._j0.slice(0),j0(this._inBlock),this._partialBytes=0,t=Yt.util.createBuffer(t),this._aDataLength=d2(t.length()*8);var i=t.length()%this.blockSize;for(i&&t.fillWithByte(0,this.blockSize-i),this._s=[0,0,0,0];t.length()>0;)this._s=this.ghash(this._hashSubkey,this._s,[t.getInt32(),t.getInt32(),t.getInt32(),t.getInt32()])};ke.gcm.prototype.encrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var i=0;i<this._ints;++i)e.putInt32(this._outBlock[i]^=r.getInt32());this._cipherLength+=this.blockSize}else{var s=(this.blockSize-n)%this.blockSize;s>0&&(s=this.blockSize-s),this._partialOutput.clear();for(var i=0;i<this._ints;++i)this._partialOutput.putInt32(r.getInt32()^this._outBlock[i]);if(s<=0||t){if(t){var o=n%this.blockSize;this._cipherLength+=o,this._partialOutput.truncate(this.blockSize-o)}else this._cipherLength+=this.blockSize;for(var i=0;i<this._ints;++i)this._outBlock[i]=this._partialOutput.getInt32();this._partialOutput.read-=this.blockSize}if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),s>0&&!t)return r.read-=this.blockSize,e.putBytes(this._partialOutput.getBytes(s-this._partialBytes)),this._partialBytes=s,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0}this._s=this.ghash(this._hashSubkey,this._s,this._outBlock),j0(this._inBlock)};ke.gcm.prototype.decrypt=function(r,e,t){var n=r.length();if(n<this.blockSize&&!(t&&n>0))return!0;this.cipher.encrypt(this._inBlock,this._outBlock),j0(this._inBlock),this._hashBlock[0]=r.getInt32(),this._hashBlock[1]=r.getInt32(),this._hashBlock[2]=r.getInt32(),this._hashBlock[3]=r.getInt32(),this._s=this.ghash(this._hashSubkey,this._s,this._hashBlock);for(var i=0;i<this._ints;++i)e.putInt32(this._outBlock[i]^this._hashBlock[i]);n<this.blockSize?this._cipherLength+=n%this.blockSize:this._cipherLength+=this.blockSize};ke.gcm.prototype.afterFinish=function(r,e){var t=!0;e.decrypt&&e.overflow&&r.truncate(this.blockSize-e.overflow),this.tag=Yt.util.createBuffer();var n=this._aDataLength.concat(d2(this._cipherLength*8));this._s=this.ghash(this._hashSubkey,this._s,n);var i=[];this.cipher.encrypt(this._j0,i);for(var s=0;s<this._ints;++s)this.tag.putInt32(this._s[s]^i[s]);return this.tag.truncate(this.tag.length()%(this._tagLength/8)),e.decrypt&&this.tag.bytes()!==this._tag&&(t=!1),t};ke.gcm.prototype.multiply=function(r,e){for(var t=[0,0,0,0],n=e.slice(0),i=0;i<128;++i){var s=r[i/32|0]&1<<31-i%32;s&&(t[0]^=n[0],t[1]^=n[1],t[2]^=n[2],t[3]^=n[3]),this.pow(n,n)}return t};ke.gcm.prototype.pow=function(r,e){for(var t=r[3]&1,n=3;n>0;--n)e[n]=r[n]>>>1|(r[n-1]&1)<<31;e[0]=r[0]>>>1,t&&(e[0]^=this._R)};ke.gcm.prototype.tableMultiply=function(r){for(var e=[0,0,0,0],t=0;t<32;++t){var n=t/8|0,i=r[n]>>>(7-t%8)*4&15,s=this._m[t][i];e[0]^=s[0],e[1]^=s[1],e[2]^=s[2],e[3]^=s[3]}return e};ke.gcm.prototype.ghash=function(r,e,t){return e[0]^=t[0],e[1]^=t[1],e[2]^=t[2],e[3]^=t[3],this.tableMultiply(e)};ke.gcm.prototype.generateHashTable=function(r,e){for(var t=8/e,n=4*t,i=16*t,s=new Array(i),o=0;o<i;++o){var a=[0,0,0,0],c=o/n|0,l=(n-1-o%n)*e;a[c]=1<<e-1<<l,s[o]=this.generateSubHashTable(this.multiply(a,r),e)}return s};ke.gcm.prototype.generateSubHashTable=function(r,e){var t=1<<e,n=t>>>1,i=new Array(t);i[n]=r.slice(0);for(var s=n>>>1;s>0;)this.pow(i[2*s],i[s]=[]),s>>=1;for(s=2;s<n;){for(var o=1;o<s;++o){var a=i[s],c=i[o];i[s+o]=[a[0]^c[0],a[1]^c[1],a[2]^c[2],a[3]^c[3]]}s*=2}for(i[0]=[0,0,0,0],s=n+1;s<t;++s){var l=i[s^n];i[s]=[r[0]^l[0],r[1]^l[1],r[2]^l[2],r[3]^l[3]]}return i};function X0(r,e){if(typeof r=="string"&&(r=Yt.util.createBuffer(r)),Yt.util.isArray(r)&&r.length>4){var t=r;r=Yt.util.createBuffer();for(var n=0;n<t.length;++n)r.putByte(t[n])}if(r.length()<e)throw new Error("Invalid IV length; got "+r.length()+" bytes and expected "+e+" bytes.");if(!Yt.util.isArray(r)){for(var i=[],s=e/4,n=0;n<s;++n)i.push(r.getInt32());r=i}return r}function j0(r){r[r.length-1]=r[r.length-1]+1&4294967295}function d2(r){return[r/4294967296|0,r&4294967295]}});var J0=F((VJ,I7)=>{var rt=Qe();h2();p2();At();I7.exports=rt.aes=rt.aes||{};rt.aes.startEncrypting=function(r,e,t,n){var i=Z0({key:r,output:t,decrypt:!1,mode:n});return i.start(e),i};rt.aes.createEncryptionCipher=function(r,e){return Z0({key:r,output:null,decrypt:!1,mode:e})};rt.aes.startDecrypting=function(r,e,t,n){var i=Z0({key:r,output:t,decrypt:!0,mode:n});return i.start(e),i};rt.aes.createDecryptionCipher=function(r,e){return Z0({key:r,output:null,decrypt:!0,mode:e})};rt.aes.Algorithm=function(r,e){y2||S7();var t=this;t.name=r,t.mode=new e({blockSize:16,cipher:{encrypt:function(n,i){return g2(t._w,n,i,!1)},decrypt:function(n,i){return g2(t._w,n,i,!0)}}}),t._init=!1};rt.aes.Algorithm.prototype.initialize=function(r){if(!this._init){var e=r.key,t;if(typeof e=="string"&&(e.length===16||e.length===24||e.length===32))e=rt.util.createBuffer(e);else if(rt.util.isArray(e)&&(e.length===16||e.length===24||e.length===32)){t=e,e=rt.util.createBuffer();for(var n=0;n<t.length;++n)e.putByte(t[n])}if(!rt.util.isArray(e)){t=e,e=[];var i=t.length();if(i===16||i===24||i===32){i=i>>>2;for(var n=0;n<i;++n)e.push(t.getInt32())}}if(!rt.util.isArray(e)||!(e.length===4||e.length===6||e.length===8))throw new Error("Invalid key parameter.");var s=this.mode.name,o=["CFB","OFB","CTR","GCM"].indexOf(s)!==-1;this._w=R7(e,r.decrypt&&!o),this._init=!0}};rt.aes._expandKey=function(r,e){return y2||S7(),R7(r,e)};rt.aes._updateBlock=g2;Aa("AES-ECB",rt.cipher.modes.ecb);Aa("AES-CBC",rt.cipher.modes.cbc);Aa("AES-CFB",rt.cipher.modes.cfb);Aa("AES-OFB",rt.cipher.modes.ofb);Aa("AES-CTR",rt.cipher.modes.ctr);Aa("AES-GCM",rt.cipher.modes.gcm);function Aa(r,e){var t=function(){return new rt.aes.Algorithm(r,e)};rt.cipher.registerAlgorithm(r,t)}var y2=!1,Ia=4,xr,m2,_7,bo,qn;function S7(){y2=!0,_7=[0,1,2,4,8,16,32,64,128,27,54];for(var r=new Array(256),e=0;e<128;++e)r[e]=e<<1,r[e+128]=e+128<<1^283;xr=new Array(256),m2=new Array(256),bo=new Array(4),qn=new Array(4);for(var e=0;e<4;++e)bo[e]=new Array(256),qn[e]=new Array(256);for(var t=0,n=0,i,s,o,a,c,l,u,e=0;e<256;++e){a=n^n<<1^n<<2^n<<3^n<<4,a=a>>8^a&255^99,xr[t]=a,m2[a]=t,c=r[a],i=r[t],s=r[i],o=r[s],l=c<<24^a<<16^a<<8^(a^c),u=(i^s^o)<<24^(t^o)<<16^(t^s^o)<<8^(t^i^o);for(var f=0;f<4;++f)bo[f][t]=l,qn[f][a]=u,l=l<<24|l>>>8,u=u<<24|u>>>8;t===0?t=n=1:(t=i^r[r[r[i^o]]],n^=r[r[n]])}}function R7(r,e){for(var t=r.slice(0),n,i=1,s=t.length,o=s+6+1,a=Ia*o,c=s;c<a;++c)n=t[c-1],c%s===0?(n=xr[n>>>16&255]<<24^xr[n>>>8&255]<<16^xr[n&255]<<8^xr[n>>>24]^_7[i]<<24,i++):s>6&&c%s===4&&(n=xr[n>>>24]<<24^xr[n>>>16&255]<<16^xr[n>>>8&255]<<8^xr[n&255]),t[c]=t[c-s]^n;if(e){var l,u=qn[0],f=qn[1],h=qn[2],d=qn[3],p=t.slice(0);a=t.length;for(var c=0,m=a-Ia;c<a;c+=Ia,m-=Ia)if(c===0||c===a-Ia)p[c]=t[m],p[c+1]=t[m+3],p[c+2]=t[m+2],p[c+3]=t[m+1];else for(var g=0;g<Ia;++g)l=t[m+g],p[c+(3&-g)]=u[xr[l>>>24]]^f[xr[l>>>16&255]]^h[xr[l>>>8&255]]^d[xr[l&255]];t=p}return t}function g2(r,e,t,n){var i=r.length/4-1,s,o,a,c,l;n?(s=qn[0],o=qn[1],a=qn[2],c=qn[3],l=m2):(s=bo[0],o=bo[1],a=bo[2],c=bo[3],l=xr);var u,f,h,d,p,m,g;u=e[0]^r[0],f=e[n?3:1]^r[1],h=e[2]^r[2],d=e[n?1:3]^r[3];for(var y=3,w=1;w<i;++w)p=s[u>>>24]^o[f>>>16&255]^a[h>>>8&255]^c[d&255]^r[++y],m=s[f>>>24]^o[h>>>16&255]^a[d>>>8&255]^c[u&255]^r[++y],g=s[h>>>24]^o[d>>>16&255]^a[u>>>8&255]^c[f&255]^r[++y],d=s[d>>>24]^o[u>>>16&255]^a[f>>>8&255]^c[h&255]^r[++y],u=p,f=m,h=g;t[0]=l[u>>>24]<<24^l[f>>>16&255]<<16^l[h>>>8&255]<<8^l[d&255]^r[++y],t[n?3:1]=l[f>>>24]<<24^l[h>>>16&255]<<16^l[d>>>8&255]<<8^l[u&255]^r[++y],t[2]=l[h>>>24]<<24^l[d>>>16&255]<<16^l[u>>>8&255]<<8^l[f&255]^r[++y],t[n?1:3]=l[d>>>24]<<24^l[u>>>16&255]<<16^l[f>>>8&255]<<8^l[h&255]^r[++y]}function Z0(r){r=r||{};var e=(r.mode||"CBC").toUpperCase(),t="AES-"+e,n;r.decrypt?n=rt.cipher.createDecipher(t,r.key):n=rt.cipher.createCipher(t,r.key);var i=n.start;return n.start=function(s,o){var a=null;o instanceof rt.util.ByteBuffer&&(a=o,o={}),o=o||{},o.output=a,o.iv=s,i.call(n,o)},n}});var D7=F((qJ,T7)=>{var dt=Qe();h2();p2();At();T7.exports=dt.des=dt.des||{};dt.des.startEncrypting=function(r,e,t,n){var i=ef({key:r,output:t,decrypt:!1,mode:n||(e===null?"ECB":"CBC")});return i.start(e),i};dt.des.createEncryptionCipher=function(r,e){return ef({key:r,output:null,decrypt:!1,mode:e})};dt.des.startDecrypting=function(r,e,t,n){var i=ef({key:r,output:t,decrypt:!0,mode:n||(e===null?"ECB":"CBC")});return i.start(e),i};dt.des.createDecryptionCipher=function(r,e){return ef({key:r,output:null,decrypt:!0,mode:e})};dt.des.Algorithm=function(r,e){var t=this;t.name=r,t.mode=new e({blockSize:8,cipher:{encrypt:function(n,i){return A7(t._keys,n,i,!1)},decrypt:function(n,i){return A7(t._keys,n,i,!0)}}}),t._init=!1};dt.des.Algorithm.prototype.initialize=function(r){if(!this._init){var e=dt.util.createBuffer(r.key);if(this.name.indexOf("3DES")===0&&e.length()!==24)throw new Error("Invalid Triple-DES key size: "+e.length()*8);this._keys=Ck(e),this._init=!0}};li("DES-ECB",dt.cipher.modes.ecb);li("DES-CBC",dt.cipher.modes.cbc);li("DES-CFB",dt.cipher.modes.cfb);li("DES-OFB",dt.cipher.modes.ofb);li("DES-CTR",dt.cipher.modes.ctr);li("3DES-ECB",dt.cipher.modes.ecb);li("3DES-CBC",dt.cipher.modes.cbc);li("3DES-CFB",dt.cipher.modes.cfb);li("3DES-OFB",dt.cipher.modes.ofb);li("3DES-CTR",dt.cipher.modes.ctr);function li(r,e){var t=function(){return new dt.des.Algorithm(r,e)};dt.cipher.registerAlgorithm(r,t)}var vk=[16843776,0,65536,16843780,16842756,66564,4,65536,1024,16843776,16843780,1024,16778244,16842756,16777216,4,1028,16778240,16778240,66560,66560,16842752,16842752,16778244,65540,16777220,16777220,65540,0,1028,66564,16777216,65536,16843780,4,16842752,16843776,16777216,16777216,1024,16842756,65536,66560,16777220,1024,4,16778244,66564,16843780,65540,16842752,16778244,16777220,1028,66564,16843776,1028,16778240,16778240,0,65540,66560,0,16842756],_k=[-2146402272,-2147450880,32768,1081376,1048576,32,-2146435040,-2147450848,-2147483616,-2146402272,-2146402304,-2147483648,-2147450880,1048576,32,-2146435040,1081344,1048608,-2147450848,0,-2147483648,32768,1081376,-2146435072,1048608,-2147483616,0,1081344,32800,-2146402304,-2146435072,32800,0,1081376,-2146435040,1048576,-2147450848,-2146435072,-2146402304,32768,-2146435072,-2147450880,32,-2146402272,1081376,32,32768,-2147483648,32800,-2146402304,1048576,-2147483616,1048608,-2147450848,-2147483616,1048608,1081344,0,-2147450880,32800,-2147483648,-2146435040,-2146402272,1081344],Sk=[520,134349312,0,134348808,134218240,0,131592,134218240,131080,134217736,134217736,131072,134349320,131080,134348800,520,134217728,8,134349312,512,131584,134348800,134348808,131592,134218248,131584,131072,134218248,8,134349320,512,134217728,134349312,134217728,131080,520,131072,134349312,134218240,0,512,131080,134349320,134218240,134217736,512,0,134348808,134218248,131072,134217728,134349320,8,131592,131584,134217736,134348800,134218248,520,134348800,131592,8,134348808,131584],Rk=[8396801,8321,8321,128,8396928,8388737,8388609,8193,0,8396800,8396800,8396929,129,0,8388736,8388609,1,8192,8388608,8396801,128,8388608,8193,8320,8388737,1,8320,8388736,8192,8396928,8396929,129,8388736,8388609,8396800,8396929,129,0,0,8396800,8320,8388736,8388737,1,8396801,8321,8321,128,8396929,129,1,8192,8388609,8193,8396928,8388737,8193,8320,8388608,8396801,128,8388608,8192,8396928],Ik=[256,34078976,34078720,1107296512,524288,256,1073741824,34078720,1074266368,524288,33554688,1074266368,1107296512,1107820544,524544,1073741824,33554432,1074266112,1074266112,0,1073742080,1107820800,1107820800,33554688,1107820544,1073742080,0,1107296256,34078976,33554432,1107296256,524544,524288,1107296512,256,33554432,1073741824,34078720,1107296512,1074266368,33554688,1073741824,1107820544,34078976,1074266368,256,33554432,1107820544,1107820800,524544,1107296256,1107820800,34078720,0,1074266112,1107296256,524544,33554688,1073742080,524288,0,1074266112,34078976,1073742080],Ak=[536870928,541065216,16384,541081616,541065216,16,541081616,4194304,536887296,4210704,4194304,536870928,4194320,536887296,536870912,16400,0,4194320,536887312,16384,4210688,536887312,16,541065232,541065232,0,4210704,541081600,16400,4210688,541081600,536870912,536887296,16,541065232,4210688,541081616,4194304,16400,536870928,4194304,536887296,536870912,16400,536870928,541081616,4210688,541065216,4210704,541081600,0,541065232,16,16384,541065216,4210704,16384,4194320,536887312,0,541081600,536870912,4194320,536887312],Tk=[2097152,69206018,67110914,0,2048,67110914,2099202,69208064,69208066,2097152,0,67108866,2,67108864,69206018,2050,67110912,2099202,2097154,67110912,67108866,69206016,69208064,2097154,69206016,2048,2050,69208066,2099200,2,67108864,2099200,67108864,2099200,2097152,67110914,67110914,69206018,69206018,2,2097154,67108864,67110912,2097152,69208064,2050,2099202,69208064,2050,67108866,69208066,69206016,2099200,0,2,69208066,0,2099202,69206016,2048,67108866,67110912,2048,2097154],Dk=[268439616,4096,262144,268701760,268435456,268439616,64,268435456,262208,268697600,268701760,266240,268701696,266304,4096,64,268697600,268435520,268439552,4160,266240,262208,268697664,268701696,4160,0,0,268697664,268435520,268439552,266304,262144,266304,262144,268701696,4096,64,268697664,4096,266304,268439552,64,268435520,268697600,268697664,268435456,262144,268439616,0,268701760,262208,268435520,268697600,268439552,268439616,0,268701760,266240,266240,4160,4160,262208,268435456,268701696];function Ck(r){for(var e=[0,4,536870912,536870916,65536,65540,536936448,536936452,512,516,536871424,536871428,66048,66052,536936960,536936964],t=[0,1,1048576,1048577,67108864,67108865,68157440,68157441,256,257,1048832,1048833,67109120,67109121,68157696,68157697],n=[0,8,2048,2056,16777216,16777224,16779264,16779272,0,8,2048,2056,16777216,16777224,16779264,16779272],i=[0,2097152,134217728,136314880,8192,2105344,134225920,136323072,131072,2228224,134348800,136445952,139264,2236416,134356992,136454144],s=[0,262144,16,262160,0,262144,16,262160,4096,266240,4112,266256,4096,266240,4112,266256],o=[0,1024,32,1056,0,1024,32,1056,33554432,33555456,33554464,33555488,33554432,33555456,33554464,33555488],a=[0,268435456,524288,268959744,2,268435458,524290,268959746,0,268435456,524288,268959744,2,268435458,524290,268959746],c=[0,65536,2048,67584,536870912,536936448,536872960,536938496,131072,196608,133120,198656,537001984,537067520,537004032,537069568],l=[0,262144,0,262144,2,262146,2,262146,33554432,33816576,33554432,33816576,33554434,33816578,33554434,33816578],u=[0,268435456,8,268435464,0,268435456,8,268435464,1024,268436480,1032,268436488,1024,268436480,1032,268436488],f=[0,32,0,32,1048576,1048608,1048576,1048608,8192,8224,8192,8224,1056768,1056800,1056768,1056800],h=[0,16777216,512,16777728,2097152,18874368,2097664,18874880,67108864,83886080,67109376,83886592,69206016,85983232,69206528,85983744],d=[0,4096,134217728,134221824,524288,528384,134742016,134746112,16,4112,134217744,134221840,524304,528400,134742032,134746128],p=[0,4,256,260,0,4,256,260,1,5,257,261,1,5,257,261],m=r.length()>8?3:1,g=[],y=[0,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0],w=0,E,R=0;R<m;R++){var x=r.getInt32(),v=r.getInt32();E=(x>>>4^v)&252645135,v^=E,x^=E<<4,E=(v>>>-16^x)&65535,x^=E,v^=E<<-16,E=(x>>>2^v)&858993459,v^=E,x^=E<<2,E=(v>>>-16^x)&65535,x^=E,v^=E<<-16,E=(x>>>1^v)&1431655765,v^=E,x^=E<<1,E=(v>>>8^x)&16711935,x^=E,v^=E<<8,E=(x>>>1^v)&1431655765,v^=E,x^=E<<1,E=x<<8|v>>>20&240,x=v<<24|v<<8&16711680|v>>>8&65280|v>>>24&240,v=E;for(var I=0;I<y.length;++I){y[I]?(x=x<<2|x>>>26,v=v<<2|v>>>26):(x=x<<1|x>>>27,v=v<<1|v>>>27),x&=-15,v&=-15;var _=e[x>>>28]|t[x>>>24&15]|n[x>>>20&15]|i[x>>>16&15]|s[x>>>12&15]|o[x>>>8&15]|a[x>>>4&15],k=c[v>>>28]|l[v>>>24&15]|u[v>>>20&15]|f[v>>>16&15]|h[v>>>12&15]|d[v>>>8&15]|p[v>>>4&15];E=(k>>>16^_)&65535,g[w++]=_^E,g[w++]=k^E<<16}}return g}function A7(r,e,t,n){var i=r.length===32?3:9,s;i===3?s=n?[30,-2,-2]:[0,32,2]:s=n?[94,62,-2,32,64,2,30,-2,-2]:[0,32,2,62,30,-2,64,96,2];var o,a=e[0],c=e[1];o=(a>>>4^c)&252645135,c^=o,a^=o<<4,o=(a>>>16^c)&65535,c^=o,a^=o<<16,o=(c>>>2^a)&858993459,a^=o,c^=o<<2,o=(c>>>8^a)&16711935,a^=o,c^=o<<8,o=(a>>>1^c)&1431655765,c^=o,a^=o<<1,a=a<<1|a>>>31,c=c<<1|c>>>31;for(var l=0;l<i;l+=3){for(var u=s[l+1],f=s[l+2],h=s[l];h!=u;h+=f){var d=c^r[h],p=(c>>>4|c<<28)^r[h+1];o=a,a=c,c=o^(_k[d>>>24&63]|Rk[d>>>16&63]|Ak[d>>>8&63]|Dk[d&63]|vk[p>>>24&63]|Sk[p>>>16&63]|Ik[p>>>8&63]|Tk[p&63])}o=a,a=c,c=o}a=a>>>1|a<<31,c=c>>>1|c<<31,o=(a>>>1^c)&1431655765,c^=o,a^=o<<1,o=(c>>>8^a)&16711935,a^=o,c^=o<<8,o=(c>>>2^a)&858993459,a^=o,c^=o<<2,o=(a>>>16^c)&65535,c^=o,a^=o<<16,o=(a>>>4^c)&252645135,c^=o,a^=o<<4,t[0]=a,t[1]=c}function ef(r){r=r||{};var e=(r.mode||"CBC").toUpperCase(),t="DES-"+e,n;r.decrypt?n=dt.cipher.createDecipher(t,r.key):n=dt.cipher.createCipher(t,r.key);var i=n.start;return n.start=function(s,o){var a=null;o instanceof dt.util.ByteBuffer&&(a=o,o={}),o=o||{},o.output=a,o.iv=s,i.call(n,o)},n}});var wo=F((zJ,C7)=>{var tf=Qe();C7.exports=tf.md=tf.md||{};tf.md.algorithms=tf.md.algorithms||{}});var k7=F(($J,P7)=>{var Li=Qe();wo();At();var Pk=P7.exports=Li.hmac=Li.hmac||{};Pk.create=function(){var r=null,e=null,t=null,n=null,i={};return i.start=function(s,o){if(s!==null)if(typeof s=="string")if(s=s.toLowerCase(),s in Li.md.algorithms)e=Li.md.algorithms[s].create();else throw new Error('Unknown hash algorithm "'+s+'"');else e=s;if(o===null)o=r;else{if(typeof o=="string")o=Li.util.createBuffer(o);else if(Li.util.isArray(o)){var a=o;o=Li.util.createBuffer();for(var c=0;c<a.length;++c)o.putByte(a[c])}var l=o.length();l>e.blockLength&&(e.start(),e.update(o.bytes()),o=e.digest()),t=Li.util.createBuffer(),n=Li.util.createBuffer(),l=o.length();for(var c=0;c<l;++c){var a=o.at(c);t.putByte(54^a),n.putByte(92^a)}if(l<e.blockLength)for(var a=e.blockLength-l,c=0;c<a;++c)t.putByte(54),n.putByte(92);r=o,t=t.bytes(),n=n.bytes()}e.start(),e.update(t)},i.update=function(s){e.update(s)},i.getMac=function(){var s=e.digest().bytes();return e.start(),e.update(n),e.update(s),e.digest()},i.digest=i.getMac,i}});var xl=F(()=>{});var b2=F((GJ,N7)=>{var vr=Qe();k7();wo();At();var kk=vr.pkcs5=vr.pkcs5||{},Bi;vr.util.isNodejs&&!vr.options.usePureJavaScript&&(Bi=xl());N7.exports=vr.pbkdf2=kk.pbkdf2=function(r,e,t,n,i,s){if(typeof i=="function"&&(s=i,i=null),vr.util.isNodejs&&!vr.options.usePureJavaScript&&Bi.pbkdf2&&(i===null||typeof i!="object")&&(Bi.pbkdf2Sync.length>4||!i||i==="sha1"))return typeof i!="string"&&(i="sha1"),r=Buffer.from(r,"binary"),e=Buffer.from(e,"binary"),s?Bi.pbkdf2Sync.length===4?Bi.pbkdf2(r,e,t,n,function(E,R){if(E)return s(E);s(null,R.toString("binary"))}):Bi.pbkdf2(r,e,t,n,i,function(E,R){if(E)return s(E);s(null,R.toString("binary"))}):Bi.pbkdf2Sync.length===4?Bi.pbkdf2Sync(r,e,t,n).toString("binary"):Bi.pbkdf2Sync(r,e,t,n,i).toString("binary");if((typeof i>"u"||i===null)&&(i="sha1"),typeof i=="string"){if(!(i in vr.md.algorithms))throw new Error("Unknown hash algorithm: "+i);i=vr.md[i].create()}var o=i.digestLength;if(n>4294967295*o){var a=new Error("Derived key is too long.");if(s)return s(a);throw a}var c=Math.ceil(n/o),l=n-(c-1)*o,u=vr.hmac.create();u.start(i,r);var f="",h,d,p;if(!s){for(var m=1;m<=c;++m){u.start(null,null),u.update(e),u.update(vr.util.int32ToBytes(m)),h=p=u.digest().getBytes();for(var g=2;g<=t;++g)u.start(null,null),u.update(p),d=u.digest().getBytes(),h=vr.util.xorBytes(h,d,o),p=d;f+=m<c?h:h.substr(0,l)}return f}var m=1,g;function y(){if(m>c)return s(null,f);u.start(null,null),u.update(e),u.update(vr.util.int32ToBytes(m)),h=p=u.digest().getBytes(),g=2,w()}function w(){if(g<=t)return u.start(null,null),u.update(p),d=u.digest().getBytes(),h=vr.util.xorBytes(h,d,o),p=d,++g,vr.util.setImmediate(w);f+=m<c?h:h.substr(0,l),++m,y()}y()}});var B7=F((YJ,L7)=>{var nf=Qe();At();var O7=L7.exports=nf.pem=nf.pem||{};O7.encode=function(r,e){e=e||{};var t="-----BEGIN "+r.type+`-----\r
`,n;if(r.procType&&(n={name:"Proc-Type",values:[String(r.procType.version),r.procType.type]},t+=rf(n)),r.contentDomain&&(n={name:"Content-Domain",values:[r.contentDomain]},t+=rf(n)),r.dekInfo&&(n={name:"DEK-Info",values:[r.dekInfo.algorithm]},r.dekInfo.parameters&&n.values.push(r.dekInfo.parameters),t+=rf(n)),r.headers)for(var i=0;i<r.headers.length;++i)t+=rf(r.headers[i]);return r.procType&&(t+=`\r
`),t+=nf.util.encode64(r.body,e.maxline||64)+`\r
`,t+="-----END "+r.type+`-----\r
`,t};O7.decode=function(r){for(var e=[],t=/\s*-----BEGIN ([A-Z0-9- ]+)-----\r?\n?([\x21-\x7e\s]+?(?:\r?\n\r?\n))?([:A-Za-z0-9+\/=\s]+?)-----END \1-----/g,n=/([\x21-\x7e]+):\s*([\x21-\x7e\s^:]+)/,i=/\r?\n/,s;s=t.exec(r),!!s;){var o=s[1];o==="NEW CERTIFICATE REQUEST"&&(o="CERTIFICATE REQUEST");var a={type:o,procType:null,contentDomain:null,dekInfo:null,headers:[],body:nf.util.decode64(s[3])};if(e.push(a),!!s[2]){for(var c=s[2].split(i),l=0;s&&l<c.length;){for(var u=c[l].replace(/\s+$/,""),f=l+1;f<c.length;++f){var h=c[f];if(!/\s/.test(h[0]))break;u+=h,l=f}if(s=u.match(n),s){for(var d={name:s[1],values:[]},p=s[2].split(","),m=0;m<p.length;++m)d.values.push(Nk(p[m]));if(a.procType)if(!a.contentDomain&&d.name==="Content-Domain")a.contentDomain=p[0]||"";else if(!a.dekInfo&&d.name==="DEK-Info"){if(d.values.length===0)throw new Error('Invalid PEM formatted message. The "DEK-Info" header must have at least one subfield.');a.dekInfo={algorithm:p[0],parameters:p[1]||null}}else a.headers.push(d);else{if(d.name!=="Proc-Type")throw new Error('Invalid PEM formatted message. The first encapsulated header must be "Proc-Type".');if(d.values.length!==2)throw new Error('Invalid PEM formatted message. The "Proc-Type" header must have two subfields.');a.procType={version:p[0],type:p[1]}}}++l}if(a.procType==="ENCRYPTED"&&!a.dekInfo)throw new Error('Invalid PEM formatted message. The "DEK-Info" header must be present if "Proc-Type" is "ENCRYPTED".')}}if(e.length===0)throw new Error("Invalid PEM formatted message.");return e};function rf(r){for(var e=r.name+": ",t=[],n=function(c,l){return" "+l},i=0;i<r.values.length;++i)t.push(r.values[i].replace(/^(\S+\r\n)/,n));e+=t.join(",")+`\r
`;for(var s=0,o=-1,i=0;i<e.length;++i,++s)if(s>65&&o!==-1){var a=e[o];a===","?(++o,e=e.substr(0,o)+`\r
 `+e.substr(o)):e=e.substr(0,o)+`\r
`+a+e.substr(o+1),s=i-o-1,o=-1,++i}else(e[i]===" "||e[i]==="	"||e[i]===",")&&(o=i);return e}function Nk(r){return r.replace(/^\s+/,"")}});var q7=F((QJ,V7)=>{var ui=Qe();wo();At();var U7=V7.exports=ui.sha256=ui.sha256||{};ui.md.sha256=ui.md.algorithms.sha256=U7;U7.create=function(){F7||Ok();var r=null,e=ui.util.createBuffer(),t=new Array(64),n={algorithm:"sha256",blockLength:64,digestLength:32,messageLength:0,fullMessageLength:null,messageLengthSize:8};return n.start=function(){n.messageLength=0,n.fullMessageLength=n.messageLength64=[];for(var i=n.messageLengthSize/4,s=0;s<i;++s)n.fullMessageLength.push(0);return e=ui.util.createBuffer(),r={h0:1779033703,h1:3144134277,h2:1013904242,h3:2773480762,h4:1359893119,h5:2600822924,h6:528734635,h7:1541459225},n},n.start(),n.update=function(i,s){s==="utf8"&&(i=ui.util.encodeUtf8(i));var o=i.length;n.messageLength+=o,o=[o/4294967296>>>0,o>>>0];for(var a=n.fullMessageLength.length-1;a>=0;--a)n.fullMessageLength[a]+=o[1],o[1]=o[0]+(n.fullMessageLength[a]/4294967296>>>0),n.fullMessageLength[a]=n.fullMessageLength[a]>>>0,o[0]=o[1]/4294967296>>>0;return e.putBytes(i),M7(r,t,e),(e.read>2048||e.length()===0)&&e.compact(),n},n.digest=function(){var i=ui.util.createBuffer();i.putBytes(e.bytes());var s=n.fullMessageLength[n.fullMessageLength.length-1]+n.messageLengthSize,o=s&n.blockLength-1;i.putBytes(w2.substr(0,n.blockLength-o));for(var a,c,l=n.fullMessageLength[0]*8,u=0;u<n.fullMessageLength.length-1;++u)a=n.fullMessageLength[u+1]*8,c=a/4294967296>>>0,l+=c,i.putInt32(l>>>0),l=a>>>0;i.putInt32(l);var f={h0:r.h0,h1:r.h1,h2:r.h2,h3:r.h3,h4:r.h4,h5:r.h5,h6:r.h6,h7:r.h7};M7(f,t,i);var h=ui.util.createBuffer();return h.putInt32(f.h0),h.putInt32(f.h1),h.putInt32(f.h2),h.putInt32(f.h3),h.putInt32(f.h4),h.putInt32(f.h5),h.putInt32(f.h6),h.putInt32(f.h7),h},n};var w2=null,F7=!1,K7=null;function Ok(){w2=String.fromCharCode(128),w2+=ui.util.fillString(String.fromCharCode(0),64),K7=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],F7=!0}function M7(r,e,t){for(var n,i,s,o,a,c,l,u,f,h,d,p,m,g,y,w=t.length();w>=64;){for(l=0;l<16;++l)e[l]=t.getInt32();for(;l<64;++l)n=e[l-2],n=(n>>>17|n<<15)^(n>>>19|n<<13)^n>>>10,i=e[l-15],i=(i>>>7|i<<25)^(i>>>18|i<<14)^i>>>3,e[l]=n+e[l-7]+i+e[l-16]|0;for(u=r.h0,f=r.h1,h=r.h2,d=r.h3,p=r.h4,m=r.h5,g=r.h6,y=r.h7,l=0;l<64;++l)o=(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7),a=g^p&(m^g),s=(u>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),c=u&f|h&(u^f),n=y+o+a+K7[l]+e[l],i=s+c,y=g,g=m,m=p,p=d+n>>>0,d=h,h=f,f=u,u=n+i>>>0;r.h0=r.h0+u|0,r.h1=r.h1+f|0,r.h2=r.h2+h|0,r.h3=r.h3+d|0,r.h4=r.h4+p|0,r.h5=r.h5+m|0,r.h6=r.h6+g|0,r.h7=r.h7+y|0,w-=64}}});var $7=F((XJ,z7)=>{var fi=Qe();At();var sf=null;fi.util.isNodejs&&!fi.options.usePureJavaScript&&!process.versions["node-webkit"]&&(sf=xl());var Lk=z7.exports=fi.prng=fi.prng||{};Lk.create=function(r){for(var e={plugin:r,key:null,seed:null,time:null,reseeds:0,generated:0,keyBytes:""},t=r.md,n=new Array(32),i=0;i<32;++i)n[i]=t.create();e.pools=n,e.pool=0,e.generate=function(l,u){if(!u)return e.generateSync(l);var f=e.plugin.cipher,h=e.plugin.increment,d=e.plugin.formatKey,p=e.plugin.formatSeed,m=fi.util.createBuffer();e.key=null,g();function g(y){if(y)return u(y);if(m.length()>=l)return u(null,m.getBytes(l));if(e.generated>1048575&&(e.key=null),e.key===null)return fi.util.nextTick(function(){s(g)});var w=f(e.key,e.seed);e.generated+=w.length,m.putBytes(w),e.key=d(f(e.key,h(e.seed))),e.seed=p(f(e.key,e.seed)),fi.util.setImmediate(g)}},e.generateSync=function(l){var u=e.plugin.cipher,f=e.plugin.increment,h=e.plugin.formatKey,d=e.plugin.formatSeed;e.key=null;for(var p=fi.util.createBuffer();p.length()<l;){e.generated>1048575&&(e.key=null),e.key===null&&o();var m=u(e.key,e.seed);e.generated+=m.length,p.putBytes(m),e.key=h(u(e.key,f(e.seed))),e.seed=d(u(e.key,e.seed))}return p.getBytes(l)};function s(l){if(e.pools[0].messageLength>=32)return a(),l();var u=32-e.pools[0].messageLength<<5;e.seedFile(u,function(f,h){if(f)return l(f);e.collect(h),a(),l()})}function o(){if(e.pools[0].messageLength>=32)return a();var l=32-e.pools[0].messageLength<<5;e.collect(e.seedFileSync(l)),a()}function a(){e.reseeds=e.reseeds===4294967295?0:e.reseeds+1;var l=e.plugin.md.create();l.update(e.keyBytes);for(var u=1,f=0;f<32;++f)e.reseeds%u===0&&(l.update(e.pools[f].digest().getBytes()),e.pools[f].start()),u=u<<1;e.keyBytes=l.digest().getBytes(),l.start(),l.update(e.keyBytes);var h=l.digest().getBytes();e.key=e.plugin.formatKey(e.keyBytes),e.seed=e.plugin.formatSeed(h),e.generated=0}function c(l){var u=null,f=fi.util.globalScope,h=f.crypto||f.msCrypto;h&&h.getRandomValues&&(u=function(x){return h.getRandomValues(x)});var d=fi.util.createBuffer();if(u)for(;d.length()<l;){var p=Math.max(1,Math.min(l-d.length(),65536)/4),m=new Uint32Array(Math.floor(p));try{u(m);for(var g=0;g<m.length;++g)d.putInt32(m[g])}catch(x){if(!(typeof QuotaExceededError<"u"&&x instanceof QuotaExceededError))throw x}}if(d.length()<l)for(var y,w,E,R=Math.floor(Math.random()*65536);d.length()<l;){w=16807*(R&65535),y=16807*(R>>16),w+=(y&32767)<<16,w+=y>>15,w=(w&2147483647)+(w>>31),R=w&4294967295;for(var g=0;g<3;++g)E=R>>>(g<<3),E^=Math.floor(Math.random()*256),d.putByte(E&255)}return d.getBytes(l)}return sf?(e.seedFile=function(l,u){sf.randomBytes(l,function(f,h){if(f)return u(f);u(null,h.toString())})},e.seedFileSync=function(l){return sf.randomBytes(l).toString()}):(e.seedFile=function(l,u){try{u(null,c(l))}catch(f){u(f)}},e.seedFileSync=c),e.collect=function(l){for(var u=l.length,f=0;f<u;++f)e.pools[e.pool].update(l.substr(f,1)),e.pool=e.pool===31?0:e.pool+1},e.collectInt=function(l,u){for(var f="",h=0;h<u;h+=8)f+=String.fromCharCode(l>>h&255);e.collect(f)},e.registerWorker=function(l){if(l===self)e.seedFile=function(f,h){function d(p){var m=p.data;m.forge&&m.forge.prng&&(self.removeEventListener("message",d),h(m.forge.prng.err,m.forge.prng.bytes))}self.addEventListener("message",d),self.postMessage({forge:{prng:{needed:f}}})};else{var u=function(f){var h=f.data;h.forge&&h.forge.prng&&e.seedFile(h.forge.prng.needed,function(d,p){l.postMessage({forge:{prng:{err:d,bytes:p}}})})};l.addEventListener("message",u)}},e}});var vl=F((jJ,E2)=>{var Qt=Qe();J0();q7();$7();At();(function(){if(Qt.random&&Qt.random.getBytes){E2.exports=Qt.random;return}(function(r){var e={},t=new Array(4),n=Qt.util.createBuffer();e.formatKey=function(f){var h=Qt.util.createBuffer(f);return f=new Array(4),f[0]=h.getInt32(),f[1]=h.getInt32(),f[2]=h.getInt32(),f[3]=h.getInt32(),Qt.aes._expandKey(f,!1)},e.formatSeed=function(f){var h=Qt.util.createBuffer(f);return f=new Array(4),f[0]=h.getInt32(),f[1]=h.getInt32(),f[2]=h.getInt32(),f[3]=h.getInt32(),f},e.cipher=function(f,h){return Qt.aes._updateBlock(f,h,t,!1),n.putInt32(t[0]),n.putInt32(t[1]),n.putInt32(t[2]),n.putInt32(t[3]),n.getBytes()},e.increment=function(f){return++f[3],f},e.md=Qt.md.sha256;function i(){var f=Qt.prng.create(e);return f.getBytes=function(h,d){return f.generate(h,d)},f.getBytesSync=function(h){return f.generate(h)},f}var s=i(),o=null,a=Qt.util.globalScope,c=a.crypto||a.msCrypto;if(c&&c.getRandomValues&&(o=function(f){return c.getRandomValues(f)}),Qt.options.usePureJavaScript||!Qt.util.isNodejs&&!o){if(typeof window>"u"||window.document,s.collectInt(+new Date,32),typeof navigator<"u"){var l="";for(var u in navigator)try{typeof navigator[u]=="string"&&(l+=navigator[u])}catch{}s.collect(l),l=null}r&&(r().mousemove(function(f){s.collectInt(f.clientX,16),s.collectInt(f.clientY,16)}),r().keypress(function(f){s.collectInt(f.charCode,8)}))}if(!Qt.random)Qt.random=s;else for(var u in s)Qt.random[u]=s[u];Qt.random.createInstance=i,E2.exports=Qt.random})(typeof jQuery<"u"?jQuery:null)})()});var Y7=F((ZJ,G7)=>{var Nr=Qe();At();var x2=[217,120,249,196,25,221,181,237,40,233,253,121,74,160,216,157,198,126,55,131,43,118,83,142,98,76,100,136,68,139,251,162,23,154,89,245,135,179,79,19,97,69,109,141,9,129,125,50,189,143,64,235,134,183,123,11,240,149,33,34,92,107,78,130,84,214,101,147,206,96,178,28,115,86,192,20,167,140,241,220,18,117,202,31,59,190,228,209,66,61,212,48,163,60,182,38,111,191,14,218,70,105,7,87,39,242,29,155,188,148,67,3,248,17,199,246,144,239,62,231,6,195,213,47,200,102,30,215,8,232,234,222,128,82,238,247,132,170,114,172,53,77,106,42,150,26,210,113,90,21,73,116,75,159,208,94,4,24,164,236,194,224,65,110,15,81,203,204,36,145,175,80,161,244,112,57,153,124,58,133,35,184,180,122,252,2,54,91,37,85,151,49,45,93,250,152,227,138,146,174,5,223,41,16,103,108,186,201,211,0,230,207,225,158,168,44,99,22,1,63,88,226,137,169,13,56,52,27,171,51,255,176,187,72,12,95,185,177,205,46,197,243,219,71,229,165,156,119,10,166,32,104,254,127,193,173],H7=[1,2,3,5],Bk=function(r,e){return r<<e&65535|(r&65535)>>16-e},Mk=function(r,e){return(r&65535)>>e|r<<16-e&65535};G7.exports=Nr.rc2=Nr.rc2||{};Nr.rc2.expandKey=function(r,e){typeof r=="string"&&(r=Nr.util.createBuffer(r)),e=e||128;var t=r,n=r.length(),i=e,s=Math.ceil(i/8),o=255>>(i&7),a;for(a=n;a<128;a++)t.putByte(x2[t.at(a-1)+t.at(a-n)&255]);for(t.setAt(128-s,x2[t.at(128-s)&o]),a=127-s;a>=0;a--)t.setAt(a,x2[t.at(a+1)^t.at(a+s)]);return t};var W7=function(r,e,t){var n=!1,i=null,s=null,o=null,a,c,l,u,f=[];for(r=Nr.rc2.expandKey(r,e),l=0;l<64;l++)f.push(r.getInt16Le());t?(a=function(p){for(l=0;l<4;l++)p[l]+=f[u]+(p[(l+3)%4]&p[(l+2)%4])+(~p[(l+3)%4]&p[(l+1)%4]),p[l]=Bk(p[l],H7[l]),u++},c=function(p){for(l=0;l<4;l++)p[l]+=f[p[(l+3)%4]&63]}):(a=function(p){for(l=3;l>=0;l--)p[l]=Mk(p[l],H7[l]),p[l]-=f[u]+(p[(l+3)%4]&p[(l+2)%4])+(~p[(l+3)%4]&p[(l+1)%4]),u--},c=function(p){for(l=3;l>=0;l--)p[l]-=f[p[(l+3)%4]&63]});var h=function(p){var m=[];for(l=0;l<4;l++){var g=i.getInt16Le();o!==null&&(t?g^=o.getInt16Le():o.putInt16Le(g)),m.push(g&65535)}u=t?0:63;for(var y=0;y<p.length;y++)for(var w=0;w<p[y][0];w++)p[y][1](m);for(l=0;l<4;l++)o!==null&&(t?o.putInt16Le(m[l]):m[l]^=o.getInt16Le()),s.putInt16Le(m[l])},d=null;return d={start:function(p,m){p&&typeof p=="string"&&(p=Nr.util.createBuffer(p)),n=!1,i=Nr.util.createBuffer(),s=m||new Nr.util.createBuffer,o=p,d.output=s},update:function(p){for(n||i.putBuffer(p);i.length()>=8;)h([[5,a],[1,c],[6,a],[1,c],[5,a]])},finish:function(p){var m=!0;if(t)if(p)m=p(8,i,!t);else{var g=i.length()===8?8:8-i.length();i.fillWithByte(g,g)}if(m&&(n=!0,d.update()),!t&&(m=i.length()===0,m))if(p)m=p(8,s,!t);else{var y=s.length(),w=s.at(y-1);w>y?m=!1:s.truncate(w)}return m}},d};Nr.rc2.startEncrypting=function(r,e,t){var n=Nr.rc2.createEncryptionCipher(r,128);return n.start(e,t),n};Nr.rc2.createEncryptionCipher=function(r,e){return W7(r,e,!0)};Nr.rc2.startDecrypting=function(r,e,t){var n=Nr.rc2.createDecryptionCipher(r,128);return n.start(e,t),n};Nr.rc2.createDecryptionCipher=function(r,e){return W7(r,e,!1)}});var cf=F((JJ,r9)=>{var v2=Qe();r9.exports=v2.jsbn=v2.jsbn||{};var Mi,Uk=0xdeadbeefcafe,Q7=(Uk&16777215)==15715070;function V(r,e,t){this.data=[],r!=null&&(typeof r=="number"?this.fromNumber(r,e,t):e==null&&typeof r!="string"?this.fromString(r,256):this.fromString(r,e))}v2.jsbn.BigInteger=V;function Ue(){return new V(null)}function Fk(r,e,t,n,i,s){for(;--s>=0;){var o=e*this.data[r++]+t.data[n]+i;i=Math.floor(o/67108864),t.data[n++]=o&67108863}return i}function Kk(r,e,t,n,i,s){for(var o=e&32767,a=e>>15;--s>=0;){var c=this.data[r]&32767,l=this.data[r++]>>15,u=a*c+l*o;c=o*c+((u&32767)<<15)+t.data[n]+(i&1073741823),i=(c>>>30)+(u>>>15)+a*l+(i>>>30),t.data[n++]=c&1073741823}return i}function X7(r,e,t,n,i,s){for(var o=e&16383,a=e>>14;--s>=0;){var c=this.data[r]&16383,l=this.data[r++]>>14,u=a*c+l*o;c=o*c+((u&16383)<<14)+t.data[n]+i,i=(c>>28)+(u>>14)+a*l,t.data[n++]=c&268435455}return i}typeof navigator>"u"?(V.prototype.am=X7,Mi=28):Q7&&navigator.appName=="Microsoft Internet Explorer"?(V.prototype.am=Kk,Mi=30):Q7&&navigator.appName!="Netscape"?(V.prototype.am=Fk,Mi=26):(V.prototype.am=X7,Mi=28);V.prototype.DB=Mi;V.prototype.DM=(1<<Mi)-1;V.prototype.DV=1<<Mi;var _2=52;V.prototype.FV=Math.pow(2,_2);V.prototype.F1=_2-Mi;V.prototype.F2=2*Mi-_2;var Vk="0123456789abcdefghijklmnopqrstuvwxyz",of=new Array,Ta,bn;Ta="0".charCodeAt(0);for(bn=0;bn<=9;++bn)of[Ta++]=bn;Ta="a".charCodeAt(0);for(bn=10;bn<36;++bn)of[Ta++]=bn;Ta="A".charCodeAt(0);for(bn=10;bn<36;++bn)of[Ta++]=bn;function j7(r){return Vk.charAt(r)}function Z7(r,e){var t=of[r.charCodeAt(e)];return t??-1}function qk(r){for(var e=this.t-1;e>=0;--e)r.data[e]=this.data[e];r.t=this.t,r.s=this.s}function zk(r){this.t=1,this.s=r<0?-1:0,r>0?this.data[0]=r:r<-1?this.data[0]=r+this.DV:this.t=0}function Es(r){var e=Ue();return e.fromInt(r),e}function $k(r,e){var t;if(e==16)t=4;else if(e==8)t=3;else if(e==256)t=8;else if(e==2)t=1;else if(e==32)t=5;else if(e==4)t=2;else{this.fromRadix(r,e);return}this.t=0,this.s=0;for(var n=r.length,i=!1,s=0;--n>=0;){var o=t==8?r[n]&255:Z7(r,n);if(o<0){r.charAt(n)=="-"&&(i=!0);continue}i=!1,s==0?this.data[this.t++]=o:s+t>this.DB?(this.data[this.t-1]|=(o&(1<<this.DB-s)-1)<<s,this.data[this.t++]=o>>this.DB-s):this.data[this.t-1]|=o<<s,s+=t,s>=this.DB&&(s-=this.DB)}t==8&&r[0]&128&&(this.s=-1,s>0&&(this.data[this.t-1]|=(1<<this.DB-s)-1<<s)),this.clamp(),i&&V.ZERO.subTo(this,this)}function Hk(){for(var r=this.s&this.DM;this.t>0&&this.data[this.t-1]==r;)--this.t}function Wk(r){if(this.s<0)return"-"+this.negate().toString(r);var e;if(r==16)e=4;else if(r==8)e=3;else if(r==2)e=1;else if(r==32)e=5;else if(r==4)e=2;else return this.toRadix(r);var t=(1<<e)-1,n,i=!1,s="",o=this.t,a=this.DB-o*this.DB%e;if(o-- >0)for(a<this.DB&&(n=this.data[o]>>a)>0&&(i=!0,s=j7(n));o>=0;)a<e?(n=(this.data[o]&(1<<a)-1)<<e-a,n|=this.data[--o]>>(a+=this.DB-e)):(n=this.data[o]>>(a-=e)&t,a<=0&&(a+=this.DB,--o)),n>0&&(i=!0),i&&(s+=j7(n));return i?s:"0"}function Gk(){var r=Ue();return V.ZERO.subTo(this,r),r}function Yk(){return this.s<0?this.negate():this}function Qk(r){var e=this.s-r.s;if(e!=0)return e;var t=this.t;if(e=t-r.t,e!=0)return this.s<0?-e:e;for(;--t>=0;)if((e=this.data[t]-r.data[t])!=0)return e;return 0}function af(r){var e=1,t;return(t=r>>>16)!=0&&(r=t,e+=16),(t=r>>8)!=0&&(r=t,e+=8),(t=r>>4)!=0&&(r=t,e+=4),(t=r>>2)!=0&&(r=t,e+=2),(t=r>>1)!=0&&(r=t,e+=1),e}function Xk(){return this.t<=0?0:this.DB*(this.t-1)+af(this.data[this.t-1]^this.s&this.DM)}function jk(r,e){var t;for(t=this.t-1;t>=0;--t)e.data[t+r]=this.data[t];for(t=r-1;t>=0;--t)e.data[t]=0;e.t=this.t+r,e.s=this.s}function Zk(r,e){for(var t=r;t<this.t;++t)e.data[t-r]=this.data[t];e.t=Math.max(this.t-r,0),e.s=this.s}function Jk(r,e){var t=r%this.DB,n=this.DB-t,i=(1<<n)-1,s=Math.floor(r/this.DB),o=this.s<<t&this.DM,a;for(a=this.t-1;a>=0;--a)e.data[a+s+1]=this.data[a]>>n|o,o=(this.data[a]&i)<<t;for(a=s-1;a>=0;--a)e.data[a]=0;e.data[s]=o,e.t=this.t+s+1,e.s=this.s,e.clamp()}function eN(r,e){e.s=this.s;var t=Math.floor(r/this.DB);if(t>=this.t){e.t=0;return}var n=r%this.DB,i=this.DB-n,s=(1<<n)-1;e.data[0]=this.data[t]>>n;for(var o=t+1;o<this.t;++o)e.data[o-t-1]|=(this.data[o]&s)<<i,e.data[o-t]=this.data[o]>>n;n>0&&(e.data[this.t-t-1]|=(this.s&s)<<i),e.t=this.t-t,e.clamp()}function tN(r,e){for(var t=0,n=0,i=Math.min(r.t,this.t);t<i;)n+=this.data[t]-r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;if(r.t<this.t){for(n-=r.s;t<this.t;)n+=this.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;t<r.t;)n-=r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n-=r.s}e.s=n<0?-1:0,n<-1?e.data[t++]=this.DV+n:n>0&&(e.data[t++]=n),e.t=t,e.clamp()}function rN(r,e){var t=this.abs(),n=r.abs(),i=t.t;for(e.t=i+n.t;--i>=0;)e.data[i]=0;for(i=0;i<n.t;++i)e.data[i+t.t]=t.am(0,n.data[i],e,i,0,t.t);e.s=0,e.clamp(),this.s!=r.s&&V.ZERO.subTo(e,e)}function nN(r){for(var e=this.abs(),t=r.t=2*e.t;--t>=0;)r.data[t]=0;for(t=0;t<e.t-1;++t){var n=e.am(t,e.data[t],r,2*t,0,1);(r.data[t+e.t]+=e.am(t+1,2*e.data[t],r,2*t+1,n,e.t-t-1))>=e.DV&&(r.data[t+e.t]-=e.DV,r.data[t+e.t+1]=1)}r.t>0&&(r.data[r.t-1]+=e.am(t,e.data[t],r,2*t,0,1)),r.s=0,r.clamp()}function iN(r,e,t){var n=r.abs();if(!(n.t<=0)){var i=this.abs();if(i.t<n.t){e?.fromInt(0),t!=null&&this.copyTo(t);return}t==null&&(t=Ue());var s=Ue(),o=this.s,a=r.s,c=this.DB-af(n.data[n.t-1]);c>0?(n.lShiftTo(c,s),i.lShiftTo(c,t)):(n.copyTo(s),i.copyTo(t));var l=s.t,u=s.data[l-1];if(u!=0){var f=u*(1<<this.F1)+(l>1?s.data[l-2]>>this.F2:0),h=this.FV/f,d=(1<<this.F1)/f,p=1<<this.F2,m=t.t,g=m-l,y=e??Ue();for(s.dlShiftTo(g,y),t.compareTo(y)>=0&&(t.data[t.t++]=1,t.subTo(y,t)),V.ONE.dlShiftTo(l,y),y.subTo(s,s);s.t<l;)s.data[s.t++]=0;for(;--g>=0;){var w=t.data[--m]==u?this.DM:Math.floor(t.data[m]*h+(t.data[m-1]+p)*d);if((t.data[m]+=s.am(0,w,t,g,0,l))<w)for(s.dlShiftTo(g,y),t.subTo(y,t);t.data[m]<--w;)t.subTo(y,t)}e!=null&&(t.drShiftTo(l,e),o!=a&&V.ZERO.subTo(e,e)),t.t=l,t.clamp(),c>0&&t.rShiftTo(c,t),o<0&&V.ZERO.subTo(t,t)}}}function sN(r){var e=Ue();return this.abs().divRemTo(r,null,e),this.s<0&&e.compareTo(V.ZERO)>0&&r.subTo(e,e),e}function Eo(r){this.m=r}function oN(r){return r.s<0||r.compareTo(this.m)>=0?r.mod(this.m):r}function aN(r){return r}function cN(r){r.divRemTo(this.m,null,r)}function lN(r,e,t){r.multiplyTo(e,t),this.reduce(t)}function uN(r,e){r.squareTo(e),this.reduce(e)}Eo.prototype.convert=oN;Eo.prototype.revert=aN;Eo.prototype.reduce=cN;Eo.prototype.mulTo=lN;Eo.prototype.sqrTo=uN;function fN(){if(this.t<1)return 0;var r=this.data[0];if(!(r&1))return 0;var e=r&3;return e=e*(2-(r&15)*e)&15,e=e*(2-(r&255)*e)&255,e=e*(2-((r&65535)*e&65535))&65535,e=e*(2-r*e%this.DV)%this.DV,e>0?this.DV-e:-e}function xo(r){this.m=r,this.mp=r.invDigit(),this.mpl=this.mp&32767,this.mph=this.mp>>15,this.um=(1<<r.DB-15)-1,this.mt2=2*r.t}function hN(r){var e=Ue();return r.abs().dlShiftTo(this.m.t,e),e.divRemTo(this.m,null,e),r.s<0&&e.compareTo(V.ZERO)>0&&this.m.subTo(e,e),e}function dN(r){var e=Ue();return r.copyTo(e),this.reduce(e),e}function pN(r){for(;r.t<=this.mt2;)r.data[r.t++]=0;for(var e=0;e<this.m.t;++e){var t=r.data[e]&32767,n=t*this.mpl+((t*this.mph+(r.data[e]>>15)*this.mpl&this.um)<<15)&r.DM;for(t=e+this.m.t,r.data[t]+=this.m.am(0,n,r,e,0,this.m.t);r.data[t]>=r.DV;)r.data[t]-=r.DV,r.data[++t]++}r.clamp(),r.drShiftTo(this.m.t,r),r.compareTo(this.m)>=0&&r.subTo(this.m,r)}function mN(r,e){r.squareTo(e),this.reduce(e)}function gN(r,e,t){r.multiplyTo(e,t),this.reduce(t)}xo.prototype.convert=hN;xo.prototype.revert=dN;xo.prototype.reduce=pN;xo.prototype.mulTo=gN;xo.prototype.sqrTo=mN;function yN(){return(this.t>0?this.data[0]&1:this.s)==0}function bN(r,e){if(r>4294967295||r<1)return V.ONE;var t=Ue(),n=Ue(),i=e.convert(this),s=af(r)-1;for(i.copyTo(t);--s>=0;)if(e.sqrTo(t,n),(r&1<<s)>0)e.mulTo(n,i,t);else{var o=t;t=n,n=o}return e.revert(t)}function wN(r,e){var t;return r<256||e.isEven()?t=new Eo(e):t=new xo(e),this.exp(r,t)}V.prototype.copyTo=qk;V.prototype.fromInt=zk;V.prototype.fromString=$k;V.prototype.clamp=Hk;V.prototype.dlShiftTo=jk;V.prototype.drShiftTo=Zk;V.prototype.lShiftTo=Jk;V.prototype.rShiftTo=eN;V.prototype.subTo=tN;V.prototype.multiplyTo=rN;V.prototype.squareTo=nN;V.prototype.divRemTo=iN;V.prototype.invDigit=fN;V.prototype.isEven=yN;V.prototype.exp=bN;V.prototype.toString=Wk;V.prototype.negate=Gk;V.prototype.abs=Yk;V.prototype.compareTo=Qk;V.prototype.bitLength=Xk;V.prototype.mod=sN;V.prototype.modPowInt=wN;V.ZERO=Es(0);V.ONE=Es(1);function EN(){var r=Ue();return this.copyTo(r),r}function xN(){if(this.s<0){if(this.t==1)return this.data[0]-this.DV;if(this.t==0)return-1}else{if(this.t==1)return this.data[0];if(this.t==0)return 0}return(this.data[1]&(1<<32-this.DB)-1)<<this.DB|this.data[0]}function vN(){return this.t==0?this.s:this.data[0]<<24>>24}function _N(){return this.t==0?this.s:this.data[0]<<16>>16}function SN(r){return Math.floor(Math.LN2*this.DB/Math.log(r))}function RN(){return this.s<0?-1:this.t<=0||this.t==1&&this.data[0]<=0?0:1}function IN(r){if(r==null&&(r=10),this.signum()==0||r<2||r>36)return"0";var e=this.chunkSize(r),t=Math.pow(r,e),n=Es(t),i=Ue(),s=Ue(),o="";for(this.divRemTo(n,i,s);i.signum()>0;)o=(t+s.intValue()).toString(r).substr(1)+o,i.divRemTo(n,i,s);return s.intValue().toString(r)+o}function AN(r,e){this.fromInt(0),e==null&&(e=10);for(var t=this.chunkSize(e),n=Math.pow(e,t),i=!1,s=0,o=0,a=0;a<r.length;++a){var c=Z7(r,a);if(c<0){r.charAt(a)=="-"&&this.signum()==0&&(i=!0);continue}o=e*o+c,++s>=t&&(this.dMultiply(n),this.dAddOffset(o,0),s=0,o=0)}s>0&&(this.dMultiply(Math.pow(e,s)),this.dAddOffset(o,0)),i&&V.ZERO.subTo(this,this)}function TN(r,e,t){if(typeof e=="number")if(r<2)this.fromInt(1);else for(this.fromNumber(r,t),this.testBit(r-1)||this.bitwiseTo(V.ONE.shiftLeft(r-1),S2,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(e);)this.dAddOffset(2,0),this.bitLength()>r&&this.subTo(V.ONE.shiftLeft(r-1),this);else{var n=new Array,i=r&7;n.length=(r>>3)+1,e.nextBytes(n),i>0?n[0]&=(1<<i)-1:n[0]=0,this.fromString(n,256)}}function DN(){var r=this.t,e=new Array;e[0]=this.s;var t=this.DB-r*this.DB%8,n,i=0;if(r-- >0)for(t<this.DB&&(n=this.data[r]>>t)!=(this.s&this.DM)>>t&&(e[i++]=n|this.s<<this.DB-t);r>=0;)t<8?(n=(this.data[r]&(1<<t)-1)<<8-t,n|=this.data[--r]>>(t+=this.DB-8)):(n=this.data[r]>>(t-=8)&255,t<=0&&(t+=this.DB,--r)),n&128&&(n|=-256),i==0&&(this.s&128)!=(n&128)&&++i,(i>0||n!=this.s)&&(e[i++]=n);return e}function CN(r){return this.compareTo(r)==0}function PN(r){return this.compareTo(r)<0?this:r}function kN(r){return this.compareTo(r)>0?this:r}function NN(r,e,t){var n,i,s=Math.min(r.t,this.t);for(n=0;n<s;++n)t.data[n]=e(this.data[n],r.data[n]);if(r.t<this.t){for(i=r.s&this.DM,n=s;n<this.t;++n)t.data[n]=e(this.data[n],i);t.t=this.t}else{for(i=this.s&this.DM,n=s;n<r.t;++n)t.data[n]=e(i,r.data[n]);t.t=r.t}t.s=e(this.s,r.s),t.clamp()}function ON(r,e){return r&e}function LN(r){var e=Ue();return this.bitwiseTo(r,ON,e),e}function S2(r,e){return r|e}function BN(r){var e=Ue();return this.bitwiseTo(r,S2,e),e}function J7(r,e){return r^e}function MN(r){var e=Ue();return this.bitwiseTo(r,J7,e),e}function e9(r,e){return r&~e}function UN(r){var e=Ue();return this.bitwiseTo(r,e9,e),e}function FN(){for(var r=Ue(),e=0;e<this.t;++e)r.data[e]=this.DM&~this.data[e];return r.t=this.t,r.s=~this.s,r}function KN(r){var e=Ue();return r<0?this.rShiftTo(-r,e):this.lShiftTo(r,e),e}function VN(r){var e=Ue();return r<0?this.lShiftTo(-r,e):this.rShiftTo(r,e),e}function qN(r){if(r==0)return-1;var e=0;return r&65535||(r>>=16,e+=16),r&255||(r>>=8,e+=8),r&15||(r>>=4,e+=4),r&3||(r>>=2,e+=2),r&1||++e,e}function zN(){for(var r=0;r<this.t;++r)if(this.data[r]!=0)return r*this.DB+qN(this.data[r]);return this.s<0?this.t*this.DB:-1}function $N(r){for(var e=0;r!=0;)r&=r-1,++e;return e}function HN(){for(var r=0,e=this.s&this.DM,t=0;t<this.t;++t)r+=$N(this.data[t]^e);return r}function WN(r){var e=Math.floor(r/this.DB);return e>=this.t?this.s!=0:(this.data[e]&1<<r%this.DB)!=0}function GN(r,e){var t=V.ONE.shiftLeft(r);return this.bitwiseTo(t,e,t),t}function YN(r){return this.changeBit(r,S2)}function QN(r){return this.changeBit(r,e9)}function XN(r){return this.changeBit(r,J7)}function jN(r,e){for(var t=0,n=0,i=Math.min(r.t,this.t);t<i;)n+=this.data[t]+r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;if(r.t<this.t){for(n+=r.s;t<this.t;)n+=this.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;t<r.t;)n+=r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n+=r.s}e.s=n<0?-1:0,n>0?e.data[t++]=n:n<-1&&(e.data[t++]=this.DV+n),e.t=t,e.clamp()}function ZN(r){var e=Ue();return this.addTo(r,e),e}function JN(r){var e=Ue();return this.subTo(r,e),e}function eO(r){var e=Ue();return this.multiplyTo(r,e),e}function tO(r){var e=Ue();return this.divRemTo(r,e,null),e}function rO(r){var e=Ue();return this.divRemTo(r,null,e),e}function nO(r){var e=Ue(),t=Ue();return this.divRemTo(r,e,t),new Array(e,t)}function iO(r){this.data[this.t]=this.am(0,r-1,this,0,0,this.t),++this.t,this.clamp()}function sO(r,e){if(r!=0){for(;this.t<=e;)this.data[this.t++]=0;for(this.data[e]+=r;this.data[e]>=this.DV;)this.data[e]-=this.DV,++e>=this.t&&(this.data[this.t++]=0),++this.data[e]}}function _l(){}function t9(r){return r}function oO(r,e,t){r.multiplyTo(e,t)}function aO(r,e){r.squareTo(e)}_l.prototype.convert=t9;_l.prototype.revert=t9;_l.prototype.mulTo=oO;_l.prototype.sqrTo=aO;function cO(r){return this.exp(r,new _l)}function lO(r,e,t){var n=Math.min(this.t+r.t,e);for(t.s=0,t.t=n;n>0;)t.data[--n]=0;var i;for(i=t.t-this.t;n<i;++n)t.data[n+this.t]=this.am(0,r.data[n],t,n,0,this.t);for(i=Math.min(r.t,e);n<i;++n)this.am(0,r.data[n],t,n,0,e-n);t.clamp()}function uO(r,e,t){--e;var n=t.t=this.t+r.t-e;for(t.s=0;--n>=0;)t.data[n]=0;for(n=Math.max(e-this.t,0);n<r.t;++n)t.data[this.t+n-e]=this.am(e-n,r.data[n],t,0,0,this.t+n-e);t.clamp(),t.drShiftTo(1,t)}function Da(r){this.r2=Ue(),this.q3=Ue(),V.ONE.dlShiftTo(2*r.t,this.r2),this.mu=this.r2.divide(r),this.m=r}function fO(r){if(r.s<0||r.t>2*this.m.t)return r.mod(this.m);if(r.compareTo(this.m)<0)return r;var e=Ue();return r.copyTo(e),this.reduce(e),e}function hO(r){return r}function dO(r){for(r.drShiftTo(this.m.t-1,this.r2),r.t>this.m.t+1&&(r.t=this.m.t+1,r.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);r.compareTo(this.r2)<0;)r.dAddOffset(1,this.m.t+1);for(r.subTo(this.r2,r);r.compareTo(this.m)>=0;)r.subTo(this.m,r)}function pO(r,e){r.squareTo(e),this.reduce(e)}function mO(r,e,t){r.multiplyTo(e,t),this.reduce(t)}Da.prototype.convert=fO;Da.prototype.revert=hO;Da.prototype.reduce=dO;Da.prototype.mulTo=mO;Da.prototype.sqrTo=pO;function gO(r,e){var t=r.bitLength(),n,i=Es(1),s;if(t<=0)return i;t<18?n=1:t<48?n=3:t<144?n=4:t<768?n=5:n=6,t<8?s=new Eo(e):e.isEven()?s=new Da(e):s=new xo(e);var o=new Array,a=3,c=n-1,l=(1<<n)-1;if(o[1]=s.convert(this),n>1){var u=Ue();for(s.sqrTo(o[1],u);a<=l;)o[a]=Ue(),s.mulTo(u,o[a-2],o[a]),a+=2}var f=r.t-1,h,d=!0,p=Ue(),m;for(t=af(r.data[f])-1;f>=0;){for(t>=c?h=r.data[f]>>t-c&l:(h=(r.data[f]&(1<<t+1)-1)<<c-t,f>0&&(h|=r.data[f-1]>>this.DB+t-c)),a=n;!(h&1);)h>>=1,--a;if((t-=a)<0&&(t+=this.DB,--f),d)o[h].copyTo(i),d=!1;else{for(;a>1;)s.sqrTo(i,p),s.sqrTo(p,i),a-=2;a>0?s.sqrTo(i,p):(m=i,i=p,p=m),s.mulTo(p,o[h],i)}for(;f>=0&&!(r.data[f]&1<<t);)s.sqrTo(i,p),m=i,i=p,p=m,--t<0&&(t=this.DB-1,--f)}return s.revert(i)}function yO(r){var e=this.s<0?this.negate():this.clone(),t=r.s<0?r.negate():r.clone();if(e.compareTo(t)<0){var n=e;e=t,t=n}var i=e.getLowestSetBit(),s=t.getLowestSetBit();if(s<0)return e;for(i<s&&(s=i),s>0&&(e.rShiftTo(s,e),t.rShiftTo(s,t));e.signum()>0;)(i=e.getLowestSetBit())>0&&e.rShiftTo(i,e),(i=t.getLowestSetBit())>0&&t.rShiftTo(i,t),e.compareTo(t)>=0?(e.subTo(t,e),e.rShiftTo(1,e)):(t.subTo(e,t),t.rShiftTo(1,t));return s>0&&t.lShiftTo(s,t),t}function bO(r){if(r<=0)return 0;var e=this.DV%r,t=this.s<0?r-1:0;if(this.t>0)if(e==0)t=this.data[0]%r;else for(var n=this.t-1;n>=0;--n)t=(e*t+this.data[n])%r;return t}function wO(r){var e=r.isEven();if(this.isEven()&&e||r.signum()==0)return V.ZERO;for(var t=r.clone(),n=this.clone(),i=Es(1),s=Es(0),o=Es(0),a=Es(1);t.signum()!=0;){for(;t.isEven();)t.rShiftTo(1,t),e?((!i.isEven()||!s.isEven())&&(i.addTo(this,i),s.subTo(r,s)),i.rShiftTo(1,i)):s.isEven()||s.subTo(r,s),s.rShiftTo(1,s);for(;n.isEven();)n.rShiftTo(1,n),e?((!o.isEven()||!a.isEven())&&(o.addTo(this,o),a.subTo(r,a)),o.rShiftTo(1,o)):a.isEven()||a.subTo(r,a),a.rShiftTo(1,a);t.compareTo(n)>=0?(t.subTo(n,t),e&&i.subTo(o,i),s.subTo(a,s)):(n.subTo(t,n),e&&o.subTo(i,o),a.subTo(s,a))}if(n.compareTo(V.ONE)!=0)return V.ZERO;if(a.compareTo(r)>=0)return a.subtract(r);if(a.signum()<0)a.addTo(r,a);else return a;return a.signum()<0?a.add(r):a}var zn=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509],EO=(1<<26)/zn[zn.length-1];function xO(r){var e,t=this.abs();if(t.t==1&&t.data[0]<=zn[zn.length-1]){for(e=0;e<zn.length;++e)if(t.data[0]==zn[e])return!0;return!1}if(t.isEven())return!1;for(e=1;e<zn.length;){for(var n=zn[e],i=e+1;i<zn.length&&n<EO;)n*=zn[i++];for(n=t.modInt(n);e<i;)if(n%zn[e++]==0)return!1}return t.millerRabin(r)}function vO(r){var e=this.subtract(V.ONE),t=e.getLowestSetBit();if(t<=0)return!1;for(var n=e.shiftRight(t),i=_O(),s,o=0;o<r;++o){do s=new V(this.bitLength(),i);while(s.compareTo(V.ONE)<=0||s.compareTo(e)>=0);var a=s.modPow(n,this);if(a.compareTo(V.ONE)!=0&&a.compareTo(e)!=0){for(var c=1;c++<t&&a.compareTo(e)!=0;)if(a=a.modPowInt(2,this),a.compareTo(V.ONE)==0)return!1;if(a.compareTo(e)!=0)return!1}}return!0}function _O(){return{nextBytes:function(r){for(var e=0;e<r.length;++e)r[e]=Math.floor(Math.random()*256)}}}V.prototype.chunkSize=SN;V.prototype.toRadix=IN;V.prototype.fromRadix=AN;V.prototype.fromNumber=TN;V.prototype.bitwiseTo=NN;V.prototype.changeBit=GN;V.prototype.addTo=jN;V.prototype.dMultiply=iO;V.prototype.dAddOffset=sO;V.prototype.multiplyLowerTo=lO;V.prototype.multiplyUpperTo=uO;V.prototype.modInt=bO;V.prototype.millerRabin=vO;V.prototype.clone=EN;V.prototype.intValue=xN;V.prototype.byteValue=vN;V.prototype.shortValue=_N;V.prototype.signum=RN;V.prototype.toByteArray=DN;V.prototype.equals=CN;V.prototype.min=PN;V.prototype.max=kN;V.prototype.and=LN;V.prototype.or=BN;V.prototype.xor=MN;V.prototype.andNot=UN;V.prototype.not=FN;V.prototype.shiftLeft=KN;V.prototype.shiftRight=VN;V.prototype.getLowestSetBit=zN;V.prototype.bitCount=HN;V.prototype.testBit=WN;V.prototype.setBit=YN;V.prototype.clearBit=QN;V.prototype.flipBit=XN;V.prototype.add=ZN;V.prototype.subtract=JN;V.prototype.multiply=eO;V.prototype.divide=tO;V.prototype.remainder=rO;V.prototype.divideAndRemainder=nO;V.prototype.modPow=gO;V.prototype.modInverse=wO;V.prototype.pow=cO;V.prototype.gcd=yO;V.prototype.isProbablePrime=xO});var a9=F((eee,o9)=>{var hi=Qe();wo();At();var i9=o9.exports=hi.sha1=hi.sha1||{};hi.md.sha1=hi.md.algorithms.sha1=i9;i9.create=function(){s9||SO();var r=null,e=hi.util.createBuffer(),t=new Array(80),n={algorithm:"sha1",blockLength:64,digestLength:20,messageLength:0,fullMessageLength:null,messageLengthSize:8};return n.start=function(){n.messageLength=0,n.fullMessageLength=n.messageLength64=[];for(var i=n.messageLengthSize/4,s=0;s<i;++s)n.fullMessageLength.push(0);return e=hi.util.createBuffer(),r={h0:1732584193,h1:4023233417,h2:2562383102,h3:271733878,h4:3285377520},n},n.start(),n.update=function(i,s){s==="utf8"&&(i=hi.util.encodeUtf8(i));var o=i.length;n.messageLength+=o,o=[o/4294967296>>>0,o>>>0];for(var a=n.fullMessageLength.length-1;a>=0;--a)n.fullMessageLength[a]+=o[1],o[1]=o[0]+(n.fullMessageLength[a]/4294967296>>>0),n.fullMessageLength[a]=n.fullMessageLength[a]>>>0,o[0]=o[1]/4294967296>>>0;return e.putBytes(i),n9(r,t,e),(e.read>2048||e.length()===0)&&e.compact(),n},n.digest=function(){var i=hi.util.createBuffer();i.putBytes(e.bytes());var s=n.fullMessageLength[n.fullMessageLength.length-1]+n.messageLengthSize,o=s&n.blockLength-1;i.putBytes(R2.substr(0,n.blockLength-o));for(var a,c,l=n.fullMessageLength[0]*8,u=0;u<n.fullMessageLength.length-1;++u)a=n.fullMessageLength[u+1]*8,c=a/4294967296>>>0,l+=c,i.putInt32(l>>>0),l=a>>>0;i.putInt32(l);var f={h0:r.h0,h1:r.h1,h2:r.h2,h3:r.h3,h4:r.h4};n9(f,t,i);var h=hi.util.createBuffer();return h.putInt32(f.h0),h.putInt32(f.h1),h.putInt32(f.h2),h.putInt32(f.h3),h.putInt32(f.h4),h},n};var R2=null,s9=!1;function SO(){R2=String.fromCharCode(128),R2+=hi.util.fillString(String.fromCharCode(0),64),s9=!0}function n9(r,e,t){for(var n,i,s,o,a,c,l,u,f=t.length();f>=64;){for(i=r.h0,s=r.h1,o=r.h2,a=r.h3,c=r.h4,u=0;u<16;++u)n=t.getInt32(),e[u]=n,l=a^s&(o^a),n=(i<<5|i>>>27)+l+c+1518500249+n,c=a,a=o,o=(s<<30|s>>>2)>>>0,s=i,i=n;for(;u<20;++u)n=e[u-3]^e[u-8]^e[u-14]^e[u-16],n=n<<1|n>>>31,e[u]=n,l=a^s&(o^a),n=(i<<5|i>>>27)+l+c+1518500249+n,c=a,a=o,o=(s<<30|s>>>2)>>>0,s=i,i=n;for(;u<32;++u)n=e[u-3]^e[u-8]^e[u-14]^e[u-16],n=n<<1|n>>>31,e[u]=n,l=s^o^a,n=(i<<5|i>>>27)+l+c+1859775393+n,c=a,a=o,o=(s<<30|s>>>2)>>>0,s=i,i=n;for(;u<40;++u)n=e[u-6]^e[u-16]^e[u-28]^e[u-32],n=n<<2|n>>>30,e[u]=n,l=s^o^a,n=(i<<5|i>>>27)+l+c+1859775393+n,c=a,a=o,o=(s<<30|s>>>2)>>>0,s=i,i=n;for(;u<60;++u)n=e[u-6]^e[u-16]^e[u-28]^e[u-32],n=n<<2|n>>>30,e[u]=n,l=s&o|a&(s^o),n=(i<<5|i>>>27)+l+c+2400959708+n,c=a,a=o,o=(s<<30|s>>>2)>>>0,s=i,i=n;for(;u<80;++u)n=e[u-6]^e[u-16]^e[u-28]^e[u-32],n=n<<2|n>>>30,e[u]=n,l=s^o^a,n=(i<<5|i>>>27)+l+c+3395469782+n,c=a,a=o,o=(s<<30|s>>>2)>>>0,s=i,i=n;r.h0=r.h0+i|0,r.h1=r.h1+s|0,r.h2=r.h2+o|0,r.h3=r.h3+a|0,r.h4=r.h4+c|0,f-=64}}});var u9=F((tee,l9)=>{var di=Qe();At();vl();a9();var c9=l9.exports=di.pkcs1=di.pkcs1||{};c9.encode_rsa_oaep=function(r,e,t){var n,i,s,o;typeof t=="string"?(n=t,i=arguments[3]||void 0,s=arguments[4]||void 0):t&&(n=t.label||void 0,i=t.seed||void 0,s=t.md||void 0,t.mgf1&&t.mgf1.md&&(o=t.mgf1.md)),s?s.start():s=di.md.sha1.create(),o||(o=s);var a=Math.ceil(r.n.bitLength()/8),c=a-2*s.digestLength-2;if(e.length>c){var l=new Error("RSAES-OAEP input message length is too long.");throw l.length=e.length,l.maxLength=c,l}n||(n=""),s.update(n,"raw");for(var u=s.digest(),f="",h=c-e.length,d=0;d<h;d++)f+="\0";var p=u.getBytes()+f+""+e;if(!i)i=di.random.getBytes(s.digestLength);else if(i.length!==s.digestLength){var l=new Error("Invalid RSAES-OAEP seed. The seed length must match the digest length.");throw l.seedLength=i.length,l.digestLength=s.digestLength,l}var m=lf(i,a-s.digestLength-1,o),g=di.util.xorBytes(p,m,p.length),y=lf(g,s.digestLength,o),w=di.util.xorBytes(i,y,i.length);return"\0"+w+g};c9.decode_rsa_oaep=function(r,e,t){var n,i,s;typeof t=="string"?(n=t,i=arguments[3]||void 0):t&&(n=t.label||void 0,i=t.md||void 0,t.mgf1&&t.mgf1.md&&(s=t.mgf1.md));var o=Math.ceil(r.n.bitLength()/8);if(e.length!==o){var g=new Error("RSAES-OAEP encoded message length is invalid.");throw g.length=e.length,g.expectedLength=o,g}if(i===void 0?i=di.md.sha1.create():i.start(),s||(s=i),o<2*i.digestLength+2)throw new Error("RSAES-OAEP key is too short for the hash function.");n||(n=""),i.update(n,"raw");for(var a=i.digest().getBytes(),c=e.charAt(0),l=e.substring(1,i.digestLength+1),u=e.substring(1+i.digestLength),f=lf(u,i.digestLength,s),h=di.util.xorBytes(l,f,l.length),d=lf(h,o-i.digestLength-1,s),p=di.util.xorBytes(u,d,u.length),m=p.substring(0,i.digestLength),g=c!=="\0",y=0;y<i.digestLength;++y)g|=a.charAt(y)!==m.charAt(y);for(var w=1,E=i.digestLength,R=i.digestLength;R<p.length;R++){var x=p.charCodeAt(R),v=x&1^1,I=w?65534:0;g|=x&I,w=w&v,E+=w}if(g||p.charCodeAt(E)!==1)throw new Error("Invalid RSAES-OAEP padding.");return p.substring(E+1)};function lf(r,e,t){t||(t=di.md.sha1.create());for(var n="",i=Math.ceil(e/t.digestLength),s=0;s<i;++s){var o=String.fromCharCode(s>>24&255,s>>16&255,s>>8&255,s&255);t.start(),t.update(r+o),n+=t.digest().getBytes()}return n.substring(0,e)}});var f9=F((ree,I2)=>{var xs=Qe();At();cf();vl();(function(){if(xs.prime){I2.exports=xs.prime;return}var r=I2.exports=xs.prime=xs.prime||{},e=xs.jsbn.BigInteger,t=[6,4,2,4,2,4,6,2],n=new e(null);n.fromInt(30);var i=function(f,h){return f|h};r.generateProbablePrime=function(f,h,d){typeof h=="function"&&(d=h,h={}),h=h||{};var p=h.algorithm||"PRIMEINC";typeof p=="string"&&(p={name:p}),p.options=p.options||{};var m=h.prng||xs.random,g={nextBytes:function(y){for(var w=m.getBytesSync(y.length),E=0;E<y.length;++E)y[E]=w.charCodeAt(E)}};if(p.name==="PRIMEINC")return s(f,g,p.options,d);throw new Error("Invalid prime generation algorithm: "+p.name)};function s(f,h,d,p){return"workers"in d?c(f,h,d,p):o(f,h,d,p)}function o(f,h,d,p){var m=l(f,h),g=0,y=u(m.bitLength());"millerRabinTests"in d&&(y=d.millerRabinTests);var w=10;"maxBlockTime"in d&&(w=d.maxBlockTime),a(m,f,h,g,y,w,p)}function a(f,h,d,p,m,g,y){var w=+new Date;do{if(f.bitLength()>h&&(f=l(h,d)),f.isProbablePrime(m))return y(null,f);f.dAddOffset(t[p++%8],0)}while(g<0||+new Date-w<g);xs.util.setImmediate(function(){a(f,h,d,p,m,g,y)})}function c(f,h,d,p){if(typeof Worker>"u")return o(f,h,d,p);var m=l(f,h),g=d.workers,y=d.workLoad||100,w=y*30/8,E=d.workerScript||"forge/prime.worker.js";if(g===-1)return xs.util.estimateCores(function(x,v){x&&(v=2),g=v-1,R()});R();function R(){g=Math.max(1,g);for(var x=[],v=0;v<g;++v)x[v]=new Worker(E);for(var I=g,v=0;v<g;++v)x[v].addEventListener("message",k);var _=!1;function k(B){if(!_){--I;var L=B.data;if(L.found){for(var K=0;K<x.length;++K)x[K].terminate();return _=!0,p(null,new e(L.prime,16))}m.bitLength()>f&&(m=l(f,h));var W=m.toString(16);B.target.postMessage({hex:W,workLoad:y}),m.dAddOffset(w,0)}}}}function l(f,h){var d=new e(f,h),p=f-1;return d.testBit(p)||d.bitwiseTo(e.ONE.shiftLeft(p),i,d),d.dAddOffset(31-d.mod(n).byteValue(),0),d}function u(f){return f<=100?27:f<=150?18:f<=200?15:f<=250?12:f<=300?9:f<=350?8:f<=400?7:f<=500?6:f<=600?5:f<=800?4:f<=1250?3:2}})()});var ff=F((nee,b9)=>{var he=Qe();El();cf();Y0();u9();f9();vl();At();typeof Be>"u"&&(Be=he.jsbn.BigInteger);var Be,A2=he.util.isNodejs?xl():null,C=he.asn1,wn=he.util;he.pki=he.pki||{};b9.exports=he.pki.rsa=he.rsa=he.rsa||{};var Se=he.pki,RO=[6,4,2,4,2,4,6,2],IO={name:"PrivateKeyInfo",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"PrivateKeyInfo.version",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"PrivateKeyInfo.privateKeyAlgorithm",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:C.Class.UNIVERSAL,type:C.Type.OID,constructed:!1,capture:"privateKeyOid"}]},{name:"PrivateKeyInfo",tagClass:C.Class.UNIVERSAL,type:C.Type.OCTETSTRING,constructed:!1,capture:"privateKey"}]},AO={name:"RSAPrivateKey",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"RSAPrivateKey.version",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"RSAPrivateKey.modulus",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyModulus"},{name:"RSAPrivateKey.publicExponent",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyPublicExponent"},{name:"RSAPrivateKey.privateExponent",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyPrivateExponent"},{name:"RSAPrivateKey.prime1",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyPrime1"},{name:"RSAPrivateKey.prime2",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyPrime2"},{name:"RSAPrivateKey.exponent1",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyExponent1"},{name:"RSAPrivateKey.exponent2",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyExponent2"},{name:"RSAPrivateKey.coefficient",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyCoefficient"}]},TO={name:"RSAPublicKey",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"RSAPublicKey.modulus",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"publicKeyModulus"},{name:"RSAPublicKey.exponent",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"publicKeyExponent"}]},DO=he.pki.rsa.publicKeyValidator={name:"SubjectPublicKeyInfo",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,captureAsn1:"subjectPublicKeyInfo",value:[{name:"SubjectPublicKeyInfo.AlgorithmIdentifier",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:C.Class.UNIVERSAL,type:C.Type.OID,constructed:!1,capture:"publicKeyOid"}]},{name:"SubjectPublicKeyInfo.subjectPublicKey",tagClass:C.Class.UNIVERSAL,type:C.Type.BITSTRING,constructed:!1,value:[{name:"SubjectPublicKeyInfo.subjectPublicKey.RSAPublicKey",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,optional:!0,captureAsn1:"rsaPublicKey"}]}]},CO={name:"DigestInfo",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"DigestInfo.DigestAlgorithm",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"DigestInfo.DigestAlgorithm.algorithmIdentifier",tagClass:C.Class.UNIVERSAL,type:C.Type.OID,constructed:!1,capture:"algorithmIdentifier"},{name:"DigestInfo.DigestAlgorithm.parameters",tagClass:C.Class.UNIVERSAL,type:C.Type.NULL,capture:"parameters",optional:!0,constructed:!1}]},{name:"DigestInfo.digest",tagClass:C.Class.UNIVERSAL,type:C.Type.OCTETSTRING,constructed:!1,capture:"digest"}]},PO=function(r){var e;if(r.algorithm in Se.oids)e=Se.oids[r.algorithm];else{var t=new Error("Unknown message digest algorithm.");throw t.algorithm=r.algorithm,t}var n=C.oidToDer(e).getBytes(),i=C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[]),s=C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[]);s.value.push(C.create(C.Class.UNIVERSAL,C.Type.OID,!1,n)),s.value.push(C.create(C.Class.UNIVERSAL,C.Type.NULL,!1,""));var o=C.create(C.Class.UNIVERSAL,C.Type.OCTETSTRING,!1,r.digest().getBytes());return i.value.push(s),i.value.push(o),C.toDer(i).getBytes()},g9=function(r,e,t){if(t)return r.modPow(e.e,e.n);if(!e.p||!e.q)return r.modPow(e.d,e.n);e.dP||(e.dP=e.d.mod(e.p.subtract(Be.ONE))),e.dQ||(e.dQ=e.d.mod(e.q.subtract(Be.ONE))),e.qInv||(e.qInv=e.q.modInverse(e.p));var n;do n=new Be(he.util.bytesToHex(he.random.getBytes(e.n.bitLength()/8)),16);while(n.compareTo(e.n)>=0||!n.gcd(e.n).equals(Be.ONE));r=r.multiply(n.modPow(e.e,e.n)).mod(e.n);for(var i=r.mod(e.p).modPow(e.dP,e.p),s=r.mod(e.q).modPow(e.dQ,e.q);i.compareTo(s)<0;)i=i.add(e.p);var o=i.subtract(s).multiply(e.qInv).mod(e.p).multiply(e.q).add(s);return o=o.multiply(n.modInverse(e.n)).mod(e.n),o};Se.rsa.encrypt=function(r,e,t){var n=t,i,s=Math.ceil(e.n.bitLength()/8);t!==!1&&t!==!0?(n=t===2,i=y9(r,e,t)):(i=he.util.createBuffer(),i.putBytes(r));for(var o=new Be(i.toHex(),16),a=g9(o,e,n),c=a.toString(16),l=he.util.createBuffer(),u=s-Math.ceil(c.length/2);u>0;)l.putByte(0),--u;return l.putBytes(he.util.hexToBytes(c)),l.getBytes()};Se.rsa.decrypt=function(r,e,t,n){var i=Math.ceil(e.n.bitLength()/8);if(r.length!==i){var s=new Error("Encrypted message length is invalid.");throw s.length=r.length,s.expected=i,s}var o=new Be(he.util.createBuffer(r).toHex(),16);if(o.compareTo(e.n)>=0)throw new Error("Encrypted message is invalid.");for(var a=g9(o,e,t),c=a.toString(16),l=he.util.createBuffer(),u=i-Math.ceil(c.length/2);u>0;)l.putByte(0),--u;return l.putBytes(he.util.hexToBytes(c)),n!==!1?uf(l.getBytes(),e,t):l.getBytes()};Se.rsa.createKeyPairGenerationState=function(r,e,t){typeof r=="string"&&(r=parseInt(r,10)),r=r||2048,t=t||{};var n=t.prng||he.random,i={nextBytes:function(a){for(var c=n.getBytesSync(a.length),l=0;l<a.length;++l)a[l]=c.charCodeAt(l)}},s=t.algorithm||"PRIMEINC",o;if(s==="PRIMEINC")o={algorithm:s,state:0,bits:r,rng:i,eInt:e||65537,e:new Be(null),p:null,q:null,qBits:r>>1,pBits:r-(r>>1),pqState:0,num:null,keys:null},o.e.fromInt(o.eInt);else throw new Error("Invalid key generation algorithm: "+s);return o};Se.rsa.stepKeyPairGenerationState=function(r,e){"algorithm"in r||(r.algorithm="PRIMEINC");var t=new Be(null);t.fromInt(30);for(var n=0,i=function(f,h){return f|h},s=+new Date,o,a=0;r.keys===null&&(e<=0||a<e);){if(r.state===0){var c=r.p===null?r.pBits:r.qBits,l=c-1;r.pqState===0?(r.num=new Be(c,r.rng),r.num.testBit(l)||r.num.bitwiseTo(Be.ONE.shiftLeft(l),i,r.num),r.num.dAddOffset(31-r.num.mod(t).byteValue(),0),n=0,++r.pqState):r.pqState===1?r.num.bitLength()>c?r.pqState=0:r.num.isProbablePrime(NO(r.num.bitLength()))?++r.pqState:r.num.dAddOffset(RO[n++%8],0):r.pqState===2?r.pqState=r.num.subtract(Be.ONE).gcd(r.e).compareTo(Be.ONE)===0?3:0:r.pqState===3&&(r.pqState=0,r.p===null?r.p=r.num:r.q=r.num,r.p!==null&&r.q!==null&&++r.state,r.num=null)}else if(r.state===1)r.p.compareTo(r.q)<0&&(r.num=r.p,r.p=r.q,r.q=r.num),++r.state;else if(r.state===2)r.p1=r.p.subtract(Be.ONE),r.q1=r.q.subtract(Be.ONE),r.phi=r.p1.multiply(r.q1),++r.state;else if(r.state===3)r.phi.gcd(r.e).compareTo(Be.ONE)===0?++r.state:(r.p=null,r.q=null,r.state=0);else if(r.state===4)r.n=r.p.multiply(r.q),r.n.bitLength()===r.bits?++r.state:(r.q=null,r.state=0);else if(r.state===5){var u=r.e.modInverse(r.phi);r.keys={privateKey:Se.rsa.setPrivateKey(r.n,r.e,u,r.p,r.q,u.mod(r.p1),u.mod(r.q1),r.q.modInverse(r.p)),publicKey:Se.rsa.setPublicKey(r.n,r.e)}}o=+new Date,a+=o-s,s=o}return r.keys!==null};Se.rsa.generateKeyPair=function(r,e,t,n){if(arguments.length===1?typeof r=="object"?(t=r,r=void 0):typeof r=="function"&&(n=r,r=void 0):arguments.length===2?typeof r=="number"?typeof e=="function"?(n=e,e=void 0):typeof e!="number"&&(t=e,e=void 0):(t=r,n=e,r=void 0,e=void 0):arguments.length===3&&(typeof e=="number"?typeof t=="function"&&(n=t,t=void 0):(n=t,t=e,e=void 0)),t=t||{},r===void 0&&(r=t.bits||2048),e===void 0&&(e=t.e||65537),!he.options.usePureJavaScript&&!t.prng&&r>=256&&r<=16384&&(e===65537||e===3)){if(n){if(h9("generateKeyPair"))return A2.generateKeyPair("rsa",{modulusLength:r,publicExponent:e,publicKeyEncoding:{type:"spki",format:"pem"},privateKeyEncoding:{type:"pkcs8",format:"pem"}},function(a,c,l){if(a)return n(a);n(null,{privateKey:Se.privateKeyFromPem(l),publicKey:Se.publicKeyFromPem(c)})});if(d9("generateKey")&&d9("exportKey"))return wn.globalScope.crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:m9(e),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(a){return wn.globalScope.crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(void 0,function(a){n(a)}).then(function(a){if(a){var c=Se.privateKeyFromAsn1(C.fromDer(he.util.createBuffer(a)));n(null,{privateKey:c,publicKey:Se.setRsaPublicKey(c.n,c.e)})}});if(p9("generateKey")&&p9("exportKey")){var i=wn.globalScope.msCrypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:m9(e),hash:{name:"SHA-256"}},!0,["sign","verify"]);i.oncomplete=function(a){var c=a.target.result,l=wn.globalScope.msCrypto.subtle.exportKey("pkcs8",c.privateKey);l.oncomplete=function(u){var f=u.target.result,h=Se.privateKeyFromAsn1(C.fromDer(he.util.createBuffer(f)));n(null,{privateKey:h,publicKey:Se.setRsaPublicKey(h.n,h.e)})},l.onerror=function(u){n(u)}},i.onerror=function(a){n(a)};return}}else if(h9("generateKeyPairSync")){var s=A2.generateKeyPairSync("rsa",{modulusLength:r,publicExponent:e,publicKeyEncoding:{type:"spki",format:"pem"},privateKeyEncoding:{type:"pkcs8",format:"pem"}});return{privateKey:Se.privateKeyFromPem(s.privateKey),publicKey:Se.publicKeyFromPem(s.publicKey)}}}var o=Se.rsa.createKeyPairGenerationState(r,e,t);if(!n)return Se.rsa.stepKeyPairGenerationState(o,0),o.keys;kO(o,t,n)};Se.setRsaPublicKey=Se.rsa.setPublicKey=function(r,e){var t={n:r,e};return t.encrypt=function(n,i,s){if(typeof i=="string"?i=i.toUpperCase():i===void 0&&(i="RSAES-PKCS1-V1_5"),i==="RSAES-PKCS1-V1_5")i={encode:function(a,c,l){return y9(a,c,2).getBytes()}};else if(i==="RSA-OAEP"||i==="RSAES-OAEP")i={encode:function(a,c){return he.pkcs1.encode_rsa_oaep(c,a,s)}};else if(["RAW","NONE","NULL",null].indexOf(i)!==-1)i={encode:function(a){return a}};else if(typeof i=="string")throw new Error('Unsupported encryption scheme: "'+i+'".');var o=i.encode(n,t,!0);return Se.rsa.encrypt(o,t,!0)},t.verify=function(n,i,s,o){typeof s=="string"?s=s.toUpperCase():s===void 0&&(s="RSASSA-PKCS1-V1_5"),o===void 0&&(o={_parseAllDigestBytes:!0}),"_parseAllDigestBytes"in o||(o._parseAllDigestBytes=!0),s==="RSASSA-PKCS1-V1_5"?s={verify:function(c,l){l=uf(l,t,!0);var u=C.fromDer(l,{parseAllBytes:o._parseAllDigestBytes}),f={},h=[];if(!C.validate(u,CO,f,h)){var d=new Error("ASN.1 object does not contain a valid RSASSA-PKCS1-v1_5 DigestInfo value.");throw d.errors=h,d}var p=C.derToOid(f.algorithmIdentifier);if(!(p===he.oids.md2||p===he.oids.md5||p===he.oids.sha1||p===he.oids.sha224||p===he.oids.sha256||p===he.oids.sha384||p===he.oids.sha512||p===he.oids["sha512-224"]||p===he.oids["sha512-256"])){var d=new Error("Unknown RSASSA-PKCS1-v1_5 DigestAlgorithm identifier.");throw d.oid=p,d}if((p===he.oids.md2||p===he.oids.md5)&&!("parameters"in f))throw new Error("ASN.1 object does not contain a valid RSASSA-PKCS1-v1_5 DigestInfo value. Missing algorithm identifer NULL parameters.");return c===f.digest}}:(s==="NONE"||s==="NULL"||s===null)&&(s={verify:function(c,l){return l=uf(l,t,!0),c===l}});var a=Se.rsa.decrypt(i,t,!0,!1);return s.verify(n,a,t.n.bitLength())},t};Se.setRsaPrivateKey=Se.rsa.setPrivateKey=function(r,e,t,n,i,s,o,a){var c={n:r,e,d:t,p:n,q:i,dP:s,dQ:o,qInv:a};return c.decrypt=function(l,u,f){typeof u=="string"?u=u.toUpperCase():u===void 0&&(u="RSAES-PKCS1-V1_5");var h=Se.rsa.decrypt(l,c,!1,!1);if(u==="RSAES-PKCS1-V1_5")u={decode:uf};else if(u==="RSA-OAEP"||u==="RSAES-OAEP")u={decode:function(d,p){return he.pkcs1.decode_rsa_oaep(p,d,f)}};else if(["RAW","NONE","NULL",null].indexOf(u)!==-1)u={decode:function(d){return d}};else throw new Error('Unsupported encryption scheme: "'+u+'".');return u.decode(h,c,!1)},c.sign=function(l,u){var f=!1;typeof u=="string"&&(u=u.toUpperCase()),u===void 0||u==="RSASSA-PKCS1-V1_5"?(u={encode:PO},f=1):(u==="NONE"||u==="NULL"||u===null)&&(u={encode:function(){return l}},f=1);var h=u.encode(l,c.n.bitLength());return Se.rsa.encrypt(h,c,f)},c};Se.wrapRsaPrivateKey=function(r){return C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,C.integerToDer(0).getBytes()),C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.OID,!1,C.oidToDer(Se.oids.rsaEncryption).getBytes()),C.create(C.Class.UNIVERSAL,C.Type.NULL,!1,"")]),C.create(C.Class.UNIVERSAL,C.Type.OCTETSTRING,!1,C.toDer(r).getBytes())])};Se.privateKeyFromAsn1=function(r){var e={},t=[];if(C.validate(r,IO,e,t)&&(r=C.fromDer(he.util.createBuffer(e.privateKey))),e={},t=[],!C.validate(r,AO,e,t)){var n=new Error("Cannot read private key. ASN.1 object does not contain an RSAPrivateKey.");throw n.errors=t,n}var i,s,o,a,c,l,u,f;return i=he.util.createBuffer(e.privateKeyModulus).toHex(),s=he.util.createBuffer(e.privateKeyPublicExponent).toHex(),o=he.util.createBuffer(e.privateKeyPrivateExponent).toHex(),a=he.util.createBuffer(e.privateKeyPrime1).toHex(),c=he.util.createBuffer(e.privateKeyPrime2).toHex(),l=he.util.createBuffer(e.privateKeyExponent1).toHex(),u=he.util.createBuffer(e.privateKeyExponent2).toHex(),f=he.util.createBuffer(e.privateKeyCoefficient).toHex(),Se.setRsaPrivateKey(new Be(i,16),new Be(s,16),new Be(o,16),new Be(a,16),new Be(c,16),new Be(l,16),new Be(u,16),new Be(f,16))};Se.privateKeyToAsn1=Se.privateKeyToRSAPrivateKey=function(r){return C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,C.integerToDer(0).getBytes()),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,pi(r.n)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,pi(r.e)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,pi(r.d)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,pi(r.p)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,pi(r.q)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,pi(r.dP)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,pi(r.dQ)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,pi(r.qInv))])};Se.publicKeyFromAsn1=function(r){var e={},t=[];if(C.validate(r,DO,e,t)){var n=C.derToOid(e.publicKeyOid);if(n!==Se.oids.rsaEncryption){var i=new Error("Cannot read public key. Unknown OID.");throw i.oid=n,i}r=e.rsaPublicKey}if(t=[],!C.validate(r,TO,e,t)){var i=new Error("Cannot read public key. ASN.1 object does not contain an RSAPublicKey.");throw i.errors=t,i}var s=he.util.createBuffer(e.publicKeyModulus).toHex(),o=he.util.createBuffer(e.publicKeyExponent).toHex();return Se.setRsaPublicKey(new Be(s,16),new Be(o,16))};Se.publicKeyToAsn1=Se.publicKeyToSubjectPublicKeyInfo=function(r){return C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.OID,!1,C.oidToDer(Se.oids.rsaEncryption).getBytes()),C.create(C.Class.UNIVERSAL,C.Type.NULL,!1,"")]),C.create(C.Class.UNIVERSAL,C.Type.BITSTRING,!1,[Se.publicKeyToRSAPublicKey(r)])])};Se.publicKeyToRSAPublicKey=function(r){return C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,pi(r.n)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,pi(r.e))])};function y9(r,e,t){var n=he.util.createBuffer(),i=Math.ceil(e.n.bitLength()/8);if(r.length>i-11){var s=new Error("Message is too long for PKCS#1 v1.5 padding.");throw s.length=r.length,s.max=i-11,s}n.putByte(0),n.putByte(t);var o=i-3-r.length,a;if(t===0||t===1){a=t===0?0:255;for(var c=0;c<o;++c)n.putByte(a)}else for(;o>0;){for(var l=0,u=he.random.getBytes(o),c=0;c<o;++c)a=u.charCodeAt(c),a===0?++l:n.putByte(a);o=l}return n.putByte(0),n.putBytes(r),n}function uf(r,e,t,n){var i=Math.ceil(e.n.bitLength()/8),s=he.util.createBuffer(r),o=s.getByte(),a=s.getByte();if(o!==0||t&&a!==0&&a!==1||!t&&a!=2||t&&a===0&&typeof n>"u")throw new Error("Encryption block is invalid.");var c=0;if(a===0){c=i-3-n;for(var l=0;l<c;++l)if(s.getByte()!==0)throw new Error("Encryption block is invalid.")}else if(a===1)for(c=0;s.length()>1;){if(s.getByte()!==255){--s.read;break}++c}else if(a===2)for(c=0;s.length()>1;){if(s.getByte()===0){--s.read;break}++c}var u=s.getByte();if(u!==0||c!==i-3-s.length())throw new Error("Encryption block is invalid.");return s.getBytes()}function kO(r,e,t){typeof e=="function"&&(t=e,e={}),e=e||{};var n={algorithm:{name:e.algorithm||"PRIMEINC",options:{workers:e.workers||2,workLoad:e.workLoad||100,workerScript:e.workerScript}}};"prng"in e&&(n.prng=e.prng),i();function i(){s(r.pBits,function(a,c){if(a)return t(a);if(r.p=c,r.q!==null)return o(a,r.q);s(r.qBits,o)})}function s(a,c){he.prime.generateProbablePrime(a,n,c)}function o(a,c){if(a)return t(a);if(r.q=c,r.p.compareTo(r.q)<0){var l=r.p;r.p=r.q,r.q=l}if(r.p.subtract(Be.ONE).gcd(r.e).compareTo(Be.ONE)!==0){r.p=null,i();return}if(r.q.subtract(Be.ONE).gcd(r.e).compareTo(Be.ONE)!==0){r.q=null,s(r.qBits,o);return}if(r.p1=r.p.subtract(Be.ONE),r.q1=r.q.subtract(Be.ONE),r.phi=r.p1.multiply(r.q1),r.phi.gcd(r.e).compareTo(Be.ONE)!==0){r.p=r.q=null,i();return}if(r.n=r.p.multiply(r.q),r.n.bitLength()!==r.bits){r.q=null,s(r.qBits,o);return}var u=r.e.modInverse(r.phi);r.keys={privateKey:Se.rsa.setPrivateKey(r.n,r.e,u,r.p,r.q,u.mod(r.p1),u.mod(r.q1),r.q.modInverse(r.p)),publicKey:Se.rsa.setPublicKey(r.n,r.e)},t(null,r.keys)}}function pi(r){var e=r.toString(16);e[0]>="8"&&(e="00"+e);var t=he.util.hexToBytes(e);return t.length>1&&(t.charCodeAt(0)===0&&!(t.charCodeAt(1)&128)||t.charCodeAt(0)===255&&(t.charCodeAt(1)&128)===128)?t.substr(1):t}function NO(r){return r<=100?27:r<=150?18:r<=200?15:r<=250?12:r<=300?9:r<=350?8:r<=400?7:r<=500?6:r<=600?5:r<=800?4:r<=1250?3:2}function h9(r){return he.util.isNodejs&&typeof A2[r]=="function"}function d9(r){return typeof wn.globalScope<"u"&&typeof wn.globalScope.crypto=="object"&&typeof wn.globalScope.crypto.subtle=="object"&&typeof wn.globalScope.crypto.subtle[r]=="function"}function p9(r){return typeof wn.globalScope<"u"&&typeof wn.globalScope.msCrypto=="object"&&typeof wn.globalScope.msCrypto.subtle=="object"&&typeof wn.globalScope.msCrypto.subtle[r]=="function"}function m9(r){for(var e=he.util.hexToBytes(r.toString(16)),t=new Uint8Array(e.length),n=0;n<e.length;++n)t[n]=e.charCodeAt(n);return t}});var S9=F((iee,_9)=>{var ee=Qe();J0();El();D7();wo();Y0();b2();B7();vl();Y7();ff();At();typeof w9>"u"&&(w9=ee.jsbn.BigInteger);var w9,M=ee.asn1,Ie=ee.pki=ee.pki||{};_9.exports=Ie.pbe=ee.pbe=ee.pbe||{};var vo=Ie.oids,OO={name:"EncryptedPrivateKeyInfo",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedPrivateKeyInfo.encryptionAlgorithm",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:M.Class.UNIVERSAL,type:M.Type.OID,constructed:!1,capture:"encryptionOid"},{name:"AlgorithmIdentifier.parameters",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,captureAsn1:"encryptionParams"}]},{name:"EncryptedPrivateKeyInfo.encryptedData",tagClass:M.Class.UNIVERSAL,type:M.Type.OCTETSTRING,constructed:!1,capture:"encryptedData"}]},LO={name:"PBES2Algorithms",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc.oid",tagClass:M.Class.UNIVERSAL,type:M.Type.OID,constructed:!1,capture:"kdfOid"},{name:"PBES2Algorithms.params",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.params.salt",tagClass:M.Class.UNIVERSAL,type:M.Type.OCTETSTRING,constructed:!1,capture:"kdfSalt"},{name:"PBES2Algorithms.params.iterationCount",tagClass:M.Class.UNIVERSAL,type:M.Type.INTEGER,constructed:!1,capture:"kdfIterationCount"},{name:"PBES2Algorithms.params.keyLength",tagClass:M.Class.UNIVERSAL,type:M.Type.INTEGER,constructed:!1,optional:!0,capture:"keyLength"},{name:"PBES2Algorithms.params.prf",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,optional:!0,value:[{name:"PBES2Algorithms.params.prf.algorithm",tagClass:M.Class.UNIVERSAL,type:M.Type.OID,constructed:!1,capture:"prfOid"}]}]}]},{name:"PBES2Algorithms.encryptionScheme",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.encryptionScheme.oid",tagClass:M.Class.UNIVERSAL,type:M.Type.OID,constructed:!1,capture:"encOid"},{name:"PBES2Algorithms.encryptionScheme.iv",tagClass:M.Class.UNIVERSAL,type:M.Type.OCTETSTRING,constructed:!1,capture:"encIv"}]}]},BO={name:"pkcs-12PbeParams",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"pkcs-12PbeParams.salt",tagClass:M.Class.UNIVERSAL,type:M.Type.OCTETSTRING,constructed:!1,capture:"salt"},{name:"pkcs-12PbeParams.iterations",tagClass:M.Class.UNIVERSAL,type:M.Type.INTEGER,constructed:!1,capture:"iterations"}]};Ie.encryptPrivateKeyInfo=function(r,e,t){t=t||{},t.saltSize=t.saltSize||8,t.count=t.count||2048,t.algorithm=t.algorithm||"aes128",t.prfAlgorithm=t.prfAlgorithm||"sha1";var n=ee.random.getBytesSync(t.saltSize),i=t.count,s=M.integerToDer(i),o,a,c;if(t.algorithm.indexOf("aes")===0||t.algorithm==="des"){var l,u,f;switch(t.algorithm){case"aes128":o=16,l=16,u=vo["aes128-CBC"],f=ee.aes.createEncryptionCipher;break;case"aes192":o=24,l=16,u=vo["aes192-CBC"],f=ee.aes.createEncryptionCipher;break;case"aes256":o=32,l=16,u=vo["aes256-CBC"],f=ee.aes.createEncryptionCipher;break;case"des":o=8,l=8,u=vo.desCBC,f=ee.des.createEncryptionCipher;break;default:var h=new Error("Cannot encrypt private key. Unknown encryption algorithm.");throw h.algorithm=t.algorithm,h}var d="hmacWith"+t.prfAlgorithm.toUpperCase(),p=v9(d),m=ee.pkcs5.pbkdf2(e,n,i,o,p),g=ee.random.getBytesSync(l),y=f(m);y.start(g),y.update(M.toDer(r)),y.finish(),c=y.output.getBytes();var w=MO(n,s,o,d);a=M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(vo.pkcs5PBES2).getBytes()),M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(vo.pkcs5PBKDF2).getBytes()),w]),M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(u).getBytes()),M.create(M.Class.UNIVERSAL,M.Type.OCTETSTRING,!1,g)])])])}else if(t.algorithm==="3des"){o=24;var E=new ee.util.ByteBuffer(n),m=Ie.pbe.generatePkcs12Key(e,E,1,i,o),g=Ie.pbe.generatePkcs12Key(e,E,2,i,o),y=ee.des.createEncryptionCipher(m);y.start(g),y.update(M.toDer(r)),y.finish(),c=y.output.getBytes(),a=M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(vo["pbeWithSHAAnd3-KeyTripleDES-CBC"]).getBytes()),M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OCTETSTRING,!1,n),M.create(M.Class.UNIVERSAL,M.Type.INTEGER,!1,s.getBytes())])])}else{var h=new Error("Cannot encrypt private key. Unknown encryption algorithm.");throw h.algorithm=t.algorithm,h}var R=M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[a,M.create(M.Class.UNIVERSAL,M.Type.OCTETSTRING,!1,c)]);return R};Ie.decryptPrivateKeyInfo=function(r,e){var t=null,n={},i=[];if(!M.validate(r,OO,n,i)){var s=new Error("Cannot read encrypted private key. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw s.errors=i,s}var o=M.derToOid(n.encryptionOid),a=Ie.pbe.getCipher(o,n.encryptionParams,e),c=ee.util.createBuffer(n.encryptedData);return a.update(c),a.finish()&&(t=M.fromDer(a.output)),t};Ie.encryptedPrivateKeyToPem=function(r,e){var t={type:"ENCRYPTED PRIVATE KEY",body:M.toDer(r).getBytes()};return ee.pem.encode(t,{maxline:e})};Ie.encryptedPrivateKeyFromPem=function(r){var e=ee.pem.decode(r)[0];if(e.type!=="ENCRYPTED PRIVATE KEY"){var t=new Error('Could not convert encrypted private key from PEM; PEM header type is "ENCRYPTED PRIVATE KEY".');throw t.headerType=e.type,t}if(e.procType&&e.procType.type==="ENCRYPTED")throw new Error("Could not convert encrypted private key from PEM; PEM is encrypted.");return M.fromDer(e.body)};Ie.encryptRsaPrivateKey=function(r,e,t){if(t=t||{},!t.legacy){var n=Ie.wrapRsaPrivateKey(Ie.privateKeyToAsn1(r));return n=Ie.encryptPrivateKeyInfo(n,e,t),Ie.encryptedPrivateKeyToPem(n)}var i,s,o,a;switch(t.algorithm){case"aes128":i="AES-128-CBC",o=16,s=ee.random.getBytesSync(16),a=ee.aes.createEncryptionCipher;break;case"aes192":i="AES-192-CBC",o=24,s=ee.random.getBytesSync(16),a=ee.aes.createEncryptionCipher;break;case"aes256":i="AES-256-CBC",o=32,s=ee.random.getBytesSync(16),a=ee.aes.createEncryptionCipher;break;case"3des":i="DES-EDE3-CBC",o=24,s=ee.random.getBytesSync(8),a=ee.des.createEncryptionCipher;break;case"des":i="DES-CBC",o=8,s=ee.random.getBytesSync(8),a=ee.des.createEncryptionCipher;break;default:var c=new Error('Could not encrypt RSA private key; unsupported encryption algorithm "'+t.algorithm+'".');throw c.algorithm=t.algorithm,c}var l=ee.pbe.opensslDeriveBytes(e,s.substr(0,8),o),u=a(l);u.start(s),u.update(M.toDer(Ie.privateKeyToAsn1(r))),u.finish();var f={type:"RSA PRIVATE KEY",procType:{version:"4",type:"ENCRYPTED"},dekInfo:{algorithm:i,parameters:ee.util.bytesToHex(s).toUpperCase()},body:u.output.getBytes()};return ee.pem.encode(f)};Ie.decryptRsaPrivateKey=function(r,e){var t=null,n=ee.pem.decode(r)[0];if(n.type!=="ENCRYPTED PRIVATE KEY"&&n.type!=="PRIVATE KEY"&&n.type!=="RSA PRIVATE KEY"){var i=new Error('Could not convert private key from PEM; PEM header type is not "ENCRYPTED PRIVATE KEY", "PRIVATE KEY", or "RSA PRIVATE KEY".');throw i.headerType=i,i}if(n.procType&&n.procType.type==="ENCRYPTED"){var s,o;switch(n.dekInfo.algorithm){case"DES-CBC":s=8,o=ee.des.createDecryptionCipher;break;case"DES-EDE3-CBC":s=24,o=ee.des.createDecryptionCipher;break;case"AES-128-CBC":s=16,o=ee.aes.createDecryptionCipher;break;case"AES-192-CBC":s=24,o=ee.aes.createDecryptionCipher;break;case"AES-256-CBC":s=32,o=ee.aes.createDecryptionCipher;break;case"RC2-40-CBC":s=5,o=function(f){return ee.rc2.createDecryptionCipher(f,40)};break;case"RC2-64-CBC":s=8,o=function(f){return ee.rc2.createDecryptionCipher(f,64)};break;case"RC2-128-CBC":s=16,o=function(f){return ee.rc2.createDecryptionCipher(f,128)};break;default:var i=new Error('Could not decrypt private key; unsupported encryption algorithm "'+n.dekInfo.algorithm+'".');throw i.algorithm=n.dekInfo.algorithm,i}var a=ee.util.hexToBytes(n.dekInfo.parameters),c=ee.pbe.opensslDeriveBytes(e,a.substr(0,8),s),l=o(c);if(l.start(a),l.update(ee.util.createBuffer(n.body)),l.finish())t=l.output.getBytes();else return t}else t=n.body;return n.type==="ENCRYPTED PRIVATE KEY"?t=Ie.decryptPrivateKeyInfo(M.fromDer(t),e):t=M.fromDer(t),t!==null&&(t=Ie.privateKeyFromAsn1(t)),t};Ie.pbe.generatePkcs12Key=function(r,e,t,n,i,s){var o,a;if(typeof s>"u"||s===null){if(!("sha1"in ee.md))throw new Error('"sha1" hash algorithm unavailable.');s=ee.md.sha1.create()}var c=s.digestLength,l=s.blockLength,u=new ee.util.ByteBuffer,f=new ee.util.ByteBuffer;if(r!=null){for(a=0;a<r.length;a++)f.putInt16(r.charCodeAt(a));f.putInt16(0)}var h=f.length(),d=e.length(),p=new ee.util.ByteBuffer;p.fillWithByte(t,l);var m=l*Math.ceil(d/l),g=new ee.util.ByteBuffer;for(a=0;a<m;a++)g.putByte(e.at(a%d));var y=l*Math.ceil(h/l),w=new ee.util.ByteBuffer;for(a=0;a<y;a++)w.putByte(f.at(a%h));var E=g;E.putBuffer(w);for(var R=Math.ceil(i/c),x=1;x<=R;x++){var v=new ee.util.ByteBuffer;v.putBytes(p.bytes()),v.putBytes(E.bytes());for(var I=0;I<n;I++)s.start(),s.update(v.getBytes()),v=s.digest();var _=new ee.util.ByteBuffer;for(a=0;a<l;a++)_.putByte(v.at(a%c));var k=Math.ceil(d/l)+Math.ceil(h/l),B=new ee.util.ByteBuffer;for(o=0;o<k;o++){var L=new ee.util.ByteBuffer(E.getBytes(l)),K=511;for(a=_.length()-1;a>=0;a--)K=K>>8,K+=_.at(a)+L.at(a),L.setAt(a,K&255);B.putBuffer(L)}E=B,u.putBuffer(v)}return u.truncate(u.length()-i),u};Ie.pbe.getCipher=function(r,e,t){switch(r){case Ie.oids.pkcs5PBES2:return Ie.pbe.getCipherForPBES2(r,e,t);case Ie.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:case Ie.oids["pbewithSHAAnd40BitRC2-CBC"]:return Ie.pbe.getCipherForPKCS12PBE(r,e,t);default:var n=new Error("Cannot read encrypted PBE data block. Unsupported OID.");throw n.oid=r,n.supportedOids=["pkcs5PBES2","pbeWithSHAAnd3-KeyTripleDES-CBC","pbewithSHAAnd40BitRC2-CBC"],n}};Ie.pbe.getCipherForPBES2=function(r,e,t){var n={},i=[];if(!M.validate(e,LO,n,i)){var s=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw s.errors=i,s}if(r=M.derToOid(n.kdfOid),r!==Ie.oids.pkcs5PBKDF2){var s=new Error("Cannot read encrypted private key. Unsupported key derivation function OID.");throw s.oid=r,s.supportedOids=["pkcs5PBKDF2"],s}if(r=M.derToOid(n.encOid),r!==Ie.oids["aes128-CBC"]&&r!==Ie.oids["aes192-CBC"]&&r!==Ie.oids["aes256-CBC"]&&r!==Ie.oids["des-EDE3-CBC"]&&r!==Ie.oids.desCBC){var s=new Error("Cannot read encrypted private key. Unsupported encryption scheme OID.");throw s.oid=r,s.supportedOids=["aes128-CBC","aes192-CBC","aes256-CBC","des-EDE3-CBC","desCBC"],s}var o=n.kdfSalt,a=ee.util.createBuffer(n.kdfIterationCount);a=a.getInt(a.length()<<3);var c,l;switch(Ie.oids[r]){case"aes128-CBC":c=16,l=ee.aes.createDecryptionCipher;break;case"aes192-CBC":c=24,l=ee.aes.createDecryptionCipher;break;case"aes256-CBC":c=32,l=ee.aes.createDecryptionCipher;break;case"des-EDE3-CBC":c=24,l=ee.des.createDecryptionCipher;break;case"desCBC":c=8,l=ee.des.createDecryptionCipher;break}var u=x9(n.prfOid),f=ee.pkcs5.pbkdf2(t,o,a,c,u),h=n.encIv,d=l(f);return d.start(h),d};Ie.pbe.getCipherForPKCS12PBE=function(r,e,t){var n={},i=[];if(!M.validate(e,BO,n,i)){var s=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw s.errors=i,s}var o=ee.util.createBuffer(n.salt),a=ee.util.createBuffer(n.iterations);a=a.getInt(a.length()<<3);var c,l,u;switch(r){case Ie.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:c=24,l=8,u=ee.des.startDecrypting;break;case Ie.oids["pbewithSHAAnd40BitRC2-CBC"]:c=5,l=8,u=function(m,g){var y=ee.rc2.createDecryptionCipher(m,40);return y.start(g,null),y};break;default:var s=new Error("Cannot read PKCS #12 PBE data block. Unsupported OID.");throw s.oid=r,s}var f=x9(n.prfOid),h=Ie.pbe.generatePkcs12Key(t,o,1,a,c,f);f.start();var d=Ie.pbe.generatePkcs12Key(t,o,2,a,l,f);return u(h,d)};Ie.pbe.opensslDeriveBytes=function(r,e,t,n){if(typeof n>"u"||n===null){if(!("md5"in ee.md))throw new Error('"md5" hash algorithm unavailable.');n=ee.md.md5.create()}e===null&&(e="");for(var i=[E9(n,r+e)],s=16,o=1;s<t;++o,s+=16)i.push(E9(n,i[o-1]+r+e));return i.join("").substr(0,t)};function E9(r,e){return r.start().update(e).digest().getBytes()}function x9(r){var e;if(!r)e="hmacWithSHA1";else if(e=Ie.oids[M.derToOid(r)],!e){var t=new Error("Unsupported PRF OID.");throw t.oid=r,t.supported=["hmacWithSHA1","hmacWithSHA224","hmacWithSHA256","hmacWithSHA384","hmacWithSHA512"],t}return v9(e)}function v9(r){var e=ee.md;switch(r){case"hmacWithSHA224":e=ee.md.sha512;case"hmacWithSHA1":case"hmacWithSHA256":case"hmacWithSHA384":case"hmacWithSHA512":r=r.substr(8).toLowerCase();break;default:var t=new Error("Unsupported PRF algorithm.");throw t.algorithm=r,t.supported=["hmacWithSHA1","hmacWithSHA224","hmacWithSHA256","hmacWithSHA384","hmacWithSHA512"],t}if(!e||!(r in e))throw new Error("Unknown hash algorithm: "+r);return e[r].create()}function MO(r,e,t,n){var i=M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OCTETSTRING,!1,r),M.create(M.Class.UNIVERSAL,M.Type.INTEGER,!1,e.getBytes())]);return n!=="hmacWithSHA1"&&i.value.push(M.create(M.Class.UNIVERSAL,M.Type.INTEGER,!1,ee.util.hexToBytes(t.toString(16))),M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(Ie.oids[n]).getBytes()),M.create(M.Class.UNIVERSAL,M.Type.NULL,!1,"")])),i}});var hb=F((kte,fb)=>{var ut=Qe();wo();At();var Pl=fb.exports=ut.sha512=ut.sha512||{};ut.md.sha512=ut.md.algorithms.sha512=Pl;var lb=ut.sha384=ut.sha512.sha384=ut.sha512.sha384||{};lb.create=function(){return Pl.create("SHA-384")};ut.md.sha384=ut.md.algorithms.sha384=lb;ut.sha512.sha256=ut.sha512.sha256||{create:function(){return Pl.create("SHA-512/256")}};ut.md["sha512/256"]=ut.md.algorithms["sha512/256"]=ut.sha512.sha256;ut.sha512.sha224=ut.sha512.sha224||{create:function(){return Pl.create("SHA-512/224")}};ut.md["sha512/224"]=ut.md.algorithms["sha512/224"]=ut.sha512.sha224;Pl.create=function(r){if(ub||YL(),typeof r>"u"&&(r="SHA-512"),!(r in Ao))throw new Error("Invalid SHA-512 algorithm: "+r);for(var e=Ao[r],t=null,n=ut.util.createBuffer(),i=new Array(80),s=0;s<80;++s)i[s]=new Array(2);var o=64;switch(r){case"SHA-384":o=48;break;case"SHA-512/256":o=32;break;case"SHA-512/224":o=28;break}var a={algorithm:r.replace("-","").toLowerCase(),blockLength:128,digestLength:o,messageLength:0,fullMessageLength:null,messageLengthSize:16};return a.start=function(){a.messageLength=0,a.fullMessageLength=a.messageLength128=[];for(var c=a.messageLengthSize/4,l=0;l<c;++l)a.fullMessageLength.push(0);n=ut.util.createBuffer(),t=new Array(e.length);for(var l=0;l<e.length;++l)t[l]=e[l].slice(0);return a},a.start(),a.update=function(c,l){l==="utf8"&&(c=ut.util.encodeUtf8(c));var u=c.length;a.messageLength+=u,u=[u/4294967296>>>0,u>>>0];for(var f=a.fullMessageLength.length-1;f>=0;--f)a.fullMessageLength[f]+=u[1],u[1]=u[0]+(a.fullMessageLength[f]/4294967296>>>0),a.fullMessageLength[f]=a.fullMessageLength[f]>>>0,u[0]=u[1]/4294967296>>>0;return n.putBytes(c),cb(t,i,n),(n.read>2048||n.length()===0)&&n.compact(),a},a.digest=function(){var c=ut.util.createBuffer();c.putBytes(n.bytes());var l=a.fullMessageLength[a.fullMessageLength.length-1]+a.messageLengthSize,u=l&a.blockLength-1;c.putBytes(X2.substr(0,a.blockLength-u));for(var f,h,d=a.fullMessageLength[0]*8,p=0;p<a.fullMessageLength.length-1;++p)f=a.fullMessageLength[p+1]*8,h=f/4294967296>>>0,d+=h,c.putInt32(d>>>0),d=f>>>0;c.putInt32(d);for(var m=new Array(t.length),p=0;p<t.length;++p)m[p]=t[p].slice(0);cb(m,i,c);var g=ut.util.createBuffer(),y;r==="SHA-512"?y=m.length:r==="SHA-384"?y=m.length-2:y=m.length-4;for(var p=0;p<y;++p)g.putInt32(m[p][0]),(p!==y-1||r!=="SHA-512/224")&&g.putInt32(m[p][1]);return g},a};var X2=null,ub=!1,j2=null,Ao=null;function YL(){X2=String.fromCharCode(128),X2+=ut.util.fillString(String.fromCharCode(0),128),j2=[[1116352408,3609767458],[1899447441,602891725],[3049323471,3964484399],[3921009573,2173295548],[961987163,4081628472],[1508970993,3053834265],[2453635748,2937671579],[2870763221,3664609560],[3624381080,2734883394],[310598401,1164996542],[607225278,1323610764],[1426881987,3590304994],[1925078388,4068182383],[2162078206,991336113],[2614888103,633803317],[3248222580,3479774868],[3835390401,2666613458],[4022224774,944711139],[264347078,2341262773],[604807628,2007800933],[770255983,1495990901],[1249150122,1856431235],[1555081692,3175218132],[1996064986,2198950837],[2554220882,3999719339],[2821834349,766784016],[2952996808,2566594879],[3210313671,3203337956],[3336571891,1034457026],[3584528711,2466948901],[113926993,3758326383],[338241895,168717936],[666307205,1188179964],[773529912,1546045734],[1294757372,1522805485],[1396182291,2643833823],[1695183700,2343527390],[1986661051,1014477480],[2177026350,1206759142],[2456956037,344077627],[2730485921,1290863460],[2820302411,3158454273],[3259730800,3505952657],[3345764771,106217008],[3516065817,3606008344],[3600352804,1432725776],[4094571909,1467031594],[275423344,851169720],[430227734,3100823752],[506948616,1363258195],[659060556,3750685593],[883997877,3785050280],[958139571,3318307427],[1322822218,3812723403],[1537002063,2003034995],[1747873779,3602036899],[1955562222,1575990012],[2024104815,1125592928],[2227730452,2716904306],[2361852424,442776044],[2428436474,593698344],[2756734187,3733110249],[3204031479,2999351573],[3329325298,3815920427],[3391569614,3928383900],[3515267271,566280711],[3940187606,3454069534],[4118630271,4000239992],[116418474,1914138554],[174292421,2731055270],[289380356,3203993006],[460393269,320620315],[685471733,587496836],[852142971,1086792851],[1017036298,365543100],[1126000580,2618297676],[1288033470,3409855158],[1501505948,4234509866],[1607167915,987167468],[1816402316,1246189591]],Ao={},Ao["SHA-512"]=[[1779033703,4089235720],[3144134277,2227873595],[1013904242,4271175723],[2773480762,1595750129],[1359893119,2917565137],[2600822924,725511199],[528734635,4215389547],[1541459225,327033209]],Ao["SHA-384"]=[[3418070365,3238371032],[1654270250,914150663],[2438529370,812702999],[355462360,4144912697],[1731405415,4290775857],[2394180231,1750603025],[3675008525,1694076839],[1203062813,3204075428]],Ao["SHA-512/256"]=[[573645204,4230739756],[2673172387,3360449730],[596883563,1867755857],[2520282905,1497426621],[2519219938,2827943907],[3193839141,1401305490],[721525244,746961066],[246885852,2177182882]],Ao["SHA-512/224"]=[[2352822216,424955298],[1944164710,2312950998],[502970286,855612546],[1738396948,1479516111],[258812777,2077511080],[2011393907,79989058],[1067287976,1780299464],[286451373,2446758561]],ub=!0}function cb(r,e,t){for(var n,i,s,o,a,c,l,u,f,h,d,p,m,g,y,w,E,R,x,v,I,_,k,B,L,K,W,te,P,N,O,U,A,z,Q,Z=t.length();Z>=128;){for(P=0;P<16;++P)e[P][0]=t.getInt32()>>>0,e[P][1]=t.getInt32()>>>0;for(;P<80;++P)U=e[P-2],N=U[0],O=U[1],n=((N>>>19|O<<13)^(O>>>29|N<<3)^N>>>6)>>>0,i=((N<<13|O>>>19)^(O<<3|N>>>29)^(N<<26|O>>>6))>>>0,z=e[P-15],N=z[0],O=z[1],s=((N>>>1|O<<31)^(N>>>8|O<<24)^N>>>7)>>>0,o=((N<<31|O>>>1)^(N<<24|O>>>8)^(N<<25|O>>>7))>>>0,A=e[P-7],Q=e[P-16],O=i+A[1]+o+Q[1],e[P][0]=n+A[0]+s+Q[0]+(O/4294967296>>>0)>>>0,e[P][1]=O>>>0;for(m=r[0][0],g=r[0][1],y=r[1][0],w=r[1][1],E=r[2][0],R=r[2][1],x=r[3][0],v=r[3][1],I=r[4][0],_=r[4][1],k=r[5][0],B=r[5][1],L=r[6][0],K=r[6][1],W=r[7][0],te=r[7][1],P=0;P<80;++P)l=((I>>>14|_<<18)^(I>>>18|_<<14)^(_>>>9|I<<23))>>>0,u=((I<<18|_>>>14)^(I<<14|_>>>18)^(_<<23|I>>>9))>>>0,f=(L^I&(k^L))>>>0,h=(K^_&(B^K))>>>0,a=((m>>>28|g<<4)^(g>>>2|m<<30)^(g>>>7|m<<25))>>>0,c=((m<<4|g>>>28)^(g<<30|m>>>2)^(g<<25|m>>>7))>>>0,d=(m&y|E&(m^y))>>>0,p=(g&w|R&(g^w))>>>0,O=te+u+h+j2[P][1]+e[P][1],n=W+l+f+j2[P][0]+e[P][0]+(O/4294967296>>>0)>>>0,i=O>>>0,O=c+p,s=a+d+(O/4294967296>>>0)>>>0,o=O>>>0,W=L,te=K,L=k,K=B,k=I,B=_,O=v+i,I=x+n+(O/4294967296>>>0)>>>0,_=O>>>0,x=E,v=R,E=y,R=w,y=m,w=g,O=i+o,m=n+s+(O/4294967296>>>0)>>>0,g=O>>>0;O=r[0][1]+g,r[0][0]=r[0][0]+m+(O/4294967296>>>0)>>>0,r[0][1]=O>>>0,O=r[1][1]+w,r[1][0]=r[1][0]+y+(O/4294967296>>>0)>>>0,r[1][1]=O>>>0,O=r[2][1]+R,r[2][0]=r[2][0]+E+(O/4294967296>>>0)>>>0,r[2][1]=O>>>0,O=r[3][1]+v,r[3][0]=r[3][0]+x+(O/4294967296>>>0)>>>0,r[3][1]=O>>>0,O=r[4][1]+_,r[4][0]=r[4][0]+I+(O/4294967296>>>0)>>>0,r[4][1]=O>>>0,O=r[5][1]+B,r[5][0]=r[5][0]+k+(O/4294967296>>>0)>>>0,r[5][1]=O>>>0,O=r[6][1]+K,r[6][0]=r[6][0]+L+(O/4294967296>>>0)>>>0,r[6][1]=O>>>0,O=r[7][1]+te,r[7][0]=r[7][0]+W+(O/4294967296>>>0)>>>0,r[7][1]=O>>>0,Z-=128}}});var qb=F((gne,Vb)=>{"use strict";Vb.exports=r=>{if(Object.prototype.toString.call(r)!=="[object Object]")return!1;let e=Object.getPrototypeOf(r);return e===null||e===Object.prototype}});var Yb=F((Wb,Gb)=>{"use strict";var Nf=qb(),{hasOwnProperty:$b}=Object.prototype,{propertyIsEnumerable:AB}=Object,za=(r,e,t)=>Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0}),TB=Wb,zb={concatArrays:!1,ignoreUndefined:!1},Of=r=>{let e=[];for(let t in r)$b.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){let t=Object.getOwnPropertySymbols(r);for(let n of t)AB.call(r,n)&&e.push(n)}return e};function $a(r){return Array.isArray(r)?DB(r):Nf(r)?CB(r):r}function DB(r){let e=r.slice(0,0);return Of(r).forEach(t=>{za(e,t,$a(r[t]))}),e}function CB(r){let e=Object.getPrototypeOf(r)===null?Object.create(null):{};return Of(r).forEach(t=>{za(e,t,$a(r[t]))}),e}var Hb=(r,e,t,n)=>(t.forEach(i=>{typeof e[i]>"u"&&n.ignoreUndefined||(i in r&&r[i]!==Object.getPrototypeOf(r)?za(r,i,dm(r[i],e[i],n)):za(r,i,$a(e[i])))}),r),PB=(r,e,t)=>{let n=r.slice(0,0),i=0;return[r,e].forEach(s=>{let o=[];for(let a=0;a<s.length;a++)$b.call(s,a)&&(o.push(String(a)),s===r?za(n,i++,s[a]):za(n,i++,$a(s[a])));n=Hb(n,s,Of(s).filter(a=>!o.includes(a)),t)}),n};function dm(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?PB(r,e,t):!Nf(e)||!Nf(r)?$a(e):Hb(r,e,Of(e),t)}Gb.exports=function(...r){let e=dm($a(zb),this!==TB&&this||{},zb),t={_:{}};for(let n of r)if(n!==void 0){if(!Nf(n))throw new TypeError("`"+n+"` is not an Option Object");t=dm(t,{_:n},e)}return t._}});var jb=F((bne,Xb)=>{"use strict";function kB(r){return r>=55296&&r<=56319}function NB(r){return r>=56320&&r<=57343}Xb.exports=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var i=t.length,s=0,o,a,c=0;c<i;c+=1){if(o=t.charCodeAt(c),a=t[c],kB(o)&&NB(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),s+=e(a),s===n)return t.slice(0,c+1);if(s>n)return t.slice(0,c-a.length+1)}return t}});var Jb=F((wne,Zb)=>{"use strict";function OB(r){return r>=55296&&r<=56319}function LB(r){return r>=56320&&r<=57343}Zb.exports=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,i=null,s=null,o=0;o<t;o++)i=e.charCodeAt(o),LB(i)?s!=null&&OB(s)?n+=1:n+=3:i<=127?n+=1:i>=128&&i<=2047?n+=2:i>=2048&&i<=65535&&(n+=3),s=i;return n}});var tw=F((Ene,ew)=>{"use strict";var BB=jb(),MB=Jb();ew.exports=BB.bind(null,MB)});var iw=F((xne,nw)=>{"use strict";var UB=tw(),FB=/[\/\?<>\\:\*\|"]/g,KB=/[\x00-\x1f\x80-\x9f]/g,VB=/^\.+$/,qB=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,zB=/[\. ]+$/;function rw(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(FB,e).replace(KB,e).replace(VB,e).replace(qB,e).replace(zB,e);return UB(t,255)}nw.exports=function(r,e){var t=e&&e.replacement||"",n=rw(r,t);return t===""?n:rw(n,"")}});var Pw=F($l=>{(function(){var r,e,t,n,i,s,o,a;a=function(c){var l,u,f,h;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,f=(c&65280)>>>8,h=c&255,[l,u,f,h].join(".")},o=function(c){var l,u,f,h,d,p;for(l=[],f=h=0;h<=3&&c.length!==0;f=++h){if(f>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}p=e(c),d=p[0],u=p[1],c=c.substring(u),l.push(d)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),s=t("a"),i=t("A"),e=function(c){var l,u,f,h,d;for(h=0,l=10,u="9",f=0,c.length>1&&c[f]==="0"&&(c[f+1]==="x"||c[f+1]==="X"?(f+=2,l=16):"0"<=c[f+1]&&c[f+1]<="9"&&(f++,l=8,u="7")),d=f;f<c.length;){if("0"<=c[f]&&c[f]<=u)h=h*l+(t(c[f])-n)>>>0;else if(l===16)if("a"<=c[f]&&c[f]<="f")h=h*l+(10+t(c[f])-s)>>>0;else if("A"<=c[f]&&c[f]<="F")h=h*l+(10+t(c[f])-i)>>>0;else break;else break;if(h>4294967295)throw new Error("too large");f++}if(f===d)throw new Error("empty octet");return[h,f]},r=function(){function c(l,u){var f,h,d,p;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(p=l.split("/",2),l=p[0],u=p[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=o(u)}catch(m){throw f=m,new Error("Invalid mask: "+u)}for(h=d=32;d>=0;h=--d)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(l)&this.maskLong)>>>0}catch(m){throw f=m,new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(o(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,f,h;for(h=o(this.first),f=o(this.last),u=0;h<=f;)l(a(h),h,u),u++,h++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),$l.ip2long=o,$l.long2ip=a,$l.Netmask=r}).call($l)});var Lw=F((Ow,Zf)=>{(function(r){"use strict";let e="(0?\\d+|0x[a-f0-9]+)",t={fourOctet:new RegExp(`^${e}\\.${e}\\.${e}\\.${e}$`,"i"),threeOctet:new RegExp(`^${e}\\.${e}\\.${e}$`,"i"),twoOctet:new RegExp(`^${e}\\.${e}$`,"i"),longValue:new RegExp(`^${e}$`,"i")},n=new RegExp("^0[0-7]+$","i"),i=new RegExp("^0x[a-f0-9]+$","i"),s="%[0-9a-z]{1,}",o="(?:[0-9a-f]+::?)+",a={zoneIndex:new RegExp(s,"i"),native:new RegExp(`^(::)?(${o})?([0-9a-f]+)?(::)?(${s})?$`,"i"),deprecatedTransitional:new RegExp(`^(?:::)(${e}\\.${e}\\.${e}\\.${e}(${s})?)$`,"i"),transitional:new RegExp(`^((?:${o})|(?:::)(?:${o})?)${e}\\.${e}\\.${e}\\.${e}(${s})?$`,"i")};function c(d,p){if(d.indexOf("::")!==d.lastIndexOf("::"))return null;let m=0,g=-1,y=(d.match(a.zoneIndex)||[])[0],w,E;for(y&&(y=y.substring(1),d=d.replace(/%.+$/,""));(g=d.indexOf(":",g+1))>=0;)m++;if(d.substr(0,2)==="::"&&m--,d.substr(-2,2)==="::"&&m--,m>p)return null;for(E=p-m,w=":";E--;)w+="0:";return d=d.replace("::",w),d[0]===":"&&(d=d.slice(1)),d[d.length-1]===":"&&(d=d.slice(0,-1)),p=function(){let R=d.split(":"),x=[];for(let v=0;v<R.length;v++)x.push(parseInt(R[v],16));return x}(),{parts:p,zoneId:y}}function l(d,p,m,g){if(d.length!==p.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");let y=0,w;for(;g>0;){if(w=m-g,w<0&&(w=0),d[y]>>w!==p[y]>>w)return!1;g-=m,y+=1}return!0}function u(d){if(i.test(d))return parseInt(d,16);if(d[0]==="0"&&!isNaN(parseInt(d[1],10))){if(n.test(d))return parseInt(d,8);throw new Error(`ipaddr: cannot parse ${d} as octal`)}return parseInt(d,10)}function f(d,p){for(;d.length<p;)d=`0${d}`;return d}let h={};h.IPv4=function(){function d(p){if(p.length!==4)throw new Error("ipaddr: ipv4 octet count should be 4");let m,g;for(m=0;m<p.length;m++)if(g=p[m],!(0<=g&&g<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=p}return d.prototype.SpecialRanges={unspecified:[[new d([0,0,0,0]),8]],broadcast:[[new d([255,255,255,255]),32]],multicast:[[new d([224,0,0,0]),4]],linkLocal:[[new d([169,254,0,0]),16]],loopback:[[new d([127,0,0,0]),8]],carrierGradeNat:[[new d([100,64,0,0]),10]],private:[[new d([10,0,0,0]),8],[new d([172,16,0,0]),12],[new d([192,168,0,0]),16]],reserved:[[new d([192,0,0,0]),24],[new d([192,0,2,0]),24],[new d([192,88,99,0]),24],[new d([198,18,0,0]),15],[new d([198,51,100,0]),24],[new d([203,0,113,0]),24],[new d([240,0,0,0]),4]]},d.prototype.kind=function(){return"ipv4"},d.prototype.match=function(p,m){let g;if(m===void 0&&(g=p,p=g[0],m=g[1]),p.kind()!=="ipv4")throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return l(this.octets,p.octets,8,m)},d.prototype.prefixLengthFromSubnetMask=function(){let p=0,m=!1,g={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0},y,w,E;for(y=3;y>=0;y-=1)if(w=this.octets[y],w in g){if(E=g[w],m&&E!==0)return null;E!==8&&(m=!0),p+=E}else return null;return 32-p},d.prototype.range=function(){return h.subnetMatch(this,this.SpecialRanges)},d.prototype.toByteArray=function(){return this.octets.slice(0)},d.prototype.toIPv4MappedAddress=function(){return h.IPv6.parse(`::ffff:${this.toString()}`)},d.prototype.toNormalizedString=function(){return this.toString()},d.prototype.toString=function(){return this.octets.join(".")},d}(),h.IPv4.broadcastAddressFromCIDR=function(d){try{let p=this.parseCIDR(d),m=p[0].toByteArray(),g=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),y=[],w=0;for(;w<4;)y.push(parseInt(m[w],10)|parseInt(g[w],10)^255),w++;return new this(y)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},h.IPv4.isIPv4=function(d){return this.parser(d)!==null},h.IPv4.isValid=function(d){try{return new this(this.parser(d)),!0}catch{return!1}},h.IPv4.isValidFourPartDecimal=function(d){return!!(h.IPv4.isValid(d)&&d.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},h.IPv4.networkAddressFromCIDR=function(d){let p,m,g,y,w;try{for(p=this.parseCIDR(d),g=p[0].toByteArray(),w=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),y=[],m=0;m<4;)y.push(parseInt(g[m],10)&parseInt(w[m],10)),m++;return new this(y)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},h.IPv4.parse=function(d){let p=this.parser(d);if(p===null)throw new Error("ipaddr: string is not formatted like an IPv4 Address");return new this(p)},h.IPv4.parseCIDR=function(d){let p;if(p=d.match(/^(.+)\/(\d+)$/)){let m=parseInt(p[2]);if(m>=0&&m<=32){let g=[this.parse(p[1]),m];return Object.defineProperty(g,"toString",{value:function(){return this.join("/")}}),g}}throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},h.IPv4.parser=function(d){let p,m,g;if(p=d.match(t.fourOctet))return function(){let y=p.slice(1,6),w=[];for(let E=0;E<y.length;E++)m=y[E],w.push(u(m));return w}();if(p=d.match(t.longValue)){if(g=u(p[1]),g>4294967295||g<0)throw new Error("ipaddr: address outside defined range");return function(){let y=[],w;for(w=0;w<=24;w+=8)y.push(g>>w&255);return y}().reverse()}else return(p=d.match(t.twoOctet))?function(){let y=p.slice(1,4),w=[];if(g=u(y[1]),g>16777215||g<0)throw new Error("ipaddr: address outside defined range");return w.push(u(y[0])),w.push(g>>16&255),w.push(g>>8&255),w.push(g&255),w}():(p=d.match(t.threeOctet))?function(){let y=p.slice(1,5),w=[];if(g=u(y[2]),g>65535||g<0)throw new Error("ipaddr: address outside defined range");return w.push(u(y[0])),w.push(u(y[1])),w.push(g>>8&255),w.push(g&255),w}():null},h.IPv4.subnetMaskFromPrefixLength=function(d){if(d=parseInt(d),d<0||d>32)throw new Error("ipaddr: invalid IPv4 prefix length");let p=[0,0,0,0],m=0,g=Math.floor(d/8);for(;m<g;)p[m]=255,m++;return g<4&&(p[g]=Math.pow(2,d%8)-1<<8-d%8),new this(p)},h.IPv6=function(){function d(p,m){let g,y;if(p.length===16)for(this.parts=[],g=0;g<=14;g+=2)this.parts.push(p[g]<<8|p[g+1]);else if(p.length===8)this.parts=p;else throw new Error("ipaddr: ipv6 part count should be 8 or 16");for(g=0;g<this.parts.length;g++)if(y=this.parts[g],!(0<=y&&y<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");m&&(this.zoneId=m)}return d.prototype.SpecialRanges={unspecified:[new d([0,0,0,0,0,0,0,0]),128],linkLocal:[new d([65152,0,0,0,0,0,0,0]),10],multicast:[new d([65280,0,0,0,0,0,0,0]),8],loopback:[new d([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new d([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new d([0,0,0,0,0,65535,0,0]),96],rfc6145:[new d([0,0,0,0,65535,0,0,0]),96],rfc6052:[new d([100,65435,0,0,0,0,0,0]),96],"6to4":[new d([8194,0,0,0,0,0,0,0]),16],teredo:[new d([8193,0,0,0,0,0,0,0]),32],reserved:[[new d([8193,3512,0,0,0,0,0,0]),32]],benchmarking:[new d([8193,2,0,0,0,0,0,0]),48],amt:[new d([8193,3,0,0,0,0,0,0]),32],as112v6:[new d([8193,4,274,0,0,0,0,0]),48],deprecated:[new d([8193,16,0,0,0,0,0,0]),28],orchid2:[new d([8193,32,0,0,0,0,0,0]),28]},d.prototype.isIPv4MappedAddress=function(){return this.range()==="ipv4Mapped"},d.prototype.kind=function(){return"ipv6"},d.prototype.match=function(p,m){let g;if(m===void 0&&(g=p,p=g[0],m=g[1]),p.kind()!=="ipv6")throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return l(this.parts,p.parts,16,m)},d.prototype.prefixLengthFromSubnetMask=function(){let p=0,m=!1,g={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0},y,w;for(let E=7;E>=0;E-=1)if(y=this.parts[E],y in g){if(w=g[y],m&&w!==0)return null;w!==16&&(m=!0),p+=w}else return null;return 128-p},d.prototype.range=function(){return h.subnetMatch(this,this.SpecialRanges)},d.prototype.toByteArray=function(){let p,m=[],g=this.parts;for(let y=0;y<g.length;y++)p=g[y],m.push(p>>8),m.push(p&255);return m},d.prototype.toFixedLengthString=function(){let p=function(){let g=[];for(let y=0;y<this.parts.length;y++)g.push(f(this.parts[y].toString(16),4));return g}.call(this).join(":"),m="";return this.zoneId&&(m=`%${this.zoneId}`),p+m},d.prototype.toIPv4Address=function(){if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");let p=this.parts.slice(-2),m=p[0],g=p[1];return new h.IPv4([m>>8,m&255,g>>8,g&255])},d.prototype.toNormalizedString=function(){let p=function(){let g=[];for(let y=0;y<this.parts.length;y++)g.push(this.parts[y].toString(16));return g}.call(this).join(":"),m="";return this.zoneId&&(m=`%${this.zoneId}`),p+m},d.prototype.toRFC5952String=function(){let p=/((^|:)(0(:|$)){2,})/g,m=this.toNormalizedString(),g=0,y=-1,w;for(;w=p.exec(m);)w[0].length>y&&(g=w.index,y=w[0].length);return y<0?m:`${m.substring(0,g)}::${m.substring(g+y)}`},d.prototype.toString=function(){return this.toRFC5952String()},d}(),h.IPv6.broadcastAddressFromCIDR=function(d){try{let p=this.parseCIDR(d),m=p[0].toByteArray(),g=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),y=[],w=0;for(;w<16;)y.push(parseInt(m[w],10)|parseInt(g[w],10)^255),w++;return new this(y)}catch(p){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${p})`)}},h.IPv6.isIPv6=function(d){return this.parser(d)!==null},h.IPv6.isValid=function(d){if(typeof d=="string"&&d.indexOf(":")===-1)return!1;try{let p=this.parser(d);return new this(p.parts,p.zoneId),!0}catch{return!1}},h.IPv6.networkAddressFromCIDR=function(d){let p,m,g,y,w;try{for(p=this.parseCIDR(d),g=p[0].toByteArray(),w=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),y=[],m=0;m<16;)y.push(parseInt(g[m],10)&parseInt(w[m],10)),m++;return new this(y)}catch(E){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${E})`)}},h.IPv6.parse=function(d){let p=this.parser(d);if(p.parts===null)throw new Error("ipaddr: string is not formatted like an IPv6 Address");return new this(p.parts,p.zoneId)},h.IPv6.parseCIDR=function(d){let p,m,g;if((m=d.match(/^(.+)\/(\d+)$/))&&(p=parseInt(m[2]),p>=0&&p<=128))return g=[this.parse(m[1]),p],Object.defineProperty(g,"toString",{value:function(){return this.join("/")}}),g;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},h.IPv6.parser=function(d){let p,m,g,y,w,E;if(g=d.match(a.deprecatedTransitional))return this.parser(`::ffff:${g[1]}`);if(a.native.test(d))return c(d,8);if((g=d.match(a.transitional))&&(E=g[6]||"",p=c(g[1].slice(0,-1)+E,6),p.parts)){for(w=[parseInt(g[2]),parseInt(g[3]),parseInt(g[4]),parseInt(g[5])],m=0;m<w.length;m++)if(y=w[m],!(0<=y&&y<=255))return null;return p.parts.push(w[0]<<8|w[1]),p.parts.push(w[2]<<8|w[3]),{parts:p.parts,zoneId:p.zoneId}}return null},h.IPv6.subnetMaskFromPrefixLength=function(d){if(d=parseInt(d),d<0||d>128)throw new Error("ipaddr: invalid IPv6 prefix length");let p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],m=0,g=Math.floor(d/8);for(;m<g;)p[m]=255,m++;return g<16&&(p[g]=Math.pow(2,d%8)-1<<8-d%8),new this(p)},h.fromByteArray=function(d){let p=d.length;if(p===4)return new h.IPv4(d);if(p===16)return new h.IPv6(d);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},h.isValid=function(d){return h.IPv6.isValid(d)||h.IPv4.isValid(d)},h.parse=function(d){if(h.IPv6.isValid(d))return h.IPv6.parse(d);if(h.IPv4.isValid(d))return h.IPv4.parse(d);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},h.parseCIDR=function(d){try{return h.IPv6.parseCIDR(d)}catch{try{return h.IPv4.parseCIDR(d)}catch{throw new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},h.process=function(d){let p=this.parse(d);return p.kind()==="ipv6"&&p.isIPv4MappedAddress()?p.toIPv4Address():p},h.subnetMatch=function(d,p,m){let g,y,w,E;m==null&&(m="unicast");for(y in p)if(Object.prototype.hasOwnProperty.call(p,y)){for(w=p[y],w[0]&&!(w[0]instanceof Array)&&(w=[w]),g=0;g<w.length;g++)if(E=w[g],d.kind()===E[0].kind()&&d.match.apply(d,E))return y}return m},typeof Zf<"u"&&Zf.exports?Zf.exports=h:r.ipaddr=h})(Ow)});var rE=F((bae,tE)=>{"use strict";tE.exports=eE;var NM=v1(),Ns=eE.prototype,OM=new Date%1e9;function LM(){return(Math.random()*1e9>>>0)+OM++}function eE(r){r=r||{},this.id=r.id||LM(),this.max=r.max||1/0,this.items=r.items||[],this._lookup={},this.size=this.items.length,this.lastModified=new Date(r.lastModified||new Date);for(var e,t,n=this.items.length;n--;)e=this.items[n],t=new Date(e.expires)-new Date,this._lookup[e.key]=e,t>0?this.expire(e.key,t):t<=0&&this.delete(e.key)}Ns.has=function(r){return r in this._lookup};Ns.get=function(r){if(!this.has(r))return null;var e=this._lookup[r];return e.refresh&&this.expire(r,e.refresh),this.items.splice(this.items.indexOf(e),1),this.items.push(e),e.value};Ns.meta=function(r){if(!this.has(r))return null;var e=this._lookup[r];return"meta"in e?e.meta:null};Ns.set=function(r,e,t){var n=this._lookup[r],i=this._lookup[r]={key:r,value:e};return this.lastModified=new Date,n?(clearTimeout(n.timeout),this.items.splice(this.items.indexOf(n),1,i)):(this.size>=this.max&&this.delete(this.items[0].key),this.items.push(i),this.size++),t&&("ttl"in t&&this.expire(r,t.ttl),"meta"in t&&(i.meta=t.meta),t.refresh&&(i.refresh=t.ttl)),this};Ns.delete=function(r){var e=this._lookup[r];return e?(this.lastModified=new Date,this.items.splice(this.items.indexOf(e),1),clearTimeout(e.timeout),delete this._lookup[r],this.size--,this):!1};Ns.expire=function(r,e){var t=e||0,n=this._lookup[r];if(!n)return this;if(typeof t=="string"&&(t=NM(e)),typeof t!="number")throw new TypeError("Expiration time must be a string or number.");return clearTimeout(n.timeout),n.timeout=setTimeout(this.delete.bind(this,n.key),t),n.expires=Number(new Date)+t,this};Ns.clear=function(){for(var r=this.items.length;r--;)this.delete(this.items[r].key);return this};Ns.toJSON=function(){for(var r=new Array(this.items.length),e,t=r.length;t--;)e=this.items[t],r[t]={key:e.key,meta:e.meta,value:e.value,expires:e.expires,refresh:e.refresh};return{id:this.id,max:isFinite(this.max)?this.max:void 0,lastModified:this.lastModified,items:r}}});var Ql=F((Fae,uE)=>{uE.exports=class{constructor(e={}){this.points=e.points,this.duration=e.duration,this.blockDuration=e.blockDuration,this.execEvenly=e.execEvenly,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs,this.keyPrefix=e.keyPrefix}get points(){return this._points}set points(e){this._points=e>=0?e:4}get duration(){return this._duration}set duration(e){this._duration=typeof e>"u"?1:e}get msDuration(){return this.duration*1e3}get blockDuration(){return this._blockDuration}set blockDuration(e){this._blockDuration=typeof e>"u"?0:e}get msBlockDuration(){return this.blockDuration*1e3}get execEvenly(){return this._execEvenly}set execEvenly(e){this._execEvenly=typeof e>"u"?!1:!!e}get execEvenlyMinDelayMs(){return this._execEvenlyMinDelayMs}set execEvenlyMinDelayMs(e){this._execEvenlyMinDelayMs=typeof e>"u"?Math.ceil(this.msDuration/this.points):e}get keyPrefix(){return this._keyPrefix}set keyPrefix(e){if(typeof e>"u"&&(e="rlflx"),typeof e!="string")throw new Error("keyPrefix must be string");this._keyPrefix=e}_getKeySecDuration(e={}){return e&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}consume(){throw new Error("You have to implement the method 'consume'!")}penalty(){throw new Error("You have to implement the method 'penalty'!")}reward(){throw new Error("You have to implement the method 'reward'!")}get(){throw new Error("You have to implement the method 'get'!")}set(){throw new Error("You have to implement the method 'set'!")}block(){throw new Error("You have to implement the method 'block'!")}delete(){throw new Error("You have to implement the method 'delete'!")}}});var hE=F((Vae,fE)=>{fE.exports=class{constructor(){this._keys={},this._addedKeysAmount=0}collectExpired(){let e=Date.now();Object.keys(this._keys).forEach(t=>{this._keys[t]<=e&&delete this._keys[t]}),this._addedKeysAmount=Object.keys(this._keys).length}add(e,t){this.addMs(e,t*1e3)}addMs(e,t){this._keys[e]=Date.now()+t,this._addedKeysAmount++,this._addedKeysAmount>999&&this.collectExpired()}msBeforeExpire(e){let t=this._keys[e];if(t&&t>=Date.now()){this.collectExpired();let n=Date.now();return t>=n?t-n:0}return 0}delete(e){e?delete this._keys[e]:Object.keys(this._keys).forEach(t=>{delete this._keys[t]})}}});var pE=F((qae,dE)=>{var FM=hE();dE.exports=FM});var en=F(($ae,mE)=>{mE.exports=class{constructor(e,t,n,i){this.remainingPoints=typeof e>"u"?0:e,this.msBeforeNext=typeof t>"u"?0:t,this.consumedPoints=typeof n>"u"?0:n,this.isFirstInDuration=typeof i>"u"?!1:i}get msBeforeNext(){return this._msBeforeNext}set msBeforeNext(e){return this._msBeforeNext=e,this}get remainingPoints(){return this._remainingPoints}set remainingPoints(e){return this._remainingPoints=e,this}get consumedPoints(){return this._consumedPoints}set consumedPoints(e){return this._consumedPoints=e,this}get isFirstInDuration(){return this._isFirstInDuration}set isFirstInDuration(e){this._isFirstInDuration=!!e}_getDecoratedProperties(){return{remainingPoints:this.remainingPoints,msBeforeNext:this.msBeforeNext,consumedPoints:this.consumedPoints,isFirstInDuration:this.isFirstInDuration}}[Symbol.for("nodejs.util.inspect.custom")](){return this._getDecoratedProperties()}toString(){return JSON.stringify(this._getDecoratedProperties())}toJSON(){return this._getDecoratedProperties()}}});var Ja=F((Wae,yE)=>{var qm=Ql(),KM=pE(),gE=en();yE.exports=class extends qm{constructor(e={}){super(e),this.inMemoryBlockOnConsumed=e.inMemoryBlockOnConsumed,this.inMemoryBlockDuration=e.inMemoryBlockDuration,this.insuranceLimiter=e.insuranceLimiter,this._inMemoryBlockedKeys=new KM}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("storeClient is not set");this._client=e}_afterConsume(e,t,n,i,s,o={}){let a=this._getRateLimiterRes(n,i,s);if(this.inMemoryBlockOnConsumed>0&&!(this.inMemoryBlockDuration>0)&&a.consumedPoints>=this.inMemoryBlockOnConsumed)return this._inMemoryBlockedKeys.addMs(n,a.msBeforeNext),a.consumedPoints>this.points?t(a):e(a);if(a.consumedPoints>this.points){let c=Promise.resolve();this.blockDuration>0&&a.consumedPoints<=this.points+i&&(a.msBeforeNext=this.msBlockDuration,c=this._block(n,a.consumedPoints,this.msBlockDuration,o)),this.inMemoryBlockOnConsumed>0&&a.consumedPoints>=this.inMemoryBlockOnConsumed&&(this._inMemoryBlockedKeys.add(n,this.inMemoryBlockDuration),a.msBeforeNext=this.msInMemoryBlockDuration),c.then(()=>{t(a)}).catch(l=>{t(l)})}else if(this.execEvenly&&a.msBeforeNext>0&&!a.isFirstInDuration){let c=Math.ceil(a.msBeforeNext/(a.remainingPoints+2));c<this.execEvenlyMinDelayMs&&(c=a.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(e,c,a)}else e(a)}_handleError(e,t,n,i,s,o=!1,a={}){this.insuranceLimiter instanceof qm?this.insuranceLimiter[t](s,o,a).then(c=>{n(c)}).catch(c=>{i(c)}):i(e)}getInMemoryBlockMsBeforeExpire(e){return this.inMemoryBlockOnConsumed>0?this._inMemoryBlockedKeys.msBeforeExpire(e):0}get inMemoryBlockOnConsumed(){return this._inMemoryBlockOnConsumed}set inMemoryBlockOnConsumed(e){if(this._inMemoryBlockOnConsumed=e?parseInt(e):0,this.inMemoryBlockOnConsumed>0&&this.points>this.inMemoryBlockOnConsumed)throw new Error('inMemoryBlockOnConsumed option must be greater or equal "points" option')}get inMemoryBlockDuration(){return this._inMemoryBlockDuration}set inMemoryBlockDuration(e){if(this._inMemoryBlockDuration=e?parseInt(e):0,this.inMemoryBlockDuration>0&&this.inMemoryBlockOnConsumed===0)throw new Error("inMemoryBlockOnConsumed option must be set up")}get msInMemoryBlockDuration(){return this._inMemoryBlockDuration*1e3}get insuranceLimiter(){return this._insuranceLimiter}set insuranceLimiter(e){if(typeof e<"u"&&!(e instanceof qm))throw new Error("insuranceLimiter must be instance of RateLimiterAbstract");this._insuranceLimiter=e,this._insuranceLimiter&&(this._insuranceLimiter.blockDuration=this.blockDuration,this._insuranceLimiter.execEvenly=this.execEvenly)}block(e,t,n={}){let i=t*1e3;return this._block(this.getKey(e),this.points+1,i,n)}set(e,t,n,i={}){let s=(n>=0?n:this.duration)*1e3;return this._block(this.getKey(e),t,s,i)}consume(e,t=1,n={}){return new Promise((i,s)=>{let o=this.getKey(e),a=this.getInMemoryBlockMsBeforeExpire(o);if(a>0)return s(new gE(0,a));this._upsert(o,t,this._getKeySecDuration(n)*1e3,!1,n).then(c=>{this._afterConsume(i,s,o,t,c)}).catch(c=>{this._handleError(c,"consume",i,s,e,t,n)})})}penalty(e,t=1,n={}){let i=this.getKey(e);return new Promise((s,o)=>{this._upsert(i,t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{s(this._getRateLimiterRes(i,t,a))}).catch(a=>{this._handleError(a,"penalty",s,o,e,t,n)})})}reward(e,t=1,n={}){let i=this.getKey(e);return new Promise((s,o)=>{this._upsert(i,-t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{s(this._getRateLimiterRes(i,-t,a))}).catch(a=>{this._handleError(a,"reward",s,o,e,t,n)})})}get(e,t={}){let n=this.getKey(e);return new Promise((i,s)=>{this._get(n,t).then(o=>{i(o===null||typeof o>"u"?null:this._getRateLimiterRes(n,0,o))}).catch(o=>{this._handleError(o,"get",i,s,e,t)})})}delete(e,t={}){let n=this.getKey(e);return new Promise((i,s)=>{this._delete(n,t).then(o=>{this._inMemoryBlockedKeys.delete(n),i(o)}).catch(o=>{this._handleError(o,"delete",i,s,e,t)})})}deleteInMemoryBlockedAll(){this._inMemoryBlockedKeys.delete()}_getRateLimiterRes(e,t,n){throw new Error("You have to implement the method '_getRateLimiterRes'!")}_block(e,t,n,i={}){return new Promise((s,o)=>{this._upsert(e,t,n,!0,i).then(()=>{s(new gE(0,n>0?n:-1,t))}).catch(a=>{this._handleError(a,"block",s,o,this.parseKey(e),n/1e3,i)})})}_get(e,t={}){throw new Error("You have to implement the method '_get'!")}_delete(e,t={}){throw new Error("You have to implement the method '_delete'!")}_upsert(e,t,n,i=!1,s={}){throw new Error("You have to implement the method '_upsert'!")}}});var wE=F((Gae,bE)=>{var VM=Ja(),qM=en(),zm="redis.call('set', KEYS[1], 0, 'EX', ARGV[2], 'NX') local consumed = redis.call('incrby', KEYS[1], ARGV[1]) local ttl = redis.call('pttl', KEYS[1]) if ttl == -1 then   redis.call('expire', KEYS[1], ARGV[2])   ttl = 1000 * ARGV[2] end return {consumed, ttl} ",$m=class extends VM{constructor(e){super(e),this.client=e.storeClient,this._rejectIfRedisNotReady=!!e.rejectIfRedisNotReady,this.useRedisPackage=e.useRedisPackage,this.useRedis3AndLowerPackage=e.useRedis3AndLowerPackage,typeof this.client.defineCommand=="function"&&this.client.defineCommand("rlflxIncr",{numberOfKeys:1,lua:zm})}_isRedisReady(){return this._rejectIfRedisNotReady?!(this.client.status&&this.client.status!=="ready"||typeof this.client.isReady=="function"&&!this.client.isReady()):!0}_getRateLimiterRes(e,t,n){let[i,s]=n;Array.isArray(i)&&([,i]=i,[,s]=s);let o=new qM;return o.consumedPoints=parseInt(i),o.isFirstInDuration=o.consumedPoints===t,o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.msBeforeNext=s,o}async _upsert(e,t,n,i=!1){if(!this._isRedisReady())throw new Error("Redis connection is not ready");let s=Math.floor(n/1e3),o=this.client.multi();return i?(s>0?!this.useRedisPackage&&!this.useRedis3AndLowerPackage?o.set(e,t,"EX",s):o.set(e,t,{EX:s}):o.set(e,t),!this.useRedisPackage&&!this.useRedis3AndLowerPackage?o.pttl(e).exec(!0):o.pTTL(e).exec(!0)):s>0?!this.useRedisPackage&&!this.useRedis3AndLowerPackage?this.client.rlflxIncr([e].concat([String(t),String(s)])):this.useRedis3AndLowerPackage?new Promise((a,c)=>{let l=function(u,f){return u?c(u):a(f)};typeof this.client.rlflxIncr=="function"?this.client.rlflxIncr(e,t,s,l):this.client.eval(zm,1,e,t,s,l)}):this.client.eval(zm,{keys:[e],arguments:[String(t),String(s)]}):!this.useRedisPackage&&!this.useRedis3AndLowerPackage?o.incrby(e,t).pttl(e).exec(!0):o.incrBy(e,t).pTTL(e).exec(!0)}async _get(e){if(!this._isRedisReady())throw new Error("Redis connection is not ready");return!this.useRedisPackage&&!this.useRedis3AndLowerPackage?this.client.multi().get(e).pttl(e).exec().then(t=>{let[[,n]]=t;return n===null?null:t}):this.client.multi().get(e).pTTL(e).exec(!0).then(t=>{let[n]=t;return n===null?null:t})}_delete(e){return this.client.del(e).then(t=>t>0)}};bE.exports=$m});var vE=F((Yae,xE)=>{var zM=Ja(),$M=en();function EE(r){try{let e=r.client?r.client:r,{version:t}=e.topology.s.options.metadata.driver,n=t.split(".").map(i=>parseInt(i));return{major:n[0],feature:n[1],patch:n[2]}}catch{return{major:0,feature:0,patch:0}}}var Hm=class r extends zM{constructor(e){super(e),this.dbName=e.dbName,this.tableName=e.tableName,this.indexKeyPrefix=e.indexKeyPrefix,e.mongo?this.client=e.mongo:this.client=e.storeClient,typeof this.client.then=="function"?this.client.then(t=>{this.client=t,this._initCollection(),this._driverVersion=EE(this.client)}):(this._initCollection(),this._driverVersion=EE(this.client))}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?r.getDbName():e}static getDbName(){return"node-rate-limiter-flexible"}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("mongo is not set");this._client=e}get indexKeyPrefix(){return this._indexKeyPrefix}set indexKeyPrefix(e){this._indexKeyPrefix=e||{}}_initCollection(){let t=(typeof this.client.db=="function"?this.client.db(this.dbName):this.client).collection(this.tableName);t.createIndex({expire:-1},{expireAfterSeconds:0}),t.createIndex(Object.assign({},this.indexKeyPrefix,{key:1}),{unique:!0}),this._collection=t}_getRateLimiterRes(e,t,n){let i=new $M,s;return typeof n.value>"u"?s=n:s=n.value,i.isFirstInDuration=s.points===t,i.consumedPoints=s.points,i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.msBeforeNext=s.expire!==null?Math.max(new Date(s.expire).getTime()-Date.now(),0):-1,i}_upsert(e,t,n,i=!1,s={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));let o=s.attrs||{},a,c;i?(a={key:e},a=Object.assign(a,o),c={$set:{key:e,points:t,expire:n>0?new Date(Date.now()+n):null}},c.$set=Object.assign(c.$set,o)):(a={$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}],key:e},a=Object.assign(a,o),c={$setOnInsert:{key:e,expire:n>0?new Date(Date.now()+n):null},$inc:{points:t}},c.$setOnInsert=Object.assign(c.$setOnInsert,o));let l={upsert:!0};return this._driverVersion.major>=4||this._driverVersion.major===3&&this._driverVersion.feature>=7||this._driverVersion.feature>=6&&this._driverVersion.patch>=7?l.returnDocument="after":l.returnOriginal=!1,new Promise((u,f)=>{this._collection.findOneAndUpdate(a,c,l).then(h=>{u(h)}).catch(h=>{if(h&&h.code===11e3){let d=Object.assign({$or:[{expire:{$lte:new Date}},{expire:{$eq:null}}],key:e},o),p={$set:Object.assign({key:e,points:t,expire:n>0?new Date(Date.now()+n):null},o)};this._collection.findOneAndUpdate(d,p,l).then(m=>{u(m)}).catch(m=>{m&&m.code===11e3?this._upsert(e,t,n,i).then(g=>u(g)).catch(g=>f(g)):f(m)})}else f(h)})})}_get(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));let n=t.attrs||{},i=Object.assign({key:e,$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}]},n);return this._collection.findOne(i)}_delete(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));let n=t.attrs||{},i=Object.assign({key:e},n);return this._collection.deleteOne(i).then(s=>s.deletedCount>0)}};xE.exports=Hm});var SE=F((Qae,_E)=>{var HM=Ja(),WM=en(),Wm=class extends HM{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.dbName=e.dbName,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?(this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()):this._createDbAndTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}clearExpired(e){return new Promise(t=>{this._getConnection().then(n=>{n.query("DELETE FROM ??.?? WHERE expire < ?",[this.dbName,this.tableName,e],()=>{this._releaseConnection(n),t()})}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return new Promise((e,t)=>{this.client.getConnection((n,i)=>{if(n)return t(n);e(i)})});case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return e.release();case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);default:return!0}}_createDbAndTable(){return new Promise((e,t)=>{this._getConnection().then(n=>{n.query(`CREATE DATABASE IF NOT EXISTS \`${this.dbName}\`;`,i=>{if(i)return this._releaseConnection(n),t(i);n.query(this._getCreateTableStmt(),s=>{if(s)return this._releaseConnection(n),t(s);this._releaseConnection(n),e()})})}).catch(n=>{t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS \`${this.dbName}\`.\`${this.tableName}\` (\`key\` VARCHAR(255) CHARACTER SET utf8 NOT NULL,\`points\` INT(9) NOT NULL default 0,\`expire\` BIGINT UNSIGNED,PRIMARY KEY (\`key\`)) ENGINE = INNODB;`}get clientType(){return this._clientType}set clientType(e){if(typeof e>"u")if(this.client.constructor.name==="Connection")e="connection";else if(this.client.constructor.name==="Pool")e="pool";else if(this.client.constructor.name==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?"rtlmtrflx":e}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:!!e}_getRateLimiterRes(e,t,n){let i=new WM,[s]=n;return i.isFirstInDuration=t===s.points,i.consumedPoints=i.isFirstInDuration?t:s.points,i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.msBeforeNext=s.expire?Math.max(s.expire-Date.now(),0):-1,i}_upsertTransaction(e,t,n,i,s){return new Promise((o,a)=>{e.query("BEGIN",c=>{if(c)return e.rollback(),a(c);let l=Date.now(),u=i>0?l+i:null,f,h;s?(f=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = ?, 
            expire = ?;`,h=[this.dbName,this.tableName,t,n,u,n,u]):(f=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = IF(expire <= ?, ?, points + (?)), 
            expire = IF(expire <= ?, ?, expire);`,h=[this.dbName,this.tableName,t,n,u,l,n,n,l,u]),e.query(f,h,d=>{if(d)return e.rollback(),a(d);e.query("SELECT points, expire FROM ??.?? WHERE `key` = ?;",[this.dbName,this.tableName,t],(p,m)=>{if(p)return e.rollback(),a(p);e.query("COMMIT",g=>{if(g)return e.rollback(),a(g);o(m)})})})})})}_upsert(e,t,n,i=!1){return this.tableCreated?new Promise((s,o)=>{this._getConnection().then(a=>{this._upsertTransaction(a,e,t,n,i).then(c=>{s(c),this._releaseConnection(a)}).catch(c=>{o(c),this._releaseConnection(a)})}).catch(a=>{o(a)})}):Promise.reject(Error("Table is not created yet"))}_get(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(i=>{i.query("SELECT points, expire FROM ??.?? WHERE `key` = ? AND (`expire` > ? OR `expire` IS NULL)",[this.dbName,this.tableName,e,Date.now()],(s,o)=>{s?n(s):o.length===0?t(null):t(o),this._releaseConnection(i)})}).catch(i=>{n(i)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(i=>{i.query("DELETE FROM ??.?? WHERE `key` = ?",[this.dbName,this.tableName,e],(s,o)=>{s?n(s):t(o.affectedRows>0),this._releaseConnection(i)})}).catch(i=>{n(i)})}):Promise.reject(Error("Table is not created yet"))}};_E.exports=Wm});var IE=F((Xae,RE)=>{var GM=Ja(),YM=en(),Gm=class extends GM{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.tableName=e.tableName,this.schemaName=e.schemaName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?(this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()):this._createTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}_getTableIdentifier(){return this.schemaName?`"${this.schemaName}"."${this.tableName}"`:`"${this.tableName}"`}clearExpired(e){return new Promise(t=>{let n={name:"rlflx-clear-expired",text:`DELETE FROM ${this._getTableIdentifier()} WHERE expire < $1`,values:[e]};this._query(n).then(()=>{t()}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return Promise.resolve(this.client);case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();case"typeorm":return Promise.resolve(this.client.driver.master);default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return!0;case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);case"typeorm":return!0;default:return!0}}_createTable(){return new Promise((e,t)=>{this._query({text:this._getCreateTableStmt()}).then(()=>{e()}).catch(n=>{n.code==="23505"?e():t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS ${this._getTableIdentifier()} (
      key varchar(255) PRIMARY KEY,
      points integer NOT NULL DEFAULT 0,
      expire bigint
    );`}get clientType(){return this._clientType}set clientType(e){let t=this.client.constructor.name;if(typeof e>"u")if(t==="Client")e="client";else if(t==="Pool"||t==="BoundPool")e="pool";else if(t==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get schemaName(){return this._schemaName}set schemaName(e){this._schemaName=e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:!!e}_getRateLimiterRes(e,t,n){let i=new YM,s=n.rows[0];return i.isFirstInDuration=t===s.points,i.consumedPoints=i.isFirstInDuration?t:s.points,i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.msBeforeNext=s.expire?Math.max(s.expire-Date.now(),0):-1,i}_query(e){let n={name:`${this.tableName.toLowerCase()}:${e.name}`,text:e.text,values:e.values};return new Promise((i,s)=>{this._getConnection().then(o=>{o.query(n).then(a=>{i(a),this._releaseConnection(o)}).catch(a=>{s(a),this._releaseConnection(o)})}).catch(o=>{s(o)})})}_upsert(e,t,n,i=!1){if(!this.tableCreated)return Promise.reject(Error("Table is not created yet"));let s=n>0?Date.now()+n:null,o=i?" $3 ":` CASE
             WHEN ${this._getTableIdentifier()}.expire <= $4 THEN $3
             ELSE ${this._getTableIdentifier()}.expire
            END `;return this._query({name:i?"rlflx-upsert-force":"rlflx-upsert",text:`
            INSERT INTO ${this._getTableIdentifier()} VALUES ($1, $2, $3)
              ON CONFLICT(key) DO UPDATE SET
                points = CASE
                          WHEN (${this._getTableIdentifier()}.expire <= $4 OR 1=${i?1:0}) THEN $2
                          ELSE ${this._getTableIdentifier()}.points + ($2)
                         END,
                expire = ${o}
            RETURNING points, expire;`,values:[e,t,s,Date.now()]})}_get(e){return this.tableCreated?new Promise((t,n)=>{this._query({name:"rlflx-get",text:`
            SELECT points, expire FROM ${this._getTableIdentifier()} WHERE key = $1 AND (expire > $2 OR expire IS NULL);`,values:[e,Date.now()]}).then(i=>{i.rowCount===0&&(i=null),t(i)}).catch(i=>{n(i)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?this._query({name:"rlflx-delete",text:`DELETE FROM ${this._getTableIdentifier()} WHERE key = $1`,values:[e]}).then(t=>t.rowCount>0):Promise.reject(Error("Table is not created yet"))}};RE.exports=Gm});var AE=F(()=>{});var DE=F((ece,TE)=>{TE.exports=class{constructor(e,t,n=null){this.value=e,this.expiresAt=t,this.timeoutId=n}get value(){return this._value}set value(e){this._value=parseInt(e)}get expiresAt(){return this._expiresAt}set expiresAt(e){!(e instanceof Date)&&Number.isInteger(e)&&(e=new Date(e)),this._expiresAt=e}get timeoutId(){return this._timeoutId}set timeoutId(e){this._timeoutId=e}}});var PE=F((rce,CE)=>{var QM=DE(),Ym=en();CE.exports=class{constructor(){this._storage={}}incrby(e,t,n){if(this._storage[e]){let i=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return i!==0?(this._storage[e].value=this._storage[e].value+t,new Ym(0,i,this._storage[e].value,!1)):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){let i=n*1e3;return this._storage[e]&&this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),this._storage[e]=new QM(t,i>0?new Date(Date.now()+i):null),i>0&&(this._storage[e].timeoutId=setTimeout(()=>{delete this._storage[e]},i),this._storage[e].timeoutId.unref&&this._storage[e].timeoutId.unref()),new Ym(0,i===0?-1:i,this._storage[e].value,!0)}get(e){if(this._storage[e]){let t=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return new Ym(0,t,this._storage[e].value,!1)}return null}delete(e){return this._storage[e]?(this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),delete this._storage[e],!0):!1}}});var Xm=F((nce,NE)=>{var XM=Ql(),jM=PE(),kE=en(),Qm=class extends XM{constructor(e={}){super(e),this._memoryStorage=new jM}consume(e,t=1,n={}){return new Promise((i,s)=>{let o=this.getKey(e),a=this._getKeySecDuration(n),c=this._memoryStorage.incrby(o,t,a);if(c.remainingPoints=Math.max(this.points-c.consumedPoints,0),c.consumedPoints>this.points)this.blockDuration>0&&c.consumedPoints<=this.points+t&&(c=this._memoryStorage.set(o,c.consumedPoints,this.blockDuration)),s(c);else if(this.execEvenly&&c.msBeforeNext>0&&!c.isFirstInDuration){let l=Math.ceil(c.msBeforeNext/(c.remainingPoints+2));l<this.execEvenlyMinDelayMs&&(l=c.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(i,l,c)}else i(c)})}penalty(e,t=1,n={}){let i=this.getKey(e);return new Promise(s=>{let o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(i,t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),s(a)})}reward(e,t=1,n={}){let i=this.getKey(e);return new Promise(s=>{let o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(i,-t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),s(a)})}block(e,t){let n=t*1e3,i=this.points+1;return this._memoryStorage.set(this.getKey(e),i,t),Promise.resolve(new kE(0,n===0?-1:n,i))}set(e,t,n){let i=(n>=0?n:this.duration)*1e3;return this._memoryStorage.set(this.getKey(e),t,n),Promise.resolve(new kE(0,i===0?-1:i,t))}get(e){let t=this._memoryStorage.get(this.getKey(e));return t!==null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),Promise.resolve(t)}delete(e){return Promise.resolve(this._memoryStorage.delete(this.getKey(e)))}};NE.exports=Qm});var KE=F((ice,FE)=>{var OE=AE(),ZM=xl(),JM=Ql(),BE=Xm(),eU=en(),In="rate_limiter_flexible",rc=null,LE=function(r,e,t,n){let i;n===null||n===!0||n===!1?i=n:i={remainingPoints:n.remainingPoints,msBeforeNext:n.msBeforeNext,consumedPoints:n.consumedPoints,isFirstInDuration:n.isFirstInDuration},r.send({channel:In,keyPrefix:e.keyPrefix,promiseId:e.promiseId,type:t,data:i})},ME=function(r){setTimeout(()=>{this._initiated?process.send(r):typeof this._promises[r.promiseId]<"u"&&ME.call(this,r)},30)},ec=function(r,e,t,n,i){let s={channel:In,keyPrefix:this.keyPrefix,func:r,promiseId:e,data:{key:t,arg:n,opts:i}};this._initiated?process.send(s):ME.call(this,s)},UE=function(r,e){if(!e||e.channel!==In||typeof this._rateLimiters[e.keyPrefix]>"u")return!1;let t;switch(e.func){case"consume":t=this._rateLimiters[e.keyPrefix].consume(e.data.key,e.data.arg,e.data.opts);break;case"penalty":t=this._rateLimiters[e.keyPrefix].penalty(e.data.key,e.data.arg,e.data.opts);break;case"reward":t=this._rateLimiters[e.keyPrefix].reward(e.data.key,e.data.arg,e.data.opts);break;case"block":t=this._rateLimiters[e.keyPrefix].block(e.data.key,e.data.arg,e.data.opts);break;case"get":t=this._rateLimiters[e.keyPrefix].get(e.data.key,e.data.opts);break;case"delete":t=this._rateLimiters[e.keyPrefix].delete(e.data.key,e.data.opts);break;default:return!1}t&&t.then(n=>{LE(r,e,"resolve",n)}).catch(n=>{LE(r,e,"reject",n)})},tU=function(r){if(!r||r.channel!==In||r.keyPrefix!==this.keyPrefix)return!1;if(this._promises[r.promiseId]){clearTimeout(this._promises[r.promiseId].timeoutId);let e;switch(r.data===null||r.data===!0||r.data===!1?e=r.data:e=new eU(r.data.remainingPoints,r.data.msBeforeNext,r.data.consumedPoints,r.data.isFirstInDuration),r.type){case"resolve":this._promises[r.promiseId].resolve(e);break;case"reject":this._promises[r.promiseId].reject(e);break;default:throw new Error(`RateLimiterCluster: no such message type '${r.type}'`)}delete this._promises[r.promiseId]}},rU=function(){return{points:this.points,duration:this.duration,blockDuration:this.blockDuration,execEvenly:this.execEvenly,execEvenlyMinDelayMs:this.execEvenlyMinDelayMs,keyPrefix:this.keyPrefix}},tc=function(r,e){let t=process.hrtime(),n=t[0].toString()+t[1].toString();return typeof this._promises[n]<"u"&&(n+=ZM.randomBytes(12).toString("base64")),this._promises[n]={resolve:r,reject:e,timeoutId:setTimeout(()=>{delete this._promises[n],e(new Error("RateLimiterCluster timeout: no answer from master in time"))},this.timeoutMs)},n},jm=class{constructor(){if(rc)return rc;this._rateLimiters={},OE.setMaxListeners(0),OE.on("message",(e,t)=>{t&&t.channel===In&&t.type==="init"?(typeof this._rateLimiters[t.opts.keyPrefix]>"u"&&(this._rateLimiters[t.opts.keyPrefix]=new BE(t.opts)),e.send({channel:In,type:"init",keyPrefix:t.opts.keyPrefix})):UE.call(this,e,t)}),rc=this}},Zm=class{constructor(e){if(rc)return rc;this._rateLimiters={},e.launchBus((t,n)=>{n.on("process:msg",i=>{let s=i.raw;if(s&&s.channel===In&&s.type==="init")typeof this._rateLimiters[s.opts.keyPrefix]>"u"&&(this._rateLimiters[s.opts.keyPrefix]=new BE(s.opts)),e.sendDataToProcessId(i.process.pm_id,{data:{},topic:In,channel:In,type:"init",keyPrefix:s.opts.keyPrefix},(o,a)=>{o&&console.log(o,a)});else{let o={send:a=>{let c=a;c.topic=In,typeof c.data>"u"&&(c.data={}),e.sendDataToProcessId(i.process.pm_id,c,(l,u)=>{l&&console.log(l,u)})}};UE.call(this,o,s)}})}),rc=this}},Jm=class extends JM{get timeoutMs(){return this._timeoutMs}set timeoutMs(e){this._timeoutMs=typeof e>"u"?5e3:Math.abs(parseInt(e))}constructor(e={}){super(e),process.setMaxListeners(0),this.timeoutMs=e.timeoutMs,this._initiated=!1,process.on("message",t=>{t&&t.channel===In&&t.type==="init"&&t.keyPrefix===this.keyPrefix?this._initiated=!0:tU.call(this,t)}),process.send({channel:In,type:"init",opts:rU.call(this)}),this._promises={}}consume(e,t=1,n={}){return new Promise((i,s)=>{let o=tc.call(this,i,s);ec.call(this,"consume",o,e,t,n)})}penalty(e,t=1,n={}){return new Promise((i,s)=>{let o=tc.call(this,i,s);ec.call(this,"penalty",o,e,t,n)})}reward(e,t=1,n={}){return new Promise((i,s)=>{let o=tc.call(this,i,s);ec.call(this,"reward",o,e,t,n)})}block(e,t,n={}){return new Promise((i,s)=>{let o=tc.call(this,i,s);ec.call(this,"block",o,e,t,n)})}get(e,t={}){return new Promise((n,i)=>{let s=tc.call(this,n,i);ec.call(this,"get",s,e,t)})}delete(e,t={}){return new Promise((n,i)=>{let s=tc.call(this,n,i);ec.call(this,"delete",s,e,t)})}};FE.exports={RateLimiterClusterMaster:jm,RateLimiterClusterMasterPM2:Zm,RateLimiterCluster:Jm}});var qE=F((sce,VE)=>{var nU=Ja(),iU=en(),e3=class extends nU{constructor(e){super(e),this.client=e.storeClient}_getRateLimiterRes(e,t,n){let i=new iU;return i.consumedPoints=parseInt(n.consumedPoints),i.isFirstInDuration=n.consumedPoints===t,i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.msBeforeNext=n.msBeforeNext,i}_upsert(e,t,n,i=!1,s={}){return new Promise((o,a)=>{let c=Date.now(),l=Math.floor(n/1e3);i?this.client.set(e,t,l,u=>{u?a(u):this.client.set(`${e}_expire`,l>0?c+l*1e3:-1,l,()=>{let f={consumedPoints:t,msBeforeNext:l>0?l*1e3:-1};o(f)})}):this.client.incr(e,t,(u,f)=>{u||f===!1?this.client.add(e,t,l,(h,d)=>{if(h||!d)if(typeof s.attemptNumber>"u"||s.attemptNumber<3){let p=Object.assign({},s);p.attemptNumber=p.attemptNumber?p.attemptNumber+1:1,this._upsert(e,t,n,i,p).then(m=>o(m)).catch(m=>a(m))}else a(new Error("Can not add key"));else this.client.add(`${e}_expire`,l>0?c+l*1e3:-1,l,()=>{let p={consumedPoints:t,msBeforeNext:l>0?l*1e3:-1};o(p)})}):this.client.get(`${e}_expire`,(h,d)=>{if(h)a(h);else{let p=d===!1?0:d,m={consumedPoints:f,msBeforeNext:p>=0?Math.max(p-c,0):-1};o(m)}})})})}_get(e){return new Promise((t,n)=>{let i=Date.now();this.client.get(e,(s,o)=>{o?this.client.get(`${e}_expire`,(a,c)=>{if(a)n(a);else{let l=c===!1?0:c,u={consumedPoints:o,msBeforeNext:l>=0?Math.max(l-i,0):-1};t(u)}}):t(null)})})}_delete(e){return new Promise((t,n)=>{this.client.del(e,(i,s)=>{i?n(i):s===!1?t(s):this.client.del(`${e}_expire`,o=>{o?n(o):t(s)})})})}};VE.exports=e3});var HE=F((ace,$E)=>{var zE=en();$E.exports=class{constructor(e={}){this.limiter=e.limiter,this.blackList=e.blackList,this.whiteList=e.whiteList,this.isBlackListed=e.isBlackListed,this.isWhiteListed=e.isWhiteListed,this.runActionAnyway=e.runActionAnyway}get limiter(){return this._limiter}set limiter(e){if(typeof e>"u")throw new Error("limiter is not set");this._limiter=e}get runActionAnyway(){return this._runActionAnyway}set runActionAnyway(e){this._runActionAnyway=typeof e>"u"?!1:e}get blackList(){return this._blackList}set blackList(e){this._blackList=Array.isArray(e)?e:[]}get isBlackListed(){return this._isBlackListed}set isBlackListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isBlackListed must be function");this._isBlackListed=e}get whiteList(){return this._whiteList}set whiteList(e){this._whiteList=Array.isArray(e)?e:[]}get isWhiteListed(){return this._isWhiteListed}set isWhiteListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isWhiteListed must be function");this._isWhiteListed=e}isBlackListedSomewhere(e){return this.blackList.indexOf(e)>=0||this.isBlackListed(e)}isWhiteListedSomewhere(e){return this.whiteList.indexOf(e)>=0||this.isWhiteListed(e)}getBlackRes(){return new zE(0,Number.MAX_SAFE_INTEGER,0,!1)}getWhiteRes(){return new zE(Number.MAX_SAFE_INTEGER,0,0,!1)}rejectBlack(){return Promise.reject(this.getBlackRes())}resolveBlack(){return Promise.resolve(this.getBlackRes())}resolveWhite(){return Promise.resolve(this.getWhiteRes())}consume(e,t=1){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.rejectBlack()),typeof n>"u"?this.limiter.consume(e,t):(this.runActionAnyway&&this.limiter.consume(e,t).catch(()=>{}),n)}block(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.block(e,t):(this.runActionAnyway&&this.limiter.block(e,t).catch(()=>{}),n)}penalty(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.penalty(e,t):(this.runActionAnyway&&this.limiter.penalty(e,t).catch(()=>{}),n)}reward(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.reward(e,t):(this.runActionAnyway&&this.limiter.reward(e,t).catch(()=>{}),n)}get(e){let t;return this.isWhiteListedSomewhere(e)?t=this.resolveWhite():this.isBlackListedSomewhere(e)&&(t=this.resolveBlack()),typeof t>"u"||this.runActionAnyway?this.limiter.get(e):t}delete(e){return this.limiter.delete(e)}}});var GE=F((lce,WE)=>{var sU=Ql();WE.exports=class{constructor(...e){if(e.length<1)throw new Error("RateLimiterUnion: at least one limiter have to be passed");e.forEach(t=>{if(!(t instanceof sU))throw new Error("RateLimiterUnion: all limiters have to be instance of RateLimiterAbstract")}),this._limiters=e}consume(e,t=1){return new Promise((n,i)=>{let s=[];this._limiters.forEach(o=>{s.push(o.consume(e,t).catch(a=>({rejected:!0,rej:a})))}),Promise.all(s).then(o=>{let a={},c=!1;o.forEach(l=>{l.rejected===!0&&(c=!0)});for(let l=0;l<o.length;l++)c&&o[l].rejected===!0?a[this._limiters[l].keyPrefix]=o[l].rej:c||(a[this._limiters[l].keyPrefix]=o[l]);c?i(a):n(a)})})}}});var QE=F((fce,YE)=>{YE.exports=class extends Error{constructor(e,t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="CustomError",this.message=e,t&&(this.extra=t)}}});var JE=F((dce,ZE)=>{var XE=QE(),jE=4294967295,t3="limiter";ZE.exports=class{constructor(e,t={maxQueueSize:jE}){this._queueLimiters={KEY_DEFAULT:new oh(e,t)},this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(e=t3){return this._queueLimiters[e]?this._queueLimiters[e].getTokensRemaining():Promise.resolve(this._limiterFlexible.points)}removeTokens(e,t=t3){return this._queueLimiters[t]||(this._queueLimiters[t]=new oh(this._limiterFlexible,{key:t,maxQueueSize:this._maxQueueSize})),this._queueLimiters[t].removeTokens(e)}};var oh=class{constructor(e,t={maxQueueSize:jE,key:t3}){this._key=t.key,this._waitTimeout=null,this._queue=[],this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(){return this._limiterFlexible.get(this._key).then(e=>e!==null?e.remainingPoints:this._limiterFlexible.points)}removeTokens(e){let t=this;return new Promise((n,i)=>{if(e>t._limiterFlexible.points){i(new XE(`Requested tokens ${e} exceeds maximum ${t._limiterFlexible.points} tokens per interval`));return}t._queue.length>0?t._queueRequest.call(t,n,i,e):t._limiterFlexible.consume(t._key,e).then(s=>{n(s.remainingPoints)}).catch(s=>{s instanceof Error?i(s):(t._queueRequest.call(t,n,i,e),t._waitTimeout===null&&(t._waitTimeout=setTimeout(t._processFIFO.bind(t),s.msBeforeNext)))})})}_queueRequest(e,t,n){let i=this;i._queue.length<i._maxQueueSize?i._queue.push({resolve:e,reject:t,tokens:n}):t(new XE(`Number of requests reached it's maximum ${i._maxQueueSize}`))}_processFIFO(){let e=this;if(e._waitTimeout!==null&&(clearTimeout(e._waitTimeout),e._waitTimeout=null),e._queue.length===0)return;let t=e._queue.shift();e._limiterFlexible.consume(e._key,t.tokens).then(n=>{t.resolve(n.remainingPoints),e._processFIFO.call(e)}).catch(n=>{n instanceof Error?(t.reject(n),e._processFIFO.call(e)):(e._queue.unshift(t),e._waitTimeout===null&&(e._waitTimeout=setTimeout(e._processFIFO.bind(e),n.msBeforeNext)))})}}});var tx=F((mce,ex)=>{var r3=en();ex.exports=class{constructor(e,t){this._rateLimiter=e,this._burstLimiter=t}_combineRes(e,t){return e?new r3(e.remainingPoints,Math.min(e.msBeforeNext,t?t.msBeforeNext:0),e.consumedPoints,e.isFirstInDuration):null}consume(e,t=1,n={}){return this._rateLimiter.consume(e,t,n).catch(i=>i instanceof r3?this._burstLimiter.consume(e,t,n).then(s=>Promise.resolve(this._combineRes(i,s))).catch(s=>s instanceof r3?Promise.reject(this._combineRes(i,s)):Promise.reject(s)):Promise.reject(i))}get(e){return Promise.all([this._rateLimiter.get(e),this._burstLimiter.get(e)]).then(([t,n])=>this._combineRes(t,n))}get points(){return this._rateLimiter.points}}});var n3=F((gce,rx)=>{var oU=wE(),aU=vE(),cU=SE(),lU=IE(),{RateLimiterClusterMaster:uU,RateLimiterClusterMasterPM2:fU,RateLimiterCluster:hU}=KE(),dU=Xm(),pU=qE(),mU=HE(),gU=GE(),yU=JE(),bU=tx(),wU=en();rx.exports={RateLimiterRedis:oU,RateLimiterMongo:aU,RateLimiterMySQL:cU,RateLimiterPostgres:lU,RateLimiterMemory:dU,RateLimiterMemcache:pU,RateLimiterClusterMaster:uU,RateLimiterClusterMasterPM2:fU,RateLimiterCluster:hU,RLWrapperBlackAndWhite:mU,RateLimiterUnion:gU,RateLimiterQueue:yU,BurstyRateLimiter:bU,RateLimiterRes:wU}});var bx=F((N0e,yx)=>{"use strict";yx.exports=qU;function qU(r,e){for(var t=new Array(arguments.length-1),n=0,i=2,s=!0;i<arguments.length;)t[n++]=arguments[i++];return new Promise(function(a,c){t[n]=function(u){if(s)if(s=!1,u)c(u);else{for(var f=new Array(arguments.length-1),h=0;h<f.length;)f[h++]=arguments[h];a.apply(null,f)}};try{r.apply(e||null,t)}catch(l){s&&(s=!1,c(l))}})}});var vx=F(xx=>{"use strict";var Sh=xx;Sh.length=function(e){var t=e.length;if(!t)return 0;for(var n=0;--t%4>1&&e.charAt(t)==="=";)++n;return Math.ceil(e.length*3)/4-n};var oc=new Array(64),Ex=new Array(123);for(jn=0;jn<64;)Ex[oc[jn]=jn<26?jn+65:jn<52?jn+71:jn<62?jn-4:jn-59|43]=jn++;var jn;Sh.encode=function(e,t,n){for(var i=null,s=[],o=0,a=0,c;t<n;){var l=e[t++];switch(a){case 0:s[o++]=oc[l>>2],c=(l&3)<<4,a=1;break;case 1:s[o++]=oc[c|l>>4],c=(l&15)<<2,a=2;break;case 2:s[o++]=oc[c|l>>6],s[o++]=oc[l&63],a=0;break}o>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,s)),o=0)}return a&&(s[o++]=oc[c],s[o++]=61,a===1&&(s[o++]=61)),i?(o&&i.push(String.fromCharCode.apply(String,s.slice(0,o))),i.join("")):String.fromCharCode.apply(String,s.slice(0,o))};var wx="invalid encoding";Sh.decode=function(e,t,n){for(var i=n,s=0,o,a=0;a<e.length;){var c=e.charCodeAt(a++);if(c===61&&s>1)break;if((c=Ex[c])===void 0)throw Error(wx);switch(s){case 0:o=c,s=1;break;case 1:t[n++]=o<<2|(c&48)>>4,o=c,s=2;break;case 2:t[n++]=(o&15)<<4|(c&60)>>2,o=c,s=3;break;case 3:t[n++]=(o&3)<<6|c,s=0;break}}if(s===1)throw Error(wx);return n-i};Sh.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}});var Sx=F((L0e,_x)=>{"use strict";_x.exports=Rh;function Rh(){this._listeners={}}Rh.prototype.on=function(e,t,n){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:n||this}),this};Rh.prototype.off=function(e,t){if(e===void 0)this._listeners={};else if(t===void 0)this._listeners[e]=[];else for(var n=this._listeners[e],i=0;i<n.length;)n[i].fn===t?n.splice(i,1):++i;return this};Rh.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var n=[],i=1;i<arguments.length;)n.push(arguments[i++]);for(i=0;i<t.length;)t[i].fn.apply(t[i++].ctx,n)}return this}});var Px=F((B0e,Cx)=>{"use strict";Cx.exports=Rx(Rx);function Rx(r){return typeof Float32Array<"u"?function(){var e=new Float32Array([-0]),t=new Uint8Array(e.buffer),n=t[3]===128;function i(c,l,u){e[0]=c,l[u]=t[0],l[u+1]=t[1],l[u+2]=t[2],l[u+3]=t[3]}function s(c,l,u){e[0]=c,l[u]=t[3],l[u+1]=t[2],l[u+2]=t[1],l[u+3]=t[0]}r.writeFloatLE=n?i:s,r.writeFloatBE=n?s:i;function o(c,l){return t[0]=c[l],t[1]=c[l+1],t[2]=c[l+2],t[3]=c[l+3],e[0]}function a(c,l){return t[3]=c[l],t[2]=c[l+1],t[1]=c[l+2],t[0]=c[l+3],e[0]}r.readFloatLE=n?o:a,r.readFloatBE=n?a:o}():function(){function e(n,i,s,o){var a=i<0?1:0;if(a&&(i=-i),i===0)n(1/i>0?0:2147483648,s,o);else if(isNaN(i))n(2143289344,s,o);else if(i>34028234663852886e22)n((a<<31|2139095040)>>>0,s,o);else if(i<11754943508222875e-54)n((a<<31|Math.round(i/1401298464324817e-60))>>>0,s,o);else{var c=Math.floor(Math.log(i)/Math.LN2),l=Math.round(i*Math.pow(2,-c)*8388608)&8388607;n((a<<31|c+127<<23|l)>>>0,s,o)}}r.writeFloatLE=e.bind(null,Ix),r.writeFloatBE=e.bind(null,Ax);function t(n,i,s){var o=n(i,s),a=(o>>31)*2+1,c=o>>>23&255,l=o&8388607;return c===255?l?NaN:a*(1/0):c===0?a*1401298464324817e-60*l:a*Math.pow(2,c-150)*(l+8388608)}r.readFloatLE=t.bind(null,Tx),r.readFloatBE=t.bind(null,Dx)}(),typeof Float64Array<"u"?function(){var e=new Float64Array([-0]),t=new Uint8Array(e.buffer),n=t[7]===128;function i(c,l,u){e[0]=c,l[u]=t[0],l[u+1]=t[1],l[u+2]=t[2],l[u+3]=t[3],l[u+4]=t[4],l[u+5]=t[5],l[u+6]=t[6],l[u+7]=t[7]}function s(c,l,u){e[0]=c,l[u]=t[7],l[u+1]=t[6],l[u+2]=t[5],l[u+3]=t[4],l[u+4]=t[3],l[u+5]=t[2],l[u+6]=t[1],l[u+7]=t[0]}r.writeDoubleLE=n?i:s,r.writeDoubleBE=n?s:i;function o(c,l){return t[0]=c[l],t[1]=c[l+1],t[2]=c[l+2],t[3]=c[l+3],t[4]=c[l+4],t[5]=c[l+5],t[6]=c[l+6],t[7]=c[l+7],e[0]}function a(c,l){return t[7]=c[l],t[6]=c[l+1],t[5]=c[l+2],t[4]=c[l+3],t[3]=c[l+4],t[2]=c[l+5],t[1]=c[l+6],t[0]=c[l+7],e[0]}r.readDoubleLE=n?o:a,r.readDoubleBE=n?a:o}():function(){function e(n,i,s,o,a,c){var l=o<0?1:0;if(l&&(o=-o),o===0)n(0,a,c+i),n(1/o>0?0:2147483648,a,c+s);else if(isNaN(o))n(0,a,c+i),n(2146959360,a,c+s);else if(o>17976931348623157e292)n(0,a,c+i),n((l<<31|2146435072)>>>0,a,c+s);else{var u;if(o<22250738585072014e-324)u=o/5e-324,n(u>>>0,a,c+i),n((l<<31|u/4294967296)>>>0,a,c+s);else{var f=Math.floor(Math.log(o)/Math.LN2);f===1024&&(f=1023),u=o*Math.pow(2,-f),n(u*4503599627370496>>>0,a,c+i),n((l<<31|f+1023<<20|u*1048576&1048575)>>>0,a,c+s)}}}r.writeDoubleLE=e.bind(null,Ix,0,4),r.writeDoubleBE=e.bind(null,Ax,4,0);function t(n,i,s,o,a){var c=n(o,a+i),l=n(o,a+s),u=(l>>31)*2+1,f=l>>>20&2047,h=4294967296*(l&1048575)+c;return f===2047?h?NaN:u*(1/0):f===0?u*5e-324*h:u*Math.pow(2,f-1075)*(h+4503599627370496)}r.readDoubleLE=t.bind(null,Tx,0,4),r.readDoubleBE=t.bind(null,Dx,4,0)}(),r}function Ix(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function Ax(r,e,t){e[t]=r>>>24,e[t+1]=r>>>16&255,e[t+2]=r>>>8&255,e[t+3]=r&255}function Tx(r,e){return(r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24)>>>0}function Dx(r,e){return(r[e]<<24|r[e+1]<<16|r[e+2]<<8|r[e+3])>>>0}});var kx=F((exports,module)=>{"use strict";module.exports=inquire;function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(r){}return null}});var Ox=F(Nx=>{"use strict";var b3=Nx;b3.length=function(e){for(var t=0,n=0,i=0;i<e.length;++i)n=e.charCodeAt(i),n<128?t+=1:n<2048?t+=2:(n&64512)===55296&&(e.charCodeAt(i+1)&64512)===56320?(++i,t+=4):t+=3;return t};b3.read=function(e,t,n){var i=n-t;if(i<1)return"";for(var s=null,o=[],a=0,c;t<n;)c=e[t++],c<128?o[a++]=c:c>191&&c<224?o[a++]=(c&31)<<6|e[t++]&63:c>239&&c<365?(c=((c&7)<<18|(e[t++]&63)<<12|(e[t++]&63)<<6|e[t++]&63)-65536,o[a++]=55296+(c>>10),o[a++]=56320+(c&1023)):o[a++]=(c&15)<<12|(e[t++]&63)<<6|e[t++]&63,a>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,o)),a=0);return s?(a&&s.push(String.fromCharCode.apply(String,o.slice(0,a))),s.join("")):String.fromCharCode.apply(String,o.slice(0,a))};b3.write=function(e,t,n){for(var i=n,s,o,a=0;a<e.length;++a)s=e.charCodeAt(a),s<128?t[n++]=s:s<2048?(t[n++]=s>>6|192,t[n++]=s&63|128):(s&64512)===55296&&((o=e.charCodeAt(a+1))&64512)===56320?(s=65536+((s&1023)<<10)+(o&1023),++a,t[n++]=s>>18|240,t[n++]=s>>12&63|128,t[n++]=s>>6&63|128,t[n++]=s&63|128):(t[n++]=s>>12|224,t[n++]=s>>6&63|128,t[n++]=s&63|128);return n-i}});var Bx=F((U0e,Lx)=>{"use strict";Lx.exports=zU;function zU(r,e,t){var n=t||8192,i=n>>>1,s=null,o=n;return function(c){if(c<1||c>i)return r(c);o+c>n&&(s=r(n),o=0);var l=e.call(s,o,o+=c);return o&7&&(o=(o|7)+1),l}}});var Ux=F((F0e,Mx)=>{"use strict";Mx.exports=Jt;var iu=Ms();function Jt(r,e){this.lo=r>>>0,this.hi=e>>>0}var $o=Jt.zero=new Jt(0,0);$o.toNumber=function(){return 0};$o.zzEncode=$o.zzDecode=function(){return this};$o.length=function(){return 1};var $U=Jt.zeroHash="\0\0\0\0\0\0\0\0";Jt.fromNumber=function(e){if(e===0)return $o;var t=e<0;t&&(e=-e);var n=e>>>0,i=(e-n)/4294967296>>>0;return t&&(i=~i>>>0,n=~n>>>0,++n>4294967295&&(n=0,++i>4294967295&&(i=0))),new Jt(n,i)};Jt.from=function(e){if(typeof e=="number")return Jt.fromNumber(e);if(iu.isString(e))if(iu.Long)e=iu.Long.fromString(e);else return Jt.fromNumber(parseInt(e,10));return e.low||e.high?new Jt(e.low>>>0,e.high>>>0):$o};Jt.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=~this.lo+1>>>0,n=~this.hi>>>0;return t||(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296};Jt.prototype.toLong=function(e){return iu.Long?new iu.Long(this.lo|0,this.hi|0,!!e):{low:this.lo|0,high:this.hi|0,unsigned:!!e}};var Bs=String.prototype.charCodeAt;Jt.fromHash=function(e){return e===$U?$o:new Jt((Bs.call(e,0)|Bs.call(e,1)<<8|Bs.call(e,2)<<16|Bs.call(e,3)<<24)>>>0,(Bs.call(e,4)|Bs.call(e,5)<<8|Bs.call(e,6)<<16|Bs.call(e,7)<<24)>>>0)};Jt.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)};Jt.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this};Jt.prototype.zzDecode=function(){var e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this};Jt.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}});var Ms=F(w3=>{"use strict";var oe=w3;oe.asPromise=bx();oe.base64=vx();oe.EventEmitter=Sx();oe.float=Px();oe.inquire=kx();oe.utf8=Ox();oe.pool=Bx();oe.LongBits=Ux();oe.isNode=!!(typeof globalThis<"u"&&globalThis&&globalThis.process&&globalThis.process.versions&&globalThis.process.versions.node);oe.global=oe.isNode&&globalThis||typeof window<"u"&&window||typeof self<"u"&&self||w3;oe.emptyArray=Object.freeze?Object.freeze([]):[];oe.emptyObject=Object.freeze?Object.freeze({}):{};oe.isInteger=Number.isInteger||function(e){return typeof e=="number"&&isFinite(e)&&Math.floor(e)===e};oe.isString=function(e){return typeof e=="string"||e instanceof String};oe.isObject=function(e){return e&&typeof e=="object"};oe.isset=oe.isSet=function(e,t){var n=e[t];return n!=null&&e.hasOwnProperty(t)?typeof n!="object"||(Array.isArray(n)?n.length:Object.keys(n).length)>0:!1};oe.Buffer=function(){try{var r=oe.inquire("buffer").Buffer;return r.prototype.utf8Write?r:null}catch{return null}}();oe._Buffer_from=null;oe._Buffer_allocUnsafe=null;oe.newBuffer=function(e){return typeof e=="number"?oe.Buffer?oe._Buffer_allocUnsafe(e):new oe.Array(e):oe.Buffer?oe._Buffer_from(e):typeof Uint8Array>"u"?e:new Uint8Array(e)};oe.Array=typeof Uint8Array<"u"?Uint8Array:Array;oe.Long=oe.global.dcodeIO&&oe.global.dcodeIO.Long||oe.global.Long||oe.inquire("long");oe.key2Re=/^true|false|0|1$/;oe.key32Re=/^-?(?:0|[1-9][0-9]*)$/;oe.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/;oe.longToHash=function(e){return e?oe.LongBits.from(e).toHash():oe.LongBits.zeroHash};oe.longFromHash=function(e,t){var n=oe.LongBits.fromHash(e);return oe.Long?oe.Long.fromBits(n.lo,n.hi,t):n.toNumber(!!t)};function Fx(r,e,t){for(var n=Object.keys(e),i=0;i<n.length;++i)(r[n[i]]===void 0||!t)&&(r[n[i]]=e[n[i]]);return r}oe.merge=Fx;oe.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)};function Kx(r){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:new Error().stack||""}),n&&Fx(this,n)}return e.prototype=Object.create(Error.prototype,{constructor:{value:e,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return r},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),e}oe.newError=Kx;oe.ProtocolError=Kx("ProtocolError");oe.oneOfGetter=function(e){for(var t={},n=0;n<e.length;++n)t[e[n]]=1;return function(){for(var i=Object.keys(this),s=i.length-1;s>-1;--s)if(t[i[s]]===1&&this[i[s]]!==void 0&&this[i[s]]!==null)return i[s]}};oe.oneOfSetter=function(e){return function(t){for(var n=0;n<e.length;++n)e[n]!==t&&delete this[e[n]]}};oe.toJSONOptions={longs:String,enums:String,bytes:String,json:!0};oe._configure=function(){var r=oe.Buffer;if(!r){oe._Buffer_from=oe._Buffer_allocUnsafe=null;return}oe._Buffer_from=r.from!==Uint8Array.from&&r.from||function(t,n){return new r(t,n)},oe._Buffer_allocUnsafe=r.allocUnsafe||function(t){return new r(t)}}});var I3=F((V0e,$x)=>{"use strict";$x.exports=Ke;var An=Ms(),E3,Ih=An.LongBits,Vx=An.base64,qx=An.utf8;function su(r,e,t){this.fn=r,this.len=e,this.next=void 0,this.val=t}function v3(){}function HU(r){this.head=r.head,this.tail=r.tail,this.len=r.len,this.next=r.states}function Ke(){this.len=0,this.head=new su(v3,0,0),this.tail=this.head,this.states=null}var zx=function(){return An.Buffer?function(){return(Ke.create=function(){return new E3})()}:function(){return new Ke}};Ke.create=zx();Ke.alloc=function(e){return new An.Array(e)};An.Array!==Array&&(Ke.alloc=An.pool(Ke.alloc,An.Array.prototype.subarray));Ke.prototype._push=function(e,t,n){return this.tail=this.tail.next=new su(e,t,n),this.len+=t,this};function _3(r,e,t){e[t]=r&255}function WU(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}function S3(r,e){this.len=r,this.next=void 0,this.val=e}S3.prototype=Object.create(su.prototype);S3.prototype.fn=WU;Ke.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new S3((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this};Ke.prototype.int32=function(e){return e<0?this._push(R3,10,Ih.fromNumber(e)):this.uint32(e)};Ke.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)};function R3(r,e,t){for(;r.hi;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}Ke.prototype.uint64=function(e){var t=Ih.from(e);return this._push(R3,t.length(),t)};Ke.prototype.int64=Ke.prototype.uint64;Ke.prototype.sint64=function(e){var t=Ih.from(e).zzEncode();return this._push(R3,t.length(),t)};Ke.prototype.bool=function(e){return this._push(_3,1,e?1:0)};function x3(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}Ke.prototype.fixed32=function(e){return this._push(x3,4,e>>>0)};Ke.prototype.sfixed32=Ke.prototype.fixed32;Ke.prototype.fixed64=function(e){var t=Ih.from(e);return this._push(x3,4,t.lo)._push(x3,4,t.hi)};Ke.prototype.sfixed64=Ke.prototype.fixed64;Ke.prototype.float=function(e){return this._push(An.float.writeFloatLE,4,e)};Ke.prototype.double=function(e){return this._push(An.float.writeDoubleLE,8,e)};var GU=An.Array.prototype.set?function(e,t,n){t.set(e,n)}:function(e,t,n){for(var i=0;i<e.length;++i)t[n+i]=e[i]};Ke.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(_3,1,0);if(An.isString(e)){var n=Ke.alloc(t=Vx.length(e));Vx.decode(e,n,0),e=n}return this.uint32(t)._push(GU,t,e)};Ke.prototype.string=function(e){var t=qx.length(e);return t?this.uint32(t)._push(qx.write,t,e):this._push(_3,1,0)};Ke.prototype.fork=function(){return this.states=new HU(this),this.head=this.tail=new su(v3,0,0),this.len=0,this};Ke.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new su(v3,0,0),this.len=0),this};Ke.prototype.ldelim=function(){var e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=e.next,this.tail=t,this.len+=n),this};Ke.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),n=0;e;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t};Ke._configure=function(r){E3=r,Ke.create=zx(),E3._configure()}});var Gx=F((q0e,Wx)=>{"use strict";Wx.exports=xi;var Hx=I3();(xi.prototype=Object.create(Hx.prototype)).constructor=xi;var Us=Ms();function xi(){Hx.call(this)}xi._configure=function(){xi.alloc=Us._Buffer_allocUnsafe,xi.writeBytesBuffer=Us.Buffer&&Us.Buffer.prototype instanceof Uint8Array&&Us.Buffer.prototype.set.name==="set"?function(e,t,n){t.set(e,n)}:function(e,t,n){if(e.copy)e.copy(t,n,0,e.length);else for(var i=0;i<e.length;)t[n++]=e[i++]}};xi.prototype.bytes=function(e){Us.isString(e)&&(e=Us._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(xi.writeBytesBuffer,t,e),this};function YU(r,e,t){r.length<40?Us.utf8.write(r,e,t):e.utf8Write?e.utf8Write(r,t):e.write(r,t)}xi.prototype.string=function(e){var t=Us.Buffer.byteLength(e);return this.uint32(t),t&&this._push(YU,t,e),this};xi._configure()});var D3=F((z0e,Zx)=>{"use strict";Zx.exports=Pt;var Zn=Ms(),T3,Xx=Zn.LongBits,QU=Zn.utf8;function Jn(r,e){return RangeError("index out of range: "+r.pos+" + "+(e||1)+" > "+r.len)}function Pt(r){this.buf=r,this.pos=0,this.len=r.length}var Yx=typeof Uint8Array<"u"?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new Pt(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new Pt(e);throw Error("illegal buffer")},jx=function(){return Zn.Buffer?function(t){return(Pt.create=function(i){return Zn.Buffer.isBuffer(i)?new T3(i):Yx(i)})(t)}:Yx};Pt.create=jx();Pt.prototype._slice=Zn.Array.prototype.subarray||Zn.Array.prototype.slice;Pt.prototype.uint32=function(){var e=4294967295;return function(){if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Jn(this,10);return e}}();Pt.prototype.int32=function(){return this.uint32()|0};Pt.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(e&1)|0};function A3(){var r=new Xx(0,0),e=0;if(this.len-this.pos>4){for(;e<4;++e)if(r.lo=(r.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return r;if(r.lo=(r.lo|(this.buf[this.pos]&127)<<28)>>>0,r.hi=(r.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return r;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw Jn(this);if(r.lo=(r.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return r}return r.lo=(r.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,r}if(this.len-this.pos>4){for(;e<5;++e)if(r.hi=(r.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return r}else for(;e<5;++e){if(this.pos>=this.len)throw Jn(this);if(r.hi=(r.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return r}throw Error("invalid varint encoding")}Pt.prototype.bool=function(){return this.uint32()!==0};function Ah(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}Pt.prototype.fixed32=function(){if(this.pos+4>this.len)throw Jn(this,4);return Ah(this.buf,this.pos+=4)};Pt.prototype.sfixed32=function(){if(this.pos+4>this.len)throw Jn(this,4);return Ah(this.buf,this.pos+=4)|0};function Qx(){if(this.pos+8>this.len)throw Jn(this,8);return new Xx(Ah(this.buf,this.pos+=4),Ah(this.buf,this.pos+=4))}Pt.prototype.float=function(){if(this.pos+4>this.len)throw Jn(this,4);var e=Zn.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e};Pt.prototype.double=function(){if(this.pos+8>this.len)throw Jn(this,4);var e=Zn.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e};Pt.prototype.bytes=function(){var e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Jn(this,e);if(this.pos+=e,Array.isArray(this.buf))return this.buf.slice(t,n);if(t===n){var i=Zn.Buffer;return i?i.alloc(0):new this.buf.constructor(0)}return this._slice.call(this.buf,t,n)};Pt.prototype.string=function(){var e=this.bytes();return QU.read(e,0,e.length)};Pt.prototype.skip=function(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Jn(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Jn(this);while(this.buf[this.pos++]&128);return this};Pt.prototype.skipType=function(r){switch(r){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(r=this.uint32()&7)!==4;)this.skipType(r);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+r+" at offset "+this.pos)}return this};Pt._configure=function(r){T3=r,Pt.create=jx(),T3._configure();var e=Zn.Long?"toLong":"toNumber";Zn.merge(Pt.prototype,{int64:function(){return A3.call(this)[e](!1)},uint64:function(){return A3.call(this)[e](!0)},sint64:function(){return A3.call(this).zzDecode()[e](!1)},fixed64:function(){return Qx.call(this)[e](!0)},sfixed64:function(){return Qx.call(this)[e](!1)}})}});var rv=F(($0e,tv)=>{"use strict";tv.exports=Ho;var ev=D3();(Ho.prototype=Object.create(ev.prototype)).constructor=Ho;var Jx=Ms();function Ho(r){ev.call(this,r)}Ho._configure=function(){Jx.Buffer&&(Ho.prototype._slice=Jx.Buffer.prototype.slice)};Ho.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))};Ho._configure()});var iv=F((H0e,nv)=>{"use strict";nv.exports=ou;var C3=Ms();(ou.prototype=Object.create(C3.EventEmitter.prototype)).constructor=ou;function ou(r,e,t){if(typeof r!="function")throw TypeError("rpcImpl must be a function");C3.EventEmitter.call(this),this.rpcImpl=r,this.requestDelimited=!!e,this.responseDelimited=!!t}ou.prototype.rpcCall=function r(e,t,n,i,s){if(!i)throw TypeError("request must be specified");var o=this;if(!s)return C3.asPromise(r,o,e,t,n,i);if(!o.rpcImpl){setTimeout(function(){s(Error("already ended"))},0);return}try{return o.rpcImpl(e,t[o.requestDelimited?"encodeDelimited":"encode"](i).finish(),function(c,l){if(c)return o.emit("error",c,e),s(c);if(l===null){o.end(!0);return}if(!(l instanceof n))try{l=n[o.responseDelimited?"decodeDelimited":"decode"](l)}catch(u){return o.emit("error",u,e),s(u)}return o.emit("data",l,e),s(null,l)})}catch(a){o.emit("error",a,e),setTimeout(function(){s(a)},0);return}};ou.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}});var ov=F(sv=>{"use strict";var XU=sv;XU.Service=iv()});var cv=F((G0e,av)=>{"use strict";av.exports={}});var fv=F(uv=>{"use strict";var Ur=uv;Ur.build="minimal";Ur.Writer=I3();Ur.BufferWriter=Gx();Ur.Reader=D3();Ur.BufferReader=rv();Ur.util=Ms();Ur.rpc=ov();Ur.roots=cv();Ur.configure=lv;function lv(){Ur.util._configure(),Ur.Writer._configure(Ur.BufferWriter),Ur.Reader._configure(Ur.BufferReader)}lv()});var P3=F((Q0e,hv)=>{"use strict";hv.exports=fv()});var pv=F((dv,au)=>{(function(r,e){typeof define=="function"&&define.amd?define(["protobufjs/minimal"],e):typeof y8=="function"&&typeof au=="object"&&au&&au.exports&&(au.exports=e(P3()))})(dv,function(r){"use strict";var e=r.Reader,t=r.Writer,n=r.util,i=r.roots.default||(r.roots.default={});return i.RPC=function(){function s(a){if(this.subscriptions=[],this.messages=[],a)for(var c=Object.keys(a),l=0;l<c.length;++l)a[c[l]]!=null&&(this[c[l]]=a[c[l]])}s.prototype.subscriptions=n.emptyArray,s.prototype.messages=n.emptyArray,s.prototype.control=null;var o;return Object.defineProperty(s.prototype,"_control",{get:n.oneOfGetter(o=["control"]),set:n.oneOfSetter(o)}),s.encode=function(c,l){if(l||(l=t.create()),c.subscriptions!=null&&c.subscriptions.length)for(var u=0;u<c.subscriptions.length;++u)i.RPC.SubOpts.encode(c.subscriptions[u],l.uint32(10).fork()).ldelim();if(c.messages!=null&&c.messages.length)for(var u=0;u<c.messages.length;++u)i.RPC.Message.encode(c.messages[u],l.uint32(18).fork()).ldelim();return c.control!=null&&Object.hasOwnProperty.call(c,"control")&&i.RPC.ControlMessage.encode(c.control,l.uint32(26).fork()).ldelim(),l},s.decode=function(c,l){c instanceof e||(c=e.create(c));for(var u=l===void 0?c.len:c.pos+l,f=new i.RPC;c.pos<u;){var h=c.uint32();switch(h>>>3){case 1:f.subscriptions&&f.subscriptions.length||(f.subscriptions=[]),f.subscriptions.push(i.RPC.SubOpts.decode(c,c.uint32()));break;case 2:f.messages&&f.messages.length||(f.messages=[]),f.messages.push(i.RPC.Message.decode(c,c.uint32()));break;case 3:f.control=i.RPC.ControlMessage.decode(c,c.uint32());break;default:c.skipType(h&7);break}}return f},s.fromObject=function(c){if(c instanceof i.RPC)return c;var l=new i.RPC;if(c.subscriptions){if(!Array.isArray(c.subscriptions))throw TypeError(".RPC.subscriptions: array expected");l.subscriptions=[];for(var u=0;u<c.subscriptions.length;++u){if(typeof c.subscriptions[u]!="object")throw TypeError(".RPC.subscriptions: object expected");l.subscriptions[u]=i.RPC.SubOpts.fromObject(c.subscriptions[u])}}if(c.messages){if(!Array.isArray(c.messages))throw TypeError(".RPC.messages: array expected");l.messages=[];for(var u=0;u<c.messages.length;++u){if(typeof c.messages[u]!="object")throw TypeError(".RPC.messages: object expected");l.messages[u]=i.RPC.Message.fromObject(c.messages[u])}}if(c.control!=null){if(typeof c.control!="object")throw TypeError(".RPC.control: object expected");l.control=i.RPC.ControlMessage.fromObject(c.control)}return l},s.toObject=function(c,l){l||(l={});var u={};if((l.arrays||l.defaults)&&(u.subscriptions=[],u.messages=[]),c.subscriptions&&c.subscriptions.length){u.subscriptions=[];for(var f=0;f<c.subscriptions.length;++f)u.subscriptions[f]=i.RPC.SubOpts.toObject(c.subscriptions[f],l)}if(c.messages&&c.messages.length){u.messages=[];for(var f=0;f<c.messages.length;++f)u.messages[f]=i.RPC.Message.toObject(c.messages[f],l)}return c.control!=null&&c.hasOwnProperty("control")&&(u.control=i.RPC.ControlMessage.toObject(c.control,l),l.oneofs&&(u._control="control")),u},s.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},s.SubOpts=function(){function a(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.subscribe=null,a.prototype.topic=null;var c;return Object.defineProperty(a.prototype,"_subscribe",{get:n.oneOfGetter(c=["subscribe"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_topic",{get:n.oneOfGetter(c=["topic"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){return f||(f=t.create()),u.subscribe!=null&&Object.hasOwnProperty.call(u,"subscribe")&&f.uint32(8).bool(u.subscribe),u.topic!=null&&Object.hasOwnProperty.call(u,"topic")&&f.uint32(18).string(u.topic),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new i.RPC.SubOpts;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.subscribe=u.bool();break;case 2:d.topic=u.string();break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof i.RPC.SubOpts)return u;var f=new i.RPC.SubOpts;return u.subscribe!=null&&(f.subscribe=!!u.subscribe),u.topic!=null&&(f.topic=String(u.topic)),f},a.toObject=function(u,f){f||(f={});var h={};return u.subscribe!=null&&u.hasOwnProperty("subscribe")&&(h.subscribe=u.subscribe,f.oneofs&&(h._subscribe="subscribe")),u.topic!=null&&u.hasOwnProperty("topic")&&(h.topic=u.topic,f.oneofs&&(h._topic="topic")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),s.Message=function(){function a(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.from=null,a.prototype.data=null,a.prototype.seqno=null,a.prototype.topic="",a.prototype.signature=null,a.prototype.key=null;var c;return Object.defineProperty(a.prototype,"_from",{get:n.oneOfGetter(c=["from"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_data",{get:n.oneOfGetter(c=["data"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_seqno",{get:n.oneOfGetter(c=["seqno"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_signature",{get:n.oneOfGetter(c=["signature"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_key",{get:n.oneOfGetter(c=["key"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){return f||(f=t.create()),u.from!=null&&Object.hasOwnProperty.call(u,"from")&&f.uint32(10).bytes(u.from),u.data!=null&&Object.hasOwnProperty.call(u,"data")&&f.uint32(18).bytes(u.data),u.seqno!=null&&Object.hasOwnProperty.call(u,"seqno")&&f.uint32(26).bytes(u.seqno),f.uint32(34).string(u.topic),u.signature!=null&&Object.hasOwnProperty.call(u,"signature")&&f.uint32(42).bytes(u.signature),u.key!=null&&Object.hasOwnProperty.call(u,"key")&&f.uint32(50).bytes(u.key),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new i.RPC.Message;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.from=u.bytes();break;case 2:d.data=u.bytes();break;case 3:d.seqno=u.bytes();break;case 4:d.topic=u.string();break;case 5:d.signature=u.bytes();break;case 6:d.key=u.bytes();break;default:u.skipType(p&7);break}}if(!d.hasOwnProperty("topic"))throw n.ProtocolError("missing required 'topic'",{instance:d});return d},a.fromObject=function(u){if(u instanceof i.RPC.Message)return u;var f=new i.RPC.Message;return u.from!=null&&(typeof u.from=="string"?n.base64.decode(u.from,f.from=n.newBuffer(n.base64.length(u.from)),0):u.from.length&&(f.from=u.from)),u.data!=null&&(typeof u.data=="string"?n.base64.decode(u.data,f.data=n.newBuffer(n.base64.length(u.data)),0):u.data.length&&(f.data=u.data)),u.seqno!=null&&(typeof u.seqno=="string"?n.base64.decode(u.seqno,f.seqno=n.newBuffer(n.base64.length(u.seqno)),0):u.seqno.length&&(f.seqno=u.seqno)),u.topic!=null&&(f.topic=String(u.topic)),u.signature!=null&&(typeof u.signature=="string"?n.base64.decode(u.signature,f.signature=n.newBuffer(n.base64.length(u.signature)),0):u.signature.length&&(f.signature=u.signature)),u.key!=null&&(typeof u.key=="string"?n.base64.decode(u.key,f.key=n.newBuffer(n.base64.length(u.key)),0):u.key.length&&(f.key=u.key)),f},a.toObject=function(u,f){f||(f={});var h={};return f.defaults&&(h.topic=""),u.from!=null&&u.hasOwnProperty("from")&&(h.from=f.bytes===String?n.base64.encode(u.from,0,u.from.length):f.bytes===Array?Array.prototype.slice.call(u.from):u.from,f.oneofs&&(h._from="from")),u.data!=null&&u.hasOwnProperty("data")&&(h.data=f.bytes===String?n.base64.encode(u.data,0,u.data.length):f.bytes===Array?Array.prototype.slice.call(u.data):u.data,f.oneofs&&(h._data="data")),u.seqno!=null&&u.hasOwnProperty("seqno")&&(h.seqno=f.bytes===String?n.base64.encode(u.seqno,0,u.seqno.length):f.bytes===Array?Array.prototype.slice.call(u.seqno):u.seqno,f.oneofs&&(h._seqno="seqno")),u.topic!=null&&u.hasOwnProperty("topic")&&(h.topic=u.topic),u.signature!=null&&u.hasOwnProperty("signature")&&(h.signature=f.bytes===String?n.base64.encode(u.signature,0,u.signature.length):f.bytes===Array?Array.prototype.slice.call(u.signature):u.signature,f.oneofs&&(h._signature="signature")),u.key!=null&&u.hasOwnProperty("key")&&(h.key=f.bytes===String?n.base64.encode(u.key,0,u.key.length):f.bytes===Array?Array.prototype.slice.call(u.key):u.key,f.oneofs&&(h._key="key")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),s.ControlMessage=function(){function a(c){if(this.ihave=[],this.iwant=[],this.graft=[],this.prune=[],c)for(var l=Object.keys(c),u=0;u<l.length;++u)c[l[u]]!=null&&(this[l[u]]=c[l[u]])}return a.prototype.ihave=n.emptyArray,a.prototype.iwant=n.emptyArray,a.prototype.graft=n.emptyArray,a.prototype.prune=n.emptyArray,a.encode=function(l,u){if(u||(u=t.create()),l.ihave!=null&&l.ihave.length)for(var f=0;f<l.ihave.length;++f)i.RPC.ControlIHave.encode(l.ihave[f],u.uint32(10).fork()).ldelim();if(l.iwant!=null&&l.iwant.length)for(var f=0;f<l.iwant.length;++f)i.RPC.ControlIWant.encode(l.iwant[f],u.uint32(18).fork()).ldelim();if(l.graft!=null&&l.graft.length)for(var f=0;f<l.graft.length;++f)i.RPC.ControlGraft.encode(l.graft[f],u.uint32(26).fork()).ldelim();if(l.prune!=null&&l.prune.length)for(var f=0;f<l.prune.length;++f)i.RPC.ControlPrune.encode(l.prune[f],u.uint32(34).fork()).ldelim();return u},a.decode=function(l,u){l instanceof e||(l=e.create(l));for(var f=u===void 0?l.len:l.pos+u,h=new i.RPC.ControlMessage;l.pos<f;){var d=l.uint32();switch(d>>>3){case 1:h.ihave&&h.ihave.length||(h.ihave=[]),h.ihave.push(i.RPC.ControlIHave.decode(l,l.uint32()));break;case 2:h.iwant&&h.iwant.length||(h.iwant=[]),h.iwant.push(i.RPC.ControlIWant.decode(l,l.uint32()));break;case 3:h.graft&&h.graft.length||(h.graft=[]),h.graft.push(i.RPC.ControlGraft.decode(l,l.uint32()));break;case 4:h.prune&&h.prune.length||(h.prune=[]),h.prune.push(i.RPC.ControlPrune.decode(l,l.uint32()));break;default:l.skipType(d&7);break}}return h},a.fromObject=function(l){if(l instanceof i.RPC.ControlMessage)return l;var u=new i.RPC.ControlMessage;if(l.ihave){if(!Array.isArray(l.ihave))throw TypeError(".RPC.ControlMessage.ihave: array expected");u.ihave=[];for(var f=0;f<l.ihave.length;++f){if(typeof l.ihave[f]!="object")throw TypeError(".RPC.ControlMessage.ihave: object expected");u.ihave[f]=i.RPC.ControlIHave.fromObject(l.ihave[f])}}if(l.iwant){if(!Array.isArray(l.iwant))throw TypeError(".RPC.ControlMessage.iwant: array expected");u.iwant=[];for(var f=0;f<l.iwant.length;++f){if(typeof l.iwant[f]!="object")throw TypeError(".RPC.ControlMessage.iwant: object expected");u.iwant[f]=i.RPC.ControlIWant.fromObject(l.iwant[f])}}if(l.graft){if(!Array.isArray(l.graft))throw TypeError(".RPC.ControlMessage.graft: array expected");u.graft=[];for(var f=0;f<l.graft.length;++f){if(typeof l.graft[f]!="object")throw TypeError(".RPC.ControlMessage.graft: object expected");u.graft[f]=i.RPC.ControlGraft.fromObject(l.graft[f])}}if(l.prune){if(!Array.isArray(l.prune))throw TypeError(".RPC.ControlMessage.prune: array expected");u.prune=[];for(var f=0;f<l.prune.length;++f){if(typeof l.prune[f]!="object")throw TypeError(".RPC.ControlMessage.prune: object expected");u.prune[f]=i.RPC.ControlPrune.fromObject(l.prune[f])}}return u},a.toObject=function(l,u){u||(u={});var f={};if((u.arrays||u.defaults)&&(f.ihave=[],f.iwant=[],f.graft=[],f.prune=[]),l.ihave&&l.ihave.length){f.ihave=[];for(var h=0;h<l.ihave.length;++h)f.ihave[h]=i.RPC.ControlIHave.toObject(l.ihave[h],u)}if(l.iwant&&l.iwant.length){f.iwant=[];for(var h=0;h<l.iwant.length;++h)f.iwant[h]=i.RPC.ControlIWant.toObject(l.iwant[h],u)}if(l.graft&&l.graft.length){f.graft=[];for(var h=0;h<l.graft.length;++h)f.graft[h]=i.RPC.ControlGraft.toObject(l.graft[h],u)}if(l.prune&&l.prune.length){f.prune=[];for(var h=0;h<l.prune.length;++h)f.prune[h]=i.RPC.ControlPrune.toObject(l.prune[h],u)}return f},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),s.ControlIHave=function(){function a(l){if(this.messageIDs=[],l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.topicID=null,a.prototype.messageIDs=n.emptyArray;var c;return Object.defineProperty(a.prototype,"_topicID",{get:n.oneOfGetter(c=["topicID"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){if(f||(f=t.create()),u.topicID!=null&&Object.hasOwnProperty.call(u,"topicID")&&f.uint32(10).string(u.topicID),u.messageIDs!=null&&u.messageIDs.length)for(var h=0;h<u.messageIDs.length;++h)f.uint32(18).bytes(u.messageIDs[h]);return f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new i.RPC.ControlIHave;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.topicID=u.string();break;case 2:d.messageIDs&&d.messageIDs.length||(d.messageIDs=[]),d.messageIDs.push(u.bytes());break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof i.RPC.ControlIHave)return u;var f=new i.RPC.ControlIHave;if(u.topicID!=null&&(f.topicID=String(u.topicID)),u.messageIDs){if(!Array.isArray(u.messageIDs))throw TypeError(".RPC.ControlIHave.messageIDs: array expected");f.messageIDs=[];for(var h=0;h<u.messageIDs.length;++h)typeof u.messageIDs[h]=="string"?n.base64.decode(u.messageIDs[h],f.messageIDs[h]=n.newBuffer(n.base64.length(u.messageIDs[h])),0):u.messageIDs[h].length&&(f.messageIDs[h]=u.messageIDs[h])}return f},a.toObject=function(u,f){f||(f={});var h={};if((f.arrays||f.defaults)&&(h.messageIDs=[]),u.topicID!=null&&u.hasOwnProperty("topicID")&&(h.topicID=u.topicID,f.oneofs&&(h._topicID="topicID")),u.messageIDs&&u.messageIDs.length){h.messageIDs=[];for(var d=0;d<u.messageIDs.length;++d)h.messageIDs[d]=f.bytes===String?n.base64.encode(u.messageIDs[d],0,u.messageIDs[d].length):f.bytes===Array?Array.prototype.slice.call(u.messageIDs[d]):u.messageIDs[d]}return h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),s.ControlIWant=function(){function a(c){if(this.messageIDs=[],c)for(var l=Object.keys(c),u=0;u<l.length;++u)c[l[u]]!=null&&(this[l[u]]=c[l[u]])}return a.prototype.messageIDs=n.emptyArray,a.encode=function(l,u){if(u||(u=t.create()),l.messageIDs!=null&&l.messageIDs.length)for(var f=0;f<l.messageIDs.length;++f)u.uint32(10).bytes(l.messageIDs[f]);return u},a.decode=function(l,u){l instanceof e||(l=e.create(l));for(var f=u===void 0?l.len:l.pos+u,h=new i.RPC.ControlIWant;l.pos<f;){var d=l.uint32();switch(d>>>3){case 1:h.messageIDs&&h.messageIDs.length||(h.messageIDs=[]),h.messageIDs.push(l.bytes());break;default:l.skipType(d&7);break}}return h},a.fromObject=function(l){if(l instanceof i.RPC.ControlIWant)return l;var u=new i.RPC.ControlIWant;if(l.messageIDs){if(!Array.isArray(l.messageIDs))throw TypeError(".RPC.ControlIWant.messageIDs: array expected");u.messageIDs=[];for(var f=0;f<l.messageIDs.length;++f)typeof l.messageIDs[f]=="string"?n.base64.decode(l.messageIDs[f],u.messageIDs[f]=n.newBuffer(n.base64.length(l.messageIDs[f])),0):l.messageIDs[f].length&&(u.messageIDs[f]=l.messageIDs[f])}return u},a.toObject=function(l,u){u||(u={});var f={};if((u.arrays||u.defaults)&&(f.messageIDs=[]),l.messageIDs&&l.messageIDs.length){f.messageIDs=[];for(var h=0;h<l.messageIDs.length;++h)f.messageIDs[h]=u.bytes===String?n.base64.encode(l.messageIDs[h],0,l.messageIDs[h].length):u.bytes===Array?Array.prototype.slice.call(l.messageIDs[h]):l.messageIDs[h]}return f},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),s.ControlGraft=function(){function a(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.topicID=null;var c;return Object.defineProperty(a.prototype,"_topicID",{get:n.oneOfGetter(c=["topicID"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){return f||(f=t.create()),u.topicID!=null&&Object.hasOwnProperty.call(u,"topicID")&&f.uint32(10).string(u.topicID),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new i.RPC.ControlGraft;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.topicID=u.string();break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof i.RPC.ControlGraft)return u;var f=new i.RPC.ControlGraft;return u.topicID!=null&&(f.topicID=String(u.topicID)),f},a.toObject=function(u,f){f||(f={});var h={};return u.topicID!=null&&u.hasOwnProperty("topicID")&&(h.topicID=u.topicID,f.oneofs&&(h._topicID="topicID")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),s.ControlPrune=function(){function a(l){if(this.peers=[],l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.topicID=null,a.prototype.peers=n.emptyArray,a.prototype.backoff=null;var c;return Object.defineProperty(a.prototype,"_topicID",{get:n.oneOfGetter(c=["topicID"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_backoff",{get:n.oneOfGetter(c=["backoff"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){if(f||(f=t.create()),u.topicID!=null&&Object.hasOwnProperty.call(u,"topicID")&&f.uint32(10).string(u.topicID),u.peers!=null&&u.peers.length)for(var h=0;h<u.peers.length;++h)i.RPC.PeerInfo.encode(u.peers[h],f.uint32(18).fork()).ldelim();return u.backoff!=null&&Object.hasOwnProperty.call(u,"backoff")&&f.uint32(24).uint64(u.backoff),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new i.RPC.ControlPrune;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.topicID=u.string();break;case 2:d.peers&&d.peers.length||(d.peers=[]),d.peers.push(i.RPC.PeerInfo.decode(u,u.uint32()));break;case 3:d.backoff=u.uint64();break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof i.RPC.ControlPrune)return u;var f=new i.RPC.ControlPrune;if(u.topicID!=null&&(f.topicID=String(u.topicID)),u.peers){if(!Array.isArray(u.peers))throw TypeError(".RPC.ControlPrune.peers: array expected");f.peers=[];for(var h=0;h<u.peers.length;++h){if(typeof u.peers[h]!="object")throw TypeError(".RPC.ControlPrune.peers: object expected");f.peers[h]=i.RPC.PeerInfo.fromObject(u.peers[h])}}return u.backoff!=null&&(n.Long?(f.backoff=n.Long.fromValue(u.backoff)).unsigned=!0:typeof u.backoff=="string"?f.backoff=parseInt(u.backoff,10):typeof u.backoff=="number"?f.backoff=u.backoff:typeof u.backoff=="object"&&(f.backoff=new n.LongBits(u.backoff.low>>>0,u.backoff.high>>>0).toNumber(!0))),f},a.toObject=function(u,f){f||(f={});var h={};if((f.arrays||f.defaults)&&(h.peers=[]),u.topicID!=null&&u.hasOwnProperty("topicID")&&(h.topicID=u.topicID,f.oneofs&&(h._topicID="topicID")),u.peers&&u.peers.length){h.peers=[];for(var d=0;d<u.peers.length;++d)h.peers[d]=i.RPC.PeerInfo.toObject(u.peers[d],f)}return u.backoff!=null&&u.hasOwnProperty("backoff")&&(typeof u.backoff=="number"?h.backoff=f.longs===String?String(u.backoff):u.backoff:h.backoff=f.longs===String?n.Long.prototype.toString.call(u.backoff):f.longs===Number?new n.LongBits(u.backoff.low>>>0,u.backoff.high>>>0).toNumber(!0):u.backoff,f.oneofs&&(h._backoff="backoff")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),s.PeerInfo=function(){function a(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.peerID=null,a.prototype.signedPeerRecord=null;var c;return Object.defineProperty(a.prototype,"_peerID",{get:n.oneOfGetter(c=["peerID"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_signedPeerRecord",{get:n.oneOfGetter(c=["signedPeerRecord"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){return f||(f=t.create()),u.peerID!=null&&Object.hasOwnProperty.call(u,"peerID")&&f.uint32(10).bytes(u.peerID),u.signedPeerRecord!=null&&Object.hasOwnProperty.call(u,"signedPeerRecord")&&f.uint32(18).bytes(u.signedPeerRecord),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new i.RPC.PeerInfo;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.peerID=u.bytes();break;case 2:d.signedPeerRecord=u.bytes();break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof i.RPC.PeerInfo)return u;var f=new i.RPC.PeerInfo;return u.peerID!=null&&(typeof u.peerID=="string"?n.base64.decode(u.peerID,f.peerID=n.newBuffer(n.base64.length(u.peerID)),0):u.peerID.length&&(f.peerID=u.peerID)),u.signedPeerRecord!=null&&(typeof u.signedPeerRecord=="string"?n.base64.decode(u.signedPeerRecord,f.signedPeerRecord=n.newBuffer(n.base64.length(u.signedPeerRecord)),0):u.signedPeerRecord.length&&(f.signedPeerRecord=u.signedPeerRecord)),f},a.toObject=function(u,f){f||(f={});var h={};return u.peerID!=null&&u.hasOwnProperty("peerID")&&(h.peerID=f.bytes===String?n.base64.encode(u.peerID,0,u.peerID.length):f.bytes===Array?Array.prototype.slice.call(u.peerID):u.peerID,f.oneofs&&(h._peerID="peerID")),u.signedPeerRecord!=null&&u.hasOwnProperty("signedPeerRecord")&&(h.signedPeerRecord=f.bytes===String?n.base64.encode(u.signedPeerRecord,0,u.signedPeerRecord.length):f.bytes===Array?Array.prototype.slice.call(u.signedPeerRecord):u.signedPeerRecord,f.oneofs&&(h._signedPeerRecord="signedPeerRecord")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),s}(),i})});var Rv=F((xfe,Sv)=>{"use strict";function yt(r,t){var t=t||{};this._capacity=t.capacity,this._head=0,this._tail=0,Array.isArray(r)?this._fromArray(r):(this._capacityMask=3,this._list=new Array(4))}yt.prototype.peekAt=function(e){var t=e;if(t===(t|0)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),t=this._head+t&this._capacityMask,this._list[t]}};yt.prototype.get=function(e){return this.peekAt(e)};yt.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]};yt.prototype.peekFront=function(){return this.peek()};yt.prototype.peekBack=function(){return this.peekAt(-1)};Object.defineProperty(yt.prototype,"length",{get:function(){return this.size()}});yt.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};yt.prototype.unshift=function(e){if(arguments.length===0)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};yt.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}};yt.prototype.push=function(e){if(arguments.length===0)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};yt.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),n}};yt.prototype.removeOne=function(e){var t=e;if(t===(t|0)&&this._head!==this._tail){var n=this.size(),i=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n),t=this._head+t&this._capacityMask;var s=this._list[t],o;if(e<n/2){for(o=e;o>0;o--)this._list[t]=this._list[t=t-1+i&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+i&this._capacityMask}else{for(o=n-1-e;o>0;o--)this._list[t]=this._list[t=t+1+i&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+i&this._capacityMask}return s}}};yt.prototype.remove=function(e,t){var n=e,i,s=t;if(n===(n|0)&&this._head!==this._tail){var o=this.size(),a=this._list.length;if(!(n>=o||n<-o||t<1)){if(n<0&&(n+=o),t===1||!t)return i=new Array(1),i[0]=this.removeOne(n),i;if(n===0&&n+t>=o)return i=this.toArray(),this.clear(),i;n+t>o&&(t=o-n);var c;for(i=new Array(t),c=0;c<t;c++)i[c]=this._list[this._head+n+c&this._capacityMask];if(n=this._head+n&this._capacityMask,e+t===o){for(this._tail=this._tail-t+a&this._capacityMask,c=t;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return i}if(e===0){for(this._head=this._head+t+a&this._capacityMask,c=t-1;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return i}if(n<o/2){for(this._head=this._head+e+t+a&this._capacityMask,c=e;c>0;c--)this.unshift(this._list[n=n-1+a&this._capacityMask]);for(n=this._head-1+a&this._capacityMask;s>0;)this._list[n=n-1+a&this._capacityMask]=void 0,s--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+t+a&this._capacityMask,c=o-(t+e);c>0;c--)this.push(this._list[n++]);for(n=this._tail;s>0;)this._list[n=n+1+a&this._capacityMask]=void 0,s--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),i}}};yt.prototype.splice=function(e,t){var n=e;if(n===(n|0)){var i=this.size();if(n<0&&(n+=i),!(n>i))if(arguments.length>2){var s,o,a,c=arguments.length,l=this._list.length,u=2;if(!i||n<i/2){for(o=new Array(n),s=0;s<n;s++)o[s]=this._list[this._head+s&this._capacityMask];for(t===0?(a=[],n>0&&(this._head=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._head=this._head+n+l&this._capacityMask);c>u;)this.unshift(arguments[--c]);for(s=n;s>0;s--)this.unshift(o[s-1])}else{o=new Array(i-(n+t));var f=o.length;for(s=0;s<f;s++)o[s]=this._list[this._head+n+t+s&this._capacityMask];for(t===0?(a=[],n!=i&&(this._tail=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._tail=this._tail-f+l&this._capacityMask);u<c;)this.push(arguments[u++]);for(s=0;s<f;s++)this.push(o[s])}return a}else return this.remove(n,t)}};yt.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0};yt.prototype.isEmpty=function(){return this._head===this._tail};yt.prototype.toArray=function(){return this._copyArray(!1)};yt.prototype._fromArray=function(e){var t=e.length,n=this._nextPowerOf2(t);this._list=new Array(n),this._capacityMask=n-1,this._tail=t;for(var i=0;i<t;i++)this._list[i]=e[i]};yt.prototype._copyArray=function(e,t){var n=this._list,i=n.length,s=this.length;if(t=t|s,t==s&&this._head<this._tail)return this._list.slice(this._head,this._tail);var o=new Array(t),a=0,c;if(e||this._head>this._tail){for(c=this._head;c<i;c++)o[a++]=n[c];for(c=0;c<this._tail;c++)o[a++]=n[c]}else for(c=this._head;c<this._tail;c++)o[a++]=n[c];return o};yt.prototype._growArray=function(){if(this._head!=0){var e=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=e}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1};yt.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1};yt.prototype._nextPowerOf2=function(e){var t=Math.log(e)/Math.log(2),n=1<<t+1;return Math.max(n,4)};Sv.exports=yt});var d4=F((xpe,h4)=>{var Epe=function(){typeof h4<"u"&&(h4.exports=m);var r=86400,e=3200,t=146097*e/400,n=r*t,i=1e3*n,s=864e13,o=4294967296,a=1e6,c="000000000",l=Math.trunc||function(_){var k=_-_%1;return k==0&&(_<0||_===0&&1/_!=1/0)?-0:k},u=m.prototype,f=(m.fromDate=function(_){return new m(+_)},m.fromInt64BE=R(0,1,2,3,0,4),m.fromInt64LE=R(3,2,1,0,4,0),m.fromString=function(L){var k,B=new m,L=(L+="").replace(/^\s*[+\-]?\d+/,function(W){var W=+W,te=1970+(W-1970)%400;return B.year=W-te,te}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(K,W,te){return W<0&&(te*=-1),k=6e4*(60*+W+ +te),""}).replace(/\.\d+$/,function(K){return B.nano=+(K+c).substr(1,9),""}).split(/\D+/);if(1<L.length?L[1]--:L[1]=0,B.time=k=Date.UTC.apply(Date,L)-(k||0),isNaN(k))throw new TypeError("Invalid Date");return g(B)},m.fromTimeT=function(_){return w(_,0)},u.year=0,u.time=0,u.nano=0,u.addNano=function(_){return this.nano+=+_||0,this},u.getNano=function(){var _=g(this);return(_.time%1e3*a+ +_.nano+1e9)%1e9},u.getTimeT=function(){var k=g(this),_=Math.floor(k.time/1e3),k=k.year;return k&&(_+=k*t*r/e),_},u.getYear=function(){return this.toDate().getUTCFullYear()+this.year},u.toDate=function(){return y(g(this).time)},u.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},u.toString=function(_){var k=this,B=k.toDate(),L={H:function(){return v(B.getUTCHours())},L:function(){return I(B.getUTCMilliseconds(),3)},M:function(){return v(B.getUTCMinutes())},N:function(){return I(k.getNano(),9)},S:function(){return v(B.getUTCSeconds())},Y:function(){var K=k.getYear();return 999999<K?"+"+K:9999<K?"+"+I(K,6):0<=K?I(K,4):-999999<=K?"-"+I(-K,6):K},a:function(){return d[B.getUTCDay()]},b:function(){return h[B.getUTCMonth()]},d:function(){return v(B.getUTCDate())},e:function(){return function(K){return(9<K?"":" ")+(0|K)}(B.getUTCDate())},m:function(){return v(B.getUTCMonth()+1)}};return function K(W){return W.replace(/%./g,function(te){var N=te[1],P=p[N],N=L[N];return P?K(P):N?N():te})}(_||f)},u.writeInt64BE=E(0,1,2,3,0,4),u.writeInt64LE=E(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),h=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],p={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return m;function m(_,k,B){var L=this;if(!(L instanceof m))return new m(_,k,B);L.time=+_||0,L.nano=+k||0,L.year=+B||0,g(L)}function g(_){var k,B,L,K=_.year,W=_.time,te=_.nano,P=((te<0||a<=te)&&(te-=(B=Math.floor(te/a))*a,W+=B,B=1),K%e);return(W<-s||s<W||P)&&((k=l(W/i))&&(K+=k*e,W-=k*i),(L=y(W)).setUTCFullYear(P+L.getUTCFullYear()),L=(W=+L)+(k=l((K-=P)/e))*i,k&&-s<=L&&L<=s&&(K-=k*e,W=L),B=1),B&&(_.year=K,_.time=W,_.nano=te),_}function y(_){var k=new Date(0);return k.setTime(_),k}function w(K,L){K=+K||0;var B=l((L=(L|0)*o)/n)+l(K/n),L=L%n+K%n,K=l(L/n);return K&&(B+=K,L-=K*n),new m(1e3*L,0,B*e)}function E(_,k,B,L,K,W){return function(P,N){var U=g(this);P=P||new Array(8),x(P,N|=0);var A=Math.floor(U.time/1e3),U=U.year*(t*r/e),O=l(U/o)+l(A/o),U=U%o+A%o,A=Math.floor(U/o);return A&&(O+=A,U-=A*o),te(P,N+K,O),te(P,N+W,U),P};function te(P,N,O){P[N+_]=O>>24&255,P[N+k]=O>>16&255,P[N+B]=O>>8&255,P[N+L]=255&O}}function R(_,k,B,L,K,W){return function(P,N){x(P,N|=0);var O=te(P,N+K);return w(te(P,N+W),O)};function te(P,N){return 16777216*P[N+_]+(P[N+k]<<16|P[N+B]<<8|P[N+L])}}function x(_,k){if(_=_&&_.length,_==null)throw new TypeError("Invalid Buffer");if(_<k+8)throw new RangeError("Out of range")}function v(_){return(9<_?"":"0")+(0|_)}function I(_,k){return(c+(0|_)).substr(-k)}}()});var SS=F((S3e,_S)=>{_S.exports=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function i(s,o){t[s]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(s){return t[s]!==void 0||n[s]!==void 0},remove:function(s){t[s]!==void 0&&(t[s]=void 0),n[s]!==void 0&&(n[s]=void 0)},get:function(s){var o=t[s];if(o!==void 0)return o;if((o=n[s])!==void 0)return i(s,o),o},set:function(s,o){t[s]!==void 0?t[s]=o:i(s,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}}});var fR=F((o5e,uR)=>{"use strict";function YV(r){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),t=0;t<e.length;t++)e[t]=255;for(var n=0;n<r.length;n++){var i=r.charAt(n),s=i.charCodeAt(0);if(e[s]!==255)throw new TypeError(i+" is ambiguous");e[s]=n}var o=r.length,a=r.charAt(0),c=Math.log(o)/Math.log(256),l=Math.log(256)/Math.log(o);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,m=0,g=0,y=d.length;g!==y&&d[g]===0;)g++,p++;for(var w=(y-g)*l+1>>>0,E=new Uint8Array(w);g!==y;){for(var R=d[g],x=0,v=w-1;(R!==0||x<m)&&v!==-1;v--,x++)R+=256*E[v]>>>0,E[v]=R%o>>>0,R=R/o>>>0;if(R!==0)throw new Error("Non-zero carry");m=x,g++}for(var I=w-m;I!==w&&E[I]===0;)I++;for(var _=a.repeat(p);I<w;++I)_+=r.charAt(E[I]);return _}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var m=0,g=0;d[p]===a;)m++,p++;for(var y=(d.length-p)*c+1>>>0,w=new Uint8Array(y);d[p];){var E=e[d.charCodeAt(p)];if(E===255)return;for(var R=0,x=y-1;(E!==0||R<g)&&x!==-1;x--,R++)E+=o*w[x]>>>0,w[x]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");g=R,p++}if(d[p]!==" "){for(var v=y-g;v!==y&&w[v]===0;)v++;for(var I=new Uint8Array(m+(y-v)),_=m;v!==y;)I[_++]=w[v++];return I}}}function h(d){var p=f(d);if(p)return p;throw new Error("Non-base"+o+" character")}return{encode:u,decodeUnsafe:f,decode:h}}uR.exports=YV});var Gd=F((a5e,hR)=>{"use strict";var QV=new TextDecoder,XV=r=>QV.decode(r),jV=new TextEncoder,ZV=r=>jV.encode(r);function JV(r,e){let t=new Uint8Array(e),n=0;for(let i of r)t.set(i,n),n+=i.length;return t}hR.exports={decodeText:XV,encodeText:ZV,concat:JV}});var pR=F((c5e,dR)=>{"use strict";var{encodeText:eq}=Gd(),ig=class{constructor(e,t,n,i){this.name=e,this.code=t,this.codeBuf=eq(this.code),this.alphabet=i,this.codec=n(i)}encode(e){return this.codec.encode(e)}decode(e){for(let t of e)if(this.alphabet&&this.alphabet.indexOf(t)<0)throw new Error(`invalid character '${t}' in '${e}'`);return this.codec.decode(e)}};dR.exports=ig});var gR=F((l5e,mR)=>{"use strict";var tq=(r,e,t)=>{let n={};for(let l=0;l<e.length;++l)n[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;let s=new Uint8Array(i*t/8|0),o=0,a=0,c=0;for(let l=0;l<i;++l){let u=n[r[l]];if(u===void 0)throw new SyntaxError("Invalid character "+r[l]);a=a<<t|u,o+=t,o>=8&&(o-=8,s[c++]=255&a>>o)}if(o>=t||255&a<<8-o)throw new SyntaxError("Unexpected end of data");return s},rq=(r,e,t)=>{let n=e[e.length-1]==="=",i=(1<<t)-1,s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s},nq=r=>e=>({encode(t){return rq(t,e,r)},decode(t){return tq(t,e,r)}});mR.exports={rfc4648:nq}});var ER=F((u5e,wR)=>{"use strict";var Tu=fR(),iq=pR(),{rfc4648:ur}=gR(),{decodeText:sq,encodeText:oq}=Gd(),aq=()=>({encode:sq,decode:oq}),yR=[["identity","\0",aq,""],["base2","0",ur(1),"01"],["base8","7",ur(3),"01234567"],["base10","9",Tu,"0123456789"],["base16","f",ur(4),"0123456789abcdef"],["base16upper","F",ur(4),"0123456789ABCDEF"],["base32hex","v",ur(5),"0123456789abcdefghijklmnopqrstuv"],["base32hexupper","V",ur(5),"0123456789ABCDEFGHIJKLMNOPQRSTUV"],["base32hexpad","t",ur(5),"0123456789abcdefghijklmnopqrstuv="],["base32hexpadupper","T",ur(5),"0123456789ABCDEFGHIJKLMNOPQRSTUV="],["base32","b",ur(5),"abcdefghijklmnopqrstuvwxyz234567"],["base32upper","B",ur(5),"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"],["base32pad","c",ur(5),"abcdefghijklmnopqrstuvwxyz234567="],["base32padupper","C",ur(5),"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567="],["base32z","h",ur(5),"ybndrfg8ejkmcpqxot1uwisza345h769"],["base36","k",Tu,"0123456789abcdefghijklmnopqrstuvwxyz"],["base36upper","K",Tu,"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"],["base58btc","z",Tu,"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"],["base58flickr","Z",Tu,"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"],["base64","m",ur(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"],["base64pad","M",ur(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="],["base64url","u",ur(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"],["base64urlpad","U",ur(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_="]],bR=yR.reduce((r,e)=>(r[e[0]]=new iq(e[0],e[1],e[2],e[3]),r),{}),cq=yR.reduce((r,e)=>(r[e[1]]=bR[e[0]],r),{});wR.exports={names:bR,codes:cq}});var _R=F((ts,vR)=>{"use strict";var Tc=ER(),{encodeText:lq,decodeText:Yd,concat:xR}=Gd();function uq(r,e){if(!e)throw new Error("requires an encoded Uint8Array");let{name:t,codeBuf:n}=ta(r);return pq(t,e),xR([n,e],n.length+e.length)}function fq(r,e){let t=ta(r),n=lq(t.encode(e));return xR([t.codeBuf,n],t.codeBuf.length+n.length)}function hq(r){r instanceof Uint8Array&&(r=Yd(r));let e=r[0];return["f","F","v","V","t","T","b","B","c","C","h","k","K"].includes(e)&&(r=r.toLowerCase()),ta(r[0]).decode(r.substring(1))}function dq(r){if(r instanceof Uint8Array&&(r=Yd(r)),Object.prototype.toString.call(r)!=="[object String]")return!1;try{return ta(r[0]).name}catch{return!1}}function pq(r,e){ta(r).decode(Yd(e))}function ta(r){if(Object.prototype.hasOwnProperty.call(Tc.names,r))return Tc.names[r];if(Object.prototype.hasOwnProperty.call(Tc.codes,r))return Tc.codes[r];throw new Error(`Unsupported encoding: ${r}`)}function mq(r){return r instanceof Uint8Array&&(r=Yd(r)),ta(r[0])}ts=vR.exports=uq;ts.encode=fq;ts.decode=hq;ts.isEncoded=dq;ts.encoding=ta;ts.encodingFromData=mq;var gq=Object.freeze(Tc.names),yq=Object.freeze(Tc.codes);ts.names=gq;ts.codes=yq});var AR=F((f5e,IR)=>{IR.exports=RR;var SR=128,bq=127,wq=~bq,Eq=Math.pow(2,31);function RR(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Eq;)e[t++]=r&255|SR,r/=128;for(;r&wq;)e[t++]=r&255|SR,r>>>=7;return e[t]=r|0,RR.bytes=t-n+1,e}});var CR=F((h5e,DR)=>{DR.exports=sg;var xq=128,TR=127;function sg(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw sg.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&TR)<<i:(o&TR)*Math.pow(2,i),i+=7}while(o>=xq);return sg.bytes=s-n,t}});var kR=F((d5e,PR)=>{var vq=Math.pow(2,7),_q=Math.pow(2,14),Sq=Math.pow(2,21),Rq=Math.pow(2,28),Iq=Math.pow(2,35),Aq=Math.pow(2,42),Tq=Math.pow(2,49),Dq=Math.pow(2,56),Cq=Math.pow(2,63);PR.exports=function(r){return r<vq?1:r<_q?2:r<Sq?3:r<Rq?4:r<Iq?5:r<Aq?6:r<Tq?7:r<Dq?8:r<Cq?9:10}});var OR=F((p5e,NR)=>{NR.exports={encode:AR(),decode:CR(),encodingLength:kR()}});var BR=F((m5e,LR)=>{"use strict";var Pq=Object.freeze({identity:0,sha1:17,"sha2-256":18,"sha2-512":19,"sha3-512":20,"sha3-384":21,"sha3-256":22,"sha3-224":23,"shake-128":24,"shake-256":25,"keccak-224":26,"keccak-256":27,"keccak-384":28,"keccak-512":29,blake3:30,"murmur3-128":34,"murmur3-32":35,"dbl-sha2-256":86,md4:212,md5:213,bmt:214,"sha2-256-trunc254-padded":4114,"ripemd-128":4178,"ripemd-160":4179,"ripemd-256":4180,"ripemd-320":4181,x11:4352,kangarootwelve:7425,"sm3-256":21325,"blake2b-8":45569,"blake2b-16":45570,"blake2b-24":45571,"blake2b-32":45572,"blake2b-40":45573,"blake2b-48":45574,"blake2b-56":45575,"blake2b-64":45576,"blake2b-72":45577,"blake2b-80":45578,"blake2b-88":45579,"blake2b-96":45580,"blake2b-104":45581,"blake2b-112":45582,"blake2b-120":45583,"blake2b-128":45584,"blake2b-136":45585,"blake2b-144":45586,"blake2b-152":45587,"blake2b-160":45588,"blake2b-168":45589,"blake2b-176":45590,"blake2b-184":45591,"blake2b-192":45592,"blake2b-200":45593,"blake2b-208":45594,"blake2b-216":45595,"blake2b-224":45596,"blake2b-232":45597,"blake2b-240":45598,"blake2b-248":45599,"blake2b-256":45600,"blake2b-264":45601,"blake2b-272":45602,"blake2b-280":45603,"blake2b-288":45604,"blake2b-296":45605,"blake2b-304":45606,"blake2b-312":45607,"blake2b-320":45608,"blake2b-328":45609,"blake2b-336":45610,"blake2b-344":45611,"blake2b-352":45612,"blake2b-360":45613,"blake2b-368":45614,"blake2b-376":45615,"blake2b-384":45616,"blake2b-392":45617,"blake2b-400":45618,"blake2b-408":45619,"blake2b-416":45620,"blake2b-424":45621,"blake2b-432":45622,"blake2b-440":45623,"blake2b-448":45624,"blake2b-456":45625,"blake2b-464":45626,"blake2b-472":45627,"blake2b-480":45628,"blake2b-488":45629,"blake2b-496":45630,"blake2b-504":45631,"blake2b-512":45632,"blake2s-8":45633,"blake2s-16":45634,"blake2s-24":45635,"blake2s-32":45636,"blake2s-40":45637,"blake2s-48":45638,"blake2s-56":45639,"blake2s-64":45640,"blake2s-72":45641,"blake2s-80":45642,"blake2s-88":45643,"blake2s-96":45644,"blake2s-104":45645,"blake2s-112":45646,"blake2s-120":45647,"blake2s-128":45648,"blake2s-136":45649,"blake2s-144":45650,"blake2s-152":45651,"blake2s-160":45652,"blake2s-168":45653,"blake2s-176":45654,"blake2s-184":45655,"blake2s-192":45656,"blake2s-200":45657,"blake2s-208":45658,"blake2s-216":45659,"blake2s-224":45660,"blake2s-232":45661,"blake2s-240":45662,"blake2s-248":45663,"blake2s-256":45664,"skein256-8":45825,"skein256-16":45826,"skein256-24":45827,"skein256-32":45828,"skein256-40":45829,"skein256-48":45830,"skein256-56":45831,"skein256-64":45832,"skein256-72":45833,"skein256-80":45834,"skein256-88":45835,"skein256-96":45836,"skein256-104":45837,"skein256-112":45838,"skein256-120":45839,"skein256-128":45840,"skein256-136":45841,"skein256-144":45842,"skein256-152":45843,"skein256-160":45844,"skein256-168":45845,"skein256-176":45846,"skein256-184":45847,"skein256-192":45848,"skein256-200":45849,"skein256-208":45850,"skein256-216":45851,"skein256-224":45852,"skein256-232":45853,"skein256-240":45854,"skein256-248":45855,"skein256-256":45856,"skein512-8":45857,"skein512-16":45858,"skein512-24":45859,"skein512-32":45860,"skein512-40":45861,"skein512-48":45862,"skein512-56":45863,"skein512-64":45864,"skein512-72":45865,"skein512-80":45866,"skein512-88":45867,"skein512-96":45868,"skein512-104":45869,"skein512-112":45870,"skein512-120":45871,"skein512-128":45872,"skein512-136":45873,"skein512-144":45874,"skein512-152":45875,"skein512-160":45876,"skein512-168":45877,"skein512-176":45878,"skein512-184":45879,"skein512-192":45880,"skein512-200":45881,"skein512-208":45882,"skein512-216":45883,"skein512-224":45884,"skein512-232":45885,"skein512-240":45886,"skein512-248":45887,"skein512-256":45888,"skein512-264":45889,"skein512-272":45890,"skein512-280":45891,"skein512-288":45892,"skein512-296":45893,"skein512-304":45894,"skein512-312":45895,"skein512-320":45896,"skein512-328":45897,"skein512-336":45898,"skein512-344":45899,"skein512-352":45900,"skein512-360":45901,"skein512-368":45902,"skein512-376":45903,"skein512-384":45904,"skein512-392":45905,"skein512-400":45906,"skein512-408":45907,"skein512-416":45908,"skein512-424":45909,"skein512-432":45910,"skein512-440":45911,"skein512-448":45912,"skein512-456":45913,"skein512-464":45914,"skein512-472":45915,"skein512-480":45916,"skein512-488":45917,"skein512-496":45918,"skein512-504":45919,"skein512-512":45920,"skein1024-8":45921,"skein1024-16":45922,"skein1024-24":45923,"skein1024-32":45924,"skein1024-40":45925,"skein1024-48":45926,"skein1024-56":45927,"skein1024-64":45928,"skein1024-72":45929,"skein1024-80":45930,"skein1024-88":45931,"skein1024-96":45932,"skein1024-104":45933,"skein1024-112":45934,"skein1024-120":45935,"skein1024-128":45936,"skein1024-136":45937,"skein1024-144":45938,"skein1024-152":45939,"skein1024-160":45940,"skein1024-168":45941,"skein1024-176":45942,"skein1024-184":45943,"skein1024-192":45944,"skein1024-200":45945,"skein1024-208":45946,"skein1024-216":45947,"skein1024-224":45948,"skein1024-232":45949,"skein1024-240":45950,"skein1024-248":45951,"skein1024-256":45952,"skein1024-264":45953,"skein1024-272":45954,"skein1024-280":45955,"skein1024-288":45956,"skein1024-296":45957,"skein1024-304":45958,"skein1024-312":45959,"skein1024-320":45960,"skein1024-328":45961,"skein1024-336":45962,"skein1024-344":45963,"skein1024-352":45964,"skein1024-360":45965,"skein1024-368":45966,"skein1024-376":45967,"skein1024-384":45968,"skein1024-392":45969,"skein1024-400":45970,"skein1024-408":45971,"skein1024-416":45972,"skein1024-424":45973,"skein1024-432":45974,"skein1024-440":45975,"skein1024-448":45976,"skein1024-456":45977,"skein1024-464":45978,"skein1024-472":45979,"skein1024-480":45980,"skein1024-488":45981,"skein1024-496":45982,"skein1024-504":45983,"skein1024-512":45984,"skein1024-520":45985,"skein1024-528":45986,"skein1024-536":45987,"skein1024-544":45988,"skein1024-552":45989,"skein1024-560":45990,"skein1024-568":45991,"skein1024-576":45992,"skein1024-584":45993,"skein1024-592":45994,"skein1024-600":45995,"skein1024-608":45996,"skein1024-616":45997,"skein1024-624":45998,"skein1024-632":45999,"skein1024-640":46e3,"skein1024-648":46001,"skein1024-656":46002,"skein1024-664":46003,"skein1024-672":46004,"skein1024-680":46005,"skein1024-688":46006,"skein1024-696":46007,"skein1024-704":46008,"skein1024-712":46009,"skein1024-720":46010,"skein1024-728":46011,"skein1024-736":46012,"skein1024-744":46013,"skein1024-752":46014,"skein1024-760":46015,"skein1024-768":46016,"skein1024-776":46017,"skein1024-784":46018,"skein1024-792":46019,"skein1024-800":46020,"skein1024-808":46021,"skein1024-816":46022,"skein1024-824":46023,"skein1024-832":46024,"skein1024-840":46025,"skein1024-848":46026,"skein1024-856":46027,"skein1024-864":46028,"skein1024-872":46029,"skein1024-880":46030,"skein1024-888":46031,"skein1024-896":46032,"skein1024-904":46033,"skein1024-912":46034,"skein1024-920":46035,"skein1024-928":46036,"skein1024-936":46037,"skein1024-944":46038,"skein1024-952":46039,"skein1024-960":46040,"skein1024-968":46041,"skein1024-976":46042,"skein1024-984":46043,"skein1024-992":46044,"skein1024-1000":46045,"skein1024-1008":46046,"skein1024-1016":46047,"skein1024-1024":46048,"poseidon-bls12_381-a2-fc1":46081,"poseidon-bls12_381-a2-fc1-sc":46082});LR.exports={names:Pq}});function kq(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,g=0,y=0,w=p.length;y!==w&&p[y]===0;)y++,m++;for(var E=(w-y)*u+1>>>0,R=new Uint8Array(E);y!==w;){for(var x=p[y],v=0,I=E-1;(x!==0||v<g)&&I!==-1;I--,v++)x+=256*R[I]>>>0,R[I]=x%a>>>0,x=x/a>>>0;if(x!==0)throw new Error("Non-zero carry");g=v,y++}for(var _=E-g;_!==E&&R[_]===0;)_++;for(var k=c.repeat(m);_<E;++_)k+=r.charAt(R[_]);return k}function h(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var g=0,y=0;p[m]===c;)g++,m++;for(var w=(p.length-m)*l+1>>>0,E=new Uint8Array(w);p[m];){var R=t[p.charCodeAt(m)];if(R===255)return;for(var x=0,v=w-1;(R!==0||x<y)&&v!==-1;v--,x++)R+=a*E[v]>>>0,E[v]=R%256>>>0,R=R/256>>>0;if(R!==0)throw new Error("Non-zero carry");y=x,m++}if(p[m]!==" "){for(var I=w-y;I!==w&&E[I]===0;)I++;for(var _=new Uint8Array(g+(w-I)),k=g;I!==w;)_[k++]=E[I++];return _}}}function d(p){var m=h(p);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var Nq,Oq,MR,UR=$e(()=>{Nq=kq,Oq=Nq,MR=Oq});var y5e,FR,rs,KR,VR,Ys=$e(()=>{y5e=new Uint8Array(0),FR=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},rs=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},KR=r=>new TextEncoder().encode(r),VR=r=>new TextDecoder().decode(r)});var og,ag,cg,zR,lg,Dc,Qs,Lq,Bq,St,ni=$e(()=>{UR();Ys();og=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},ag=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return zR(this,e)}},cg=class{constructor(e){this.decoders=e}or(e){return zR(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},zR=(r,e)=>new cg({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}}),lg=class{constructor(e,t,n,i){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new og(e,t,n),this.decoder=new ag(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},Dc=({name:r,prefix:e,encode:t,decode:n})=>new lg(r,e,t,n),Qs=({prefix:r,name:e,alphabet:t})=>{let{encode:n,decode:i}=MR(t,e);return Dc({prefix:r,name:e,encode:n,decode:s=>rs(i(s))})},Lq=(r,e,t,n)=>{let i={};for(let u=0;u<e.length;++u)i[e[u]]=u;let s=r.length;for(;r[s-1]==="=";)--s;let o=new Uint8Array(s*t/8|0),a=0,c=0,l=0;for(let u=0;u<s;++u){let f=i[r[u]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|f,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Bq=(r,e,t)=>{let n=e[e.length-1]==="=",i=(1<<t)-1,s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s},St=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Dc({prefix:e,name:r,encode(i){return Bq(i,n,t)},decode(i){return Lq(i,n,t,r)}})});var ug={};Pe(ug,{identity:()=>Mq});var Mq,$R=$e(()=>{ni();Ys();Mq=Dc({prefix:"\0",name:"identity",encode:r=>VR(r),decode:r=>KR(r)})});var fg={};Pe(fg,{base2:()=>Uq});var Uq,HR=$e(()=>{ni();Uq=St({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1})});var hg={};Pe(hg,{base8:()=>Fq});var Fq,WR=$e(()=>{ni();Fq=St({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3})});var dg={};Pe(dg,{base10:()=>Kq});var Kq,GR=$e(()=>{ni();Kq=Qs({prefix:"9",name:"base10",alphabet:"0123456789"})});var pg={};Pe(pg,{base16:()=>Vq,base16upper:()=>qq});var Vq,qq,YR=$e(()=>{ni();Vq=St({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),qq=St({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4})});var mg={};Pe(mg,{base32:()=>Cc,base32hex:()=>Wq,base32hexpad:()=>Yq,base32hexpadupper:()=>Qq,base32hexupper:()=>Gq,base32pad:()=>$q,base32padupper:()=>Hq,base32upper:()=>zq,base32z:()=>Xq});var Cc,zq,$q,Hq,Wq,Gq,Yq,Qq,Xq,gg=$e(()=>{ni();Cc=St({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),zq=St({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),$q=St({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Hq=St({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Wq=St({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Gq=St({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Yq=St({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Qq=St({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Xq=St({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5})});var yg={};Pe(yg,{base36:()=>jq,base36upper:()=>Zq});var jq,Zq,QR=$e(()=>{ni();jq=Qs({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Zq=Qs({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"})});var bg={};Pe(bg,{base58btc:()=>Ri,base58flickr:()=>Jq});var Ri,Jq,wg=$e(()=>{ni();Ri=Qs({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Jq=Qs({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"})});var Eg={};Pe(Eg,{base64:()=>ez,base64pad:()=>tz,base64url:()=>rz,base64urlpad:()=>nz});var ez,tz,rz,nz,XR=$e(()=>{ni();ez=St({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),tz=St({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),rz=St({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),nz=St({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6})});var xg={};Pe(xg,{base256emoji:()=>cz});function oz(r){return r.reduce((e,t)=>(e+=iz[t],e),"")}function az(r){let e=[];for(let t of r){let n=sz[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}var jR,iz,sz,cz,ZR=$e(()=>{ni();jR=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),iz=jR.reduce((r,e,t)=>(r[t]=e,r),[]),sz=jR.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);cz=Dc({prefix:"\u{1F680}",name:"base256emoji",encode:oz,decode:az})});function tI(r,e,t){e=e||[],t=t||0;for(var n=t;r>=hz;)e[t++]=r&255|JR,r/=128;for(;r&fz;)e[t++]=r&255|JR,r>>>=7;return e[t]=r|0,tI.bytes=t-n+1,e}function vg(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw vg.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&eI)<<i:(o&eI)*Math.pow(2,i),i+=7}while(o>=pz);return vg.bytes=s-n,t}var lz,JR,uz,fz,hz,dz,pz,eI,mz,gz,yz,bz,wz,Ez,xz,vz,_z,Sz,Rz,Iz,Du,rI=$e(()=>{lz=tI,JR=128,uz=127,fz=~uz,hz=Math.pow(2,31);dz=vg,pz=128,eI=127;mz=Math.pow(2,7),gz=Math.pow(2,14),yz=Math.pow(2,21),bz=Math.pow(2,28),wz=Math.pow(2,35),Ez=Math.pow(2,42),xz=Math.pow(2,49),vz=Math.pow(2,56),_z=Math.pow(2,63),Sz=function(r){return r<mz?1:r<gz?2:r<yz?3:r<bz?4:r<wz?5:r<Ez?6:r<xz?7:r<vz?8:r<_z?9:10},Rz={encode:lz,decode:dz,encodingLength:Sz},Iz=Rz,Du=Iz});var Cu,Pc,kc,Xd=$e(()=>{rI();Cu=(r,e=0)=>[Du.decode(r,e),Du.decode.bytes],Pc=(r,e,t=0)=>(Du.encode(r,e,t),e),kc=r=>Du.encodingLength(r)});var ra,nI,iI,Nc,ku=$e(()=>{Ys();Xd();ra=(r,e)=>{let t=e.byteLength,n=kc(r),i=n+kc(t),s=new Uint8Array(i+t);return Pc(r,s,0),Pc(t,s,n),s.set(e,i),new Nc(r,t,e,s)},nI=r=>{let e=rs(r),[t,n]=Cu(e),[i,s]=Cu(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new Nc(t,i,o,e)},iI=(r,e)=>r===e?!0:r.code===e.code&&r.size===e.size&&FR(r.bytes,e.bytes),Nc=class{constructor(e,t,n,i){this.code=e,this.size=t,this.digest=n,this.bytes=i}}});var Sg,_g,Rg=$e(()=>{ku();Sg=({name:r,code:e,encode:t})=>new _g(r,e,t),_g=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?ra(this.code,t):t.then(n=>ra(this.code,n))}else throw Error("Unknown type, must be binary type")}}});var Ig={};Pe(Ig,{sha256:()=>Az,sha512:()=>Tz});var oI,Az,Tz,aI=$e(()=>{Rg();oI=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Az=Sg({name:"sha2-256",code:18,encode:oI("SHA-256")}),Tz=Sg({name:"sha2-512",code:19,encode:oI("SHA-512")})});var Ag={};Pe(Ag,{identity:()=>Pz});var cI,Dz,lI,Cz,Pz,uI=$e(()=>{Ys();ku();cI=0,Dz="identity",lI=rs,Cz=r=>ra(cI,lI(r)),Pz={code:cI,name:Dz,encode:lI,digest:Cz}});var fI=$e(()=>{Ys()});var U5e,F5e,hI=$e(()=>{U5e=new TextEncoder,F5e=new TextDecoder});var Jd,Oz,Lz,Bz,Nu,Mz,dI,pI,jd,Zd,Uz,Fz,Kz,mI=$e(()=>{Xd();ku();wg();gg();Ys();Jd=class r{constructor(e,t,n,i){this.code=t,this.version=e,this.multihash=n,this.bytes=i,this.byteOffset=i.byteOffset,this.byteLength=i.byteLength,this.asCID=this,this._baseCache=new Map,Object.defineProperties(this,{byteOffset:Zd,byteLength:Zd,code:jd,version:jd,multihash:jd,bytes:jd,_baseCache:Zd,asCID:Zd})}toV0(){switch(this.version){case 0:return this;default:{let{code:e,multihash:t}=this;if(e!==Nu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Mz)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=ra(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}equals(e){return e&&this.code===e.code&&this.version===e.version&&iI(this.multihash,e.multihash)}toString(e){let{bytes:t,version:n,_baseCache:i}=this;switch(n){case 0:return Lz(t,i,e||Ri.encoder);default:return Bz(t,i,e||Cc.encoder)}}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID("+this.toString()+")"}static isCID(e){return Fz(/^0\.0/,Kz),!!(e&&(e[pI]||e.asCID===e))}get toBaseEncodedString(){throw new Error("Deprecated, use .toString()")}get codec(){throw new Error('"codec" property is deprecated, use integer "code" property instead')}get buffer(){throw new Error("Deprecated .buffer property, use .bytes to get Uint8Array instead")}get multibaseName(){throw new Error('"multibaseName" property is deprecated')}get prefix(){throw new Error('"prefix" property is deprecated')}static asCID(e){if(e instanceof r)return e;if(e!=null&&e.asCID===e){let{version:t,code:n,multihash:i,bytes:s}=e;return new r(t,n,i,s||dI(t,n,i.bytes))}else if(e!=null&&e[pI]===!0){let{version:t,multihash:n,code:i}=e,s=nI(n);return r.create(t,i,s)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");switch(e){case 0:{if(t!==Nu)throw new Error(`Version 0 CID must use dag-pb (code: ${Nu}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let i=dI(e,t,n.bytes);return new r(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,Nu,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,i=rs(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");let s=i.subarray(t.multihashSize-t.digestSize),o=new Nc(t.multihashCode,t.digestSize,s,i);return[t.version===0?r.createV0(o):r.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=Cu(e.subarray(t));return t+=h,f},i=n(),s=Nu;if(i===18?(i=0,t=0):i===1&&(s=n()),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);let o=t,a=n(),c=n(),l=t+c,u=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,i]=Oz(e,t),s=r.decode(i);return s._baseCache.set(n,e),s}},Oz=(r,e)=>{switch(r[0]){case"Q":{let t=e||Ri;return[Ri.prefix,t.decode(`${Ri.prefix}${r}`)]}case Ri.prefix:{let t=e||Ri;return[Ri.prefix,t.decode(r)]}case Cc.prefix:{let t=e||Cc;return[Cc.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Lz=(r,e,t)=>{let{prefix:n}=t;if(n!==Ri.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let i=e.get(n);if(i==null){let s=t.encode(r).slice(1);return e.set(n,s),s}else return i},Bz=(r,e,t)=>{let{prefix:n}=t,i=e.get(n);if(i==null){let s=t.encode(r);return e.set(n,s),s}else return i},Nu=112,Mz=18,dI=(r,e,t)=>{let n=kc(r),i=n+kc(e),s=new Uint8Array(i+t.byteLength);return Pc(r,s,0),Pc(e,s,n),s.set(t,i),s},pI=Symbol.for("@ipld/js-cid/CID"),jd={writable:!1,configurable:!1,enumerable:!0},Zd={writable:!1,enumerable:!1,configurable:!1},Uz="0.0.0-dev",Fz=(r,e)=>{if(r.test(Uz))console.warn(e);else throw new Error(e)},Kz=`CID.isCID(v) is deprecated and will be removed in the next major release.
Following code pattern:

if (CID.isCID(value)) {
  doSomethingWithCID(value)
}

Is replaced with:

const cid = CID.asCID(value)
if (cid) {
  // Make sure to use cid instead of value
  doSomethingWithCID(cid)
}
`});var gI=$e(()=>{mI();Xd();Ys();Rg();ku()});var Tg,G5e,yI=$e(()=>{$R();HR();WR();GR();YR();gg();QR();wg();XR();ZR();aI();uI();fI();hI();gI();Tg={...ug,...fg,...hg,...dg,...pg,...mg,...yg,...bg,...Eg,...xg},G5e={...Ig,...Ag}});function Oc(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}var e1=$e(()=>{});function t1(r=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?Oc(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}var Dg=$e(()=>{e1()});function wI(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var bI,Cg,Vz,r1,Pg=$e(()=>{yI();Dg();bI=wI("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),Cg=wI("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=t1(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),Vz={utf8:bI,"utf-8":bI,hex:Tg.base16,latin1:Cg,ascii:Cg,binary:Cg,...Tg},r1=Vz});var EI={};Pe(EI,{toString:()=>qz});function qz(r,e="utf8"){let t=r1[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var xI=$e(()=>{Pg()});var vI={};Pe(vI,{fromString:()=>zz});function zz(r,e="utf8"){let t=r1[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?Oc(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}var _I=$e(()=>{Pg();e1()});var SI={};Pe(SI,{concat:()=>$z});function $z(r,e){e||(e=r.reduce((i,s)=>i+s.length,0));let t=t1(e),n=0;for(let i of r)t.set(i,n),n+=i.length;return Oc(t)}var RI=$e(()=>{Dg();e1()});var Ng=F((oye,PI)=>{"use strict";var II=_R(),Lc=OR(),{names:Ou}=BR(),{toString:n1}=(xI(),Ku(EI)),{fromString:Hz}=(_I(),Ku(vI)),{concat:Wz}=(RI(),Ku(SI)),Bc={};for(let r in Ou){let e=r;Bc[Ou[e]]=e}Object.freeze(Bc);function Gz(r){if(!(r instanceof Uint8Array))throw new Error("must be passed a Uint8Array");return n1(r,"base16")}function Yz(r){return Hz(r,"base16")}function Qz(r){if(!(r instanceof Uint8Array))throw new Error("must be passed a Uint8Array");return n1(II.encode("base58btc",r)).slice(1)}function Xz(r){let e=r instanceof Uint8Array?n1(r):r;return II.decode("z"+e)}function AI(r){if(!(r instanceof Uint8Array))throw new Error("multihash must be a Uint8Array");if(r.length<2)throw new Error("multihash too short. must be > 2 bytes.");let e=Lc.decode(r);if(!DI(e))throw new Error(`multihash unknown function code: 0x${e.toString(16)}`);r=r.slice(Lc.decode.bytes);let t=Lc.decode(r);if(t<0)throw new Error(`multihash invalid length: ${t}`);if(r=r.slice(Lc.decode.bytes),r.length!==t)throw new Error(`multihash length inconsistent: 0x${n1(r,"base16")}`);return{code:e,name:Bc[e],length:t,digest:r}}function jz(r,e,t){if(!r||e===void 0)throw new Error("multihash encode requires at least two args: digest, code");let n=TI(e);if(!(r instanceof Uint8Array))throw new Error("digest should be a Uint8Array");if(t==null&&(t=r.length),t&&r.length!==t)throw new Error("digest length should be equal to specified length.");let i=Lc.encode(n),s=Lc.encode(t);return Wz([i,s,r],i.length+s.length+r.length)}function TI(r){let e=r;if(typeof r=="string"){if(Ou[r]===void 0)throw new Error(`Unrecognized hash function named: ${r}`);e=Ou[r]}if(typeof e!="number")throw new Error(`Hash function code should be a number. Got: ${e}`);if(Bc[e]===void 0&&!kg(e))throw new Error(`Unrecognized function code: ${e}`);return e}function kg(r){return r>0&&r<16}function DI(r){return!!(kg(r)||Bc[r])}function CI(r){AI(r)}function Zz(r){return CI(r),r.subarray(0,2)}PI.exports={names:Ou,codes:Bc,toHexString:Gz,fromHexString:Yz,toB58String:Qz,fromB58String:Xz,decode:AI,encode:jz,coerceCode:TI,isAppCode:kg,validate:CI,prefix:Zz,isValidCode:DI}});var YI=F(c1=>{"use strict";Object.defineProperty(c1,"__esModule",{value:!0});var Ug=class{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;let t={value:e,done:!1};if(this.pullQueue.length){let n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(let e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(let t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{let t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{let t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,i)=>{this.pullQueue.push({resolve:n,reject:i})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}},a1=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){let i=new Ug;i.highWaterMark=t,i.lowWaterMark=n,i.removeCallback=e({push:s=>i.push(s),stop:()=>i.stop(),fail:s=>i.fail(s),on:(s,o)=>{i.eventHandlers[s]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>i[Symbol.asyncIterator](),Object.freeze(this)}};c1.EventIterator=a1;c1.default=a1});var QI=F(Lu=>{"use strict";Object.defineProperty(Lu,"__esModule",{value:!0});var Fg=YI();Lu.EventIterator=Fg.EventIterator;function o$(r,e,t){return new Fg.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}Lu.subscribe=o$;Lu.default=Fg.EventIterator});var Vg=F(($ye,rA)=>{"use strict";var a$=typeof navigator<"u"&&navigator.product==="ReactNative";function c$(){return a$?"http://localhost":self.location?self.location.protocol+"//"+self.location.host:""}var Bu=self.URL,tA=c$(),Kg=class{constructor(e="",t=tA){this.super=new Bu(e,t),this.path=this.pathname+this.search,this.auth=this.username&&this.password?this.username+":"+this.password:null,this.query=this.search&&this.search.startsWith("?")?this.search.slice(1):null}get hash(){return this.super.hash}get host(){return this.super.host}get hostname(){return this.super.hostname}get href(){return this.super.href}get origin(){return this.super.origin}get password(){return this.super.password}get pathname(){return this.super.pathname}get port(){return this.super.port}get protocol(){return this.super.protocol}get search(){return this.super.search}get searchParams(){return this.super.searchParams}get username(){return this.super.username}set hash(e){this.super.hash=e}set host(e){this.super.host=e}set hostname(e){this.super.hostname=e}set href(e){this.super.href=e}set password(e){this.super.password=e}set pathname(e){this.super.pathname=e}set port(e){this.super.port=e}set protocol(e){this.super.protocol=e}set search(e){this.super.search=e}set username(e){this.super.username=e}static createObjectURL(e){return Bu.createObjectURL(e)}static revokeObjectURL(e){Bu.revokeObjectURL(e)}toJSON(){return this.super.toJSON()}toString(){return this.super.toString()}format(){return this.toString()}};function l$(r){if(typeof r=="string")return new Bu(r).toString();if(!(r instanceof Bu)){let e=r.username&&r.password?`${r.username}:${r.password}@`:"",t=r.auth?r.auth+"@":"",n=r.port?":"+r.port:"",i=r.protocol?r.protocol+"//":"",s=r.host||"",o=r.hostname||"",a=r.search||(r.query?"?"+r.query:""),c=r.hash||"",l=r.pathname||"",u=r.path||l+a;return`${i}${e||t}${s||o+n}${u}${c}`}}rA.exports={URLWithLegacySupport:Kg,URLSearchParams:self.URLSearchParams,defaultBase:tA,format:l$}});var sA=F((Hye,iA)=>{"use strict";var{URLWithLegacySupport:nA,format:u$}=Vg();iA.exports=(r,e={},t={},n)=>{let i=e.protocol?e.protocol.replace(":",""):"http";i=(t[i]||n||i)+":";let s;try{s=new nA(r)}catch{s={}}let o=Object.assign({},e,{protocol:i||s.protocol,host:e.host||s.host});return new nA(r,u$(o)).toString()}});var aA=F((Wye,oA)=>{"use strict";var{URLWithLegacySupport:f$,format:h$,URLSearchParams:d$,defaultBase:p$}=Vg(),m$=sA();oA.exports={URL:f$,URLSearchParams:d$,format:h$,relative:m$,defaultBase:p$}});var hA=F((Zye,fA)=>{function b$(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}fA.exports=b$});var LA=F((x9e,OA)=>{function Nn(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}OA.exports=Nn;Nn.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Nn.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Nn.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};Nn.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Nn.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};Nn.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};Nn.prototype.start=Nn.prototype.try;Nn.prototype.errors=function(){return this._errors};Nn.prototype.attempts=function(){return this._attempts};Nn.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var i=this._errors[n],s=i.message,o=(r[s]||0)+1;r[s]=o,o>=t&&(e=i,t=o)}return e}});var BA=F(na=>{var P$=LA();na.operation=function(r){var e=na.timeouts(r);return new P$(e,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};na.timeouts=function(r){if(r instanceof Array)return[].concat(r);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in r)e[t]=r[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],i=0;i<e.retries;i++)n.push(this.createTimeout(i,e));return r&&r.forever&&!n.length&&n.push(this.createTimeout(i,e)),n.sort(function(s,o){return s-o}),n};na.createTimeout=function(r,e){var t=e.randomize?Math.random()+1:1,n=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,r));return n=Math.min(n,e.maxTimeout),n};na.wrap=function(r,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var n in r)typeof r[n]=="function"&&t.push(n)}for(var i=0;i<t.length;i++){var s=t[i],o=r[s];r[s]=function(c){var l=na.operation(e),u=Array.prototype.slice.call(arguments,1),f=u.pop();u.push(function(h){l.retry(h)||(h&&(arguments[0]=l.mainError()),f.apply(this,arguments))}),l.attempt(function(){c.apply(r,u)})}.bind(r,o),r[s].options=e}}});var UA=F((_9e,MA)=>{MA.exports=BA()});var j$={};Pe(j$,{createHelia:()=>Y$});var qr=de(_1(),1);var T1={};Pe(T1,{base32:()=>Mt,base32hex:()=>KT,base32hexpad:()=>qT,base32hexpadupper:()=>zT,base32hexupper:()=>VT,base32pad:()=>UT,base32padupper:()=>FT,base32upper:()=>T8,base32z:()=>$T});function NT(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,g=0,y=0,w=p.length;y!==w&&p[y]===0;)y++,m++;for(var E=(w-y)*u+1>>>0,R=new Uint8Array(E);y!==w;){for(var x=p[y],v=0,I=E-1;(x!==0||v<g)&&I!==-1;I--,v++)x+=256*R[I]>>>0,R[I]=x%a>>>0,x=x/a>>>0;if(x!==0)throw new Error("Non-zero carry");g=v,y++}for(var _=E-g;_!==E&&R[_]===0;)_++;for(var k=c.repeat(m);_<E;++_)k+=r.charAt(R[_]);return k}function h(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var g=0,y=0;p[m]===c;)g++,m++;for(var w=(p.length-m)*l+1>>>0,E=new Uint8Array(w);p[m];){var R=t[p.charCodeAt(m)];if(R===255)return;for(var x=0,v=w-1;(R!==0||x<y)&&v!==-1;v--,x++)R+=a*E[v]>>>0,E[v]=R%256>>>0,R=R/256>>>0;if(R!==0)throw new Error("Non-zero carry");y=x,m++}if(p[m]!==" "){for(var I=w-y;I!==w&&E[I]===0;)I++;for(var _=new Uint8Array(g+(w-I)),k=g;I!==w;)_[k++]=E[I++];return _}}}function d(p){var m=h(p);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var OT=NT,LT=OT,v8=LT;var rH=new Uint8Array(0);var _8=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Ai=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var S8=r=>new TextEncoder().encode(r),R8=r=>new TextDecoder().decode(r);var S1=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},R1=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return A8(this,e)}},I1=class{constructor(e){this.decoders=e}or(e){return A8(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},A8=(r,e)=>new I1({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}}),A1=class{constructor(e,t,n,i){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new S1(e,t,n),this.decoder=new R1(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},aa=({name:r,prefix:e,encode:t,decode:n})=>new A1(r,e,t,n),is=({prefix:r,name:e,alphabet:t})=>{let{encode:n,decode:i}=v8(t,e);return aa({prefix:r,name:e,encode:n,decode:s=>Ai(i(s))})},BT=(r,e,t,n)=>{let i={};for(let u=0;u<e.length;++u)i[e[u]]=u;let s=r.length;for(;r[s-1]==="=";)--s;let o=new Uint8Array(s*t/8|0),a=0,c=0,l=0;for(let u=0;u<s;++u){let f=i[r[u]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|f,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},MT=(r,e,t)=>{let n=e[e.length-1]==="=",i=(1<<t)-1,s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s},wt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>aa({prefix:e,name:r,encode(i){return MT(i,n,t)},decode(i){return BT(i,n,t,r)}});var Mt=wt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),T8=wt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),UT=wt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),FT=wt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),KT=wt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),VT=wt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),qT=wt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),zT=wt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),$T=wt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var D1={};Pe(D1,{base58btc:()=>Ee,base58flickr:()=>HT});var Ee=is({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),HT=is({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var P1={};Pe(P1,{base64:()=>oi,base64pad:()=>WT,base64url:()=>C1,base64urlpad:()=>GT});var oi=wt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),WT=wt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),C1=wt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),GT=wt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});qr.default.formatters.b=r=>r==null?"undefined":Ee.baseEncode(r);qr.default.formatters.t=r=>r==null?"undefined":Mt.baseEncode(r);qr.default.formatters.m=r=>r==null?"undefined":oi.baseEncode(r);qr.default.formatters.p=r=>r==null?"undefined":r.toString();qr.default.formatters.c=r=>r==null?"undefined":r.toString();qr.default.formatters.k=r=>r==null?"undefined":r.toString();qr.default.formatters.a=r=>r==null?"undefined":r.toString();function YT(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function D(r){let e=YT(`${r}:trace`);return qr.default.enabled(`${r}:trace`)&&qr.default.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=(0,qr.default)(`${r}:trace`)),Object.assign((0,qr.default)(r),{error:(0,qr.default)(`${r}:error`),trace:e})}var ca={};Pe(ca,{abortedError:()=>eD,closeFailedError:()=>jT,deleteFailedError:()=>k8,getFailedError:()=>ZT,hasFailedError:()=>JT,notFoundError:()=>Vc,openFailedError:()=>XT,putFailedError:()=>P8});var Ti=de(ro(),1);function XT(r){return r=r??new Error("Open failed"),(0,Ti.default)(r,"ERR_OPEN_FAILED")}function jT(r){return r=r??new Error("Close failed"),(0,Ti.default)(r,"ERR_CLOSE_FAILED")}function P8(r){return r=r??new Error("Put failed"),(0,Ti.default)(r,"ERR_PUT_FAILED")}function ZT(r){return r=r??new Error("Get failed"),(0,Ti.default)(r,"ERR_GET_FAILED")}function k8(r){return r=r??new Error("Delete failed"),(0,Ti.default)(r,"ERR_DELETE_FAILED")}function JT(r){return r=r??new Error("Has failed"),(0,Ti.default)(r,"ERR_HAS_FAILED")}function Vc(r){return r=r??new Error("Not Found"),(0,Ti.default)(r,"ERR_NOT_FOUND")}function eD(r){return r=r??new Error("Aborted"),(0,Ti.default)(r,"ERR_ABORTED")}var no=class{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(let{cid:n,block:i}of e)await this.put(n,i,t),yield n}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(let n of e)yield{cid:n,block:await this.get(n,t)}}async delete(e,t){await Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(let n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}};var fn={};Pe(fn,{Digest:()=>io,create:()=>On,decode:()=>Ln,equals:()=>N1});var tD=L8,N8=128,rD=127,nD=~rD,iD=Math.pow(2,31);function L8(r,e,t){e=e||[],t=t||0;for(var n=t;r>=iD;)e[t++]=r&255|N8,r/=128;for(;r&nD;)e[t++]=r&255|N8,r>>>=7;return e[t]=r|0,L8.bytes=t-n+1,e}var sD=k1,oD=128,O8=127;function k1(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw k1.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&O8)<<i:(o&O8)*Math.pow(2,i),i+=7}while(o>=oD);return k1.bytes=s-n,t}var aD=Math.pow(2,7),cD=Math.pow(2,14),lD=Math.pow(2,21),uD=Math.pow(2,28),fD=Math.pow(2,35),hD=Math.pow(2,42),dD=Math.pow(2,49),pD=Math.pow(2,56),mD=Math.pow(2,63),gD=function(r){return r<aD?1:r<cD?2:r<lD?3:r<uD?4:r<fD?5:r<hD?6:r<dD?7:r<pD?8:r<mD?9:10},yD={encode:tD,decode:sD,encodingLength:gD},bD=yD,qc=bD;var zc=(r,e=0)=>[qc.decode(r,e),qc.decode.bytes],la=(r,e,t=0)=>(qc.encode(r,e,t),e),ua=r=>qc.encodingLength(r);var On=(r,e)=>{let t=e.byteLength,n=ua(r),i=n+ua(t),s=new Uint8Array(i+t);return la(r,s,0),la(t,s,n),s.set(e,i),new io(r,t,e,s)},Ln=r=>{let e=Ai(r),[t,n]=zc(e),[i,s]=zc(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new io(t,i,o,e)},N1=(r,e)=>{if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&_8(r.bytes,t.bytes)}},io=class{constructor(e,t,n,i){this.code=e,this.size=t,this.digest=n,this.bytes=i}};var B8=(r,e)=>{let{bytes:t,version:n}=r;switch(n){case 0:return ED(t,O1(r),e||Ee.encoder);default:return xD(t,O1(r),e||Mt.encoder)}};var M8=new WeakMap,O1=r=>{let e=M8.get(r);if(e==null){let t=new Map;return M8.set(r,t),t}return e},be=class r{constructor(e,t,n,i){this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==$c)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==vD)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=On(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n&&e.code===n.code&&e.version===n.version&&N1(e.multihash,n.multihash)}toString(e){return B8(this,e)}toJSON(){return{"/":B8(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:i,multihash:s,bytes:o}=t;return new r(n,i,s,o||U8(n,i,s.bytes))}else if(t[_D]===!0){let{version:n,multihash:i,code:s}=t,o=Ln(i);return r.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==$c)throw new Error(`Version 0 CID must use dag-pb (code: ${$c}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let i=U8(e,t,n.bytes);return new r(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,$c,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,i=Ai(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");let s=i.subarray(t.multihashSize-t.digestSize),o=new io(t.multihashCode,t.digestSize,s,i);return[t.version===0?r.createV0(o):r.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=zc(e.subarray(t));return t+=h,f},i=n(),s=$c;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);let o=t,a=n(),c=n(),l=t+c,u=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,i]=wD(e,t),s=r.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return O1(s).set(n,e),s}},wD=(r,e)=>{switch(r[0]){case"Q":{let t=e||Ee;return[Ee.prefix,t.decode(`${Ee.prefix}${r}`)]}case Ee.prefix:{let t=e||Ee;return[Ee.prefix,t.decode(r)]}case Mt.prefix:{let t=e||Mt;return[Mt.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},ED=(r,e,t)=>{let{prefix:n}=t;if(n!==Ee.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let i=e.get(n);if(i==null){let s=t.encode(r).slice(1);return e.set(n,s),s}else return i},xD=(r,e,t)=>{let{prefix:n}=t,i=e.get(n);if(i==null){let s=t.encode(r);return e.set(n,s),s}else return i},$c=112,vD=18,U8=(r,e,t)=>{let n=ua(r),i=n+ua(e),s=new Uint8Array(i+t.byteLength);return la(r,s,0),la(e,s,n),s.set(t,i),s},_D=Symbol.for("@ipld/js-cid/CID");var $u=85;var Hc=class extends no{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(Mt.encode(e.multihash.bytes),t),e}get(e){let t=this.data.get(Mt.encode(e.multihash.bytes));if(t==null)throw Vc();return t}has(e){return this.data.has(Mt.encode(e.multihash.bytes))}async delete(e){this.data.delete(Mt.encode(e.multihash.bytes))}async*getAll(){for(let[e,t]of this.data.entries())yield{cid:be.createV1($u,Ln(Mt.decode(e))),block:t}}};function SD(r){return r[Symbol.asyncIterator]!=null}function RD(r){if(SD(r))return(async()=>{for await(let e of r);})();for(let e of r);}var Cr=RD;function ID(r){let[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:i=>{n.push(i)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}var fa=ID;function AD(r){return r[Symbol.asyncIterator]!=null}function TD(r,e){if(AD(r))return async function*(){for await(let a of r)await e(a)&&(yield a)}();let t=fa(r),{value:n,done:i}=t.next();if(i===!0)return function*(){}();let s=e(n);if(typeof s.then=="function")return async function*(){await s&&(yield n);for await(let a of t)await e(a)&&(yield a)}();let o=e;return function*(){s===!0&&(yield n);for(let a of t)o(a)&&(yield a)}()}var wr=TD;function ge(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var Hu=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},ha=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new Hu(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new Hu(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var B1=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Et(r={}){return K8(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function F8(r={}){return K8(t=>{let n,i=[];for(;!t.isEmpty()&&(n=t.shift(),n!=null);){if(n.error!=null)throw n.error;n.done===!1&&i.push(n.value)}return n==null?{done:!0}:{done:n.done===!0,value:i}},r)}function K8(r,e){e=e??{};let t=e.onEnd,n=new ha,i,s,o,a=ge(),c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((g,y)=>{s=w=>{s=null,n.push(w);try{g(r(n))}catch(E){y(E)}return i}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=ge()})}},l=g=>s!=null?s(g):(n.push(g),i),u=g=>(n=new ha,s!=null?s({error:g}):(n.push({error:g}),i)),f=g=>{if(o)return i;if(e?.objectMode!==!0&&g?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:g})},h=g=>o?i:(o=!0,g!=null?u(g):l({done:!0})),d=()=>(n=new ha,h(),{done:!0}),p=g=>(h(g),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:c,return:d,throw:p,push:f,end:h,get readableLength(){return n.size},onEmpty:async g=>{let y=g?.signal;if(y?.throwIfAborted(),n.isEmpty())return;let w,E;y!=null&&(w=new Promise((R,x)=>{E=()=>{x(new B1)},y.addEventListener("abort",E)}));try{await Promise.race([a.promise,w])}finally{E!=null&&y!=null&&y?.removeEventListener("abort",E)}}},t==null)return i;let m=i;return i={[Symbol.asyncIterator](){return this},next(){return m.next()},throw(g){return m.throw(g),t!=null&&(t(g),t=void 0),{done:!0}},return(){return m.return(),t!=null&&(t(),t=void 0),{done:!0}},push:f,end(g){return m.end(g),t!=null&&(t(g),t=void 0),i},get readableLength(){return m.readableLength}},i}function DD(r){return r[Symbol.asyncIterator]!=null}function CD(...r){let e=[];for(let t of r)DD(t)||e.push(t);return e.length===r.length?function*(){for(let t of e)yield*t}():async function*(){let t=Et({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(r.map(async n=>{for await(let i of n)t.push(i)})),t.end()}catch(n){t.end(n)}}),yield*t}()}var Ut=CD;var GH=D("blockstore:core:tiered");var jH={...ca};var V8=de(ro(),1);function Wu(r){return r=r??new Error("Not Found"),(0,V8.default)(r,"ERR_NOT_FOUND")}var q8=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");function Di(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}var M1={};Pe(M1,{base10:()=>PD});var PD=is({prefix:"9",name:"base10",alphabet:"0123456789"});var U1={};Pe(U1,{base16:()=>kD,base16upper:()=>ND});var kD=wt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),ND=wt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var F1={};Pe(F1,{base2:()=>OD});var OD=wt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var K1={};Pe(K1,{base256emoji:()=>FD});var z8=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),LD=z8.reduce((r,e,t)=>(r[t]=e,r),[]),BD=z8.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function MD(r){return r.reduce((e,t)=>(e+=LD[t],e),"")}function UD(r){let e=[];for(let t of r){let n=BD[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}var FD=aa({prefix:"\u{1F680}",name:"base256emoji",encode:MD,decode:UD});var V1={};Pe(V1,{base36:()=>ss,base36upper:()=>KD});var ss=is({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),KD=is({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var q1={};Pe(q1,{base8:()=>VD});var VD=wt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var z1={};Pe(z1,{identity:()=>qD});var qD=aa({prefix:"\0",name:"identity",encode:r=>R8(r),decode:r=>S8(r)});var dW=new TextEncoder,pW=new TextDecoder;var $8=512;var $1={};Pe($1,{identity:()=>hn});var W8=0,zD="identity",G8=Ai,$D=r=>On(W8,G8(r)),hn={code:W8,name:zD,encode:G8,digest:$D};var Y1={};Pe(Y1,{sha256:()=>Oe,sha512:()=>G1});var W1=({name:r,code:e,encode:t})=>new H1(r,e,t),H1=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?On(this.code,t):t.then(n=>On(this.code,n))}else throw Error("Unknown type, must be binary type")}};var Q8=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Oe=W1({name:"sha2-256",code:18,encode:Q8("SHA-256")}),G1=W1({name:"sha2-512",code:19,encode:Q8("SHA-512")});var dn={...z1,...F1,...q1,...M1,...U1,...T1,...V1,...D1,...P1,...K1},xW={...Y1,...$1};function Ci(r=0){return globalThis.Buffer?.alloc!=null?Di(globalThis.Buffer.alloc(r)):new Uint8Array(r)}function zt(r=0){return globalThis.Buffer?.allocUnsafe!=null?Di(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function j8(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var X8=j8("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),Q1=j8("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=zt(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),HD={utf8:X8,"utf-8":X8,hex:dn.base16,latin1:Q1,ascii:Q1,binary:Q1,...dn},Gu=HD;function Y(r,e="utf8"){let t=Gu[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?Di(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}function H(r,e="utf8"){let t=Gu[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var Pi="/",Z8=new TextEncoder().encode(Pi),Yu=Z8[0],tt=class r{_buf;constructor(e,t){if(typeof e=="string")this._buf=Y(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Yu)throw new Error("Invalid key")}toString(e="utf8"){return H(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new r(e.join(Pi))}static random(){return new r(q8().replace(/-/g,""))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new r(e):typeof e.uint8Array=="function"?new r(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=Z8),this._buf[0]!==Yu){let e=new Uint8Array(this._buf.byteLength+1);e.fill(Yu,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Yu;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),n=e.list();for(let i=0;i<t.length;i++){if(n.length<i+1)return!1;let s=t[i],o=n[i];if(s<o)return!0;if(s>o)return!1}return t.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Pi).slice(1)}type(){return WD(this.baseNamespace())}name(){return GD(this.baseNamespace())}instance(e){return new r(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Pi)||(e+=Pi),e+=this.type(),new r(e)}parent(){let e=this.list();return e.length===1?new r(Pi):new r(e.slice(0,-1).join(Pi))}child(e){return this.toString()===Pi?e:e.toString()===Pi?this:new r(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return r.withNamespaces([...this.namespaces(),...YD(e.map(t=>t.namespaces()))])}};function WD(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function GD(r){let e=r.split(":");return e[e.length-1]}function YD(r){return[].concat(...r)}var J8="SHARDING";function XD(r){return r[Symbol.asyncIterator]!=null}function jD(r){if(XD(r))return(async()=>{let t=[];for await(let n of r)t.push(n);return t})();let e=[];for(let t of r)e.push(t);return e}var Gc=jD;function ZD(r){return r[Symbol.asyncIterator]!=null}function JD(r,e){return ZD(r)?async function*(){yield*(await Gc(r)).sort(e)}():function*(){yield*Gc(r).sort(e)}()}var Qu=JD;function eC(r){return r[Symbol.asyncIterator]!=null}function tC(r,e){return eC(r)?async function*(){let t=0;if(!(e<1)){for await(let n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(let n of r)if(yield n,t++,t===e)return}}()}var os=tC;var ki=class{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:n,value:i}of e)await this.put(n,i,t),yield n}async*getMany(e,t={}){for await(let n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(let n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,i){e.push({key:n,value:i})},delete(n){t.push(n)},commit:async n=>{await Cr(this.putMany(e,n)),e=[],await Cr(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){let i=e.prefix;n=wr(n,s=>s.key.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,s)=>wr(i,s),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,s)=>Qu(i,s),n)),e.offset!=null){let i=0,s=e.offset;n=wr(n,()=>i++>=s)}return e.limit!=null&&(n=os(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){let i=e.prefix;n=wr(n,s=>s.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,s)=>wr(i,s),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,s)=>Qu(i,s),n)),e.offset!=null){let i=e.offset,s=0;n=wr(n,()=>s++>=i)}return e.limit!=null&&(n=os(n,e.limit)),n}};var so=class extends ki{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(e.toString(),t),e}get(e){let t=this.data.get(e.toString());if(t==null)throw Wu();return t}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(let[e,t]of this.data.entries())yield{key:new tt(e),value:t}}*_allKeys(){for(let e of this.data.keys())yield new tt(e)}};function rC(r){return r[Symbol.asyncIterator]!=null}function nC(r,e){if(rC(r))return async function*(){for await(let a of r)yield e(a)}();let t=fa(r),{value:n,done:i}=t.next();if(i===!0)return function*(){}();let s=e(n);if(typeof s.then=="function")return async function*(){yield await s;for await(let a of t)yield e(a)}();let o=e;return function*(){yield s;for(let a of t)yield o(a)}()}var zr=nC;function Te(r,...e){if(r==null)throw new Error("Empty pipeline");if(X1(r)){let n=r;r=()=>n.source}else if(t6(r)||e6(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&X1(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)X1(t[n])&&(t[n]=sC(t[n]));return iC(...t)}var iC=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},e6=r=>r?.[Symbol.asyncIterator]!=null,t6=r=>r?.[Symbol.iterator]!=null,X1=r=>r==null?!1:r.sink!=null&&r.source!=null,sC=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=Et({objectMode:!0});t.then(()=>{n.end()},o=>{n.end(o)});let i,s=r.source;if(e6(s))i=async function*(){yield*s,n.end()};else if(t6(s))i=function*(){yield*s,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Ut(n,i())}return r.source};var dG=new tt(J8);var RG=D("datastore:core:tiered");function Xu(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function da(...r){let e=[];for(let t of r)Xu(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function pa(...r){let e=[];for(let t of r)Xu(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}var Le=class extends Event{constructor(e,t){super(e),this.detail=t}};function xt(r){let e=new globalThis.AbortController;function t(){e.abort();for(let s of r)s?.removeEventListener!=null&&s.removeEventListener("abort",t)}for(let s of r){if(s?.aborted===!0){t();break}s?.addEventListener!=null&&s.addEventListener("abort",t)}function n(){for(let s of r)s?.removeEventListener!=null&&s.removeEventListener("abort",t)}let i=e.signal;return i.clear=n,i}function cC(r){return r[Symbol.asyncIterator]!=null}function lC(r,e){if(cC(r))return async function*(){for await(let a of r)await e(a),yield a}();let t=fa(r),{value:n,done:i}=t.next();if(i===!0)return function*(){}();if(typeof e(n)?.then=="function")return async function*(){yield n;for await(let a of t)await e(a),yield a}();let o=e;return function*(){yield n;for(let a of t)o(a),yield a}()}var oo=lC;var j1=class extends Map{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function ai(r){let{name:e,metrics:t}=r,n;return t!=null?n=new j1({name:e,metrics:t}):n=new Map,n}var Bn=class r extends Error{code;type;constructor(e="The operation was aborted"){super(e),this.code=r.code,this.type=r.type}static code="ABORT_ERR";static type="aborted"},b=class extends Error{code;props;constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}},Yc=class r extends Error{code;constructor(e="Unexpected Peer"){super(e),this.code=r.code}static code="ERR_UNEXPECTED_PEER"},ao=class r extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=r.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"};var B6=de(g6(),1);function ce(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var co=class{_refCounter;cid;priority;wantType;constructor(e,t,n){this._refCounter=1,this.cid=e,this.priority=t??1,this.wantType=n}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(Ee)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(e){return this._refCounter===e._refCounter&&this.cid.equals(e.cid)&&this.priority===e.priority&&this.wantType===e.wantType}};var as=class{entry;cancel;sendDontHave;constructor(e,t,n,i,s){this.entry=new co(e,t,n),this.cancel=!!i,this.sendDontHave=!!s}get cid(){return this.entry.cid}set cid(e){this.entry.cid=e}get priority(){return this.entry.priority}set priority(e){this.entry.priority=e}get wantType(){return this.entry.wantType}set wantType(e){this.entry.wantType=e}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(Ee)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(e){return this.cancel===e.cancel&&this.sendDontHave===e.sendDontHave&&this.wantType===e.wantType&&this.entry.equals(e.entry)}};var pn=(r,e)=>{let t=["bitswap"];return e!=null&&t.push(e),r!=null&&t.push(`${r.toString().slice(0,8)}`),D(t.join(":"))};var ju=(r,e)=>{if(r.size!==e.size)return!1;for(let[t,n]of r){let i=e.get(t);if(i===void 0||n instanceof Uint8Array&&i instanceof Uint8Array&&!ce(n,i)||n instanceof as&&i instanceof as&&!n.equals(i))return!1}return!0};var Qc=de(I6(),1);function BC(r){let e=new Uint8Array(r.reduce((n,i)=>n+Qc.default.encodingLength(i),0)),t=0;for(let n of r)e=Qc.encode(n,e,t),t+=Qc.default.encodingLength(n);return e}var A6=BC;var tp=new Float32Array([-0]),cs=new Uint8Array(tp.buffer);function T6(r,e,t){tp[0]=r,e[t]=cs[0],e[t+1]=cs[1],e[t+2]=cs[2],e[t+3]=cs[3]}function D6(r,e){return cs[0]=r[e],cs[1]=r[e+1],cs[2]=r[e+2],cs[3]=r[e+3],tp[0]}var rp=new Float64Array([-0]),hr=new Uint8Array(rp.buffer);function C6(r,e,t){rp[0]=r,e[t]=hr[0],e[t+1]=hr[1],e[t+2]=hr[2],e[t+3]=hr[3],e[t+4]=hr[4],e[t+5]=hr[5],e[t+6]=hr[6],e[t+7]=hr[7]}function P6(r,e){return hr[0]=r[e],hr[1]=r[e+1],hr[2]=r[e+2],hr[3]=r[e+3],hr[4]=r[e+4],hr[5]=r[e+5],hr[6]=r[e+6],hr[7]=r[e+7],rp[0]}var MC=BigInt(Number.MAX_SAFE_INTEGER),UC=BigInt(Number.MIN_SAFE_INTEGER),Pr=class r{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return lo;if(e<MC&&e>UC)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,i=e-(n<<32n);return t&&(n=~n|0n,i=~i|0n,++i>k6&&(i=0n,++n>k6&&(n=0n))),new r(Number(i),Number(n))}static fromNumber(e){if(e===0)return lo;let t=e<0;t&&(e=-e);let n=e>>>0,i=(e-n)/4294967296>>>0;return t&&(i=~i>>>0,n=~n>>>0,++n>4294967295&&(n=0,++i>4294967295&&(i=0))),new r(n,i)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):lo}},lo=new Pr(0,0);lo.toBigInt=function(){return 0n};lo.zzEncode=lo.zzDecode=function(){return this};lo.length=function(){return 1};var k6=4294967296n;function N6(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function O6(r,e,t){if(t-e<1)return"";let i,s=[],o=0,a;for(;e<t;)a=r[e++],a<128?s[o++]=a:a>191&&a<224?s[o++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,s[o++]=55296+(a>>10),s[o++]=56320+(a&1023)):s[o++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,o>8191&&((i??(i=[])).push(String.fromCharCode.apply(String,s)),o=0);return i!=null?(o>0&&i.push(String.fromCharCode.apply(String,s.slice(0,o))),i.join("")):String.fromCharCode.apply(String,s.slice(0,o))}function np(r,e,t){let n=t,i,s;for(let o=0;o<r.length;++o)i=r.charCodeAt(o),i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&((s=r.charCodeAt(o+1))&64512)===56320?(i=65536+((i&1023)<<10)+(s&1023),++o,e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128);return t-n}function Mn(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function Zu(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var ip=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Mn(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Mn(this,4);return Zu(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Mn(this,4);return Zu(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Mn(this,4);let e=D6(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw Mn(this,4);let e=P6(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Mn(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return O6(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Mn(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Mn(this);while(this.buf[this.pos++]&128);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new Pr(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw Mn(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Mn(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Mn(this,8);let e=Zu(this.buf,this.pos+=4),t=Zu(this.buf,this.pos+=4);return new Pr(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){return this.readLongVarint().toNumber(!0)}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function sp(r){return new ip(r instanceof Uint8Array?r:r.subarray())}function le(r,e){let t=sp(r);return e.decode(t)}function op(r){let e=r??8192,t=e>>>1,n,i=e;return function(o){if(o<1||o>t)return zt(o);i+o>e&&(n=zt(e),i=0);let a=n.subarray(i,i+=o);return i&7&&(i=(i|7)+1),a}}var uo=class{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}};function ap(){}var lp=class{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},FC=op();function KC(r){return globalThis.Buffer!=null?zt(r):FC(r)}var Zc=class{len;head;tail;states;constructor(){this.len=0,this.head=new uo(ap,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new uo(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new up((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(Xc,10,Pr.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=Pr.fromBigInt(e);return this._push(Xc,t.length(),t)}uint64Number(e){let t=Pr.fromNumber(e);return this._push(Xc,t.length(),t)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=Pr.fromBigInt(e).zzEncode();return this._push(Xc,t.length(),t)}sint64Number(e){let t=Pr.fromNumber(e).zzEncode();return this._push(Xc,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(cp,1,e?1:0)}fixed32(e){return this._push(jc,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=Pr.fromBigInt(e);return this._push(jc,4,t.lo)._push(jc,4,t.hi)}fixed64Number(e){let t=Pr.fromNumber(e);return this._push(jc,4,t.lo)._push(jc,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(T6,4,e)}double(e){return this._push(C6,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(cp,1,0):this.uint32(t)._push(qC,t,e)}string(e){let t=N6(e);return t!==0?this.uint32(t)._push(np,t,e):this._push(cp,1,0)}fork(){return this.states=new lp(this),this.head=this.tail=new uo(ap,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new uo(ap,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=KC(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function cp(r,e,t){e[t]=r&255}function VC(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var up=class extends uo{next;constructor(e,t){super(VC,e,t),this.next=void 0}};function Xc(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function jc(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function qC(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(Zc.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(zC,e,r),this},Zc.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push($C,e,r),this});function zC(r,e,t){e.set(r,t)}function $C(r,e,t){r.length<40?np(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(Y(r),t)}function fp(){return new Zc}function ue(r,e){let t=fp();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var ma;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(ma||(ma={}));function Ju(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function ht(r){function e(i){if(r[i.toString()]==null)throw new Error("Invalid enum value");return r[i]}let t=function(s,o){let a=e(s);o.int32(a)},n=function(s){let o=s.int32();return e(o)};return Ju("enum",ma.VARINT,t,n)}function fe(r,e){return Ju("message",ma.LENGTH_DELIMITED,r,e)}var kr;(function(r){let e;(function(a){let c;(function(h){h.Block="Block",h.Have="Have"})(c=a.WantType||(a.WantType={}));let l;(function(h){h[h.Block=0]="Block",h[h.Have=1]="Have"})(l||(l={})),function(h){h.codec=()=>ht(l)}(c=a.WantType||(a.WantType={}));let u;(function(h){let d;h.codec=()=>(d==null&&(d=fe((p,m,g={})=>{g.lengthDelimited!==!1&&m.fork(),p.block!=null&&p.block.byteLength>0&&(m.uint32(10),m.bytes(p.block)),p.priority!=null&&p.priority!==0&&(m.uint32(16),m.int32(p.priority)),p.cancel!=null&&p.cancel!==!1&&(m.uint32(24),m.bool(p.cancel)),p.wantType!=null&&l[p.wantType]!==0&&(m.uint32(32),r.Wantlist.WantType.codec().encode(p.wantType,m)),p.sendDontHave!=null&&p.sendDontHave!==!1&&(m.uint32(40),m.bool(p.sendDontHave)),g.lengthDelimited!==!1&&m.ldelim()},(p,m)=>{let g={block:new Uint8Array(0),priority:0,cancel:!1,wantType:c.Block,sendDontHave:!1},y=m==null?p.len:p.pos+m;for(;p.pos<y;){let w=p.uint32();switch(w>>>3){case 1:g.block=p.bytes();break;case 2:g.priority=p.int32();break;case 3:g.cancel=p.bool();break;case 4:g.wantType=r.Wantlist.WantType.codec().decode(p);break;case 5:g.sendDontHave=p.bool();break;default:p.skipType(w&7);break}}return g})),d),h.encode=p=>ue(p,h.codec()),h.decode=p=>le(p,h.codec())})(u=a.Entry||(a.Entry={}));let f;a.codec=()=>(f==null&&(f=fe((h,d,p={})=>{if(p.lengthDelimited!==!1&&d.fork(),h.entries!=null)for(let m of h.entries)d.uint32(10),r.Wantlist.Entry.codec().encode(m,d);h.full!=null&&h.full!==!1&&(d.uint32(16),d.bool(h.full)),p.lengthDelimited!==!1&&d.ldelim()},(h,d)=>{let p={entries:[],full:!1},m=d==null?h.len:h.pos+d;for(;h.pos<m;){let g=h.uint32();switch(g>>>3){case 1:p.entries.push(r.Wantlist.Entry.codec().decode(h,h.uint32()));break;case 2:p.full=h.bool();break;default:h.skipType(g&7);break}}return p})),f),a.encode=h=>ue(h,a.codec()),a.decode=h=>le(h,a.codec())})(e=r.Wantlist||(r.Wantlist={}));let t;(function(a){let c;a.codec=()=>(c==null&&(c=fe((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.prefix!=null&&l.prefix.byteLength>0&&(u.uint32(10),u.bytes(l.prefix)),l.data!=null&&l.data.byteLength>0&&(u.uint32(18),u.bytes(l.data)),f.lengthDelimited!==!1&&u.ldelim()},(l,u)=>{let f={prefix:new Uint8Array(0),data:new Uint8Array(0)},h=u==null?l.len:l.pos+u;for(;l.pos<h;){let d=l.uint32();switch(d>>>3){case 1:f.prefix=l.bytes();break;case 2:f.data=l.bytes();break;default:l.skipType(d&7);break}}return f})),c),a.encode=l=>ue(l,a.codec()),a.decode=l=>le(l,a.codec())})(t=r.Block||(r.Block={}));let n;(function(a){a.Have="Have",a.DontHave="DontHave"})(n=r.BlockPresenceType||(r.BlockPresenceType={}));let i;(function(a){a[a.Have=0]="Have",a[a.DontHave=1]="DontHave"})(i||(i={})),function(a){a.codec=()=>ht(i)}(n=r.BlockPresenceType||(r.BlockPresenceType={}));let s;(function(a){let c;a.codec=()=>(c==null&&(c=fe((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.cid!=null&&l.cid.byteLength>0&&(u.uint32(10),u.bytes(l.cid)),l.type!=null&&i[l.type]!==0&&(u.uint32(16),r.BlockPresenceType.codec().encode(l.type,u)),f.lengthDelimited!==!1&&u.ldelim()},(l,u)=>{let f={cid:new Uint8Array(0),type:n.Have},h=u==null?l.len:l.pos+u;for(;l.pos<h;){let d=l.uint32();switch(d>>>3){case 1:f.cid=l.bytes();break;case 2:f.type=r.BlockPresenceType.codec().decode(l);break;default:l.skipType(d&7);break}}return f})),c),a.encode=l=>ue(l,a.codec()),a.decode=l=>le(l,a.codec())})(s=r.BlockPresence||(r.BlockPresence={}));let o;r.codec=()=>(o==null&&(o=fe((a,c,l={})=>{if(l.lengthDelimited!==!1&&c.fork(),a.wantlist!=null&&(c.uint32(10),r.Wantlist.codec().encode(a.wantlist,c)),a.blocks!=null)for(let u of a.blocks)c.uint32(18),c.bytes(u);if(a.payload!=null)for(let u of a.payload)c.uint32(26),r.Block.codec().encode(u,c);if(a.blockPresences!=null)for(let u of a.blockPresences)c.uint32(34),r.BlockPresence.codec().encode(u,c);a.pendingBytes!=null&&a.pendingBytes!==0&&(c.uint32(40),c.int32(a.pendingBytes)),l.lengthDelimited!==!1&&c.ldelim()},(a,c)=>{let l={blocks:[],payload:[],blockPresences:[],pendingBytes:0},u=c==null?a.len:a.pos+c;for(;a.pos<u;){let f=a.uint32();switch(f>>>3){case 1:l.wantlist=r.Wantlist.codec().decode(a,a.uint32());break;case 2:l.blocks.push(a.bytes());break;case 3:l.payload.push(r.Block.codec().decode(a,a.uint32()));break;case 4:l.blockPresences.push(r.BlockPresence.codec().decode(a,a.uint32()));break;case 5:l.pendingBytes=a.int32();break;default:a.skipType(f&7);break}}return l})),o),r.encode=a=>ue(a,r.codec()),r.decode=a=>le(a,r.codec())})(kr||(kr={}));var dr=class r{static Entry=as;static WantType={Block:kr.Wantlist.WantType.Block,Have:kr.Wantlist.WantType.Have};static BlockPresenceType={Have:kr.BlockPresenceType.Have,DontHave:kr.BlockPresenceType.DontHave};static deserialize=async(e,t)=>{let n=kr.decode(e),i=n.wantlist?.full===!0,s=new r(i);return n.wantlist?.entries.forEach(o=>{if(o.block==null)return;let a=be.decode(o.block);s.addEntry(a,o.priority??0,o.wantType,!!o.cancel,!!o.sendDontHave)}),n.blockPresences.forEach(o=>{if(o.cid==null)return;let a=be.decode(o.cid);o.type===r.BlockPresenceType.Have?s.addHave(a):s.addDontHave(a)}),n.blocks.length>0?(await Promise.all(n.blocks.map(async o=>{let a=await Oe.digest(o),c=be.createV0(a);s.addBlock(c,o)})),s):(n.payload.length>0&&(await Promise.all(n.payload.map(async o=>{if(o.prefix==null||o.data==null)return;let a=(0,B6.default)(o.prefix),c=a[0],l=a[1],u=a[2],f=u===Oe.code?Oe:await t?.getHasher(u);if(f==null)throw new b("Unknown hash algorithm","ERR_UNKNOWN_HASH_ALG");let h=await f.digest(o.data),d=be.create(c,l,h);s.addBlock(d,o.data)})),s.setPendingBytes(n.pendingBytes)),s)};static blockPresenceSize=e=>e.bytes.length+1;full;wantlist;blocks;blockPresences;pendingBytes;constructor(e){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return this.blocks.size===0&&this.wantlist.size===0&&this.blockPresences.size===0}addEntry(e,t,n,i,s){n==null&&(n=r.WantType.Block);let o=e.toString(Ee),a=this.wantlist.get(o);a!=null?(a.wantType===n&&(a.priority=t),i===!0&&(a.cancel=!!i),s===!0&&(a.sendDontHave=!!s),n===r.WantType.Block&&a.wantType===r.WantType.Have&&(a.wantType=n)):this.wantlist.set(o,new as(e,t,n,i,s))}addBlock(e,t){let n=e.toString(Ee);this.blocks.set(n,t)}addHave(e){let t=e.toString(Ee);this.blockPresences.has(t)||this.blockPresences.set(t,r.BlockPresenceType.Have)}addDontHave(e){let t=e.toString(Ee);this.blockPresences.has(t)||this.blockPresences.set(t,r.BlockPresenceType.DontHave)}cancel(e){let t=e.toString(Ee);this.wantlist.delete(t),this.addEntry(e,0,r.WantType.Block,!0,!1)}setPendingBytes(e){this.pendingBytes=e}serializeToBitswap100(){return kr.encode({wantlist:{entries:Array.from(this.wantlist.values()).map(e=>({block:e.cid.bytes,priority:Number(e.priority),cancel:!!e.cancel,wantType:kr.Wantlist.WantType.Block,sendDontHave:!1})),full:!!this.full},blocks:Array.from(this.blocks.values())})}serializeToBitswap110(){let e={wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),wantType:t.wantType,cancel:!!t.cancel,sendDontHave:!!t.sendDontHave})),full:!!this.full},blockPresences:[],payload:[],pendingBytes:this.pendingBytes,blocks:[]};for(let[t,n]of this.blocks.entries()){let i=be.parse(t),s=i.version,o=i.code,a=i.multihash.code,c=i.multihash.digest.length,l=A6([s,o,a,c]);e.payload.push({prefix:l,data:n})}for(let[t,n]of this.blockPresences)e.blockPresences.push({cid:be.parse(t).bytes,type:n});return this.pendingBytes>0&&(e.pendingBytes=this.pendingBytes),kr.encode(e)}equals(e){return!(this.full!==e.full||this.pendingBytes!==e.pendingBytes||!ju(this.wantlist,e.wantlist)||!ju(this.blocks,e.blocks)||!ju(this.blockPresences,e.blockPresences))}get[Symbol.toStringTag](){let e=Array.from(this.wantlist.keys()),t=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${e}, blocks: ${t}>`}};var M6={Block:kr.Wantlist.WantType.Block,Have:kr.Wantlist.WantType.Have},HC=(r,e)=>Array.prototype.slice.call(e,0).sort((t,n)=>{let i=r(t),s=r(n);return i<s?-1:i>s?1:0}),ls=class{static Entry=co;set;_stats;constructor(e,t){this.set=t!=null?ai({name:"ipfs_bitswap_wantlist",metrics:t.metrics}):new Map,this._stats=e}get length(){return this.set.size}add(e,t,n){let i=e.toString(Ee),s=this.set.get(i);s!=null?(s.inc(),s.priority=t,s.wantType===M6.Have&&n===M6.Block&&(s.wantType=n)):(this.set.set(i,new co(e,t,n)),this._stats!=null&&this._stats.push(void 0,"wantListSize",1))}remove(e){let t=e.toString(Ee),n=this.set.get(t);n!=null&&(n.dec(),!n.hasRefs()&&(this.set.delete(t),this._stats!=null&&this._stats.push(void 0,"wantListSize",-1)))}removeForce(e){this.set.has(e)&&this.set.delete(e)}forEach(e){this.set.forEach(e)}entries(){return this.set.entries()}sortedEntries(){return new Map(HC(e=>e[1].key,Array.from(this.set.entries())))}contains(e){let t=e.toString(Ee);return this.set.has(t)}get(e){let t=e.toString(Ee);return this.set.get(t)}};var e0=class{partner;wantlist;exchangeCount;accounting;lastExchange;constructor(e){this.partner=e,this.wantlist=new ls,this.exchangeCount=0,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesRecv+=e}wants(e,t,n){this.wantlist.add(e,t,n)}cancelWant(e){this.wantlist.remove(e)}wantlistContains(e){return this.wantlist.get(e)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}};var Jc=class extends Map{_cmp;_keys;constructor(e,t){super(),this._cmp=t??this._defaultSort,this._keys=[];for(let[n,i]of e??[])this.set(n,i)}update(e){if(e<0||e>=this._keys.length)return;let t=this._keys[e];this._keys.splice(e,1);let n=this._find(t);this._keys.splice(n,0,t)}set(e,t){if(this.has(e)){let i=this.indexOf(e);this._keys.splice(i,1)}super.set(e,t);let n=this._find(e);return this._keys.splice(n,0,e),this}clear(){super.clear(),this._keys=[]}delete(e){if(!this.has(e))return!1;let t=this.indexOf(e);return this._keys.splice(t,1),super.delete(e)}indexOf(e){if(!this.has(e))return-1;let t=this._find(e);if(this._keys[t]===e)return t;for(let n=1;n<this._keys.length;n++){if(this._keys[t+n]===e)return t+n;if(this._keys[t-n]===e)return t-n}return-1}_find(e){let t=0,n=this._keys.length;for(;t<n;){let i=t+n>>>1,s=this._kCmp(this._keys[i],e);if(s<0)t=i+1;else if(s>0)n=i;else return i}return t}*keys(){for(let e of this._keys)yield e}*values(){for(let e of this._keys)yield this.get(e)}*entries(){for(let e of this._keys)yield[e,this.get(e)]}*[Symbol.iterator](){yield*this.entries()}forEach(e,t=this){if(e!=null)for(let n of this._keys){let i=this.get(n);if(i==null)throw new Error("Value cannot be undefined");e.apply(t,[[n,i]])}}_defaultSort(e,t){return e[0]<t[0]?-1:t[0]<e[0]?1:0}_kCmp(e,t){return this._cmp([e,this.get(e)],[t,this.get(t)])}};var WC={hasNewInfo(){return!1},merge(){}},t0=class{_taskMerger;_byPeer;constructor(e=WC){this._taskMerger=e,this._byPeer=new Jc([],r0.compare)}pushTasks(e,t){let n=this._byPeer.get(e.toString());n==null&&(n=new r0(e,this._taskMerger)),n.pushTasks(t),this._byPeer.set(e.toString(),n)}popTasks(e){let t=this._head();if(t===void 0)return{tasks:[],pendingSize:0};let{tasks:n,pendingSize:i}=t.popTasks(e);if(n.length===0)return{tasks:n,pendingSize:i};let s=t.peerId;return t.isIdle()?this._byPeer.delete(s.toString()):this._byPeer.update(0),{peerId:s,tasks:n,pendingSize:i}}_head(){if(this._byPeer.size!==0)for(let[,e]of this._byPeer)return e}remove(e,t){this._byPeer.get(t.toString())?.remove(e)}tasksDone(e,t){let n=this._byPeer.get(e.toString());if(n==null)return;let i=this._byPeer.indexOf(e.toString());for(let s of t)n.taskDone(s);this._byPeer.update(i)}},r0=class{peerId;_taskMerger;_activeTotalSize;_pending;_active;constructor(e,t){this.peerId=e,this._taskMerger=t,this._activeTotalSize=0,this._pending=new hp,this._active=new Set}pushTasks(e){for(let t of e)this._pushTask(t)}_pushTask(e){if(!this._taskHasMoreInfoThanActiveTasks(e))return;let t=this._pending.get(e.topic);if(t!=null){e.priority>t.priority&&this._pending.updatePriority(e.topic,e.priority),this._taskMerger.merge(e,t);return}this._pending.add(e)}_taskHasMoreInfoThanActiveTasks(e){let t=[];for(let n of this._active)n.topic===e.topic&&t.push(n);return t.length===0?!0:this._taskMerger.hasNewInfo(e,t)}popTasks(e){let t=0,n=[],i=this._pending.tasks();for(let s=0;s<i.length&&t<e;s++){let o=i[s];n.push(o),t+=o.size,this._pending.delete(o.topic),this._activeTotalSize+=o.size,this._active.add(o)}return{tasks:n,pendingSize:this._pending.totalSize}}taskDone(e){this._active.has(e)&&(this._activeTotalSize-=e.size,this._active.delete(e))}remove(e){this._pending.delete(e)}isIdle(){return this._pending.length===0&&this._active.size===0}static compare(e,t){return e[1]._pending.length===0?1:t[1]._pending.length===0?-1:e[1]._activeTotalSize===t[1]._activeTotalSize?t[1]._pending.length-e[1]._pending.length:e[1]._activeTotalSize-t[1]._activeTotalSize}},hp=class{_tasks;constructor(){this._tasks=new Jc([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce((e,t)=>e+t.task.size,0)}get(e){return this._tasks?.get(e)?.task}add(e){this._tasks.set(e.topic,{created:Date.now(),task:e})}delete(e){this._tasks.delete(e)}tasks(){return[...this._tasks.values()].map(e=>e.task)}updatePriority(e,t){let n=this._tasks.get(e);if(n==null)return;let i=this._tasks.indexOf(e);n.task.priority=t,this._tasks.update(i)}_compare(e,t){return e[1].task.priority===t[1].task.priority?e[1].created-t[1].created:t[1].task.priority-e[1].task.priority}};var U6={hasNewInfo(r,e){let t=!1,n=!1;for(let i of e)i.data.haveBlock&&(t=!0),i.data.isWantBlock&&(n=!0);return!!(!n&&r.data.isWantBlock||!t&&r.data.haveBlock)},merge(r,e){let t=r.data,n=e.data;!n.haveBlock&&t.haveBlock&&(n.haveBlock=t.haveBlock,n.blockSize=t.blockSize),!n.isWantBlock&&t.isWantBlock&&(n.isWantBlock=!0,(!n.haveBlock||t.haveBlock)&&(n.haveBlock=t.haveBlock,e.size=r.size)),n.isWantBlock&&n.haveBlock&&(e.size=n.blockSize)}};var F6=dr.WantType,GC=16*1024,YC=1024,n0=class{_log;blockstore;network;_stats;_opts;ledgerMap;_running;_requestQueue;constructor(e,t,n,i,s,o={}){this._log=pn(e,"engine"),this.blockstore=t,this.network=n,this._stats=i,this._opts=this._processOpts(o),this.ledgerMap=ai({name:"ipfs_bitswap_ledger_map",metrics:s.metrics}),this._running=!1,this._requestQueue=new t0(U6)}_processOpts(e){return{maxSizeReplaceHasWithBlock:YC,targetMessageSize:GC,...e}}_scheduleProcessTasks(){setTimeout(()=>{this._processTasks().catch(e=>{this._log.error("error processing stats",e)})})}async _processTasks(){if(!this._running)return;let{peerId:e,tasks:t,pendingSize:n}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(t.length===0)return;let i=new dr(!1);i.setPendingBytes(n);let s=[],o=new Map;for(let c of t){let l=be.parse(c.topic);c.data.haveBlock?c.data.isWantBlock?(s.push(l),o.set(c.topic,c.data)):i.addHave(l):i.addDontHave(l)}let a=await this._getBlocks(s);for(let[c,l]of o){let u=be.parse(c),f=a.get(c);f!=null?i.addBlock(u,f):l.sendDontHave&&i.addDontHave(u)}if(i.empty){e!=null&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks();return}try{e!=null&&await this.network.sendMessage(e,i);for(let[c,l]of a.entries())e!=null&&this.messageSent(e,be.parse(c),l)}catch(c){this._log.error(c)}e!=null&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks()}wantlistForPeer(e){let t=e.toString(),n=this.ledgerMap.get(t);return n!=null?n.wantlist.sortedEntries():new Map}ledgerForPeer(e){let t=e.toString(),n=this.ledgerMap.get(t);if(n!=null)return{peer:n.partner,value:n.debtRatio(),sent:n.accounting.bytesSent,recv:n.accounting.bytesRecv,exchanged:n.exchangeCount}}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.partner)}receivedBlocks(e){if(e.length!==0){for(let t of this.ledgerMap.values())for(let{cid:n,block:i}of e){let s=t.wantlistContains(n);if(s==null)continue;let o=i.length,a=this._sendAsBlock(s.wantType,o),c=o;a||(c=dr.blockPresenceSize(s.cid)),this._requestQueue.pushTasks(t.partner,[{topic:s.cid.toString(Ee),priority:s.priority,size:c,data:{blockSize:o,isWantBlock:a,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(e,t){let n=this._findOrCreate(e);if(t.empty)return;if(t.full&&(n.wantlist=new ls),this._updateBlockAccounting(t.blocks,n),t.wantlist.size===0){this._scheduleProcessTasks();return}let i=[],s=[];t.wantlist.forEach(o=>{o.cancel?(n.cancelWant(o.cid),i.push(o.cid)):(n.wants(o.cid,o.priority,o.wantType),s.push(o))}),this._cancelWants(e,i),await this._addWants(e,s),this._scheduleProcessTasks()}_cancelWants(e,t){for(let n of t)this._requestQueue.remove(n.toString(Ee),e)}async _addWants(e,t){let n=await this._getBlockSizes(t.map(s=>s.cid)),i=[];for(let s of t){let o=s.cid.toString(Ee),a=n.get(o);if(a==null)s.sendDontHave&&i.push({topic:o,priority:s.priority,size:dr.blockPresenceSize(s.cid),data:{isWantBlock:s.wantType===F6.Block,blockSize:0,haveBlock:!1,sendDontHave:s.sendDontHave}});else{let c=this._sendAsBlock(s.wantType,a),l=a;c||(l=dr.blockPresenceSize(s.cid)),i.push({topic:o,priority:s.priority,size:l,data:{isWantBlock:c,blockSize:a,haveBlock:!0,sendDontHave:s.sendDontHave}})}this._requestQueue.pushTasks(e,i)}}_sendAsBlock(e,t){return e===F6.Block||t<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(e){let t=await this._getBlocks(e);return new Map([...t].map(([n,i])=>[n,i.length]))}async _getBlocks(e){let t=new Map;return await Promise.all(e.map(async n=>{try{let i=await this.blockstore.get(n);t.set(n.toString(Ee),i)}catch(i){i.code!=="ERR_NOT_FOUND"&&this._log.error("failed to query blockstore for %s: %s",n,i)}})),t}_updateBlockAccounting(e,t){for(let n of e.values())this._log("got block (%s bytes)",n.length),t.receivedBytes(n.length)}messageSent(e,t,n){let i=this._findOrCreate(e);i.sentBytes(n.length),i.wantlist.remove(t)}numBytesSentTo(e){return this._findOrCreate(e).accounting.bytesSent}numBytesReceivedFrom(e){return this._findOrCreate(e).accounting.bytesRecv}peerDisconnected(e){this.ledgerMap.delete(e.toString())}_findOrCreate(e){let t=e.toString(),n=this.ledgerMap.get(t);if(n!=null)return n;let i=new e0(e);return this.ledgerMap.set(t,i),this._stats!=null&&this._stats.push(t,"peerCount",1),i}start(){this._running=!0}stop(){this._running=!1}};var QC=Math.pow(2,7),XC=Math.pow(2,14),jC=Math.pow(2,21),dp=Math.pow(2,28),pp=Math.pow(2,35),mp=Math.pow(2,42),gp=Math.pow(2,49),He=128,pr=127;function $t(r){if(r<QC)return 1;if(r<XC)return 2;if(r<jC)return 3;if(r<dp)return 4;if(r<pp)return 5;if(r<mp)return 6;if(r<gp)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function ZC(r,e,t=0){switch($t(r)){case 8:e[t++]=r&255|He,r/=128;case 7:e[t++]=r&255|He,r/=128;case 6:e[t++]=r&255|He,r/=128;case 5:e[t++]=r&255|He,r/=128;case 4:e[t++]=r&255|He,r>>>=7;case 3:e[t++]=r&255|He,r>>>=7;case 2:e[t++]=r&255|He,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function JC(r,e,t=0){switch($t(r)){case 8:e.set(t++,r&255|He),r/=128;case 7:e.set(t++,r&255|He),r/=128;case 6:e.set(t++,r&255|He),r/=128;case 5:e.set(t++,r&255|He),r/=128;case 4:e.set(t++,r&255|He),r>>>=7;case 3:e.set(t++,r&255|He),r>>>=7;case 2:e.set(t++,r&255|He),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function eP(r,e){let t=r[e],n=0;if(n+=t&pr,t<He||(t=r[e+1],n+=(t&pr)<<7,t<He)||(t=r[e+2],n+=(t&pr)<<14,t<He)||(t=r[e+3],n+=(t&pr)<<21,t<He)||(t=r[e+4],n+=(t&pr)*dp,t<He)||(t=r[e+5],n+=(t&pr)*pp,t<He)||(t=r[e+6],n+=(t&pr)*mp,t<He)||(t=r[e+7],n+=(t&pr)*gp,t<He))return n;throw new RangeError("Could not decode varint")}function tP(r,e){let t=r.get(e),n=0;if(n+=t&pr,t<He||(t=r.get(e+1),n+=(t&pr)<<7,t<He)||(t=r.get(e+2),n+=(t&pr)<<14,t<He)||(t=r.get(e+3),n+=(t&pr)<<21,t<He)||(t=r.get(e+4),n+=(t&pr)*dp,t<He)||(t=r.get(e+5),n+=(t&pr)*pp,t<He)||(t=r.get(e+6),n+=(t&pr)*mp,t<He)||(t=r.get(e+7),n+=(t&pr)*gp,t<He))return n;throw new RangeError("Could not decode varint")}function Ht(r,e,t=0){return e==null&&(e=zt($t(r))),e instanceof Uint8Array?ZC(r,e,t):JC(r,e,t)}function $r(r,e=0){return r instanceof Uint8Array?eP(r,e):tP(r,e)}function ve(r,e){e==null&&(e=r.reduce((i,s)=>i+s.length,0));let t=zt(e),n=0;for(let i of r)t.set(i,n),n+=i.length;return Di(t)}var V6=Symbol.for("@achingbrain/uint8arraylist");function K6(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let i=t+n.byteLength;if(e<i)return{buf:n,index:e-t};t=i}throw new RangeError("index is out of bounds")}function i0(r){return!!r?.[V6]}var _e=class r{constructor(...e){Object.defineProperty(this,V6,{value:!0}),this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(i0(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(i0(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=K6(this.bufs,e);return t.buf[t.index]}set(e,t){let n=K6(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(i0(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:i}=this._subList(e,t);return ve(n,i)}subarray(e,t){let{bufs:n,length:i}=this._subList(e,t);return n.length===1?n[0]:ve(n,i)}sublist(e,t){let{bufs:n,length:i}=this._subList(e,t),s=new r;return s.length=i,s.bufs=n,s}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:[...this.bufs],length:this.length};let n=[],i=0;for(let s=0;s<this.bufs.length;s++){let o=this.bufs[s],a=i,c=a+o.byteLength;if(i=c,e>=c)continue;let l=e>=a&&e<c,u=t>a&&t<=c;if(l&&u){if(e===a&&t===c){n.push(o);break}let f=e-a;n.push(o.subarray(f,f+(t-e)));break}if(l){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(u){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!i0(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let i=n.byteLength;if(i===0)throw new TypeError("search must be at least 1 byte long");let s=256,o=new Int32Array(s);for(let f=0;f<s;f++)o[f]=-1;for(let f=0;f<i;f++)o[n[f]]=f;let a=o,c=this.byteLength-n.byteLength,l=n.byteLength-1,u;for(let f=t;f<=c;f+=u){u=0;for(let h=l;h>=0;h--){let d=this.get(f+h);if(n[h]!==d){u=Math.max(1,h-a[d]);break}}if(u===0)return f}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=zt(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let i=Ci(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt16(0,t,n),this.write(i,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let i=Ci(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt32(0,t,n),this.write(i,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let i=Ci(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigInt64(0,t,n),this.write(i,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=zt(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let i=Ci(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint16(0,t,n),this.write(i,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let i=Ci(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint32(0,t,n),this.write(i,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let i=Ci(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigUint64(0,t,n),this.write(i,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let i=Ci(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat32(0,t,n),this.write(i,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let i=Ci(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat64(0,t,n),this.write(i,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!ce(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((i,s)=>i+s.byteLength,0)),n.length=t,n}};function s0(r){return r[Symbol.asyncIterator]!=null}var o0=r=>{let e=$t(r),t=zt(e);return Ht(r,t),o0.bytes=e,t};o0.bytes=0;function Rt(r,e){e=e??{};let t=e.lengthEncoder??o0;function*n(i){let s=t(i.byteLength);s instanceof Uint8Array?yield s:yield*s,i instanceof Uint8Array?yield i:yield*i}return s0(r)?async function*(){for await(let i of r)yield*n(i)}():function*(){for(let i of r)yield*n(i)}()}Rt.single=(r,e)=>{e=e??{};let t=e.lengthEncoder??o0;return new _e(t(r.byteLength),r)};var ga=de(ro(),1);var rP=8,nP=1024*1024*4,fo;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(fo||(fo={}));var yp=r=>{let e=$r(r);return yp.bytes=$t(e),e};yp.bytes=0;function vt(r,e){let t=new _e,n=fo.LENGTH,i=-1,s=e?.lengthDecoder??yp,o=e?.maxLengthLength??rP,a=e?.maxDataLength??nP;function*c(){for(;t.byteLength>0;){if(n===fo.LENGTH)try{if(i=s(t),i<0)throw(0,ga.default)(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(i>a)throw(0,ga.default)(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");let l=s.bytes;t.consume(l),e?.onLength!=null&&e.onLength(i),n=fo.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw(0,ga.default)(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw l}if(n===fo.DATA){if(t.byteLength<i)break;let l=t.sublist(0,i);t.consume(i),e?.onData!=null&&e.onData(l),yield l,n=fo.LENGTH}}}return s0(r)?async function*(){for await(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw(0,ga.default)(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw(0,ga.default)(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}vt.fromReader=(r,e)=>{let t=1,n=async function*(){for(;;)try{let{done:s,value:o}=await r.next(t);if(s===!0)return;o!=null&&(yield o)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{t=1}}();return vt(n,{...e??{},onLength:s=>{t=s}})};var Z6=de(Y6(),1);var Q6=Math.pow(2,31)-1,X6=1e3,j6=1;var xp="/ipfs/bitswap/1.0.0",vp="/ipfs/bitswap/1.1.0",_p="/ipfs/bitswap/1.2.0",aP=1024,cP=1024,lP=3e4,c0=class{_log;_libp2p;_bitswap;_protocols;_stats;_running;_hashLoader;_maxInboundStreams;_maxOutboundStreams;_incomingStreamTimeout;_registrarIds;constructor(e,t,n,i={}){this._log=pn(e.peerId,"network"),this._libp2p=e,this._bitswap=t,this._protocols=[xp],i.b100Only!==!0&&(this._protocols.unshift(vp),this._protocols.unshift(_p)),this._stats=n,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=i.hashLoader??{async getHasher(){throw new Error("Not implemented")}},this._maxInboundStreams=i.maxInboundStreams??aP,this._maxOutboundStreams=i.maxOutboundStreams??cP,this._incomingStreamTimeout=i.incomingStreamTimeout??lP}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});let e={onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect};this._registrarIds=[];for(let t of this._protocols)this._registrarIds.push(await this._libp2p.register(t,e));this._libp2p.getConnections().forEach(t=>{this._onPeerConnect(t.remotePeer)})}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),this._registrarIds!=null){for(let e of this._registrarIds)this._libp2p.unregister(e);this._registrarIds=[]}}_onConnection(e){if(!this._running)return;let{stream:t,connection:n}=e,i=new Z6.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then(async()=>{this._log("incoming new bitswap %s connection from %p",t.protocol,n.remotePeer);let s=()=>{t.abort(new b("Incoming Bitswap stream timed out","ERR_TIMEOUT"))},o=AbortSignal.timeout(this._incomingStreamTimeout);o.addEventListener("abort",s),await Te(t,a=>vt(a),async a=>{for await(let c of a){try{let l=await dr.deserialize(c.subarray(),this._hashLoader);await this._bitswap._receiveMessage(n.remotePeer,l)}catch(l){this._bitswap._receiveError(l);break}o.removeEventListener("abort",s),o=AbortSignal.timeout(this._incomingStreamTimeout),o.addEventListener("abort",s)}}),await t.close({signal:o})}).catch(s=>{this._log(s),t.abort(s)}).finally(()=>{i.clear()})}_onPeerConnect(e){this._bitswap._onPeerConnected(e)}_onPeerDisconnect(e){this._bitswap._onPeerDisconnected(e)}findProviders(e,t={}){return t.onProgress?.(new Le("bitswap:network:find-providers",e)),this._libp2p.contentRouting.findProviders(e,t)}async findAndConnect(e,t){await Cr(os(zr(this.findProviders(e,t),async n=>this.connectTo(n.id,t).catch(i=>{this._log.error(i)})),3)).catch(n=>{this._log.error(n)})}async provide(e,t={}){t.onProgress?.(new Le("bitswap:network:provide",e)),await this._libp2p.contentRouting.provide(e,t)}async sendMessage(e,t,n={}){if(!this._running)throw new Error("network isn't running");let i=e.toString();this._log("sendMessage to %s",i,t),n.onProgress?.(new Le("bitswap:network:send-wantlist",e)),await this._writeMessage(e,t,n),this._updateSentStats(e,t.blocks)}async connectTo(e,t={}){if(!this._running)throw new Error("network isn't running");return t.onProgress?.(new Le("bitswap:network:dial",e)),this._libp2p.dial(e,t)}_updateSentStats(e,t){let n=e.toString();if(this._stats!=null){for(let i of t.values())this._stats.push(n,"dataSent",i.length);this._stats.push(n,"blocksSent",t.size)}}async _writeMessage(e,t,n={}){let i=await this._libp2p.dialProtocol(e,[_p,vp,xp]);try{let s;switch(i.protocol){case xp:s=t.serializeToBitswap100();break;case vp:case _p:s=t.serializeToBitswap110();break;default:throw new Error(`Unknown protocol: ${i.protocol}`)}await Te([s],o=>Rt(o),i),await i.close()}catch(s){n.onProgress?.(new Le("bitswap:network:send-wantlist:error",{peer:e,error:s})),this._log(s),i.abort(s)}}};var f5=de(f0(),1);var l5=r=>`unwant:${H(r.multihash.bytes,"base64")}`,u5=r=>`block:${H(r.multihash.bytes,"base64")}`,h0=class extends f5.EventEmitter{_log;constructor(e){super(),this.setMaxListeners(X6),this._log=pn(e,"notif")}hasBlock(e,t){let n=u5(e);this._log(n),this.emit(n,t)}async wantBlock(e,t={}){if(e==null)throw new Error("Not a valid cid");let n=u5(e),i=l5(e);return this._log(`wantBlock:${e}`),new Promise((s,o)=>{let a=()=>{this.removeListener(n,c),t.onProgress?.(new Le("bitswap:want-block:unwant",e)),o(new Error(`Block for ${e} unwanted`))},c=l=>{this.removeListener(i,a),t.onProgress?.(new Le("bitswap:want-block:block",e)),s(l)};this.once(i,a),this.once(n,c),t.signal?.addEventListener("abort",()=>{this.removeListener(n,c),this.removeListener(i,a),o(new Error(`Want for ${e} aborted`))})})}unwantBlock(e){let t=l5(e);this._log(t),this.emit(t)}};var y5=de(f0(),1);var m5=de(f0(),1),Rp=de(p5(),1),el=class extends m5.EventEmitter{_options;_queue;_stats;_frequencyLastTime;_frequencyAccumulators;_movingAverages;_enabled;_timeout;constructor(e,t){super(),this._options=t,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),e.forEach(n=>{this._stats[n]=BigInt(0),this._movingAverages[n]={},this._options.movingAverageIntervals.forEach(i=>{(this._movingAverages[n][i]=(0,Rp.default)(i)).push(this._frequencyLastTime,0)})}),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._enabled=!1}stop(){this._timeout!=null&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(e,t){this._enabled&&(this._queue.push([e,t,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){this._timeout!=null&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){let e=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-e),0)}_update(){if(this._timeout=void 0,this._queue.length>0){let e;for(;this._queue.length>0;){let t=e=this._queue.shift();t!=null&&this._applyOp(t)}e!=null&&this._updateFrequency(e[2]),this.emit("update",this._stats)}}_updateFrequency(e){let t=e-this._frequencyLastTime;t>0&&Object.keys(this._stats).forEach(n=>{this._updateFrequencyFor(n,t,e)}),this._frequencyLastTime=e}_updateFrequencyFor(e,t,n){let i=this._frequencyAccumulators[e]??0;this._frequencyAccumulators[e]=0;let s=i/t*1e3,o=this._movingAverages[e];o==null&&(o=this._movingAverages[e]={}),this._options.movingAverageIntervals.forEach(a=>{let c=o[a];c==null&&(c=o[a]=(0,Rp.default)(a)),c.push(n,s)})}_applyOp(e){let t=e[0],n=e[1];if(typeof n!="number")throw new Error(`invalid increment number: ${n}`);Object.prototype.hasOwnProperty.call(this._stats,t)||(this._stats[t]=BigInt(0)),this._stats[t]=BigInt(this._stats[t])+BigInt(n),this._frequencyAccumulators[t]==null&&(this._frequencyAccumulators[t]=0),this._frequencyAccumulators[t]+=n}};var g5={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[60*1e3,5*60*1e3,15*60*1e3]},d0=class extends y5.EventEmitter{_initialCounters;_options;_enabled;_global;_peers;constructor(e,t=[],n=g5){super();let i=Object.assign({},g5,n);if(typeof i.computeThrottleTimeout!="number")throw new Error("need computeThrottleTimeout");if(typeof i.computeThrottleMaxQueueSize!="number")throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=t,this._options=i,this._enabled=this._options.enabled,this._global=new el(t,i),this._global.on("update",s=>this.emit("update",s)),this._peers=ai({name:"ipfs_bitswap_stats_peers",metrics:e.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(let e of this._peers)e[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(e){let t=e.toString();return this._peers.get(t)}push(e,t,n){if(this._enabled&&(this._global.push(t,n),e!=null)){let i=this._peers.get(e);i==null&&(i=new el(this._initialCounters,this._options),this._peers.set(e,i)),i.push(t,n)}}disconnected(e){let t=e.toString(),n=this._peers.get(t);n!=null&&(n.stop(),this._peers.delete(t))}};var b5=yP;function yP(r,e,t){var n=null,i=null,s=function(){n&&(clearTimeout(n),i=null,n=null)},o=function(){var c=i;s(),c&&c()},a=function(){if(!e)return r.apply(this,arguments);var c=this,l=arguments,u=t&&!n;if(s(),i=function(){r.apply(c,l)},n=setTimeout(function(){if(n=null,!u){var f=i;return i=null,f()}},e),u)return i()};return a.cancel=s,a.flush=o,a}var p0=class{peerId;refcnt;network;_entries;_log;constructor(e,t,n){this.peerId=t,this.network=n,this.refcnt=1,this._entries=[],this._log=pn(e,"msgqueue"),this.sendEntries=b5(this.sendEntries.bind(this),j6)}addMessage(e,t={}){e.empty||this.send(e,t)}addEntries(e,t={}){this._entries=this._entries.concat(e),this.sendEntries(t)}sendEntries(e={}){if(this._entries.length===0)return;let t=new dr(!1);this._entries.forEach(n=>{n.cancel===!0?t.cancel(n.cid):t.addEntry(n.cid,n.priority)}),this._entries=[],this.addMessage(t,e)}async send(e,t={}){try{await this.network.connectTo(this.peerId,t)}catch(n){this._log.error("cant connect to peer %p: %s",this.peerId,n.message);return}this._log("sending message to peer %p",this.peerId),this.network.sendMessage(this.peerId,e,t).catch(n=>{this._log.error("send error",n)})}};var m0=class{peers;wantlist;network;_peerId;_log;constructor(e,t,n,i){this.peers=ai({name:"ipfs_bitswap_want_manager_peers",metrics:i.metrics}),this.wantlist=new ls(n,i),this.network=t,this._peerId=e,this._log=pn(e,"want")}_addEntries(e,t,n,i={}){let s=e.map((o,a)=>new dr.Entry(o,Q6-a,dr.WantType.Block,t));s.forEach(o=>{o.cancel?n===!0?this.wantlist.removeForce(o.cid.toString(Ee)):this.wantlist.remove(o.cid):(this._log("adding to wantlist"),this.wantlist.add(o.cid,o.priority))});for(let o of this.peers.values())o.addEntries(s,i)}_startPeerHandler(e){let t=this.peers.get(e.toString());if(t!=null){t.refcnt++;return}t=new p0(this._peerId,e,this.network);let n=new dr(!0);for(let i of this.wantlist.entries())n.addEntry(i[1].cid,i[1].priority);return t.addMessage(n),this.peers.set(e.toString(),t),t}_stopPeerHandler(e){let t=this.peers.get(e.toString());t!=null&&(t.refcnt--,!(t.refcnt>0)&&this.peers.delete(e.toString()))}wantBlocks(e,t={}){this._addEntries(e,!1,!1,t),t.signal?.addEventListener("abort",()=>{this.cancelWants(e)})}unwantBlocks(e){this._log("unwant blocks: %s",e.length),this._addEntries(e,!0,!0)}cancelWants(e){this._log("cancel wants: %s",e.length),this._addEntries(e,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(e){this._startPeerHandler(e)}disconnected(e){this._stopPeerHandler(e)}start(){}stop(){this.peers.forEach(e=>{this.disconnected(e.peerId)})}};var bP={async getHasher(){throw new Error("Not implemented")}},wP={maxInboundStreams:1024,maxOutboundStreams:1024,incomingStreamTimeout:3e4,hashLoader:bP,statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},EP=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"],g0=class{_libp2p;_log;stats;network;blockstore;engine;wm;notifications;started;constructor(e,t,n={}){this._libp2p=e,this._log=pn(this.peerId),n=Object.assign({},wP,n),this.stats=new d0(e,EP,{enabled:n.statsEnabled,computeThrottleTimeout:n.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:n.statsComputeThrottleMaxQueueSize}),this.network=new c0(e,this,this.stats,{hashLoader:n.hashLoader,maxInboundStreams:n.maxInboundStreams,maxOutboundStreams:n.maxOutboundStreams,incomingStreamTimeout:n.incomingStreamTimeout}),this.blockstore=t,this.engine=new n0(this.peerId,t,this.network,this.stats,e),this.wm=new m0(this.peerId,this.network,this.stats,e),this.notifications=new h0(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(e,t){try{await this.engine.messageReceived(e,t)}catch{this._log("failed to receive message",t)}if(t.blocks.size===0)return;let n=[];for(let[i,s]of t.blocks.entries()){let o=be.parse(i);n.push({wasWanted:this.wm.wantlist.contains(o),cid:o,data:s})}this.wm.cancelWants(n.filter(({wasWanted:i})=>i).map(({cid:i})=>i)),await Promise.all(n.map(async({cid:i,wasWanted:s,data:o})=>{await this._handleReceivedBlock(e,i,o,s)}))}async _handleReceivedBlock(e,t,n,i){this._log("received block");let s=await this.blockstore.has(t);this._updateReceiveCounters(e.toString(),t,n,s),i&&await this.put(t,n)}_updateReceiveCounters(e,t,n,i){this.stats.push(e,"blocksReceived",1),this.stats.push(e,"dataReceived",n.length),i&&(this.stats.push(e,"dupBlksReceived",1),this.stats.push(e,"dupDataReceived",n.length))}_receiveError(e){this._log.error("ReceiveError",e)}_onPeerConnected(e){this.wm.connected(e)}_onPeerDisconnected(e){this.wm.disconnected(e),this.engine.peerDisconnected(e),this.stats.disconnected(e)}enableStats(){this.stats.enable()}disableStats(){this.stats.disable()}wantlistForPeer(e,t){return this.engine.wantlistForPeer(e)}ledgerForPeer(e){return this.engine.ledgerForPeer(e)}async want(e,t={}){let n=async(c,l)=>(this.wm.wantBlocks([c],l),this.notifications.wantBlock(c,l)),i=!1,s=async(c,l)=>{try{return await this.blockstore.get(c,l)}catch(u){if(u.code!=="ERR_NOT_FOUND")throw u;return i||(i=!0,this.network.findAndConnect(c,l).catch(f=>{this._log.error(f)})),await n(c,l)}},o=new AbortController,a=xt([o.signal,t.signal]);try{return await Promise.race([this.notifications.wantBlock(e,{...t,signal:a}),s(e,{...t,signal:a})])}finally{o.abort(),a.clear()}}unwant(e){let t=Array.isArray(e)?e:[e];this.wm.unwantBlocks(t),t.forEach(n=>{this.notifications.unwantBlock(n)})}cancelWants(e){this.wm.cancelWants(Array.isArray(e)?e:[e])}async put(e,t,n){await this.blockstore.put(e,t),this.notify(e,t)}async*putMany(e,t){yield*this.blockstore.putMany(oo(e,({cid:n,block:i})=>{this.notify(n,i)}),t)}notify(e,t,n={}){this.notifications.hasBlock(e,t),this.engine.receivedBlocks([{cid:e,block:t}]),this.network.provide(e,n).catch(i=>{this._log.error("Failed to provide: %s",i.message)})}getWantlist(){return this.wm.wantlist.entries()}get peers(){return this.engine.peers()}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this.stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}};var w5=(r,e,t={})=>new g0(r,e,t);var Ip=class{bitswap;started;constructor(e,t={}){let{libp2p:n,blockstore:i,hashers:s}=e;this.bitswap=w5(n,i,{hashLoader:{getHasher:async o=>{let a=s.find(c=>c.code===o||c.name===o);if(a!=null)return a;throw new Error(`Could not load hasher for code/name "${o}"`)}},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}announce(e,t,n){this.bitswap.notify(e,t,n)}async retrieve(e,{validateFn:t,...n}={}){return this.bitswap.want(e,n)}};function Ap(r={}){return e=>new Ip(e,r)}var y0=class{url;#e=0;#t=0;#r=0;#n=0;constructor(e){this.url=e instanceof URL?e:new URL(e)}async getRawBlock(e,t){let n=this.url;if(n.pathname=`/ipfs/${e.toString()}`,n.search="?format=raw",t?.aborted===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);try{this.#e++;let i=await fetch(n.toString(),{signal:t,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"});if(!i.ok)throw this.#t++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);return this.#n++,new Uint8Array(await i.arrayBuffer())}catch{throw t?.aborted===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(this.#t++,new Error(`unable to fetch raw block for CID ${e}`))}}reliability(){return this.#e===0?1:this.#r>0?-1/0:this.#n/(this.#e+this.#t*3)}incrementInvalidBlocks(){this.#r++}};var tl=D("helia:trustless-gateway-block-broker"),b0=class{gateways;constructor(e={}){this.gateways=(e.gateways??E5).map(t=>new y0(t))}async retrieve(e,t={}){let n=this.gateways.sort((s,o)=>o.reliability()-s.reliability()),i=[];for(let s of n){tl("getting block for %c from %s",e,s.url);try{let o=await s.getRawBlock(e,t.signal);tl.trace("got block for %c from %s",e,s.url);try{await t.validateFn?.(o)}catch(a){throw tl.error("failed to validate block for %c from %s",e,s.url,a),s.incrementInvalidBlocks(),new Error(`unable to validate block for CID ${e} from gateway ${s.url}`)}return o}catch(o){if(tl.error("failed to get block for %c from %s",e,s.url,o),o instanceof Error?i.push(o):i.push(new Error(`unable to fetch raw block for CID ${e} from gateway ${s.url}`)),t.signal?.aborted===!0){tl.trace("request aborted while fetching raw block for CID %c from gateway %s",e,s.url);break}}}throw new AggregateError(i,`unable to fetch raw block for CID ${e} from any gateway`)}};var E5=["https://dweb.link","https://cf-ipfs.com","https://4everland.io","https://w3s.link"];function Tp(r={}){return()=>new b0(r)}var xP=["string","number","bigint","symbol"],vP=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function x5(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";let e=typeof r;if(xP.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(_P(r))return"Buffer";let t=SP(r);return t||"Object"}function _P(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function SP(r){let e=Object.prototype.toString.call(r).slice(8,-1);if(vP.includes(e))return e}var T=class{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}};T.uint=new T(0,"uint",!0);T.negint=new T(1,"negint",!0);T.bytes=new T(2,"bytes",!0);T.string=new T(3,"string",!0);T.array=new T(4,"array",!1);T.map=new T(5,"map",!1);T.tag=new T(6,"tag",!1);T.float=new T(7,"float",!0);T.false=new T(7,"false",!0);T.true=new T(7,"true",!0);T.null=new T(7,"null",!0);T.undefined=new T(7,"undefined",!0);T.break=new T(7,"break",!0);var G=class{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}};var ba=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",RP=new TextDecoder,IP=new TextEncoder;function w0(r){return ba&&globalThis.Buffer.isBuffer(r)}function rl(r){return r instanceof Uint8Array?w0(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}var R5=ba?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):_5(r,e,t):(r,e,t)=>t-e>64?RP.decode(r.subarray(e,t)):_5(r,e,t),E0=ba?r=>r.length>64?globalThis.Buffer.from(r):v5(r):r=>r.length>64?IP.encode(r):v5(r),ci=r=>Uint8Array.from(r),wa=ba?(r,e,t)=>w0(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),I5=ba?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),rl(globalThis.Buffer.concat(r,e))):(r,e)=>{let t=new Uint8Array(e),n=0;for(let i of r)n+i.length>t.length&&(i=i.subarray(0,t.length-n)),t.set(i,n),n+=i.length;return t},A5=ba?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function T5(r,e){if(w0(r)&&w0(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function v5(r){let e=[],t=0;for(let n=0;n<r.length;n++){let i=r.charCodeAt(n);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(i=65536+((i&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e}function _5(r,e,t){let n=[];for(;e<t;){let i=r[e],s=null,o=i>239?4:i>223?3:i>191?2:1;if(e+o<=t){let a,c,l,u;switch(o){case 1:i<128&&(s=i);break;case 2:a=r[e+1],(a&192)===128&&(u=(i&31)<<6|a&63,u>127&&(s=u));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(u=(i&15)<<12|(a&63)<<6|c&63,u>2047&&(u<55296||u>57343)&&(s=u));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(u=(i&15)<<18|(a&63)<<12|(c&63)<<6|l&63,u>65535&&u<1114112&&(s=u))}}s===null?(s=65533,o=1):s>65535&&(s-=65536,n.push(s>>>10&1023|55296),s=56320|s&1023),n.push(s),e+=o}return Dp(n)}var S5=4096;function Dp(r){let e=r.length;if(e<=S5)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=S5));return t}var AP=256,nl=class{constructor(e=AP){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){let i=t.length-(this.maxCursor-this.cursor)-1;t.set(e,i)}else{if(t){let i=t.length-(this.maxCursor-this.cursor)-1;i<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,i),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=A5(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){let n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=wa(n,0,this.cursor)}else t=I5(this.chunks,this.cursor);return e&&this.reset(),t}};var ne="CBOR decode error:",Ea="CBOR encode error:",il=[];il[23]=1;il[24]=2;il[25]=3;il[26]=5;il[27]=9;function Ni(r,e,t){if(r.length-e<t)throw new Error(`${ne} not enough data for type`)}var Wt=[24,256,65536,4294967296,BigInt("18446744073709551616")];function Hr(r,e,t){Ni(r,e,1);let n=r[e];if(t.strict===!0&&n<Wt[0])throw new Error(`${ne} integer encoded in more bytes than necessary (strict decode)`);return n}function Wr(r,e,t){Ni(r,e,2);let n=r[e]<<8|r[e+1];if(t.strict===!0&&n<Wt[1])throw new Error(`${ne} integer encoded in more bytes than necessary (strict decode)`);return n}function Gr(r,e,t){Ni(r,e,4);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<Wt[2])throw new Error(`${ne} integer encoded in more bytes than necessary (strict decode)`);return n}function Yr(r,e,t){Ni(r,e,8);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],i=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],s=(BigInt(n)<<BigInt(32))+BigInt(i);if(t.strict===!0&&s<Wt[3])throw new Error(`${ne} integer encoded in more bytes than necessary (strict decode)`);if(s<=Number.MAX_SAFE_INTEGER)return Number(s);if(t.allowBigInt===!0)return s;throw new Error(`${ne} integers outside of the safe integer range are not supported`)}function D5(r,e,t,n){return new G(T.uint,Hr(r,e+1,n),2)}function C5(r,e,t,n){return new G(T.uint,Wr(r,e+1,n),3)}function P5(r,e,t,n){return new G(T.uint,Gr(r,e+1,n),5)}function k5(r,e,t,n){return new G(T.uint,Yr(r,e+1,n),9)}function mn(r,e){return or(r,0,e.value)}function or(r,e,t){if(t<Wt[0]){let n=Number(t);r.push([e|n])}else if(t<Wt[1]){let n=Number(t);r.push([e|24,n])}else if(t<Wt[2]){let n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<Wt[3]){let n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{let n=BigInt(t);if(n<Wt[4]){let i=[e|27,0,0,0,0,0,0,0],s=Number(n&BigInt(4294967295)),o=Number(n>>BigInt(32)&BigInt(4294967295));i[8]=s&255,s=s>>8,i[7]=s&255,s=s>>8,i[6]=s&255,s=s>>8,i[5]=s&255,i[4]=o&255,o=o>>8,i[3]=o&255,o=o>>8,i[2]=o&255,o=o>>8,i[1]=o&255,r.push(i)}else throw new Error(`${ne} encountered BigInt larger than allowable range`)}}mn.encodedSize=function(e){return or.encodedSize(e.value)};or.encodedSize=function(e){return e<Wt[0]?1:e<Wt[1]?2:e<Wt[2]?3:e<Wt[3]?5:9};mn.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function N5(r,e,t,n){return new G(T.negint,-1-Hr(r,e+1,n),2)}function O5(r,e,t,n){return new G(T.negint,-1-Wr(r,e+1,n),3)}function L5(r,e,t,n){return new G(T.negint,-1-Gr(r,e+1,n),5)}var Cp=BigInt(-1),B5=BigInt(1);function M5(r,e,t,n){let i=Yr(r,e+1,n);if(typeof i!="bigint"){let s=-1-i;if(s>=Number.MIN_SAFE_INTEGER)return new G(T.negint,s,9)}if(n.allowBigInt!==!0)throw new Error(`${ne} integers outside of the safe integer range are not supported`);return new G(T.negint,Cp-BigInt(i),9)}function x0(r,e){let t=e.value,n=typeof t=="bigint"?t*Cp-B5:t*-1-1;or(r,e.type.majorEncoded,n)}x0.encodedSize=function(e){let t=e.value,n=typeof t=="bigint"?t*Cp-B5:t*-1-1;return n<Wt[0]?1:n<Wt[1]?2:n<Wt[2]?3:n<Wt[3]?5:9};x0.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function sl(r,e,t,n){Ni(r,e,t+n);let i=wa(r,e+t,e+t+n);return new G(T.bytes,i,t+n)}function U5(r,e,t,n){return sl(r,e,1,t)}function F5(r,e,t,n){return sl(r,e,2,Hr(r,e+1,n))}function K5(r,e,t,n){return sl(r,e,3,Wr(r,e+1,n))}function V5(r,e,t,n){return sl(r,e,5,Gr(r,e+1,n))}function q5(r,e,t,n){let i=Yr(r,e+1,n);if(typeof i=="bigint")throw new Error(`${ne} 64-bit integer bytes lengths not supported`);return sl(r,e,9,i)}function v0(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===T.string?E0(r.value):r.value),r.encodedBytes}function xa(r,e){let t=v0(e);or(r,e.type.majorEncoded,t.length),r.push(t)}xa.encodedSize=function(e){let t=v0(e);return or.encodedSize(t.length)+t.length};xa.compareTokens=function(e,t){return DP(v0(e),v0(t))};function DP(r,e){return r.length<e.length?-1:r.length>e.length?1:T5(r,e)}function ol(r,e,t,n,i){let s=t+n;Ni(r,e,s);let o=new G(T.string,R5(r,e+t,e+s),s);return i.retainStringBytes===!0&&(o.byteValue=wa(r,e+t,e+s)),o}function z5(r,e,t,n){return ol(r,e,1,t,n)}function $5(r,e,t,n){return ol(r,e,2,Hr(r,e+1,n),n)}function H5(r,e,t,n){return ol(r,e,3,Wr(r,e+1,n),n)}function W5(r,e,t,n){return ol(r,e,5,Gr(r,e+1,n),n)}function G5(r,e,t,n){let i=Yr(r,e+1,n);if(typeof i=="bigint")throw new Error(`${ne} 64-bit integer string lengths not supported`);return ol(r,e,9,i,n)}var Y5=xa;function va(r,e,t,n){return new G(T.array,n,t)}function Q5(r,e,t,n){return va(r,e,1,t)}function X5(r,e,t,n){return va(r,e,2,Hr(r,e+1,n))}function j5(r,e,t,n){return va(r,e,3,Wr(r,e+1,n))}function Z5(r,e,t,n){return va(r,e,5,Gr(r,e+1,n))}function J5(r,e,t,n){let i=Yr(r,e+1,n);if(typeof i=="bigint")throw new Error(`${ne} 64-bit integer array lengths not supported`);return va(r,e,9,i)}function ey(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ne} indefinite length items not allowed`);return va(r,e,1,1/0)}function _0(r,e){or(r,T.array.majorEncoded,e.value)}_0.compareTokens=mn.compareTokens;_0.encodedSize=function(e){return or.encodedSize(e.value)};function _a(r,e,t,n){return new G(T.map,n,t)}function ty(r,e,t,n){return _a(r,e,1,t)}function ry(r,e,t,n){return _a(r,e,2,Hr(r,e+1,n))}function ny(r,e,t,n){return _a(r,e,3,Wr(r,e+1,n))}function iy(r,e,t,n){return _a(r,e,5,Gr(r,e+1,n))}function sy(r,e,t,n){let i=Yr(r,e+1,n);if(typeof i=="bigint")throw new Error(`${ne} 64-bit integer map lengths not supported`);return _a(r,e,9,i)}function oy(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ne} indefinite length items not allowed`);return _a(r,e,1,1/0)}function S0(r,e){or(r,T.map.majorEncoded,e.value)}S0.compareTokens=mn.compareTokens;S0.encodedSize=function(e){return or.encodedSize(e.value)};function ay(r,e,t,n){return new G(T.tag,t,1)}function cy(r,e,t,n){return new G(T.tag,Hr(r,e+1,n),2)}function ly(r,e,t,n){return new G(T.tag,Wr(r,e+1,n),3)}function uy(r,e,t,n){return new G(T.tag,Gr(r,e+1,n),5)}function fy(r,e,t,n){return new G(T.tag,Yr(r,e+1,n),9)}function R0(r,e){or(r,T.tag.majorEncoded,e.value)}R0.compareTokens=mn.compareTokens;R0.encodedSize=function(e){return or.encodedSize(e.value)};var LP=20,BP=21,MP=22,UP=23;function hy(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${ne} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new G(T.null,null,1):new G(T.undefined,void 0,1)}function dy(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ne} indefinite length items not allowed`);return new G(T.break,void 0,1)}function Pp(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${ne} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${ne} Infinity values are not supported`)}return new G(T.float,r,e)}function py(r,e,t,n){return Pp(kp(r,e+1),3,n)}function my(r,e,t,n){return Pp(Np(r,e+1),5,n)}function gy(r,e,t,n){return Pp(Ey(r,e+1),9,n)}function I0(r,e,t){let n=e.value;if(n===!1)r.push([T.float.majorEncoded|LP]);else if(n===!0)r.push([T.float.majorEncoded|BP]);else if(n===null)r.push([T.float.majorEncoded|MP]);else if(n===void 0)r.push([T.float.majorEncoded|UP]);else{let i,s=!1;(!t||t.float64!==!0)&&(by(n),i=kp(Un,1),n===i||Number.isNaN(n)?(Un[0]=249,r.push(Un.slice(0,3)),s=!0):(wy(n),i=Np(Un,1),n===i&&(Un[0]=250,r.push(Un.slice(0,5)),s=!0))),s||(FP(n),i=Ey(Un,1),Un[0]=251,r.push(Un.slice(0,9)))}}I0.encodedSize=function(e,t){let n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){by(n);let i=kp(Un,1);if(n===i||Number.isNaN(n))return 3;if(wy(n),i=Np(Un,1),n===i)return 5}return 9};var yy=new ArrayBuffer(9),gn=new DataView(yy,1),Un=new Uint8Array(yy,0);function by(r){if(r===1/0)gn.setUint16(0,31744,!1);else if(r===-1/0)gn.setUint16(0,64512,!1);else if(Number.isNaN(r))gn.setUint16(0,32256,!1);else{gn.setFloat32(0,r);let e=gn.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)gn.setUint16(0,31744,!1);else if(t===0)gn.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{let i=t-127;i<-24?gn.setUint16(0,0):i<-14?gn.setUint16(0,(e&2147483648)>>16|1<<24+i,!1):gn.setUint16(0,(e&2147483648)>>16|i+15<<10|n>>13,!1)}}}function kp(r,e){if(r.length-e<2)throw new Error(`${ne} not enough data for float16`);let t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;let n=t>>10&31,i=t&1023,s;return n===0?s=i*2**-24:n!==31?s=(i+1024)*2**(n-25):s=i===0?1/0:NaN,t&32768?-s:s}function wy(r){gn.setFloat32(0,r,!1)}function Np(r,e){if(r.length-e<4)throw new Error(`${ne} not enough data for float32`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function FP(r){gn.setFloat64(0,r,!1)}function Ey(r,e){if(r.length-e<8)throw new Error(`${ne} not enough data for float64`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}I0.compareTokens=mn.compareTokens;function Ve(r,e,t){throw new Error(`${ne} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function A0(r){return()=>{throw new Error(`${ne} ${r}`)}}var X=[];for(let r=0;r<=23;r++)X[r]=Ve;X[24]=D5;X[25]=C5;X[26]=P5;X[27]=k5;X[28]=Ve;X[29]=Ve;X[30]=Ve;X[31]=Ve;for(let r=32;r<=55;r++)X[r]=Ve;X[56]=N5;X[57]=O5;X[58]=L5;X[59]=M5;X[60]=Ve;X[61]=Ve;X[62]=Ve;X[63]=Ve;for(let r=64;r<=87;r++)X[r]=U5;X[88]=F5;X[89]=K5;X[90]=V5;X[91]=q5;X[92]=Ve;X[93]=Ve;X[94]=Ve;X[95]=A0("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)X[r]=z5;X[120]=$5;X[121]=H5;X[122]=W5;X[123]=G5;X[124]=Ve;X[125]=Ve;X[126]=Ve;X[127]=A0("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)X[r]=Q5;X[152]=X5;X[153]=j5;X[154]=Z5;X[155]=J5;X[156]=Ve;X[157]=Ve;X[158]=Ve;X[159]=ey;for(let r=160;r<=183;r++)X[r]=ty;X[184]=ry;X[185]=ny;X[186]=iy;X[187]=sy;X[188]=Ve;X[189]=Ve;X[190]=Ve;X[191]=oy;for(let r=192;r<=215;r++)X[r]=ay;X[216]=cy;X[217]=ly;X[218]=uy;X[219]=fy;X[220]=Ve;X[221]=Ve;X[222]=Ve;X[223]=Ve;for(let r=224;r<=243;r++)X[r]=A0("simple values are not supported");X[244]=Ve;X[245]=Ve;X[246]=Ve;X[247]=hy;X[248]=A0("simple values are not supported");X[249]=py;X[250]=my;X[251]=gy;X[252]=Ve;X[253]=Ve;X[254]=Ve;X[255]=dy;var Fn=[];for(let r=0;r<24;r++)Fn[r]=new G(T.uint,r,1);for(let r=-1;r>=-24;r--)Fn[31-r]=new G(T.negint,r,1);Fn[64]=new G(T.bytes,new Uint8Array(0),1);Fn[96]=new G(T.string,"",1);Fn[128]=new G(T.array,0,1);Fn[160]=new G(T.map,0,1);Fn[244]=new G(T.false,!1,1);Fn[245]=new G(T.true,!0,1);Fn[246]=new G(T.null,null,1);function xy(r){switch(r.type){case T.false:return ci([244]);case T.true:return ci([245]);case T.null:return ci([246]);case T.bytes:return r.value.length?void 0:ci([64]);case T.string:return r.value===""?ci([96]):void 0;case T.array:return r.value===0?ci([128]):void 0;case T.map:return r.value===0?ci([160]):void 0;case T.uint:return r.value<24?ci([Number(r.value)]):void 0;case T.negint:if(r.value>=-24)return ci([31-Number(r.value)])}}var VP={float64:!1,mapSorter:$P,quickEncodeToken:xy};function qP(){let r=[];return r[T.uint.major]=mn,r[T.negint.major]=x0,r[T.bytes.major]=xa,r[T.string.major]=Y5,r[T.array.major]=_0,r[T.map.major]=S0,r[T.tag.major]=R0,r[T.float.major]=I0,r}var vy=qP(),Op=new nl,D0=class r{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${Ea} object contains circular references`);return new r(t,e)}},hs={null:new G(T.null,null),undefined:new G(T.undefined,void 0),true:new G(T.true,!0),false:new G(T.false,!1),emptyArray:new G(T.array,0),emptyMap:new G(T.map,0)},ds={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new G(T.float,r):r>=0?new G(T.uint,r):new G(T.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new G(T.uint,r):new G(T.negint,r)},Uint8Array(r,e,t,n){return new G(T.bytes,r)},string(r,e,t,n){return new G(T.string,r)},boolean(r,e,t,n){return r?hs.true:hs.false},null(r,e,t,n){return hs.null},undefined(r,e,t,n){return hs.undefined},ArrayBuffer(r,e,t,n){return new G(T.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new G(T.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[hs.emptyArray,new G(T.break)]:hs.emptyArray;n=D0.createCheck(n,r);let i=[],s=0;for(let o of r)i[s++]=T0(o,t,n);return t.addBreakTokens?[new G(T.array,r.length),i,new G(T.break)]:[new G(T.array,r.length),i]},Object(r,e,t,n){let i=e!=="Object",s=i?r.keys():Object.keys(r),o=i?r.size:s.length;if(!o)return t.addBreakTokens===!0?[hs.emptyMap,new G(T.break)]:hs.emptyMap;n=D0.createCheck(n,r);let a=[],c=0;for(let l of s)a[c++]=[T0(l,t,n),T0(i?r.get(l):r[l],t,n)];return zP(a,t),t.addBreakTokens?[new G(T.map,o),a,new G(T.break)]:[new G(T.map,o),a]}};ds.Map=ds.Object;ds.Buffer=ds.Uint8Array;for(let r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))ds[`${r}Array`]=ds.DataView;function T0(r,e={},t){let n=x5(r),i=e&&e.typeEncoders&&e.typeEncoders[n]||ds[n];if(typeof i=="function"){let o=i(r,n,e,t);if(o!=null)return o}let s=ds[n];if(!s)throw new Error(`${Ea} unsupported type: ${n}`);return s(r,n,e,t)}function zP(r,e){e.mapSorter&&r.sort(e.mapSorter)}function $P(r,e){let t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);let i=t.type.major,s=vy[i].compareTokens(t,n);return s===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),s}function _y(r,e,t,n){if(Array.isArray(e))for(let i of e)_y(r,i,t,n);else t[e.type.major](r,e,n)}function Sy(r,e,t){let n=T0(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){let i=t.quickEncodeToken(n);if(i)return i;let s=e[n.type.major];if(s.encodedSize){let o=s.encodedSize(n,t),a=new nl(o);if(s(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return rl(a.chunks[0])}}return Op.reset(),_y(Op,n,e,t),Op.toBytes(!0)}function Sa(r,e){return e=Object.assign({},VP,e),Sy(r,vy,e)}var HP={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0},Lp=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){let e=this.data[this._pos],t=Fn[e];if(t===void 0){let n=X[e];if(!n)throw new Error(`${ne} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);let i=e&31;t=n(this.data,this._pos,i,this.options)}return this._pos+=t.encodedLength,t}},al=Symbol.for("DONE"),C0=Symbol.for("BREAK");function WP(r,e,t){let n=[];for(let i=0;i<r.value;i++){let s=cl(e,t);if(s===C0){if(r.value===1/0)break;throw new Error(`${ne} got unexpected break to lengthed array`)}if(s===al)throw new Error(`${ne} found array but not enough entries (got ${i}, expected ${r.value})`);n[i]=s}return n}function GP(r,e,t){let n=t.useMaps===!0,i=n?void 0:{},s=n?new Map:void 0;for(let o=0;o<r.value;o++){let a=cl(e,t);if(a===C0){if(r.value===1/0)break;throw new Error(`${ne} got unexpected break to lengthed map`)}if(a===al)throw new Error(`${ne} found map but not enough entries (got ${o} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${ne} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&s.has(a)||!n&&a in i))throw new Error(`${ne} found repeat map key "${a}"`);let c=cl(e,t);if(c===al)throw new Error(`${ne} found map but not enough entries (got ${o} [no value], expected ${r.value})`);n?s.set(a,c):i[a]=c}return n?s:i}function cl(r,e){if(r.done())return al;let t=r.next();if(t.type===T.break)return C0;if(t.type.terminal)return t.value;if(t.type===T.array)return WP(t,r,e);if(t.type===T.map)return GP(t,r,e);if(t.type===T.tag){if(e.tags&&typeof e.tags[t.value]=="function"){let n=cl(r,e);return e.tags[t.value](n)}throw new Error(`${ne} tag not supported (${t.value})`)}throw new Error("unsupported")}function Bp(r,e){if(!(r instanceof Uint8Array))throw new Error(`${ne} data to decode must be a Uint8Array`);e=Object.assign({},HP,e);let t=e.tokenizer||new Lp(r,e),n=cl(t,e);if(n===al)throw new Error(`${ne} did not find any content to decode`);if(n===C0)throw new Error(`${ne} got unexpected break`);return[n,r.subarray(t.pos())]}function yn(r,e){let[t,n]=Bp(r,e);if(n.length>0)throw new Error(`${ne} too many terminals, data makes no sense`);return t}var Up=de(Iy(),1);var ul=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Fp=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},Ay=r=>globalThis.DOMException===void 0?new Fp(r):new DOMException(r),Ty=r=>{let e=r.reason===void 0?Ay("This operation was aborted."):r.reason;return e instanceof Error?e:Ay(e)};function Kp(r,e,t,n){let i,s=new Promise((o,a)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(e===Number.POSITIVE_INFINITY){o(r);return}if(n={customTimers:{setTimeout,clearTimeout},...n},n.signal){let{signal:c}=n;c.aborted&&a(Ty(c)),c.addEventListener("abort",()=>{a(Ty(c))})}i=n.customTimers.setTimeout.call(void 0,()=>{if(typeof t=="function"){try{o(t())}catch(u){a(u)}return}let c=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,l=t instanceof Error?t:new ul(c);typeof r.cancel=="function"&&r.cancel(),a(l)},e),(async()=>{try{o(await r)}catch(c){a(c)}finally{n.customTimers.clearTimeout.call(void 0,i)}})()});return s.clear=()=>{clearTimeout(i),i=void 0},s}function Vp(r,e,t){let n=0,i=r.length;for(;i>0;){let s=Math.trunc(i/2),o=n+s;t(r[o],e)<=0?(n=++o,i-=s+1):i=s}return n}var po=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Oi,qp=class{constructor(){Oi.set(this,[])}enqueue(e,t){t={priority:0,...t};let n={priority:t.priority,run:e};if(this.size&&po(this,Oi,"f")[this.size-1].priority>=t.priority){po(this,Oi,"f").push(n);return}let i=Vp(po(this,Oi,"f"),n,(s,o)=>o.priority-s.priority);po(this,Oi,"f").splice(i,0,n)}dequeue(){let e=po(this,Oi,"f").shift();return e?.run}filter(e){return po(this,Oi,"f").filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return po(this,Oi,"f").length}};Oi=new WeakMap;var Dy=qp;var gt=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},ie=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},It,hl,dl,ms,U0,pl,N0,Kn,fl,Qr,O0,Xr,ml,ps,L0,Cy,Py,Oy,ky,Ny,B0,zp,$p,F0,Ly,M0,K0=class extends Error{},Hp=class extends Up.default{constructor(e){var t,n,i,s;if(super(),It.add(this),hl.set(this,void 0),dl.set(this,void 0),ms.set(this,0),U0.set(this,void 0),pl.set(this,void 0),N0.set(this,0),Kn.set(this,void 0),fl.set(this,void 0),Qr.set(this,void 0),O0.set(this,void 0),Xr.set(this,0),ml.set(this,void 0),ps.set(this,void 0),L0.set(this,void 0),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Dy,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(n=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(i=e.interval)===null||i===void 0?void 0:i.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);gt(this,hl,e.carryoverConcurrencyCount,"f"),gt(this,dl,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,"f"),gt(this,U0,e.intervalCap,"f"),gt(this,pl,e.interval,"f"),gt(this,Qr,new e.queueClass,"f"),gt(this,O0,e.queueClass,"f"),this.concurrency=e.concurrency,this.timeout=e.timeout,gt(this,L0,e.throwOnTimeout===!0,"f"),gt(this,ps,e.autoStart===!1,"f")}get concurrency(){return ie(this,ml,"f")}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);gt(this,ml,e,"f"),ie(this,It,"m",F0).call(this)}async add(e,t={}){return t={timeout:this.timeout,throwOnTimeout:ie(this,L0,"f"),...t},new Promise((n,i)=>{ie(this,Qr,"f").enqueue(async()=>{var s,o,a;gt(this,Xr,(o=ie(this,Xr,"f"),o++,o),"f"),gt(this,ms,(a=ie(this,ms,"f"),a++,a),"f");try{if(!((s=t.signal)===null||s===void 0)&&s.aborted)throw new K0("The task was aborted.");let c=e({signal:t.signal});t.timeout&&(c=Kp(Promise.resolve(c),t.timeout)),t.signal&&(c=Promise.race([c,ie(this,It,"m",Ly).call(this,t.signal)]));let l=await c;n(l),this.emit("completed",l)}catch(c){if(c instanceof ul&&!t.throwOnTimeout){n();return}i(c),this.emit("error",c)}finally{ie(this,It,"m",Oy).call(this)}},t),this.emit("add"),ie(this,It,"m",B0).call(this)})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return ie(this,ps,"f")?(gt(this,ps,!1,"f"),ie(this,It,"m",F0).call(this),this):this}pause(){gt(this,ps,!0,"f")}clear(){gt(this,Qr,new(ie(this,O0,"f")),"f")}async onEmpty(){ie(this,Qr,"f").size!==0&&await ie(this,It,"m",M0).call(this,"empty")}async onSizeLessThan(e){ie(this,Qr,"f").size<e||await ie(this,It,"m",M0).call(this,"next",()=>ie(this,Qr,"f").size<e)}async onIdle(){ie(this,Xr,"f")===0&&ie(this,Qr,"f").size===0||await ie(this,It,"m",M0).call(this,"idle")}get size(){return ie(this,Qr,"f").size}sizeBy(e){return ie(this,Qr,"f").filter(e).length}get pending(){return ie(this,Xr,"f")}get isPaused(){return ie(this,ps,"f")}};hl=new WeakMap,dl=new WeakMap,ms=new WeakMap,U0=new WeakMap,pl=new WeakMap,N0=new WeakMap,Kn=new WeakMap,fl=new WeakMap,Qr=new WeakMap,O0=new WeakMap,Xr=new WeakMap,ml=new WeakMap,ps=new WeakMap,L0=new WeakMap,It=new WeakSet,Cy=function(){return ie(this,dl,"f")||ie(this,ms,"f")<ie(this,U0,"f")},Py=function(){return ie(this,Xr,"f")<ie(this,ml,"f")},Oy=function(){var e;gt(this,Xr,(e=ie(this,Xr,"f"),e--,e),"f"),ie(this,It,"m",B0).call(this),this.emit("next")},ky=function(){ie(this,It,"m",$p).call(this),ie(this,It,"m",zp).call(this),gt(this,fl,void 0,"f")},Ny=function(){let e=Date.now();if(ie(this,Kn,"f")===void 0){let t=ie(this,N0,"f")-e;if(t<0)gt(this,ms,ie(this,hl,"f")?ie(this,Xr,"f"):0,"f");else return ie(this,fl,"f")===void 0&&gt(this,fl,setTimeout(()=>{ie(this,It,"m",ky).call(this)},t),"f"),!0}return!1},B0=function(){if(ie(this,Qr,"f").size===0)return ie(this,Kn,"f")&&clearInterval(ie(this,Kn,"f")),gt(this,Kn,void 0,"f"),this.emit("empty"),ie(this,Xr,"f")===0&&this.emit("idle"),!1;if(!ie(this,ps,"f")){let e=!ie(this,It,"a",Ny);if(ie(this,It,"a",Cy)&&ie(this,It,"a",Py)){let t=ie(this,Qr,"f").dequeue();return t?(this.emit("active"),t(),e&&ie(this,It,"m",zp).call(this),!0):!1}}return!1},zp=function(){ie(this,dl,"f")||ie(this,Kn,"f")!==void 0||(gt(this,Kn,setInterval(()=>{ie(this,It,"m",$p).call(this)},ie(this,pl,"f")),"f"),gt(this,N0,Date.now()+ie(this,pl,"f"),"f"))},$p=function(){ie(this,ms,"f")===0&&ie(this,Xr,"f")===0&&ie(this,Kn,"f")&&(clearInterval(ie(this,Kn,"f")),gt(this,Kn,void 0,"f")),gt(this,ms,ie(this,hl,"f")?ie(this,Xr,"f"):0,"f"),ie(this,It,"m",F0).call(this)},F0=function(){for(;ie(this,It,"m",B0).call(this););},Ly=async function(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(new K0("The task was aborted."))},{once:!0})})},M0=async function(e,t){return new Promise(n=>{let i=()=>{t&&!t()||(this.off(e,i),n())};this.on(e,i)})};var Ft=Hp;var XP=42;function jP(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return be.decode(r.subarray(1))}var ZP={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};ZP.tags[XP]=jP;var By=113;var My=class extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){let t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===T.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===T.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[T.uint.major](e,t){this.prefix(e);let n=String(t.value),i=[];for(let s=0;s<n.length;s++)i[s]=n.charCodeAt(s);e.push(i)}[T.negint.major](e,t){this[T.uint.major](e,t)}[T.bytes.major](e,t){throw new Error(`${Ea} unsupported type: Uint8Array`)}[T.string.major](e,t){this.prefix(e);let n=E0(JSON.stringify(t.value));e.push(n.length>32?rl(n):n)}[T.array.major](e,t){this.prefix(e),this.inRecursive.push({type:T.array,elements:0}),e.push([91])}[T.map.major](e,t){this.prefix(e),this.inRecursive.push({type:T.map,elements:0}),e.push([123])}[T.tag.major](e,t){}[T.float.major](e,t){if(t.type.name==="break"){let o=this.inRecursive.pop();if(o){if(o.type===T.array)e.push([93]);else if(o.type===T.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${Ea} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}let n=String(t.value),i=[],s=!1;for(let o=0;o<n.length;o++)i[o]=n.charCodeAt(o),!s&&(i[o]===46||i[o]===101||i[o]===69)&&(s=!0);s||(i.push(46),i.push(48)),e.push(i)}};var mo=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${ne} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${ne} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){let e=this._pos,t=!1,n=!1,i=a=>{for(;!this.done();){let c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new G(T.uint,0,this._pos-e);if(i([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${ne} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${ne} unexpected token at position ${this._pos}`);n=!0,this._pos++,i([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,i([48,49,50,51,52,53,54,55,56,57]));let s=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),o=parseFloat(s);return n?new G(T.float,o,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new G(o>=0?T.uint:T.negint,o,this._pos-e):new G(o>=0?T.uint:T.negint,BigInt(s),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${ne} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let s=this._pos,o=0;s<this.data.length&&o<65536;s++,o++){let a=this.data[s];if(a===92||a<32||a>=128)break;if(a===34){let c=String.fromCharCode.apply(null,this.data.subarray(this._pos,s));return this._pos=s+1,new G(T.string,c,o)}}let e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${ne} unexpected end of unicode escape sequence at position ${this._pos}`);let s=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${ne} unexpected unicode escape character at position ${this._pos}`);s=s*16+a,this._pos++}return s},i=()=>{let s=this.ch(),o=null,a=s>239?4:s>223?3:s>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${ne} unexpected unicode sequence at position ${this._pos}`);let c,l,u,f;switch(a){case 1:s<128&&(o=s);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(f=(s&31)<<6|c&63,f>127&&(o=f));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(f=(s&15)<<12|(c&63)<<6|l&63,f>2047&&(f<55296||f>57343)&&(o=f));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],u=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(u&192)===128&&(f=(s&15)<<18|(c&63)<<12|(l&63)<<6|u&63,f>65535&&f<1114112&&(o=f))}o===null?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|o&1023),t.push(o),this._pos+=a};for(;!this.done();){let s=this.ch(),o;switch(s){case 92:if(this._pos++,this.done())throw new Error(`${ne} unexpected string termination at position ${this._pos}`);switch(o=this.ch(),this._pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${ne} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new G(T.string,Dp(t),this._pos-e);default:if(s<32)throw new Error(`${ne} invalid control character at position ${this._pos}`);s<128?(t.push(s),this._pos++):i()}}throw new Error(`${ne} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new G(T.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new G(T.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new G(T.null,null,4);case 102:return this.expect([102,97,108,115,101]),new G(T.false,!1,5);case 116:return this.expect([116,114,117,101]),new G(T.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${ne} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new G(T.break,void 0,1);if(this.ch()!==44)throw new Error(`${ne} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new G(T.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new G(T.break,void 0,1);if(this.ch()!==44)throw new Error(`${ne} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new G(T.break,void 0,1);let e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${ne} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${ne} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}};function V0(r,e){return e=Object.assign({tokenizer:new mo(r,e)},e),yn(r,e)}var tk={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};tk.tags[42]=be.parse;var Fy=297;var pZ=new TextDecoder;var mZ=new TextEncoder;var nk=new TextDecoder;function Wp(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");let i=r[e++];if(t+=n<28?(i&127)<<n:(i&127)*2**n,i<128)break}return[t,e]}function q0(r,e){let t;[t,e]=Wp(r,e);let n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function Ky(r,e){let t;return[t,e]=Wp(r,e),[t&7,t>>3,e]}function ik(r){let e={},t=r.length,n=0;for(;n<t;){let i,s;if([i,s,n]=Ky(r,n),s===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=q0(r,n)}else if(s===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let o;[o,n]=q0(r,n),e.Name=nk.decode(o)}else if(s===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(i!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Tsize`);[e.Tsize,n]=Wp(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${s}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function Vy(r){let e=r.length,t=0,n,i=!1,s;for(;t<e;){let a,c;if([a,c,t]=Ky(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(s)throw new Error("protobuf: (PBNode) duplicate Data section");[s,t]=q0(r,t),n&&(i=!0)}else if(c===2){if(i)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=q0(r,t),n.push(ik(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");let o={};return s&&(o.Data=s),o.Links=n||[],o}var yZ=new TextEncoder,bZ=2**32,wZ=2**31;var vZ=new TextEncoder;var qy=112;function zy(r){let e=Vy(r),t={};return e.Data&&(t.Data=e.Data),e.Links&&(t.Links=e.Links.map(n=>{let i={};try{i.Hash=be.decode(n.Hash)}catch{}if(!i.Hash)throw new Error("Invalid Hash field found in link, expected CID");return n.Name!==void 0&&(i.Name=n.Name),n.Tsize!==void 0&&(i.Tsize=n.Tsize),i})),t}var $y={codec:qy,async*walk(r){yield*zy(r).Links.map(t=>t.Hash)}},Hy={codec:$u,async*walk(){}},Wy=42,Gy={codec:By,async*walk(r){let e=[],t=[];t[Wy]=n=>{if(n[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");let i=be.decode(n.subarray(1));return e.push(i),i},yn(r,{tags:t}),yield*e}},Gp=class extends mo{tokenBuffer;constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){let e=this._next();if(e.type===T.map){let t=this._next();if(t.type===T.string&&t.value==="/"){let n=this._next();if(n.type===T.string){if(this._next().type!==T.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new G(T.tag,42,0)}if(n.type===T.map){let i=this._next();if(i.type===T.string&&i.value==="bytes"){let s=this._next();if(s.type===T.string){for(let a=0;a<2;a++)if(this._next().type!==T.break)throw new Error("Invalid encoded Bytes form");let o=oi.decode(`m${s.value}`);return new G(T.bytes,o,s.value.length)}this.tokenBuffer.push(s)}this.tokenBuffer.push(i)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}},Yy={codec:Fy,async*walk(r){let e=[],t=[];t[Wy]=n=>{let i=be.parse(n);return e.push(i),i},V0(r,{tags:t,tokenizer:new Gp(r,{tags:t,allowIndefinite:!0,allowUndefined:!0,allowNaN:!0,allowInfinity:!0,allowBigInt:!0,strict:!1,rejectDuplicateMapKeys:!1})}),yield*e}},Qy={codec:$8,async*walk(){}};var ok=[Hy,$y,Gy,Yy,Qy],Jy="/pin/",Xy="/pinned-block/",Yp=ss,jy=1;function Zy(r){return r.version===0&&(r=r.toV1()),new tt(`${Jy}${r.toString(Yp)}`)}var z0=class{datastore;blockstore;dagWalkers;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.dagWalkers={},[...ok,...n].forEach(i=>{this.dagWalkers[i.codec]=i})}async add(e,t={}){let n=Zy(e);if(await this.datastore.has(n))throw new Error("Already pinned");let i=Math.round(t.depth??1/0);if(i<0)throw new Error("Depth must be greater than or equal to 0");let s=new Ft({concurrency:jy});s.add(async()=>{await this.#e(e,s,c=>{c.pinnedBy.find(l=>ce(l,e.bytes))==null&&(c.pinCount++,c.pinnedBy.push(e.bytes))},{...t,depth:i})});let o=ge();s.on("error",c=>{s.clear(),o.reject(c)}),await Promise.race([s.onIdle(),o.promise]);let a={depth:i,metadata:t.metadata??{}};return await this.datastore.put(n,Sa(a),t),{cid:e,...a}}async#e(e,t,n,i){if(i.depth===-1)return;let s=this.dagWalkers[e.code];if(s==null)throw new Error(`No dag walker found for cid codec ${e.code}`);let o=await this.blockstore.get(e,i);await this.#t(e,n,i);for await(let a of s.walk(o))t.add(async()=>{await this.#e(a,t,n,{...i,depth:i.depth-1})})}async#t(e,t,n){let i=new tt(`${Xy}${Yp.encode(e.multihash.bytes)}`),s={pinCount:0,pinnedBy:[]};try{s=yn(await this.datastore.get(i,n))}catch(o){if(o.code!=="ERR_NOT_FOUND")throw o}if(t(s),s.pinCount===0&&await this.datastore.has(i)){await this.datastore.delete(i);return}await this.datastore.put(i,Sa(s),n),n.onProgress?.(new Le("helia:pin:add",{detail:e}))}async rm(e,t={}){let n=Zy(e),i=await this.datastore.get(n,t),s=yn(i);await this.datastore.delete(n,t);let o=new Ft({concurrency:jy});return o.add(async()=>{await this.#e(e,o,a=>{a.pinCount--,a.pinnedBy=a.pinnedBy.filter(c=>ce(c,e.bytes))},{...t,depth:s.depth})}),await o.onIdle(),{cid:e,...s}}async*ls(e={}){for await(let{key:t,value:n}of this.datastore.query({prefix:Jy+(e.cid!=null?`${e.cid.toString(ss)}`:"")},e)){let i=be.parse(t.toString().substring(5),ss),s=yn(n);yield{cid:i,...s}}}async isPinned(e,t={}){let n=new tt(`${Xy}${Yp.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}};var go=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Qp=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},e7=r=>globalThis.DOMException===void 0?new Qp(r):new DOMException(r),t7=r=>{let e=r.reason===void 0?e7("This operation was aborted."):r.reason;return e instanceof Error?e:e7(e)};function Vn(r,e){let{milliseconds:t,fallback:n,message:i,customTimers:s={setTimeout,clearTimeout}}=e,o,c=new Promise((l,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:h}=e;h.aborted&&u(t7(h)),h.addEventListener("abort",()=>{u(t7(h))})}if(t===Number.POSITIVE_INFINITY){r.then(l,u);return}let f=new go;o=s.setTimeout.call(void 0,()=>{if(n){try{l(n())}catch(h){u(h)}return}typeof r.cancel=="function"&&r.cancel(),i===!1?l():i instanceof Error?u(i):(f.message=i??`Promise timed out after ${t} milliseconds`,u(f))},t),(async()=>{try{l(await r)}catch(h){u(h)}})()}).finally(()=>{c.clear()});return c.clear=()=>{s.clearTimeout.call(void 0,o),o=void 0},c}var r7=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");var Xp="lock:worker:request-read",jp="lock:worker:release-read",Zp="lock:master:grant-read",Jp="lock:worker:request-write",e2="lock:worker:release-write",t2="lock:master:grant-write";var gs={},Ra=r=>{r.addEventListener("message",e=>{Ra.dispatchEvent("message",r,e)}),r.port!=null&&r.port.addEventListener("message",e=>{Ra.dispatchEvent("message",r,e)})};Ra.addEventListener=(r,e)=>{gs[r]==null&&(gs[r]=[]),gs[r].push(e)};Ra.removeEventListener=(r,e)=>{gs[r]!=null&&(gs[r]=gs[r].filter(t=>t===e))};Ra.dispatchEvent=function(r,e,t){gs[r]!=null&&gs[r].forEach(n=>n(e,t))};var r2=Ra;var n7=(r,e,t,n,i)=>(s,o)=>{if(o.data.type!==t)return;let a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};r.dispatchEvent(new MessageEvent(e,{data:{name:a.name,handler:async()=>(s.postMessage({type:i,name:a.name,identifier:a.identifier}),await new Promise(c=>{let l=u=>{if(u==null||u.data==null)return;let f={type:u.data.type,name:u.data.name,identifier:u.data.identifier};f.type===n&&f.identifier===a.identifier&&(s.removeEventListener("message",l),c())};s.addEventListener("message",l)}))}}))},i7=(r,e,t,n)=>async()=>{let i=r7();return globalThis.postMessage({type:e,identifier:i,name:r}),await new Promise(s=>{let o=a=>{if(a==null||a.data==null)return;let c={type:a.data.type,identifier:a.data.identifier};c.type===t&&c.identifier===i&&(globalThis.removeEventListener("message",o),s(()=>{globalThis.postMessage({type:n,identifier:i,name:r})}))};globalThis.addEventListener("message",o)})},ak={singleProcess:!1},s7=r=>{if(r=Object.assign({},ak,r),!!globalThis.document||r.singleProcess){let t=new EventTarget;return r2.addEventListener("message",n7(t,"requestReadLock",Xp,jp,Zp)),r2.addEventListener("message",n7(t,"requestWriteLock",Jp,e2,t2)),t}return{isWorker:!0,readLock:t=>i7(t,Xp,Zp,jp),writeLock:t=>i7(t,Jp,t2,e2)}};var yo={},ys;async function n2(r,e){let t,n=new Promise(i=>{t=i});return r.add(async()=>await Vn((async()=>await new Promise(i=>{t(()=>{i()})}))(),{milliseconds:e.timeout})),await n}var ck=(r,e)=>{if(ys.isWorker===!0)return{readLock:ys.readLock(r,e),writeLock:ys.writeLock(r,e)};let t=new Ft({concurrency:1}),n;return{async readLock(){if(n!=null)return await n2(n,e);n=new Ft({concurrency:e.concurrency,autoStart:!1});let i=n,s=n2(n,e);return t.add(async()=>(i.start(),await i.onIdle().then(()=>{n===i&&(n=null)}))),await s},async writeLock(){return n=null,await n2(t,e)}}},lk={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function gl(r){let e=Object.assign({},lk,r);return ys==null&&(ys=s7(e),ys.isWorker!==!0&&(ys.addEventListener("requestReadLock",t=>{yo[t.data.name]!=null&&yo[t.data.name].readLock().then(async n=>await t.data.handler().finally(()=>n()))}),ys.addEventListener("requestWriteLock",async t=>{yo[t.data.name]!=null&&yo[t.data.name].writeLock().then(async n=>await t.data.handler().finally(()=>n()))}))),yo[e.name]==null&&(yo[e.name]=ck(e.name,e)),yo[e.name]}var $0=class{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=gl({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await da(this.child),this.started=!0}async stop(){await pa(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){let i=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{i()}}async*putMany(e,t={}){let n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){let n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){let n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){let n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){let n=await this.lock.writeLock();try{let i=this;yield*this.child.deleteMany(async function*(){for await(let s of e){if(await i.pins.isPinned(s))throw new Error("CID was pinned");yield s}}(),t)}finally{n()}}async has(e,t={}){let n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){let t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}};var i2=new tt("/version"),o7=1;async function a7(r){if(!await r.has(i2)){await r.put(i2,Y(`${o7}`));return}let e=await r.get(i2),t=H(e);if(parseInt(t,10)!==o7)throw new Error("Unknown datastore version, a datastore migration may be required")}function c7(r=[]){return[Oe,G1,hn,...r]}var uk=D("helia:networked-storage");function fk(r){return typeof r.retrieve=="function"}function hk(r){return typeof r.announce=="function"}var H0=class{child;blockRetrievers;blockAnnouncers;hashers;started;constructor(e,t){this.child=e,this.blockRetrievers=(t.blockBrokers??[]).filter(fk),this.blockAnnouncers=(t.blockBrokers??[]).filter(hk),this.hashers=t.hashers??[],this.started=!1}isStarted(){return this.started}async start(){await da(this.child,...new Set([...this.blockRetrievers,...this.blockAnnouncers])),this.started=!0}async stop(){await pa(this.child,...new Set([...this.blockRetrievers,...this.blockAnnouncers])),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){return await this.child.has(e)?(n.onProgress?.(new Le("blocks:put:duplicate",e)),e):(n.onProgress?.(new Le("blocks:put:providers:notify",e)),this.blockAnnouncers.forEach(i=>{i.announce(e,t,n)}),n.onProgress?.(new Le("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){let n=wr(e,async({cid:s})=>{let o=await this.child.has(s);return o&&t.onProgress?.(new Le("blocks:put-many:duplicate",s)),!o}),i=oo(n,({cid:s,block:o})=>{t.onProgress?.(new Le("blocks:put-many:providers:notify",s)),this.blockAnnouncers.forEach(a=>{a.announce(s,o,t)})});t.onProgress?.(new Le("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(i,t)}async get(e,t={}){if(t.offline!==!0&&!await this.child.has(e)){t.onProgress?.(new Le("blocks:get:providers:get",e));let n=await l7(e,this.blockRetrievers,this.hashers,t);return t.onProgress?.(new Le("blocks:get:blockstore:put",e)),await this.child.put(e,n,t),t.onProgress?.(new Le("blocks:get:providers:notify",e)),this.blockAnnouncers.forEach(i=>{i.announce(e,n,t)}),n}return t.onProgress?.(new Le("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new Le("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(oo(e,async n=>{if(t.offline!==!0&&!await this.child.has(n)){t.onProgress?.(new Le("blocks:get-many:providers:get",n));let i=await l7(n,this.blockRetrievers,this.hashers,t);t.onProgress?.(new Le("blocks:get-many:blockstore:put",n)),await this.child.put(n,i,t),t.onProgress?.(new Le("blocks:get-many:providers:notify",n)),this.blockAnnouncers.forEach(s=>{s.announce(n,i,t)})}}))}async delete(e,t={}){t.onProgress?.(new Le("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new Le("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(let n of e)yield n}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new Le("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}},dk=(r,e)=>{let t=e.find(n=>n.code===r.multihash.code);if(t==null)throw new b(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`,"ERR_UNKNOWN_HASH_ALG");return async n=>{let i=await t.digest(n);if(!ce(i.digest,r.multihash.digest))throw new b("Hash of downloaded block did not match multihash from passed CID","ERR_HASH_MISMATCH")}};async function l7(r,e,t,n){let i=dk(r,t),s=new AbortController,o=xt([s.signal,n.signal]);try{return await Promise.any(e.map(async a=>{try{let c=!1,l=await a.retrieve(r,{...n,signal:o,validateFn:async u=>{await i(u),c=!0}});return c||await i(l),l}catch(c){throw uk.error("could not retrieve verified block for %c",r,c),c}}))}finally{o.clear()}}var s2=D("helia"),W0=class{libp2p;blockstore;datastore;pins;constructor(e){let t=c7(e.hashers),n={blockstore:e.blockstore,datastore:e.datastore,libp2p:e.libp2p,hashers:t},i=e.blockBrokers?.map(o=>o(n))??[Ap()(n),Tp()()],s=new H0(e.blockstore,{blockBrokers:i,hashers:t});this.pins=new z0(e.datastore,s,e.dagWalkers??[]),this.libp2p=e.libp2p,this.blockstore=new $0(s,this.pins,{holdGcLock:e.holdGcLock}),this.datastore=e.datastore}async start(){await a7(this.datastore),await da(this.blockstore),await this.libp2p.start()}async stop(){await this.libp2p.stop(),await pa(this.blockstore)}async gc(e={}){let t=await this.blockstore.lock.writeLock();try{let n=this,i=this.blockstore.unwrap();s2("gc start"),await Cr(i.deleteMany(async function*(){for await(let{cid:s}of i.getAll())try{if(await n.pins.isPinned(s,e))continue;yield s,e.onProgress?.(new Le("helia:gc:deleted",s))}catch(o){s2.error("Error during gc",o),e.onProgress?.(new Le("helia:gc:error",o))}}()))}finally{t()}s2("gc finished")}};var kf={};Pe(kf,{generateEphemeralKeyPair:()=>tb,generateKeyPair:()=>Ml,generateKeyPairFromSeed:()=>EB,importKey:()=>Va,keyStretcher:()=>ab,keysPBM:()=>Ba,marshalPrivateKey:()=>cm,marshalPublicKey:()=>Ul,supportedKeys:()=>mi,unmarshalPrivateKey:()=>vn,unmarshalPublicKey:()=>Lr});var Nre=de(El(),1),Ore=de(S9(),1);var Pf=de(Qe(),1);var Y2={};Pe(Y2,{Ed25519PrivateKey:()=>Io,Ed25519PublicKey:()=>Cl,generateKeyPair:()=>qL,generateKeyPairFromSeed:()=>G2,unmarshalEd25519PrivateKey:()=>KL,unmarshalEd25519PublicKey:()=>VL});function hf(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`Wrong positive integer: ${r}`)}function T2(r,...e){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(r.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${r.length}`)}function Sl(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");hf(r.outputLen),hf(r.blockLen)}function Ca(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function R9(r,e){T2(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var df=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;var I9=r=>r instanceof Uint8Array;var pf=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),$n=(r,e)=>r<<32-e|r>>>e,UO=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!UO)throw new Error("Non little-endian hardware is not supported");function D2(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function vs(r){if(typeof r=="string"&&(r=D2(r)),!I9(r))throw new Error(`expected Uint8Array, got ${typeof r}`);return r}function mf(...r){let e=new Uint8Array(r.reduce((n,i)=>n+i.length,0)),t=0;return r.forEach(n=>{if(!I9(n))throw new Error("Uint8Array expected");e.set(n,t),t+=n.length}),e}var Pa=class{clone(){return this._cloneInto()}},cee={}.toString;function gf(r){let e=n=>r().update(vs(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function _o(r=32){if(df&&typeof df.getRandomValues=="function")return df.getRandomValues(new Uint8Array(r));throw new Error("crypto.getRandomValues must be defined")}function FO(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),c=n?4:0,l=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}var ka=class extends Pa{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=pf(this.buffer)}update(e){Ca(this);let{view:t,buffer:n,blockLen:i}=this;e=vs(e);let s=e.length;for(let o=0;o<s;){let a=Math.min(i-this.pos,s-o);if(a===i){let c=pf(e);for(;i<=s-o;o+=i)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Ca(this),R9(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:s}=this,{pos:o}=this;t[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>i-o&&(this.process(n,0),o=0);for(let f=o;f<i;f++)t[f]=0;FO(n,i-8,BigInt(this.length*8),s),this.process(n,0);let a=pf(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,u[f],s)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:s,destroyed:o,pos:a}=this;return e.length=i,e.pos=a,e.finished=s,e.destroyed=o,i%t&&e.buffer.set(n),e}};var yf=BigInt(4294967295),C2=BigInt(32);function A9(r,e=!1){return e?{h:Number(r&yf),l:Number(r>>C2&yf)}:{h:Number(r>>C2&yf)|0,l:Number(r&yf)|0}}function KO(r,e=!1){let t=new Uint32Array(r.length),n=new Uint32Array(r.length);for(let i=0;i<r.length;i++){let{h:s,l:o}=A9(r[i],e);[t[i],n[i]]=[s,o]}return[t,n]}var VO=(r,e)=>BigInt(r>>>0)<<C2|BigInt(e>>>0),qO=(r,e,t)=>r>>>t,zO=(r,e,t)=>r<<32-t|e>>>t,$O=(r,e,t)=>r>>>t|e<<32-t,HO=(r,e,t)=>r<<32-t|e>>>t,WO=(r,e,t)=>r<<64-t|e>>>t-32,GO=(r,e,t)=>r>>>t-32|e<<64-t,YO=(r,e)=>e,QO=(r,e)=>r,XO=(r,e,t)=>r<<t|e>>>32-t,jO=(r,e,t)=>e<<t|r>>>32-t,ZO=(r,e,t)=>e<<t-32|r>>>64-t,JO=(r,e,t)=>r<<t-32|e>>>64-t;function eL(r,e,t,n){let i=(e>>>0)+(n>>>0);return{h:r+t+(i/2**32|0)|0,l:i|0}}var tL=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),rL=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,nL=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),iL=(r,e,t,n,i)=>e+t+n+i+(r/2**32|0)|0,sL=(r,e,t,n,i)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(i>>>0),oL=(r,e,t,n,i,s)=>e+t+n+i+s+(r/2**32|0)|0;var aL={fromBig:A9,split:KO,toBig:VO,shrSH:qO,shrSL:zO,rotrSH:$O,rotrSL:HO,rotrBH:WO,rotrBL:GO,rotr32H:YO,rotr32L:QO,rotlSH:XO,rotlSL:jO,rotlBH:ZO,rotlBL:JO,add:eL,add3L:tL,add3H:rL,add4L:nL,add4H:iL,add5H:oL,add5L:sL},Ae=aL;var[cL,lL]=(()=>Ae.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))))(),_s=new Uint32Array(80),Ss=new Uint32Array(80),P2=class extends ka{constructor(){super(128,64,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){let{Ah:e,Al:t,Bh:n,Bl:i,Ch:s,Cl:o,Dh:a,Dl:c,Eh:l,El:u,Fh:f,Fl:h,Gh:d,Gl:p,Hh:m,Hl:g}=this;return[e,t,n,i,s,o,a,c,l,u,f,h,d,p,m,g]}set(e,t,n,i,s,o,a,c,l,u,f,h,d,p,m,g){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=i|0,this.Ch=s|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=f|0,this.Fl=h|0,this.Gh=d|0,this.Gl=p|0,this.Hh=m|0,this.Hl=g|0}process(e,t){for(let E=0;E<16;E++,t+=4)_s[E]=e.getUint32(t),Ss[E]=e.getUint32(t+=4);for(let E=16;E<80;E++){let R=_s[E-15]|0,x=Ss[E-15]|0,v=Ae.rotrSH(R,x,1)^Ae.rotrSH(R,x,8)^Ae.shrSH(R,x,7),I=Ae.rotrSL(R,x,1)^Ae.rotrSL(R,x,8)^Ae.shrSL(R,x,7),_=_s[E-2]|0,k=Ss[E-2]|0,B=Ae.rotrSH(_,k,19)^Ae.rotrBH(_,k,61)^Ae.shrSH(_,k,6),L=Ae.rotrSL(_,k,19)^Ae.rotrBL(_,k,61)^Ae.shrSL(_,k,6),K=Ae.add4L(I,L,Ss[E-7],Ss[E-16]),W=Ae.add4H(K,v,B,_s[E-7],_s[E-16]);_s[E]=W|0,Ss[E]=K|0}let{Ah:n,Al:i,Bh:s,Bl:o,Ch:a,Cl:c,Dh:l,Dl:u,Eh:f,El:h,Fh:d,Fl:p,Gh:m,Gl:g,Hh:y,Hl:w}=this;for(let E=0;E<80;E++){let R=Ae.rotrSH(f,h,14)^Ae.rotrSH(f,h,18)^Ae.rotrBH(f,h,41),x=Ae.rotrSL(f,h,14)^Ae.rotrSL(f,h,18)^Ae.rotrBL(f,h,41),v=f&d^~f&m,I=h&p^~h&g,_=Ae.add5L(w,x,I,lL[E],Ss[E]),k=Ae.add5H(_,y,R,v,cL[E],_s[E]),B=_|0,L=Ae.rotrSH(n,i,28)^Ae.rotrBH(n,i,34)^Ae.rotrBH(n,i,39),K=Ae.rotrSL(n,i,28)^Ae.rotrBL(n,i,34)^Ae.rotrBL(n,i,39),W=n&s^n&a^s&a,te=i&o^i&c^o&c;y=m|0,w=g|0,m=d|0,g=p|0,d=f|0,p=h|0,{h:f,l:h}=Ae.add(l|0,u|0,k|0,B|0),l=a|0,u=c|0,a=s|0,c=o|0,s=n|0,o=i|0;let P=Ae.add3L(B,K,te);n=Ae.add3H(P,k,L,W),i=P|0}({h:n,l:i}=Ae.add(this.Ah|0,this.Al|0,n|0,i|0)),{h:s,l:o}=Ae.add(this.Bh|0,this.Bl|0,s|0,o|0),{h:a,l:c}=Ae.add(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=Ae.add(this.Dh|0,this.Dl|0,l|0,u|0),{h:f,l:h}=Ae.add(this.Eh|0,this.El|0,f|0,h|0),{h:d,l:p}=Ae.add(this.Fh|0,this.Fl|0,d|0,p|0),{h:m,l:g}=Ae.add(this.Gh|0,this.Gl|0,m|0,g|0),{h:y,l:w}=Ae.add(this.Hh|0,this.Hl|0,y|0,w|0),this.set(n,i,s,o,a,c,l,u,f,h,d,p,m,g,y,w)}roundClean(){_s.fill(0),Ss.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}};var k2=gf(()=>new P2);var Ef={};Pe(Ef,{bitGet:()=>gL,bitLen:()=>mL,bitMask:()=>Rl,bitSet:()=>yL,bytesToHex:()=>Ui,bytesToNumberBE:()=>Fi,bytesToNumberLE:()=>Hn,concatBytes:()=>Vi,createHmacDrbg:()=>L2,ensureBytes:()=>at,equalBytes:()=>dL,hexToBytes:()=>So,hexToNumber:()=>O2,numberToBytesBE:()=>Rs,numberToBytesLE:()=>Ki,numberToHexUnpadded:()=>C9,numberToVarBytesBE:()=>hL,utf8ToBytes:()=>pL,validateObject:()=>En});var D9=BigInt(0),bf=BigInt(1),uL=BigInt(2),wf=r=>r instanceof Uint8Array,fL=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Ui(r){if(!wf(r))throw new Error("Uint8Array expected");let e="";for(let t=0;t<r.length;t++)e+=fL[r[t]];return e}function C9(r){let e=r.toString(16);return e.length&1?`0${e}`:e}function O2(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return BigInt(r===""?"0":`0x${r}`)}function So(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);let e=r.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);let t=new Uint8Array(e/2);for(let n=0;n<t.length;n++){let i=n*2,s=r.slice(i,i+2),o=Number.parseInt(s,16);if(Number.isNaN(o)||o<0)throw new Error("Invalid byte sequence");t[n]=o}return t}function Fi(r){return O2(Ui(r))}function Hn(r){if(!wf(r))throw new Error("Uint8Array expected");return O2(Ui(Uint8Array.from(r).reverse()))}function Rs(r,e){return So(r.toString(16).padStart(e*2,"0"))}function Ki(r,e){return Rs(r,e).reverse()}function hL(r){return So(C9(r))}function at(r,e,t){let n;if(typeof e=="string")try{n=So(e)}catch(s){throw new Error(`${r} must be valid hex string, got "${e}". Cause: ${s}`)}else if(wf(e))n=Uint8Array.from(e);else throw new Error(`${r} must be hex string or Uint8Array`);let i=n.length;if(typeof t=="number"&&i!==t)throw new Error(`${r} expected ${t} bytes, got ${i}`);return n}function Vi(...r){let e=new Uint8Array(r.reduce((n,i)=>n+i.length,0)),t=0;return r.forEach(n=>{if(!wf(n))throw new Error("Uint8Array expected");e.set(n,t),t+=n.length}),e}function dL(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}function pL(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function mL(r){let e;for(e=0;r>D9;r>>=bf,e+=1);return e}function gL(r,e){return r>>BigInt(e)&bf}var yL=(r,e,t)=>r|(t?bf:D9)<<BigInt(e),Rl=r=>(uL<<BigInt(r-1))-bf,N2=r=>new Uint8Array(r),T9=r=>Uint8Array.from(r);function L2(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let n=N2(r),i=N2(r),s=0,o=()=>{n.fill(1),i.fill(0),s=0},a=(...f)=>t(i,n,...f),c=(f=N2())=>{i=a(T9([0]),f),n=a(),f.length!==0&&(i=a(T9([1]),f),n=a())},l=()=>{if(s++>=1e3)throw new Error("drbg: tried 1000 values");let f=0,h=[];for(;f<e;){n=a();let d=n.slice();h.push(d),f+=n.length}return Vi(...h)};return(f,h)=>{o(),c(f);let d;for(;!(d=h(l()));)c();return o(),d}}var bL={bigint:r=>typeof r=="bigint",function:r=>typeof r=="function",boolean:r=>typeof r=="boolean",string:r=>typeof r=="string",stringOrUint8Array:r=>typeof r=="string"||r instanceof Uint8Array,isSafeInteger:r=>Number.isSafeInteger(r),array:r=>Array.isArray(r),field:(r,e)=>e.Fp.isValid(r),hash:r=>typeof r=="function"&&Number.isSafeInteger(r.outputLen)};function En(r,e,t={}){let n=(i,s,o)=>{let a=bL[s];if(typeof a!="function")throw new Error(`Invalid validator "${s}", expected function`);let c=r[i];if(!(o&&c===void 0)&&!a(c,r))throw new Error(`Invalid param ${String(i)}=${c} (${typeof c}), expected ${s}`)};for(let[i,s]of Object.entries(e))n(i,s,!1);for(let[i,s]of Object.entries(t))n(i,s,!0);return r}var Kt=BigInt(0),pt=BigInt(1),Ro=BigInt(2),wL=BigInt(3),B2=BigInt(4),P9=BigInt(5),k9=BigInt(8),EL=BigInt(9),xL=BigInt(16);function ze(r,e){let t=r%e;return t>=Kt?t:e+t}function M2(r,e,t){if(t<=Kt||e<Kt)throw new Error("Expected power/modulo > 0");if(t===pt)return Kt;let n=pt;for(;e>Kt;)e&pt&&(n=n*r%t),r=r*r%t,e>>=pt;return n}function ct(r,e,t){let n=r;for(;e-- >Kt;)n*=n,n%=t;return n}function xf(r,e){if(r===Kt||e<=Kt)throw new Error(`invert: expected positive integers, got n=${r} mod=${e}`);let t=ze(r,e),n=e,i=Kt,s=pt,o=pt,a=Kt;for(;t!==Kt;){let l=n/t,u=n%t,f=i-o*l,h=s-a*l;n=t,t=u,i=o,s=a,o=f,a=h}if(n!==pt)throw new Error("invert: does not exist");return ze(i,e)}function vL(r){let e=(r-pt)/Ro,t,n,i;for(t=r-pt,n=0;t%Ro===Kt;t/=Ro,n++);for(i=Ro;i<r&&M2(i,e,r)!==r-pt;i++);if(n===1){let o=(r+pt)/B2;return function(c,l){let u=c.pow(l,o);if(!c.eql(c.sqr(u),l))throw new Error("Cannot find square root");return u}}let s=(t+pt)/Ro;return function(a,c){if(a.pow(c,e)===a.neg(a.ONE))throw new Error("Cannot find square root");let l=n,u=a.pow(a.mul(a.ONE,i),t),f=a.pow(c,s),h=a.pow(c,t);for(;!a.eql(h,a.ONE);){if(a.eql(h,a.ZERO))return a.ZERO;let d=1;for(let m=a.sqr(h);d<l&&!a.eql(m,a.ONE);d++)m=a.sqr(m);let p=a.pow(u,pt<<BigInt(l-d-1));u=a.sqr(p),f=a.mul(f,p),h=a.mul(h,u),l=d}return f}}function _L(r){if(r%B2===wL){let e=(r+pt)/B2;return function(n,i){let s=n.pow(i,e);if(!n.eql(n.sqr(s),i))throw new Error("Cannot find square root");return s}}if(r%k9===P9){let e=(r-P9)/k9;return function(n,i){let s=n.mul(i,Ro),o=n.pow(s,e),a=n.mul(i,o),c=n.mul(n.mul(a,Ro),o),l=n.mul(a,n.sub(c,n.ONE));if(!n.eql(n.sqr(l),i))throw new Error("Cannot find square root");return l}}return r%xL,vL(r)}var N9=(r,e)=>(ze(r,e)&pt)===pt,SL=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function U2(r){let e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},t=SL.reduce((n,i)=>(n[i]="function",n),e);return En(r,t)}function RL(r,e,t){if(t<Kt)throw new Error("Expected power > 0");if(t===Kt)return r.ONE;if(t===pt)return e;let n=r.ONE,i=e;for(;t>Kt;)t&pt&&(n=r.mul(n,i)),i=r.sqr(i),t>>=pt;return n}function IL(r,e){let t=new Array(e.length),n=e.reduce((s,o,a)=>r.is0(o)?s:(t[a]=s,r.mul(s,o)),r.ONE),i=r.inv(n);return e.reduceRight((s,o,a)=>r.is0(o)?s:(t[a]=r.mul(s,t[a]),r.mul(s,o)),i),t}function F2(r,e){let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function vf(r,e,t=!1,n={}){if(r<=Kt)throw new Error(`Expected Field ORDER > 0, got ${r}`);let{nBitLength:i,nByteLength:s}=F2(r,e);if(s>2048)throw new Error("Field lengths over 2048 bytes are not supported");let o=_L(r),a=Object.freeze({ORDER:r,BITS:i,BYTES:s,MASK:Rl(i),ZERO:Kt,ONE:pt,create:c=>ze(c,r),isValid:c=>{if(typeof c!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof c}`);return Kt<=c&&c<r},is0:c=>c===Kt,isOdd:c=>(c&pt)===pt,neg:c=>ze(-c,r),eql:(c,l)=>c===l,sqr:c=>ze(c*c,r),add:(c,l)=>ze(c+l,r),sub:(c,l)=>ze(c-l,r),mul:(c,l)=>ze(c*l,r),pow:(c,l)=>RL(a,c,l),div:(c,l)=>ze(c*xf(l,r),r),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>xf(c,r),sqrt:n.sqrt||(c=>o(a,c)),invertBatch:c=>IL(a,c),cmov:(c,l,u)=>u?l:c,toBytes:c=>t?Ki(c,s):Rs(c,s),fromBytes:c=>{if(c.length!==s)throw new Error(`Fp.fromBytes: expected ${s}, got ${c.length}`);return t?Hn(c):Fi(c)}});return Object.freeze(a)}function O9(r,e){if(!r.isOdd)throw new Error("Field doesn't have isOdd");let t=r.sqrt(e);return r.isOdd(t)?r.neg(t):t}function L9(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function K2(r){let e=L9(r);return e+Math.ceil(e/2)}function B9(r,e,t=!1){let n=r.length,i=L9(e),s=K2(e);if(n<16||n<s||n>1024)throw new Error(`expected ${s}-1024 bytes of input, got ${n}`);let o=t?Fi(r):Hn(r),a=ze(o,e-pt)+pt;return t?Ki(a,i):Rs(a,i)}var TL=BigInt(0),V2=BigInt(1);function _f(r,e){let t=(i,s)=>{let o=s.negate();return i?o:s},n=i=>{let s=Math.ceil(e/i)+1,o=2**(i-1);return{windows:s,windowSize:o}};return{constTimeNegate:t,unsafeLadder(i,s){let o=r.ZERO,a=i;for(;s>TL;)s&V2&&(o=o.add(a)),a=a.double(),s>>=V2;return o},precomputeWindow(i,s){let{windows:o,windowSize:a}=n(s),c=[],l=i,u=l;for(let f=0;f<o;f++){u=l,c.push(u);for(let h=1;h<a;h++)u=u.add(l),c.push(u);l=u.double()}return c},wNAF(i,s,o){let{windows:a,windowSize:c}=n(i),l=r.ZERO,u=r.BASE,f=BigInt(2**i-1),h=2**i,d=BigInt(i);for(let p=0;p<a;p++){let m=p*c,g=Number(o&f);o>>=d,g>c&&(g-=h,o+=V2);let y=m,w=m+Math.abs(g)-1,E=p%2!==0,R=g<0;g===0?u=u.add(t(E,s[y])):l=l.add(t(R,s[w]))}return{p:l,f:u}},wNAFCached(i,s,o,a){let c=i._WINDOW_SIZE||1,l=s.get(i);return l||(l=this.precomputeWindow(i,c),c!==1&&s.set(i,a(l))),this.wNAF(c,l,o)}}}function Il(r){return U2(r.Fp),En(r,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...F2(r.n,r.nBitLength),...r,p:r.Fp.ORDER})}var Wn=BigInt(0),jr=BigInt(1),Sf=BigInt(2),DL=BigInt(8),CL={zip215:!0};function PL(r){let e=Il(r);return En(r,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...e})}function Rf(r){let e=PL(r),{Fp:t,n,prehash:i,hash:s,randomBytes:o,nByteLength:a,h:c}=e,l=Sf<<BigInt(a*8)-jr,u=t.create,f=e.uvRatio||((U,A)=>{try{return{isValid:!0,value:t.sqrt(U*t.inv(A))}}catch{return{isValid:!1,value:Wn}}}),h=e.adjustScalarBytes||(U=>U),d=e.domain||((U,A,z)=>{if(A.length||z)throw new Error("Contexts/pre-hash are not supported");return U}),p=U=>typeof U=="bigint"&&Wn<U,m=(U,A)=>p(U)&&p(A)&&U<A,g=U=>U===Wn||m(U,l);function y(U,A){if(m(U,A))return U;throw new Error(`Expected valid scalar < ${A}, got ${typeof U} ${U}`)}function w(U){return U===Wn?U:y(U,n)}let E=new Map;function R(U){if(!(U instanceof x))throw new Error("ExtendedPoint expected")}class x{constructor(A,z,Q,Z){if(this.ex=A,this.ey=z,this.ez=Q,this.et=Z,!g(A))throw new Error("x required");if(!g(z))throw new Error("y required");if(!g(Q))throw new Error("z required");if(!g(Z))throw new Error("t required")}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(A){if(A instanceof x)throw new Error("extended point not allowed");let{x:z,y:Q}=A||{};if(!g(z)||!g(Q))throw new Error("invalid affine point");return new x(z,Q,jr,u(z*Q))}static normalizeZ(A){let z=t.invertBatch(A.map(Q=>Q.ez));return A.map((Q,Z)=>Q.toAffine(z[Z])).map(x.fromAffine)}_setWindowSize(A){this._WINDOW_SIZE=A,E.delete(this)}assertValidity(){let{a:A,d:z}=e;if(this.is0())throw new Error("bad point: ZERO");let{ex:Q,ey:Z,ez:me,et:we}=this,Ce=u(Q*Q),xe=u(Z*Z),Re=u(me*me),Je=u(Re*Re),Ye=u(Ce*A),ir=u(Re*u(Ye+xe)),sr=u(Je+u(z*u(Ce*xe)));if(ir!==sr)throw new Error("bad point: equation left != right (1)");let Bt=u(Q*Z),fr=u(me*we);if(Bt!==fr)throw new Error("bad point: equation left != right (2)")}equals(A){R(A);let{ex:z,ey:Q,ez:Z}=this,{ex:me,ey:we,ez:Ce}=A,xe=u(z*Ce),Re=u(me*Z),Je=u(Q*Ce),Ye=u(we*Z);return xe===Re&&Je===Ye}is0(){return this.equals(x.ZERO)}negate(){return new x(u(-this.ex),this.ey,this.ez,u(-this.et))}double(){let{a:A}=e,{ex:z,ey:Q,ez:Z}=this,me=u(z*z),we=u(Q*Q),Ce=u(Sf*u(Z*Z)),xe=u(A*me),Re=z+Q,Je=u(u(Re*Re)-me-we),Ye=xe+we,ir=Ye-Ce,sr=xe-we,Bt=u(Je*ir),fr=u(Ye*sr),Ii=u(Je*sr),eo=u(ir*Ye);return new x(Bt,fr,eo,Ii)}add(A){R(A);let{a:z,d:Q}=e,{ex:Z,ey:me,ez:we,et:Ce}=this,{ex:xe,ey:Re,ez:Je,et:Ye}=A;if(z===BigInt(-1)){let u8=u((me-Z)*(Re+xe)),f8=u((me+Z)*(Re-xe)),x1=u(f8-u8);if(x1===Wn)return this.double();let h8=u(we*Sf*Ye),d8=u(Ce*Sf*Je),p8=d8+h8,m8=f8+u8,g8=d8-h8,hT=u(p8*x1),dT=u(m8*g8),pT=u(p8*g8),mT=u(x1*m8);return new x(hT,dT,mT,pT)}let ir=u(Z*xe),sr=u(me*Re),Bt=u(Ce*Q*Ye),fr=u(we*Je),Ii=u((Z+me)*(xe+Re)-ir-sr),eo=fr-Bt,Kc=fr+Bt,l8=u(sr-z*ir),cT=u(Ii*eo),lT=u(Kc*l8),uT=u(Ii*l8),fT=u(eo*Kc);return new x(cT,lT,fT,uT)}subtract(A){return this.add(A.negate())}wNAF(A){return _.wNAFCached(this,E,A,x.normalizeZ)}multiply(A){let{p:z,f:Q}=this.wNAF(y(A,n));return x.normalizeZ([z,Q])[0]}multiplyUnsafe(A){let z=w(A);return z===Wn?I:this.equals(I)||z===jr?this:this.equals(v)?this.wNAF(z).p:_.unsafeLadder(this,z)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return _.unsafeLadder(this,n).is0()}toAffine(A){let{ex:z,ey:Q,ez:Z}=this,me=this.is0();A==null&&(A=me?DL:t.inv(Z));let we=u(z*A),Ce=u(Q*A),xe=u(Z*A);if(me)return{x:Wn,y:jr};if(xe!==jr)throw new Error("invZ was invalid");return{x:we,y:Ce}}clearCofactor(){let{h:A}=e;return A===jr?this:this.multiplyUnsafe(A)}static fromHex(A,z=!1){let{d:Q,a:Z}=e,me=t.BYTES;A=at("pointHex",A,me);let we=A.slice(),Ce=A[me-1];we[me-1]=Ce&-129;let xe=Hn(we);xe===Wn||(z?y(xe,l):y(xe,t.ORDER));let Re=u(xe*xe),Je=u(Re-jr),Ye=u(Q*Re-Z),{isValid:ir,value:sr}=f(Je,Ye);if(!ir)throw new Error("Point.fromHex: invalid y coordinate");let Bt=(sr&jr)===jr,fr=(Ce&128)!==0;if(!z&&sr===Wn&&fr)throw new Error("Point.fromHex: x=0 and x_0=1");return fr!==Bt&&(sr=u(-sr)),x.fromAffine({x:sr,y:xe})}static fromPrivateKey(A){return L(A).point}toRawBytes(){let{x:A,y:z}=this.toAffine(),Q=Ki(z,t.BYTES);return Q[Q.length-1]|=A&jr?128:0,Q}toHex(){return Ui(this.toRawBytes())}}x.BASE=new x(e.Gx,e.Gy,jr,u(e.Gx*e.Gy)),x.ZERO=new x(Wn,jr,jr,Wn);let{BASE:v,ZERO:I}=x,_=_f(x,a*8);function k(U){return ze(U,n)}function B(U){return k(Hn(U))}function L(U){let A=a;U=at("private key",U,A);let z=at("hashed private key",s(U),2*A),Q=h(z.slice(0,A)),Z=z.slice(A,2*A),me=B(Q),we=v.multiply(me),Ce=we.toRawBytes();return{head:Q,prefix:Z,scalar:me,point:we,pointBytes:Ce}}function K(U){return L(U).pointBytes}function W(U=new Uint8Array,...A){let z=Vi(...A);return B(s(d(z,at("context",U),!!i)))}function te(U,A,z={}){U=at("message",U),i&&(U=i(U));let{prefix:Q,scalar:Z,pointBytes:me}=L(A),we=W(z.context,Q,U),Ce=v.multiply(we).toRawBytes(),xe=W(z.context,Ce,me,U),Re=k(we+xe*Z);w(Re);let Je=Vi(Ce,Ki(Re,t.BYTES));return at("result",Je,a*2)}let P=CL;function N(U,A,z,Q=P){let{context:Z,zip215:me}=Q,we=t.BYTES;U=at("signature",U,2*we),A=at("message",A),i&&(A=i(A));let Ce=Hn(U.slice(we,2*we)),xe,Re,Je;try{xe=x.fromHex(z,me),Re=x.fromHex(U.slice(0,we),me),Je=v.multiplyUnsafe(Ce)}catch{return!1}if(!me&&xe.isSmallOrder())return!1;let Ye=W(Z,Re.toRawBytes(),xe.toRawBytes(),A);return Re.add(xe.multiplyUnsafe(Ye)).subtract(Je).clearCofactor().equals(x.ZERO)}return v._setWindowSize(8),{CURVE:e,getPublicKey:K,sign:te,verify:N,ExtendedPoint:x,utils:{getExtendedPublicKey:L,randomPrivateKey:()=>o(t.BYTES),precompute(U=8,A=x.BASE){return A._setWindowSize(U),A.multiply(BigInt(3)),A}}}}var Al=BigInt(0),q2=BigInt(1);function kL(r){return En(r,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...r})}function M9(r){let e=kL(r),{P:t}=e,n=E=>ze(E,t),i=e.montgomeryBits,s=Math.ceil(i/8),o=e.nByteLength,a=e.adjustScalarBytes||(E=>E),c=e.powPminus2||(E=>M2(E,t-BigInt(2),t));function l(E,R,x){let v=n(E*(R-x));return R=n(R-v),x=n(x+v),[R,x]}function u(E){if(typeof E=="bigint"&&Al<=E&&E<t)return E;throw new Error("Expected valid scalar 0 < scalar < CURVE.P")}let f=(e.a-BigInt(2))/BigInt(4);function h(E,R){let x=u(E),v=u(R),I=x,_=q2,k=Al,B=x,L=q2,K=Al,W;for(let P=BigInt(i-1);P>=Al;P--){let N=v>>P&q2;K^=N,W=l(K,_,B),_=W[0],B=W[1],W=l(K,k,L),k=W[0],L=W[1],K=N;let O=_+k,U=n(O*O),A=_-k,z=n(A*A),Q=U-z,Z=B+L,me=B-L,we=n(me*O),Ce=n(Z*A),xe=we+Ce,Re=we-Ce;B=n(xe*xe),L=n(I*n(Re*Re)),_=n(U*z),k=n(Q*(U+n(f*Q)))}W=l(K,_,B),_=W[0],B=W[1],W=l(K,k,L),k=W[0],L=W[1];let te=c(k);return n(_*te)}function d(E){return Ki(n(E),s)}function p(E){let R=at("u coordinate",E,s);return o===s&&(R[o-1]&=127),Hn(R)}function m(E){let R=at("scalar",E);if(R.length!==s&&R.length!==o)throw new Error(`Expected ${s} or ${o} bytes, got ${R.length}`);return Hn(a(R))}function g(E,R){let x=p(R),v=m(E),I=h(x,v);if(I===Al)throw new Error("Invalid private or public key received");return d(I)}let y=d(e.Gu);function w(E){return g(E,y)}return{scalarMult:g,scalarMultBase:w,getSharedSecret:(E,R)=>g(E,R),getPublicKey:E=>w(E),utils:{randomPrivateKey:()=>e.randomBytes(e.nByteLength)},GuBytes:y}}var Tl=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),U9=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752"),Oee=BigInt(0),NL=BigInt(1),z2=BigInt(2),OL=BigInt(5),F9=BigInt(10),LL=BigInt(20),BL=BigInt(40),K9=BigInt(80);function V9(r){let e=Tl,n=r*r%e*r%e,i=ct(n,z2,e)*n%e,s=ct(i,NL,e)*r%e,o=ct(s,OL,e)*s%e,a=ct(o,F9,e)*o%e,c=ct(a,LL,e)*a%e,l=ct(c,BL,e)*c%e,u=ct(l,K9,e)*l%e,f=ct(u,K9,e)*l%e,h=ct(f,F9,e)*o%e;return{pow_p_5_8:ct(h,z2,e)*r%e,b2:n}}function q9(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}function ML(r,e){let t=Tl,n=ze(e*e*e,t),i=ze(n*n*e,t),s=V9(r*i).pow_p_5_8,o=ze(r*n*s,t),a=ze(e*o*o,t),c=o,l=ze(o*U9,t),u=a===r,f=a===ze(-r,t),h=a===ze(-r*U9,t);return u&&(o=c),(f||h)&&(o=l),N9(o,t)&&(o=ze(-o,t)),{isValid:u||f,value:o}}var qi=vf(Tl,void 0,!0),$2={a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:qi,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:BigInt(8),Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:k2,randomBytes:_o,adjustScalarBytes:q9,uvRatio:ML},Na=Rf($2);function z9(r,e,t){if(e.length>255)throw new Error("Context is too big");return mf(D2("SigEd25519 no Ed25519 collisions"),new Uint8Array([t?1:0,e.length]),e,r)}var Lee=Rf({...$2,domain:z9}),Bee=Rf({...$2,domain:z9,prehash:k2}),Dl=(()=>M9({P:Tl,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:r=>{let e=Tl,{pow_p_5_8:t,b2:n}=V9(r);return ze(ct(t,BigInt(3),e)*n,e)},adjustScalarBytes:q9,randomBytes:_o}))();var UL=(qi.ORDER+BigInt(3))/BigInt(8),Mee=qi.pow(z2,UL),Uee=qi.sqrt(qi.neg(qi.ONE)),Fee=(qi.ORDER-BigInt(5))/BigInt(8),Kee=BigInt(486662);var Vee=O9(qi,qi.neg(BigInt(486664)));var qee=BigInt("25063068953384623474111414158702152701244531502492656460079210482610430750235"),zee=BigInt("54469307008909316920995813868745141605393597292927456921205312896311721017578"),$ee=BigInt("1159843021668779879193775521855586647937357759715417654439879720876111806838"),Hee=BigInt("40440834346308536858101042469323190826248399146238708352240133220865137265952");var Wee=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff");var Oa=32,zi=64,If=32;async function $9(){let r=Na.utils.randomPrivateKey(),e=Na.getPublicKey(r);return{privateKey:Y9(r,e),publicKey:e}}async function H9(r){if(r.length!==If)throw new TypeError('"seed" must be 32 bytes in length.');if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');let e=r,t=Na.getPublicKey(e);return{privateKey:Y9(e,t),publicKey:t}}async function W9(r,e){let t=r.subarray(0,If);return Na.sign(e,t)}async function G9(r,e,t){return Na.verify(e,t,r)}function Y9(r,e){let t=new Uint8Array(zi);for(let n=0;n<If;n++)t[n]=r[n],t[If+n]=e[n];return t}var Tt={get(r=globalThis){let e=r.crypto;if(e==null||e.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p-crypto/blob/master/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};var H2={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function Af(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,i=r?.digest??"SHA-256",s=r?.saltLength??16,o=r?.iterations??32767,a=Tt.get();t*=8;async function c(f,h){let d=a.getRandomValues(new Uint8Array(s)),p=a.getRandomValues(new Uint8Array(n)),m={name:e,iv:p};typeof h=="string"&&(h=Y(h));let g;if(h.length===0){g=await a.subtle.importKey("jwk",H2,{name:"AES-GCM"},!0,["encrypt"]);try{let w={name:"PBKDF2",salt:d,iterations:o,hash:{name:i}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);g=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}catch{g=await a.subtle.importKey("jwk",H2,{name:"AES-GCM"},!0,["encrypt"])}}else{let w={name:"PBKDF2",salt:d,iterations:o,hash:{name:i}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);g=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}let y=await a.subtle.encrypt(m,g,f);return ve([d,m.iv,new Uint8Array(y)])}async function l(f,h){let d=f.subarray(0,s),p=f.subarray(s,s+n),m=f.subarray(s+n),g={name:e,iv:p};typeof h=="string"&&(h=Y(h));let y;if(h.length===0)try{let E={name:"PBKDF2",salt:d,iterations:o,hash:{name:i}},R=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(E,R,{name:e,length:t},!0,["decrypt"])}catch{y=await a.subtle.importKey("jwk",H2,{name:"AES-GCM"},!0,["decrypt"])}else{let E={name:"PBKDF2",salt:d,iterations:o,hash:{name:i}},R=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(E,R,{name:e,length:t},!0,["decrypt"])}let w=await a.subtle.decrypt(g,y,m);return new Uint8Array(w)}return{encrypt:c,decrypt:l}}async function La(r,e){let n=await Af().encrypt(r,e);return oi.encode(n)}var Ba={};Pe(Ba,{KeyType:()=>lt,PrivateKey:()=>Yn,PublicKey:()=>Gn});var lt;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})(lt||(lt={}));var W2;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})(W2||(W2={}));(function(r){r.codec=()=>ht(W2)})(lt||(lt={}));var Gn;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),lt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.Type=lt.codec().decode(t);break;case 2:i.Data=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(Gn||(Gn={}));var Yn;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),lt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.Type=lt.codec().decode(t);break;case 2:i.Data=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(Yn||(Yn={}));var Cl=class{_key;constructor(e){this._key=Ma(e,Oa)}async verify(e,t){return G9(this._key,t,e)}marshal(){return this._key}get bytes(){return Gn.encode({Type:lt.Ed25519,Data:this.marshal()}).subarray()}equals(e){return ce(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Oe.digest(this.bytes);return e}},Io=class{_key;_publicKey;constructor(e,t){this._key=Ma(e,zi),this._publicKey=Ma(t,Oa)}async sign(e){return W9(this._key,e)}get public(){return new Cl(this._publicKey)}marshal(){return this._key}get bytes(){return Yn.encode({Type:lt.Ed25519,Data:this.marshal()}).subarray()}equals(e){return ce(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Oe.digest(this.bytes);return e}async id(){let e=hn.digest(this.public.bytes);return Ee.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return La(this.bytes,e);throw new b(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function KL(r){if(r.length>zi){r=Ma(r,zi+Oa);let n=r.subarray(0,zi),i=r.subarray(zi,r.length);return new Io(n,i)}r=Ma(r,zi);let e=r.subarray(0,zi),t=r.subarray(Oa);return new Io(e,t)}function VL(r){return r=Ma(r,Oa),new Cl(r)}async function qL(){let{privateKey:r,publicKey:e}=await $9();return new Io(r,e)}async function G2(r){let{privateKey:e,publicKey:t}=await H9(r);return new Io(e,t)}function Ma(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new b(`Key must be a Uint8Array of length ${e}, got ${r.length}`,"ERR_INVALID_KEY_TYPE");return r}var cte=de(At(),1),lte=de(cf(),1),X9=de(Qe(),1);function Qn(r,e){let t=Uint8Array.from(r.abs().toByteArray());if(t=t[0]===0?t.subarray(1):t,e!=null){if(t.length>e)throw new Error("byte array longer than desired length");t=ve([new Uint8Array(e-t.length),t])}return H(t,"base64url")}function Zr(r){let e=Tf(r);return new X9.default.jsbn.BigInteger(H(e,"base16"),16)}function Tf(r,e){let t=Y(r,"base64urlpad");if(e!=null){if(t.length>e)throw new Error("byte array longer than desired length");t=ve([new Uint8Array(e-t.length),t])}return t}var j9={"P-256":256,"P-384":384,"P-521":521},zL=Object.keys(j9),Q2=zL.join(" / ");async function Z9(r){if(r!=="P-256"&&r!=="P-384"&&r!=="P-521")throw new b(`Unknown curve: ${r}. Must be ${Q2}`,"ERR_INVALID_CURVE");let e=await Tt.get().subtle.generateKey({name:"ECDH",namedCurve:r},!0,["deriveBits"]),t=async(s,o)=>{let a;o!=null?a=await Tt.get().subtle.importKey("jwk",HL(r,o),{name:"ECDH",namedCurve:r},!1,["deriveBits"]):a=e.privateKey;let c=await Tt.get().subtle.importKey("jwk",eb(r,s),{name:"ECDH",namedCurve:r},!1,[]),l=await Tt.get().subtle.deriveBits({name:"ECDH",namedCurve:r,public:c},a,j9[r]);return new Uint8Array(l,0,l.byteLength)},n=await Tt.get().subtle.exportKey("jwk",e.publicKey);return{key:$L(n),genSharedKey:t}}var J9={"P-256":32,"P-384":48,"P-521":66};function $L(r){if(r.crv==null||r.x==null||r.y==null)throw new b("JWK was missing components","ERR_INVALID_PARAMETERS");if(r.crv!=="P-256"&&r.crv!=="P-384"&&r.crv!=="P-521")throw new b(`Unknown curve: ${r.crv}. Must be ${Q2}`,"ERR_INVALID_CURVE");let e=J9[r.crv];return ve([Uint8Array.from([4]),Tf(r.x,e),Tf(r.y,e)],1+e*2)}function eb(r,e){if(r!=="P-256"&&r!=="P-384"&&r!=="P-521")throw new b(`Unknown curve: ${r}. Must be ${Q2}`,"ERR_INVALID_CURVE");let t=J9[r];if(!ce(e.subarray(0,1),Uint8Array.from([4])))throw new b("Cannot unmarshal public key - invalid key format","ERR_INVALID_KEY_FORMAT");return{kty:"EC",crv:r,x:H(e.subarray(1,t+1),"base64url"),y:H(e.subarray(1+t),"base64url"),ext:!0}}var HL=(r,e)=>({...eb(r,e.public),d:H(e.private,"base64url")});var tb=Z9;async function rb(r,e){let t=oi.decode(r);return Af().decrypt(t,e)}var nb={SHA1:20,SHA256:32,SHA512:64};var WL={SHA1:"SHA-1",SHA256:"SHA-256",SHA512:"SHA-512"},GL=async(r,e)=>{let t=await Tt.get().subtle.sign({name:"HMAC"},r,e);return new Uint8Array(t,0,t.byteLength)};async function ib(r,e){let t=WL[r],n=await Tt.get().subtle.importKey("raw",e,{name:"HMAC",hash:{name:t}},!1,["sign"]);return{async digest(i){return GL(n,i)},length:nb[r]}}var ob={"AES-128":{ivSize:16,keySize:16},"AES-256":{ivSize:16,keySize:32},Blowfish:{ivSize:8,keySize:32}};async function ab(r,e,t){let n=ob[r];if(n==null){let w=Object.keys(ob).join(" / ");throw new b(`unknown cipher type '${r}'. Must be ${w}`,"ERR_INVALID_CIPHER_TYPE")}if(e==null)throw new b("missing hash type","ERR_MISSING_HASH_TYPE");let i=n.keySize,s=n.ivSize,o=20,a=Y("key expansion"),c=2*(s+i+o),l=await ib(e,t),u=await l.digest(a),f=[],h=0;for(;h<c;){let w=await l.digest(ve([u,a])),E=w.length;h+E>c&&(E=c-h),f.push(w),h+=E,u=await l.digest(u)}let d=c/2,p=ve(f),m=p.subarray(0,d),g=p.subarray(d,c),y=w=>({iv:w.subarray(0,s),cipherKey:w.subarray(s,s+i),macKey:w.subarray(s+i)});return{k1:y(m),k2:y(g)}}var em={};Pe(em,{MAX_KEY_SIZE:()=>Ol,RsaPrivateKey:()=>Ua,RsaPublicKey:()=>Nl,fromJwk:()=>nB,generateKeyPair:()=>iB,unmarshalRsaPrivateKey:()=>tB,unmarshalRsaPublicKey:()=>rB});var kl=de(Qe(),1);var ere=de(hb(),1);function Or(r){if(isNaN(r)||r<=0)throw new b("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return _o(r)}var Bte=de(ff(),1),Z2=de(Qe(),1);function db(r,e){return e.map(t=>Zr(r[t]))}function pb(r){return Z2.default.pki.setRsaPrivateKey(...db(r,["n","e","d","p","q","dp","dq","qi"]))}function mb(r){return Z2.default.pki.setRsaPublicKey(...db(r,["n","e"]))}var To={};Pe(To,{jwkToPkcs1:()=>XL,jwkToPkix:()=>ZL,pkcs1ToJwk:()=>QL,pkixToJwk:()=>jL});var Fte=de(El(),1),Kte=de(ff(),1);var $i=de(Qe(),1);function QL(r){let e=$i.default.asn1.fromDer(H(r,"ascii")),t=$i.default.pki.privateKeyFromAsn1(e);return{kty:"RSA",n:Qn(t.n),e:Qn(t.e),d:Qn(t.d),p:Qn(t.p),q:Qn(t.q),dp:Qn(t.dP),dq:Qn(t.dQ),qi:Qn(t.qInv),alg:"RS256"}}function XL(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new b("JWK was missing components","ERR_INVALID_PARAMETERS");let e=$i.default.pki.privateKeyToAsn1({n:Zr(r.n),e:Zr(r.e),d:Zr(r.d),p:Zr(r.p),q:Zr(r.q),dP:Zr(r.dp),dQ:Zr(r.dq),qInv:Zr(r.qi)});return Y($i.default.asn1.toDer(e).getBytes(),"ascii")}function jL(r){let e=$i.default.asn1.fromDer(H(r,"ascii")),t=$i.default.pki.publicKeyFromAsn1(e);return{kty:"RSA",n:Qn(t.n),e:Qn(t.e)}}function ZL(r){if(r.n==null||r.e==null)throw new b("JWK was missing components","ERR_INVALID_PARAMETERS");let e=$i.default.pki.publicKeyToAsn1({n:Zr(r.n),e:Zr(r.e)});return Y($i.default.asn1.toDer(e).getBytes(),"ascii")}async function gb(r){let e=await Tt.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await wb(e);return{privateKey:t[0],publicKey:t[1]}}async function J2(r){let t=[await Tt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await JL(r)],n=await wb({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function yb(r,e){let t=await Tt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await Tt.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,Uint8Array.from(e));return new Uint8Array(n,0,n.byteLength)}async function bb(r,e,t){let n=await Tt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Tt.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t)}async function wb(r){if(r.privateKey==null||r.publicKey==null)throw new b("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([Tt.get().subtle.exportKey("jwk",r.privateKey),Tt.get().subtle.exportKey("jwk",r.publicKey)])}async function JL(r){return Tt.get().subtle.importKey("jwk",{kty:r.kty,n:r.n,e:r.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function Eb(r,e,t,n){let i=e?mb(r):pb(r),s=H(Uint8Array.from(t),"ascii"),o=n(s,i);return Y(o,"ascii")}function xb(r,e){return Eb(r,!0,e,(t,n)=>n.encrypt(t))}function vb(r,e){return Eb(r,!1,e,(t,n)=>n.decrypt(t))}function Df(r){if(r.kty!=="RSA")throw new b("invalid key type","ERR_INVALID_KEY_TYPE");if(r.n==null)throw new b("invalid key modulus","ERR_INVALID_KEY_MODULUS");return Y(r.n,"base64url").length*8}var Ol=8192,Nl=class{_key;constructor(e){this._key=e}async verify(e,t){return bb(this._key,t,e)}marshal(){return To.jwkToPkix(this._key)}get bytes(){return Gn.encode({Type:lt.RSA,Data:this.marshal()}).subarray()}encrypt(e){return xb(this._key,e)}equals(e){return ce(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Oe.digest(this.bytes);return e}},Ua=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return Or(16)}async sign(e){return yb(this._key,e)}get public(){if(this._publicKey==null)throw new b("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new Nl(this._publicKey)}decrypt(e){return vb(this._key,e)}marshal(){return To.jwkToPkcs1(this._key)}get bytes(){return Yn.encode({Type:lt.RSA,Data:this.marshal()}).subarray()}equals(e){return ce(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Oe.digest(this.bytes);return e}async id(){let e=await this.public.hash();return H(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8"){let n=new kl.default.util.ByteBuffer(this.marshal()),i=kl.default.asn1.fromDer(n),s=kl.default.pki.privateKeyFromAsn1(i),o={algorithm:"aes256",count:1e4,saltSize:128/8,prfAlgorithm:"sha512"};return kl.default.pki.encryptRsaPrivateKey(s,e,o)}else{if(t==="libp2p-key")return La(this.bytes,e);throw new b(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}};async function tB(r){let e=To.pkcs1ToJwk(r);if(Df(e)>Ol)throw new b("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let t=await J2(e);return new Ua(t.privateKey,t.publicKey)}function rB(r){let e=To.pkixToJwk(r);if(Df(e)>Ol)throw new b("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new Nl(e)}async function nB(r){if(Df(r)>Ol)throw new b("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await J2(r);return new Ua(e.privateKey,e.publicKey)}async function iB(r){if(r>Ol)throw new b("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await gb(r);return new Ua(e.privateKey,e.publicKey)}var sm={};Pe(sm,{Secp256k1PrivateKey:()=>Bl,Secp256k1PublicKey:()=>Ll,generateKeyPair:()=>wB,unmarshalSecp256k1PrivateKey:()=>yB,unmarshalSecp256k1PublicKey:()=>bB});var sB=(r,e,t)=>r&e^~r&t,oB=(r,e,t)=>r&e^r&t^e&t,aB=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Is=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),As=new Uint32Array(64),tm=class extends ka{constructor(){super(64,32,8,!1),this.A=Is[0]|0,this.B=Is[1]|0,this.C=Is[2]|0,this.D=Is[3]|0,this.E=Is[4]|0,this.F=Is[5]|0,this.G=Is[6]|0,this.H=Is[7]|0}get(){let{A:e,B:t,C:n,D:i,E:s,F:o,G:a,H:c}=this;return[e,t,n,i,s,o,a,c]}set(e,t,n,i,s,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=s|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)As[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){let h=As[f-15],d=As[f-2],p=$n(h,7)^$n(h,18)^h>>>3,m=$n(d,17)^$n(d,19)^d>>>10;As[f]=m+As[f-7]+p+As[f-16]|0}let{A:n,B:i,C:s,D:o,E:a,F:c,G:l,H:u}=this;for(let f=0;f<64;f++){let h=$n(a,6)^$n(a,11)^$n(a,25),d=u+h+sB(a,c,l)+aB[f]+As[f]|0,m=($n(n,2)^$n(n,13)^$n(n,22))+oB(n,i,s)|0;u=l,l=c,c=a,a=o+d|0,o=s,s=i,i=n,n=d+m|0}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(n,i,s,o,a,c,l,u)}roundClean(){As.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var Fa=gf(()=>new tm);function cB(r){let e=Il(r);En(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});let{endo:t,Fp:n,a:i}=e;if(t){if(!n.eql(i,n.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof t!="object"||typeof t.beta!="bigint"||typeof t.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}var{bytesToNumberBE:lB,hexToBytes:uB}=Ef,Do={Err:class extends Error{constructor(e=""){super(e)}},_parseInt(r){let{Err:e}=Do;if(r.length<2||r[0]!==2)throw new e("Invalid signature integer tag");let t=r[1],n=r.subarray(2,t+2);if(!t||n.length!==t)throw new e("Invalid signature integer: wrong length");if(n[0]&128)throw new e("Invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new e("Invalid signature integer: unnecessary leading zero");return{d:lB(n),l:r.subarray(t+2)}},toSig(r){let{Err:e}=Do,t=typeof r=="string"?uB(r):r;if(!(t instanceof Uint8Array))throw new Error("ui8a expected");let n=t.length;if(n<2||t[0]!=48)throw new e("Invalid signature tag");if(t[1]!==n-2)throw new e("Invalid signature: incorrect length");let{d:i,l:s}=Do._parseInt(t.subarray(2)),{d:o,l:a}=Do._parseInt(s);if(a.length)throw new e("Invalid signature: left bytes after parsing");return{r:i,s:o}},hexFromSig(r){let e=l=>Number.parseInt(l[0],16)&8?"00"+l:l,t=l=>{let u=l.toString(16);return u.length&1?`0${u}`:u},n=e(t(r.s)),i=e(t(r.r)),s=n.length/2,o=i.length/2,a=t(s),c=t(o);return`30${t(o+s+4)}02${c}${i}02${a}${n}`}},Hi=BigInt(0),xn=BigInt(1),lre=BigInt(2),_b=BigInt(3),ure=BigInt(4);function fB(r){let e=cB(r),{Fp:t}=e,n=e.toBytes||((p,m,g)=>{let y=m.toAffine();return Vi(Uint8Array.from([4]),t.toBytes(y.x),t.toBytes(y.y))}),i=e.fromBytes||(p=>{let m=p.subarray(1),g=t.fromBytes(m.subarray(0,t.BYTES)),y=t.fromBytes(m.subarray(t.BYTES,2*t.BYTES));return{x:g,y}});function s(p){let{a:m,b:g}=e,y=t.sqr(p),w=t.mul(y,p);return t.add(t.add(w,t.mul(p,m)),g)}if(!t.eql(t.sqr(e.Gy),s(e.Gx)))throw new Error("bad generator point: equation left != right");function o(p){return typeof p=="bigint"&&Hi<p&&p<e.n}function a(p){if(!o(p))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function c(p){let{allowedPrivateKeyLengths:m,nByteLength:g,wrapPrivateKey:y,n:w}=e;if(m&&typeof p!="bigint"){if(p instanceof Uint8Array&&(p=Ui(p)),typeof p!="string"||!m.includes(p.length))throw new Error("Invalid key");p=p.padStart(g*2,"0")}let E;try{E=typeof p=="bigint"?p:Fi(at("private key",p,g))}catch{throw new Error(`private key must be ${g} bytes, hex or bigint, not ${typeof p}`)}return y&&(E=ze(E,w)),a(E),E}let l=new Map;function u(p){if(!(p instanceof f))throw new Error("ProjectivePoint expected")}class f{constructor(m,g,y){if(this.px=m,this.py=g,this.pz=y,m==null||!t.isValid(m))throw new Error("x required");if(g==null||!t.isValid(g))throw new Error("y required");if(y==null||!t.isValid(y))throw new Error("z required")}static fromAffine(m){let{x:g,y}=m||{};if(!m||!t.isValid(g)||!t.isValid(y))throw new Error("invalid affine point");if(m instanceof f)throw new Error("projective point not allowed");let w=E=>t.eql(E,t.ZERO);return w(g)&&w(y)?f.ZERO:new f(g,y,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(m){let g=t.invertBatch(m.map(y=>y.pz));return m.map((y,w)=>y.toAffine(g[w])).map(f.fromAffine)}static fromHex(m){let g=f.fromAffine(i(at("pointHex",m)));return g.assertValidity(),g}static fromPrivateKey(m){return f.BASE.multiply(c(m))}_setWindowSize(m){this._WINDOW_SIZE=m,l.delete(this)}assertValidity(){if(this.is0()){if(e.allowInfinityPoint&&!t.is0(this.py))return;throw new Error("bad point: ZERO")}let{x:m,y:g}=this.toAffine();if(!t.isValid(m)||!t.isValid(g))throw new Error("bad point: x or y not FE");let y=t.sqr(g),w=s(m);if(!t.eql(y,w))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){let{y:m}=this.toAffine();if(t.isOdd)return!t.isOdd(m);throw new Error("Field doesn't support isOdd")}equals(m){u(m);let{px:g,py:y,pz:w}=this,{px:E,py:R,pz:x}=m,v=t.eql(t.mul(g,x),t.mul(E,w)),I=t.eql(t.mul(y,x),t.mul(R,w));return v&&I}negate(){return new f(this.px,t.neg(this.py),this.pz)}double(){let{a:m,b:g}=e,y=t.mul(g,_b),{px:w,py:E,pz:R}=this,x=t.ZERO,v=t.ZERO,I=t.ZERO,_=t.mul(w,w),k=t.mul(E,E),B=t.mul(R,R),L=t.mul(w,E);return L=t.add(L,L),I=t.mul(w,R),I=t.add(I,I),x=t.mul(m,I),v=t.mul(y,B),v=t.add(x,v),x=t.sub(k,v),v=t.add(k,v),v=t.mul(x,v),x=t.mul(L,x),I=t.mul(y,I),B=t.mul(m,B),L=t.sub(_,B),L=t.mul(m,L),L=t.add(L,I),I=t.add(_,_),_=t.add(I,_),_=t.add(_,B),_=t.mul(_,L),v=t.add(v,_),B=t.mul(E,R),B=t.add(B,B),_=t.mul(B,L),x=t.sub(x,_),I=t.mul(B,k),I=t.add(I,I),I=t.add(I,I),new f(x,v,I)}add(m){u(m);let{px:g,py:y,pz:w}=this,{px:E,py:R,pz:x}=m,v=t.ZERO,I=t.ZERO,_=t.ZERO,k=e.a,B=t.mul(e.b,_b),L=t.mul(g,E),K=t.mul(y,R),W=t.mul(w,x),te=t.add(g,y),P=t.add(E,R);te=t.mul(te,P),P=t.add(L,K),te=t.sub(te,P),P=t.add(g,w);let N=t.add(E,x);return P=t.mul(P,N),N=t.add(L,W),P=t.sub(P,N),N=t.add(y,w),v=t.add(R,x),N=t.mul(N,v),v=t.add(K,W),N=t.sub(N,v),_=t.mul(k,P),v=t.mul(B,W),_=t.add(v,_),v=t.sub(K,_),_=t.add(K,_),I=t.mul(v,_),K=t.add(L,L),K=t.add(K,L),W=t.mul(k,W),P=t.mul(B,P),K=t.add(K,W),W=t.sub(L,W),W=t.mul(k,W),P=t.add(P,W),L=t.mul(K,P),I=t.add(I,L),L=t.mul(N,P),v=t.mul(te,v),v=t.sub(v,L),L=t.mul(te,K),_=t.mul(N,_),_=t.add(_,L),new f(v,I,_)}subtract(m){return this.add(m.negate())}is0(){return this.equals(f.ZERO)}wNAF(m){return d.wNAFCached(this,l,m,g=>{let y=t.invertBatch(g.map(w=>w.pz));return g.map((w,E)=>w.toAffine(y[E])).map(f.fromAffine)})}multiplyUnsafe(m){let g=f.ZERO;if(m===Hi)return g;if(a(m),m===xn)return this;let{endo:y}=e;if(!y)return d.unsafeLadder(this,m);let{k1neg:w,k1:E,k2neg:R,k2:x}=y.splitScalar(m),v=g,I=g,_=this;for(;E>Hi||x>Hi;)E&xn&&(v=v.add(_)),x&xn&&(I=I.add(_)),_=_.double(),E>>=xn,x>>=xn;return w&&(v=v.negate()),R&&(I=I.negate()),I=new f(t.mul(I.px,y.beta),I.py,I.pz),v.add(I)}multiply(m){a(m);let g=m,y,w,{endo:E}=e;if(E){let{k1neg:R,k1:x,k2neg:v,k2:I}=E.splitScalar(g),{p:_,f:k}=this.wNAF(x),{p:B,f:L}=this.wNAF(I);_=d.constTimeNegate(R,_),B=d.constTimeNegate(v,B),B=new f(t.mul(B.px,E.beta),B.py,B.pz),y=_.add(B),w=k.add(L)}else{let{p:R,f:x}=this.wNAF(g);y=R,w=x}return f.normalizeZ([y,w])[0]}multiplyAndAddUnsafe(m,g,y){let w=f.BASE,E=(x,v)=>v===Hi||v===xn||!x.equals(w)?x.multiplyUnsafe(v):x.multiply(v),R=E(this,g).add(E(m,y));return R.is0()?void 0:R}toAffine(m){let{px:g,py:y,pz:w}=this,E=this.is0();m==null&&(m=E?t.ONE:t.inv(w));let R=t.mul(g,m),x=t.mul(y,m),v=t.mul(w,m);if(E)return{x:t.ZERO,y:t.ZERO};if(!t.eql(v,t.ONE))throw new Error("invZ was invalid");return{x:R,y:x}}isTorsionFree(){let{h:m,isTorsionFree:g}=e;if(m===xn)return!0;if(g)return g(f,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){let{h:m,clearCofactor:g}=e;return m===xn?this:g?g(f,this):this.multiplyUnsafe(e.h)}toRawBytes(m=!0){return this.assertValidity(),n(f,this,m)}toHex(m=!0){return Ui(this.toRawBytes(m))}}f.BASE=new f(e.Gx,e.Gy,t.ONE),f.ZERO=new f(t.ZERO,t.ONE,t.ZERO);let h=e.nBitLength,d=_f(f,e.endo?Math.ceil(h/2):h);return{CURVE:e,ProjectivePoint:f,normPrivateKeyToScalar:c,weierstrassEquation:s,isWithinCurveOrder:o}}function hB(r){let e=Il(r);return En(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function Sb(r){let e=hB(r),{Fp:t,n}=e,i=t.BYTES+1,s=2*t.BYTES+1;function o(P){return Hi<P&&P<t.ORDER}function a(P){return ze(P,n)}function c(P){return xf(P,n)}let{ProjectivePoint:l,normPrivateKeyToScalar:u,weierstrassEquation:f,isWithinCurveOrder:h}=fB({...e,toBytes(P,N,O){let U=N.toAffine(),A=t.toBytes(U.x),z=Vi;return O?z(Uint8Array.from([N.hasEvenY()?2:3]),A):z(Uint8Array.from([4]),A,t.toBytes(U.y))},fromBytes(P){let N=P.length,O=P[0],U=P.subarray(1);if(N===i&&(O===2||O===3)){let A=Fi(U);if(!o(A))throw new Error("Point is not on curve");let z=f(A),Q=t.sqrt(z),Z=(Q&xn)===xn;return(O&1)===1!==Z&&(Q=t.neg(Q)),{x:A,y:Q}}else if(N===s&&O===4){let A=t.fromBytes(U.subarray(0,t.BYTES)),z=t.fromBytes(U.subarray(t.BYTES,2*t.BYTES));return{x:A,y:z}}else throw new Error(`Point of length ${N} was invalid. Expected ${i} compressed bytes or ${s} uncompressed bytes`)}}),d=P=>Ui(Rs(P,e.nByteLength));function p(P){let N=n>>xn;return P>N}function m(P){return p(P)?a(-P):P}let g=(P,N,O)=>Fi(P.slice(N,O));class y{constructor(N,O,U){this.r=N,this.s=O,this.recovery=U,this.assertValidity()}static fromCompact(N){let O=e.nByteLength;return N=at("compactSignature",N,O*2),new y(g(N,0,O),g(N,O,2*O))}static fromDER(N){let{r:O,s:U}=Do.toSig(at("DER",N));return new y(O,U)}assertValidity(){if(!h(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!h(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(N){return new y(this.r,this.s,N)}recoverPublicKey(N){let{r:O,s:U,recovery:A}=this,z=I(at("msgHash",N));if(A==null||![0,1,2,3].includes(A))throw new Error("recovery id invalid");let Q=A===2||A===3?O+e.n:O;if(Q>=t.ORDER)throw new Error("recovery id 2 or 3 invalid");let Z=A&1?"03":"02",me=l.fromHex(Z+d(Q)),we=c(Q),Ce=a(-z*we),xe=a(U*we),Re=l.BASE.multiplyAndAddUnsafe(me,Ce,xe);if(!Re)throw new Error("point at infinify");return Re.assertValidity(),Re}hasHighS(){return p(this.s)}normalizeS(){return this.hasHighS()?new y(this.r,a(-this.s),this.recovery):this}toDERRawBytes(){return So(this.toDERHex())}toDERHex(){return Do.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return So(this.toCompactHex())}toCompactHex(){return d(this.r)+d(this.s)}}let w={isValidPrivateKey(P){try{return u(P),!0}catch{return!1}},normPrivateKeyToScalar:u,randomPrivateKey:()=>{let P=K2(e.n);return B9(e.randomBytes(P),e.n)},precompute(P=8,N=l.BASE){return N._setWindowSize(P),N.multiply(BigInt(3)),N}};function E(P,N=!0){return l.fromPrivateKey(P).toRawBytes(N)}function R(P){let N=P instanceof Uint8Array,O=typeof P=="string",U=(N||O)&&P.length;return N?U===i||U===s:O?U===2*i||U===2*s:P instanceof l}function x(P,N,O=!0){if(R(P))throw new Error("first arg must be private key");if(!R(N))throw new Error("second arg must be public key");return l.fromHex(N).multiply(u(P)).toRawBytes(O)}let v=e.bits2int||function(P){let N=Fi(P),O=P.length*8-e.nBitLength;return O>0?N>>BigInt(O):N},I=e.bits2int_modN||function(P){return a(v(P))},_=Rl(e.nBitLength);function k(P){if(typeof P!="bigint")throw new Error("bigint expected");if(!(Hi<=P&&P<_))throw new Error(`bigint expected < 2^${e.nBitLength}`);return Rs(P,e.nByteLength)}function B(P,N,O=L){if(["recovered","canonical"].some(Ye=>Ye in O))throw new Error("sign() legacy options not supported");let{hash:U,randomBytes:A}=e,{lowS:z,prehash:Q,extraEntropy:Z}=O;z==null&&(z=!0),P=at("msgHash",P),Q&&(P=at("prehashed msgHash",U(P)));let me=I(P),we=u(N),Ce=[k(we),k(me)];if(Z!=null){let Ye=Z===!0?A(t.BYTES):Z;Ce.push(at("extraEntropy",Ye))}let xe=Vi(...Ce),Re=me;function Je(Ye){let ir=v(Ye);if(!h(ir))return;let sr=c(ir),Bt=l.BASE.multiply(ir).toAffine(),fr=a(Bt.x);if(fr===Hi)return;let Ii=a(sr*a(Re+fr*we));if(Ii===Hi)return;let eo=(Bt.x===fr?0:2)|Number(Bt.y&xn),Kc=Ii;return z&&p(Ii)&&(Kc=m(Ii),eo^=1),new y(fr,Kc,eo)}return{seed:xe,k2sig:Je}}let L={lowS:e.lowS,prehash:!1},K={lowS:e.lowS,prehash:!1};function W(P,N,O=L){let{seed:U,k2sig:A}=B(P,N,O),z=e;return L2(z.hash.outputLen,z.nByteLength,z.hmac)(U,A)}l.BASE._setWindowSize(8);function te(P,N,O,U=K){let A=P;if(N=at("msgHash",N),O=at("publicKey",O),"strict"in U)throw new Error("options.strict was renamed to lowS");let{lowS:z,prehash:Q}=U,Z,me;try{if(typeof A=="string"||A instanceof Uint8Array)try{Z=y.fromDER(A)}catch(Bt){if(!(Bt instanceof Do.Err))throw Bt;Z=y.fromCompact(A)}else if(typeof A=="object"&&typeof A.r=="bigint"&&typeof A.s=="bigint"){let{r:Bt,s:fr}=A;Z=new y(Bt,fr)}else throw new Error("PARSE");me=l.fromHex(O)}catch(Bt){if(Bt.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(z&&Z.hasHighS())return!1;Q&&(N=e.hash(N));let{r:we,s:Ce}=Z,xe=I(N),Re=c(Ce),Je=a(xe*Re),Ye=a(we*Re),ir=l.BASE.multiplyAndAddUnsafe(me,Je,Ye)?.toAffine();return ir?a(ir.x)===we:!1}return{CURVE:e,getPublicKey:E,getSharedSecret:x,sign:W,verify:te,ProjectivePoint:l,Signature:y,utils:w}}var Cf=class extends Pa{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Sl(e);let n=vs(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let i=this.blockLen,s=new Uint8Array(i);s.set(n.length>i?e.create().update(n).digest():n);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=e.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),s.fill(0)}update(e){return Ca(this),this.iHash.update(e),this}digestInto(e){Ca(this),T2(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:n,finished:i,destroyed:s,blockLen:o,outputLen:a}=this;return e=e,e.finished=i,e.destroyed=s,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},Ka=(r,e,t)=>new Cf(r,e).update(t).digest();Ka.create=(r,e)=>new Cf(r,e);function dB(r){return{hash:r,hmac:(e,...t)=>Ka(r,e,mf(...t)),randomBytes:_o}}function Rb(r,e){let t=n=>Sb({...r,...dB(n)});return Object.freeze({...t(e),create:t})}var Tb=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),Ib=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),pB=BigInt(1),rm=BigInt(2),Ab=(r,e)=>(r+e/rm)/e;function mB(r){let e=Tb,t=BigInt(3),n=BigInt(6),i=BigInt(11),s=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,u=l*l*r%e,f=ct(u,t,e)*u%e,h=ct(f,t,e)*u%e,d=ct(h,rm,e)*l%e,p=ct(d,i,e)*d%e,m=ct(p,s,e)*p%e,g=ct(m,a,e)*m%e,y=ct(g,c,e)*g%e,w=ct(y,a,e)*m%e,E=ct(w,t,e)*u%e,R=ct(E,o,e)*p%e,x=ct(R,n,e)*l%e,v=ct(x,rm,e);if(!nm.eql(nm.sqr(v),r))throw new Error("Cannot find square root");return v}var nm=vf(Tb,void 0,void 0,{sqrt:mB}),Wi=Rb({a:BigInt(0),b:BigInt(7),Fp:nm,n:Ib,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{let e=Ib,t=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-pB*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),i=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),s=t,o=BigInt("0x100000000000000000000000000000000"),a=Ab(s*r,e),c=Ab(-n*r,e),l=ze(r-a*t-c*i,e),u=ze(-a*n-c*s,e),f=l>o,h=u>o;if(f&&(l=e-l),h&&(u=e-u),l>o||u>o)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:f,k1:l,k2neg:h,k2:u}}}},Fa),vre=BigInt(0);var _re=Wi.ProjectivePoint;function Db(){return Wi.utils.randomPrivateKey()}async function Cb(r,e){let{digest:t}=await Oe.digest(e);try{return Wi.sign(t,r).toDERRawBytes()}catch(n){throw new b(String(n),"ERR_INVALID_INPUT")}}async function Pb(r,e,t){try{let{digest:n}=await Oe.digest(t);return Wi.verify(e,n,r)}catch(n){throw new b(String(n),"ERR_INVALID_INPUT")}}function kb(r){return Wi.ProjectivePoint.fromHex(r).toRawBytes(!0)}function Nb(r){try{Wi.getPublicKey(r,!0)}catch(e){throw new b(String(e),"ERR_INVALID_PRIVATE_KEY")}}function im(r){try{Wi.ProjectivePoint.fromHex(r)}catch(e){throw new b(String(e),"ERR_INVALID_PUBLIC_KEY")}}function Ob(r){try{return Wi.getPublicKey(r,!0)}catch(e){throw new b(String(e),"ERR_INVALID_PRIVATE_KEY")}}var Ll=class{_key;constructor(e){im(e),this._key=e}async verify(e,t){return Pb(this._key,t,e)}marshal(){return kb(this._key)}get bytes(){return Gn.encode({Type:lt.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return ce(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Oe.digest(this.bytes);return e}},Bl=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??Ob(e),Nb(this._key),im(this._publicKey)}async sign(e){return Cb(this._key,e)}get public(){return new Ll(this._publicKey)}marshal(){return this._key}get bytes(){return Yn.encode({Type:lt.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return ce(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Oe.digest(this.bytes);return e}async id(){let e=await this.public.hash();return H(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return La(this.bytes,e);throw new b(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function yB(r){return new Bl(r)}function bB(r){return new Ll(r)}async function wB(){let r=Db();return new Bl(r)}var mi={rsa:em,ed25519:Y2,secp256k1:sm};function om(r){let e=Object.keys(mi).join(" / ");return new b(`invalid or unsupported key type ${r}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function am(r){if(r=r.toLowerCase(),r==="rsa"||r==="ed25519"||r==="secp256k1")return mi[r];throw om(r)}async function Ml(r,e){return am(r).generateKeyPair(e??2048)}async function EB(r,e,t){if(r.toLowerCase()!=="ed25519")throw new b("Seed key derivation is unimplemented for RSA or secp256k1","ERR_UNSUPPORTED_KEY_DERIVATION_TYPE");return G2(e)}function Lr(r){let e=Gn.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case lt.RSA:return mi.rsa.unmarshalRsaPublicKey(t);case lt.Ed25519:return mi.ed25519.unmarshalEd25519PublicKey(t);case lt.Secp256k1:return mi.secp256k1.unmarshalSecp256k1PublicKey(t);default:throw om(e.Type??"unknown")}}function Ul(r,e){return e=(e??"rsa").toLowerCase(),am(e),r.bytes}async function vn(r){let e=Yn.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case lt.RSA:return mi.rsa.unmarshalRsaPrivateKey(t);case lt.Ed25519:return mi.ed25519.unmarshalEd25519PrivateKey(t);case lt.Secp256k1:return mi.secp256k1.unmarshalSecp256k1PrivateKey(t);default:throw om(e.Type??"RSA")}}function cm(r,e){return e=(e??"rsa").toLowerCase(),am(e),r.bytes}async function Va(r,e){try{let i=await rb(r,e);return await vn(i)}catch{}let t=Pf.default.pki.decryptRsaPrivateKey(r,e);if(t===null)throw new b("Cannot read the key, most likely the password is wrong or not a RSA key","ERR_CANNOT_DECRYPT_PEM");let n=Pf.default.asn1.toDer(Pf.default.pki.privateKeyToAsn1(t));return n=Y(n.getBytes(),"ascii"),mi.rsa.unmarshalRsaPrivateKey(n)}var Co=Symbol.for("@libp2p/content-routing");var Fe=class extends EventTarget{#e=new Map;listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let i=this.#e.get(e);i==null&&(i=[],this.#e.set(e,i)),i.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let i=this.#e.get(e);i!=null&&(i=i.filter(({callback:s})=>s!==t),this.#e.set(e,i))}dispatchEvent(e){let t=super.dispatchEvent(e),n=this.#e.get(e.type);return n==null||(n=n.filter(({once:i})=>!i),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t){return this.dispatchEvent(new Ge(e,t))}},lm=class extends Event{detail;constructor(e,t){super(e,t),this.detail=t?.detail}},Ge=globalThis.CustomEvent??lm;var nt=(r,...e)=>{try{[...e]}catch{}};var Po=Symbol.for("@libp2p/peer-discovery");var ko=Symbol.for("@libp2p/peer-routing");var Qre=de(J0(),1),xB=de(Qe(),1);var Bb=de(b2(),1),Mb=de(At(),1),Lb={sha1:"sha1","sha2-256":"sha256","sha2-512":"sha512"};function Fl(r,e,t,n,i){if(i!=="sha1"&&i!=="sha2-256"&&i!=="sha2-512"){let a=Object.keys(Lb).join(" / ");throw new b(`Hash '${i}' is unknown or not supported. Must be ${a}`,"ERR_UNSUPPORTED_HASH_TYPE")}let s=Lb[i],o=(0,Bb.default)(r,e,t,n,s);return Mb.default.encode64(o,null)}var um=Symbol.for("@libp2p/peer-id");function qa(r){return r!=null&&!!r[um]}var SB=Symbol.for("nodejs.util.inspect.custom"),Ub=Object.values(dn).map(r=>r.decoder).reduce((r,e)=>r.or(e),dn.identity.decoder),Fb=114,fm=36,hm=37,Kl=class{type;multihash;privateKey;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[um]=!0;toString(){return this.string==null&&(this.string=Ee.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return be.createV1(Fb,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(e instanceof Uint8Array)return ce(this.multihash.bytes,e);if(typeof e=="string")return ae(e).equals(this);if(e?.multihash?.bytes!=null)return ce(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[SB](){return`PeerId(${this.toString()})`}},No=class extends Kl{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},Oo=class extends Kl{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.multihash.digest}},Lo=class extends Kl{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.multihash.digest}};function Kb(r){if(r.type==="RSA")return new No(r);if(r.type==="Ed25519")return new Oo(r);if(r.type==="secp256k1")return new Lo(r);throw new b("Not a PeerId","ERR_INVALID_PARAMETERS")}function ae(r,e){if(e=e??Ub,r.charAt(0)==="1"||r.charAt(0)==="Q"){let t=Ln(Ee.decode(`z${r}`));return r.startsWith("12D")?new Oo({multihash:t}):r.startsWith("16U")?new Lo({multihash:t}):new No({multihash:t})}return it(Ub.decode(r))}function it(r){try{let e=Ln(r);if(e.code===hn.code){if(e.digest.length===fm)return new Oo({multihash:e});if(e.digest.length===hm)return new Lo({multihash:e})}if(e.code===Oe.code)return new No({multihash:e})}catch{return RB(be.decode(r))}throw new Error("Supplied PeerID CID is invalid")}function RB(r){if(r==null||r.multihash==null||r.version==null||r.version===1&&r.code!==Fb)throw new Error("Supplied PeerID CID is invalid");let e=r.multihash;if(e.code===Oe.code)return new No({multihash:r.multihash});if(e.code===hn.code){if(e.digest.length===fm)return new Oo({multihash:r.multihash});if(e.digest.length===hm)return new Lo({multihash:r.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function ar(r,e){return r.length===fm?new Oo({multihash:On(hn.code,r),privateKey:e}):r.length===hm?new Lo({multihash:On(hn.code,r),privateKey:e}):new No({multihash:await Oe.digest(r),publicKey:r,privateKey:e})}var Qb=de(Yb(),1),Ts=Qb.default;var sw=de(iw(),1);var Me;(function(r){r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",r.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",r.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",r.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",r.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",r.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",r.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",r.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",r.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",r.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",r.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",r.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",r.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",r.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH"})(Me||(Me={}));var Lf=D("libp2p:keychain"),$B="/pkcs8/",ow="/info/",Bo=new WeakMap,Mo={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},pm={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function Gi(r){return r==null||typeof r!="string"?!1:r===(0,sw.default)(r.trim())&&r.length>0}async function je(){let t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function gi(r){return new tt($B+r)}function Ds(r){return new tt(ow+r)}var Uo=class{components;init;constructor(e,t){if(this.components=e,this.init=Ts(pm,t),this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<Mo.minKeyLength)throw new Error(`dek.keyLength must be least ${Mo.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<Mo.minSaltLength)throw new Error(`dek.saltLength must be least ${Mo.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<Mo.minIterationCount)throw new Error(`dek.iterationCount must be least ${Mo.minIterationCount}`);let n=this.init.pass!=null&&this.init.dek?.salt!=null?Fl(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Bo.set(this,{dek:n})}static generateOptions(){let e=Object.assign({},pm),t=Math.ceil(Mo.minSaltLength/3)*3;return e.dek.salt=H(Or(t),"base64"),e}static get options(){return pm}async createKey(e,t,n=2048){if(!Gi(e)||e==="self")throw await je(),new b("Invalid key name",Me.ERR_INVALID_KEY_NAME);if(typeof t!="string")throw await je(),new b("Invalid key type",Me.ERR_INVALID_KEY_TYPE);let i=gi(e);if(await this.components.datastore.has(i))throw await je(),new b("Key name already exists",Me.ERR_KEY_ALREADY_EXISTS);switch(t.toLowerCase()){case"rsa":if(!Number.isSafeInteger(n)||n<2048)throw await je(),new b("Invalid RSA key size",Me.ERR_INVALID_KEY_SIZE);break;default:break}let o;try{let a=await Ml(t,n),c=await a.id(),l=Bo.get(this);if(l==null)throw new b("dek missing",Me.ERR_INVALID_PARAMETERS);let u=l.dek,f=await a.export(u);o={name:e,id:c};let h=this.components.datastore.batch();h.put(i,Y(f)),h.put(Ds(e),Y(JSON.stringify(o))),await h.commit()}catch(a){throw await je(),a}return o}async listKeys(){let e={prefix:ow},t=[];for await(let n of this.components.datastore.query(e))t.push(JSON.parse(H(n.value)));return t}async findKeyById(e){try{let n=(await this.listKeys()).find(i=>i.id===e);if(n==null)throw new b(`Key with id '${e}' does not exist.`,Me.ERR_KEY_NOT_FOUND);return n}catch(t){throw await je(),t}}async findKeyByName(e){if(!Gi(e))throw await je(),new b(`Invalid key name '${e}'`,Me.ERR_INVALID_KEY_NAME);let t=Ds(e);try{let n=await this.components.datastore.get(t);return JSON.parse(H(n))}catch(n){throw await je(),Lf.error(n),new b(`Key '${e}' does not exist.`,Me.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!Gi(e)||e==="self")throw await je(),new b(`Invalid key name '${e}'`,Me.ERR_INVALID_KEY_NAME);let t=gi(e),n=await this.findKeyByName(e),i=this.components.datastore.batch();return i.delete(t),i.delete(Ds(e)),await i.commit(),n}async renameKey(e,t){if(!Gi(e)||e==="self")throw await je(),new b(`Invalid old key name '${e}'`,Me.ERR_OLD_KEY_NAME_INVALID);if(!Gi(t)||t==="self")throw await je(),new b(`Invalid new key name '${t}'`,Me.ERR_NEW_KEY_NAME_INVALID);let n=gi(e),i=gi(t),s=Ds(e),o=Ds(t);if(await this.components.datastore.has(i))throw await je(),new b(`Key '${t}' already exists`,Me.ERR_KEY_ALREADY_EXISTS);try{let c=await this.components.datastore.get(n),l=await this.components.datastore.get(s),u=JSON.parse(H(l));u.name=t;let f=this.components.datastore.batch();return f.put(i,c),f.put(o,Y(JSON.stringify(u))),f.delete(n),f.delete(s),await f.commit(),u}catch(c){throw await je(),c}}async exportKey(e,t){if(!Gi(e))throw await je(),new b(`Invalid key name '${e}'`,Me.ERR_INVALID_KEY_NAME);if(t==null)throw await je(),new b("Password is required",Me.ERR_PASSWORD_REQUIRED);let n=gi(e);try{let i=await this.components.datastore.get(n),s=H(i),o=Bo.get(this);if(o==null)throw new b("dek missing",Me.ERR_INVALID_PARAMETERS);let a=o.dek;return await(await Va(s,a)).export(t)}catch(i){throw await je(),i}}async exportPeerId(e){let t="temporary-password",n=await this.exportKey(e,t),i=await Va(n,t);return ar(i.public.bytes,i.bytes)}async importKey(e,t,n){if(!Gi(e)||e==="self")throw await je(),new b(`Invalid key name '${e}'`,Me.ERR_INVALID_KEY_NAME);if(t==null)throw await je(),new b("PEM encoded key is required",Me.ERR_PEM_REQUIRED);let i=gi(e);if(await this.components.datastore.has(i))throw await je(),new b(`Key '${e}' already exists`,Me.ERR_KEY_ALREADY_EXISTS);let o;try{o=await Va(t,n)}catch{throw await je(),new b("Cannot read the key, most likely the password is wrong",Me.ERR_CANNOT_READ_KEY)}let a;try{a=await o.id();let u=Bo.get(this);if(u==null)throw new b("dek missing",Me.ERR_INVALID_PARAMETERS);let f=u.dek;t=await o.export(f)}catch(u){throw await je(),u}let c={name:e,id:a},l=this.components.datastore.batch();return l.put(i,Y(t)),l.put(Ds(e),Y(JSON.stringify(c))),await l.commit(),c}async importPeer(e,t){try{if(!Gi(e))throw new b(`Invalid key name '${e}'`,Me.ERR_INVALID_KEY_NAME);if(t==null)throw new b("PeerId is required",Me.ERR_MISSING_PRIVATE_KEY);if(t.privateKey==null)throw new b("PeerId.privKey is required",Me.ERR_MISSING_PRIVATE_KEY);let n=await vn(t.privateKey),i=gi(e);if(await this.components.datastore.has(i))throw await je(),new b(`Key '${e}' already exists`,Me.ERR_KEY_ALREADY_EXISTS);let o=Bo.get(this);if(o==null)throw new b("dek missing",Me.ERR_INVALID_PARAMETERS);let a=o.dek,c=await n.export(a),l={name:e,id:t.toString()},u=this.components.datastore.batch();return u.put(i,Y(c)),u.put(Ds(e),Y(JSON.stringify(l))),await u.commit(),l}catch(n){throw await je(),n}}async getPrivateKey(e){if(!Gi(e))throw await je(),new b(`Invalid key name '${e}'`,Me.ERR_INVALID_KEY_NAME);try{let t=gi(e),n=await this.components.datastore.get(t);return H(n)}catch(t){throw await je(),Lf.error(t),new b(`Key '${e}' does not exist.`,Me.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await je(),new b(`Invalid old pass type '${typeof e}'`,Me.ERR_INVALID_OLD_PASS_TYPE);if(typeof t!="string")throw await je(),new b(`Invalid new pass type '${typeof t}'`,Me.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await je(),new b(`Invalid pass length ${t.length}`,Me.ERR_INVALID_PASS_LENGTH);Lf("recreating keychain");let n=Bo.get(this);if(n==null)throw new b("dek missing",Me.ERR_INVALID_PARAMETERS);let i=n.dek;this.init.pass=t;let s=t!=null&&this.init.dek?.salt!=null?Fl(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Bo.set(this,{dek:s});let o=await this.listKeys();for(let a of o){let c=await this.components.datastore.get(gi(a.name)),l=H(c),u=await Va(l,i),f=s.toString(),h=await u.export(f),d=this.components.datastore.batch(),p={name:a.name,id:a.id};d.put(gi(a.name),Y(h)),d.put(Ds(a.name),Y(JSON.stringify(p))),await d.commit()}Lf("keychain reconstructed")}};function Yi(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),i=n.value;return n.done===!0||i==null?{done:!0,value:void 0}:{done:!1,value:e(i)}}};return t}var Xt=class{map;constructor(e){if(this.map=new Map,e!=null)for(let[t,n]of e.entries())this.map.set(t.toString(),n)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){this.map.delete(e.toString())}entries(){return Yi(this.map.entries(),e=>[ae(e[0]),e[1]])}forEach(e){this.map.forEach((t,n)=>{e(t,ae(n),this)})}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return Yi(this.map.keys(),e=>ae(e))}values(){return this.map.values()}get size(){return this.map.size}};var _n=class r{set;constructor(e){if(this.set=new Set,e!=null)for(let t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Yi(this.set.entries(),e=>{let t=ae(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{let n=ae(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Yi(this.set.values(),e=>ae(e))}intersection(e){let t=new r;for(let n of e)this.has(n)&&t.add(n);return t}difference(e){let t=new r;for(let n of this)e.has(n)||t.add(n);return t}union(e){let t=new r;for(let n of e)t.add(n);for(let n of this)t.add(n);return t}};var mm=class r{list;constructor(e){if(this.list=[],e!=null)for(let t of e)this.list.push(t.toString())}[Symbol.iterator](){return Yi(this.list.entries(),e=>ae(e[1]))}concat(e){let t=new r(this);for(let n of e)t.push(n);return t}entries(){return Yi(this.list.entries(),e=>[e[0],ae(e[1])])}every(e){return this.list.every((t,n)=>e(ae(t),n,this))}filter(e){let t=new r;return this.list.forEach((n,i)=>{let s=ae(n);e(s,i,this)&&t.push(s)}),t}find(e){let t=this.list.find((n,i)=>e(ae(n),i,this));if(t!=null)return ae(t)}findIndex(e){return this.list.findIndex((t,n)=>e(ae(t),n,this))}forEach(e){this.list.forEach((t,n)=>{e(ae(t),n,this)})}includes(e){return this.list.includes(e.toString())}indexOf(e){return this.list.indexOf(e.toString())}pop(){let e=this.list.pop();if(e!=null)return ae(e)}push(...e){for(let t of e)this.list.push(t.toString())}shift(){let e=this.list.shift();if(e!=null)return ae(e)}unshift(...e){let t=this.list.length;for(let n=e.length-1;n>-1;n--)t=this.list.unshift(e[n].toString());return t}get length(){return this.list.length}};var gm;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.id!=null&&(n.uint32(10),n.bytes(t.id)),t.pubKey!=null&&(n.uint32(18),n.bytes(t.pubKey)),t.privKey!=null&&(n.uint32(26),n.bytes(t.privKey)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.id=t.bytes();break;case 2:i.pubKey=t.bytes();break;case 3:i.privKey=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(gm||(gm={}));var Bf=async()=>{let r=await Ml("Ed25519"),e=await HB(r);if(e.type==="Ed25519")return e;throw new Error(`Generated unexpected PeerId type "${e.type}"`)};async function HB(r){return ar(Ul(r.public),cm(r))}var aw={ERR_SIGNATURE_NOT_VALID:"ERR_SIGNATURE_NOT_VALID"};var Vl;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.publicKey=t.bytes();break;case 2:i.payloadType=t.bytes();break;case 3:i.payload=t.bytes();break;case 5:i.signature=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(Vl||(Vl={}));var Sn=class r{static createFromProtobuf=async e=>{let t=Vl.decode(e),n=await ar(t.publicKey);return new r({peerId:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t)=>{if(t.privateKey==null)throw new Error("Missing private key");let n=e.domain,i=e.codec,s=e.marshal(),o=cw(n,i,s),c=await(await vn(t.privateKey)).sign(o.subarray());return new r({peerId:t,payloadType:i,payload:s,signature:c})};static openAndCertify=async(e,t)=>{let n=await r.createFromProtobuf(e);if(!await n.validate(t))throw new b("envelope signature is not valid for the given domain",aw.ERR_SIGNATURE_NOT_VALID);return n};peerId;payloadType;payload;signature;marshaled;constructor(e){let{peerId:t,payloadType:n,payload:i,signature:s}=e;this.peerId=t,this.payloadType=n,this.payload=i,this.signature=s}marshal(){if(this.peerId.publicKey==null)throw new Error("Missing public key");return this.marshaled==null&&(this.marshaled=Vl.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return ce(this.marshal(),e.marshal())}async validate(e){let t=cw(e,this.payloadType,this.payload);if(this.peerId.publicKey==null)throw new Error("Missing public key");return Lr(this.peerId.publicKey).verify(t.subarray(),this.signature)}},cw=(r,e,t)=>{let n=Y(r),i=Ht(n.byteLength),s=Ht(e.length),o=Ht(t.length);return new _e(i,n,s,e,o,t)};function lw(r,e){let t=(n,i)=>n.toString().localeCompare(i.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,i)=>e[i].equals(n)))}var Mf=class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){let t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){let t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{let t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,i){return this.readAtomically(()=>{let s=0,o=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",l=2**(8*i)-1;for(;;){let u=this.readAtomically(()=>{let f=this.readChar();if(f===void 0)return;let h=Number.parseInt(f,e);if(!Number.isNaN(h))return h});if(u===void 0)break;if(s*=e,s+=u,s>l||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:s})}readIPv4Addr(){return this.readAtomically(()=>{let e=new Uint8Array(4);for(let t=0;t<e.length;t++){let n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){let e=t=>{for(let n=0;n<t.length/2;n++){let i=n*2;if(n<t.length-3){let o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[i]=o[0],t[i+1]=o[1],t[i+2]=o[2],t[i+3]=o[3],[i+4,!0]}let s=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(s===void 0)return[i,!1];t[i]=s>>8,t[i+1]=s&255}return[t.length,!1]};return this.readAtomically(()=>{let t=new Uint8Array(16),[n,i]=e(t);if(n===16)return t;if(i||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let s=new Uint8Array(14),o=16-(n+2),[a]=e(s.subarray(0,o));return t.set(s.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var uw=45,WB=15,Ha=new Mf;function ym(r){if(!(r.length>WB))return Ha.new(r).parseWith(()=>Ha.readIPv4Addr())}function bm(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>uw))return Ha.new(r).parseWith(()=>Ha.readIPv6Addr())}function Uf(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>uw))return Ha.new(r).parseWith(()=>Ha.readIPAddr())}var _ie=parseInt("0xFFFF",16),Sie=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function Ff(r){return!!ym(r)}function Kf(r){return!!bm(r)}function Wa(r){return!!Uf(r)}var dw=Ff,jB=Kf,wm=function(r){let e=0;if(r=r.toString().trim(),dw(r)){let t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(jB(r)){let t=r.split(":",8),n;for(n=0;n<t.length;n++){let s=dw(t[n]),o;s&&(o=wm(t[n]),t[n]=H(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,H(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let s=[n,1];for(n=9-t.length;n>0;n--)s.push("0");t.splice.apply(t,s)}let i=new Uint8Array(e+16);for(n=0;n<t.length;n++){let s=parseInt(t[n],16);i[e++]=s>>8&255,i[e++]=s&255}return i}throw new Error("invalid ip address")},pw=function(r,e=0,t){e=~~e,t=t??r.length-e;let n=new DataView(r.buffer);if(t===4){let i=[];for(let s=0;s<t;s++)i.push(r[e+s]);return i.join(".")}if(t===16){let i=[];for(let s=0;s<t;s+=2)i.push(n.getUint16(e+s).toString(16));return i.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""};var Ga={},Em={},JB=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,-1,"ip6zone"],[43,8,"ipcidr"],[53,-1,"dns",!0],[54,-1,"dns4",!0],[55,-1,"dns6",!0],[56,-1,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,-1,"unix",!1,!0],[421,-1,"ipfs"],[421,-1,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,-1,"garlic64"],[448,0,"tls"],[449,-1,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,-1,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,-1,"memory"]];JB.forEach(r=>{let e=eM(...r);Em[e.code]=e,Ga[e.name]=e});function eM(r,e,t,n,i){return{code:r,size:e,name:t,resolvable:!!n,path:!!i}}function ye(r){if(typeof r=="number"){if(Em[r]!=null)return Em[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(Ga[r]!=null)return Ga[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}var ase=ye("ip4"),cse=ye("ip6"),lse=ye("ipcidr");function ql(r,e){switch(ye(r).code){case 4:case 41:return rM(e);case 42:return yw(e);case 6:case 273:case 33:case 132:return ww(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return yw(e);case 421:return oM(e);case 444:return bw(e);case 445:return bw(e);case 466:return sM(e);default:return H(e,"base16")}}function vm(r,e){switch(ye(r).code){case 4:return mw(e);case 41:return mw(e);case 42:return gw(e);case 6:case 273:case 33:case 132:return _m(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return gw(e);case 421:return nM(e);case 444:return aM(e);case 445:return cM(e);case 466:return iM(e);default:return Y(e,"base16")}}var xm=Object.values(dn).map(r=>r.decoder),tM=function(){let r=xm[0].or(xm[1]);return xm.slice(2).forEach(e=>r=r.or(e)),r}();function mw(r){if(!Wa(r))throw new Error("invalid ip address");return wm(r)}function rM(r){let e=pw(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!Wa(e))throw new Error("invalid ip address");return e}function _m(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function ww(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function gw(r){let e=Y(r),t=Uint8Array.from(Ht(e.length));return ve([t,e],t.length+e.length)}function yw(r){let e=$r(r);if(r=r.slice($t(e)),r.length!==e)throw new Error("inconsistent lengths");return H(r)}function nM(r){let e;r[0]==="Q"||r[0]==="1"?e=Ln(Ee.decode(`z${r}`)).bytes:e=be.parse(r).multihash.bytes;let t=Uint8Array.from(Ht(e.length));return ve([t,e],t.length+e.length)}function iM(r){let e=tM.decode(r),t=Uint8Array.from(Ht(e.length));return ve([t,e],t.length+e.length)}function sM(r){let e=$r(r),t=r.slice($t(e));if(t.length!==e)throw new Error("inconsistent lengths");return"u"+H(t,"base64url")}function oM(r){let e=$r(r),t=r.slice($t(e));if(t.length!==e)throw new Error("inconsistent lengths");return H(t,"base58btc")}function aM(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=Mt.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let i=_m(n);return ve([t,i],t.length+i.length)}function cM(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=Mt.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let i=_m(n);return ve([t,i],t.length+i.length)}function bw(r){let e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=H(e,"base32"),i=ww(t);return`${n}:${i}`}function Ew(r){r=Sm(r);let e=[],t=[],n=null,i=r.split("/").slice(1);if(i.length===1&&i[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let s=0;s<i.length;s++){let o=i[s],a=ye(o);if(a.size===0){e.push([a.code]),t.push([a.code]);continue}if(s++,s>=i.length)throw vw("invalid address: "+r);if(a.path===!0){n=Sm(i.slice(s).join("/")),e.push([a.code,vm(a.code,n)]),t.push([a.code,n]);break}let c=vm(a.code,i[s]);e.push([a.code,c]),t.push([a.code,ql(a.code,c)])}return{string:xw(t),bytes:Im(e),tuples:e,stringTuples:t,path:n}}function Rm(r){let e=[],t=[],n=null,i=0;for(;i<r.length;){let s=$r(r,i),o=$t(s),a=ye(s),c=lM(a,r.slice(i+o));if(c===0){e.push([s]),t.push([s]),i+=o;continue}let l=r.slice(i+o,i+o+c);if(i+=c+o,i>r.length)throw vw("Invalid address Uint8Array: "+H(r,"base16"));e.push([s,l]);let u=ql(s,l);if(t.push([s,u]),a.path===!0){n=u;break}}return{bytes:Uint8Array.from(r),string:xw(t),tuples:e,stringTuples:t,path:n}}function xw(r){let e=[];return r.map(t=>{let n=ye(t[0]);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),Sm(e.join("/"))}function Im(r){return ve(r.map(e=>{let t=ye(e[0]),n=Uint8Array.from(Ht(t.code));return e.length>1&&e[1]!=null&&(n=ve([n,e[1]])),n}))}function lM(r,e){if(r.size>0)return r.size/8;if(r.size===0)return 0;{let t=$r(e instanceof Uint8Array?e:Uint8Array.from(e));return t+$t(t)}}function Sm(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function vw(r){return new Error("Error parsing address: "+r)}var uM=Symbol.for("nodejs.util.inspect.custom"),Am=Symbol.for("@multiformats/js-multiaddr/multiaddr"),fM=[ye("dns").code,ye("dns4").code,ye("dns6").code,ye("dnsaddr").code],Vf=class r{bytes;#e;#t;#r;#n;[Am]=!0;constructor(e){e==null&&(e="");let t;if(e instanceof Uint8Array)t=Rm(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);t=Ew(e)}else if(Cs(e))t=Rm(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=t.bytes,this.#e=t.string,this.#t=t.tuples,this.#r=t.stringTuples,this.#n=t.path}toString(){return this.#e}toJSON(){return this.toString()}toOptions(){let e,t,n,i,s="",o=ye("tcp"),a=ye("udp"),c=ye("ip4"),l=ye("ip6"),u=ye("dns6"),f=ye("ip6zone");for(let[d,p]of this.stringTuples())d===f.code&&(s=`%${p??""}`),fM.includes(d)&&(t=o.name,i=443,n=`${p??""}${s}`,e=d===u.code?6:4),(d===o.code||d===a.code)&&(t=ye(d).name,i=parseInt(p??"")),(d===c.code||d===l.code)&&(t=ye(d).name,n=`${p??""}${s}`,e=d===l.code?6:4);if(e==null||t==null||n==null||i==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:i}}protos(){return this.#t.map(([e])=>Object.assign({},ye(e)))}protoCodes(){return this.#t.map(([e])=>e)}protoNames(){return this.#t.map(([e])=>ye(e).name)}tuples(){return this.#t}stringTuples(){return this.#r}encapsulate(e){return e=new r(e),new r(this.toString()+e.toString())}decapsulate(e){let t=e.toString(),n=this.toString(),i=n.lastIndexOf(t);if(i<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new r(n.slice(0,i))}decapsulateCode(e){let t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new r(Im(t.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach(([n,i])=>{n===Ga.p2p.code&&e.push([n,i]),n===Ga["p2p-circuit"].code&&(e=[])});let t=e.pop();if(t?.[1]!=null){let n=t[1];return n[0]==="Q"||n[0]==="1"?H(Ee.decode(`z${n}`),"base58btc"):H(be.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return this.#n}equals(e){return ce(this.bytes,e.bytes)}async resolve(e){let t=this.protos().find(s=>s.resolvable);if(t==null)return[this];let n=qf.get(t.name);if(n==null)throw new b(`no available resolver for ${t.name}`,"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(s=>new r(s))}nodeAddress(){let e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){let t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[uM](){return`Multiaddr(${this.#e})`}};var qf=new Map;function Cs(r){return!!r?.[Am]}function se(r){return new Vf(r)}var _w="libp2p-peer-record",Sw=Uint8Array.from([3,1]);var zl;(function(r){let e;(function(n){let i;n.codec=()=>(i==null&&(i=fe((s,o,a={})=>{a.lengthDelimited!==!1&&o.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(o.uint32(10),o.bytes(s.multiaddr)),a.lengthDelimited!==!1&&o.ldelim()},(s,o)=>{let a={multiaddr:new Uint8Array(0)},c=o==null?s.len:s.pos+o;for(;s.pos<c;){let l=s.uint32();switch(l>>>3){case 1:a.multiaddr=s.bytes();break;default:s.skipType(l&7);break}}return a})),i),n.encode=s=>ue(s,n.codec()),n.decode=s=>le(s,n.codec())})(e=r.AddressInfo||(r.AddressInfo={}));let t;r.codec=()=>(t==null&&(t=fe((n,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),n.peerId!=null&&n.peerId.byteLength>0&&(i.uint32(10),i.bytes(n.peerId)),n.seq!=null&&n.seq!==0n&&(i.uint32(16),i.uint64(n.seq)),n.addresses!=null)for(let o of n.addresses)i.uint32(26),r.AddressInfo.codec().encode(o,i);s.lengthDelimited!==!1&&i.ldelim()},(n,i)=>{let s={peerId:new Uint8Array(0),seq:0n,addresses:[]},o=i==null?n.len:n.pos+i;for(;n.pos<o;){let a=n.uint32();switch(a>>>3){case 1:s.peerId=n.bytes();break;case 2:s.seq=n.uint64();break;case 3:s.addresses.push(r.AddressInfo.codec().decode(n,n.uint32()));break;default:n.skipType(a&7);break}}return s})),t),r.encode=n=>ue(n,r.codec()),r.decode=n=>le(n,r.codec())})(zl||(zl={}));var Jr=class r{static createFromProtobuf=e=>{let t=zl.decode(e),n=it(t.peerId),i=(t.addresses??[]).map(o=>se(o.multiaddr)),s=t.seq;return new r({peerId:n,multiaddrs:i,seqNumber:s})};static DOMAIN=_w;static CODEC=Sw;peerId;multiaddrs;seqNumber;domain=r.DOMAIN;codec=r.CODEC;marshaled;constructor(e){let{peerId:t,multiaddrs:n,seqNumber:i}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=i??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=zl.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof r)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!lw(this.multiaddrs,e.multiaddrs))}};var cr={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS"};var Ya;(function(r){let e;(function(i){let s;i.codec=()=>(s==null&&(s=fe((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.key!=null&&o.key!==""&&(a.uint32(10),a.string(o.key)),o.value!=null&&o.value.byteLength>0&&(a.uint32(18),a.bytes(o.value)),c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{let c={key:"",value:new Uint8Array(0)},l=a==null?o.len:o.pos+a;for(;o.pos<l;){let u=o.uint32();switch(u>>>3){case 1:c.key=o.string();break;case 2:c.value=o.bytes();break;default:o.skipType(u&7);break}}return c})),s),i.encode=o=>ue(o,i.codec()),i.decode=o=>le(o,i.codec())})(e=r.Peer$metadataEntry||(r.Peer$metadataEntry={}));let t;(function(i){let s;i.codec=()=>(s==null&&(s=fe((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.key!=null&&o.key!==""&&(a.uint32(10),a.string(o.key)),o.value!=null&&(a.uint32(18),$f.codec().encode(o.value,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{let c={key:""},l=a==null?o.len:o.pos+a;for(;o.pos<l;){let u=o.uint32();switch(u>>>3){case 1:c.key=o.string();break;case 2:c.value=$f.codec().decode(o,o.uint32());break;default:o.skipType(u&7);break}}return c})),s),i.encode=o=>ue(o,i.codec()),i.decode=o=>le(o,i.codec())})(t=r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let n;r.codec=()=>(n==null&&(n=fe((i,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),i.addresses!=null)for(let a of i.addresses)s.uint32(10),zf.codec().encode(a,s);if(i.protocols!=null)for(let a of i.protocols)s.uint32(18),s.string(a);if(i.publicKey!=null&&(s.uint32(34),s.bytes(i.publicKey)),i.peerRecordEnvelope!=null&&(s.uint32(42),s.bytes(i.peerRecordEnvelope)),i.metadata!=null&&i.metadata.size!==0)for(let[a,c]of i.metadata.entries())s.uint32(50),r.Peer$metadataEntry.codec().encode({key:a,value:c},s);if(i.tags!=null&&i.tags.size!==0)for(let[a,c]of i.tags.entries())s.uint32(58),r.Peer$tagsEntry.codec().encode({key:a,value:c},s);o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{let o={addresses:[],protocols:[],metadata:new Map,tags:new Map},a=s==null?i.len:i.pos+s;for(;i.pos<a;){let c=i.uint32();switch(c>>>3){case 1:o.addresses.push(zf.codec().decode(i,i.uint32()));break;case 2:o.protocols.push(i.string());break;case 4:o.publicKey=i.bytes();break;case 5:o.peerRecordEnvelope=i.bytes();break;case 6:{let l=r.Peer$metadataEntry.codec().decode(i,i.uint32());o.metadata.set(l.key,l.value);break}case 7:{let l=r.Peer$tagsEntry.codec().decode(i,i.uint32());o.tags.set(l.key,l.value);break}default:i.skipType(c&7);break}}return o})),n),r.encode=i=>ue(i,r.codec()),r.decode=i=>le(i,r.codec())})(Ya||(Ya={}));var zf;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={multiaddr:new Uint8Array(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.multiaddr=t.bytes();break;case 2:i.isCertified=t.bool();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(zf||(zf={}));var $f;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={value:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.value=t.uint32();break;case 2:i.expiry=t.uint64();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})($f||($f={}));function Qa(r,e){let t=Ya.decode(e);t.publicKey!=null&&r.publicKey==null&&(r=Kb({...r,publicKey:r.publicKey}));let n=new Map,i=BigInt(Date.now());for(let[s,o]of t.tags.entries())o.expiry!=null&&o.expiry<i||n.set(s,o);return{...t,id:r,addresses:t.addresses.map(({multiaddr:s,isCertified:o})=>({multiaddr:se(s),isCertified:o??!1})),metadata:t.metadata,peerRecordEnvelope:t.peerRecordEnvelope??void 0,tags:n}}var Tm="/peers/";function Xa(r){if(!qa(r)||r.type==null)throw new b("Invalid PeerId",cr.ERR_INVALID_PARAMETERS);let e=r.toCID().toString();return new tt(`${Tm}${e}`)}async function Rw(r,e,t){let n=new Map;for(let i of t){if(i==null)continue;if(i.multiaddr instanceof Uint8Array&&(i.multiaddr=se(i.multiaddr)),!Cs(i.multiaddr))throw new b("Multiaddr was invalid",cr.ERR_INVALID_PARAMETERS);if(!await e(r,i.multiaddr))continue;let s=i.isCertified??!1,o=i.multiaddr.toString(),a=n.get(o);a!=null?i.isCertified=a.isCertified||s:n.set(o,{multiaddr:i.multiaddr,isCertified:s})}return[...n.values()].sort((i,s)=>i.multiaddr.toString().localeCompare(s.multiaddr.toString())).map(({isCertified:i,multiaddr:s})=>({isCertified:i,multiaddr:s.bytes}))}async function Wf(r,e,t,n){if(e==null)throw new b("Invalid PeerData",cr.ERR_INVALID_PARAMETERS);if(e.publicKey!=null&&r.publicKey!=null&&!ce(e.publicKey,r.publicKey))throw new b("publicKey bytes do not match peer id publicKey bytes",cr.ERR_INVALID_PARAMETERS);let i=n.existingPeer;if(i!=null&&!r.equals(i.id))throw new b("peer id did not match existing peer id",cr.ERR_INVALID_PARAMETERS);let s=i?.addresses??[],o=new Set(i?.protocols??[]),a=i?.metadata??new Map,c=i?.tags??new Map,l=i?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(s=[],e.multiaddrs!=null&&s.push(...e.multiaddrs.map(f=>({isCertified:!1,multiaddr:f}))),e.addresses!=null&&s.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){let f=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=Hf(f,{validate:Iw})}if(e.tags!=null){let f=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=Hf(f,{validate:Aw,map:Tw})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&s.push(...e.multiaddrs.map(f=>({isCertified:!1,multiaddr:f}))),e.addresses!=null&&s.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){let f=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(let[h,d]of f)d==null?a.delete(h):a.set(h,d);a=Hf([...a.entries()],{validate:Iw})}if(e.tags!=null){let f=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),h=new Map(c);for(let[d,p]of f)p==null?h.delete(d):h.set(d,p);c=Hf([...h.entries()],{validate:Aw,map:Tw})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let u={addresses:await Rw(r,n.addressFilter??(async()=>!0),s),protocols:[...o.values()].sort((f,h)=>f.localeCompare(h)),metadata:a,tags:c,publicKey:i?.id.publicKey??e.publicKey??r.publicKey,peerRecordEnvelope:l};return r.type!=="RSA"&&delete u.publicKey,u}function Hf(r,e){let t=new Map;for(let[n,i]of r)i!=null&&e.validate(n,i);for(let[n,i]of r.sort(([s],[o])=>s.localeCompare(o)))i!=null&&t.set(n,e.map?.(n,i)??i);return t}function Iw(r,e){if(typeof r!="string")throw new b("Metadata key must be a string",cr.ERR_INVALID_PARAMETERS);if(!(e instanceof Uint8Array))throw new b("Metadata value must be a Uint8Array",cr.ERR_INVALID_PARAMETERS)}function Aw(r,e){if(typeof r!="string")throw new b("Tag name must be a string",cr.ERR_INVALID_PARAMETERS);if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new b("Tag value must be an integer",cr.ERR_INVALID_PARAMETERS);if(e.value<0||e.value>100)throw new b("Tag value must be between 0-100",cr.ERR_INVALID_PARAMETERS)}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new b("Tag ttl must be an integer",cr.ERR_INVALID_PARAMETERS);if(e.ttl<0)throw new b("Tag ttl must be between greater than 0",cr.ERR_INVALID_PARAMETERS)}}function Tw(r,e){let t;return e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl))),{value:e.value??0,expiry:t}}function Gf(r,e,t){let n=r.toString().split("/")[2],i=Mt.decode(n),s=it(i),o=t.get(s);if(o!=null)return o;let a=Qa(s,e);return t.set(s,a),a}function hM(r,e){return r==null?{}:{prefix:Tm,filters:(r.filters??[]).map(t=>({key:n,value:i})=>t(Gf(n,i,e))),orders:(r.orders??[]).map(t=>(n,i)=>t(Gf(n.key,n.value,e),Gf(i.key,i.value,e)))}}var Yf=class{peerId;datastore;lock;addressFilter;constructor(e,t={}){this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=gl({name:"peer-store",singleProcess:!0})}async has(e){return this.datastore.has(Xa(e))}async delete(e){if(this.peerId.equals(e))throw new b("Cannot delete self peer",cr.ERR_INVALID_PARAMETERS);await this.datastore.delete(Xa(e))}async load(e){let t=await this.datastore.get(Xa(e));return Qa(e,t)}async save(e,t){let{existingBuf:n,existingPeer:i}=await this.#e(e),s=await Wf(e,t,"patch",{addressFilter:this.addressFilter});return this.#t(e,s,n,i)}async patch(e,t){let{existingBuf:n,existingPeer:i}=await this.#e(e),s=await Wf(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:i});return this.#t(e,s,n,i)}async merge(e,t){let{existingBuf:n,existingPeer:i}=await this.#e(e),s=await Wf(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:i});return this.#t(e,s,n,i)}async*all(e){let t=new Xt;for await(let{key:n,value:i}of this.datastore.query(hM(e??{},t))){let s=Gf(n,i,t);s.id.equals(this.peerId)||(yield s)}}async#e(e){try{let t=await this.datastore.get(Xa(e)),n=Qa(e,t);return{existingBuf:t,existingPeer:n}}catch(t){if(t.code!=="ERR_NOT_FOUND")throw t}return{}}async#t(e,t,n,i){let s=Ya.encode(t);return n!=null&&ce(s,n)?{peer:Qa(e,s),previous:i,updated:!1}:(await this.datastore.put(Xa(e),s),{peer:Qa(e,s),previous:i,updated:!0})}};var st=D("libp2p:peer-store"),Qf=class{store;events;peerId;constructor(e,t={}){this.events=e.events,this.peerId=e.peerId,this.store=new Yf(e,t)}async forEach(e,t){st.trace("forEach await read lock");let n=await this.store.lock.readLock();st.trace("forEach got read lock");try{for await(let i of this.store.all(t))e(i)}finally{st.trace("forEach release read lock"),n()}}async all(e){st.trace("all await read lock");let t=await this.store.lock.readLock();st.trace("all got read lock");try{return await Gc(this.store.all(e))}finally{st.trace("all release read lock"),t()}}async delete(e){st.trace("delete await write lock");let t=await this.store.lock.writeLock();st.trace("delete got write lock");try{await this.store.delete(e)}finally{st.trace("delete release write lock"),t()}}async has(e){st.trace("has await read lock");let t=await this.store.lock.readLock();st.trace("has got read lock");try{return await this.store.has(e)}finally{st.trace("has release read lock"),t()}}async get(e){st.trace("get await read lock");let t=await this.store.lock.readLock();st.trace("get got read lock");try{return await this.store.load(e)}finally{st.trace("get release read lock"),t()}}async save(e,t){st.trace("save await write lock");let n=await this.store.lock.writeLock();st.trace("save got write lock");try{let i=await this.store.save(e,t);return this.#e(e,i),i.peer}finally{st.trace("save release write lock"),n()}}async patch(e,t){st.trace("patch await write lock");let n=await this.store.lock.writeLock();st.trace("patch got write lock");try{let i=await this.store.patch(e,t);return this.#e(e,i),i.peer}finally{st.trace("patch release write lock"),n()}}async merge(e,t){st.trace("merge await write lock");let n=await this.store.lock.writeLock();st.trace("merge got write lock");try{let i=await this.store.merge(e,t);return this.#e(e,i),i.peer}finally{st.trace("merge release write lock"),n()}}async consumePeerRecord(e,t){let n=await Sn.openAndCertify(e,Jr.DOMAIN);if(t?.equals(n.peerId)===!1)return st("envelope peer id was not the expected peer id - expected: %p received: %p",t,n.peerId),!1;let i=Jr.createFromProtobuf(n.payload),s;try{s=await this.get(n.peerId)}catch(o){if(o.code!=="ERR_NOT_FOUND")throw o}if(s?.peerRecordEnvelope!=null){let o=await Sn.createFromProtobuf(s.peerRecordEnvelope),a=Jr.createFromProtobuf(o.payload);if(a.seqNumber>=i.seqNumber)return st("sequence number was lower or equal to existing sequence number - stored: %d received: %d",a.seqNumber,i.seqNumber),!1}return await this.patch(i.peerId,{peerRecordEnvelope:e,addresses:i.multiaddrs.map(o=>({isCertified:!0,multiaddr:o}))}),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}};function Dw(r,e){let t;return function(){let n=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(n,e)}}var dM=D("libp2p:address-manager"),pM=r=>r;function Dm(r,e){let t=r.getPeerId();return t!=null&&ae(t).equals(e)&&(r=r.decapsulate(se(`/p2p/${e.toString()}`))),r}var Xf=class{components;listen;announce;observed;announceFilter;constructor(e,t={}){let{listen:n=[],announce:i=[]}=t;this.components=e,this.listen=n.map(s=>s.toString()),this.announce=new Set(i.map(s=>s.toString())),this.observed=new Map,this.announceFilter=t.announceFilter??pM,this._updatePeerStoreAddresses=Dw(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){let e=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat([...this.observed.entries()].filter(([t,n])=>n.confident).map(([t])=>se(t))).map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{dM.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>se(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>se(e))}getObservedAddrs(){return Array.from(this.observed).map(([e])=>se(e))}addObservedAddr(e){e=Dm(e,this.components.peerId);let t=e.toString();this.observed.has(t)||this.observed.set(t,{confident:!1})}confirmObservedAddr(e){e=Dm(e,this.components.peerId);let t=e.toString(),i=(this.observed.get(t)??{confident:!1}).confident;this.observed.set(t,{confident:!0}),i||this._updatePeerStoreAddresses()}removeObservedAddr(e){e=Dm(e,this.components.peerId);let t=e.toString();this.observed.delete(t)}getAddresses(){let e=this.getAnnounceAddrs().map(n=>n.toString());e.length===0&&(e=this.components.transportManager.getAddrs().map(n=>n.toString())),e=e.concat(Array.from(this.observed).filter(([n,i])=>i.confident).map(([n])=>n));let t=new Set(e);return this.announceFilter(Array.from(t).map(n=>se(n))).map(n=>n.protos().pop()?.path===!0||n.getPeerId()===this.components.peerId.toString()?n:n.encapsulate(`/p2p/${this.components.peerId.toString()}`))}};var Cm=class{components={};_started=!1;constructor(e={}){this.components={};for(let[t,n]of Object.entries(e))this.components[t]=n}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>Xu(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}},mM=["metrics","connectionProtector"],gM=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function Cw(r={}){let e=new Cm(r);return new Proxy(e,{get(n,i,s){if(typeof i=="string"&&!gM.includes(i)){let o=e.components[i];if(o==null&&!mM.includes(i))throw new b(`${i} not set`,"ERR_SERVICE_MISSING");return o}return Reflect.get(n,i,s)},set(n,i,s){return typeof i=="string"?e.components[i]=s:Reflect.set(n,i,s),!0}})}var Mw=de(Pw(),1);var kw="[a-fA-F\\d:]",Ps=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${kw})|(?<=${kw})(?=\\s|$))`:"",Xn="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",Ot="[a-fA-F\\d]{1,4}",jf=`
(?:
(?:${Ot}:){7}(?:${Ot}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${Ot}:){6}(?:${Xn}|:${Ot}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${Ot}:){5}(?::${Xn}|(?::${Ot}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${Ot}:){4}(?:(?::${Ot}){0,1}:${Xn}|(?::${Ot}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${Ot}:){3}(?:(?::${Ot}){0,2}:${Xn}|(?::${Ot}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${Ot}:){2}(?:(?::${Ot}){0,3}:${Xn}|(?::${Ot}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${Ot}:){1}(?:(?::${Ot}){0,4}:${Xn}|(?::${Ot}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${Ot}){0,5}:${Xn}|(?::${Ot}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),yM=new RegExp(`(?:^${Xn}$)|(?:^${jf}$)`),bM=new RegExp(`^${Xn}$`),wM=new RegExp(`^${jf}$`),Pm=r=>r&&r.exact?yM:new RegExp(`(?:${Ps(r)}${Xn}${Ps(r)})|(?:${Ps(r)}${jf}${Ps(r)})`,"g");Pm.v4=r=>r&&r.exact?bM:new RegExp(`${Ps(r)}${Xn}${Ps(r)}`,"g");Pm.v6=r=>r&&r.exact?wM:new RegExp(`${Ps(r)}${jf}${Ps(r)}`,"g");var Nw=Pm;var Uw=de(Lw(),1),{isValid:EM,parse:xM}=Uw.default,vM=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],_M=vM.map(r=>new Mw.Netmask(r));function SM(r){for(let e of _M)if(e.contains(r))return!0;return!1}function Bw(r){return/^::$/.test(r)||/^::1$/.test(r)||/^::f{4}:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^::f{4}:0.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}var Fw=r=>{if(EM(r)){let e=xM(r);if(e.kind()==="ipv4")return SM(e.toNormalizedString());if(e.kind()==="ipv6")return Bw(r)}else if(Wa(r)&&Nw.v6().test(r))return Bw(r)};var Br=Fw;function Kw(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{let t=e.stringTuples();return t[0][0]===4||t[0][0]===41?!!Br(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}var yi=Symbol.for("@libp2p/transport");var ks;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(ks||(ks={}));var RM=r=>r.toString().split("/").slice(1),Hl=r=>({match:e=>e.length<1?!1:r(e[0])?e.slice(1):!1,pattern:"fn"}),Dt=r=>({match:e=>Hl(t=>t===r).match(e),pattern:r}),th=()=>({match:r=>Hl(e=>typeof e=="string").match(r),pattern:"{string}"}),Vw=()=>({match:r=>Hl(e=>!isNaN(parseInt(e))).match(r),pattern:"{number}"}),Rn=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{Ee.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),Jf=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{C1.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),bi=r=>({match:e=>{let t=r.match(e);return t===!1?e:t},pattern:`optional(${r.pattern})`}),wi=(...r)=>({match:e=>{let t;for(let n of r){let i=n.match(e);i!==!1&&(t==null||i.length<t.length)&&(t=i)}return t??!1},pattern:`or(${r.map(e=>e.pattern).join(", ")})`}),Ct=(...r)=>({match:e=>{for(let t of r){let n=t.match(e);if(n===!1)return!1;e=n}return e},pattern:`and(${r.map(e=>e.pattern).join(", ")})`});function Vt(...r){function e(i){let s=RM(i);for(let o of r){let a=o.match(s);if(a===!1)return!1;s=a}return s}function t(i){return e(i)!==!1}function n(i){let s=e(i);return s===!1?!1:s.length===0}return{matches:t,exactMatch:n}}var Nm=Ct(Dt("dns4"),th()),Om=Ct(Dt("dns6"),th()),Lm=Ct(Dt("dnsaddr"),th()),qw=Ct(Dt("dns"),th()),Joe=Vt(Nm),eae=Vt(Om),tae=Vt(Lm),zw=Vt(wi(qw,Lm,Nm,Om)),$w=Ct(Dt("ip4"),Hl(Ff)),Hw=Ct(Dt("ip6"),Hl(Kf)),Ww=wi($w,Hw),Wl=wi(Ww,qw,Nm,Om,Lm),rae=Vt(Wl),nae=Vt($w),iae=Vt(Hw),Gw=Vt(Ww),rh=Ct(Wl,Dt("tcp"),Vw()),Gl=Ct(Wl,Dt("udp"),Vw()),IM=wi(rh,Gl),sae=Vt(rh),oae=Vt(Gl),Bm=Ct(Gl,Dt("quic")),nh=Ct(Gl,Dt("quic-v1")),AM=wi(Bm,nh),aae=Vt(Bm),cae=Vt(nh),km=wi(Wl,rh,Gl,Bm,nh),Yw=wi(Ct(km,Dt("ws"),bi(Rn()))),lae=Vt(Yw),Qw=wi(Ct(km,Dt("wss"),bi(Rn())),Ct(km,Dt("tls"),Dt("ws"),bi(Rn()))),uae=Vt(Qw),Xw=Ct(IM,Dt("webrtc-direct"),Jf(),bi(Jf()),bi(Rn())),jw=Vt(Xw),Zw=Ct(nh,Dt("webtransport"),Jf(),Jf(),bi(Rn())),ih=Vt(Zw),eh=wi(Yw,Qw,Ct(rh,bi(Rn())),Ct(AM,bi(Rn())),Ct(Wl,bi(Rn())),Xw,Zw,Rn()),fae=Vt(eh),TM=Ct(eh,Dt("p2p-circuit"),Rn()),Yl=Vt(TM),DM=wi(Ct(eh,Dt("p2p-circuit"),Dt("webrtc"),Rn()),Ct(eh,Dt("webrtc"),bi(Rn())),Dt("webrtc")),Jw=Vt(DM);function Mm(r){try{let{address:e}=r.nodeAddress();return!!Br(e)}catch{return!0}}function CM(r,e){let t=Mm(r.multiaddr),n=Mm(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function PM(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function kM(r,e){let t=Yl.exactMatch(r.multiaddr),n=Yl.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function ja(r,e){let t=CM(r,e);if(t!==0)return t;let n=kM(r,e);return n!==0?n:PM(r,e)}var Fm=de(_1(),1),Km=de(rE(),1);var nE=globalThis.fetch,iE=globalThis.Headers,wae=globalThis.Request,Eae=globalThis.Response;function sh(r,e,t){return`${r}?name=${e}&type=${t}`}async function sE(r,e){return await(await nE(r,{headers:new iE({accept:"application/dns-json"}),signal:e})).json()}function Fo(r,e){return`${e}_${r}`}var Um=Object.assign((0,Fm.default)("dns-over-http-resolver"),{error:(0,Fm.default)("dns-over-http-resolver:error")}),Vm=class{_cache;_TXTcache;_servers;_request;_abortControllers;constructor(e={}){this._cache=new Km.default({max:e?.maxCache??100}),this._TXTcache=new Km.default({max:e?.maxCache??100}),this._servers=["https://cloudflare-dns.com/dns-query","https://dns.google/resolve"],this._request=e.request??sE,this._abortControllers=[]}cancel(){this._abortControllers.forEach(e=>{e.abort()})}getServers(){return this._servers}_getShuffledServers(){let e=[...this._servers];for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*t),i=e[t];e[t]=e[n],e[n]=i}return e}setServers(e){this._servers=e}async resolve(e,t="A"){switch(t){case"A":return this.resolve4(e);case"AAAA":return this.resolve6(e);case"TXT":return this.resolveTxt(e);default:throw new Error(`${t} is not supported`)}}async resolve4(e){let t="A",n=this._cache.get(Fo(e,t));if(n!=null)return n;let i=!1;for(let s of this._getShuffledServers()){let o=new AbortController;this._abortControllers.push(o);try{let a=await this._request(sh(s,e,t),o.signal),c=a.Answer.map(u=>u.data),l=Math.min(...a.Answer.map(u=>u.TTL));return this._cache.set(Fo(e,t),c,{ttl:l}),c}catch{o.signal.aborted&&(i=!0),Um.error(`${s} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw i?Object.assign(new Error("queryA ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolve6(e){let t="AAAA",n=this._cache.get(Fo(e,t));if(n!=null)return n;let i=!1;for(let s of this._getShuffledServers()){let o=new AbortController;this._abortControllers.push(o);try{let a=await this._request(sh(s,e,t),o.signal),c=a.Answer.map(u=>u.data),l=Math.min(...a.Answer.map(u=>u.TTL));return this._cache.set(Fo(e,t),c,{ttl:l}),c}catch{o.signal.aborted&&(i=!0),Um.error(`${s} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw i?Object.assign(new Error("queryAaaa ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolveTxt(e){let t="TXT",n=this._TXTcache.get(Fo(e,t));if(n!=null)return n;let i=!1;for(let s of this._getShuffledServers()){let o=new AbortController;this._abortControllers.push(o);try{let a=await this._request(sh(s,e,t),o.signal),c=a.Answer.map(u=>[u.data.replace(/['"]+/g,"")]),l=Math.min(...a.Answer.map(u=>u.TTL));return this._TXTcache.set(Fo(e,t),c,{ttl:l}),c}catch{o.signal.aborted&&(i=!0),Um.error(`${s} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw i?Object.assign(new Error("queryTxt ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}clearCache(){this._cache.clear(),this._TXTcache.clear()}},oE=Vm;var aE=oE;var{code:MM}=ye("dnsaddr");async function Za(r,e={}){let t=new aE;e.signal!=null&&e.signal.addEventListener("abort",()=>{t.cancel()});let n=r.getPeerId(),[,i]=r.stringTuples().find(([a])=>a===MM)??[];if(i==null)throw new Error("No hostname found in multiaddr");let o=(await t.resolveTxt(`_dnsaddr.${i}`)).flat().map(a=>a.split("=")[1]).filter(Boolean);return n!=null&&(o=o.filter(a=>a.includes(n))),o}var Ei;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.DHT_DISABLED="DHT is not available",r.PUBSUB_DISABLED="PubSub is not available",r.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",r.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",r.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",r.NOT_FOUND="Not found"})(Ei||(Ei={}));var $;(function(r){r.DHT_DISABLED="ERR_DHT_DISABLED",r.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",r.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",r.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",r.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",r.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",r.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",r.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",r.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",r.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",r.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",r.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",r.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",r.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",r.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",r.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",r.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",r.ERR_DIALED_SELF="ERR_DIALED_SELF",r.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",r.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",r.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",r.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",r.ERR_INVALID_KEY="ERR_INVALID_KEY",r.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_INVALID_PEER="ERR_INVALID_PEER",r.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",r.ERR_NOT_FOUND="ERR_NOT_FOUND",r.ERR_TIMEOUT="ERR_TIMEOUT",r.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",r.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",r.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",r.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",r.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",r.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",r.ERR_FIND_SELF="ERR_FIND_SELF",r.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",r.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",r.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",r.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",r.ERR_INVALID_CMS="ERR_INVALID_CMS",r.ERR_MISSING_KEYS="ERR_MISSING_KEYS",r.ERR_NO_KEY="ERR_NO_KEY",r.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",r.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",r.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",r.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",r.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",r.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",r.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",r.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",r.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",r.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",r.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",r.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",r.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",r.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",r.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",r.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",r.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",r.ERR_INVALID_RECORD="ERR_INVALID_RECORD",r.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",r.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",r.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",r.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",r.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",r.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"})($||($={}));var UM={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:Za},addressSorter:ja},transportManager:{faultTolerance:ks.FATAL_ALL}};function cE(r){let e=Ts(UM,r);if(e.transports==null||e.transports.length<1)throw new b(Ei.ERR_TRANSPORTS_REQUIRED,$.ERR_TRANSPORTS_REQUIRED);if(e.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new b(Ei.ERR_PROTECTOR_REQUIRED,$.ERR_PROTECTOR_REQUIRED);return e}var lE="keep-alive";var ax=de(n3(),1);var EU=D("libp2p:get-peer");function ah(r){if(qa(r))return{peerId:r,multiaddrs:[]};Array.isArray(r)||(r=[r]);let e;if(r.length>0){let t=r[0].getPeerId();e=t==null?void 0:ae(t),r.forEach(n=>{if(!Cs(n))throw EU.error("multiaddr %s was invalid",n),new b("Invalid Multiaddr",$.ERR_INVALID_MULTIADDR);let i=n.getPeerId();if(i==null){if(e!=null)throw new b("Multiaddrs must all have the same peer id or have no peer id",$.ERR_INVALID_PARAMETERS)}else{let s=ae(i);if(e==null||!e.equals(s))throw new b("Multiaddrs must all have the same peer id or have no peer id",$.ERR_INVALID_PARAMETERS)}})}return{peerId:e,multiaddrs:r}}function xU(r,e,t){let n=0,i=r.length;for(;i>0;){let s=Math.trunc(i/2),o=n+s;t(r[o],e)<=0?(n=++o,i-=s+1):i=s}return n}var i3=class{#e=[];enqueue(e,t){let n=t?.peerId,i=t?.priority??0;if(n==null)throw new b("missing peer id",$.ERR_INVALID_PARAMETERS);let s={priority:i,peerId:n,run:e};if(this.size>0&&this.#e[this.size-1].priority>=i){this.#e.push(s);return}let o=xU(this.#e,s,(a,c)=>c.priority-a.priority);this.#e.splice(o,0,s)}dequeue(){return this.#e.shift()?.run}filter(e){if(e.peerId!=null){let t=e.peerId;return this.#e.filter(n=>t.equals(n.peerId)).map(n=>n.run)}return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}},nc=class extends Ft{constructor(e={}){super({...e,queueClass:i3})}hasJob(e){return this.sizeBy({peerId:e})>0}};var ch="last-dial-failure";var lh=5,Os=100,uh=50,nx=1e3*60*7;var jt=D("libp2p:connection-manager:auto-dial"),Ko={minConnections:lh,maxQueueLength:100,autoDialConcurrency:25,autoDialPriority:0,autoDialInterval:5e3,autoDialPeerRetryThreshold:nx,autoDialDiscoveredPeersDebounce:10},fh=class{connectionManager;peerStore;queue;minConnections;autoDialPriority;autoDialIntervalMs;autoDialMaxQueueLength;autoDialPeerRetryThresholdMs;autoDialDiscoveredPeersDebounce;autoDialInterval;started;running;constructor(e,t){this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.minConnections=t.minConnections??Ko.minConnections,this.autoDialPriority=t.autoDialPriority??Ko.autoDialPriority,this.autoDialIntervalMs=t.autoDialInterval??Ko.autoDialInterval,this.autoDialMaxQueueLength=t.maxQueueLength??Ko.maxQueueLength,this.autoDialPeerRetryThresholdMs=t.autoDialPeerRetryThreshold??Ko.autoDialPeerRetryThreshold,this.autoDialDiscoveredPeersDebounce=t.autoDialDiscoveredPeersDebounce??Ko.autoDialDiscoveredPeersDebounce,this.started=!1,this.running=!1,this.queue=new nc({concurrency:t.autoDialConcurrency??Ko.autoDialConcurrency}),this.queue.addListener("error",i=>{jt.error("error during auto-dial",i)}),e.events.addEventListener("connection:close",()=>{this.autoDial().catch(i=>{jt.error(i)})});let n;e.events.addEventListener("peer:discovery",()=>{clearTimeout(n),n=setTimeout(()=>{this.autoDial().catch(i=>{jt.error(i)})},this.autoDialDiscoveredPeersDebounce)})}isStarted(){return this.started}start(){this.autoDialInterval=setTimeout(()=>{this.autoDial().catch(e=>{jt.error("error while autodialing",e)})},this.autoDialIntervalMs),this.started=!0}afterStart(){this.autoDial().catch(e=>{jt.error("error while autodialing",e)})}stop(){this.queue.clear(),clearTimeout(this.autoDialInterval),this.started=!1,this.running=!1}async autoDial(){if(!this.started)return;let e=this.connectionManager.getConnectionsMap(),t=e.size;if(t>=this.minConnections){this.minConnections>0&&jt.trace("have enough connections %d/%d",t,this.minConnections);return}if(this.queue.size>this.autoDialMaxQueueLength){jt("not enough connections %d/%d but auto dial queue is full",t,this.minConnections);return}if(this.running){jt("not enough connections %d/%d - but skipping autodial as it is already running",t,this.minConnections);return}this.running=!0,jt("not enough connections %d/%d - will dial peers to increase the number of connections",t,this.minConnections);let n=new _n(this.connectionManager.getDialQueue().map(l=>l.peerId).filter(Boolean)),i=await this.peerStore.all({filters:[l=>l.addresses.length===0?(jt.trace("not autodialing %p because they have no addresses",l.id),!1):e.has(l.id)?(jt.trace("not autodialing %p because they are already connected",l.id),!1):n.has(l.id)?(jt.trace("not autodialing %p because they are already being dialed",l.id),!1):this.queue.hasJob(l.id)?(jt.trace("not autodialing %p because they are already being autodialed",l.id),!1):!0]}),s=i.sort(()=>Math.random()>.5?1:-1),o=new Xt;for(let l of s)o.has(l.id)||o.set(l.id,[...l.tags.values()].reduce((u,f)=>u+f.value,0));let c=s.sort((l,u)=>{let f=o.get(l.id)??0,h=o.get(u.id)??0;return f>h?-1:f<h?1:0}).filter(l=>{let u=l.metadata.get(ch);if(u==null)return!0;let f=parseInt(H(u));return isNaN(f)?!0:Date.now()-f>this.autoDialPeerRetryThresholdMs});jt("selected %d/%d peers to dial",c.length,i.length);for(let l of c)this.queue.add(async()=>{let u=this.connectionManager.getConnectionsMap().size;if(u>=this.minConnections){jt("got enough connections now %d/%d",u,this.minConnections),this.queue.clear();return}jt("connecting to a peerStore stored peer %p",l.id),await this.connectionManager.openConnection(l.id,{priority:this.autoDialPriority})},{peerId:l.id}).catch(u=>{jt.error("could not connect to peerStore stored peer",u)});this.running=!1,this.started&&(this.autoDialInterval=setTimeout(()=>{this.autoDial().catch(l=>{jt.error("error while autodialing",l)})},this.autoDialIntervalMs))}};var ic=D("libp2p:connection-manager:connection-pruner"),ix={maxConnections:Os,allow:[]},hh=class{maxConnections;connectionManager;peerStore;allow;events;constructor(e,t={}){this.maxConnections=t.maxConnections??ix.maxConnections,this.allow=t.allow??ix.allow,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,e.events.addEventListener("connection:open",()=>{this.maybePruneConnections().catch(n=>{ic.error(n)})})}async maybePruneConnections(){let e=this.connectionManager.getConnections(),t=e.length,n=Math.max(t-this.maxConnections,0);if(ic("checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;ic("max connections limit exceeded %d/%d, pruning %d connection(s)",t,this.maxConnections,n);let i=new Xt;for(let a of e){let c=a.remotePeer;if(!i.has(c)){i.set(c,0);try{let l=await this.peerStore.get(c);i.set(c,[...l.tags.values()].reduce((u,f)=>u+f.value,0))}catch(l){l.code!=="ERR_NOT_FOUND"&&ic.error("error loading peer tags",l)}}}let s=e.sort((a,c)=>{let l=i.get(a.remotePeer)??0,u=i.get(c.remotePeer)??0;if(l>u)return 1;if(l<u)return-1;let f=a.timeline.open,h=c.timeline.open;return f<h?1:f>h?-1:0}),o=[];for(let a of s)if(ic("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(l=>a.remoteAddr.toString().startsWith(l.toString()))||o.push(a),o.length===n)break;await Promise.all(o.map(async a=>{try{await a.close()}catch(c){ic.error(c)}})),this.events.safeDispatchEvent("connection:prune",{detail:o})}};var sx=D("libp2p:connection-manager:utils");async function c3(r,e){if(!r.protoNames().includes("dnsaddr"))return[r];let n=await SU(r,e),o=(await Promise.all(n.map(async a=>c3(a,e)))).flat().reduce((a,c)=>(a.find(l=>l.equals(c))==null&&a.push(c),a),[]);return sx("resolved %s to",r,o.map(a=>a.toString())),o}async function SU(r,e){try{return r=se(r.toString()),await r.resolve(e)}catch(t){return sx.error(`multiaddr ${r.toString()} could not be resolved`,t),[]}}function ox(...r){let e=[];for(let n of r)n!=null&&(nt(1/0,n),e.push(n));let t=xt(e);return nt(1/0,t),t}var Lt=D("libp2p:connection-manager:dial-queue"),Xl={addressSorter:ja,maxParallelDials:uh,maxPeerAddrsToDial:25,maxParallelDialsPerPeer:1,dialTimeout:3e4,resolvers:{dnsaddr:Za}},dh=class{pendingDials;queue;peerId;peerStore;connectionGater;transportManager;addressSorter;maxPeerAddrsToDial;maxParallelDialsPerPeer;dialTimeout;inProgressDialCount;pendingDialCount;shutDownController;connections;constructor(e,t={}){this.addressSorter=t.addressSorter??Xl.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Xl.maxPeerAddrsToDial,this.maxParallelDialsPerPeer=t.maxParallelDialsPerPeer??Xl.maxParallelDialsPerPeer,this.dialTimeout=t.dialTimeout??Xl.dialTimeout,this.connections=t.connections??new Xt,this.peerId=e.peerId,this.peerStore=e.peerStore,this.connectionGater=e.connectionGater,this.transportManager=e.transportManager,this.shutDownController=new AbortController,nt(1/0,this.shutDownController.signal),this.pendingDialCount=e.metrics?.registerMetric("libp2p_dialler_pending_dials"),this.inProgressDialCount=e.metrics?.registerMetric("libp2p_dialler_in_progress_dials"),this.pendingDials=[];for(let[n,i]of Object.entries(t.resolvers??{}))qf.set(n,i);this.queue=new Ft({concurrency:t.maxParallelDials??Xl.maxParallelDials}),this.queue.on("add",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("active",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("completed",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("error",n=>{Lt.error("error in dial queue",n),this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("empty",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("idle",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)})}stop(){this.shutDownController.abort()}async dial(e,t={}){let{peerId:n,multiaddrs:i}=ah(e),s=i.map(h=>({multiaddr:h,isCertified:!1})),o=this.createDialAbortControllers(t.signal),a;try{a=await this.calculateMultiaddrs(n,s,{...t,signal:o})}catch(h){throw o.clear(),h}let c=Array.from(this.connections.values()).flat().find(h=>t.force===!0?!1:a.find(d=>d.multiaddr.equals(h.remoteAddr)));if(c!=null)return Lt("already connected to %a",c.remoteAddr),c;let l=this.pendingDials.find(h=>!!(h.peerId!=null&&n!=null&&h.peerId.equals(n)||a.map(({multiaddr:d})=>d.toString()).join()===h.multiaddrs.map(d=>d.toString()).join()));if(l!=null)return Lt("joining existing dial target for %p",n),o.clear(),l.promise;Lt("creating dial target for",a.map(({multiaddr:h})=>h.toString()));let u={id:RU(),status:"queued",peerId:n,multiaddrs:a.map(({multiaddr:h})=>h)};u.promise=this.performDial(u,{...t,signal:o}).finally(()=>{this.pendingDials=this.pendingDials.filter(h=>h.id!==u.id),o.clear()}).catch(async h=>{if(Lt.error("dial failed to %s",u.multiaddrs.map(d=>d.toString()).join(", "),h),n!=null)try{await this.peerStore.patch(n,{metadata:{[ch]:Y(Date.now().toString())}})}catch(d){Lt.error("could not update last dial failure key for %p",n,d)}throw o.aborted?new b(h.message,$.ERR_TIMEOUT):h}),this.pendingDials.push(u);let f=await u.promise;return c=Array.from(this.connections.values()).flat().find(h=>t.force===!0?!1:h.id!==f.id&&h.remoteAddr.equals(f.remoteAddr)),c!=null?(Lt("already connected to %a",c.remoteAddr),await f.close(),c):(Lt("connection opened to %a",f.remoteAddr),f)}createDialAbortControllers(e){let t=xt([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,e]);try{nt?.(1/0,t)}catch{}return t}async calculateMultiaddrs(e,t=[],n={}){if(e!=null){if(this.peerId.equals(e))throw new b("Tried to dial self",$.ERR_DIALED_SELF);if(await this.connectionGater.denyDialPeer?.(e)===!0)throw new b("The dial request is blocked by gater.allowDialPeer",$.ERR_PEER_DIAL_INTERCEPTED);if(t.length===0){Lt("loading multiaddrs for %p",e);try{let u=await this.peerStore.get(e);t.push(...u.addresses),Lt("loaded multiaddrs for %p",e,t.map(({multiaddr:f})=>f.toString()))}catch(u){if(u.code!==$.ERR_NOT_FOUND)throw u}}}let i=(await Promise.all(t.map(async u=>{let f=await c3(u.multiaddr,n);return f.length===1&&f[0].equals(u.multiaddr)?u:f.map(h=>({multiaddr:h,isCertified:!1}))}))).flat(),s=i.filter(u=>{if(this.transportManager.transportForMultiaddr(u.multiaddr)==null)return!1;let f=u.multiaddr.getPeerId();return e!=null&&f!=null?e.equals(f):!0}),o=new Map;for(let u of s){let f=u.multiaddr.toString(),h=o.get(f);if(h!=null){h.isCertified=h.isCertified||u.isCertified||!1;continue}o.set(f,u)}let a=[...o.values()];if((a.length===0||a.length>this.maxPeerAddrsToDial)&&(Lt("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:u})=>u.toString())),Lt("addresses for %p after filtering",e??"unknown peer",a.map(({multiaddr:u})=>u.toString()))),a.length===0)throw new b("The dial request has no valid addresses",$.ERR_NO_VALID_ADDRESSES);if(a.length>this.maxPeerAddrsToDial)throw new b("dial with more addresses than allowed",$.ERR_TOO_MANY_ADDRESSES);if(e!=null){let u=`/p2p/${e.toString()}`;a=a.map(f=>{let h=f.multiaddr.getPeerId();return f.multiaddr.protos().pop()?.path===!0?f:h!==e.toString()?{multiaddr:f.multiaddr.encapsulate(u),isCertified:f.isCertified}:f})}let c=[];for(let u of a)this.connectionGater.denyDialMultiaddr!=null&&await this.connectionGater.denyDialMultiaddr(u.multiaddr)||c.push(u);let l=c.sort(this.addressSorter);if(l.length===0)throw new b("The connection gater denied all addresses in the dial request",$.ERR_NO_VALID_ADDRESSES);return l}async performDial(e,t={}){let n=e.multiaddrs.map(()=>new AbortController);try{let i=new Ft({concurrency:this.maxParallelDialsPerPeer});i.on("error",o=>{Lt.error("error dialling",o)});let s=await Promise.any(e.multiaddrs.map(async(o,a)=>{let c=n[a];if(c==null)throw new b("dialAction did not come with an AbortController",$.ERR_INVALID_PARAMETERS);let l=ox(c.signal,t.signal);l.addEventListener("abort",()=>{Lt("dial to %a aborted",o)});let u=ge();return await i.add(async()=>{if(l.aborted){Lt("dial to %a was aborted before reaching the head of the peer dial queue",o),u.reject(new Bn);return}await this.queue.add(async()=>{try{if(l.aborted){Lt("dial to %a was aborted before reaching the head of the dial queue",o),u.reject(new Bn);return}e.status="active";let f=await this.transportManager.dial(o,{...t,signal:l});if(c.signal.aborted){Lt("multiple dials succeeded, closing superfluous connection"),f.close().catch(h=>{Lt.error("error closing superfluous connection",h)}),u.reject(new Bn);return}n[a]=void 0,n.forEach(h=>{h!==void 0&&h.abort()}),Lt("dial to %a succeeded",o),u.resolve(f)}catch(f){Lt.error("error during dial of %a",o,f),u.reject(f)}},{...t,signal:l}).catch(f=>{u.reject(f)})},{signal:l}).catch(f=>{u.reject(f)}).finally(()=>{l.clear()}),u.promise}));if(s==null)throw new b("successful dial led to empty object returned from peer dial queue",$.ERR_TRANSPORT_DIAL_FAILED);return e.status="success",s}catch(i){throw e.status="error",e.multiaddrs.length===1&&i.name==="AggregateError"?i.errors[0]:i}}};function RU(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var tn=D("libp2p:connection-manager"),TU=50,Vo={minConnections:lh,maxConnections:Os,inboundConnectionThreshold:5,maxIncomingPendingConnections:10,autoDialConcurrency:25,autoDialPriority:0,autoDialMaxQueueLength:100},ph=class{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;maxConnections;dialQueue;autoDial;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;constructor(e,t={}){this.maxConnections=t.maxConnections??Vo.maxConnections;let n=t.minConnections??Vo.minConnections;if(this.maxConnections<n)throw new b("Connection Manager maxConnections must be greater than minConnections",$.ERR_INVALID_PARAMETERS);this.connections=new Xt,this.started=!1,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(t.allow??[]).map(i=>se(i)),this.deny=(t.deny??[]).map(i=>se(i)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??Vo.maxIncomingPendingConnections,this.inboundConnectionRateLimiter=new ax.RateLimiterMemory({points:t.inboundConnectionThreshold??Vo.inboundConnectionThreshold,duration:1}),this.autoDial=new fh({connectionManager:this,peerStore:e.peerStore,events:e.events},{minConnections:n,autoDialConcurrency:t.autoDialConcurrency??Vo.autoDialConcurrency,autoDialPriority:t.autoDialPriority??Vo.autoDialPriority,maxQueueLength:t.autoDialMaxQueueLength??Vo.autoDialMaxQueueLength}),this.connectionPruner=new hh({connectionManager:this,peerStore:e.peerStore,events:e.events},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new dh({peerId:e.peerId,metrics:e.metrics,peerStore:e.peerStore,transportManager:e.transportManager,connectionGater:e.connectionGater},{addressSorter:t.addressSorter??ja,maxParallelDials:t.maxParallelDials??uh,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,maxParallelDialsPerPeer:t.maxParallelDialsPerPeer??1,dialTimeout:t.dialTimeout??3e4,resolvers:t.resolvers??{dnsaddr:Za},connections:this.connections})}isStarted(){return this.started}async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{let e={inbound:0,outbound:0};for(let t of this.connections.values())for(let n of t)n.direction==="inbound"?e.inbound++:e.outbound++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{let e={};for(let t of this.connections.values())for(let n of t)for(let i of n.streams){let s=`${i.direction} ${i.protocol??"unnegotiated"}`;e[s]=(e[s]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{let e={};for(let n of this.connections.values())for(let i of n){let s={};for(let o of i.streams){let a=`${o.direction} ${o.protocol??"unnegotiated"}`;s[a]=(s[a]??0)+1}for(let[o,a]of Object.entries(s))e[o]=e[o]??[],e[o].push(a)}let t={};for(let[n,i]of Object.entries(e)){i=i.sort((o,a)=>o-a);let s=Math.floor(i.length*.9);t[n]=i[s]}return t}}),this.autoDial.start(),this.started=!0,tn("started")}async afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>t.tags.has(lE)]});await Promise.all(e.map(async t=>{await this.openConnection(t.id).catch(n=>{tn.error(n)})}))}).catch(e=>{tn.error(e)}),this.autoDial.afterStart()}async stop(){this.dialQueue.stop(),this.autoDial.stop();let e=[];for(let t of this.connections.values())for(let n of t)e.push((async()=>{try{await n.close()}catch(i){tn.error(i)}})());tn("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),tn("stopped")}onConnect(e){this._onConnect(e).catch(t=>{tn.error(t)})}async _onConnect(e){let{detail:t}=e;if(!this.started){await t.close();return}let n=t.remotePeer,i=this.connections.get(n),s=!1;i!=null?i.push(t):(s=!0,this.connections.set(n,[t])),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){let{detail:t}=e;if(!this.started)return;let n=t.remotePeer,i=this.connections.get(n);i!=null&&i.length>1?(i=i.filter(s=>s.id!==t.id),this.connections.set(n,i)):i!=null&&(this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(let n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.isStarted())throw new b("Not started",$.ERR_NODE_NOT_STARTED);t.signal?.throwIfAborted();let{peerId:n}=ah(e);if(n!=null&&t.force!==!0){tn("dial %p",n);let a=this.getConnections(n).find(c=>!c.transient);if(a!=null)return tn("had an existing non-transient connection to %p",n),a}let i=await this.dialQueue.dial(e,{...t,priority:t.priority??TU}),s=this.connections.get(i.remotePeer);s==null&&(s=[],this.connections.set(i.remotePeer,s));let o=!1;for(let a of s)a.id===i.id&&(o=!0);return o||s.push(i),i}async closeConnections(e,t={}){let n=this.connections.get(e)??[];await Promise.all(n.map(async i=>{try{await i.close(t)}catch(s){i.abort(s)}}))}async acceptIncomingConnection(e){if(this.deny.some(i=>e.remoteAddr.toString().startsWith(i.toString())))return tn("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(i=>e.remoteAddr.toString().startsWith(i.toString())))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return tn("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){let i=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(i,1)}catch{return tn("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,i),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(tn("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){return this.dialQueue.pendingDials}};async function*jl(r,e){yield*zr(r,async t=>(await e.merge(t.id,{multiaddrs:t.multiaddrs}),t))}function mh(r){let e=new Set;return wr(r,t=>e.has(t.id.toString())?!1:(e.add(t.id.toString()),!0))}async function*gh(r,e=1){let t=0;for await(let n of r)t++,yield n;if(t<e)throw new b(`more peers required, seen: ${t}  min: ${e}`,"NOT_FOUND")}var yh=class{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new b("No content routers available",$.ERR_NO_ROUTERS_AVAILABLE);yield*Te(Ut(...this.routers.map(n=>n.findProviders(e,t))),n=>jl(n,this.components.peerStore),n=>mh(n),n=>gh(n))}async provide(e,t={}){if(this.routers.length===0)throw new b("No content routers available",$.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map(async n=>{await n.provide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new b(Ei.NOT_STARTED_YET,$.DHT_NOT_STARTED);await Promise.all(this.routers.map(async i=>{await i.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new b(Ei.NOT_STARTED_YET,$.DHT_NOT_STARTED);return Promise.any(this.routers.map(async n=>n.get(e,t)))}};function DU(r){return r[Symbol.asyncIterator]!=null}function CU(r){if(DU(r))return(async()=>{for await(let e of r)return e})();for(let e of r)return e}var rn=CU;var PU=D("libp2p:peer-routing"),bh=class{components;routers;constructor(e,t){this.components=e,this.routers=t.routers??[]}async findPeer(e,t){if(this.routers.length===0)throw new b("No peer routers available",$.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.components.peerId.toString())throw new b("Should not try to find self",$.ERR_FIND_SELF);let n=await Te(Ut(...this.routers.map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(s){PU.error(s)}}())),i=>wr(i,Boolean),i=>jl(i,this.components.peerStore),async i=>rn(i));if(n!=null)return n;throw new b(Ei.NOT_FOUND,$.ERR_NOT_FOUND)}async*getClosestPeers(e,t){if(this.routers.length===0)throw new b("No peer routers available",$.ERR_NO_ROUTERS_AVAILABLE);yield*Te(Ut(...this.routers.map(n=>n.getClosestPeers(e,t))),n=>jl(n,this.components.peerStore),n=>mh(n),n=>gh(n))}};var kU=D("libp2p:registrar"),h3=32,d3=64,wh=class{topologies;handlers;components;constructor(e){this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){let t=this.handlers.get(e);if(t==null)throw new b(`No handler registered for protocol ${e}`,$.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){let t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e))throw new b(`Handler already registered for protocol ${e}`,$.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);let i=Ts.bind({ignoreUndefined:!0})({maxInboundStreams:h3,maxOutboundStreams:d3},n);this.handlers.set(e,{handler:t,options:i}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach(n=>{this.handlers.delete(n)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(t==null)throw new b("invalid topology",$.ERR_INVALID_PARAMETERS);let n=`${(Math.random()*1e9).toString(36)}${Date.now()}`,i=this.topologies.get(e);return i==null&&(i=new Map,this.topologies.set(e,i)),i.set(n,t),n}unregister(e){for(let[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){let t=e.detail;this.components.peerStore.get(t).then(n=>{for(let i of n.protocols){let s=this.topologies.get(i);if(s!=null)for(let o of s.values())o.onDisconnect?.(t)}}).catch(n=>{n.code!==$.ERR_NOT_FOUND&&kU.error("could not inform topologies of disconnecting peer %p",t,n)})}_onPeerUpdate(e){let{peer:t,previous:n}=e.detail,i=(n?.protocols??[]).filter(s=>!t.protocols.includes(s));for(let s of i){let o=this.topologies.get(s);if(o!=null)for(let a of o.values())a.onDisconnect?.(t.id)}}_onPeerIdentify(e){let t=e.detail.protocols,n=e.detail.connection,i=e.detail.peerId;for(let s of t){let o=this.topologies.get(s);if(o!=null)for(let a of o.values())n.transient&&a.notifyOnTransient!==!0||a.onConnect?.(i,n)}}};var Ls=D("libp2p:transports"),Eh=class{components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.components=e,this.started=!1,this.transports=new Map,this.listeners=ai({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??ks.FATAL_ALL}add(e){let t=e[Symbol.toStringTag];if(t==null)throw new b("Transport must have a valid tag",$.ERR_INVALID_KEY);if(this.transports.has(t))throw new b(`There is already a transport with the tag ${t}`,$.ERR_DUPLICATE_TRANSPORT);Ls("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){let e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){let e=[];for(let[t,n]of this.listeners)for(Ls("closing listeners for %s",t);n.length>0;){let i=n.pop();i!=null&&e.push(i.close())}await Promise.all(e),Ls("all listeners closed");for(let t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){let n=this.transportForMultiaddr(e);if(n==null)throw new b(`No transport available for address ${String(e)}`,$.ERR_TRANSPORT_UNAVAILABLE);try{return await n.dial(e,{...t,upgrader:this.components.upgrader})}catch(i){throw i.code==null&&(i.code=$.ERR_TRANSPORT_DIAL_FAILED),i}}getAddrs(){let e=[];for(let t of this.listeners.values())for(let n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}transportForMultiaddr(e){for(let t of this.transports.values())if(t.filter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new b("Not started",$.ERR_NODE_NOT_STARTED);if(e==null||e.length===0){Ls("no addresses were provided for listening, this node is dial only");return}let t=[];for(let[n,i]of this.transports.entries()){let s=i.filter(e),o=[];for(let l of s){Ls("creating listener for %s on %a",n,l);let u=i.createListener({upgrader:this.components.upgrader}),f=this.listeners.get(n)??[];f==null&&(f=[],this.listeners.set(n,f)),f.push(u),u.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:u})}),u.addEventListener("close",()=>{let h=f.findIndex(d=>d===u);f.splice(h,1),this.components.events.safeDispatchEvent("transport:close",{detail:u})}),o.push(u.listen(l))}if(o.length===0){t.push(n);continue}if((await Promise.allSettled(o)).find(l=>l.status==="fulfilled")==null&&this.faultTolerance!==ks.NO_FATAL)throw new b(`Transport (${n}) could not listen on any available address`,$.ERR_NO_VALID_ADDRESSES)}if(t.length===this.transports.size){let n=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===ks.FATAL_ALL)throw new b(n,$.ERR_NO_VALID_ADDRESSES);Ls(`libp2p in dial mode only: ${n}`)}}async remove(e){let t=this.listeners.get(e)??[];Ls.trace("removing transport %s",e);let n=[];for(Ls.trace("closing listeners for %s",e);t.length>0;){let i=t.pop();i!=null&&n.push(i.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){let e=[];for(let t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}};var Qi="/multistream/1.0.0";function p3(r){let e=async function*(){let t=yield,n=new _e;for await(let i of r){if(t==null){n.append(i),t=yield n,n=new _e;continue}for(n.append(i);n.length>=t;){let s=n.sublist(0,t);if(n.consume(t),t=yield s,t==null){n.length>0&&(t=yield n,n=new _e);break}}}if(t!=null)throw Object.assign(new Error(`stream ended before ${t} bytes became available`),{code:"ERR_UNDER_READ",buffer:n})}();return e.next(),e}function xh(r){let e=Et(),t=p3(r.source),n=ge(),i,s=r.sink(async function*(){yield*e,yield*await n.promise}());return s.catch(a=>{i=a}),{reader:t,writer:e,stream:{sink:async a=>{if(i!=null){await Promise.reject(i);return}n.resolve(a),await s},source:t},rest:()=>e.end(),write:e.push,read:async()=>{let a=await t.next();if(a.value!=null)return a.value}}}var Zl=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function cx(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function Zt(r,e,t){let n=t??{},i=cx(r);async function*s(){let o,a=()=>{o?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){let{abortMessage:u,abortCode:f}=n;throw new Zl(u,f)}let l=new Promise((u,f)=>{o=()=>{let{abortMessage:h,abortCode:d}=n;f(new Zl(h,d))}});c=await Promise.race([l,i.next()]),o=null}catch(l){e.removeEventListener("abort",a);let u=l.type==="aborted"&&e.aborted;if(u&&n.onAbort!=null&&n.onAbort(r),typeof i.return=="function")try{let f=i.return();f instanceof Promise&&f.catch(h=>{n.onReturnError!=null&&n.onReturnError(h)})}catch(f){n.onReturnError!=null&&n.onReturnError(f)}if(u&&n.returnOnAbort===!0)return;throw l}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return s()}function NU(r,e,t){return n=>r(Zt(n,e,t))}function m3(r,e,t){return{sink:NU(r.sink,e,{...t,onAbort:void 0}),source:Zt(r.source,e,t)}}var LU=D("libp2p:mss"),lx=Y(`
`);function Jl(r){let e=new _e(r,lx);return Rt.single(e)}function qo(r,e,t={}){let n=Jl(e);t.writeBytes===!0?r.push(n.subarray()):r.push(n)}function ux(r,e,t={}){let n=new _e;for(let i of e)n.append(Jl(i));t.writeBytes===!0?r.push(n.subarray()):r.push(n)}async function BU(r,e){let t=1,n={[Symbol.asyncIterator]:()=>n,next:async()=>r.next(t)},i=n;e?.signal!=null&&(i=Zt(n,e.signal));let s=a=>{t=a},o=await Te(i,a=>vt(a,{onLength:s,maxDataLength:1024}),async a=>rn(a));if(o==null||o.length===0)throw new b("no buffer returned","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");if(o.get(o.byteLength-1)!==lx[0])throw LU.error("Invalid mss message - missing newline - %s",o.subarray()),new b("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return o.sublist(0,-1)}async function sc(r,e){let t=await BU(r,e);return H(t.subarray())}var eu=D("libp2p:mss:select");async function tu(r,e,t={}){e=Array.isArray(e)?[...e]:[e];let{reader:n,writer:i,rest:s,stream:o}=xh(r),a=e.shift();if(a==null)throw new Error("At least one protocol must be specified");eu.trace('select: write ["%s", "%s"]',Qi,a);let c=Y(Qi),l=Y(a);ux(i,[c,l],t);let u=await sc(n,t);if(eu.trace('select: read "%s"',u),u===Qi&&(u=await sc(n,t),eu.trace('select: read "%s"',u)),u===a)return s(),{stream:o,protocol:a};for(let f of e){eu.trace('select: write "%s"',f),qo(i,Y(f),t);let h=await sc(n,t);if(eu.trace('select: read "%s" for "%s"',h,f),h===f)return s(),{stream:o,protocol:f}}throw s(),new b("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}var ru=D("libp2p:mss:handle");async function nu(r,e,t){e=Array.isArray(e)?e:[e];let{writer:n,reader:i,rest:s,stream:o}=xh(r);for(;;){let a=await sc(i,t);if(ru.trace('read "%s"',a),a===Qi){ru.trace('respond with "%s" for "%s"',Qi,a),qo(n,Y(Qi),t);continue}if(e.includes(a))return qo(n,Y(a),t),ru.trace('respond with "%s" for "%s"',a,a),s(),{stream:o,protocol:a};if(a==="ls"){qo(n,new _e(...e.map(c=>Jl(Y(c)))),t),ru.trace('respond with "%s" for %s',e,a);continue}qo(n,Y("na"),t),ru('respond with "na" for "%s"',a)}}var hx=Symbol.for("@libp2p/connection");var zo=D("libp2p:connection"),UU=500,g3=class{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;transient;tags;_newStream;_close;_abort;_getStreams;constructor(e){let{remoteAddr:t,remotePeer:n,newStream:i,close:s,abort:o,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.transient=e.transient??!1,this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=i,this._close=s,this._abort=o,this._getStreams=a,this.tags=[]}[Symbol.toStringTag]="Connection";[hx]=!0;get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new b("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");if(this.status==="closed")throw new b("the connection is closed","ERR_CONNECTION_CLOSED");if(Array.isArray(e)||(e=[e]),this.transient&&t?.runOnTransientConnection!==!0)throw new b("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");let n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){zo("closing connection to %a",this.remoteAddr),this.status="closing",e.signal=e?.signal??AbortSignal.timeout(UU),nt(1/0,e.signal);try{zo.trace("closing all streams"),await Promise.all(this.streams.map(async t=>t.close(e))),zo.trace("closing underlying transport"),await this._close(e),zo.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){zo.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){zo.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this.streams.forEach(t=>{t.abort(e)}),zo.error("all streams aborted",this.streams.length),this._abort(e),this.timeline.close=Date.now(),this.status="closed"}};function dx(r){return new g3(r)}var et=D("libp2p:upgrader");function KU(r,e){try{let{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.code!==$.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return h3}function VU(r,e,t={}){try{let{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.code!==$.ERR_NO_HANDLER_FOR_PROTOCOL)throw n}return t.maxOutboundStreams??d3}function px(r,e,t){let n=0;return t.streams.forEach(i=>{i.direction===e&&i.protocol===r&&n++}),n}var vh=class{components;connectionEncryption;muxers;inboundUpgradeTimeout;events;constructor(e,t){this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach(n=>{this.connectionEncryption.set(n.protocol,n)}),this.muxers=new Map,t.muxers.forEach(n=>{this.muxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??3e4,this.events=e.events}async shouldBlockConnection(e,t,n){let i=this.components.connectionGater[n];if(i!==void 0&&await i(e,t))throw new b(`The multiaddr connection is blocked by gater.${n}`,$.ERR_CONNECTION_INTERCEPTED)}async upgradeInbound(e,t){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw new b("connection denied",$.ERR_CONNECTION_DENIED);let i,s,o,a,c,l=AbortSignal.timeout(this.inboundUpgradeTimeout),u=()=>{e.abort(new b("inbound upgrade timeout",$.ERR_TIMEOUT))};l.addEventListener("abort",u,{once:!0}),nt(1/0,l);try{if(await this.components.connectionGater.denyInboundConnection?.(e)===!0)throw new b("The multiaddr connection is blocked by gater.acceptConnection",$.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(e),et("starting the inbound connection upgrade");let f=e;if(t?.skipProtection!==!0){let h=this.components.connectionProtector;h!=null&&(et("protecting the inbound connection"),f=await h.protect(e))}try{if(i=f,t?.skipEncryption!==!0){({conn:i,remotePeer:s,protocol:c}=await this._encryptInbound(f));let h={...f,...i};await this.shouldBlockConnection(s,h,"denyInboundEncryptedConnection")}else{let h=e.remoteAddr.getPeerId();if(h==null)throw new b("inbound connection that skipped encryption must have a peer id",$.ERR_INVALID_MULTIADDR);let d=ae(h);c="native",s=d}if(o=i,t?.muxerFactory!=null)a=t.muxerFactory;else if(this.muxers.size>0){let h=await this._multiplexInbound({...f,...i},this.muxers);a=h.muxerFactory,o=h.stream}}catch(h){throw et.error("Failed to upgrade inbound connection",h),h}return await this.shouldBlockConnection(s,e,"denyInboundUpgradedConnection"),et("Successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:c,direction:"inbound",maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:s,transient:t?.transient})}finally{l.removeEventListener("abort",u),this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){let n=e.remoteAddr.getPeerId(),i;n!=null&&(i=ae(n),await this.shouldBlockConnection(i,e,"denyOutboundConnection"));let s,o,a,c,l;this.components.metrics?.trackMultiaddrConnection(e),et("Starting the outbound connection upgrade");let u=e;if(t?.skipProtection!==!0){let f=this.components.connectionProtector;f!=null&&(u=await f.protect(e))}try{if(s=u,t?.skipEncryption!==!0){({conn:s,remotePeer:o,protocol:c}=await this._encryptOutbound(u,i));let f={...u,...s};await this.shouldBlockConnection(o,f,"denyOutboundEncryptedConnection")}else{if(i==null)throw new b("Encryption was skipped but no peer id was passed",$.ERR_INVALID_PEER);c="native",o=i}if(a=s,t?.muxerFactory!=null)l=t.muxerFactory;else if(this.muxers.size>0){let f=await this._multiplexOutbound({...u,...s},this.muxers);l=f.muxerFactory,a=f.stream}}catch(f){throw et.error("Failed to upgrade outbound connection",f),await e.close(f),f}return await this.shouldBlockConnection(o,e,"denyOutboundUpgradedConnection"),et("Successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:c,direction:"outbound",maConn:e,upgradedConn:a,muxerFactory:l,remotePeer:o,transient:t?.transient})}_createConnection(e){let{cryptoProtocol:t,direction:n,maConn:i,upgradedConn:s,remotePeer:o,muxerFactory:a,transient:c}=e,l,u,f;a!=null&&(l=a.createStreamMuxer({direction:n,onIncomingStream:p=>{f!=null&&Promise.resolve().then(async()=>{let m=this.components.registrar.getProtocols(),{stream:g,protocol:y}=await nu(p,m);if(et("%s: incoming stream opened on %s",n,y),f==null)return;let w=KU(y,this.components.registrar);if(px(y,"inbound",f)===w){let R=new b(`Too many inbound protocol streams for protocol "${y}" - limit ${w}`,$.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS);throw p.abort(R),R}p.source=g.source,p.sink=g.sink,p.protocol=y,await this.components.peerStore.merge(o,{protocols:[y]}),this.components.metrics?.trackProtocolStream(p,f),this._onStream({connection:f,stream:p,protocol:y})}).catch(async m=>{et.error(m),p.timeline.close==null&&await p.close()})}}),u=async(p,m={})=>{if(l==null)throw new b("Stream is not multiplexed",$.ERR_MUXER_UNAVAILABLE);et("%s: starting new stream on %s",n,p);let g=await l.newStream();try{m.signal==null&&(et("No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",p),m.signal=AbortSignal.timeout(3e4),nt(1/0,m.signal));let{stream:y,protocol:w}=await tu(g,p,m),E=VU(w,this.components.registrar,m);if(px(w,"outbound",f)>=E){let x=new b(`Too many outbound protocol streams for protocol "${w}" - limit ${E}`,$.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw g.abort(x),x}return await this.components.peerStore.merge(o,{protocols:[w]}),g.source=y.source,g.sink=y.sink,g.protocol=w,this.components.metrics?.trackProtocolStream(g,f),g}catch(y){throw et.error("could not create new stream for protocols %s on connection with address %a",p,f.remoteAddr,y),g.timeline.close==null&&g.abort(y),y.code!=null?y:new b(String(y),$.ERR_UNSUPPORTED_PROTOCOL)}},Promise.all([l.sink(s.source),s.sink(l.source)]).catch(p=>{et.error(p)}));let h=i.timeline;i.timeline=new Proxy(h,{set:(...p)=>(f!=null&&p[1]==="close"&&p[2]!=null&&h.close==null&&(async()=>{try{f.status==="open"&&await f.close()}catch(m){et.error(m)}finally{this.events.safeDispatchEvent("connection:close",{detail:f})}})().catch(m=>{et.error(m)}),Reflect.set(...p))}),i.timeline.upgraded=Date.now();let d=()=>{throw new b("connection is not multiplexed",$.ERR_CONNECTION_NOT_MULTIPLEXED)};return f=dx({remoteAddr:i.remoteAddr,remotePeer:o,status:"open",direction:n,timeline:i.timeline,multiplexer:l?.protocol,encryption:t,transient:c,newStream:u??d,getStreams:()=>l!=null?l.streams:[],close:async p=>{l!=null&&(et.trace("close muxer"),await l.close(p)),et.trace("close maconn"),await i.close(p),et.trace("closed maconn")},abort:p=>{i.abort(p),l?.abort(p)}}),this.events.safeDispatchEvent("connection:open",{detail:f}),f}_onStream(e){let{connection:t,stream:n,protocol:i}=e,{handler:s,options:o}=this.components.registrar.getHandler(i);if(t.transient&&o.runOnTransientConnection!==!0)throw new b("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");s({connection:t,stream:n})}async _encryptInbound(e){let t=Array.from(this.connectionEncryption.keys());et("handling inbound crypto protocol selection",t);try{let{stream:n,protocol:i}=await nu(e,t,{writeBytes:!0}),s=this.connectionEncryption.get(i);if(s==null)throw new Error(`no crypto module found for ${i}`);return et("encrypting inbound connection..."),{...await s.secureInbound(this.components.peerId,n),protocol:i}}catch(n){throw new b(String(n),$.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){let n=Array.from(this.connectionEncryption.keys());et("selecting outbound crypto protocol",n);try{let{stream:i,protocol:s}=await tu(e,n,{writeBytes:!0}),o=this.connectionEncryption.get(s);if(o==null)throw new Error(`no crypto module found for ${s}`);return et("encrypting outbound connection to %p",t),{...await o.secureOutbound(this.components.peerId,i,t),protocol:s}}catch(i){throw new b(String(i),$.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){let n=Array.from(t.keys());et("outbound selecting muxer %s",n);try{let{stream:i,protocol:s}=await tu(e,n,{writeBytes:!0});et("%s selected as muxer protocol",s);let o=t.get(s);return{stream:i,muxerFactory:o}}catch(i){throw et.error("error multiplexing outbound stream",i),new b(String(i),$.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){let n=Array.from(t.keys());et("inbound handling muxers %s",n);try{let{stream:i,protocol:s}=await nu(e,n,{writeBytes:!0}),o=t.get(s);return{stream:i,muxerFactory:o}}catch(i){throw et.error("error multiplexing inbound stream",i),new b(String(i),$.ERR_MUXER_UNAVAILABLE)}}};var Mr=D("libp2p"),y3=class extends Fe{peerId;peerStore;contentRouting;peerRouting;keychain;metrics;services;components;#e;constructor(e){super();let t=new Fe,n=t.dispatchEvent.bind(t);t.dispatchEvent=c=>{let l=n(c),u=this.dispatchEvent(new Ge(c.type,{detail:c.detail}));return l||u},nt(1/0,t),this.#e=!1,this.peerId=e.peerId,this.services={};let i=this.components=Cw({peerId:e.peerId,events:t,datastore:e.datastore??new so,connectionGater:Kw(e.connectionGater)});this.peerStore=this.configureComponent("peerStore",new Qf(i,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),i.events.addEventListener("peer:update",c=>{if(c.detail.previous==null){let l={id:c.detail.peer.id,multiaddrs:c.detail.peer.addresses.map(u=>u.multiaddr),protocols:c.detail.peer.protocols};i.events.safeDispatchEvent("peer:discovery",{detail:l})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(i)),this.components.upgrader=new vh(this.components,{connectionEncryption:(e.connectionEncryption??[]).map((c,l)=>this.configureComponent(`connection-encryption-${l}`,c(this.components))),muxers:(e.streamMuxers??[]).map((c,l)=>this.configureComponent(`stream-muxers-${l}`,c(this.components))),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),this.configureComponent("transportManager",new Eh(this.components,e.transportManager)),this.configureComponent("connectionManager",new ph(this.components,e.connectionManager)),this.configureComponent("registrar",new wh(this.components)),this.configureComponent("addressManager",new Xf(this.components,e.addresses));let s=Uo.generateOptions();this.keychain=this.configureComponent("keyChain",new Uo(this.components,{...s,...e.keychain}));let o=(e.peerRouters??[]).map((c,l)=>this.configureComponent(`peer-router-${l}`,c(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new bh(this.components,{routers:o}));let a=(e.contentRouters??[]).map((c,l)=>this.configureComponent(`content-router-${l}`,c(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new yh(this.components,{routers:a})),(e.peerDiscovery??[]).forEach((c,l)=>{this.configureComponent(`peer-discovery-${l}`,c(this.components)).addEventListener("peer",f=>{this.#t(f)})}),e.transports.forEach((c,l)=>{this.components.transportManager.add(this.configureComponent(`transport-${l}`,c(this.components)))}),e.services!=null)for(let c of Object.keys(e.services)){let l=e.services[c],u=l(this.components);if(u==null){Mr.error("service factory %s returned null or undefined instance",c);continue}this.services[c]=u,this.configureComponent(c,u),u[Co]!=null&&(Mr("registering service %s for content routing",c),a.push(u[Co])),u[ko]!=null&&(Mr("registering service %s for peer routing",c),o.push(u[ko])),u[Po]!=null&&(Mr("registering service %s for peer discovery",c),u[Po].addEventListener("peer",f=>{this.#t(f)}))}}configureComponent(e,t){return t==null&&Mr.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.#e)return;this.#e=!0,Mr("libp2p is starting"),(await this.keychain.listKeys()).find(t=>t.name==="self")==null&&(Mr("importing self key into keychain"),await this.keychain.importPeer("self",this.components.peerId));try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.safeDispatchEvent("start",{detail:this}),Mr("libp2p has started")}catch(t){throw Mr.error("An error occurred starting libp2p",t),await this.stop(),t}}async stop(){this.#e&&(Mr("libp2p is stopping"),this.#e=!1,await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.safeDispatchEvent("stop",{detail:this}),Mr("libp2p has stopped"))}isStarted(){return this.#e}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){let e=new _n;for(let t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,t)}async dialProtocol(e,t,n={}){if(t==null)throw new b("no protocols were provided to open a stream",$.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(t=Array.isArray(t)?t:[t],t.length===0)throw new b("no protocols were provided to open a stream",$.ERR_INVALID_PROTOCOLS_FOR_STREAM);return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Cs(e)&&(e=ae(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(Mr("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;let n=await this.peerStore.get(e);if(n.id.publicKey!=null)return n.id.publicKey;let i=ve([Y("/pk/"),e.multihash.digest]),s=await this.contentRouting.get(i,t);return Lr(s),await this.peerStore.patch(e,{publicKey:s}),s}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async i=>{await this.components.registrar.handle(i,t,n)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async t=>{await this.components.registrar.unhandle(t)}))}async register(e,t){return this.components.registrar.register(e,t)}unregister(e){this.components.registrar.unregister(e)}#t(e){let{detail:t}=e;if(t.id.toString()===this.peerId.toString()){Mr.error(new Error($.ERR_DISCOVERED_SELF));return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs,protocols:t.protocols}).catch(n=>{Mr.error(n)})}};async function mx(r){if(r.peerId==null){let e=r.datastore;if(e!=null)try{let t=new Uo({datastore:e},Ts(Uo.generateOptions(),r.keychain));r.peerId=await t.exportPeerId("self")}catch(t){if(t.code!=="ERR_NOT_FOUND")throw t}}return r.peerId==null&&(r.peerId=await Bf()),new y3(cE(r))}async function gx(r){let e=await mx(r);return r.start!==!1&&await e.start(),e}var _h=class{gossip;msgs=new Map;msgIdToStrFn;history=[];notValidatedCount=0;constructor(e,t,n){this.gossip=e,this.msgIdToStrFn=n;for(let i=0;i<t;i++)this.history[i]=[]}get size(){return this.msgs.size}put(e,t,n=!1){let{msgIdStr:i}=e;return this.msgs.has(i)?!1:(this.msgs.set(i,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){let n=this.msgs.get(e);n&&!n.validated&&n.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){let n=this.msgs.get(e);if(!n)return null;let i=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,i),{msg:n.message,count:i}}getGossipIDs(e){let t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach(i=>{let s=this.msgs.get(i.msgIdStr);if(s&&s.validated&&e.has(i.topic)){let o=t.get(i.topic);o||(o=[],t.set(i.topic,o)),o.push(i.msgId)}});return t}validate(e){let t=this.msgs.get(e);if(!t)return null;t.validated||this.notValidatedCount--;let{message:n,originatingPeers:i}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:i}}shift(){this.history[this.history.length-1].forEach(t=>{let n=this.msgs.get(t.msgIdStr);n&&(this.msgs.delete(t.msgIdStr),n.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(e){let t=this.msgs.get(e);return t?(this.msgs.delete(e),t):null}};var mv=de(pv(),1),{RPC:cu}=mv.default;var k3="/floodsub/1.0.0",N3="/meshsub/1.0.0",O3="/meshsub/1.1.0";var gv="ERR_TOPIC_VALIDATOR_REJECT",yv="ERR_TOPIC_VALIDATOR_IGNORE";function vi(r){if(r.length<=1)return r;let e=()=>Math.floor(Math.random()*Math.floor(r.length));for(let t=0;t<r.length;t++){let n=e(),i=r[t];r[t]=r[n],r[n]=i}return r}function bv(r){return H(r,"base64")}var Wo="StrictSign",ac="StrictNoSign",_r;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(_r||(_r={}));var wv;(function(r){r.StrictSign="StrictSign",r.StrictNoSign="StrictNoSign"})(wv||(wv={}));var Fs;(function(r){r[r.Signing=0]="Signing",r[r.Anonymous=1]="Anonymous"})(Fs||(Fs={}));var Sr;(function(r){r.Error="error",r.Ignore="ignore",r.Reject="reject",r.Blacklisted="blacklisted"})(Sr||(Sr={}));var gr;(function(r){r.InvalidSignature="invalid_signature",r.InvalidSeqno="invalid_seqno",r.InvalidPeerId="invalid_peerid",r.SignaturePresent="signature_present",r.SeqnoPresent="seqno_present",r.FromPresent="from_present",r.TransformFailed="transform_failed"})(gr||(gr={}));var yr;(function(r){r.duplicate="duplicate",r.invalid="invalid",r.valid="valid"})(yr||(yr={}));function L3(r){switch(r){case _r.Ignore:return Sr.Ignore;case _r.Reject:return Sr.Reject}}async function B3(r,e){switch(r){case Wo:{if(!e)throw Error("Must provide PeerId");if(e.privateKey==null)throw Error("Cannot sign message, no private key present");if(e.publicKey==null)throw Error("Cannot sign message, no public key present");let t=await vn(e.privateKey);return{type:Fs.Signing,author:e,key:e.publicKey,privateKey:t}}case ac:return{type:Fs.Anonymous};default:throw new Error(`Unknown signature policy "${r}"`)}}var Ze="ERR_INVALID_PEER_SCORE_PARAMS";var ZU={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},JU={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function Ev(r={}){return{...ZU,...r,topics:r.topics?Object.entries(r.topics).reduce((e,[t,n])=>(e[t]=eF(n),e),{}):{}}}function eF(r={}){return{...JU,...r}}function xv(r){for(let[e,t]of Object.entries(r.topics))try{tF(t)}catch(n){throw new b(`invalid score parameters for topic ${e}: ${n.message}`,Ze)}if(r.topicScoreCap<0)throw new b("invalid topic score cap; must be positive (or 0 for no cap)",Ze);if(r.appSpecificScore===null||r.appSpecificScore===void 0)throw new b("missing application specific score function",Ze);if(r.IPColocationFactorWeight>0)throw new b("invalid IPColocationFactorWeight; must be negative (or 0 to disable)",Ze);if(r.IPColocationFactorWeight!==0&&r.IPColocationFactorThreshold<1)throw new b("invalid IPColocationFactorThreshold; must be at least 1",Ze);if(r.behaviourPenaltyWeight>0)throw new b("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)",Ze);if(r.behaviourPenaltyWeight!==0&&(r.behaviourPenaltyDecay<=0||r.behaviourPenaltyDecay>=1))throw new b("invalid BehaviourPenaltyDecay; must be between 0 and 1",Ze);if(r.decayInterval<1e3)throw new b("invalid DecayInterval; must be at least 1s",Ze);if(r.decayToZero<=0||r.decayToZero>=1)throw new b("invalid DecayToZero; must be between 0 and 1",Ze)}function tF(r){if(r.topicWeight<0)throw new b("invalid topic weight; must be >= 0",Ze);if(r.timeInMeshQuantum===0)throw new b("invalid TimeInMeshQuantum; must be non zero",Ze);if(r.timeInMeshWeight<0)throw new b("invalid TimeInMeshWeight; must be positive (or 0 to disable)",Ze);if(r.timeInMeshWeight!==0&&r.timeInMeshQuantum<=0)throw new b("invalid TimeInMeshQuantum; must be positive",Ze);if(r.timeInMeshWeight!==0&&r.timeInMeshCap<=0)throw new b("invalid TimeInMeshCap; must be positive",Ze);if(r.firstMessageDeliveriesWeight<0)throw new b("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)",Ze);if(r.firstMessageDeliveriesWeight!==0&&(r.firstMessageDeliveriesDecay<=0||r.firstMessageDeliveriesDecay>=1))throw new b("invalid FirstMessageDeliveriesDecay; must be between 0 and 1",Ze);if(r.firstMessageDeliveriesWeight!==0&&r.firstMessageDeliveriesCap<=0)throw new b("invalid FirstMessageDeliveriesCap; must be positive",Ze);if(r.meshMessageDeliveriesWeight>0)throw new b("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)",Ze);if(r.meshMessageDeliveriesWeight!==0&&(r.meshMessageDeliveriesDecay<=0||r.meshMessageDeliveriesDecay>=1))throw new b("invalid MeshMessageDeliveriesDecay; must be between 0 and 1",Ze);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesCap<=0)throw new b("invalid MeshMessageDeliveriesCap; must be positive",Ze);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesThreshold<=0)throw new b("invalid MeshMessageDeliveriesThreshold; must be positive",Ze);if(r.meshMessageDeliveriesWindow<0)throw new b("invalid MeshMessageDeliveriesWindow; must be non-negative",Ze);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesActivation<1e3)throw new b("invalid MeshMessageDeliveriesActivation; must be at least 1s",Ze);if(r.meshFailurePenaltyWeight>0)throw new b("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)",Ze);if(r.meshFailurePenaltyWeight!==0&&(r.meshFailurePenaltyDecay<=0||r.meshFailurePenaltyDecay>=1))throw new b("invalid MeshFailurePenaltyDecay; must be between 0 and 1",Ze);if(r.invalidMessageDeliveriesWeight>0)throw new b("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)",Ze);if(r.invalidMessageDeliveriesDecay<=0||r.invalidMessageDeliveriesDecay>=1)throw new b("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1",Ze)}var rF={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function vv(r={}){return{...rF,...r}}function _v(r,e,t,n){let i=0;Object.entries(e.topics).forEach(([o,a])=>{let c=t.topics[o];if(c===void 0)return;let l=0;if(a.inMesh){let d=a.meshTime/c.timeInMeshQuantum;d>c.timeInMeshCap&&(d=c.timeInMeshCap),l+=d*c.timeInMeshWeight}let u=a.firstMessageDeliveries;if(u>c.firstMessageDeliveriesCap&&(u=c.firstMessageDeliveriesCap),l+=u*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){let d=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,p=d*d;l+=p*c.meshMessageDeliveriesWeight}let f=a.meshFailurePenalty;l+=f*c.meshFailurePenaltyWeight;let h=a.invalidMessageDeliveries*a.invalidMessageDeliveries;l+=h*c.invalidMessageDeliveriesWeight,i+=l*c.topicWeight}),t.topicScoreCap>0&&i>t.topicScoreCap&&(i=t.topicScoreCap);let s=t.appSpecificScore(r);if(i+=s*t.appSpecificWeight,e.knownIPs.forEach(o=>{if(t.IPColocationFactorWhitelist.has(o))return;let a=n.get(o),c=a?a.size:0;if(c>t.IPColocationFactorThreshold){let l=c-t.IPColocationFactorThreshold,u=l*l;i+=u*t.IPColocationFactorWeight}}),e.behaviourPenalty>t.behaviourPenaltyThreshold){let o=e.behaviourPenalty-t.behaviourPenaltyThreshold,a=o*o;i+=a*t.behaviourPenaltyWeight}return i}var Iv=de(Rv(),1),Rr;(function(r){r[r.unknown=0]="unknown",r[r.valid=1]="valid",r[r.invalid=2]="invalid",r[r.ignored=3]="ignored"})(Rr||(Rr={}));var Th=class{records;queue;constructor(){this.records=new Map,this.queue=new Iv.default}getRecord(e){return this.records.get(e)}ensureRecord(e){let t=this.records.get(e);if(t)return t;t={status:Rr.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(e,t);let n={msgId:e,expire:Date.now()+12e4};return this.queue.push(n),t}gc(){let e=Date.now(),t=this.queue.peekFront();for(;t&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}};function Ch(r,e,t=()=>!0){let n=new Set;if(e<=0)return n;for(let i of r){if(n.size>=e)break;t(i)&&(n.add(i),r.delete(i))}return n}function Av(r,e){return Ch(r,e,()=>!0)}var Dh=class extends Map{getDefault;constructor(e){super(),this.getDefault=e}getOrDefault(e){let t=super.get(e);return t===void 0&&(t=this.getDefault(),this.set(e,t)),t}};var cc=D("libp2p:gossipsub:score"),Ph=class{params;metrics;peerStats=new Map;peerIPs=new Dh(()=>new Set);scoreCache=new Map;deliveryRecords=new Th;_backgroundInterval;scoreCacheValidityMs;computeScore;constructor(e,t,n){this.params=e,this.metrics=t,xv(e),this.scoreCacheValidityMs=n.scoreCacheValidityMs,this.computeScore=n.computeScore??_v}get size(){return this.peerStats.size}start(){if(this._backgroundInterval){cc("Peer score already running");return}this._backgroundInterval=setInterval(()=>this.background(),this.params.decayInterval),cc("started")}stop(){if(!this._backgroundInterval){cc("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),cc("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}messageFirstSeenTimestampMs(e){let t=this.deliveryRecords.getRecord(e);return t?t.firstSeenTsMs:null}refreshScores(){let e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((n,i)=>{if(!n.connected){e>n.expire&&(this.removeIPsForPeer(i,n.knownIPs),this.peerStats.delete(i),this.scoreCache.delete(i));return}Object.entries(n.topics).forEach(([s,o])=>{let a=this.params.topics[s];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<t&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<t&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<t&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<t&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=e-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)})}score(e){this.metrics?.scoreFnCalls.inc();let t=this.peerStats.get(e);if(!t)return 0;let n=Date.now(),i=this.scoreCache.get(e);if(i&&i.cacheUntil>n)return i.score;this.metrics?.scoreFnRuns.inc();let s=this.computeScore(e,t,this.params,this.peerIPs),o=n+this.scoreCacheValidityMs;return i?(this.metrics?.scoreCachedDelta.observe(Math.abs(s-i.score)),i.score=s,i.cacheUntil=o):this.scoreCache.set(e,{score:s,cacheUntil:o}),s}addPenalty(e,t,n){let i=this.peerStats.get(e);i&&(i.behaviourPenalty+=t,this.metrics?.onScorePenalty(n))}addPeer(e){let t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){let n=this.peerStats.get(e);n&&n.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){let n=this.peerStats.get(e);n&&n.knownIPs.delete(t);let i=this.peerIPs.get(t);i&&(i.delete(e),i.size===0&&this.peerIPs.delete(t))}removePeer(e){let t=this.peerStats.get(e);if(t){if(this.score(e)>0){this.removeIPsForPeer(e,t.knownIPs),this.peerStats.delete(e);return}Object.entries(t.topics).forEach(([n,i])=>{i.firstMessageDeliveries=0;let s=this.params.topics[n].meshMessageDeliveriesThreshold;if(i.inMesh&&i.meshMessageDeliveriesActive&&i.meshMessageDeliveries<s){let o=s-i.meshMessageDeliveries;i.meshFailurePenalty+=o*o}i.inMesh=!1,i.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){let n=this.peerStats.get(e);if(n){let i=this.getPtopicStats(n,t);i&&(i.inMesh=!0,i.graftTime=Date.now(),i.meshTime=0,i.meshMessageDeliveriesActive=!1)}}prune(e,t){let n=this.peerStats.get(e);if(n){let i=this.getPtopicStats(n,t);if(i){let s=this.params.topics[t].meshMessageDeliveriesThreshold;if(i.meshMessageDeliveriesActive&&i.meshMessageDeliveries<s){let o=s-i.meshMessageDeliveries;i.meshFailurePenalty+=o*o}i.meshMessageDeliveriesActive=!1,i.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);let i=this.deliveryRecords.ensureRecord(t),s=Date.now();if(i.status!==Rr.unknown){cc("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,s-i.firstSeenTsMs,Rr[i.status]);return}i.status=Rr.valid,i.validated=s,i.peers.forEach(o=>{o!==e.toString()&&this.markDuplicateMessageDelivery(o,n)})}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,i){switch(i){case Sr.Error:this.markInvalidMessageDelivery(e,n);return;case Sr.Blacklisted:return}let s=this.deliveryRecords.ensureRecord(t);if(s.status!==Rr.unknown){cc("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-s.firstSeenTsMs,Rr[s.status]);return}if(i===Sr.Ignore){s.status=Rr.ignored,s.peers.clear();return}s.status=Rr.invalid,this.markInvalidMessageDelivery(e,n),s.peers.forEach(o=>{this.markInvalidMessageDelivery(o,n)}),s.peers.clear()}duplicateMessage(e,t,n){let i=this.deliveryRecords.ensureRecord(t);if(!i.peers.has(e))switch(i.status){case Rr.unknown:i.peers.add(e);break;case Rr.valid:i.peers.add(e),this.markDuplicateMessageDelivery(e,n,i.validated);break;case Rr.invalid:this.markInvalidMessageDelivery(e,n);break;case Rr.ignored:break}}markInvalidMessageDelivery(e,t){let n=this.peerStats.get(e);if(n){let i=this.getPtopicStats(n,t);i&&(i.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){let n=this.peerStats.get(e);if(n){let i=this.getPtopicStats(n,t);if(i){let s=this.params.topics[t].firstMessageDeliveriesCap;i.firstMessageDeliveries=Math.min(s,i.firstMessageDeliveries+1),i.inMesh&&(s=this.params.topics[t].meshMessageDeliveriesCap,i.meshMessageDeliveries=Math.min(s,i.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){let i=this.peerStats.get(e);if(i){let s=n!==void 0?Date.now():0,o=this.getPtopicStats(i,t);if(o&&o.inMesh){let a=this.params.topics[t];if(n!==void 0){let l=s-n,u=l>a.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,l,u),u)return}let c=a.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(c,o.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(let n of t){let i=this.peerIPs.get(n);i&&(i.delete(e),i.size===0&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return n!==void 0?n:this.params.topics[t]!==void 0?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}};var kh=class{gossipsubIWantFollowupMs;msgIdToStrFn;metrics;promises=new Map;requestMsByMsg=new Map;requestMsByMsgExpire;constructor(e,t,n){this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){let n=Math.floor(Math.random()*t.length),i=t[n],s=this.msgIdToStrFn(i),o=this.promises.get(s);o||(o=new Map,this.promises.set(s,o));let a=Date.now();o.has(e)||(o.set(e,a+this.gossipsubIWantFollowupMs),this.metrics&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(s)||this.requestMsByMsg.set(s,a)))}getBrokenPromises(){let e=Date.now(),t=new Map,n=0;return this.promises.forEach((i,s)=>{i.forEach((o,a)=>{o<e&&(t.set(a,(t.get(a)??0)+1),i.delete(a),n++)}),i.size||this.promises.delete(s)}),this.metrics?.iwantPromiseBroken.inc(n),t}deliverMessage(e,t=!1){this.trackMessage(e);let n=this.promises.get(e);n&&(this.promises.delete(e),this.metrics&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){switch(this.trackMessage(e),t){case Sr.Error:return}this.promises.delete(e)}clear(){this.promises.clear()}prune(){let e=Date.now()-this.requestMsByMsgExpire,t=0;for(let[n,i]of this.requestMsByMsg.entries())if(i<e)this.requestMsByMsg.delete(n),t++;else break;this.metrics?.iwantMessagePruned.inc(t)}trackMessage(e){if(this.metrics){let t=this.requestMsByMsg.get(e);t!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}};var lc=class{entries=new Map;validityMs;constructor(e){this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return this.entries.has(e)?!0:(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){let e=Date.now();for(let[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}has(e){return this.entries.has(e)}get(e){let t=this.entries.get(e);return t&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}};var Tv;(function(r){r.forward="forward",r.publish="publish"})(Tv||(Tv={}));var Ir;(function(r){r.Fanout="fanout",r.Random="random",r.Subscribed="subscribed",r.Outbound="outbound",r.NotEnough="not_enough",r.Opportunistic="opportunistic"})(Ir||(Ir={}));var ei;(function(r){r.Dc="disconnected",r.BadScore="bad_score",r.Prune="prune",r.Excess="excess"})(ei||(ei={}));var fc;(function(r){r.GraftBackoff="graft_backoff",r.BrokenPromise="broken_promise",r.MessageDeficit="message_deficit",r.IPColocation="IP_colocation"})(fc||(fc={}));var hc;(function(r){r.LowScore="low_score",r.MaxIhave="max_ihave",r.MaxIasked="max_iasked"})(hc||(hc={}));var uc;(function(r){r.graylist="graylist",r.publish="publish",r.gossip="gossip",r.mesh="mesh"})(uc||(uc={}));function Dv(r,e,t){return{protocolsEnabled:r.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:r.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:r.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:r.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:r.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:r.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:r.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:r.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:r.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:r.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:r.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:r.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:r.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:r.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:r.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:r.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:r.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:r.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",labelNames:["topic"],buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:r.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:r.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:r.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:r.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:r.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:r.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:r.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:r.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:r.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:r.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:r.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:r.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:r.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:r.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:r.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:r.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:r.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:r.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:r.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:r.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:r.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:r.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:r.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:r.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:r.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:r.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:r.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:r.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:r.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:r.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:r.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:r.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:r.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:r.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:r.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:r.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:r.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:r.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:r.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:r.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:r.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:r.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*t.maxMeshMessageDeliveriesWindowSec,.5*t.maxMeshMessageDeliveriesWindowSec,1*t.maxMeshMessageDeliveriesWindowSec,2*t.maxMeshMessageDeliveriesWindowSec,4*t.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:r.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:r.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:r.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:r.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:r.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:r.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:r.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:r.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:r.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:r.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:r.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*t.behaviourPenaltyThreshold,.5*t.behaviourPenaltyThreshold,1*t.behaviourPenaltyThreshold,2*t.behaviourPenaltyThreshold,4*t.behaviourPenaltyThreshold]}),ihaveRcvIgnored:r.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:r.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:r.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:r.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:r.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:r.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:r.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:r.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:r.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:r.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:r.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*t.gossipPromiseExpireSec,1*t.gossipPromiseExpireSec,2*t.gossipPromiseExpireSec,4*t.gossipPromiseExpireSec]}),iwantPromiseUntracked:r.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:r.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:r.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:r.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:r.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:r.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:r.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:e,toTopic(n){return this.topicStrToLabel.get(n)??n},onJoin(n){this.topicSubscriptionStatus.set({topicStr:n},1),this.meshPeerCounts.set({topicStr:n},0)},onLeave(n){this.topicSubscriptionStatus.set({topicStr:n},0),this.meshPeerCounts.set({topicStr:n},0)},onAddToMesh(n,i,s){let o=this.toTopic(n);switch(i){case Ir.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:o},s);break;case Ir.Random:this.meshPeerInclusionEventsRandom.inc({topic:o},s);break;case Ir.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:o},s);break;case Ir.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:o},s);break;case Ir.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:o},s);break;case Ir.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:o},s);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:o},s);break}},onRemoveFromMesh(n,i,s){let o=this.toTopic(n);switch(i){case ei.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:o},s);break;case ei.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:o},s);break;case ei.Prune:this.meshPeerChurnEventsPrune.inc({topic:o},s);break;case ei.Excess:this.meshPeerChurnEventsExcess.inc({topic:o},s);break;default:this.meshPeerChurnEventsUnknown.inc({topic:o},s);break}},onReportValidation(n,i,s){if(this.asyncValidationMcacheHit.inc({hit:n!=null?"hit":"miss"}),n!=null){let o=this.toTopic(n.message.topic);switch(i){case _r.Accept:this.acceptedMessagesTotal.inc({topic:o});break;case _r.Ignore:this.ignoredMessagesTotal.inc({topic:o});break;case _r.Reject:this.rejectedMessagesTotal.inc({topic:o});break;default:this.unknownValidationResultsTotal.inc({topic:o});break}}s!=null?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-s)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(n){this.scoringPenalties.inc({penalty:n},1)},onIhaveRcv(n,i,s){let o=this.toTopic(n);this.ihaveRcvMsgids.inc({topic:o},i),this.ihaveRcvNotSeenMsgids.inc({topic:o},s)},onIwantRcv(n,i){for(let[s,o]of n){let a=this.toTopic(s);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(i)},onForwardMsg(n,i){let s=this.toTopic(n);this.msgForwardCount.inc({topic:s},1),this.msgForwardPeers.inc({topic:s},i)},onPublishMsg(n,i,s,o,a){let c=this.toTopic(n);this.msgPublishCount.inc({topic:c},1),this.msgPublishBytes.inc({topic:c},s*o),this.msgPublishPeersByTopic.inc({topic:c},s),this.directPeersPublishedTotal.inc({topic:c},i.direct),this.floodsubPeersPublishedTotal.inc({topic:c},i.floodsub),this.meshPeersPublishedTotal.inc({topic:c},i.mesh),this.fanoutPeersPublishedTotal.inc({topic:c},i.fanout),this.msgPublishTime.observe({topic:c},a/1e3)},onMsgRecvPreValidation(n){let i=this.toTopic(n);this.msgReceivedPreValidation.inc({topic:i},1)},onMsgRecvError(n){let i=this.toTopic(n);this.msgReceivedError.inc({topic:i},1)},onPrevalidationResult(n,i){let s=this.toTopic(n);switch(i){case yr.duplicate:this.prevalidationDuplicateTotal.inc({topic:s});break;case yr.invalid:this.prevalidationInvalidTotal.inc({topic:s});break;case yr.valid:this.prevalidationValidTotal.inc({topic:s});break;default:this.prevalidationUnknownTotal.inc({topic:s});break}},onMsgRecvInvalid(n,i){let s=this.toTopic(n),o=i.reason===Sr.Error?i.error:i.reason;this.msgReceivedInvalid.inc({error:o},1),this.msgReceivedInvalidByTopic.inc({topic:s},1)},onDuplicateMsgDelivery(n,i,s){if(this.duplicateMsgDeliveryDelay.observe(i/1e3),s){let o=this.toTopic(n);this.duplicateMsgLateDelivery.inc({topic:o},1)}},onPublishDuplicateMsg(n){let i=this.toTopic(n);this.duplicateMsgIgnored.inc({topic:i},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(n,i){this.rpcRecvBytes.inc(i),this.rpcRecvCount.inc(1),n.subscriptions&&this.rpcRecvSubscription.inc(n.subscriptions.length),n.messages&&this.rpcRecvMessage.inc(n.messages.length),n.control&&(this.rpcRecvControl.inc(1),n.control.ihave&&this.rpcRecvIHave.inc(n.control.ihave.length),n.control.iwant&&this.rpcRecvIWant.inc(n.control.iwant.length),n.control.graft&&this.rpcRecvGraft.inc(n.control.graft.length),n.control.prune&&this.rpcRecvPrune.inc(n.control.prune.length))},onRpcSent(n,i){if(this.rpcSentBytes.inc(i),this.rpcSentCount.inc(1),n.subscriptions&&this.rpcSentSubscription.inc(n.subscriptions.length),n.messages&&this.rpcSentMessage.inc(n.messages.length),n.control){let s=n.control.ihave?.length??0,o=n.control.iwant?.length??0,a=n.control.graft?.length??0,c=n.control.prune?.length??0;s>0&&this.rpcSentIHave.inc(s),o>0&&this.rpcSentIWant.inc(o),a>0&&this.rpcSentGraft.inc(a),c>0&&this.rpcSentPrune.inc(c),(s>0||o>0||a>0||c>0)&&this.rpcSentControl.inc(1)}},registerScores(n,i){let s=0,o=0,a=0,c=0;for(let l of n)l>=i.graylistThreshold&&s++,l>=i.publishThreshold&&o++,l>=i.gossipThreshold&&a++,l>=0&&c++;this.peersByScoreThreshold.set({threshold:uc.graylist},s),this.peersByScoreThreshold.set({threshold:uc.publish},o),this.peersByScoreThreshold.set({threshold:uc.gossip},a),this.peersByScoreThreshold.set({threshold:uc.mesh},c),this.score.set(n)},registerScoreWeights(n){for(let[i,s]of n.byTopic)this.scoreWeights.set({topic:i,p:"p1"},s.p1w),this.scoreWeights.set({topic:i,p:"p2"},s.p2w),this.scoreWeights.set({topic:i,p:"p3"},s.p3w),this.scoreWeights.set({topic:i,p:"p3b"},s.p3bw),this.scoreWeights.set({topic:i,p:"p4"},s.p4w);this.scoreWeights.set({p:"p5"},n.p5w),this.scoreWeights.set({p:"p6"},n.p6w),this.scoreWeights.set({p:"p7"},n.p7w)},registerScorePerMesh(n,i){let s=new Map;n.forEach((o,a)=>{let c=this.topicStrToLabel.get(a)??"unknown",l=s.get(c);l||(l=new Set,s.set(c,l)),o.forEach(u=>l?.add(u))});for(let[o,a]of s){let c=[];a.forEach(l=>{c.push(i.get(l)??0)}),this.scorePerMesh.set({topic:o},c)}}}}var Cv=Y("libp2p-pubsub:");async function Pv(r,e,t,n){switch(r.type){case Fs.Signing:{let i={from:r.author.toBytes(),data:n,seqno:Or(8),topic:e,signature:void 0,key:void 0},s=ve([Cv,cu.Message.encode(i).finish()]);i.signature=await r.privateKey.sign(s),i.key=r.key;let o={type:"signed",from:r.author,data:t,sequenceNumber:BigInt(`0x${H(i.seqno,"base16")}`),topic:e,signature:i.signature,key:i.key};return{raw:i,msg:o}}case Fs.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:e,signature:void 0,key:void 0},msg:{type:"unsigned",data:t,topic:e}}}}async function kv(r,e){switch(r){case ac:return e.signature!=null?{valid:!1,error:gr.SignaturePresent}:e.seqno!=null?{valid:!1,error:gr.SeqnoPresent}:e.key!=null?{valid:!1,error:gr.FromPresent}:{valid:!0,message:{type:"unsigned",topic:e.topic,data:e.data??new Uint8Array(0)}};case Wo:{if(e.seqno==null)return{valid:!1,error:gr.InvalidSeqno};if(e.seqno.length!==8)return{valid:!1,error:gr.InvalidSeqno};if(e.signature==null)return{valid:!1,error:gr.InvalidSignature};if(e.from==null)return{valid:!1,error:gr.InvalidPeerId};let t;try{t=it(e.from)}catch{return{valid:!1,error:gr.InvalidPeerId}}let n;if(e.key){if(n=Lr(e.key),t.publicKey!==void 0&&!ce(n.bytes,t.publicKey))return{valid:!1,error:gr.InvalidPeerId}}else{if(t.publicKey==null)return{valid:!1,error:gr.InvalidPeerId};n=Lr(t.publicKey)}let i={from:e.from,data:e.data,seqno:e.seqno,topic:e.topic,signature:void 0,key:void 0},s=ve([Cv,cu.Message.encode(i).finish()]);return await n.verify(s,e.signature)?{valid:!0,message:{type:"signed",from:t,data:e.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${H(e.seqno,"base16")}`),topic:e.topic,signature:e.signature,key:e.key??Ul(n)}}:{valid:!1,error:gr.InvalidSignature}}}}var Nv=(r,e)=>{let t=Y(e.toString(16).padStart(16,"0"),"base16"),n=new Uint8Array(r.length+t.length);return n.set(r,0),n.set(t,r.length),n};function Ov(r){if(r.type!=="signed")throw new Error("expected signed message type");if(r.sequenceNumber==null)throw Error("missing seqno field");return Nv(r.from.toBytes(),r.sequenceNumber)}async function Lv(r){return await Oe.encode(r.data)}function iF(r,e,t,n,i){let s=0,o=new Map;if(Object.entries(e.topics).forEach(([h,d])=>{let p=i.get(h)??"unknown",m=t.topics[h];if(m===void 0)return;let g=o.get(p);g||(g={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(p,g));let y=0,w=0,E=0,R=0,x=0;if(d.inMesh){let k=Math.max(d.meshTime/m.timeInMeshQuantum,m.timeInMeshCap);y+=k*m.timeInMeshWeight}let v=d.firstMessageDeliveries;if(v>m.firstMessageDeliveriesCap&&(v=m.firstMessageDeliveriesCap),w+=v*m.firstMessageDeliveriesWeight,d.meshMessageDeliveriesActive&&d.meshMessageDeliveries<m.meshMessageDeliveriesThreshold){let k=m.meshMessageDeliveriesThreshold-d.meshMessageDeliveries,B=k*k;E+=B*m.meshMessageDeliveriesWeight}let I=d.meshFailurePenalty;R+=I*m.meshFailurePenaltyWeight;let _=d.invalidMessageDeliveries*d.invalidMessageDeliveries;x+=_*m.invalidMessageDeliveriesWeight,s+=(y+w+E+R+x)*m.topicWeight,g.p1w+=y,g.p2w+=w,g.p3w+=E,g.p3bw+=R,g.p4w+=x}),t.topicScoreCap>0&&s>t.topicScoreCap){s=t.topicScoreCap;let h=t.topicScoreCap/s;for(let d of o.values())d.p1w*=h,d.p2w*=h,d.p3w*=h,d.p3bw*=h,d.p4w*=h}let a=0,c=0,l=0,u=t.appSpecificScore(r);a+=u*t.appSpecificWeight,e.knownIPs.forEach(h=>{if(t.IPColocationFactorWhitelist.has(h))return;let d=n.get(h),p=d?d.size:0;if(p>t.IPColocationFactorThreshold){let m=p-t.IPColocationFactorThreshold,g=m*m;c+=g*t.IPColocationFactorWeight}});let f=e.behaviourPenalty*e.behaviourPenalty;return l+=f*t.behaviourPenaltyWeight,s+=a+c+l,{byTopic:o,p5w:a,p6w:c,p7w:l,score:s}}function Bv(r,e,t,n,i){let s={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(let o of r){let a=e.get(o);if(a){let c=iF(o,a,t,n,i);for(let[l,u]of c.byTopic){let f=s.byTopic.get(l);f||(f={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},s.byTopic.set(l,f)),f.p1w.push(u.p1w),f.p2w.push(u.p2w),f.p3w.push(u.p3w),f.p3bw.push(u.p3bw),f.p4w.push(u.p4w)}s.p5w.push(c.p5w),s.p6w.push(c.p6w),s.p7w.push(c.p7w),s.score.push(c.score)}else s.p5w.push(0),s.p6w.push(0),s.p7w.push(0),s.score.push(0)}return s}var Nh=class{rawStream;pushable;closeController;maxBufferSize;constructor(e,t,n){this.rawStream=e,this.pushable=Et({objectMode:!1}),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,Te(Zt(this.pushable,this.closeController.signal,{returnOnAbort:!0}),i=>Rt(i),this.rawStream).catch(t)}get protocol(){return this.rawStream.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}close(){this.closeController.abort(),this.pushable.return(),this.rawStream.close()}},Oh=class{source;rawStream;closeController;constructor(e,t={}){this.rawStream=e,this.closeController=new AbortController,this.source=Zt(Te(this.rawStream,n=>vt(n,t)),this.closeController.signal,{returnOnAbort:!0})}close(){this.closeController.abort(),this.rawStream.close()}};var Mv=de(P3(),1),Uv={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};function Fv(r,e){e={...e};let t=Mv.default.Reader.create(r),n=r.length,i=n===void 0?t.len:t.pos+n,s={};for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.subscriptions&&s.subscriptions.length||(s.subscriptions=[]),s.subscriptions.length<e.maxSubscriptions?s.subscriptions.push(sF(t,t.uint32())):t.skipType(o&7);break;case 2:s.messages&&s.messages.length||(s.messages=[]),s.messages.length<e.maxMessages?s.messages.push(oF(t,t.uint32())):t.skipType(o&7);break;case 3:s.control=aF(t,t.uint32(),e);break;default:t.skipType(o&7);break}}return s}function sF(r,e){let t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){let i=r.uint32();switch(i>>>3){case 1:n.subscribe=r.bool();break;case 2:n.topic=r.string();break;default:r.skipType(i&7);break}}return n}function oF(r,e){let t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){let i=r.uint32();switch(i>>>3){case 1:n.from=r.bytes();break;case 2:n.data=r.bytes();break;case 3:n.seqno=r.bytes();break;case 4:n.topic=r.string();break;case 5:n.signature=r.bytes();break;case 6:n.key=r.bytes();break;default:r.skipType(i&7);break}}if(!n.topic)throw Error("missing required 'topic'");return n}function aF(r,e,t){let n=e===void 0?r.len:r.pos+e,i={};for(;r.pos<n;){let s=r.uint32();switch(s>>>3){case 1:i.ihave&&i.ihave.length||(i.ihave=[]),i.ihave.length<t.maxControlMessages?i.ihave.push(cF(r,r.uint32(),t)):r.skipType(s&7);break;case 2:i.iwant&&i.iwant.length||(i.iwant=[]),i.iwant.length<t.maxControlMessages?i.iwant.push(lF(r,r.uint32(),t)):r.skipType(s&7);break;case 3:i.graft&&i.graft.length||(i.graft=[]),i.graft.length<t.maxControlMessages?i.graft.push(uF(r,r.uint32())):r.skipType(s&7);break;case 4:i.prune&&i.prune.length||(i.prune=[]),i.prune.length<t.maxControlMessages?i.prune.push(fF(r,r.uint32(),t)):r.skipType(s&7);break;default:r.skipType(s&7);break}}return i}function cF(r,e,t){let n=e===void 0?r.len:r.pos+e,i={};for(;r.pos<n;){let s=r.uint32();switch(s>>>3){case 1:i.topicID=r.string();break;case 2:i.messageIDs&&i.messageIDs.length||(i.messageIDs=[]),t.maxIhaveMessageIDs-- >0?i.messageIDs.push(r.bytes()):r.skipType(s&7);break;default:r.skipType(s&7);break}}return i}function lF(r,e,t){let n=e===void 0?r.len:r.pos+e,i={};for(;r.pos<n;){let s=r.uint32();switch(s>>>3){case 1:i.messageIDs&&i.messageIDs.length||(i.messageIDs=[]),t.maxIwantMessageIDs-- >0?i.messageIDs.push(r.bytes()):r.skipType(s&7);break;default:r.skipType(s&7);break}}return i}function uF(r,e){let t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){let i=r.uint32();switch(i>>>3){case 1:n.topicID=r.string();break;default:r.skipType(i&7);break}}return n}function fF(r,e,t){let n=e===void 0?r.len:r.pos+e,i={};for(;r.pos<n;){let s=r.uint32();switch(s>>>3){case 1:i.topicID=r.string();break;case 2:i.peers&&i.peers.length||(i.peers=[]),t.maxPeerInfos-- >0?i.peers.push(hF(r,r.uint32())):r.skipType(s&7);break;case 3:i.backoff=r.uint64();break;default:r.skipType(s&7);break}}return i}function hF(r,e){let t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){let i=r.uint32();switch(i>>>3){case 1:n.peerID=r.bytes();break;case 2:n.signedPeerRecord=r.bytes();break;default:r.skipType(i&7);break}}return n}var Lh;(function(r){r[r.ip4=4]="ip4",r[r.ip6=41]="ip6"})(Lh||(Lh={}));function Kv(r){for(let e of r.tuples())switch(e[0]){case Lh.ip4:case Lh.ip6:return ql(e[0],e[1])}return null}var nn;(function(r){r[r.started=0]="started",r[r.stopped=1]="stopped"})(nn||(nn={}));var M3=class extends Fe{globalSignaturePolicy;multicodecs=[O3,N3];publishConfig;dataTransform;peers=new Set;streamsInbound=new Map;streamsOutbound=new Map;outboundInflightQueue=Et({objectMode:!0});direct=new Set;floodsubPeers=new Set;seenCache;acceptFromWhitelist=new Map;topics=new Map;subscriptions=new Set;mesh=new Map;fanout=new Map;fanoutLastpub=new Map;gossip=new Map;control=new Map;peerhave=new Map;iasked=new Map;backoff=new Map;outbound=new Map;msgIdFn;fastMsgIdFn;msgIdToStrFn;fastMsgIdCache;publishedMessageIds;mcache;score;topicValidators=new Map;log;heartbeatTicks=0;gossipTracer;components;directPeerInitial=null;static multicodec=O3;opts;decodeRpcLimits;metrics;status={code:nn.stopped};maxInboundStreams;maxOutboundStreams;allowedTopics;heartbeatTimer=null;constructor(e,t={}){super();let n={fallbackToFloodsub:!0,floodPublish:!0,doPX:!1,directPeers:[],D:6,Dlo:4,Dhi:12,Dscore:4,Dout:2,Dlazy:6,heartbeatInterval:1e3,fanoutTTL:6e4,mcacheLength:5,mcacheGossip:3,seenTTL:12e4,gossipsubIWantFollowupMs:3e3,prunePeers:16,pruneBackoff:6e4,unsubcribeBackoff:1e4,graftFloodThreshold:1e4,opportunisticGraftPeers:2,opportunisticGraftTicks:60,directConnectTicks:300,...t,scoreParams:Ev(t.scoreParams),scoreThresholds:vv(t.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=n.decodeRpcLimits??Uv,this.globalSignaturePolicy=n.globalSignaturePolicy??Wo,n.fallbackToFloodsub&&this.multicodecs.push(k3),this.log=D(n.debugName??"libp2p:gossipsub"),this.opts=n,this.direct=new Set(n.directPeers.map(i=>i.id.toString())),this.seenCache=new lc({validityMs:n.seenTTL}),this.publishedMessageIds=new lc({validityMs:n.seenTTL}),t.msgIdFn)this.msgIdFn=t.msgIdFn;else switch(this.globalSignaturePolicy){case Wo:this.msgIdFn=Ov;break;case ac:this.msgIdFn=Lv;break}if(t.fastMsgIdFn&&(this.fastMsgIdFn=t.fastMsgIdFn,this.fastMsgIdCache=new lc({validityMs:n.seenTTL})),this.msgIdToStrFn=t.msgIdToStrFn??bv,this.mcache=t.messageCache||new _h(n.mcacheGossip,n.mcacheLength,this.msgIdToStrFn),t.dataTransform&&(this.dataTransform=t.dataTransform),t.metricsRegister){if(!t.metricsTopicStrToLabel)throw Error("Must set metricsTopicStrToLabel with metrics");let i=Math.max(...Object.values(n.scoreParams.topics).map(o=>o.meshMessageDeliveriesWindow),1e3),s=Dv(t.metricsRegister,t.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:n.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:i/1e3});s.mcacheSize.addCollect(()=>this.onScrapeMetrics(s));for(let o of this.multicodecs)s.protocolsEnabled.set({protocol:o},1);this.metrics=s}else this.metrics=null;this.gossipTracer=new kh(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new Ph(this.opts.scoreParams,this.metrics,{scoreCacheValidityMs:n.heartbeatInterval}),this.maxInboundStreams=t.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams,this.allowedTopics=n.allowedTopics?new Set(n.allowedTopics):null}getPeers(){return[...this.peers.keys()].map(e=>ae(e))}isStarted(){return this.status.code===nn.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=await B3(this.globalSignaturePolicy,this.components.peerId),this.outboundInflightQueue=Et({objectMode:!0}),Te(this.outboundInflightQueue,async s=>{for await(let{peerId:o,connection:a}of s)await this.createOutboundStream(o,a)}).catch(s=>this.log.error("outbound inflight queue error",s)),await Promise.all(this.opts.directPeers.map(async s=>{await this.components.peerStore.merge(s.id,{multiaddrs:s.addrs})}));let e=this.components.registrar;await Promise.all(this.multicodecs.map(s=>e.handle(s,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams})));let t={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this)},n=await Promise.all(this.multicodecs.map(s=>e.register(s,t))),i=setTimeout(this.runHeartbeat,100);this.status={code:nn.started,registrarTopologyIds:n,heartbeatTimeout:i,hearbeatStartMs:Date.now()+100},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async s=>await this.connect(s)))}).catch(s=>{this.log(s)})},1e3),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==nn.started)return;let{registrarTopologyIds:e}=this.status;this.status={code:nn.stopped};let t=this.components.registrar;await Promise.all(this.multicodecs.map(n=>t.unhandle(n))),e.forEach(n=>t.unregister(n)),this.outboundInflightQueue.end();for(let n of this.streamsOutbound.values())n.close();this.streamsOutbound.clear();for(let n of this.streamsInbound.values())n.close();this.streamsInbound.clear(),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache&&this.fastMsgIdCache.clear(),this.directPeerInitial&&clearTimeout(this.directPeerInitial),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:t}){if(!this.isStarted())return;let n=t.remotePeer;this.addPeer(n,t.direction,t.remoteAddr),this.createInboundStream(n,e),this.outboundInflightQueue.push({peerId:n,connection:t})}onPeerConnected(e,t){this.metrics?.newConnectionCount.inc({status:t.status}),!(!this.isStarted()||t.status!=="open")&&(this.addPeer(e,t.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;let n=e.toString();if(this.peers.has(n)&&!this.streamsOutbound.has(n))try{let i=new Nh(await t.newStream(this.multicodecs),o=>this.log.error("outbound pipe error",o),{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(n,i);let s=i.protocol;s===k3&&this.floodsubPeers.add(n),this.metrics?.peersPerProtocol.inc({protocol:s},1),this.subscriptions.size>0&&(this.log("send subscriptions to",n),this.sendSubscriptions(n,Array.from(this.subscriptions),!0))}catch(i){this.log.error("createOutboundStream error",i)}}async createInboundStream(e,t){if(!this.isStarted())return;let n=e.toString();if(!this.peers.has(n))return;let i=this.streamsInbound.get(n);i!==void 0&&(this.log("replacing existing inbound steam %s",n),i.close()),this.log("create inbound stream %s",n);let s=new Oh(t,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(n,s),this.pipePeerReadStream(e,s.source).catch(o=>this.log(o))}addPeer(e,t,n){let i=e.toString();if(!this.peers.has(i)){this.log("new peer %p",e),this.peers.add(i),this.score.addPeer(i);let s=Kv(n);s!==null?this.score.addIP(i,s):this.log("Added peer has no IP in current address %s %s",i,n.toString()),this.outbound.has(i)||this.outbound.set(i,t==="outbound")}}removePeer(e){let t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);let n=this.streamsOutbound.get(t),i=this.streamsInbound.get(t);n&&this.metrics?.peersPerProtocol.inc({protocol:n.protocol},-1),n?.close(),i?.close(),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(let s of this.topics.values())s.delete(t);for(let[s,o]of this.mesh)o.delete(t)===!0&&this.metrics?.onRemoveFromMesh(s,ei.Dc,1);for(let s of this.fanout.values())s.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===nn.started}getMeshPeers(e){let t=this.mesh.get(e);return t?Array.from(t):[]}getSubscribers(e){let t=this.topics.get(e);return(t?Array.from(t):[]).map(n=>ae(n))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await Te(t,async n=>{for await(let i of n)try{let s=i.subarray(),o=Fv(s,this.decodeRpcLimits);if(this.metrics?.onRpcRecv(o,s.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,o)}catch(a){this.metrics?.onRpcRecvError(),this.log(a)}else this.handleReceivedRpc(e,o).catch(a=>{this.metrics?.onRpcRecvError(),this.log(a)})}catch(s){this.metrics?.onRpcDataError(),this.log(s)}})}catch(n){this.metrics?.onPeerReadStreamError(),this.handlePeerReadStreamError(n,e)}}handlePeerReadStreamError(e,t){this.log.error(e),this.onPeerDisconnected(t)}async handleReceivedRpc(e,t){if(!this.acceptFrom(e.toString())){this.log("received message from unacceptable peer %p",e),this.metrics?.rpcRecvNotAccepted.inc();return}let n=t.subscriptions?t.subscriptions.length:0,i=t.messages?t.messages.length:0,s=0,o=0,a=0,c=0;if(t.control&&(t.control.ihave&&(s=t.control.ihave.length),t.control.iwant&&(o=t.control.iwant.length),t.control.graft&&(a=t.control.graft.length),t.control.prune&&(c=t.control.prune.length)),this.log(`rpc.from ${e.toString()} subscriptions ${n} messages ${i} ihave ${s} iwant ${o} graft ${a} prune ${c}`),t.subscriptions&&t.subscriptions.length>0){let l=[];t.subscriptions.forEach(u=>{let f=u.topic,h=u.subscribe===!0;if(f!=null){if(this.allowedTopics&&!this.allowedTopics.has(f))return;this.handleReceivedSubscription(e,f,h),l.push({topic:f,subscribe:h})}}),this.dispatchEvent(new Ge("subscription-change",{detail:{peerId:e,subscriptions:l}}))}if(t.messages)for(let l of t.messages){if(this.allowedTopics&&!this.allowedTopics.has(l.topic))continue;let u=this.handleReceivedMessage(e,l).catch(f=>{this.metrics?.onMsgRecvError(l.topic),this.log(f)});this.opts.awaitRpcMessageHandler&&await u}t.control&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t,n){this.log("subscription update from %p topic %s",e,t);let i=this.topics.get(t);i==null&&(i=new Set,this.topics.set(t,i)),n?i.add(e.toString()):i.delete(e.toString())}async handleReceivedMessage(e,t){this.metrics?.onMsgRecvPreValidation(t.topic);let n=await this.validateReceivedMessage(e,t);switch(this.metrics?.onPrevalidationResult(t.topic,n.code),n.code){case yr.duplicate:this.score.duplicateMessage(e.toString(),n.msgIdStr,t.topic),this.gossipTracer.deliverMessage(n.msgIdStr,!0),this.mcache.observeDuplicate(n.msgIdStr,e.toString());return;case yr.invalid:if(n.msgIdStr){let i=n.msgIdStr;this.score.rejectMessage(e.toString(),i,t.topic,n.reason),this.gossipTracer.rejectMessage(i,n.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);this.metrics?.onMsgRecvInvalid(t.topic,n);return;case yr.valid:this.score.validateMessage(n.messageId.msgIdStr),this.gossipTracer.deliverMessage(n.messageId.msgIdStr),this.mcache.put(n.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)&&(!this.components.peerId.equals(e)||this.opts.emitSelf)&&(super.dispatchEvent(new Ge("gossipsub:message",{detail:{propagationSource:e,msgId:n.messageId.msgIdStr,msg:n.msg}})),super.dispatchEvent(new Ge("message",{detail:n.msg}))),this.opts.asyncValidation||this.forwardMessage(n.messageId.msgIdStr,t,e.toString())}}async validateReceivedMessage(e,t){let n=this.fastMsgIdFn?.(t),i=n!==void 0?this.fastMsgIdCache?.get(n):void 0;if(i)return{code:yr.duplicate,msgIdStr:i};let s=await kv(this.globalSignaturePolicy,t);if(!s.valid)return{code:yr.invalid,reason:Sr.Error,error:s.error};let o=s.message;try{this.dataTransform&&(o.data=this.dataTransform.inboundTransform(t.topic,o.data))}catch(f){return this.log("Invalid message, transform failed",f),{code:yr.invalid,reason:Sr.Error,error:gr.TransformFailed}}let a=await this.msgIdFn(o),c=this.msgIdToStrFn(a),l={msgId:a,msgIdStr:c};if(n!==void 0&&this.fastMsgIdCache&&this.fastMsgIdCache.put(n,c)&&this.metrics?.fastMsgIdCacheCollision.inc(),this.seenCache.has(c))return{code:yr.duplicate,msgIdStr:c};this.seenCache.put(c);let u=this.topicValidators.get(t.topic);if(u!=null){let f;try{f=await u(e,o)}catch(h){let d=h.code;d===yv&&(f=_r.Ignore),d===gv?f=_r.Reject:f=_r.Ignore}if(f!==_r.Accept)return{code:yr.invalid,reason:L3(f),msgIdStr:c}}return{code:yr.valid,messageId:l,msg:o}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,n){this.sendRpc(e,{subscriptions:t.map(i=>({topic:i,subscribe:n}))})}async handleControlMessage(e,t){if(t===void 0)return;let n=t.ihave?this.handleIHave(e,t.ihave):[],i=t.iwant?this.handleIWant(e,t.iwant):[],s=t.graft?await this.handleGraft(e,t.graft):[];if(t.prune&&await this.handlePrune(e,t.prune),!n.length&&!i.length&&!s.length)return;let o=this.sendRpc(e,{messages:i,control:{iwant:n,prune:s}}),a=n[0]?.messageIDs;a&&(o?this.gossipTracer.addPromise(e,a):this.metrics?.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;let t=Date.now(),n=this.acceptFromWhitelist.get(e);if(n&&n.messagesAccepted<128&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;let i=this.score.score(e);return i>=0?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+1e3}):this.acceptFromWhitelist.delete(e),i>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){if(!t.length)return[];let n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,n),this.metrics?.ihaveRcvIgnored.inc({reason:hc.LowScore}),[];let i=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,i),i>10)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,i),this.metrics?.ihaveRcvIgnored.inc({reason:hc.MaxIhave}),[];let s=this.iasked.get(e)??0;if(s>=5e3)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:hc.MaxIasked}),[];let o=new Map;if(t.forEach(({topicID:l,messageIDs:u})=>{if(!l||!u||!this.mesh.has(l))return;let f=0;u.forEach(h=>{let d=this.msgIdToStrFn(h);this.seenCache.has(d)||(o.set(d,h),f++)}),this.metrics?.onIhaveRcv(l,u.length,f)}),!o.size)return[];let a=o.size;a+s>5e3&&(a=5e3-s),this.log("IHAVE: Asking for %d out of %d messages from %s",a,o.size,e);let c=Array.from(o.values());return vi(c),c=c.slice(0,a),this.iasked.set(e,s+a),[{messageIDs:c}]}handleIWant(e,t){if(!t.length)return[];let n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,n),[];let i=new Map,s=new Map,o=0;return t.forEach(({messageIDs:a})=>{a&&a.forEach(c=>{let l=this.msgIdToStrFn(c),u=this.mcache.getWithIWantCount(l,e);if(u==null){o++;return}if(s.set(u.msg.topic,1+(s.get(u.msg.topic)??0)),u.count>3){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,c);return}i.set(l,u.msg)})}),this.metrics?.onIwantRcv(s,o),i.size?(this.log("IWANT: Sending %d messages to %s",i.size,e),Array.from(i.values())):(this.log("IWANT: Could not provide any wanted messages to %s",e),[])}async handleGraft(e,t){let n=[],i=this.score.score(e),s=Date.now(),o=this.opts.doPX;if(t.forEach(({topicID:c})=>{if(!c)return;let l=this.mesh.get(c);if(!l){o=!1;return}if(l.has(e))return;if(this.direct.has(e)){this.log("GRAFT: ignoring request from direct peer %s",e),n.push(c),o=!1;return}let u=this.backoff.get(c)?.get(e);if(typeof u=="number"&&s<u){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,fc.GraftBackoff),o=!1;let f=u+this.opts.graftFloodThreshold-this.opts.pruneBackoff;s<f&&this.score.addPenalty(e,1,fc.GraftBackoff),this.addBackoff(e,c),n.push(c);return}if(i<0){this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,i,c),n.push(c),o=!1,this.addBackoff(e,c);return}if(l.size>=this.opts.Dhi&&!this.outbound.get(e)){n.push(c),this.addBackoff(e,c);return}this.log("GRAFT: Add mesh link from %s in %s",e,c),this.score.graft(e,c),l.add(e),this.metrics?.onAddToMesh(c,Ir.Subscribed,1)}),!n.length)return[];let a=!1;return await Promise.all(n.map(c=>this.makePrune(e,c,o,a)))}async handlePrune(e,t){let n=this.score.score(e);for(let{topicID:i,backoff:s,peers:o}of t){if(i==null)continue;let a=this.mesh.get(i);if(!a)return;if(this.log("PRUNE: Remove mesh link to %s in %s",e,i),this.score.prune(e,i),a.has(e)&&(a.delete(e),this.metrics?.onRemoveFromMesh(i,ei.Prune,1)),typeof s=="number"&&s>0?this.doAddBackoff(e,i,s*1e3):this.addBackoff(e,i),o&&o.length){if(n<this.opts.scoreThresholds.acceptPXThreshold){this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,n,i);continue}await this.pxConnect(o)}}}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,n){let i=this.backoff.get(t);i||(i=new Map,this.backoff.set(t,i));let s=Date.now()+n;(i.get(e)??0)<s&&i.set(e,s)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,fc.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%15!==0)return;let e=Date.now();this.backoff.forEach((t,n)=>{t.forEach((i,s)=>{i+1*this.opts.heartbeatInterval<e&&t.delete(s)}),t.size===0&&this.backoff.delete(n)})}async directConnect(){let e=[];this.direct.forEach(t=>{this.streamsOutbound.has(t)||e.push(t)}),await Promise.all(e.map(async t=>await this.connect(t)))}async pxConnect(e){e.length>this.opts.prunePeers&&(vi(e),e=e.slice(0,this.opts.prunePeers));let t=[];await Promise.all(e.map(async n=>{if(!n.peerID)return;let i=it(n.peerID),s=i.toString();if(!this.peers.has(s)){if(!n.signedPeerRecord){t.push(s);return}try{if(!await this.components.peerStore.consumePeerRecord(n.signedPeerRecord,i)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}t.push(s)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),t.length&&await Promise.all(t.map(async n=>await this.connect(n)))}async connect(e){this.log("Initiating connection with %s",e);let t=ae(e),n=await this.components.connectionManager.openConnection(t);for(let i of this.multicodecs)for(let s of this.components.registrar.getTopologies(i))s.onConnect?.(t,n)}subscribe(e){if(this.status.code!==nn.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(let t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==nn.started)throw new Error("Pubsub is not started");let t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(let n of this.peers.keys())this.sendSubscriptions(n,[e],!1);this.leave(e)}join(e){if(this.status.code!==nn.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);let t=new Set,n=this.backoff.get(e),i=this.fanout.get(e);if(i&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),i.forEach(s=>{!this.direct.has(s)&&this.score.score(s)>=0&&(!n||!n.has(s))&&t.add(s)}),this.metrics?.onAddToMesh(e,Ir.Fanout,t.size)),t.size<this.opts.D){let s=t.size;this.getRandomGossipPeers(e,this.opts.D,a=>!t.has(a)&&!this.direct.has(a)&&this.score.score(a)>=0&&(!n||!n.has(a))).forEach(a=>{t.add(a)}),this.metrics?.onAddToMesh(e,Ir.Random,t.size-s)}this.mesh.set(e,t),t.forEach(s=>{this.log("JOIN: Add mesh link to %s in %s",s,e),this.sendGraft(s,e)})}leave(e){if(this.status.code!==nn.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);let t=this.mesh.get(e);t&&(Promise.all(Array.from(t).map(async n=>(this.log("LEAVE: Remove mesh link to %s in %s",n,e),await this.sendPrune(n,e)))).catch(n=>{this.log("Error sending prunes to mesh peers",n)}),this.mesh.delete(e))}selectPeersToForward(e,t,n){let i=new Set,s=this.topics.get(e);s&&(this.direct.forEach(a=>{s.has(a)&&t!==a&&!n?.has(a)&&i.add(a)}),this.floodsubPeers.forEach(a=>{s.has(a)&&t!==a&&!n?.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&i.add(a)}));let o=this.mesh.get(e);return o&&o.size>0&&o.forEach(a=>{t!==a&&!n?.has(a)&&i.add(a)}),i}selectPeersToPublish(e){let t=new Set,n={direct:0,floodsub:0,mesh:0,fanout:0},i=this.topics.get(e);if(i)if(this.opts.floodPublish)i.forEach(s=>{this.direct.has(s)?(t.add(s),n.direct++):this.score.score(s)>=this.opts.scoreThresholds.publishThreshold&&(t.add(s),n.floodsub++)});else{this.direct.forEach(o=>{i.has(o)&&(t.add(o),n.direct++)}),this.floodsubPeers.forEach(o=>{i.has(o)&&this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(t.add(o),n.floodsub++)});let s=this.mesh.get(e);if(s&&s.size>0)s.forEach(o=>{t.add(o),n.mesh++});else{let o=this.fanout.get(e);if(o&&o.size>0)o.forEach(a=>{t.add(a),n.fanout++});else{let a=this.getRandomGossipPeers(e,this.opts.D,c=>this.score.score(c)>=this.opts.scoreThresholds.publishThreshold);a.size>0&&(this.fanout.set(e,a),a.forEach(c=>{t.add(c),n.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:n}}forwardMessage(e,t,n,i){n&&this.score.deliverMessage(n,e,t.topic);let s=this.selectPeersToForward(t.topic,n,i);s.forEach(o=>{this.sendRpc(o,{messages:[t]})}),this.metrics?.onForwardMsg(t.topic,s.size)}async publish(e,t,n){let i=Date.now(),s=this.dataTransform?this.dataTransform.outboundTransform(e,t):t;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");let{raw:o,msg:a}=await Pv(this.publishConfig,e,t,s),c=await this.msgIdFn(a),l=this.msgIdToStrFn(c),u=n?.ignoreDuplicatePublishError??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(l)){if(u)return this.metrics?.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}let{tosend:f,tosendCount:h}=this.selectPeersToPublish(e),d=this.opts.emitSelf===!0&&this.subscriptions.has(e),p=n?.allowPublishToZeroPeers??this.opts.allowPublishToZeroPeers;if(f.size===0&&!p&&!d)throw Error("PublishError.InsufficientPeers");this.seenCache.put(l),this.mcache.put({msgId:c,msgIdStr:l},o,!0),this.publishedMessageIds.put(l);for(let g of f)this.sendRpc(g,{messages:[o]})||f.delete(g);let m=Date.now()-i;return this.metrics?.onPublishMsg(e,h,f.size,o.data!=null?o.data.length:0,m),d&&(f.add(this.components.peerId.toString()),super.dispatchEvent(new Ge("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:l,msg:a}})),super.dispatchEvent(new Ge("message",{detail:a}))),{recipients:Array.from(f.values()).map(g=>ae(g))}}reportMessageValidationResult(e,t,n){let i;if(n===_r.Accept){if(i=this.mcache.validate(e),i!=null){let{message:o,originatingPeers:a}=i;this.score.deliverMessage(t,e,o.topic),this.forwardMessage(e,i.message,t,a)}}else if(i=this.mcache.remove(e),i){let o=L3(n),{message:a,originatingPeers:c}=i;this.score.rejectMessage(t,e,a.topic,o);for(let l of c)this.score.rejectMessage(l,e,a.topic,o)}let s=this.score.messageFirstSeenTimestampMs(e);this.metrics?.onReportValidation(i,n,s)}sendGraft(e,t){let n=[{topicID:t}];this.sendRpc(e,{control:{graft:n}})}async sendPrune(e,t){let i=[await this.makePrune(e,t,this.opts.doPX,!0)];this.sendRpc(e,{control:{prune:i}})}sendRpc(e,t){let n=this.streamsOutbound.get(e);if(!n)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;let i=this.control.get(e);i&&(this.piggybackControl(e,t,i),this.control.delete(e));let s=this.gossip.get(e);s&&(this.piggybackGossip(e,t,s),this.gossip.delete(e));let o=cu.encode(t).finish();try{n.push(o)}catch(a){return this.log.error(`Cannot send rpc to ${e}`,a),i&&this.control.set(e,i),s&&this.gossip.set(e,s),!1}return this.metrics?.onRpcSent(t,o.length),!0}piggybackControl(e,t,n){if(n.graft){t.control||(t.control={}),t.control.graft||(t.control.graft=[]);for(let i of n.graft)i.topicID&&this.mesh.get(i.topicID)?.has(e)&&t.control.graft.push(i)}if(n.prune){t.control||(t.control={}),t.control.prune||(t.control.prune=[]);for(let i of n.prune)i.topicID&&!this.mesh.get(i.topicID)?.has(e)&&t.control.prune.push(i)}}piggybackGossip(e,t,n){t.control||(t.control={}),t.control.ihave=n}async sendGraftPrune(e,t,n){let i=this.opts.doPX,s=!1;for(let[o,a]of e){let c=a.map(f=>({topicID:f})),l=[],u=t.get(o);u&&(l=await Promise.all(u.map(async f=>await this.makePrune(o,f,i&&!(n.get(o)??!1),s))),t.delete(o)),this.sendRpc(o,{control:{graft:c,prune:l}})}for(let[o,a]of t){let c=await Promise.all(a.map(async l=>await this.makePrune(o,l,i&&!(n.get(o)??!1),s)));this.sendRpc(o,{control:{prune:c}})}}emitGossip(e){let t=this.mcache.getGossipIDs(new Set(e.keys()));for(let[n,i]of e)this.doEmitGossip(n,i,t.get(n)??[])}doEmitGossip(e,t,n){if(!n.length||(vi(n),n.length>5e3&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",n.length),!t.size))return;let i=this.opts.Dlazy,s=.25*t.size,o=t;s>i&&(i=s),i>o.size?i=o.size:o=vi(Array.from(o)).slice(0,i),o.forEach(a=>{let c=n;n.length>5e3&&(c=vi(c.slice()).slice(0,5e3)),this.pushGossip(a,{topicID:e,messageIDs:c})})}flush(){for(let[e,t]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,{control:{ihave:t}});for(let[e,t]of this.control.entries())this.control.delete(e),this.sendRpc(e,{control:{graft:t.graft,prune:t.prune}})}pushGossip(e,t){this.log("Add gossip to %s",e);let n=this.gossip.get(e)||[];this.gossip.set(e,n.concat(t))}async makePrune(e,t,n,i){if(this.score.prune(e,t),this.streamsOutbound.get(e).protocol===N3)return{topicID:t,peers:[]};let s=i?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,o=s/1e3;if(this.doAddBackoff(e,t,s),!n)return{topicID:t,peers:[],backoff:o};let a=this.getRandomGossipPeers(t,this.opts.prunePeers,l=>l!==e&&this.score.score(l)>=0),c=await Promise.all(Array.from(a).map(async l=>{let u=ae(l),f;try{f=await this.components.peerStore.get(u)}catch(h){if(h.code!=="ERR_NOT_FOUND")throw h}return{peerID:u.toBytes(),signedPeerRecord:f?.peerRecordEnvelope}}));return{topicID:t,peers:c,backoff:o}}runHeartbeat=()=>{let e=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(t=>{this.log("Error running heartbeat",t)}).finally(()=>{if(e?.(),this.status.code===nn.started){clearTimeout(this.status.heartbeatTimeout);let t=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;t<this.opts.heartbeatInterval*.25&&(t+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,t)}})};async heartbeat(){let{D:e,Dlo:t,Dhi:n,Dscore:i,Dout:s,fanoutTTL:o}=this.opts;this.heartbeatTicks++;let a=new Map,c=p=>{let m=a.get(p);return m===void 0&&(m=this.score.score(p),a.set(p,m)),m},l=new Map,u=new Map,f=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();let h=new Map;this.mesh.forEach((p,m)=>{let g=this.topics.get(m),y=new Set,w=new Set;if(h.set(m,w),g){let x=vi(Array.from(g)),v=this.backoff.get(m);for(let I of x){let _=this.streamsOutbound.get(I);if(_&&this.multicodecs.includes(_.protocol)&&!p.has(I)&&!this.direct.has(I)){let k=c(I);(!v||!v.has(I))&&k>=0&&y.add(I),k>=this.opts.scoreThresholds.gossipThreshold&&w.add(I)}}}let E=(x,v)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",x,m),this.addBackoff(x,m),p.delete(x),c(x)>=this.opts.scoreThresholds.gossipThreshold&&w.add(x),this.metrics?.onRemoveFromMesh(m,v,1);let I=u.get(x);I?I.push(m):u.set(x,[m])},R=(x,v)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",x,m),this.score.graft(x,m),p.add(x),w.delete(x),this.metrics?.onAddToMesh(m,v,1);let I=l.get(x);I?I.push(m):l.set(x,[m])};if(p.forEach(x=>{let v=c(x);v<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",x,v,m),E(x,ei.BadScore),f.set(x,!0))}),p.size<t){let x=e-p.size;Av(y,x).forEach(I=>{R(I,Ir.NotEnough)})}if(p.size>n){let x=Array.from(p);x.sort((I,_)=>c(_)-c(I)),x=x.slice(0,i).concat(vi(x.slice(i)));let v=0;if(x.slice(0,e).forEach(I=>{this.outbound.get(I)&&v++}),v<s){let I=k=>{let B=x[k];for(let L=k;L>0;L--)x[L]=x[L-1];x[0]=B};if(v>0){let k=v;for(let B=1;B<e&&k>0;B++)this.outbound.get(x[B])&&(I(B),k--)}let _=e-v;for(let k=e;k<x.length&&_>0;k++)this.outbound.get(x[k])&&(I(k),_--)}x.slice(e).forEach(I=>{E(I,ei.Excess)})}if(p.size>=t){let x=0;if(p.forEach(v=>{this.outbound.get(v)&&x++}),x<s){let v=s-x;Ch(y,v,_=>this.outbound.get(_)===!0).forEach(_=>{R(_,Ir.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&p.size>1){let x=Array.from(p).sort((_,k)=>c(_)-c(k)),v=Math.floor(p.size/2),I=c(x[v]);if(I<this.opts.scoreThresholds.opportunisticGraftThreshold){let _=this.opts.opportunisticGraftPeers,k=Ch(y,_,B=>c(B)>I);for(let B of k)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",B,m),R(B,Ir.Opportunistic)}}});let d=Date.now();this.fanoutLastpub.forEach((p,m)=>{p+o<d&&(this.fanout.delete(m),this.fanoutLastpub.delete(m))}),this.fanout.forEach((p,m)=>{let g=this.topics.get(m);p.forEach(R=>{(!g.has(R)||c(R)<this.opts.scoreThresholds.publishThreshold)&&p.delete(R)});let y=this.topics.get(m),w=[],E=new Set;if(h.set(m,E),y){let R=vi(Array.from(y));for(let x of R){let v=this.streamsOutbound.get(x);if(v&&this.multicodecs.includes(v.protocol)&&!p.has(x)&&!this.direct.has(x)){let I=c(x);I>=this.opts.scoreThresholds.publishThreshold&&w.push(x),I>=this.opts.scoreThresholds.gossipThreshold&&E.add(x)}}}if(p.size<e){let R=e-p.size;w.slice(0,R).forEach(x=>{p.add(x),E?.delete(x)})}}),this.emitGossip(h),await this.sendGraftPrune(l,u,f),this.flush(),this.mcache.shift(),this.dispatchEvent(new Ge("gossipsub:heartbeat"))}getRandomGossipPeers(e,t,n=()=>!0){let i=this.topics.get(e);if(!i)return new Set;let s=[];return i.forEach(o=>{let a=this.streamsOutbound.get(o);a&&this.multicodecs.includes(a.protocol)&&n(o)&&s.push(o)}),s=vi(s),t>0&&s.length>t&&(s=s.slice(0,t)),new Set(s)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let t=0,n=Date.now();e.connectedPeersBackoffSec.reset();for(let a of this.backoff.values()){t+=a.size;for(let[c,l]of a.entries())this.peers.has(c)&&e.connectedPeersBackoffSec.observe(Math.max(0,l-n)/1e3)}e.cacheSize.set({cache:"backoff"},t);for(let[a,c]of this.topics)e.topicPeersCount.set({topicStr:a},c.size);for(let[a,c]of this.mesh)e.meshPeerCounts.set({topicStr:a},c.size);let i=[],s=new Map;e.behaviourPenalty.reset();for(let a of this.peers.keys()){let c=this.score.score(a);i.push(c),s.set(a,c),e.behaviourPenalty.observe(this.score.peerStats.get(a)?.behaviourPenalty??0)}e.registerScores(i,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,s);let o=Bv(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(o)}};function qv(r={}){return e=>new M3(e,r)}var Bh=class extends Error{code;constructor(e,t){super(e),this.code=t}},U3=class extends Bh{type;constructor(e){super(e,"ABORT_ERR"),this.type="aborted"}};function zv(r){let e=Et();r.sink(e).catch(s=>{e.end(s)}),r.sink=async s=>{for await(let o of s)e.push(o);e.end()};let t=r.source;r.source[Symbol.iterator]!=null?t=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(t=r.source[Symbol.asyncIterator]());let n=new _e;return{read:async(s,o)=>{o?.signal?.throwIfAborted();let a,c=new Promise((l,u)=>{a=()=>{u(new U3("Read aborted"))},o?.signal?.addEventListener("abort",a)});try{if(s==null){let{done:u,value:f}=await Promise.race([t.next(),c]);return u===!0?new _e:f}for(;n.byteLength<s;){let{value:u,done:f}=await Promise.race([t.next(),c]);if(f===!0)throw new Bh("unexpected end of input","ERR_UNEXPECTED_EOF");n.append(u)}let l=n.sublist(0,s);return n.consume(s),l}finally{a!=null&&o?.signal?.removeEventListener("abort",a)}},write:async(s,o)=>{o?.signal?.throwIfAborted(),s instanceof Uint8Array?e.push(s):e.push(s.subarray()),await e.onEmpty(o)},unwrap:()=>{let s=r.source;return r.source=async function*(){yield*n,yield*s}(),r}}}var Mh=class extends Error{code;constructor(e,t){super(e),this.code=t}},$v=r=>$r(r);$v.bytes=0;function lu(r,e){let t=zv(r);return{read:async i=>{let s=-1,o=new _e,a=e?.lengthDecoder??$v;for(;;){o.append(await t.read(1,i));try{s=a(o)}catch(c){if(c instanceof RangeError)continue;throw c}if(s>-1)break;if(e?.maxLengthLength!=null&&o.byteLength>e.maxLengthLength)throw new Mh("message length length too long","ERR_MSG_LENGTH_TOO_LONG")}if(e?.maxDataLength!=null&&s>e.maxDataLength)throw new Mh("message length too long","ERR_MSG_DATA_TOO_LONG");return t.read(s,i)},write:async(i,s)=>{await t.write(Rt.single(i,e),s)},unwrap:()=>t.unwrap()}}function F3(){let r=ge(),e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function Hv(){let r=F3(),e=F3();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}var Wv=!!globalThis.process?.env?.DUMP_SESSION_KEYS;var qF=r=>r instanceof Uint8Array;var Xi=r=>new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4)),Gv=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),zF=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!zF)throw new Error("Non little-endian hardware is not supported");function Uh(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function Fh(r){if(typeof r=="string")r=Uh(r);else if(qF(r))r=r.slice();else throw new Error(`expected Uint8Array, got ${typeof r}`);return r}var $F=r=>Object.prototype.toString.call(r)==="[object Object]"&&r.constructor===Object;function Yv(r,e){if(e!==void 0&&(typeof e!="object"||!$F(e)))throw new Error("options must be object or undefined");return Object.assign(r,e)}function Go(r,e){if(!(r instanceof Uint8Array))throw new Error("Uint8Array expected");if(typeof e=="number"&&r.length!==e)throw new Error(`Uint8Array length ${e} expected`)}function Qv(r,e){if(r.length!==e.length)throw new Error("equalBytes: Different size of Uint8Arrays");let t=!0;for(let n=0;n<r.length;n++)t&&(t=r[n]===e[n]);return t}var K3=(r,e)=>(Object.assign(e,r),e);function V3(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),c=n?4:0,l=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function Kh(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`Wrong positive integer: ${r}`)}function q3(r){if(typeof r!="boolean")throw new Error(`Expected boolean, not ${r}`)}function pc(r,...e){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(r.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${r.length}`)}function z3(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Xv(r,e){pc(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var lr=(r,e)=>r[e++]&255|(r[e++]&255)<<8,$3=class{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=Fh(e),Go(e,32);let t=lr(e,0),n=lr(e,2),i=lr(e,4),s=lr(e,6),o=lr(e,8),a=lr(e,10),c=lr(e,12),l=lr(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|i<<6)&7939,this.r[3]=(i>>>7|s<<9)&8191,this.r[4]=(s>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=lr(e,16+2*u)}process(e,t,n=!1){let i=n?0:2048,{h:s,r:o}=this,a=o[0],c=o[1],l=o[2],u=o[3],f=o[4],h=o[5],d=o[6],p=o[7],m=o[8],g=o[9],y=lr(e,t+0),w=lr(e,t+2),E=lr(e,t+4),R=lr(e,t+6),x=lr(e,t+8),v=lr(e,t+10),I=lr(e,t+12),_=lr(e,t+14),k=s[0]+(y&8191),B=s[1]+((y>>>13|w<<3)&8191),L=s[2]+((w>>>10|E<<6)&8191),K=s[3]+((E>>>7|R<<9)&8191),W=s[4]+((R>>>4|x<<12)&8191),te=s[5]+(x>>>1&8191),P=s[6]+((x>>>14|v<<2)&8191),N=s[7]+((v>>>11|I<<5)&8191),O=s[8]+((I>>>8|_<<8)&8191),U=s[9]+(_>>>5|i),A=0,z=A+k*a+B*(5*g)+L*(5*m)+K*(5*p)+W*(5*d);A=z>>>13,z&=8191,z+=te*(5*h)+P*(5*f)+N*(5*u)+O*(5*l)+U*(5*c),A+=z>>>13,z&=8191;let Q=A+k*c+B*a+L*(5*g)+K*(5*m)+W*(5*p);A=Q>>>13,Q&=8191,Q+=te*(5*d)+P*(5*h)+N*(5*f)+O*(5*u)+U*(5*l),A+=Q>>>13,Q&=8191;let Z=A+k*l+B*c+L*a+K*(5*g)+W*(5*m);A=Z>>>13,Z&=8191,Z+=te*(5*p)+P*(5*d)+N*(5*h)+O*(5*f)+U*(5*u),A+=Z>>>13,Z&=8191;let me=A+k*u+B*l+L*c+K*a+W*(5*g);A=me>>>13,me&=8191,me+=te*(5*m)+P*(5*p)+N*(5*d)+O*(5*h)+U*(5*f),A+=me>>>13,me&=8191;let we=A+k*f+B*u+L*l+K*c+W*a;A=we>>>13,we&=8191,we+=te*(5*g)+P*(5*m)+N*(5*p)+O*(5*d)+U*(5*h),A+=we>>>13,we&=8191;let Ce=A+k*h+B*f+L*u+K*l+W*c;A=Ce>>>13,Ce&=8191,Ce+=te*a+P*(5*g)+N*(5*m)+O*(5*p)+U*(5*d),A+=Ce>>>13,Ce&=8191;let xe=A+k*d+B*h+L*f+K*u+W*l;A=xe>>>13,xe&=8191,xe+=te*c+P*a+N*(5*g)+O*(5*m)+U*(5*p),A+=xe>>>13,xe&=8191;let Re=A+k*p+B*d+L*h+K*f+W*u;A=Re>>>13,Re&=8191,Re+=te*l+P*c+N*a+O*(5*g)+U*(5*m),A+=Re>>>13,Re&=8191;let Je=A+k*m+B*p+L*d+K*h+W*f;A=Je>>>13,Je&=8191,Je+=te*u+P*l+N*c+O*a+U*(5*g),A+=Je>>>13,Je&=8191;let Ye=A+k*g+B*m+L*p+K*d+W*h;A=Ye>>>13,Ye&=8191,Ye+=te*f+P*u+N*l+O*c+U*a,A+=Ye>>>13,Ye&=8191,A=(A<<2)+A|0,A=A+z|0,z=A&8191,A=A>>>13,Q+=A,s[0]=z,s[1]=Q,s[2]=Z,s[3]=me,s[4]=we,s[5]=Ce,s[6]=xe,s[7]=Re,s[8]=Je,s[9]=Ye}finalize(){let{h:e,pad:t}=this,n=new Uint16Array(10),i=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=i,i=e[a]>>>13,e[a]&=8191;e[0]+=i*5,i=e[0]>>>13,e[0]&=8191,e[1]+=i,i=e[1]>>>13,e[1]&=8191,e[2]+=i,n[0]=e[0]+5,i=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+i,i=n[a]>>>13,n[a]&=8191;n[9]-=8192;let s=(i^1)-1;for(let a=0;a<10;a++)n[a]&=s;s=~s;for(let a=0;a<10;a++)e[a]=e[a]&s|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535}update(e){z3(this);let{buffer:t,blockLen:n}=this;e=Fh(e);let i=e.length;for(let s=0;s<i;){let o=Math.min(n-this.pos,i-s);if(o===n){for(;n<=i-s;s+=n)this.process(e,s);continue}t.set(e.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){this.h.fill(0),this.r.fill(0),this.buffer.fill(0),this.pad.fill(0)}digestInto(e){z3(this),Xv(e,this),this.finished=!0;let{buffer:t,h:n}=this,{pos:i}=this;if(i){for(t[i++]=1;i<16;i++)t[i]=0;this.process(t,0,!0)}this.finalize();let s=0;for(let o=0;o<8;o++)e[s++]=n[o]>>>0,e[s++]=n[o]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}};function HF(r){let e=(n,i)=>r(i).update(Fh(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}var jv=HF(r=>new $3(r));var WF=Uh("expand 16-byte k"),GF=Uh("expand 32-byte k"),YF=Xi(WF),QF=Xi(GF);function re(r,e){return r<<e|r>>>32-e}function H3(r){return r.byteOffset%4===0}var Vh=64,XF=16,Jv=2**32-1,Zv=new Uint32Array;function jF(r,e,t,n,i,s,o,a){let c=i.length,l=new Uint8Array(Vh),u=Xi(l),f=H3(i)&&H3(s),h=f?Xi(i):Zv,d=f?Xi(s):Zv;for(let p=0;p<c;o++){if(r(e,t,n,u,o,a),o>=Jv)throw new Error("arx: counter overflow");let m=Math.min(Vh,c-p);if(f&&m===Vh){let g=p/4;if(p%4!==0)throw new Error("arx: invalid block position");for(let y=0,w;y<XF;y++)w=g+y,d[w]=h[w]^u[y];p+=Vh;continue}for(let g=0,y;g<m;g++)y=p+g,s[y]=i[y]^l[g];p+=m}}function W3(r,e){let{allowShortKeys:t,extendNonceFn:n,counterLength:i,counterRight:s,rounds:o}=Yv({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return Kh(i),Kh(o),q3(s),q3(t),(a,c,l,u,f=0)=>{pc(a),pc(c),pc(l);let h=l.length;if(u||(u=new Uint8Array(h)),pc(u),Kh(f),f<0||f>=Jv)throw new Error("arx: counter overflow");if(u.length<h)throw new Error(`arx: output (${u.length}) is shorter than data (${h})`);let d=[],p=a.length,m,g;if(p===32)m=a.slice(),d.push(m),g=QF;else if(p===16&&t)m=new Uint8Array(32),m.set(a),m.set(a,16),g=YF,d.push(m);else throw new Error(`arx: invalid 32-byte key, got length=${p}`);H3(c)||(c=c.slice(),d.push(c));let y=Xi(m);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(g,y,Xi(c.subarray(0,16)),y),c=c.subarray(16)}let w=16-i;if(w!==c.length)throw new Error(`arx: nonce must be ${w} or 16 bytes`);if(w!==12){let R=new Uint8Array(12);R.set(c,s?0:12-c.length),c=R,d.push(c)}let E=Xi(c);for(jF(r,g,y,E,l,u,f,o);d.length>0;)d.pop().fill(0);return u}}function r_(r,e,t,n,i,s=20){let o=r[0],a=r[1],c=r[2],l=r[3],u=e[0],f=e[1],h=e[2],d=e[3],p=e[4],m=e[5],g=e[6],y=e[7],w=i,E=t[0],R=t[1],x=t[2],v=o,I=a,_=c,k=l,B=u,L=f,K=h,W=d,te=p,P=m,N=g,O=y,U=w,A=E,z=R,Q=x;for(let me=0;me<s;me+=2)v=v+B|0,U=re(U^v,16),te=te+U|0,B=re(B^te,12),v=v+B|0,U=re(U^v,8),te=te+U|0,B=re(B^te,7),I=I+L|0,A=re(A^I,16),P=P+A|0,L=re(L^P,12),I=I+L|0,A=re(A^I,8),P=P+A|0,L=re(L^P,7),_=_+K|0,z=re(z^_,16),N=N+z|0,K=re(K^N,12),_=_+K|0,z=re(z^_,8),N=N+z|0,K=re(K^N,7),k=k+W|0,Q=re(Q^k,16),O=O+Q|0,W=re(W^O,12),k=k+W|0,Q=re(Q^k,8),O=O+Q|0,W=re(W^O,7),v=v+L|0,Q=re(Q^v,16),N=N+Q|0,L=re(L^N,12),v=v+L|0,Q=re(Q^v,8),N=N+Q|0,L=re(L^N,7),I=I+K|0,U=re(U^I,16),O=O+U|0,K=re(K^O,12),I=I+K|0,U=re(U^I,8),O=O+U|0,K=re(K^O,7),_=_+W|0,A=re(A^_,16),te=te+A|0,W=re(W^te,12),_=_+W|0,A=re(A^_,8),te=te+A|0,W=re(W^te,7),k=k+B|0,z=re(z^k,16),P=P+z|0,B=re(B^P,12),k=k+B|0,z=re(z^k,8),P=P+z|0,B=re(B^P,7);let Z=0;n[Z++]=o+v|0,n[Z++]=a+I|0,n[Z++]=c+_|0,n[Z++]=l+k|0,n[Z++]=u+B|0,n[Z++]=f+L|0,n[Z++]=h+K|0,n[Z++]=d+W|0,n[Z++]=p+te|0,n[Z++]=m+P|0,n[Z++]=g+N|0,n[Z++]=y+O|0,n[Z++]=w+U|0,n[Z++]=E+A|0,n[Z++]=R+z|0,n[Z++]=x+Q|0}function ZF(r,e,t,n){let i=r[0],s=r[1],o=r[2],a=r[3],c=e[0],l=e[1],u=e[2],f=e[3],h=e[4],d=e[5],p=e[6],m=e[7],g=t[0],y=t[1],w=t[2],E=t[3];for(let x=0;x<20;x+=2)i=i+c|0,g=re(g^i,16),h=h+g|0,c=re(c^h,12),i=i+c|0,g=re(g^i,8),h=h+g|0,c=re(c^h,7),s=s+l|0,y=re(y^s,16),d=d+y|0,l=re(l^d,12),s=s+l|0,y=re(y^s,8),d=d+y|0,l=re(l^d,7),o=o+u|0,w=re(w^o,16),p=p+w|0,u=re(u^p,12),o=o+u|0,w=re(w^o,8),p=p+w|0,u=re(u^p,7),a=a+f|0,E=re(E^a,16),m=m+E|0,f=re(f^m,12),a=a+f|0,E=re(E^a,8),m=m+E|0,f=re(f^m,7),i=i+l|0,E=re(E^i,16),p=p+E|0,l=re(l^p,12),i=i+l|0,E=re(E^i,8),p=p+E|0,l=re(l^p,7),s=s+u|0,g=re(g^s,16),m=m+g|0,u=re(u^m,12),s=s+u|0,g=re(g^s,8),m=m+g|0,u=re(u^m,7),o=o+f|0,y=re(y^o,16),h=h+y|0,f=re(f^h,12),o=o+f|0,y=re(y^o,8),h=h+y|0,f=re(f^h,7),a=a+c|0,w=re(w^a,16),d=d+w|0,c=re(c^d,12),a=a+c|0,w=re(w^a,8),d=d+w|0,c=re(c^d,7);let R=0;n[R++]=i,n[R++]=s,n[R++]=o,n[R++]=a,n[R++]=g,n[R++]=y,n[R++]=w,n[R++]=E}var JF=W3(r_,{counterRight:!1,counterLength:4,allowShortKeys:!1}),eK=W3(r_,{counterRight:!1,counterLength:8,extendNonceFn:ZF,allowShortKeys:!1});var tK=new Uint8Array(16),e_=(r,e)=>{r.update(e);let t=e.length%16;t&&r.update(tK.subarray(t))},rK=new Uint8Array(32);function t_(r,e,t,n,i){let s=r(e,t,rK),o=jv.create(s);i&&e_(o,i),e_(o,n);let a=new Uint8Array(16),c=Gv(a);V3(c,0,BigInt(i?i.length:0),!0),V3(c,8,BigInt(n.length),!0),o.update(a);let l=o.digest();return s.fill(0),l}var n_=r=>(e,t,n)=>(Go(e,32),Go(t),{encrypt:(s,o)=>{let a=s.length,c=a+16;o?Go(o,c):o=new Uint8Array(c),r(e,t,s,o,1);let l=t_(r,e,t,o.subarray(0,-16),n);return o.set(l,a),o},decrypt:(s,o)=>{let a=s.length,c=a-16;if(a<16)throw new Error("encrypted data must be at least 16 bytes");o?Go(o,c):o=new Uint8Array(c);let l=s.subarray(0,-16),u=s.subarray(-16),f=t_(r,e,t,l,n);if(!Qv(u,f))throw new Error("invalid tag");return r(e,t,l,o,1),o}}),G3=K3({blockSize:64,nonceLength:12,tagLength:16},n_(JF)),pde=K3({blockSize:64,nonceLength:24,tagLength:16},n_(eK));function s_(r,e,t){return Sl(r),t===void 0&&(t=new Uint8Array(r.outputLen)),Ka(r,vs(t),vs(e))}var Y3=new Uint8Array([0]),i_=new Uint8Array;function o_(r,e,t,n=32){if(Sl(r),hf(n),n>255*r.outputLen)throw new Error("Length should be <= 255*HashLen");let i=Math.ceil(n/r.outputLen);t===void 0&&(t=i_);let s=new Uint8Array(i*r.outputLen),o=Ka.create(r,e),a=o._cloneInto(),c=new Uint8Array(o.outputLen);for(let l=0;l<i;l++)Y3[0]=l+1,a.update(l===0?i_:c).update(t).update(Y3).digestInto(c),s.set(c,r.outputLen*l),o._cloneInto(a);return o.destroy(),a.destroy(),c.fill(0),Y3.fill(0),s.slice(0,n)}var Q3={hashSHA256(r){return Fa(r)},getHKDF(r,e){let t=s_(Fa,e,r),i=o_(Fa,t,void 0,96),s=i.subarray(0,32),o=i.subarray(32,64),a=i.subarray(64,96);return[s,o,a]},generateX25519KeyPair(){let r=Dl.utils.randomPrivateKey();return{publicKey:Dl.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:Dl.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return Dl.getSharedSecret(r,e)},chaCha20Poly1305Encrypt(r,e,t,n){return G3(n,e,t).encrypt(r)},chaCha20Poly1305Decrypt(r,e,t,n,i){return G3(n,e,t).decrypt(r,i)}};var nK=r=>globalThis.Buffer?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r),mc=r=>{let e=nK(2);return new DataView(e.buffer,e.byteOffset,e.byteLength).setUint16(0,r,!1),e};mc.bytes=2;var uu=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");return r instanceof Uint8Array?new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,!1):r.getUint16(0)};uu.bytes=2;function a_(r){return ve([r.ne,r.ciphertext],r.ne.length+r.ciphertext.length)}function c_(r){return ve([r.ne,r.ns,r.ciphertext],r.ne.length+r.ns.length+r.ciphertext.length)}function l_(r){return ve([r.ns,r.ciphertext],r.ns.length+r.ciphertext.length)}function u_(r){if(r.length<32)throw new Error("Cannot decode stage 0 MessageBuffer: length less than 32 bytes.");return{ne:r.subarray(0,32),ciphertext:r.subarray(32,r.length),ns:new Uint8Array(0)}}function f_(r){if(r.length<80)throw new Error("Cannot decode stage 1 MessageBuffer: length less than 80 bytes.");return{ne:r.subarray(0,32),ns:r.subarray(32,80),ciphertext:r.subarray(80,r.length)}}function h_(r){if(r.length<48)throw new Error("Cannot decode stage 2 MessageBuffer: length less than 48 bytes.");return{ne:new Uint8Array(0),ns:r.subarray(0,48),ciphertext:r.subarray(48,r.length)}}var p_=16;function m_(r,e){return async function*(t){for await(let n of t)for(let i=0;i<n.length;i+=65519){let s=i+65519;s>n.length&&(s=n.length);let o=r.encrypt(n.subarray(i,s),r.session);e?.encryptedPackets.increment(),yield mc(o.byteLength),yield o}}}function g_(r,e){return async function*(t){for await(let n of t)for(let i=0;i<n.length;i+=65535){let s=i+65535;if(s>n.length&&(s=n.length),s-p_<i)throw new Error("Invalid chunk");let o=n.subarray(i,s),a=n.subarray(i,s-p_),{plaintext:c,valid:l}=r.decrypt(o,r.session,a);if(!l)throw e?.decryptErrors.increment(),new Error("Failed to validate decrypted chunk");e?.decryptedPackets.increment(),yield c}}}var qh;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(let s of t.webtransportCerthashes)n.uint32(10),n.bytes(s);i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={webtransportCerthashes:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.webtransportCerthashes.push(t.bytes());break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(qh||(qh={}));var hu;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),(i.writeDefaults===!0||t.identityKey!=null&&t.identityKey.byteLength>0)&&(n.uint32(10),n.bytes(t.identityKey??new Uint8Array(0))),(i.writeDefaults===!0||t.identitySig!=null&&t.identitySig.byteLength>0)&&(n.uint32(18),n.bytes(t.identitySig??new Uint8Array(0))),t.extensions!=null&&(n.uint32(34),qh.codec().encode(t.extensions,n,{writeDefaults:!1})),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={identityKey:new Uint8Array(0),identitySig:new Uint8Array(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.identityKey=t.bytes();break;case 2:i.identitySig=t.bytes();break;case 4:i.extensions=qh.codec().decode(t,t.uint32());break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(hu||(hu={}));async function y_(r,e,t){let n=await sK(r,b_(e));if(r.publicKey==null)throw new Error("PublicKey was missing from local PeerId");return iK(r.publicKey,n,t)}function iK(r,e,t){return hu.encode({identityKey:r,identitySig:e,extensions:t??{webtransportCerthashes:[]}}).subarray()}async function sK(r,e){if(r.privateKey==null)throw new Error("PrivateKey was missing from PeerId");return(await vn(r.privateKey)).sign(e)}async function X3(r){return ar(r.identityKey)}function j3(r){return hu.decode(r)}function b_(r){let e=Y("noise-libp2p-static-key:");return ve([e,r],e.length+r.length)}async function Z3(r,e,t){let n=await ar(e.identityKey);if(!n.equals(t))throw new Error(`Payload identity key ${n.toString()} does not match expected remote peer ${t.toString()}`);let i=b_(r);if(n.publicKey==null)throw new Error("PublicKey was missing from PeerId");if(e.identitySig==null)throw new Error("Signature was missing from message");if(!await Lr(n.publicKey).verify(i,e.identitySig))throw new Error("Static key doesn't match to peer that signed payload!");return n}function du(r){return!(!(r instanceof Uint8Array)||r.length!==32)}function zh(r,e){for(let t=0;t<r.byteLength;t++){if(r[t]<e[t])return-1;if(r[t]>e[t])return 1}return r.byteLength>e.byteLength?1:r.byteLength<e.byteLength?-1:0}function ji(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");let t=zt(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return Di(t)}var er=D("libp2p:noise");var Tn;Wv?Tn=er:Tn=Object.assign(()=>{},{enabled:!1,trace:()=>{},error:()=>{}});function w_(r){Tn(`LOCAL_STATIC_PUBLIC_KEY ${H(r.publicKey,"hex")}`),Tn(`LOCAL_STATIC_PRIVATE_KEY ${H(r.privateKey,"hex")}`)}function J3(r){r?(Tn(`LOCAL_PUBLIC_EPHEMERAL_KEY ${H(r.publicKey,"hex")}`),Tn(`LOCAL_PRIVATE_EPHEMERAL_KEY ${H(r.privateKey,"hex")}`)):Tn("Missing local ephemeral keys.")}function E_(r){Tn(`REMOTE_STATIC_PUBLIC_KEY ${H(r,"hex")}`)}function e4(r){Tn(`REMOTE_EPHEMERAL_PUBLIC_KEY ${H(r,"hex")}`)}function x_(r){r.cs1&&r.cs2?(Tn(`CIPHER_STATE_1 ${r.cs1.n.getUint64()} ${H(r.cs1.k,"hex")}`),Tn(`CIPHER_STATE_2 ${r.cs2.n.getUint64()} ${H(r.cs2.k,"hex")}`)):Tn("Missing cipher state.")}var oK="Cipherstate has reached maximum n, a new handshake must be performed",$h=class{n;bytes;view;constructor(e=0){this.n=e,this.bytes=new Uint8Array(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>4294967295)throw new Error(oK)}};var Hh=class{crypto;constructor(e){this.crypto=e}encryptWithAd(e,t,n){let i=this.encrypt(e.k,e.n,t,n);return e.n.increment(),i}decryptWithAd(e,t,n,i){let{plaintext:s,valid:o}=this.decrypt(e.k,e.n,t,n,i);return o&&e.n.increment(),{plaintext:s,valid:o}}hasKey(e){return!this.isEmptyKey(e.k)}createEmptyKey(){return new Uint8Array(32)}isEmptyKey(e){let t=this.createEmptyKey();return ce(t,e)}encrypt(e,t,n,i){return t.assertValue(),this.crypto.chaCha20Poly1305Encrypt(i,t.getBytes(),n,e)}encryptAndHash(e,t){let n;return this.hasKey(e.cs)?n=this.encryptWithAd(e.cs,e.h,t):n=t,this.mixHash(e,n),n}decrypt(e,t,n,i,s){t.assertValue();let o=this.crypto.chaCha20Poly1305Decrypt(i,t.getBytes(),n,e,s);return o?{plaintext:o,valid:!0}:{plaintext:new Uint8Array(0),valid:!1}}decryptAndHash(e,t){let n,i=!0;return this.hasKey(e.cs)?{plaintext:n,valid:i}=this.decryptWithAd(e.cs,e.h,t):n=t,this.mixHash(e,t),{plaintext:n,valid:i}}dh(e,t){try{let n=this.crypto.generateX25519SharedKey(e,t);return n.length===32?n:n.subarray(0,32)}catch(n){let i=n;return er.error(i),new Uint8Array(32)}}mixHash(e,t){e.h=this.getHash(e.h,t)}getHash(e,t){return this.crypto.hashSHA256(ve([e,t],e.length+t.length))}mixKey(e,t){let[n,i]=this.crypto.getHKDF(e.ck,t);e.cs=this.initializeKey(i),e.ck=n}initializeKey(e){return{k:e,n:new $h}}initializeSymmetric(e){let t=Y(e,"utf-8"),n=this.hashProtocolName(t),i=n,s=this.createEmptyKey();return{cs:this.initializeKey(s),ck:i,h:n}}hashProtocolName(e){if(e.length<=32){let t=new Uint8Array(32);return t.set(e),t}else return this.getHash(e,new Uint8Array(0))}split(e){let[t,n]=this.crypto.getHKDF(e.ck,new Uint8Array(0)),i=this.initializeKey(t),s=this.initializeKey(n);return{cs1:i,cs2:s}}writeMessageRegular(e,t){let n=this.encryptWithAd(e,new Uint8Array(0),t),i=this.createEmptyKey(),s=new Uint8Array(0);return{ne:i,ns:s,ciphertext:n}}readMessageRegular(e,t){return this.decryptWithAd(e,new Uint8Array(0),t.ciphertext)}};var Wh=class extends Hh{initializeInitiator(e,t,n,i){let s="Noise_XX_25519_ChaChaPoly_SHA256",o=this.initializeSymmetric(s);this.mixHash(o,e);let a=new Uint8Array(32);return{ss:o,s:t,rs:n,psk:i,re:a}}initializeResponder(e,t,n,i){let s="Noise_XX_25519_ChaChaPoly_SHA256",o=this.initializeSymmetric(s);this.mixHash(o,e);let a=new Uint8Array(32);return{ss:o,s:t,rs:n,psk:i,re:a}}writeMessageA(e,t,n){let i=new Uint8Array(0);n!==void 0?e.e=n:e.e=this.crypto.generateX25519KeyPair();let s=e.e.publicKey;this.mixHash(e.ss,s);let o=this.encryptAndHash(e.ss,t);return{ne:s,ns:i,ciphertext:o}}writeMessageB(e,t){e.e=this.crypto.generateX25519KeyPair();let n=e.e.publicKey;this.mixHash(e.ss,n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));let i=e.s.publicKey,s=this.encryptAndHash(e.ss,i);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));let o=this.encryptAndHash(e.ss,t);return{ne:n,ns:s,ciphertext:o}}writeMessageC(e,t){let n=e.s.publicKey,i=this.encryptAndHash(e.ss,n);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));let s=this.encryptAndHash(e.ss,t),a={ne:this.createEmptyKey(),ns:i,ciphertext:s},{cs1:c,cs2:l}=this.split(e.ss);return{h:e.ss.h,messageBuffer:a,cs1:c,cs2:l}}readMessageA(e,t){return du(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),this.decryptAndHash(e.ss,t.ciphertext)}readMessageB(e,t){if(du(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));let{plaintext:n,valid:i}=this.decryptAndHash(e.ss,t.ns);i&&du(n)&&(e.rs=n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));let{plaintext:s,valid:o}=this.decryptAndHash(e.ss,t.ciphertext);return{plaintext:s,valid:i&&o}}readMessageC(e,t){let{plaintext:n,valid:i}=this.decryptAndHash(e.ss,t.ns);if(i&&du(n)&&(e.rs=n),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));let{plaintext:s,valid:o}=this.decryptAndHash(e.ss,t.ciphertext),{cs1:a,cs2:c}=this.split(e.ss);return{h:e.ss.h,plaintext:s,valid:i&&o,cs1:a,cs2:c}}initSession(e,t,n){let i=this.createEmptyKey(),s=new Uint8Array(32),o;return e?o=this.initializeInitiator(t,n,s,i):o=this.initializeResponder(t,n,s,i),{hs:o,i:e,mc:0}}sendMessage(e,t,n){let i;if(e.mc===0)i=this.writeMessageA(e.hs,t,n);else if(e.mc===1)i=this.writeMessageB(e.hs,t);else if(e.mc===2){let{h:s,messageBuffer:o,cs1:a,cs2:c}=this.writeMessageC(e.hs,t);i=o,e.h=s,e.cs1=a,e.cs2=c}else if(e.mc>2)if(e.i){if(!e.cs1)throw new Error("CS1 (cipher state) is not defined");i=this.writeMessageRegular(e.cs1,t)}else{if(!e.cs2)throw new Error("CS2 (cipher state) is not defined");i=this.writeMessageRegular(e.cs2,t)}else throw new Error("Session invalid.");return e.mc++,i}recvMessage(e,t){let n=new Uint8Array(0),i=!1;if(e.mc===0)({plaintext:n,valid:i}=this.readMessageA(e.hs,t));else if(e.mc===1)({plaintext:n,valid:i}=this.readMessageB(e.hs,t));else if(e.mc===2){let{h:s,plaintext:o,valid:a,cs1:c,cs2:l}=this.readMessageC(e.hs,t);n=o,i=a,e.h=s,e.cs1=c,e.cs2=l}return e.mc++,{plaintext:n,valid:i}}};var Gh=class{isInitiator;session;remotePeer;remoteExtensions={webtransportCerthashes:[]};payload;connection;xx;staticKeypair;prologue;constructor(e,t,n,i,s,o,a,c){this.isInitiator=e,this.payload=t,this.prologue=n,this.staticKeypair=s,this.connection=o,a&&(this.remotePeer=a),this.xx=c??new Wh(i),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}async propose(){if(w_(this.session.hs.s),this.isInitiator){er.trace("Stage 0 - Initiator starting to send first message.");let e=this.xx.sendMessage(this.session,new Uint8Array(0));await this.connection.write(a_(e)),er.trace("Stage 0 - Initiator finished sending first message."),J3(this.session.hs.e)}else{er.trace("Stage 0 - Responder waiting to receive first message...");let e=u_((await this.connection.read()).subarray()),{valid:t}=this.xx.recvMessage(this.session,e);if(!t)throw new ao("xx handshake stage 0 validation fail");er.trace("Stage 0 - Responder received first message."),e4(this.session.hs.re)}}async exchange(){if(this.isInitiator){er.trace("Stage 1 - Initiator waiting to receive first message from responder...");let e=f_((await this.connection.read()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new ao("xx handshake stage 1 validation fail");er.trace("Stage 1 - Initiator received the message."),e4(this.session.hs.re),E_(this.session.hs.rs),er.trace("Initiator going to check remote's signature...");try{let i=j3(t);this.remotePeer=this.remotePeer||await X3(i),await Z3(this.session.hs.rs,i,this.remotePeer),this.setRemoteNoiseExtension(i.extensions)}catch(i){let s=i;throw new Yc(`Error occurred while verifying signed payload: ${s.message}`)}er.trace("All good with the signature!")}else{er.trace("Stage 1 - Responder sending out first message with signed payload and static key.");let e=this.xx.sendMessage(this.session,this.payload);await this.connection.write(c_(e)),er.trace("Stage 1 - Responder sent the second handshake message with signed payload."),J3(this.session.hs.e)}}async finish(){if(this.isInitiator){er.trace("Stage 2 - Initiator sending third handshake message.");let e=this.xx.sendMessage(this.session,this.payload);await this.connection.write(l_(e)),er.trace("Stage 2 - Initiator sent message with signed payload.")}else{er.trace("Stage 2 - Responder waiting for third handshake message...");let e=h_((await this.connection.read()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new ao("xx handshake stage 2 validation fail");er.trace("Stage 2 - Responder received the message, finished handshake.");try{let i=j3(t);this.remotePeer=this.remotePeer||await X3(i),await Z3(this.session.hs.rs,i,this.remotePeer),this.setRemoteNoiseExtension(i.extensions)}catch(i){let s=i;throw new Yc(`Error occurred while verifying signed payload: ${s.message}`)}}x_(this.session)}encrypt(e,t){let n=this.getCS(t);return this.xx.encryptWithAd(n,new Uint8Array(0),e)}decrypt(e,t,n){let i=this.getCS(t,!1);return this.xx.decryptWithAd(i,new Uint8Array(0),e,n)}getRemoteStaticKey(){return this.session.hs.rs}getCS(e,t=!0){if(!e.cs1||!e.cs2)throw new ao("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?t?e.cs1:e.cs2:t?e.cs2:e.cs1}setRemoteNoiseExtension(e){e&&(this.remoteExtensions=e)}};function v_(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}var Yh=class{protocol="/noise";crypto;prologue;staticKeys;extensions;metrics;constructor(e={}){let{staticNoiseKey:t,extensions:n,crypto:i,prologueBytes:s,metrics:o}=e;this.crypto=i??Q3,this.extensions=n,this.metrics=o?v_(o):void 0,t?this.staticKeys=this.crypto.generateX25519KeyPairFromSeed(t):this.staticKeys=this.crypto.generateX25519KeyPair(),this.prologue=s??new Uint8Array(0)}async secureOutbound(e,t,n){let i=lu(t,{lengthEncoder:mc,lengthDecoder:uu,maxDataLength:65535}),s=await this.performHandshake({connection:i,isInitiator:!0,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(i,s),remoteExtensions:s.remoteExtensions,remotePeer:s.remotePeer}}async secureInbound(e,t,n){let i=lu(t,{lengthEncoder:mc,lengthDecoder:uu,maxDataLength:65535}),s=await this.performHandshake({connection:i,isInitiator:!1,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(i,s),remotePeer:s.remotePeer,remoteExtensions:s.remoteExtensions}}async performHandshake(e){let t=await y_(e.localPeer,this.staticKeys.publicKey,this.extensions);return this.performXXHandshake(e,t)}async performXXHandshake(e,t){let{isInitiator:n,remotePeer:i,connection:s}=e,o=new Gh(n,t,this.prologue,this.crypto,this.staticKeys,s,i);try{await o.propose(),await o.exchange(),await o.finish(),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){if(this.metrics?.xxHandshakeErrors.increment(),a instanceof Error)throw a.message=`Error occurred during XX handshake: ${a.message}`,a}return o}async createSecureConnection(e,t){let[n,i]=Hv(),s=e.unwrap();return await Te(n,m_(t,this.metrics),s,o=>vt(o,{lengthDecoder:uu}),g_(t,this.metrics),n),i}};function gc(r={}){return()=>new Yh(r)}var yc="ERR_INVALID_FRAME",t4="ERR_UNREQUESTED_PING",r4="ERR_NOT_MATCHING_PING",n4="ERR_STREAM_ALREADY_EXISTS",i4="ERR_DECODE_INVALID_VERSION",s4="ERR_BOTH_CLIENTS",o4="ERR_RECV_WINDOW_EXCEEDED",__=new Set([yc,t4,r4,n4,i4,s4,o4]),Ks="ERR_INVALID_CONFIG",Qh="ERR_MUXER_LOCAL_CLOSED",a4="ERR_MUXER_REMOTE_CLOSED";var S_="ERR_STREAM_ABORT",R_="ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED",I_="ERR_DECODE_IN_PROGRESS",pu=256*1024,A_=16*1024*1024;var T_={log:D("libp2p:yamux"),enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:pu,maxStreamWindowSize:A_,maxMessageSize:64*1024};function D_(r){if(r.keepAliveInterval<=0)throw new b("keep-alive interval must be positive",Ks);if(r.maxInboundStreams<0)throw new b("max inbound streams must be larger or equal 0",Ks);if(r.maxOutboundStreams<0)throw new b("max outbound streams must be larger or equal 0",Ks);if(r.initialStreamWindowSize<pu)throw new b("InitialStreamWindowSize must be larger or equal 256 kB",Ks);if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new b("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",Ks);if(r.maxStreamWindowSize>2**32-1)throw new b("MaxStreamWindowSize must be less than equal MAX_UINT32",Ks);if(r.maxMessageSize<1024)throw new b("MaxMessageSize must be greater than a kilobyte",Ks)}var bt;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(bt||(bt={}));var ft;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(ft||(ft={}));var aK=Object.values(ft).filter(r=>typeof r!="string"),C_=0,Dn;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(Dn||(Dn={}));var Vs=12;function c4(r){let e=aK.filter(t=>(r.flag&t)===t).map(t=>ft[t]).join("|");return`streamID=${r.streamID} type=${bt[r.type]} flag=${e} length=${r.length}`}var P_=2**24;function cK(r){if(r[0]!==C_)throw new b("Invalid frame version",i4);return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*P_+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*P_+(r[9]<<16)+(r[10]<<8)+r[11]}}var Xh=class{source;buffer;frameInProgress;constructor(e){this.source=lK(e),this.buffer=new _e,this.frameInProgress=!1}async*emitFrames(){for await(let e of this.source)for(this.buffer.append(e);;){let t=this.readHeader();if(t===void 0)break;let{type:n,length:i}=t;n===bt.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,i)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new b("decoding frame already in progress",I_);if(this.buffer.length<Vs)return;let e=cK(this.buffer.subarray(0,Vs));return this.buffer.consume(Vs),e}async readBytes(e){if(this.buffer.length<e){for await(let n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}let t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function lK(r){if(r[Symbol.iterator]!==void 0){let e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){let e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function l4(r){let e=new Uint8Array(Vs);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}var bc=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};async function Yo(r,e,t){if(e==null)return r;if(e.aborted)return Promise.reject(new bc(t?.errorMessage,t?.errorCode));let n,i=new bc(t?.errorMessage,t?.errorCode);try{return await Promise.race([r,new Promise((s,o)=>{n=()=>{o(i)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}var uK="ERR_STREAM_RESET",fK="ERR_SINK_INVALID_STATE",hK=5e3;function u4(r){return r!=null&&typeof r.then=="function"}var qs=class{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;sinkController;sinkEnd;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;log;constructor(e){this.sinkController=new AbortController,this.sinkEnd=ge(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??hK,this.onEnd=e.onEnd,this.onCloseRead=e?.onCloseRead,this.onCloseWrite=e?.onCloseWrite,this.onReset=e?.onReset,this.onAbort=e?.onAbort,this.source=this.streamSource=Et({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new b(`writable end state is "${this.writeStatus}" not "ready"`,fK);try{this.writeStatus="writing";let t={signal:this.sinkController.signal};if(this.direction==="outbound"){let n=this.sendNewStream(t);u4(n)&&await n}e=Zt(e,this.sinkController.signal,{returnOnAbort:!0}),this.log.trace("sink reading from source");for await(let n of e){n=n instanceof Uint8Array?new _e(n):n;let i=this.sendData(n,t);u4(i)&&await i}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr)):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr)):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.log.trace("closing gracefully"),this.status="closing",await Promise.all([this.closeRead(e),this.closeWrite(e)]),this.status="closed",this.log.trace("closed gracefully")}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);let t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue"),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await Yo(this.sink([]),e.signal)),this.writeStatus==="writing"&&await new Promise((t,n)=>{queueMicrotask(()=>{this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),Yo(this.sinkEnd.promise,e.signal).then(t,n)})}),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");let t=this.sendReset();u4(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;let e=new b("stream reset",uK);this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}};var Cn;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(Cn||(Cn={}));var jh=class extends qs{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=Cn.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=pu,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=oo(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&await this.waitForSendWindowCapacity(t),this.status!=="open")return;let n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-Vs,e.length),i=this.getSendFlags();this.sendFrame({type:bt.Data,flag:i,streamID:this._id,length:n},e.subarray(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:bt.WindowUpdate,flag:ft.RST,streamID:this._id,length:0})}async sendCloseWrite(){let e=this.getSendFlags()|ft.FIN;this.sendFrame({type:bt.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n,i=()=>{this.status==="open"?n(new b("stream aborted",S_)):t()};e.signal?.addEventListener("abort",i);try{await new Promise((s,o)=>{this.sendWindowCapacityUpdate=()=>{s()},n=o,t=s})}finally{e.signal?.removeEventListener("abort",i)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);let t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new b("receive window exceeded",o4,{available:this.recvWindowCapacity,recv:e.length});let n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&ft.ACK)===ft.ACK&&this.state===Cn.SYNSent&&(this.state=Cn.Established),(e&ft.FIN)===ft.FIN&&this.remoteCloseWrite(),(e&ft.RST)===ft.RST&&this.reset()}getSendFlags(){switch(this.state){case Cn.Init:return this.state=Cn.SYNSent,ft.SYN;case Cn.SYNReceived:return this.state=Cn.Established,ft.ACK;default:return 0}}sendWindowUpdate(){let e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>0&&t-this.epochStart<n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;let i=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:bt.WindowUpdate,flag:e,streamID:this._id,length:i})}};var k_="/yamux/1.0.0",dK=500,Zh=class{protocol=k_;_init;constructor(e={}){this._init=e}createStreamMuxer(e){return new f4({...this._init,...e})}},f4=class{protocol=k_;source;sink;config;log;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e){this.client=e.direction==="outbound",this.config={...T_,...e},this.log=this.config.log,D_(this.config),this.closeController=new AbortController,this.onIncomingStream=e.onIncomingStream,this.onStreamEnd=e.onStreamEnd,this._streams=new Map,this.source=Et({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(t=>{t.destroy()})}}),this.sink=async t=>{t=Zt(t,this.closeController.signal,{returnOnAbort:!0});let n,i;try{let s=new Xh(t);await Te(s.emitFrames.bind(s),async o=>{for await(let{header:a,readData:c}of o)await this.handleFrame(a,c)}),n=Dn.NormalTermination}catch(s){let o=s.code;__.has(o)?(this.log?.error("protocol error in sink",s),n=Dn.ProtocolError):(this.log?.error("internal error in sink",s),n=Dn.InternalError),i=s}this.log?.trace("muxer sink ended"),i!=null?this.abort(i,n):await this.close({reason:n})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=0,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(t=>this.log?.error("keepalive error: %s",t))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new b("muxer closed remotely",a4);if(this.localGoAway!==void 0)throw new b("muxer closed locally",Qh);let t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new b("max outbound streams exceeded",R_);this.log?.trace("new outgoing stream id=%s",t);let n=this._newStream(t,e,Cn.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new b("muxer closed remotely",a4);if(this.localGoAway!==void 0)throw new b("muxer closed locally",Qh);if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((i,s)=>{let o=()=>{s(new b("muxer closed locally",Qh))};this.closeController.signal.addEventListener("abort",o,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",o),i()}}),resolve:e};let t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}let n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;let t=e?.reason??Dn.NormalTermination;this.log?.trace("muxer close reason=%s",t),e.signal=e.signal??AbortSignal.timeout(dK);try{await Promise.all([...this._streams.values()].map(async n=>n.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(n){this.abort(n)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??Dn.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(let n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,i){if(this._streams.get(e)!=null)throw new b("Stream already exists",n4,{id:e});let s=new jh({id:e.toString(),name:t,state:n,direction:i,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(s)},log:D(`libp2p:yamux:${i}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return s}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){let e=new Promise((t,n)=>{this.closeController.signal.addEventListener("abort",n,{once:!0})});for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await Promise.race([e,new Promise(n=>{t=setTimeout(n,this.config.keepAliveInterval)})]),this.ping().catch(n=>this.log?.error("ping error: %s",n))}catch{clearInterval(t);return}}}async handleFrame(e,t){let{streamID:n,type:i,length:s}=e;if(this.log?.trace("received frame %s",c4(e)),n===0)switch(i){case bt.Ping:{this.handlePing(e);return}case bt.GoAway:{this.handleGoAway(s);return}default:throw new b("Invalid frame type",yc,{header:e})}else switch(e.type){case bt.Data:case bt.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new b("Invalid frame type",yc,{header:e})}}handlePing(e){if(e.flag===ft.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,ft.ACK);else if(e.flag===ft.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new b("Invalid frame flag",yc,{header:e})}handlePingResponse(e){if(this.activePing===void 0)throw new b("ping not requested",t4);if(this.activePing.id!==e)throw new b("ping doesn't match our id",r4);this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",Dn[e]??"unknown"),this.remoteGoAway=e;for(let t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){let{streamID:n,flag:i,type:s}=e;(i&ft.SYN)===ft.SYN&&this.incomingStream(n);let o=this._streams.get(n);if(o===void 0){if(s===bt.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.("frame for missing stream id=%s",n);return}switch(s){case bt.WindowUpdate:{o.handleWindowUpdate(e);return}case bt.Data:{if(t===void 0)throw new Error("unreachable");await o.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new b("both endpoints are clients",s4);if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:bt.WindowUpdate,flag:ft.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:bt.WindowUpdate,flag:ft.RST,streamID:e,length:0});return}let t=this._newStream(e,void 0,Cn.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %s",c4(e)),e.type===bt.Data){if(t===void 0)throw new b("invalid frame",yc);this.source.push(l4(e)),this.source.push(t)}else this.source.push(l4(e))}sendPing(e,t=ft.SYN){t===ft.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:bt.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Dn.NormalTermination){this.log?.("sending GoAway reason=%s",Dn[e]),this.localGoAway=e,this.sendFrame({type:bt.GoAway,flag:0,streamID:0,length:e})}};function N_(r={}){return()=>new Zh(r)}async function*Jh(r,e={}){let t=r.getReader();try{for(;;){let n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var yK=de(ro(),1);var bK=de(d4(),1);var O_="ERR_IPNS_EXPIRED_RECORD",ed="ERR_UNRECOGNIZED_VALIDITY";var Zi="ERR_SIGNATURE_VERIFICATION",L_="ERR_UNRECOGNIZED_FORMAT";var p4="ERR_UNDEFINED_PARAMETER",B_="ERR_INVALID_RECORD_DATA",M_="ERR_INVALID_VALUE",U_="ERR_INVALID_EMBEDDED_KEY";var F_="ERR_RECORD_TOO_LARGE";var Pn;(function(r){let e;(function(i){i.EOL="EOL"})(e=r.ValidityType||(r.ValidityType={}));let t;(function(i){i[i.EOL=0]="EOL"})(t||(t={})),function(i){i.codec=()=>ht(t)}(e=r.ValidityType||(r.ValidityType={}));let n;r.codec=()=>(n==null&&(n=fe((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.value!=null&&(s.uint32(10),s.bytes(i.value)),i.signatureV1!=null&&(s.uint32(18),s.bytes(i.signatureV1)),i.validityType!=null&&(s.uint32(24),r.ValidityType.codec().encode(i.validityType,s)),i.validity!=null&&(s.uint32(34),s.bytes(i.validity)),i.sequence!=null&&(s.uint32(40),s.uint64(i.sequence)),i.ttl!=null&&(s.uint32(48),s.uint64(i.ttl)),i.pubKey!=null&&(s.uint32(58),s.bytes(i.pubKey)),i.signatureV2!=null&&(s.uint32(66),s.bytes(i.signatureV2)),i.data!=null&&(s.uint32(74),s.bytes(i.data)),o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{let o={},a=s==null?i.len:i.pos+s;for(;i.pos<a;){let c=i.uint32();switch(c>>>3){case 1:o.value=i.bytes();break;case 2:o.signatureV1=i.bytes();break;case 3:o.validityType=r.ValidityType.codec().decode(i);break;case 4:o.validity=i.bytes();break;case 5:o.sequence=i.uint64();break;case 6:o.ttl=i.uint64();break;case 7:o.pubKey=i.bytes();break;case 8:o.signatureV2=i.bytes();break;case 9:o.data=i.bytes();break;default:i.skipType(c&7);break}}return o})),n),r.encode=i=>ue(i,r.codec()),r.decode=i=>le(i,r.codec())})(Pn||(Pn={}));var Fr=de(ro(),1);var K_=de(d4(),1);var g4=D("ipns:utils"),V_=Y("/ipns/"),pK=114;function mK(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),i=parseInt(t[2],10)-1,s=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].padEnd(6,"0").slice(0,3),10);return new Date(Date.UTC(n,i,s,o,a,c,l))}var y4=async(r,e)=>{if(e==null||r==null){let n=new Error("one or more of the provided parameters are not defined");throw g4.error(n),(0,Fr.default)(n,p4)}let t;if(e.pubKey!=null){try{t=Lr(e.pubKey)}catch(i){throw g4.error(i),i}if(!(await ar(e.pubKey)).equals(r))throw(0,Fr.default)(new Error("Embedded public key did not match PeerID"),U_)}else r.publicKey!=null&&(t=Lr(r.publicKey));if(t!=null)return t;throw(0,Fr.default)(new Error("no public key is available"),p4)};var b4=r=>{let e=Y("ipns-signature:");return ve([e,r])},mu=r=>"signatureV1"in r?Pn.encode({value:Y(r.value),signatureV1:r.signatureV1,validityType:r.validityType,validity:Y(r.validity.toString()),sequence:r.sequence,ttl:r.ttl,pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data}):Pn.encode({pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data});function _i(r){let e=Pn.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw(0,Fr.default)(new Error("missing data or signatureV2"),Zi);let t=q_(e.data),n=z_(t.Value),i;try{i=K_.default.fromDate(mK(H(t.Validity)))}catch{throw g4.error("unrecognized validity format (not an rfc3339 format)"),(0,Fr.default)(new Error("unrecognized validity format (not an rfc3339 format)"),L_)}if(e.value!=null&&e.signatureV1!=null)return gK(e),{value:n,validityType:Pn.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:Pn.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}var w4=r=>ve([V_,r.toBytes()]),E4=r=>it(r.slice(V_.length));var q_=r=>{let e=yn(r);if(e.ValidityType===0)e.ValidityType=Pn.ValidityType.EOL;else throw(0,Fr.default)(new Error("Unknown validity type"),ed);return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e},z_=r=>{if(r!=null){if(qa(r))return`/ipns/${r.toCID().toString(ss)}`;if(r instanceof Uint8Array){let n=H(r);n.startsWith("/")&&(r=n)}let e=r.toString().trim();if(e.startsWith("/")&&e.length>1)return e;let t=be.asCID(r);if(t!=null)return t.code===pK?`/ipns/${t.toString(ss)}`:`/ipfs/${t.toV1().toString()}`;try{return r instanceof Uint8Array?`/ipfs/${be.decode(r).toV1().toString()}`:`/ipfs/${be.parse(e).toV1().toString()}`}catch{}}throw(0,Fr.default)(new Error("Value must be a valid content path starting with /"),M_)},gK=r=>{if(r.data==null)throw(0,Fr.default)(new Error("Record data is missing"),B_);let e=q_(r.data);if(!ce(e.Value,r.value??new Uint8Array(0)))throw(0,Fr.default)(new Error('Field "value" did not match between protobuf and CBOR'),Zi);if(!ce(e.Validity,r.validity??new Uint8Array(0)))throw(0,Fr.default)(new Error('Field "validity" did not match between protobuf and CBOR'),Zi);if(e.ValidityType!==r.validityType)throw(0,Fr.default)(new Error('Field "validityType" did not match between protobuf and CBOR'),Zi);if(e.Sequence!==r.sequence)throw(0,Fr.default)(new Error('Field "sequence" did not match between protobuf and CBOR'),Zi);if(e.TTL!==r.ttl)throw(0,Fr.default)(new Error('Field "ttl" did not match between protobuf and CBOR'),Zi)};var Qpe=D("ipns"),Xpe=hn.code,wK="/ipns/",jpe=wK.length;var gu=de(ro(),1);var td=D("ipns:validator"),EK=1024*10,xK=async(r,e)=>{let t=_i(e),n;try{let i=b4(t.data);n=await r.verify(i,t.signatureV2)}catch{n=!1}if(!n)throw td.error("record signature verification failed"),(0,gu.default)(new Error("record signature verification failed"),Zi);if(t.validityType===Pn.ValidityType.EOL){if(t.validity.toDate().getTime()<Date.now())throw td.error("record has expired"),(0,gu.default)(new Error("record has expired"),O_)}else if(t.validityType!=null)throw td.error("unrecognized validity type"),(0,gu.default)(new Error("unrecognized validity type"),ed);td("ipns record for %b is valid",t.value)};async function rd(r,e){if(e.byteLength>EK)throw(0,gu.default)(new Error("record too large"),F_);let t=E4(r),n=_i(e),i=await y4(t,n);await xK(i,e)}async function*yu(r){let e=/\r?\n/,t=new TextDecoder("utf8"),n="";for await(let i of r){typeof i=="string"&&(i=new TextEncoder().encode(i)),n+=t.decode(i,{stream:!0});let s=n.split(e);n=s.pop()??"";for(let o=0;o<s.length;o++)yield JSON.parse(s[o])}n+=t.decode(),n!==""&&(yield JSON.parse(n))}var x4=Y("/ipns/");function $_(r){return ce(r.subarray(0,x4.byteLength),x4)}var H_=r=>it(r.slice(x4.length)),nd=class{client;constructor(e){this.client=e}async*findProviders(e,t={}){yield*zr(this.client.getProviders(e,t),n=>({id:n.ID,multiaddrs:n.Addrs??[],protocols:[]}))}async provide(){}async put(e,t,n){if(!$_(e))return;let i=H_(e),s=_i(t);await this.client.putIPNS(i,s,n)}async get(e,t){if(!$_(e))throw new b("Not found","ERR_NOT_FOUND");let n=H_(e);try{let i=await this.client.getIPNS(n,t);return mu(i)}catch(i){throw i.code==="ERR_BAD_RESPONSE"?new b("Not found","ERR_NOT_FOUND"):i}}},id=class{client;constructor(e){this.client=e}async findPeer(e,t={}){let n=await rn(this.client.getPeers(e,t));if(n!=null)return{id:n.ID,multiaddrs:n.Addrs,protocols:[]};throw new b("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){}};var Si=D("delegated-routing-v1-http-api-client"),W_={concurrentRequests:4,timeout:3e4},sd=class{started;httpQueue;shutDownController;clientUrl;timeout;contentRouting;peerRouting;constructor(e,t={}){this.started=!1,this.shutDownController=new AbortController,this.httpQueue=new Ft({concurrency:t.concurrentRequests??W_.concurrentRequests}),this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??W_.timeout,this.contentRouting=new nd(this),this.peerRouting=new id(this)}get[Co](){return this.contentRouting}get[ko](){return this.peerRouting}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.shutDownController.abort(),this.started=!1}async*getProviders(e,t={}){Si("getProviders starts: %c",e);let n=xt([this.shutDownController.signal,t.signal,AbortSignal.timeout(this.timeout)]),i=ge(),s=ge();this.httpQueue.add(async()=>(i.resolve(),s.promise));try{await i.promise;let o=`${this.clientUrl}routing/v1/providers/${e.toString()}`,c=await fetch(o,{headers:{Accept:"application/x-ndjson"},signal:n});if(c.body==null)throw new b("Routing response had no body","ERR_BAD_RESPONSE");if(c.headers.get("Content-Type")==="application/json"){let u=await c.json();for(let f of u.Providers){let h=this.#e(f);h!=null&&(yield h)}}else for await(let u of yu(Jh(c.body))){let f=this.#e(u);f!=null&&(yield f)}}catch(o){Si.error("getProviders errored:",o)}finally{n.clear(),s.resolve(),Si("getProviders finished: %c",e)}}async*getPeers(e,t={}){Si("getPeers starts: %c",e);let n=xt([this.shutDownController.signal,t.signal,AbortSignal.timeout(this.timeout)]),i=ge(),s=ge();this.httpQueue.add(async()=>(i.resolve(),s.promise));try{await i.promise;let o=`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`,c=await fetch(o,{headers:{Accept:"application/x-ndjson"},signal:n});if(c.body==null)throw new b("Routing response had no body","ERR_BAD_RESPONSE");if(c.headers.get("Content-Type")==="application/json"){let u=await c.json();for(let f of u.Peers){let h=this.#t(e,f);h!=null&&(yield h)}}else for await(let u of yu(Jh(c.body))){let f=this.#t(e,u);f!=null&&(yield f)}}catch(o){Si.error("getPeers errored:",o)}finally{n.clear(),s.resolve(),Si("getPeers finished: %c",e)}}async getIPNS(e,t={}){Si("getIPNS starts: %c",e);let n=xt([this.shutDownController.signal,t.signal,AbortSignal.timeout(this.timeout)]),i=ge(),s=ge();this.httpQueue.add(async()=>(i.resolve(),s.promise));try{await i.promise;let o=`${this.clientUrl}routing/v1/ipns/${e.toCID().toString()}`,c=await fetch(o,{headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:n});if(c.body==null)throw new b("GET ipns response had no body","ERR_BAD_RESPONSE");let l=new Uint8Array(await c.arrayBuffer());return await rd(w4(e),l),_i(l)}finally{n.clear(),s.resolve(),Si("getIPNS finished: %c",e)}}async putIPNS(e,t,n={}){Si("getIPNS starts: %c",e);let i=xt([this.shutDownController.signal,n.signal,AbortSignal.timeout(this.timeout)]),s=ge(),o=ge();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;let a=mu(t),c=`${this.clientUrl}routing/v1/ipns/${e.toCID().toString()}`;if((await fetch(c,{method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:a,signal:i})).status!==200)throw new b("PUT ipns response had status other than 200","ERR_BAD_RESPONSE")}finally{i.clear(),o.resolve(),Si("getIPNS finished: %c",e)}}#e(e){if(e.Schema==="peer")return e.ID=ae(e.ID),e.Addrs=e.Addrs.map(se),e.Protocols=e.Protocols??[],e;if(e.Schema==="bitswap")return{Schema:"peer",ID:ae(e.ID),Addrs:e.Addrs.map(se),Protocols:e.Protocol!=null?[e.Protocol]:[]};if(e.ID!=null&&Array.isArray(e.Addrs))return{Schema:"peer",ID:ae(e.ID),Addrs:e.Addrs.map(se),Protocols:Array.isArray(e.Protocols)?e.Protocols:[]}}#t(e,t){if(t.Schema==="peer"&&(t.ID=ae(t.ID),t.Addrs=t.Addrs.map(se),e.equals(t.ID)))return t}};function G_(r,e={}){return new sd(new URL(r),e)}var vK=J("dns4"),_K=J("dns6"),SK=J("dnsaddr"),$s=kt(J("dns"),SK,vK,_K),od=kt(J("ip4"),J("ip6")),wc=kt(pe(od,J("tcp")),pe($s,J("tcp"))),ad=pe(od,J("udp")),RK=pe(ad,J("utp")),IK=pe(ad,J("quic")),AK=pe(ad,J("quic-v1")),v4=kt(pe(wc,J("ws")),pe($s,J("ws"))),Ec=kt(pe(v4,J("p2p")),v4),_4=kt(pe(wc,J("wss")),pe($s,J("wss")),pe(wc,J("tls"),J("ws")),pe($s,J("tls"),J("ws"))),Qo=kt(pe(_4,J("p2p")),_4),S4=kt(pe(wc,J("http")),pe(od,J("http")),pe($s,J("http"))),R4=kt(pe(wc,J("https")),pe(od,J("https")),pe($s,J("https"))),Y_=pe(ad,J("webrtc-direct"),J("certhash")),j_=kt(pe(Y_,J("p2p")),Y_),Q_=pe(AK,J("webtransport"),J("certhash"),J("certhash")),Z_=kt(pe(Q_,J("p2p")),Q_),J_=kt(pe(Ec,J("p2p-webrtc-star"),J("p2p")),pe(Qo,J("p2p-webrtc-star"),J("p2p")),pe(Ec,J("p2p-webrtc-star")),pe(Qo,J("p2p-webrtc-star"))),q2e=kt(pe(Ec,J("p2p-websocket-star"),J("p2p")),pe(Qo,J("p2p-websocket-star"),J("p2p")),pe(Ec,J("p2p-websocket-star")),pe(Qo,J("p2p-websocket-star"))),eS=kt(pe(S4,J("p2p-webrtc-direct"),J("p2p")),pe(R4,J("p2p-webrtc-direct"),J("p2p")),pe(S4,J("p2p-webrtc-direct")),pe(R4,J("p2p-webrtc-direct"))),Xo=kt(v4,_4,S4,R4,J_,eS,wc,RK,IK,$s,j_,Z_),z2e=kt(pe(Xo,J("p2p-stardust"),J("p2p")),pe(Xo,J("p2p-stardust"))),zs=kt(pe(Xo,J("p2p")),J_,eS,j_,Z_,J("p2p")),X_=kt(pe(zs,J("p2p-circuit"),zs),pe(zs,J("p2p-circuit")),pe(J("p2p-circuit"),zs),pe(Xo,J("p2p-circuit")),pe(J("p2p-circuit"),Xo),J("p2p-circuit")),tS=()=>kt(pe(X_,tS),X_),ti=tS(),rS=kt(pe(ti,zs,ti),pe(zs,ti),pe(ti,zs),ti,zs);var $2e=kt(pe(ti,J("webrtc"),J("p2p")),pe(ti,J("webrtc")),pe(Xo,J("webrtc"),J("p2p")),pe(Xo,J("webrtc")),J("webrtc"));function nS(r){function e(t){let n;try{n=se(t)}catch{return!1}let i=r(n.protoNames());return i===null?!1:i===!0||i===!1?i:i.length===0}return e}function pe(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(i=>(n=typeof i=="function"?i().partialMatch(t):i.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:nS(e),partialMatch:e}}function kt(...r){function e(n){let i=null;return r.some(s=>{let o=typeof s=="function"?s().partialMatch(n):s.partialMatch(n);return o!=null?(i=o,!0):!1}),i}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:nS(e),partialMatch:e}}function J(r){let e=r;function t(i){let s;try{s=se(i)}catch{return!1}let o=s.protoNames();return o.length===1&&o[0]===e}function n(i){return i.length===0?null:i[0]===e?i.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}var cd=D("libp2p:bootstrap"),TK="bootstrap",DK=50,CK=12e4,PK=1e3,I4=class extends Fe{static tag="bootstrap";timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.timeout=t.timeout??PK,this.list=[];for(let n of t.list){if(!rS.matches(n)){cd.error("Invalid multiaddr");continue}let i=se(n),s=i.getPeerId();if(s==null){cd.error("Invalid bootstrap multiaddr without peer id");continue}let o={id:ae(s),multiaddrs:[i],protocols:[]};this.list.push(o)}this._init=t}[Po]=this;[Symbol.toStringTag]="@libp2p/bootstrap";isStarted(){return!!this.timer}start(){this.isStarted()||(cd("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{cd.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(let e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??TK]:{value:this._init.tagValue??DK,ttl:this._init.tagTTL??CK}}}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}};function sS(r){return e=>new I4(e,r)}var oS="/lan",aS="/ipfs",cS="/kad/1.0.0",lS="/dht/record",A4="/dht/provider";var ld=globalThis.CustomEvent??Event;async function*jo(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);let n=e.ordered==null?!1:e.ordered,i=new EventTarget,s=[],o=ge(),a=ge(),c=!1,l,u=!1;i.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(let p of r){if(s.length===t&&(o=ge(),await o.promise),u)break;let m={done:!1};s.push(m),p().then(g=>{m.done=!0,m.ok=!0,m.value=g,i.dispatchEvent(new ld("task-complete"))},g=>{m.done=!0,m.err=g,i.dispatchEvent(new ld("task-complete"))})}c=!0,i.dispatchEvent(new ld("task-complete"))}catch(p){l=p,i.dispatchEvent(new ld("task-complete"))}});function f(){return n?s[0]?.done:!!s.find(p=>p.done)}function*h(){for(;s.length>0&&s[0].done;){let p=s[0];if(s.shift(),p.ok)yield p.value;else throw u=!0,o.resolve(),p.err;o.resolve()}}function*d(){for(;f();)for(let p=0;p<s.length;p++)if(s[p].done){let m=s[p];if(s.splice(p,1),p--,m.ok)yield m.value;else throw u=!0,o.resolve(),m.err;o.resolve()}}for(;;){if(f()||(a=ge(),await a.promise),l!=null)throw l;if(n?yield*h():yield*d(),c&&s.length===0)break}}var bu;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={key:new Uint8Array(0),value:new Uint8Array(0),timeReceived:""},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.key=t.bytes();break;case 2:i.value=t.bytes();break;case 5:i.timeReceived=t.string();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(bu||(bu={}));function uS(r){let e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),i=String(r.getUTCHours()).padStart(2,"0"),s=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${i}:${s}:${o}.${c}Z`}function fS(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),i=parseInt(t[2],10)-1,s=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,i,s,o,a,c,l))}var tr=class r{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return bu.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:uS(this.timeReceived)}}static deserialize(e){let t=bu.decode(e);return new r(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){let t=fS(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new r(e.key,e.value,t)}};var hS;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.key=t.bytes();break;case 2:i.value=t.bytes();break;case 3:i.author=t.bytes();break;case 4:i.signature=t.bytes();break;case 5:i.timeReceived=t.string();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(hS||(hS={}));var Hs;(function(r){let e;(function(a){a.PUT_VALUE="PUT_VALUE",a.GET_VALUE="GET_VALUE",a.ADD_PROVIDER="ADD_PROVIDER",a.GET_PROVIDERS="GET_PROVIDERS",a.FIND_NODE="FIND_NODE",a.PING="PING"})(e=r.MessageType||(r.MessageType={}));let t;(function(a){a[a.PUT_VALUE=0]="PUT_VALUE",a[a.GET_VALUE=1]="GET_VALUE",a[a.ADD_PROVIDER=2]="ADD_PROVIDER",a[a.GET_PROVIDERS=3]="GET_PROVIDERS",a[a.FIND_NODE=4]="FIND_NODE",a[a.PING=5]="PING"})(t||(t={})),function(a){a.codec=()=>ht(t)}(e=r.MessageType||(r.MessageType={}));let n;(function(a){a.NOT_CONNECTED="NOT_CONNECTED",a.CONNECTED="CONNECTED",a.CAN_CONNECT="CAN_CONNECT",a.CANNOT_CONNECT="CANNOT_CONNECT"})(n=r.ConnectionType||(r.ConnectionType={}));let i;(function(a){a[a.NOT_CONNECTED=0]="NOT_CONNECTED",a[a.CONNECTED=1]="CONNECTED",a[a.CAN_CONNECT=2]="CAN_CONNECT",a[a.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(i||(i={})),function(a){a.codec=()=>ht(i)}(n=r.ConnectionType||(r.ConnectionType={}));let s;(function(a){let c;a.codec=()=>(c==null&&(c=fe((l,u,f={})=>{if(f.lengthDelimited!==!1&&u.fork(),l.id!=null&&(u.uint32(10),u.bytes(l.id)),l.addrs!=null)for(let h of l.addrs)u.uint32(18),u.bytes(h);l.connection!=null&&(u.uint32(24),r.ConnectionType.codec().encode(l.connection,u)),f.lengthDelimited!==!1&&u.ldelim()},(l,u)=>{let f={addrs:[]},h=u==null?l.len:l.pos+u;for(;l.pos<h;){let d=l.uint32();switch(d>>>3){case 1:f.id=l.bytes();break;case 2:f.addrs.push(l.bytes());break;case 3:f.connection=r.ConnectionType.codec().decode(l);break;default:l.skipType(d&7);break}}return f})),c),a.encode=l=>ue(l,a.codec()),a.decode=l=>le(l,a.codec())})(s=r.Peer||(r.Peer={}));let o;r.codec=()=>(o==null&&(o=fe((a,c,l={})=>{if(l.lengthDelimited!==!1&&c.fork(),a.type!=null&&(c.uint32(8),r.MessageType.codec().encode(a.type,c)),a.clusterLevelRaw!=null&&(c.uint32(80),c.int32(a.clusterLevelRaw)),a.key!=null&&(c.uint32(18),c.bytes(a.key)),a.record!=null&&(c.uint32(26),c.bytes(a.record)),a.closerPeers!=null)for(let u of a.closerPeers)c.uint32(66),r.Peer.codec().encode(u,c);if(a.providerPeers!=null)for(let u of a.providerPeers)c.uint32(74),r.Peer.codec().encode(u,c);l.lengthDelimited!==!1&&c.ldelim()},(a,c)=>{let l={closerPeers:[],providerPeers:[]},u=c==null?a.len:a.pos+c;for(;a.pos<u;){let f=a.uint32();switch(f>>>3){case 1:l.type=r.MessageType.codec().decode(a);break;case 10:l.clusterLevelRaw=a.int32();break;case 2:l.key=a.bytes();break;case 3:l.record=a.bytes();break;case 8:l.closerPeers.push(r.Peer.codec().decode(a,a.uint32()));break;case 9:l.providerPeers.push(r.Peer.codec().decode(a,a.uint32()));break;default:a.skipType(f&7);break}}return l})),o),r.encode=a=>ue(a,r.codec()),r.decode=a=>le(a,r.codec())})(Hs||(Hs={}));var Nt=Hs.MessageType,NK=Hs.ConnectionType,mS=Object.keys(Nt),_t=class r{type;key;clusterLevelRaw;closerPeers;providerPeers;record;constructor(e,t,n){if(!(t instanceof Uint8Array))throw new Error("Key must be a Uint8Array");this.type=e,this.key=t,this.clusterLevelRaw=n,this.closerPeers=[],this.providerPeers=[],this.record=void 0}get clusterLevel(){let e=this.clusterLevelRaw-1;return e<0?0:e}set clusterLevel(e){this.clusterLevelRaw=e}serialize(){return Hs.encode({key:this.key,type:this.type,clusterLevelRaw:this.clusterLevelRaw,closerPeers:this.closerPeers.map(dS),providerPeers:this.providerPeers.map(dS),record:this.record==null?void 0:this.record.serialize().subarray()})}static deserialize(e){let t=Hs.decode(e),n=new r(t.type??Hs.MessageType.PUT_VALUE,t.key??Uint8Array.from([]),t.clusterLevelRaw??0);return n.closerPeers=t.closerPeers.map(pS),n.providerPeers=t.providerPeers.map(pS),t.record?.length!=null&&(n.record=tr.deserialize(t.record)),n}};function dS(r){return{id:r.id.toBytes(),addrs:(r.multiaddrs??[]).map(t=>t.bytes),connection:NK.CONNECTED}}function pS(r){if(r.id==null)throw new Error("Invalid peer in message");return{id:it(r.id),multiaddrs:(r.addrs??[]).map(e=>se(e)),protocols:[]}}function T4(r,e={}){let t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:mS.indexOf(r.type.toString())};return e.onProgress?.(new Ge("kad-dht:query:send-query",{detail:t})),t}function wu(r,e={}){let t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer!=null?r.closer:[],providers:r.providers!=null?r.providers:[]};return e.onProgress?.(new Ge("kad-dht:query:peer-response",{detail:t})),t}function ud(r,e={}){let t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new Ge("kad-dht:query:final-peer",{detail:t})),t}function Ar(r,e={}){let t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new Ge("kad-dht:query:query-error",{detail:t})),t}function D4(r,e={}){let t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new Ge("kad-dht:query:provider",{detail:t})),t}function Eu(r,e={}){let t={...r,name:"VALUE",type:5};return e.onProgress?.(new Ge("kad-dht:query:value",{detail:t})),t}function C4(r,e={}){let t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new Ge("kad-dht:query:dial-peer",{detail:t})),t}function gS(r,e,t){if(t.length===0){let o="No records given";throw new b(o,"ERR_NO_RECORDS_RECEIVED")}let i=H(e).split("/");if(i.length<3){let o="Record key does not have a selector function";throw new b(o,"ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")}let s=r[i[1].toString()];if(s==null){let o=`No selector function configured for key type "${i[1]}"`;throw new b(o,"ERR_UNRECOGNIZED_KEY_PREFIX")}return t.length===1?0:s(e,t)}function OK(r,e){return 0}var yS={pk:OK};async function xc(r,e){let t=e.key,i=H(t).split("/");if(i.length<3)return;let s=r[i[1].toString()];if(s==null){let o=`No validator available for key type "${i[1]}"`;throw new b(o,"ERR_INVALID_RECORD_KEY_TYPE")}await s(t,e.value)}var LK=async(r,e)=>{if(!(r instanceof Uint8Array))throw new b('"key" must be a Uint8Array',"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(r.byteLength<5)throw new b("invalid public key record","ERR_INVALID_RECORD_KEY_TOO_SHORT");if(H(r.subarray(0,4))!=="/pk/")throw new b("key was not prefixed with /pk/","ERR_INVALID_RECORD_KEY_BAD_PREFIX");let n=r.slice(4),i=await Oe.digest(e);if(!ce(n,i.bytes))throw new b("public key does not match passed in key","ERR_INVALID_RECORD_HASH_MISMATCH")},bS={pk:LK};var BK=Y("/pk/");function vc(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{let[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;let i=Br(n);return i==null?!0:!i})}}function _c(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{let[[t,n]]=e.stringTuples();if(n==="localhost")return!0;if(t!==4&&t!==6||n==null)return!1;let i=Br(n);return i??!1})}}async function Ws(r){return(await Oe.digest(r)).digest}async function ri(r){return Ws(r.toBytes())}function Ji(r){return new tt(`${lS}/${H(r,"base32")}`,!1)}function wS(r){return ve([BK,r.toBytes()])}function ES(r){return H(r.subarray(0,4))==="/pk/"}function xS(r){return it(r.subarray(4))}function P4(r,e){let t=new Date;return new tr(r,e,t).serialize()}function vS(r,e=100){let t;return()=>{clearTimeout(t),t=setTimeout(()=>{r()},e)}}var fd=class{log;components;validators;selectors;peerRouting;queryManager;network;constructor(e,t){let{validators:n,selectors:i,peerRouting:s,queryManager:o,network:a,lan:c}=t;this.components=e,this.log=D(`libp2p:kad-dht:${c?"lan":"wan"}:content-fetching`),this.validators=n,this.selectors=i,this.peerRouting=s,this.queryManager=o,this.network=a}async putLocal(e,t){let n=Ji(e);await this.components.datastore.put(n,t)}async getLocal(e){this.log("getLocal %b",e);let t=Ji(e);this.log("fetching record for key %k",t);let n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);let i=tr.deserialize(n);return await xc(this.validators,i),i}async*sendCorrectionRecord(e,t,n,i={}){this.log("sendCorrection for %b",e);let s=P4(e,n);for(let{value:o,from:a}of t){if(ce(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{let u=Ji(e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,s.subarray())}catch(u){this.log.error("Failed error correcting self",u)}continue}let c=!1,l=new _t(Nt.PUT_VALUE,e,0);l.record=tr.deserialize(s);for await(let u of this.network.sendRequest(a,l,i))u.name==="PEER_RESPONSE"&&u.record!=null&&ce(u.record.value,tr.deserialize(s).value)&&(c=!0),yield u;c||(yield Ar({from:a,error:new b("value not put correctly","ERR_PUT_VALUE_INVALID")},i)),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);let i=P4(e,t),s=Ji(e);this.log(`storing record for key ${s.toString()}`),await this.components.datastore.put(s,i.subarray()),yield*Te(this.peerRouting.getClosestPeers(e,{signal:n.signal}),o=>zr(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];let c=[],l=new _t(Nt.PUT_VALUE,e,0);l.record=tr.deserialize(i),this.log("send put to %p",a.peer.id);for await(let u of this.network.sendRequest(a.peer.id,l,n))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&ce(u.record.value,tr.deserialize(i).value)||c.push(Ar({from:a.peer.id,error:new b("value not put correctly","ERR_PUT_VALUE_INVALID")},n)));return c}),o=>jo(o,{ordered:!1,concurrency:3}),async function*(o){for await(let a of o)yield*a})}async*get(e,t={}){this.log("get %b",e);let n=[];for await(let a of this.getMany(e,t))a.name==="VALUE"&&n.push(a),yield a;if(n.length===0)return;let i=n.map(a=>a.value),s=0;try{s=gS(this.selectors,e,i)}catch(a){if(a.code!=="ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")throw a}let o=i[s];if(this.log("GetValue %b %b",e,o),o==null)throw new b("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,n,o,t),yield n[s]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{let s=await this.getLocal(e);yield Eu({value:s.value,from:this.components.peerId},t)}catch(s){this.log("error getting local value for %b",e,s)}let n=this,i=async function*({peer:s,signal:o}){for await(let a of n.peerRouting.getValueOrPeers(s,e,{signal:o}))yield a,a.name==="PEER_RESPONSE"&&a.record!=null&&(yield Eu({from:s,value:a.record.value},t))};yield*this.queryManager.run(e,i,t)}};var hd=class{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){let{network:n,peerRouting:i,queryManager:s,routingTable:o,providers:a,lan:c}=t;this.components=e,this.log=D(`libp2p:kad-dht:${c?"lan":"wan"}:content-routing`),this.network=n,this.peerRouting=i,this.queryManager=s,this.routingTable=o,this.providers=a}async*provide(e,t,n={}){this.log("provide %s",e),await this.providers.addProvider(e,this.components.peerId);let i=new _t(Nt.ADD_PROVIDER,e.multihash.bytes,0);i.providerPeers=[{id:this.components.peerId,multiaddrs:t,protocols:[]}];let s=0,o=a=>async()=>{if(a.name!=="FINAL_PEER")return[a];let c=[];this.log("putProvider %s to %p",e,a.peer.id);try{this.log("sending provider record for %s to %p",e,a.peer.id);for await(let l of this.network.sendMessage(a.peer.id,i,n))l.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",e,a.peer.id),s++),c.push(l)}catch(l){this.log.error("error sending provide record to peer %p",a.peer.id,l),c.push(Ar({from:a.peer.id,error:l},n))}return c};yield*Te(this.peerRouting.getClosestPeers(e.multihash.bytes,n),a=>zr(a,c=>o(c)),a=>jo(a,{ordered:!1,concurrency:3}),async function*(a){for await(let c of a)yield*c}),this.log("sent provider records to %d peers",s)}async*findProviders(e,t){let n=this.routingTable.kBucketSize,i=e.multihash.bytes,s=this;this.log("findProviders %c",e);let o=await this.providers.getProviders(e);if(o.length>0){let l=[];for(let u of o.slice(0,n))try{let f=await this.components.peerStore.get(u);l.push({id:u,multiaddrs:f.addresses.map(({multiaddr:h})=>h),protocols:f.protocols})}catch(f){if(f.code!=="ERR_NOT_FOUND")throw f;this.log("no peer store entry for %p",u)}yield wu({from:this.components.peerId,messageType:Nt.GET_PROVIDERS,providers:l},t),yield D4({from:this.components.peerId,providers:l},t)}if(o.length>=n)return;let a=async function*({peer:l,signal:u}){let f=new _t(Nt.GET_PROVIDERS,i,0);yield*s.network.sendRequest(l,f,{...t,signal:u})},c=new Set(o.map(l=>l.toString()));for await(let l of this.queryManager.run(i,a,t))if(yield l,l.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",l.providers.length,e,l.closer.length);let u=[];for(let f of l.providers)c.has(f.id.toString())||(c.add(f.id.toString()),u.push(f));if(u.length>0&&(yield D4({from:l.from,providers:u},t)),c.size===n)return}}};var dd=class extends Fe{log;protocol;running;components;constructor(e,t){super();let{protocol:n,lan:i}=t;this.components=e,this.log=D(`libp2p:kad-dht:${i?"lan":"wan"}:network`),this.running=!1,this.protocol=n}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n={}){if(!this.running)return;this.log("sending %s to %p",t.type,e),yield C4({peer:e},n),yield T4({to:e,type:t.type},n);let i;try{let o=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),a=await this._writeReadMessage(o,t.serialize(),n);yield wu({from:e,messageType:a.type,closer:a.closerPeers,providers:a.providerPeers,record:a.record},n)}catch(s){yield Ar({from:e,error:s},n)}finally{i!=null&&await i.close()}}async*sendMessage(e,t,n={}){if(!this.running)return;this.log("sending %s to %p",t.type,e),yield C4({peer:e},n),yield T4({to:e,type:t.type},n);let i;try{let o=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n);await this._writeMessage(o,t.serialize(),n),yield wu({from:e,messageType:t.type},n)}catch(s){yield Ar({from:e,error:s},n)}finally{i!=null&&await i.close()}}async _writeMessage(e,t,n){n.signal!=null&&(e=m3(e,n.signal)),await Te([t],i=>Rt(i),e,Cr)}async _writeReadMessage(e,t,n){n.signal!=null&&(e=m3(e,n.signal));let i=await Te([t],o=>Rt(o),e,o=>vt(o),async o=>{let a=await rn(o);if(a!=null)return a;throw new b("No message received","ERR_NO_MESSAGE_RECEIVED")}),s=_t.deserialize(i);return s.closerPeers.forEach(o=>{this.dispatchEvent(new Ge("peer",{detail:o}))}),s.providerPeers.forEach(o=>{this.dispatchEvent(new Ge("peer",{detail:o}))}),s}};var pd=class{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peerId)}async add(e){if(this.peerDistances.find(i=>i.peerId.equals(e))!=null)return;let t=await ri(e),n={peerId:e,distance:ji(this.originDhtKey,t)};this.peerDistances.push(n),this.peerDistances.sort((i,s)=>zh(i.distance,s.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async anyCloser(e){if(e.length===0)return!1;if(this.length===0)return!0;let t=await Promise.all(e.map(ri)),n=this.peerDistances[this.peerDistances.length-1].distance;for(let i of t){let s=ji(this.originDhtKey,i);if(zh(s,n)<0)return!0}return!1}};var md=class{components;log;routingTable;network;validators;queryManager;constructor(e,t){let{routingTable:n,network:i,validators:s,queryManager:o,lan:a}=t;this.components=e,this.routingTable=n,this.network=i,this.validators=s,this.queryManager=o,this.log=D(`libp2p:kad-dht:${a?"lan":"wan"}:peer-routing`)}async findPeerLocal(e){let t,n=await this.routingTable.find(e);if(n!=null){this.log("findPeerLocal found %p in routing table",e);try{t=await this.components.peerStore.get(n)}catch(i){if(i.code!=="ERR_NOT_FOUND")throw i}}if(t==null)try{t=await this.components.peerStore.get(e)}catch(i){if(i.code!=="ERR_NOT_FOUND")throw i}if(t!=null)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(i=>i.multiaddr),protocols:[]}}async*_getValueSingle(e,t,n={}){let i=new _t(Nt.GET_VALUE,t,0);yield*this.network.sendRequest(e,i,n)}async*getPublicKeyFromNode(e,t={}){let n=wS(e);for await(let i of this._getValueSingle(e,n,t))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){let s=await ar(kf.marshalPublicKey({bytes:i.record.value}));if(!s.equals(e))throw new b("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(s.publicKey==null)throw new b("public key missing","ERR_PUBLIC_KEY_MISSING");yield Eu({from:e,value:s.publicKey},t)}throw new b(`Node not responding with its public key: ${e.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(e,t={}){this.log("findPeer %p",e);let n=await this.findPeerLocal(e);if(n!=null){this.log("found local"),yield ud({from:this.components.peerId,peer:n},t);return}let i=this,s=async function*({peer:a,signal:c}){let l=new _t(Nt.FIND_NODE,e.toBytes(),0);for await(let u of i.network.sendRequest(a,l,{...t,signal:c}))if(yield u,u.name==="PEER_RESPONSE"){let f=u.closer.find(h=>h.id.equals(e));f!=null&&(yield ud({from:u.from,peer:f},t))}},o=!1;for await(let a of this.queryManager.run(e.toBytes(),s,t))a.name==="FINAL_PEER"&&(o=!0),yield a;o||(yield Ar({from:this.components.peerId,error:new b("Not found","ERR_NOT_FOUND")},t))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);let n=await Ws(e),i=this.routingTable.closestPeers(n),s=this,o=new pd(n,this.routingTable.kBucketSize);await Promise.all(i.map(async c=>{await o.add(c)}));let a=async function*({peer:c,signal:l}){s.log("closerPeersSingle %s from %p",H(e,"base32"),c);let u=new _t(Nt.FIND_NODE,e,0);yield*s.network.sendRequest(c,u,{...t,signal:l})};for await(let c of this.queryManager.run(e,a,t))yield c,c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async l=>{await o.add(l.id)}));this.log("found %d peers close to %b",o.length,e);for(let c of o.peers)try{let l=await this.components.peerStore.get(c);yield ud({from:this.components.peerId,peer:{id:c,multiaddrs:l.addresses.map(({multiaddr:u})=>u),protocols:l.protocols}},t)}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}}async*getValueOrPeers(e,t,n={}){for await(let i of this._getValueSingle(e,t,n)){if(i.name==="PEER_RESPONSE"&&i.record!=null)try{await this._verifyRecordOnline(i.record)}catch{let o="invalid record received, discarded";this.log(o),yield Ar({from:i.from,error:new b(o,"ERR_INVALID_RECORD")},n);continue}yield i}}async _verifyRecordOnline(e){if(e.timeReceived==null)throw new b("invalid record received","ERR_INVALID_RECORD");await xc(this.validators,new tr(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){let n=await Ws(e),i=this.routingTable.closestPeers(n),s=[];for(let o of i)if(!o.equals(t))try{let a=await this.components.peerStore.get(o);s.push({id:o,multiaddrs:a.addresses.map(({multiaddr:c})=>c),protocols:a.protocols})}catch(a){if(a.code!=="ERR_NOT_FOUND")throw a}return s.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",s.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p",e,t),s}};var RS=de(SS(),1);var es=D("libp2p:kad-dht:providers"),gd=class{components;cache;cleanupInterval;provideValidity;syncQueue;started;cleaner;constructor(e,t={}){let{cacheSize:n,cleanupInterval:i,provideValidity:s}=t;this.components=e,this.cleanupInterval=i??36e5,this.provideValidity=s??864e5,this.cache=(0,RS.default)(n??256),this.syncQueue=new Ft({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval(()=>{this._cleanup().catch(e=>{es.error(e)})},this.cleanupInterval))}async stop(){this.started=!1,this.cleaner!=null&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add(async()=>{let e=Date.now(),t=0,n=0,i=new Map,s=this.components.datastore.batch(),o=this.components.datastore.query({prefix:A4});for await(let a of o)try{let{cid:c,peerId:l}=IS(a.key),u=AS(a.value).getTime(),f=Date.now(),h=f-u,d=h>this.provideValidity;if(es("comparing: %d - %d = %d > %d %s",f,u,h,this.provideValidity,d?"(expired)":""),d){n++,s.delete(a.key);let p=i.get(c)??new Set;p.add(l),i.set(c,p)}t++}catch(c){es.error(c.message)}i.size>0?(es("deleting %d / %d entries",n,t),await s.commit()):es("nothing to delete");for(let[a,c]of i){let l=xu(a),u=this.cache.get(l);if(u!=null){for(let f of c)u.delete(f);u.size===0?this.cache.remove(l):this.cache.set(l,u)}}es("Cleanup successful (%dms)",Date.now()-e)})}async _getProvidersMap(e){let t=xu(e),n=this.cache.get(t);return n==null&&(n=await VK(this.components.datastore,e),this.cache.set(t,n)),n}async addProvider(e,t){await this.syncQueue.add(async()=>{es("%p provides %s",t,e);let n=await this._getProvidersMap(e);es("loaded %s provs",n.size);let i=new Date;n.set(t.toString(),i);let s=xu(e);this.cache.set(s,n),await KK(this.components.datastore,e,t,i)})}async getProviders(e){return this.syncQueue.add(async()=>(es("get providers for %s",e),[...(await this._getProvidersMap(e)).keys()].map(n=>ae(n))),{throwOnTimeout:!0})}};function xu(r){let e=typeof r=="string"?r:H(r.multihash.bytes,"base32");return`${A4}/${e}`}async function KK(r,e,t,n){let i=[xu(e),"/",t.toString()].join(""),s=new tt(i),o=Ht(n.getTime());await r.put(s,o)}function IS(r){let e=r.toString().split("/");if(e.length!==5)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:e[3],peerId:e[4]}}async function VK(r,e){let t=new Map,n=r.query({prefix:xu(e)});for await(let i of n){let{peerId:s}=IS(i.key);t.set(s,AS(i.value))}return t}function AS(r){return new Date($r(r))}var qK=BigInt("0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");async function*TS(r){let{key:e,startingPeer:t,ourPeerId:n,signal:i,query:s,alpha:o,pathIndex:a,numPaths:c,cleanUp:l,queryFuncTimeout:u,log:f,peersSeen:h}=r,d=new Ft({concurrency:o}),p=await Ws(e);function m(g,y){if(g==null)return;h.add(g);let w=BigInt("0x"+H(ji(y,p),"base16"));d.add(async()=>{let E=[i];u!=null&&E.push(AbortSignal.timeout(u));let R=xt(E);try{for await(let x of s({key:e,peer:g,signal:R,pathIndex:a,numPaths:c})){if(R.aborted)return;if(x.name==="PEER_RESPONSE")for(let v of x.closer){if(h.has(v.id)){f("already seen %p in query",v.id);continue}if(n.equals(v.id)){f("not querying ourselves");continue}let I=await ri(v.id);if(BigInt("0x"+H(ji(I,p),"base16"))>w){f("skipping %p as they are not closer to %b than %p",v.id,e,g);continue}f("querying closer peer %p",v.id),m(v.id,I)}d.emit("completed",x)}}catch(x){if(!i.aborted)return Ar({from:g,error:x},r)}finally{R.clear()}},{priority:qK-w}).catch(E=>{f.error(E)})}m(t,await ri(t)),yield*zK(d,i,l,f)}async function*zK(r,e,t,n){let i=ge(),s=!0,o=[],a=()=>{s&&(n("clean up queue, results %d, queue size %d, pending tasks %d",o.length,r.size,r.pending),s=!1,r.clear(),o.splice(0,o.length))};for(r.on("completed",c=>{o.push(c),i.resolve()}),r.on("error",c=>{n("queue error",c),a(),i.reject(c)}),r.on("idle",()=>{n("queue idle"),s=!1,i.resolve()}),e.addEventListener("abort",()=>{n("abort queue");let c=s;a(),c&&i.reject(new b("Query aborted","ERR_QUERY_ABORTED"))}),t.addEventListener("cleanup",()=>{a(),i.resolve()});s;)for(await i.promise,i=ge();o.length>0;){let c=o.shift();c!=null&&(yield c)}yield*o}var bd=class{components;lan;disjointPaths;alpha;shutDownController;running;queries;metrics;routingTable;initialQuerySelfHasRun;constructor(e,t){let{lan:n=!1,disjointPaths:i=20,alpha:s=3}=t;this.components=e,this.disjointPaths=i??20,this.running=!1,this.alpha=s??3,this.lan=n,this.queries=0,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.shutDownController=new AbortController,nt(1/0,this.shutDownController.signal)}isStarted(){return this.running}async start(){this.running=!0,this.components.metrics!=null&&this.metrics==null&&(this.metrics={runningQueries:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_running_queries`),queryTime:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_query_time_seconds`)})}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");let i=this.metrics?.queryTime.timer();n.signal==null&&(n.signal=AbortSignal.timeout(3e4),nt(1/0,n.signal));let s=xt([this.shutDownController.signal,n.signal]);nt(1/0,s);let o=D(`libp2p:kad-dht:${this.lan?"lan":"wan"}:query:`+H(e,"base58btc")),a=Date.now(),c=new Fe;try{n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(o("waiting for initial query-self query before continuing"),await Promise.race([new Promise((p,m)=>{s.addEventListener("abort",()=>{m(new Bn("Query was aborted before self-query ran"))})}),this.initialQuerySelfHasRun.promise]),this.initialQuerySelfHasRun=void 0),o("query:start"),this.queries++,this.metrics?.runningQueries.update(this.queries);let l=await Ws(e),u=this.routingTable.closestPeers(l),f=u.slice(0,Math.min(this.disjointPaths,u.length));if(u.length===0){o.error("Running query with no peers");return}let h=new _n,d=f.map((p,m)=>TS({key:e,startingPeer:p,ourPeerId:this.components.peerId,signal:s,query:t,pathIndex:m,numPaths:f.length,alpha:this.alpha,cleanUp:c,queryFuncTimeout:n.queryFuncTimeout,log:o,peersSeen:h,onProgress:n.onProgress}));for await(let p of Ut(...d))yield p,p.name==="QUERY_ERROR"&&o("error",p.error)}catch(l){if(!(!this.running&&l.code==="ERR_QUERY_ABORTED"))throw l}finally{s.clear(),this.queries--,this.metrics?.runningQueries.update(this.queries),i?.(),c.dispatchEvent(new Ge("cleanup")),o("query:done in %dms",Date.now()-a)}}};function HK(r){return r[Symbol.asyncIterator]!=null}function WK(r){if(HK(r))return(async()=>{let e=0;for await(let t of r)e++;return e})();{let e=0;for(let t of r)e++;return e}}var wd=WK;var GK=r=>{let e=r.on||r.addListener||r.addEventListener,t=r.off||r.removeListener||r.removeEventListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function YK(r,e,t){let n,i=new Promise((s,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:u}=GK(r),f=(...d)=>{let p=t.multiArgs?d:d[0];t.filter&&!t.filter(p)||(c.push(p),t.count===c.length&&(n(),s(c)))},h=d=>{n(),o(d)};n=()=>{for(let d of a)u(d,f);for(let d of t.rejectionEvents)u(d,h)};for(let d of a)l(d,f);for(let d of t.rejectionEvents)l(d,h);t.signal&&t.signal.addEventListener("abort",()=>{h(t.signal.reason)},{once:!0}),t.resolveImmediately&&s(c)});if(i.cancel=n,typeof t.timeout=="number"){let s=Vn(i,{milliseconds:t.timeout});return s.cancel=n,s}return i}function DS(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=YK(r,e,t),i=n.then(s=>s[0]);return i.cancel=n.cancel,i}var Ed=class{log;components;peerRouting;routingTable;count;interval;initialInterval;queryTimeout;started;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){let{peerRouting:n,lan:i,count:s,interval:o,queryTimeout:a,routingTable:c}=t;this.components=e,this.log=D(`libp2p:kad-dht:${i?"lan":"wan"}:query-self`),this.started=!1,this.peerRouting=n,this.routingTable=c,this.count=s??20,this.interval=o??3e5,this.initialInterval=t.initialInterval??1e3,this.queryTimeout=a??5e3,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun}isStarted(){return this.started}start(){this.started||(this.started=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.started=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.started){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=ge(),this.started){this.controller=new AbortController;let e=xt([this.controller.signal,AbortSignal.timeout(this.queryTimeout)]);nt(1/0,e);try{this.routingTable.size===0&&(this.log("routing table was empty, waiting for some peers before running query"),await DS(this.routingTable,"peer:add",{signal:e})),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);let t=Date.now(),n=await Te(this.peerRouting.getClosestPeers(this.components.peerId.toBytes(),{signal:e,isSelfQuery:!0}),i=>os(i,this.count),async i=>wd(i));this.log("self-query found %d peers in %dms",n,Date.now()-t)}catch(t){this.log.error("self-query error",t)}finally{e.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.started&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}};function CS(r,e){if(r===e)return!0;if(r.length!==e.length)return!1;for(let t=0,n=r.length;t<n;++t)if(r[t]!==e[t])return!1;return!0}function N4(){return{contacts:[],dontSplit:!1,left:null,right:null}}function vu(r,e){if(!(e instanceof Uint8Array))throw new TypeError(r+" is not a Uint8Array")}var xd=class r extends Fe{localNodeId;root;numberOfNodesPerKBucket;numberOfNodesToPing;distance;arbiter;constructor(e){super(),this.localNodeId=e.localNodeId,this.numberOfNodesPerKBucket=e.numberOfNodesPerKBucket??20,this.numberOfNodesToPing=e.numberOfNodesToPing??3,this.distance=e.distance??r.distance,this.arbiter=e.arbiter??r.arbiter,vu("option.localNodeId as parameter 1",this.localNodeId),this.root=N4()}static arbiter(e,t){return(e.vectorClock??0)>(t.vectorClock??0)?e:t}static distance(e,t){let n=0,i=0,s=Math.min(e.length,t.length),o=Math.max(e.length,t.length);for(;i<s;++i)n=n*256+(e[i]^t[i]);for(;i<o;++i)n=n*256+255;return n}add(e){vu("contact.id",e?.id);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e.id,t++);let i=this._indexOf(n,e.id);return i>=0?(this._update(n,i,e),this):n.contacts.length<this.numberOfNodesPerKBucket?(n.contacts.push(e),this.safeDispatchEvent("added",{detail:e}),this):n.dontSplit?(this.safeDispatchEvent("ping",{detail:{oldContacts:n.contacts.slice(0,this.numberOfNodesToPing),newContact:e}}),this):(this._split(n,t),this.add(e))}closest(e,t=1/0){if(vu("id",e),!Number.isInteger(t)&&t!==1/0||t<=0)throw new TypeError("n is not positive number");let n=[];for(let i=[this.root],s=0;i.length>0&&n.length<t;){let o=i.pop();if(o!=null)if(o.contacts===null){let a=this._determineNode(o,e,s++);i.push(o.left===a?o.right:o.left),i.push(a)}else n=n.concat(o.contacts)}return n.map(i=>({distance:this.distance(i.id,e),contact:i})).sort((i,s)=>i.distance-s.distance).slice(0,t).map(i=>i.contact)}count(){let e=0;for(let t=[this.root];t.length>0;){let n=t.pop();n!=null&&(n.contacts===null?t.push(n.right,n.left):e+=n.contacts.length)}return e}_determineNode(e,t,n){let i=n>>3,s=n%8;return t.length<=i&&s!==0?e.left:t[i]&1<<7-s?e.right:e.left}get(e){vu("id",e);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e,t++);let i=this._indexOf(n,e);return i>=0?n.contacts[i]:void 0}_indexOf(e,t){for(let n=0;n<e.contacts.length;++n)if(CS(e.contacts[n].id,t))return n;return-1}remove(e){vu("the id as parameter 1",e);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e,t++);let i=this._indexOf(n,e);if(i>=0){let s=n.contacts.splice(i,1)[0];this.safeDispatchEvent("removed",{detail:s})}return this}_split(e,t){e.left=N4(),e.right=N4();for(let s of e.contacts)this._determineNode(e,s.id,t).contacts.push(s);e.contacts=null;let n=this._determineNode(e,this.localNodeId,t),i=e.left===n?e.right:e.left;i.dontSplit=!0}toArray(){let e=[];for(let t=[this.root];t.length>0;){let n=t.pop();n!=null&&(n.contacts===null?t.push(n.right,n.left):e=e.concat(n.contacts))}return e}*toIterable(){for(let e=[this.root];e.length>0;){let t=e.pop();t!=null&&(t.contacts===null?e.push(t.right,t.left):yield*t.contacts)}}_update(e,t,n){if(!CS(e.contacts[t].id,n.id))throw new Error("wrong index for _update");let i=e.contacts[t],s=this.arbiter(i,n);s===i&&i!==n||(e.contacts.splice(t,1),e.contacts.push(s),this.safeDispatchEvent("updated",{detail:{incumbent:i,selection:s}}))}};var ZK="kad-close",JK=50,PS=20,eV=1e4,tV=10,vd=class extends Fe{kBucketSize;kb;pingQueue;log;components;lan;pingTimeout;pingConcurrency;running;protocol;tagName;tagValue;metrics;constructor(e,t){super();let{kBucketSize:n,pingTimeout:i,lan:s,pingConcurrency:o,protocol:a,tagName:c,tagValue:l}=t;this.components=e,this.log=D(`libp2p:kad-dht:${s?"lan":"wan"}:routing-table`),this.kBucketSize=n??PS,this.pingTimeout=i??eV,this.pingConcurrency=o??tV,this.lan=s,this.running=!1,this.protocol=a,this.tagName=c??ZK,this.tagValue=l??JK;let u=()=>{this.metrics?.pingQueueSize.update(this.pingQueue.size),this.metrics?.pingRunning.update(this.pingQueue.pending)};this.pingQueue=new Ft({concurrency:this.pingConcurrency}),this.pingQueue.addListener("add",u),this.pingQueue.addListener("next",u),this._onPing=this._onPing.bind(this)}isStarted(){return this.running}async start(){this.running=!0,this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_routing_table_size`),pingQueueSize:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_ping_queue_size`),pingRunning:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_ping_running`)});let e=new xd({localNodeId:await ri(this.components.peerId),numberOfNodesPerKBucket:this.kBucketSize,numberOfNodesToPing:1});this.kb=e,e.addEventListener("ping",this._onPing),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let t=new _n,n=vS(()=>{let i=new _n(e.closest(e.localNodeId,PS).map(a=>a.peer)),s=i.difference(t),o=t.difference(i);Promise.resolve().then(async()=>{for(let a of s)await this.components.peerStore.merge(a,{tags:{[this.tagName]:{value:this.tagValue}}});for(let a of o)await this.components.peerStore.merge(a,{tags:{[this.tagName]:void 0}})}).catch(a=>{this.log.error("Could not update peer tags",a)}),t=i});e.addEventListener("added",i=>{n(),this.safeDispatchEvent("peer:add",{detail:i.detail.peer})}),e.addEventListener("removed",i=>{n(),this.safeDispatchEvent("peer:remove",{detail:i.detail.peer})})}_onPing(e){let{oldContacts:t,newContact:n}=e.detail;this.pingQueue.add(async()=>{if(!this.running)return;let i=0;try{await Promise.all(t.map(async s=>{try{let o={signal:AbortSignal.timeout(this.pingTimeout)};this.log("pinging old contact %p",s.peer),await(await(await this.components.connectionManager.openConnection(s.peer,o)).newStream(this.protocol,o)).close(),i++}catch(o){this.running&&this.kb!=null&&(this.log.error("could not ping peer %p",s.peer,o),this.log("evicting old contact after ping failed %p",s.peer),this.kb.remove(s.id))}finally{this.metrics?.routingTableSize.update(this.size)}})),this.running&&i<t.length&&this.kb!=null&&(this.log("adding new contact %p",n.peer),this.kb.add(n))}catch(s){this.log.error("could not process k-bucket ping event",s)}}).catch(i=>{this.log.error("could not process k-bucket ping event",i)})}get size(){return this.kb==null?0:this.kb.count()}async find(e){let t=await ri(e),n=this.closestPeer(t);if(n!=null&&e.equals(n))return n}closestPeer(e){let t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t=this.kBucketSize){return this.kb==null?[]:this.kb.closest(e,t).map(i=>i.peer)}async add(e){if(this.kb==null)throw new Error("RoutingTable is not started");let t=await ri(e);this.kb.add({id:t,peer:e}),this.log("added %p with kad id %b",e,t),this.metrics?.routingTableSize.update(this.size)}async remove(e){if(this.kb==null)throw new Error("RoutingTable is not started");let t=await ri(e);this.kb.remove(t),this.metrics?.routingTableSize.update(this.size)}};var kS=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];var _d=15,Sd=class{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e){let{peerRouting:t,routingTable:n,refreshInterval:i,refreshQueryTimeout:s,lan:o}=e;this.log=D(`libp2p:kad-dht:${o?"lan":"wan"}:routing-table:refresh`),this.peerRouting=t,this.routingTable=n,this.refreshInterval=i??3e5,this.refreshQueryTimeout=s??3e4,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async start(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");let t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(n.map(async(i,s)=>{try{if(await this._refreshCommonPrefixLength(s,i,e),this._numPeersForCpl(t)===0){let o=Math.min(2*(s+1),n.length-1);for(let a=s+1;a<o+1;a++)try{await this._refreshCommonPrefixLength(a,i,e)}catch(c){this.log.error(c)}}}catch(o){this.log.error(o)}})).catch(i=>{this.log.error(i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error(i)})}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}let i=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);let s=await wd(this.peerRouting.getClosestPeers(i.toBytes(),{signal:AbortSignal.timeout(this.refreshQueryTimeout)}));this.log(`found ${s} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(e){e>_d&&(e=_d);let t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");let t=Or(2),n=(t[1]<<8)+t[0],i=await this._makePeerId(this.routingTable.kb.localNodeId,n,e);return it(i)}async _makePeerId(e,t,n){if(n>_d)throw new Error(`Cannot generate peer ID for common prefix length greater than ${_d}`);let o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=o&a|t&~a,l=kS[c],u=new ArrayBuffer(34),f=new DataView(u,0,u.byteLength);return f.setUint8(0,Oe.code),f.setUint8(1,32),f.setUint32(2,l,!1),new Uint8Array(f.buffer,f.byteOffset,f.byteLength)}_maxCommonPrefix(){let e=0;for(let t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(let n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb!=null)for(let{id:e}of this.routingTable.kb.toIterable()){let t=ji(this.routingTable.kb.localNodeId,e),n=0;for(let i of t)if(i===0)n++;else break;yield n}}};var _u=D("libp2p:kad-dht:rpc:handlers:add-provider"),Rd=class{providers;constructor(e){let{providers:t}=e;this.providers=t}async handle(e,t){if(_u("start"),t.key==null||t.key.length===0)throw new b("Missing key","ERR_MISSING_KEY");let n;try{n=be.decode(t.key)}catch{throw new b("Invalid CID","ERR_INVALID_CID")}(t.providerPeers==null||t.providerPeers.length===0)&&_u.error("no providers found in message"),await Promise.all(t.providerPeers.map(async i=>{if(!i.id.equals(e)){_u("invalid provider peer %p from %p",i.id,e);return}if(i.multiaddrs.length<1){_u("no valid addresses for provider %p. Ignore",e);return}_u("received provider %p for %s (addrs %s)",e,n,i.multiaddrs.map(s=>s.toString())),await this.providers.addProvider(n,i.id)}))}};var NS=D("libp2p:kad-dht:rpc:handlers:find-node"),Id=class{peerRouting;lan;components;constructor(e,t){let{peerRouting:n,lan:i}=t;this.components=e,this.peerRouting=n,this.lan=!!i}async handle(e,t){NS("incoming request from %p for peers closer to %b",e,t.key);let n=[];ce(this.components.peerId.toBytes(),t.key)?n=[{id:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map(s=>s.decapsulateCode(ye("p2p").code)),protocols:[]}]:n=await this.peerRouting.getCloserPeersOffline(t.key,e),n=n.map(this.lan?_c:vc).filter(({multiaddrs:s})=>s.length);let i=new _t(t.type,new Uint8Array(0),t.clusterLevel);return n.length>0?i.closerPeers=n:NS("could not find any peers closer to %b than %p",t.key,e),i}};var OS=D("libp2p:kad-dht:rpc:handlers:get-providers"),Ad=class{components;peerRouting;providers;lan;constructor(e,t){let{peerRouting:n,providers:i,lan:s}=t;this.components=e,this.peerRouting=n,this.providers=i,this.lan=!!s}async handle(e,t){let n;try{n=be.decode(t.key)}catch{throw new b("Invalid CID","ERR_INVALID_CID")}OS("%p asking for providers for %s",e,n);let[i,s]=await Promise.all([this.providers.getProviders(n),this.peerRouting.getCloserPeersOffline(t.key,e)]),o=await this._getPeers(i),a=await this._getPeers(s.map(({id:l})=>l)),c=new _t(t.type,t.key,t.clusterLevel);return o.length>0&&(c.providerPeers=o),a.length>0&&(c.closerPeers=a),OS("got %s providers %s closerPeers",o.length,a.length),c}async _getAddresses(e){return[]}async _getPeers(e){let t=[],n=this.lan?_c:vc;for(let i of e)try{let s=await this.components.peerStore.get(i),o=n({id:i,multiaddrs:s.addresses.map(({multiaddr:a})=>a),protocols:s.protocols});o.multiaddrs.length>0&&t.push(o)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}return t}};var Rc=D("libp2p:kad-dht:rpc:handlers:get-value"),Td=class{components;peerRouting;constructor(e,t){let{peerRouting:n}=t;this.components=e,this.peerRouting=n}async handle(e,t){let n=t.key;if(Rc("%p asked for key %b",e,n),n==null||n.length===0)throw new b("Invalid key","ERR_INVALID_KEY");let i=new _t(Nt.GET_VALUE,n,t.clusterLevel);if(ES(n)){Rc("is public key");let a=xS(n),c;try{let l=await this.components.peerStore.get(a);if(l.id.publicKey==null)throw new b("No public key found in key book","ERR_NOT_FOUND");c=l.id.publicKey}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}if(c!=null)return Rc("returning found public key"),i.record=new tr(n,c,new Date),i}let[s,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(t.key,e)]);return s!=null&&(Rc("had record for %b in local datastore",n),i.record=s),o.length>0&&(Rc("had %s closer peers in routing table",o.length),i.closerPeers=o),i}async _checkLocalDatastore(e){Rc("checkLocalDatastore looking for %b",e);let t=Ji(e),n;try{n=await this.components.datastore.get(t)}catch(s){if(s.code==="ERR_NOT_FOUND")return;throw s}let i=tr.deserialize(n);if(i==null)throw new b("Invalid record","ERR_INVALID_RECORD");if(i.timeReceived==null||Date.now()-i.timeReceived.getTime()>1296e5){await this.components.datastore.delete(t);return}return i}};var sV=D("libp2p:kad-dht:rpc:handlers:ping"),Dd=class{async handle(e,t){return sV("ping from %p",e),t}};var Cd=class{log;components;validators;constructor(e,t){let{validators:n}=t;this.components=e,this.log=D("libp2p:kad-dht:rpc:handlers:put-value"),this.validators=n}async handle(e,t){let n=t.key;this.log("%p asked us to store value for key %b",e,n);let i=t.record;if(i==null){let s=`Empty record from: ${e.toString()}`;throw this.log.error(s),new b(s,"ERR_EMPTY_RECORD")}try{await xc(this.validators,i),i.timeReceived=new Date;let s=Ji(i.key);await this.components.datastore.put(s,i.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,s)}catch(s){this.log("did not put record for key %b into datastore %o",n,s)}return t}};var Pd=class{handlers;routingTable;log;constructor(e,t){let{providers:n,peerRouting:i,validators:s,lan:o}=t;this.log=D("libp2p:kad-dht:rpc"),this.routingTable=t.routingTable,this.handlers={[Nt.GET_VALUE]:new Td(e,{peerRouting:i}),[Nt.PUT_VALUE]:new Cd(e,{validators:s}),[Nt.FIND_NODE]:new Id(e,{peerRouting:i,lan:o}),[Nt.ADD_PROVIDER]:new Rd({providers:n}),[Nt.GET_PROVIDERS]:new Ad(e,{peerRouting:i,providers:n,lan:o}),[Nt.PING]:new Dd}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(i){this.log.error("Failed to update the kbucket store",i)}let n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}return n.handle(e,t)}onIncomingStream(e){Promise.resolve().then(async()=>{let{stream:t,connection:n}=e,i=n.remotePeer;try{await this.routingTable.add(i)}catch(o){this.log.error(o)}let s=this;await Te(t,o=>vt(o),async function*(o){for await(let a of o){let c=_t.deserialize(a);s.log("incoming %s from %p",c.type,i);let l=await s.handleMessage(i,c);l!=null&&(yield l.serialize())}},o=>Rt(o),t)}).catch(t=>{this.log.error(t)})}};var kd=class extends Fe{log;components;protocol;running;registrarId;constructor(e,t){super();let{protocol:n,lan:i}=t;this.components=e,this.log=D(`libp2p:kad-dht:topology-listener:${i?"lan":"wan"}`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new Ge("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}};var oV=32,aV=64,Su=class extends Fe{protocol;routingTable;providers;network;peerRouting;components;log;running;kBucketSize;clientMode;lan;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;constructor(e,t){super();let{kBucketSize:n,clientMode:i,validators:s,selectors:o,querySelfInterval:a,lan:c,protocolPrefix:l,pingTimeout:u,pingConcurrency:f,maxInboundStreams:h,maxOutboundStreams:d,providers:p}=t;this.running=!1,this.components=e,this.lan=!!c,this.log=D(`libp2p:kad-dht:${c===!0?"lan":"wan"}`),this.protocol=`${l??aS}${c===!0?oS:""}${cS}`,this.kBucketSize=n??20,this.clientMode=i??!0,this.maxInboundStreams=h??oV,this.maxOutboundStreams=d??aV,this.routingTable=new vd(e,{kBucketSize:n,lan:this.lan,pingTimeout:u,pingConcurrency:f,protocol:this.protocol}),this.providers=new gd(e,p??{}),this.validators={...bS,...s},this.selectors={...yS,...o},this.network=new dd(e,{protocol:this.protocol,lan:this.lan});let m=ge();t.allowQueryWithZeroPeers===!0&&m.resolve(),this.queryManager=new bd(e,{disjointPaths:Math.ceil(this.kBucketSize/2),lan:c,initialQuerySelfHasRun:m,routingTable:this.routingTable}),this.peerRouting=new md(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,lan:this.lan}),this.contentFetching=new fd(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,lan:this.lan}),this.contentRouting=new hd(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,lan:this.lan}),this.routingTableRefresh=new Sd({peerRouting:this.peerRouting,routingTable:this.routingTable,lan:this.lan}),this.rpc=new Pd(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,lan:this.lan}),this.topologyListener=new kd(e,{protocol:this.protocol,lan:this.lan}),this.querySelf=new Ed(e,{peerRouting:this.peerRouting,interval:a,initialInterval:t.initialQuerySelfInterval,lan:this.lan,initialQuerySelfHasRun:m,routingTable:this.routingTable}),this.network.addEventListener("peer",g=>{let y=g.detail;this.onPeerConnect(y).catch(w=>{this.log.error("could not add %p to routing table",y.id,w)}),this.dispatchEvent(new Ge("peer",{detail:y}))}),this.topologyListener.addEventListener("peer",g=>{let y=g.detail;Promise.resolve().then(async()=>{let w=await this.components.peerStore.get(y),E={id:y,multiaddrs:w.addresses.map(({multiaddr:R})=>R),protocols:w.protocols};await this.onPeerConnect(E)}).catch(w=>{this.log.error("could not add %p to routing table",y,w)})})}async onPeerConnect(e){if(this.log("peer %p connected with protocols",e.id,e.protocols),this.lan?e=_c(e):e=vc(e),e.multiaddrs.length===0){this.log("ignoring %p as they do not have any %s addresses in %s",e.id,this.lan?"private":"public",e.multiaddrs.map(t=>t.toString()));return}try{await this.routingTable.add(e.id)}catch(t){this.log.error("could not add %p to routing table",e.id,t)}}isStarted(){return this.running}async getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),e==="client"?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await Promise.all([this.providers.start(),this.queryManager.start(),this.network.start(),this.routingTable.start(),this.topologyListener.start()]),this.querySelf.start(),await this.routingTableRefresh.start()}async stop(){this.running=!1,this.querySelf.stop(),await Promise.all([this.providers.stop(),this.queryManager.stop(),this.network.stop(),this.routingTable.stop(),this.routingTableRefresh.stop(),this.topologyListener.stop()])}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}};var O4=D("libp2p:kad-dht"),L4=class{dht;constructor(e){this.dht=e}async provide(e,t={}){await Cr(this.dht.provide(e,t))}async*findProviders(e,t={}){for await(let n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await Cr(this.dht.put(e,t,n))}async get(e,t){for await(let n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new b("Not found","ERR_NOT_FOUND")}},B4=class{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(let n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new b("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){for await(let n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}},cV=290,lV=54,uV=55,fV=56,hV=4,dV=41;function pV(r){let e=r.stringTuples();for(let t of e)if(t[0]===cV)return!1;if(e[0][0]===lV||e[0][0]===uV||e[0][0]===fV)return!0;if(e[0][0]===hV||e[0][0]===dV){let t=Br(`${e[0][1]}`);return t==null||!t}return!1}var Nd=class extends Fe{wan;lan;components;contentRouting;peerRouting;constructor(e,t={}){super(),this.components=e,this.wan=new Su(e,{protocolPrefix:"/ipfs",...t,lan:!1}),this.lan=new Su(e,{protocolPrefix:"/ipfs",...t,clientMode:!1,lan:!0}),this.contentRouting=new L4(this),this.peerRouting=new B4(this),this.wan.addEventListener("peer",n=>{this.dispatchEvent(new Ge("peer",{detail:n.detail}))}),this.lan.addEventListener("peer",n=>{this.dispatchEvent(new Ge("peer",{detail:n.detail}))}),t.clientMode==null&&e.events.addEventListener("self:peer:update",n=>{O4("received update of self-peer info");let i=n.detail.peer.addresses.some(({multiaddr:s})=>pV(s));this.getMode().then(async s=>{i&&s==="client"?await this.setMode("server"):s==="server"&&!i&&await this.setMode("client")}).catch(s=>{O4.error("error setting dht server mode",s)})})}[Symbol.toStringTag]="@libp2p/dual-kad-dht";get[Co](){return this.contentRouting}get[ko](){return this.peerRouting}get[Po](){return this}isStarted(){return this.wan.isStarted()&&this.lan.isStarted()}async getMode(){return this.wan.getMode()}async setMode(e){await this.wan.setMode(e)}async start(){await Promise.all([this.lan.start(),this.wan.start()])}async stop(){await Promise.all([this.lan.stop(),this.wan.stop()])}async*put(e,t,n={}){for await(let i of Ut(this.lan.put(e,t,n),this.wan.put(e,t,n)))yield i}async*get(e,t={}){let n=!1,i=!1;for await(let s of Ut(this.lan.get(e,t),this.wan.get(e,t)))yield s,s.name==="DIAL_PEER"&&(n=!0),s.name==="VALUE"&&(n=!0,s.value!=null&&(i=!0)),s.name==="SEND_QUERY"&&(n=!0);if(!n)throw new b("No peers found in routing table!","ERR_NO_PEERS_IN_ROUTING_TABLE");i||(yield Ar({from:this.components.peerId,error:new b("Not found","ERR_NOT_FOUND")},t))}async*provide(e,t={}){let n=0,i=0,s=[],o=[this.lan];await this.wan.getMode()==="server"&&o.push(this.wan);for await(let a of Ut(...o.map(c=>c.provide(e,t))))yield a,a.name==="SEND_QUERY"&&n++,a.name==="QUERY_ERROR"&&s.push(a.error),a.name==="PEER_RESPONSE"&&a.messageName==="ADD_PROVIDER"&&(O4("sent provider record for %s to %p",e,a.from),i++);if(i===0)throw s.length>0?new b(`Failed to provide to ${s.length} of ${n} peers`,"ERR_PROVIDES_FAILED",{errors:s}):new b("Failed to provide - no peers found","ERR_PROVIDES_FAILED")}async*findProviders(e,t={}){yield*Ut(this.lan.findProviders(e,t),this.wan.findProviders(e,t))}async*findPeer(e,t={}){let n=!1;for await(let i of Ut(this.lan.findPeer(e,t),this.wan.findPeer(e,t)))yield i,(i.name==="SEND_QUERY"||i.name==="FINAL_PEER")&&(n=!0);if(!n)throw new b("Peer lookup failed","ERR_LOOKUP_FAILED")}async*getClosestPeers(e,t={}){yield*Ut(this.lan.getClosestPeers(e,t),this.wan.getClosestPeers(e,t))}async refreshRoutingTable(){await Promise.all([this.lan.refreshRoutingTable(),this.wan.refreshRoutingTable()])}};var LS;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER"})(LS||(LS={}));var BS;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(BS||(BS={}));function MS(r){return e=>new Nd(e,r)}var GS=de(n3(),1);var Ne;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(Ne||(Ne={}));var Ru=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),M4=Object.freeze({NEW_STREAM:Ne.NEW_STREAM,MESSAGE:Ne.MESSAGE_INITIATOR,CLOSE:Ne.CLOSE_INITIATOR,RESET:Ne.RESET_INITIATOR}),US=Object.freeze({MESSAGE:Ne.MESSAGE_RECEIVER,CLOSE:Ne.CLOSE_RECEIVER,RESET:Ne.RESET_RECEIVER});var U4=1<<20,mV=4<<20,Od=class{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=U4,t=mV){this._buffer=new _e,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});let t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.code==="ERR_MSG_TOO_BIG")throw l;break}let{id:n,type:i,length:s,offset:o}=this._headerInfo;if(this._buffer.length-o<s)break;let c={id:n,type:i};(i===Ne.NEW_STREAM||i===Ne.MESSAGE_INITIATOR||i===Ne.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+s)),t.push(c),this._buffer.consume(o+s),this._headerInfo=null}return t}_decodeHeader(e){let{value:t,offset:n}=KS(e),{value:i,offset:s}=KS(e,n),o=t&7;if(Ru[o]==null)throw new Error(`Invalid type received: ${o}`);if(i>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:o,offset:n+s,length:i}}},gV=128,FS=127;function KS(r,e=0){let t=0,n=0,i=e,s,o=r.length;do{if(i>=o||n>49)throw e=0,new RangeError("Could not decode varint");s=r.get(i++),t+=n<28?(s&FS)<<n:(s&FS)*Math.pow(2,n),n+=7}while(s>=gV);return e=i-e,{value:t,offset:e}}function yV(r){return r[Symbol.asyncIterator]!=null}var Ld=1024*1024,VS=(r,e)=>{e.append(r)};function bV(r,e){return yV(r)?async function*(){let t=new _e,n=!1,i=ge(),s=Number(e?.size??Ld);if((isNaN(s)||s===0||s<0)&&(s=Ld),s!==Math.round(s))throw new Error("Batch size must be an integer");let o=e?.yieldAfter??0,a=e?.serialize??VS;for(Promise.resolve().then(async()=>{try{let c;for await(let l of r){if(a(l,t),t.byteLength>=s){clearTimeout(c),i.resolve();continue}c=setTimeout(()=>{i.resolve()},o)}clearTimeout(c),i.resolve()}catch(c){i.reject(c)}finally{n=!0}});!n;)if(await i.promise,i=ge(),t.byteLength>0){let c=t;t=new _e,yield c.subarray()}}():function*(){let t=new _e,n=Number(e?.size??Ld);if((isNaN(n)||n===0||n<0)&&(n=Ld),n!==Math.round(n))throw new Error("Batch size must be an integer");let i=e?.serialize??VS;for(let s of r)i(s,t),t.byteLength>=n&&(yield t.subarray(0,n),t.consume(n));t.byteLength>0&&(yield t.subarray())}()}var qS=bV;function F4(r){return new Uint8Array(r)}var K4=10*1024,V4=class{_pool;_poolOffset;constructor(){this._pool=F4(K4),this._poolOffset=0}write(e,t){let n=this._pool,i=this._poolOffset;Ht(e.id<<3|e.type,n,i),i+=$t(e.id<<3|e.type),(e.type===Ne.NEW_STREAM||e.type===Ne.MESSAGE_INITIATOR||e.type===Ne.MESSAGE_RECEIVER)&&e.data!=null?(Ht(e.data.length,n,i),i+=$t(e.data.length)):(Ht(0,n,i),i+=$t(0));let s=n.subarray(this._poolOffset,i);K4-i<100?(this._pool=F4(K4),this._poolOffset=0):this._poolOffset=i,t.append(s),(e.type===Ne.NEW_STREAM||e.type===Ne.MESSAGE_INITIATOR||e.type===Ne.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}},zS=new V4;async function*$S(r,e=0){if(e==null||e===0){for await(let t of r){let n=new _e;for(let i of t)zS.write(i,n);yield n.subarray()}return}yield*qS(r,{size:e,serialize:(t,n)=>{for(let i of t)zS.write(i,n)}})}var q4=class extends qs{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types=e.direction==="outbound"?M4:US,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:M4.NEW_STREAM,data:new _e(Y(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){let t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}};function HS(r){let{id:e,name:t,send:n,onEnd:i,type:s="initiator",maxMsgSize:o=U4}=r;return new q4({id:s==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:s==="initiator"?"outbound":"inbound",maxDataSize:o,onEnd:i,send:n,log:D(`libp2p:mplex:stream:${s}:${e}`)})}var sn=D("libp2p:mplex"),wV=1024,EV=1024,xV=1024*1024*4,vV=5,_V=500;function WS(r){let e={...r,type:`${Ru[r.type]} (${r.type})`};return r.type===Ne.NEW_STREAM&&(e.data=H(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===Ne.MESSAGE_INITIATOR||r.type===Ne.MESSAGE_RECEIVER)&&(e.data=H(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}var Bd=class{protocol="/mplex/6.7.0";sink;source;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;constructor(e){e=e??{},this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=e,this.closeTimeout=e.closeTimeout??_V,this.sink=this._createSink(),this._source=F8({objectMode:!0,onEnd:()=>{for(let t of this._streams.initiators.values())t.destroy();for(let t of this._streams.receivers.values())t.destroy()}}),this.source=Te(this._source,t=>$S(t,this._init.minSendBytes)),this.closeController=new AbortController,this.rateLimiter=new GS.RateLimiterMemory({points:e.disconnectThreshold??vV,duration:1})}get streams(){let e=[];for(let t of this._streams.initiators.values())e.push(t);for(let t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");let t=this._streamId++;e=e==null?t.toString():e.toString();let n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;let t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async n=>n.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(n){this.abort(n)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){let{id:t,name:n}=e,i=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:i})}_newStream(e){let{id:t,name:n,type:i,registry:s}=e;if(sn("new %s stream %s",i,t),i==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??EV))throw new b("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(s.has(t))throw new Error(`${i} stream ${t} already exists!`);let c=HS({id:t,name:n,send:async l=>{sn.enabled&&sn.trace("%s stream %s send",i,t,WS(l)),this._source.push(l)},type:i,onEnd:()=>{sn("%s stream with id %s and protocol %s ended",i,t,c.protocol),s.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize});return s.set(t,c),c}_createSink(){return async t=>{try{t=Zt(t,this.closeController.signal,{returnOnAbort:!0});let n=new Od(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(let i of t)for(let s of n.write(i))await this._handleIncoming(s);this._source.end()}catch(n){sn("error in sink",n),this._source.end(n)}}}async _handleIncoming(e){let{id:t,type:n}=e;if(sn.enabled&&sn.trace("incoming message",WS(e)),e.type===Ne.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??wV)){sn("too many inbound streams open"),this._source.push({id:t,type:Ne.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{sn("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}let a=this._newReceiverStream({id:t,name:H(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}let s=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(s==null){sn("missing stream %s for message type %s",t,Ru[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{sn("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}let o=this._init.maxStreamBufferSize??xV;try{switch(n){case Ne.MESSAGE_INITIATOR:case Ne.MESSAGE_RECEIVER:if(s.sourceReadableLength()>o)throw this._source.push({id:e.id,type:n===Ne.MESSAGE_INITIATOR?Ne.RESET_RECEIVER:Ne.RESET_INITIATOR}),new b("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL");s.sourcePush(e.data);break;case Ne.CLOSE_INITIATOR:case Ne.CLOSE_RECEIVER:s.remoteCloseWrite();break;case Ne.RESET_INITIATOR:case Ne.RESET_RECEIVER:s.reset();break;default:sn("unknown message type %s",n)}}catch(a){sn.error("error while processing message",a),s.abort(a)}}};var z4=class{protocol="/mplex/6.7.0";_init;constructor(e={}){this._init=e}createStreamMuxer(e={}){return new Bd({...e,...this._init})}};function YS(r={}){return()=>new z4(r)}var on;(function(r){r.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",r.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",r.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",r.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",r.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",r.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",r.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",r.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"})(on||(on={}));var Gs=class extends b{constructor(e,t){super(`WebRTC transport error: ${e}`,t??""),this.name="WebRTCTransportError"}};var $4=class extends Gs{constructor(e,t){super(`[stream: ${e}] data channel error: ${t}`,on.ERR_DATA_CHANNEL),this.name="WebRTC/DataChannelError"}};function X4(r,e){return new $4(r,e)}var H4=class extends Gs{constructor(e){super(`There was a problem with the Multiaddr which was passed in: ${e}`,on.ERR_INVALID_MULTIADDR),this.name="WebRTC/InappropriateMultiaddrError"}};function Md(r){return new H4(r)}var W4=class extends Gs{constructor(e){super(`There was a problem with a provided argument: ${e}`,on.ERR_INVALID_PARAMETERS),this.name="WebRTC/InvalidArgumentError"}};function Iu(r){return new W4(r)}var G4=class extends Gs{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`,on.ERR_INVALID_FINGERPRINT),this.name="WebRTC/InvalidFingerprintError"}};function j4(r,e){return new G4(r,e)}var Y4=class extends Gs{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`,on.ERR_NOT_IMPLEMENTED),this.name="WebRTC/UnimplementedError"}};function QS(r){return new Y4(r)}var Q4=class extends Gs{constructor(e){super(`unsupported hash algorithm: ${e}`,on.ERR_HASH_NOT_SUPPORTED),this.name="WebRTC/UnsupportedHashAlgorithmError"}};function XS(r){return new Q4(r)}var jS=function(r,e,t){if(t||arguments.length===2)for(var n=0,i=e.length,s;n<i;n++)(s||!(n in e))&&(s||(s=Array.prototype.slice.call(e,0,n)),s[n]=e[n]);return r.concat(s||Array.prototype.slice.call(e))},SV=function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r}();var RV=function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r}();var IV=function(){function r(e,t,n,i){this.name=e,this.version=t,this.os=n,this.bot=i,this.type="bot-device"}return r}();var AV=function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r}();var TV=function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r}();var DV=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,CV=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,ZS=3,PV=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",DV]],JS=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function tR(r){return r?eR(r):typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new TV:typeof navigator<"u"?eR(navigator.userAgent):OV()}function kV(r){return r!==""&&PV.reduce(function(e,t){var n=t[0],i=t[1];if(e)return e;var s=i.exec(r);return!!s&&[n,s]},!1)}function eR(r){var e=kV(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new AV;var i=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);i?i.length<ZS&&(i=jS(jS([],i,!0),LV(ZS-i.length),!0)):i=[];var s=i.join("."),o=NV(r),a=CV.exec(r);return a&&a[1]?new IV(t,s,o,a[1]):new SV(t,s,o)}function NV(r){for(var e=0,t=JS.length;e<t;e++){var n=JS[e],i=n[0],s=n[1],o=s.exec(r);if(o)return i}return null}function OV(){var r=typeof process<"u"&&process.version;return r?new RV(process.version.slice(1)):null}function LV(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}var Z4=D("libp2p:webrtc:utils"),rR=tR(),Au=rR!=null&&rR.name==="firefox",Ud=async function*(){},Fd=async r=>{},BV=30*1e3;function J4(r,e,t=BV){r.readyState==="open"&&Promise.resolve().then(async()=>{if(r.bufferedAmount>0){Z4("%s drain channel with %d buffered bytes",e,r.bufferedAmount);let n=ge(),i=!1;r.bufferedAmountLowThreshold=0;let s=()=>{i||(Z4("%s drain channel closed before drain",e),n.resolve())};r.addEventListener("close",s,{once:!0}),r.addEventListener("bufferedamountlow",()=>{i=!0,r.removeEventListener("close",s),n.resolve()}),await Vn(n.promise,{milliseconds:t})}}).then(async()=>{r.readyState==="open"&&r.close()}).catch(n=>{Z4.error("error closing outbound stream",n)})}var eg=D("libp2p:webrtc:maconn"),Zo=class{peerConnection;remoteAddr;timeline;metrics;source=Ud();sink=Fd;constructor(e){this.remoteAddr=e.remoteAddr,this.timeline=e.timeline,this.peerConnection=e.peerConnection;let t=this.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{eg.trace("peer connection state change",this.peerConnection.connectionState,"initial state",t),(this.peerConnection.connectionState==="disconnected"||this.peerConnection.connectionState==="failed"||this.peerConnection.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){eg.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){eg.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}};var MV=r=>{let e=r.on||r.addListener||r.addEventListener,t=r.off||r.removeListener||r.removeEventListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function UV(r,e,t){let n,i=new Promise((s,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:u}=MV(r),f=(...d)=>{let p=t.multiArgs?d:d[0];t.filter&&!t.filter(p)||(c.push(p),t.count===c.length&&(n(),s(c)))},h=d=>{n(),o(d)};n=()=>{for(let d of a)u(d,f);for(let d of t.rejectionEvents)u(d,h)};for(let d of a)l(d,f);for(let d of t.rejectionEvents)l(d,h);t.signal&&t.signal.addEventListener("abort",()=>{h(t.signal.reason)},{once:!0}),t.resolveImmediately&&s(c)});if(i.cancel=n,typeof t.timeout=="number"){let s=Vn(i,{milliseconds:t.timeout});return s.cancel=n,s}return i}function nR(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=UV(r,e,t),i=n.then(s=>s[0]);return i.cancel=n.cancel,i}var Kr;(function(r){let e;(function(i){i.FIN="FIN",i.STOP_SENDING="STOP_SENDING",i.RESET="RESET",i.FIN_ACK="FIN_ACK"})(e=r.Flag||(r.Flag={}));let t;(function(i){i[i.FIN=0]="FIN",i[i.STOP_SENDING=1]="STOP_SENDING",i[i.RESET=2]="RESET",i[i.FIN_ACK=3]="FIN_ACK"})(t||(t={})),function(i){i.codec=()=>ht(t)}(e=r.Flag||(r.Flag={}));let n;r.codec=()=>(n==null&&(n=fe((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.flag!=null&&(s.uint32(8),r.Flag.codec().encode(i.flag,s)),i.message!=null&&(s.uint32(18),s.bytes(i.message)),o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{let o={},a=s==null?i.len:i.pos+s;for(;i.pos<a;){let c=i.uint32();switch(c>>>3){case 1:o.flag=r.Flag.codec().decode(i);break;case 2:o.message=i.bytes();break;default:i.skipType(c&7);break}}return o})),n),r.encode=i=>ue(i,r.codec()),r.decode=i=>le(i,r.codec())})(Kr||(Kr={}));var FV=16*1024*1024,KV=30*1e3,VV=5,qV=2,zV=16*1024,$V=5e3,tg=class extends qs{channel;incomingData;messageQueue;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;constructor(e){let t=e.onEnd;switch(e.onEnd=i=>{this.log.trace("readable and writeable ends closed",this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await Vn(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(s){this.log.error("error receiving FIN_ACK",s)}}).then(()=>{this.incomingData.end(),t?.(i)}).catch(s=>{this.log.error("error ending stream",s)})},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=Et(),this.messageQueue=new _e,this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??KV,this.maxBufferedAmount=e.maxBufferedAmount??FV,this.maxMessageSize=(e.maxMessageSize??zV)-VV-qV,this.receiveFinAck=ge(),this.finAckTimeout=e.closeTimeout??$V,this.channel.readyState){case"open":break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new b("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=i=>{this.timeline.open=new Date().getTime(),this.messageQueue!=null&&this.messageQueue.byteLength>0&&(this.log.trace("dataChannel opened, sending queued messages",this.messageQueue.byteLength,this.channel.readyState),this._sendMessage(this.messageQueue).catch(s=>{this.log.error("error sending queued messages",s),this.abort(s)})),this.messageQueue=void 0},this.channel.onclose=i=>{this.receiveFinAck.resolve(),this.close().catch(s=>{this.log.error("error closing stream after channel closed",s)})},this.channel.onerror=i=>{let s=i.error;this.abort(s)},this.channel.onmessage=async i=>{let{data:s}=i;s===null||s.byteLength===0||this.incomingData.push(new Uint8Array(s,0,s.byteLength))};let n=this;Promise.resolve().then(async()=>{for await(let i of vt(this.incomingData)){let s=n.processIncomingProtobuf(i);s!=null&&n.sourcePush(new _e(s))}}).catch(i=>{this.log.error("error processing incoming data channel messages",i)})}sendNewStream(){}async _sendMessage(e,t=!0){if(t&&this.channel.bufferedAmount>this.maxBufferedAmount)try{await nR(this.channel,"bufferedamountlow",{timeout:this.bufferedAmountLowEventTimeout})}catch(n){throw n instanceof go?new b(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`,"ERR_BUFFER_CLEAR_TIMEOUT"):n}if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new b(`Invalid datachannel state - ${this.channel.readyState}`,"ERR_INVALID_STATE");if(this.channel.readyState==="open")for(let n of e)this.channel.send(n);else if(this.channel.readyState==="connecting")this.messageQueue==null&&(this.messageQueue=new _e),this.messageQueue.append(e);else throw this.log.error("unknown datachannel state %s",this.channel.readyState),new b("Unknown datachannel state","ERR_INVALID_STATE")}async sendData(e){for(e=e.sublist();e.byteLength>0;){let t=Math.min(e.byteLength,this.maxMessageSize),n=e.subarray(0,t),i=Kr.encode({message:n}),s=Rt.single(i);await this._sendMessage(s),e.consume(t)}}async sendReset(){await this._sendFlag(Kr.Flag.RESET)}async sendCloseWrite(e){if(await this._sendFlag(Kr.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await Yo(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorCode:"ERR_FIN_ACK_NOT_RECEIVED"})}catch(n){this.log.error("failed to await FIN_ACK",n)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){await this._sendFlag(Kr.Flag.STOP_SENDING)}processIncomingProtobuf(e){let t=Kr.decode(e);if(t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===Kr.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(Kr.Flag.FIN_ACK).catch(n=>{this.log.error("error sending FIN_ACK immediately",n)})),t.flag===Kr.Flag.RESET&&this.reset(),t.flag===Kr.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===Kr.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return t.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace("not sending flag %s because channel is not open",e.toString()),!1;this.log.trace("sending flag %s",e.toString());let t=Kr.encode({flag:e}),n=Rt.single(t);try{return await this._sendMessage(n,!1),!0}catch(i){this.log.error("could not send flag %s",e.toString(),i)}return!1}};function Ic(r){let{channel:e,direction:t}=r;return new tg({id:t==="inbound"?`i${e.id}`:`r${e.id}`,log:D(`libp2p:webrtc:stream:${t}:${e.id}`),...r})}var iR=D("libp2p:webrtc:muxer"),sR="/webrtc",Jo=class{protocol;peerConnection;streamBuffer=[];metrics;dataChannelOptions;constructor(e){this.peerConnection=e.peerConnection,this.metrics=e.metrics,this.protocol=e.protocol??sR,this.dataChannelOptions=e.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:t})=>{let n=Ic({channel:t,direction:"inbound",onEnd:()=>{this.streamBuffer=this.streamBuffer.filter(i=>i.id!==n.id)},...this.dataChannelOptions});this.streamBuffer.push(n)}}createStreamMuxer(e){return new rg({...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.streamBuffer,protocol:this.protocol})}},rg=class{init;streams;protocol;peerConnection;dataChannelOptions;metrics;constructor(e){this.init=e,this.streams=e.streams,this.peerConnection=e.peerConnection,this.protocol=e.protocol??sR,this.metrics=e.metrics,this.dataChannelOptions=e.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{let i=Ic({channel:n,direction:"inbound",onEnd:()=>{iR.trace("stream %s %s %s onEnd",i.direction,i.id,i.protocol),J4(n,`inbound ${i.id} ${i.protocol}`,this.dataChannelOptions.drainTimeout),this.streams=this.streams.filter(s=>s.id!==i.id),this.metrics?.increment({stream_end:!0}),e?.onStreamEnd?.(i)},...this.dataChannelOptions});this.streams.push(i),this.metrics?.increment({incoming_stream:!0}),e?.onIncomingStream?.(i)};let t=e?.onIncomingStream;t!=null&&this.streams.forEach(n=>{t(n)})}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(let t of this.streams)t.abort(e)}source=Ud();sink=Fd;newStream(){let e=this.peerConnection.createDataChannel(""),t=Ic({channel:e,direction:"outbound",onEnd:()=>{iR.trace("stream %s %s %s onEnd",t.direction,t.id,t.protocol),J4(e,`outbound ${t.id} ${t.protocol}`,this.dataChannelOptions.drainTimeout),this.streams=this.streams.filter(n=>n.id!==t.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(t)},...this.dataChannelOptions});return this.streams.push(t),this.metrics?.increment({outgoing_stream:!0}),t}};var Ac=globalThis.RTCPeerConnection,Kd=globalThis.RTCSessionDescription,oR=globalThis.RTCIceCandidate;function rr(r,e){let t=lu(r,e),n={read:async(i,s)=>{let o=await t.read(s);return i.decode(o)},write:async(i,s,o)=>{await t.write(s.encode(i),o)},pb:i=>({read:async s=>n.read(i,s),write:async(s,o)=>n.write(s,i,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}var Tr;(function(r){let e;(function(i){i.SDP_OFFER="SDP_OFFER",i.SDP_ANSWER="SDP_ANSWER",i.ICE_CANDIDATE="ICE_CANDIDATE"})(e=r.Type||(r.Type={}));let t;(function(i){i[i.SDP_OFFER=0]="SDP_OFFER",i[i.SDP_ANSWER=1]="SDP_ANSWER",i[i.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(t||(t={})),function(i){i.codec=()=>ht(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=fe((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.type!=null&&(s.uint32(8),r.Type.codec().encode(i.type,s)),i.data!=null&&(s.uint32(18),s.string(i.data)),o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{let o={},a=s==null?i.len:i.pos+s;for(;i.pos<a;){let c=i.uint32();switch(c>>>3){case 1:o.type=r.Type.codec().decode(i);break;case 2:o.data=i.string();break;default:i.skipType(c&7);break}}return o})),n),r.encode=i=>ue(i,r.codec()),r.decode=i=>le(i,r.codec())})(Tr||(Tr={}));var ea=D("libp2p:webrtc:peer:util"),Vd=async(r,e,t,n)=>{let i=new AbortController;r.promise.then(()=>{i.abort()},()=>{i.abort()});let s=xt([i.signal,n.signal]),o=Zt(t.unwrap().unwrap().source,s,{returnOnAbort:!0});try{for await(let a of vt(o)){let c=Tr.decode(a);if(c.type!==Tr.Type.ICE_CANDIDATE)throw new b("ICE candidate message expected","ERR_NOT_ICE_CANDIDATE");let l=JSON.parse(c.data??"null");l===""&&(ea.trace("end-of-candidates for this generation received"),l={candidate:"",sdpMid:"0",sdpMLineIndex:0}),l===null&&(ea.trace("end-of-candidates received"),l={candidate:null,sdpMid:"0",sdpMLineIndex:0});let u=new oR(l);ea.trace("%s received new ICE candidate",n.direction,u);try{await e.addIceCandidate(u)}catch(f){ea.error("%s bad candidate received",n.direction,f)}}}catch(a){ea.error("%s error parsing ICE candidate",n.direction,a)}finally{s.clear()}if(n.signal?.aborted===!0)throw new bc("Aborted while reading ICE candidates","ERR_ICE_CANDIDATES_READ_ABORTED");await Yo(r.promise,n.signal,{errorMessage:"Aborted before connected",errorCode:"ERR_ABORTED_BEFORE_CONNECTED"})};function qd(r,e){r[Au?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(ea.trace("receiver peerConnectionState state change: %s",r.connectionState),Au?r.iceConnectionState:r.connectionState){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new b("RTCPeerConnection was closed","ERR_CONNECTION_CLOSED_BEFORE_CONNECTED"));break;default:break}}}function zd(r){let e=r.split(`\r
`).filter(n=>n.startsWith("a=candidate")).pop(),t=e?.split(" ");return e==null||t==null||t.length<5?(ea("could not parse remote address from",e),"/webrtc"):`/dnsaddr/${t[4]}/${t[2].toLowerCase()}/${t[5]}/webrtc`}var kn=D("libp2p:webrtc:initiate-connection");async function aR({peerConnection:r,signal:e,metrics:t,multiaddr:n,connectionManager:i,transportManager:s}){let{baseAddr:o,peerId:a}=cR(n);t?.dialerEvents.increment({open:!0}),kn.trace("dialing base address: %a",o);let c=o.getPeerId();if(c==null)throw new b("Relay peer was missing","ERR_INVALID_ADDRESS");let l=i.getConnections(ae(c)),u,f=!1;l.length===0?(u=await s.dial(o,{signal:e}),f=!0):u=l[0];try{let h=await u.newStream($d,{signal:e,runOnTransientConnection:!0}),d=rr(h).pb(Tr),p=ge(),m=()=>{p.reject(new b("SDP handshake aborted","ERR_SDP_HANDSHAKE_ABORTED"))};try{qd(r,p),e?.addEventListener("abort",m);let g=r.createDataChannel("init");r.onicecandidate=({candidate:x})=>{let v=JSON.stringify(x?.toJSON()??null);kn.trace("initiator sending ICE candidate %s",v),d.write({type:Tr.Type.ICE_CANDIDATE,data:v},{signal:e}).catch(I=>{kn.error("error sending ICE candidate",I)})},r.onicecandidateerror=x=>{kn("initiator ICE candidate error",x)};let y=await r.createOffer();kn.trace("initiator send SDP offer %s",y.sdp),await d.write({type:Tr.Type.SDP_OFFER,data:y.sdp},{signal:e}),await r.setLocalDescription(y).catch(x=>{throw kn.error("could not execute setLocalDescription",x),new b("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")});let w=await d.read({signal:e});if(w.type!==Tr.Type.SDP_ANSWER)throw new b("remote should send an SDP answer","ERR_SDP_HANDSHAKE_FAILED");kn.trace("initiator receive SDP answer %s",w.data);let E=new Kd({type:"answer",sdp:w.data});await r.setRemoteDescription(E).catch(x=>{throw kn.error("could not execute setRemoteDescription",x),new b("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")}),kn.trace("initiator read candidates until connected"),await Vd(p,r,d,{direction:"initiator",signal:e}),kn.trace("initiator connected, closing init channel"),g.close(),kn.trace("initiator closing signalling stream"),await d.unwrap().unwrap().close({signal:e});let R=zd(r.currentRemoteDescription?.sdp??"");return kn.trace("initiator connected to remote address %s",R),{remoteAddress:se(R).encapsulate(`/p2p/${a.toString()}`)}}catch(g){throw r.close(),h.abort(g),g}finally{e?.removeEventListener("abort",m),r.onicecandidate=null,r.onicecandidateerror=null}}finally{if(f)try{await u.close({signal:e})}catch(h){u.abort(h)}}}var Hd=class extends Fe{peerId;transportManager;shutdownController;constructor(e,t){super(),this.peerId=e.peerId,this.transportManager=e.transportManager,this.shutdownController=t.shutdownController}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter(e=>e!==this).map(e=>e.getAddrs().filter(t=>ti.matches(t)).map(t=>t.encapsulate(`/webrtc/p2p/${this.peerId}`))).flat()}async close(){this.shutdownController.abort(),this.safeDispatchEvent("close",{})}};var an=D("libp2p:webrtc:signaling-stream-handler");async function lR({peerConnection:r,stream:e,signal:t,connection:n}){an.trace("new inbound signaling stream");let i=rr(e).pb(Tr);try{let o=ge(),a=ge();t.onabort=()=>{o.reject(new b("Timed out while trying to connect","ERR_TIMEOUT"))},r.onicecandidate=({candidate:f})=>{a.promise.then(async()=>{let h=JSON.stringify(f?.toJSON()??null);an.trace("recipient sending ICE candidate %s",h),await i.write({type:Tr.Type.ICE_CANDIDATE,data:h},{signal:t})},h=>{an.error("cannot set candidate since sending answer failed",h),o.reject(h)})},qd(r,o);let c=await i.read({signal:t});if(c.type!==Tr.Type.SDP_OFFER)throw new b(`expected message type SDP_OFFER, received: ${c.type??"undefined"} `,"ERR_SDP_HANDSHAKE_FAILED");an.trace("recipient receive SDP offer %s",c.data);let l=new Kd({type:"offer",sdp:c.data});await r.setRemoteDescription(l).catch(f=>{throw an.error("could not execute setRemoteDescription",f),new b("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")});let u=await r.createAnswer().catch(f=>{throw an.error("could not execute createAnswer",f),a.reject(f),new b("Failed to create answer","ERR_SDP_HANDSHAKE_FAILED")});an.trace("recipient send SDP answer %s",u.sdp),await i.write({type:Tr.Type.SDP_ANSWER,data:u.sdp},{signal:t}),await r.setLocalDescription(u).catch(f=>{throw an.error("could not execute setLocalDescription",f),a.reject(f),new b("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}),a.resolve(),an.trace("recipient read candidates until connected"),await Vd(o,r,i,{direction:"recipient",signal:t}),an.trace("recipient connected, closing signaling stream"),await i.unwrap().unwrap().close({signal:t})}catch(o){if(r.connectionState!=="connected")throw an.error("error while handling signaling stream from peer %a",n.remoteAddr,o),r.close(),o;an("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,o)}let s=zd(r.currentRemoteDescription?.sdp??"");return an.trace("recipient connected to remote address %s",s),{remoteAddress:s}}var ng=D("libp2p:webrtc:peer"),HV="/webrtc",WV="/p2p-circuit",$d="/webrtc-signaling/0.0.1",GV=30*1e3,Wd=class{components;init;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.shutdownController=new AbortController,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}isStarted(){return this._started}async start(){await this.components.registrar.handle($d,e=>{this._onProtocol(e).catch(t=>{ng.error("failed to handle incoming connect from %p",e.connection.remotePeer,t)})},{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle($d),this._started=!1}createListener(e){return new Hd(this.components,{shutdownController:this.shutdownController})}[Symbol.toStringTag]="@libp2p/webrtc";[yi]=!0;filter(e){return e.filter(Jw.exactMatch)}async dial(e,t){ng.trace("dialing address: %a",e);let n=new Ac(this.init.rtcConfiguration),i=new Jo({peerConnection:n,dataChannelOptions:this.init.dataChannel}),{remoteAddress:s}=await aR({peerConnection:n,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager}),o=new Zo({peerConnection:n,timeline:{open:Date.now()},remoteAddr:s,metrics:this.metrics?.dialerEvents}),a=await t.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:i});return this._closeOnShutdown(n,o),a}async _onProtocol({connection:e,stream:t}){let n=AbortSignal.timeout(this.init.inboundConnectionTimeout??GV),i=new Ac(this.init.rtcConfiguration),s=new Jo({peerConnection:i,dataChannelOptions:this.init.dataChannel});try{let{remoteAddress:o}=await lR({peerConnection:i,connection:e,stream:t,signal:n}),a=new Zo({peerConnection:i,timeline:{open:new Date().getTime()},remoteAddr:se(o).encapsulate(`/p2p/${e.remotePeer.toString()}`),metrics:this.metrics?.listenerEvents});this._closeOnShutdown(i,a),await this.components.upgrader.upgradeInbound(a,{skipEncryption:!0,skipProtection:!0,muxerFactory:s}),await t.close({signal:n})}catch(o){throw t.abort(o),o}}_closeOnShutdown(e,t){let n=()=>{t.close().catch(i=>{ng.error("could not close WebRTCMultiaddrConnection",i)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}};function cR(r){let e=r.toString().split(HV+"/");if(e.length!==2)throw new b("webrtc protocol was not present in multiaddr",on.ERR_INVALID_MULTIADDR);if(!e[0].includes(WV))throw new b("p2p-circuit protocol was not present in multiaddr",on.ERR_INVALID_MULTIADDR);let t=se(e[0]),i=se("/"+e[1]).getPeerId();if(i==null)throw new b("destination peer id was missing",on.ERR_INVALID_MULTIADDR);let s=t.protos().pop();if(s===void 0)throw new b("invalid multiaddr",on.ERR_INVALID_MULTIADDR);return s.name!=="p2p"&&(t=t.encapsulate(`/p2p/${i}`)),{baseAddr:t,peerId:ae(i)}}var FI=de(Ng(),1);var kI=de(Ng(),1);var Og=D("libp2p:webrtc:sdp"),Lg=Object.values(dn).map(r=>r.decoder).reduce((r,e)=>r.or(e));function NI(r){let e=r.getConfiguration().certificates?.at(0);if(e==null||e.getFingerprints==null){Og.trace("fetching fingerprint from local SDP");let n=r.localDescription;return n==null?void 0:e$(n.sdp)}if(Og.trace("fetching fingerprint from local certificate"),e.getFingerprints().length===0)return;let t=e.getFingerprints()[0].value;if(t==null)throw j4("","no fingerprint on local certificate");return t}var Jz=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function e$(r){return r.match(Jz)?.groups?.fingerprint}function t$(r){for(let e of r.protoNames())if(e.startsWith("ip"))return e.toUpperCase();return Og("Warning: multiaddr does not appear to contain IP4 or IP6, defaulting to IP6",r),"IP6"}function i1(r){let t=r.stringTuples().filter(n=>n[0]===BI).map(n=>n[1])[0];if(t===void 0||t==="")throw Md(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function Bg(r){let e=Lg.decode(r);return kI.decode(e)}function r$(r){let e=Bg(i1(r)),t=Mg(e.name),n=e.digest.reduce((s,o)=>s+o.toString(16).padStart(2,"0"),""),i=n.match(/.{1,2}/g);if(i==null)throw j4(n,r.toString());return[`${t.toUpperCase()} ${i.join(":").toUpperCase()}`,n]}function Mg(r){switch(r){case"sha1":return"sha-1";case"sha2-256":return"sha-256";case"sha2-512":return"sha-512";default:throw XS(r)}}function n$(r,e){let{host:t,port:n}=r.toOptions(),i=t$(r),[s]=r$(r);return`v=0
o=- 0 0 IN ${i} ${t}
s=-
c=IN ${i} ${t}
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:passive
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${s}
a=sctp-port:5000
a=max-message-size:16384
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host\r
`}function OI(r,e){return{type:"answer",sdp:n$(r,e)}}function LI(r,e){if(r.sdp===void 0)throw Iu("Can't munge a missing SDP");return r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+`
`).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+`
`),r}var MI=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),UI=r=>[...Array(r)].map(()=>MI.at(Math.floor(Math.random()*MI.length))).join("");var s1=D("libp2p:webrtc:transport"),s$=1e4,Iye=ye("webrtc-direct").code,BI=ye("certhash").code,o1=class{metrics;components;init;constructor(e,t={}){this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}async dial(e,t){let n=await this._connect(e,t);return s1("dialing address: %a",e),n}createListener(e){throw QS("WebRTCTransport.createListener")}filter(e){return e.filter(jw.exactMatch)}[Symbol.toStringTag]="@libp2p/webrtc-direct";[yi]=!0;async _connect(e,t){let n=new AbortController,i=n.signal,s=e.getPeerId();if(s===null)throw Md("we need to have the remote's PeerId");let o=ae(s),a=Bg(i1(e)),c=await Ac.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:Mg(a.name)}),l=new Ac({certificates:[c]});try{let u=new Promise((_,k)=>{let B=l.createDataChannel("",{negotiated:!0,id:0}),L=setTimeout(()=>{let K=`Data channel was never opened: state: ${B.readyState}`;s1.error(K),this.metrics?.dialerEvents.increment({open_error:!0}),k(X4("data",K))},s$);B.onopen=K=>{clearTimeout(L),_(B)},B.onerror=K=>{clearTimeout(L);let te=`Error opening a data channel for handshaking: ${K.target?.toString()??"not specified"}`;s1.error(te),this.metrics?.dialerEvents.increment({unknown_error:!0}),k(X4("data",te))}}),f="libp2p+webrtc+v1/"+UI(32),h=await l.createOffer(),d=LI(h,f);await l.setLocalDescription(d);let p=OI(e,f);await l.setRemoteDescription(p);let m=await u,g=this.components.peerId,y=this.generateNoisePrologue(l,a.code,e),w=gc({prologueBytes:y})(),E=Ic({channel:m,direction:"inbound",...this.init.dataChannel??{}}),R={...E,sink:E.sink.bind(E),source:async function*(){for await(let _ of E.source)for(let k of _)yield k}()},x=new Zo({peerConnection:l,remoteAddr:e,timeline:{open:Date.now()},metrics:this.metrics?.dialerEvents}),v=Au?"iceconnectionstatechange":"connectionstatechange";l.addEventListener(v,()=>{switch(l.connectionState){case"failed":case"disconnected":case"closed":x.close().catch(_=>{s1.error("error closing connection",_)}).finally(()=>{n.abort()});break;default:break}},{signal:i}),this.metrics?.dialerEvents.increment({peer_connection:!0});let I=new Jo({peerConnection:l,metrics:this.metrics?.dialerEvents,dataChannelOptions:this.init.dataChannel});return await w.secureInbound(g,R,o),await t.upgrader.upgradeOutbound(x,{skipProtection:!0,skipEncryption:!0,muxerFactory:I})}catch(u){throw l.close(),u}}generateNoisePrologue(e,t,n){if(e.getConfiguration().certificates?.length===0)throw Iu("no local certificate");let i=NI(e);if(i==null)throw Iu("no local fingerprint found");let s=i.trim().toLowerCase().replaceAll(":",""),o=Y(s,"hex"),a=FI.encode(o,t),c=Lg.decode(i1(n)),l=Y("libp2p-webrtc-noise:");return ve([l,a,c])}};function KI(r){return e=>new o1(e,r)}function VI(r){return e=>new Wd(e,r)}function qI(r){let e;try{e=ye("sni").code}catch{return null}for(let[t,n]of r)if(t===e&&n!==void 0)return n;return null}function zI(r){return r.some(([e,t])=>e===ye("tls").code)}function cn(r,e,t){let n=$I[ye(r).name];if(n===void 0)throw new Error(`Can't interpret protocol ${ye(r).name}`);let i=n(e,t);return r===ye("ip6").code?`[${i}]`:i}var $I={ip4:(r,e)=>r,ip6:(r,e)=>e.length===0?r:`[${r}]`,tcp:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`tcp://${cn(t[0],t[1]??"",e)}:${r}`},udp:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`udp://${cn(t[0],t[1]??"",e)}:${r}`},dnsaddr:(r,e)=>r,dns4:(r,e)=>r,dns6:(r,e)=>r,dns:(r,e)=>r,ipfs:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${cn(t[0],t[1]??"",e)}/ipfs/${r}`},p2p:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${cn(t[0],t[1]??"",e)}/p2p/${r}`},http:(r,e)=>{let t=zI(e),n=qI(e);if(t&&n!==null)return`https://${n}`;let i=t?"https://":"http://",s=e.pop();if(s===void 0)throw new Error("Unexpected end of multiaddr");let o=cn(s[0],s[1]??"",e);return o=o.replace("tcp://",""),`${i}${o}`},tls:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return cn(t[0],t[1]??"",e)},sni:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return cn(t[0],t[1]??"",e)},https:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");let n=cn(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{let t=zI(e),n=qI(e);if(t&&n!==null)return`wss://${n}`;let i=t?"wss://":"ws://",s=e.pop();if(s===void 0)throw new Error("Unexpected end of multiaddr");let o=cn(s[0],s[1]??"",e);return o=o.replace("tcp://",""),`${i}${o}`},wss:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");let n=cn(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`wss://${n}`},"p2p-websocket-star":(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${cn(t[0],t[1]??"",e)}/p2p-websocket-star`},"p2p-webrtc-star":(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${cn(t[0],t[1]??"",e)}/p2p-webrtc-star`},"p2p-webrtc-direct":(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${cn(t[0],t[1]??"",e)}/p2p-webrtc-direct`}};function HI(r,e){let n=se(r).stringTuples(),i=n.pop();if(i===void 0)throw new Error("Unexpected end of multiaddr");let s=ye(i[0]),o=$I[s.name];if(o==null)throw new Error(`No interpreter found for ${s.name}`);let a=o(i[1]??"",n);return e?.assumeHttp!==!1&&i[0]===ye("tcp").code&&(a=a.replace("tcp://","http://"),(i[1]==="443"||i[1]==="80")&&(i[1]==="443"&&(a=a.replace("http://","https://")),a=a.substring(0,a.lastIndexOf(":")))),a}var WI=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",i),r.removeEventListener("error",s)}function i(){n(),e()}function s(o){n(),t(o.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",i),r.addEventListener("error",s)})};var GI=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(let i of n){try{await WI(r)}catch(s){if(s.message==="socket closed")break;throw s}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(i)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((i,s)=>{r.addEventListener("close",o=>{if(o.wasClean||o.code===1006)i();else{let a=Object.assign(new Error("ws error"),{event:o});s(a)}}),setTimeout(()=>{r.close()})})});var jI=de(QI(),1);function XI(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}var ZI=r=>{r.binaryType="arraybuffer";let e=async()=>{await new Promise((s,o)=>{if(n){s();return}if(i!=null){o(i);return}let a=u=>{r.removeEventListener("open",c),r.removeEventListener("error",l),u()},c=()=>{a(s)},l=u=>{a(()=>{o(u.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",l)})},t=async function*(){let s=new jI.EventIterator(({push:o,stop:a,fail:c})=>{let l=f=>{let h=null;typeof f.data=="string"&&(h=Y(f.data)),XI(f.data)&&(h=new Uint8Array(f.data)),f.data instanceof Uint8Array&&(h=f.data),h!=null&&o(h)},u=f=>{c(f.error??new Error("Socket error"))};return r.addEventListener("message",l),r.addEventListener("error",u),r.addEventListener("close",a),()=>{r.removeEventListener("message",l),r.removeEventListener("error",u),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(let o of s)yield XI(o)?new Uint8Array(o):o}(),n=r.readyState===1,i;return r.addEventListener("open",()=>{n=!0,i=null}),r.addEventListener("close",()=>{n=!1,i=null}),r.addEventListener("error",s=>{n||(i=s.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})};var JI=(r,e)=>{e=e??{};let t=ZI(r),n=e.remoteAddress,i=e.remotePort;if(r.url!=null)try{let o=new URL(r.url);n=o.hostname,i=parseInt(o.port,10)}catch{}if(n==null||i==null)throw new Error("Remote connection did not have address and/or port");return{sink:GI(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(o=>{r.addEventListener("close",()=>{o()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:i,socket:r}};var eA=WebSocket;var cA=de(aA(),1),g$={http:"ws",https:"wss"},y$="ws",lA=(r,e)=>(0,cA.relative)(r,e,g$,y$);function uA(r,e){let t=typeof window>"u"?"":window.location;e=e??{};let n=lA(r,t.toString()),i=new eA(n,e.websocket);return JI(i,e)}var dA=de(hA(),1),qg=typeof window=="object"&&typeof document=="object"&&document.nodeType===9,l1=(0,dA.default)(),u1=qg&&!l1,pA=l1&&!qg,mA=l1&&qg,gA=typeof globalThis.process<"u"&&typeof globalThis.process.release<"u"&&globalThis.process.release.name==="node"&&!l1,f1=typeof importScripts=="function"&&typeof self<"u"&&typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope,Jye=typeof globalThis.process<"u"&&typeof globalThis.process.env<"u"&&globalThis.process.env["NODE"+(()=>"_")()+"ENV"]==="test",yA=typeof navigator<"u"&&navigator.product==="ReactNative";function EA(r){return r.filter(e=>{if(e.protoCodes().includes(290))return!1;let t=e.decapsulateCode(421);return Ec.matches(t)||Qo.matches(t)})}function xA(r){return r.filter(e=>{if(e.protoCodes().includes(290))return!1;let t=e.decapsulateCode(421);return Qo.matches(t)})}function vA(){throw new Error("WebSocket Servers can not be created in the browser!")}var h1=D("libp2p:websockets:socket");function _A(r,e,t){t=t??{};let n={async sink(i){t?.signal!=null&&(i=Zt(i,t.signal));try{await r.sink(i)}catch(s){s.type!=="aborted"&&h1.error(s)}},source:t.signal!=null?Zt(r.source,t.signal):r.source,remoteAddr:e,timeline:{open:Date.now()},async close(i={}){let s=Date.now();i.signal=i.signal??AbortSignal.timeout(500);let o=()=>{let{host:a,port:c}=n.remoteAddr.toOptions();h1("timeout closing stream to %s:%s after %dms, destroying it manually",a,c,Date.now()-s),this.abort(new b("Socket close timeout","ERR_SOCKET_CLOSE_TIMEOUT"))};i.signal.addEventListener("abort",o);try{await r.close()}catch(a){h1.error("error closing WebSocket gracefully",a),this.abort(a)}finally{i.signal.removeEventListener("abort",o),n.timeline.close=Date.now()}},abort(i){let{host:s,port:o}=n.remoteAddr.toOptions();h1("timeout closing stream to %s:%s due to error",s,o,i),r.destroy(),n.timeline.close=Date.now()}};return r.socket.addEventListener("close",()=>{n.timeline.close==null&&(n.timeline.close=Date.now())},{once:!0}),n}var Xs=D("libp2p:websockets"),zg=class{init;constructor(e){this.init=e}[Symbol.toStringTag]="@libp2p/websockets";[yi]=!0;async dial(e,t){Xs("dialing %s",e),t=t??{};let n=await this._connect(e,t),i=_A(n,e);Xs("new outbound connection %s",i.remoteAddr);let s=await t.upgrader.upgradeOutbound(i);return Xs("outbound connection %s upgraded",i.remoteAddr),s}async _connect(e,t){if(t?.signal?.aborted===!0)throw new Bn;let n=e.toOptions();Xs("dialing %s:%s",n.host,n.port);let i=ge(),s=uA(HI(e),this.init);if(s.socket.addEventListener("error",()=>{let c=new b(`Could not connect to ${e.toString()}`,"ERR_CONNECTION_FAILED");Xs.error("connection error:",c),i.reject(c)}),t.signal==null)return await Promise.race([s.connected(),i.promise]),Xs("connected %s",e),s;let o,a=new Promise((c,l)=>{if(o=()=>{l(new Bn),s.close().catch(u=>{Xs.error("error closing raw socket",u)})},t?.signal?.aborted===!0){o();return}t?.signal?.addEventListener("abort",o)});try{await Promise.race([a,i.promise,s.connected()])}finally{o!=null&&t?.signal?.removeEventListener("abort",o)}return Xs("connected %s",e),s}createListener(e){return vA({...this.init,...e})}filter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):u1||f1?xA(e):EA(e)}};function SA(r={}){return()=>new zg(r)}var Mu=D("libp2p:webtransport:stream");async function $g(r,e,t,n,i){let s=r.writable.getWriter(),o=r.readable.getReader();await s.ready;function a(){let h=n.findIndex(d=>d===f);h!==-1&&(n.splice(h,1),f.timeline.close=Date.now(),i?.(f))}let c=!1,l=!1;(async function(){let h=await s.closed.catch(d=>d);if(h!=null){let d=h.message;d.includes("aborted by the remote server")||d.includes("STOP_SENDING")||Mu.error(`WebTransport writer closed unexpectedly: streamId=${e} err=${h.message}`)}c=!0,c&&l&&a()})().catch(()=>{Mu.error("WebTransport failed to cleanup closed stream")}),async function(){let h=await o.closed.catch(d=>d);h!=null&&Mu.error(`WebTransport reader closed unexpectedly: streamId=${e} err=${h.message}`),l=!0,c&&l&&a()}().catch(()=>{Mu.error("WebTransport failed to cleanup closed stream")});let u=!1,f={id:e,status:"open",writeStatus:"ready",readStatus:"ready",abort(h){c||(s.abort(h).catch(d=>{Mu.error("could not abort stream",d)}),c=!0),l=!0,this.status="aborted",this.writeStatus="closed",this.readStatus="closed",this.timeline.reset=this.timeline.close=this.timeline.closeRead=this.timeline.closeWrite=Date.now(),a()},async close(h){this.status="closing",await Promise.all([f.closeRead(h),f.closeWrite(h)]),a(),this.status="closed",this.timeline.close=Date.now()},async closeRead(h){if(!l){this.readStatus="closing";try{await o.cancel()}catch(d){d.toString().includes("RESET_STREAM")===!0&&(c=!0)}this.timeline.closeRead=Date.now(),this.readStatus="closed",l=!0}c&&a()},async closeWrite(h){if(!c){c=!0,this.writeStatus="closing";try{await s.close()}catch(d){d.toString().includes("RESET_STREAM")===!0&&(l=!0)}this.timeline.closeWrite=Date.now(),this.writeStatus="closed"}l&&a()},direction:t,timeline:{open:Date.now()},metadata:{},source:async function*(){for(;;){let h=await o.read();if(h.done){l=!0,c&&a();return}yield new _e(h.value)}}(),sink:async function(h){if(u)throw new Error("sink already called on stream");u=!0;try{this.writeStatus="writing";for await(let d of h)if(d instanceof Uint8Array)await s.write(d);else for(let p of d)await s.write(p);this.writeStatus="done"}finally{this.timeline.closeWrite=Date.now(),this.writeStatus="closed",await f.closeWrite()}}};return f}function Hg(){return{source:{[Symbol.asyncIterator](){return{async next(){return new Promise(()=>{})}}}},sink:async r=>new Promise(()=>{})}}function RA(r,e){return e.filter(n=>!!r.find(i=>ce(n,i))).length===e.length}var x$=Object.values(dn).map(r=>r.decoder).reduce((r,e)=>r.or(e));function v$(r){return fn.decode(x$.decode(r))}function IA(r){if(!ih.matches(r))throw new b("Invalid multiaddr, was not a WebTransport address","ERR_INVALID_MULTIADDR");let e=r.stringTuples(),t=e.filter(([o,a])=>o===ye("certhash").code).map(([o,a])=>v$(a??"")),n=e.filter(([o,a])=>o===ye("p2p").code).map(([o,a])=>ae(a??""))[0],i=r.toOptions(),s=i.host;return i.family===6&&s?.includes(":")&&(s=`[${s}]`),{url:`https://${s}:${i.port}`,certhashes:t,remotePeer:n}}var ln=D("libp2p:webtransport"),Wg=class{components;config;metrics;constructor(e,t={}){this.components=e,this.config={maxInboundStreams:t.maxInboundStreams??1e3},e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webtransport_dialer_events_total",{label:"event",help:"Total count of WebTransport dialer events by type"})})}[Symbol.toStringTag]="@libp2p/webtransport";[yi]=!0;async dial(e,t){t?.signal?.throwIfAborted(),ln("dialing %s",e);let n=this.components.peerId;if(n===void 0)throw new Error("Need a local peerid");t=t??{};let{url:i,certhashes:s,remotePeer:o}=IA(e);if(o==null)throw new Error("Need a target peerid");if(s.length===0)throw new Error("Expected multiaddr to contain certhashes");let a,c,l=()=>{},u=!1,f=!1,h=!1;try{this.metrics?.dialerEvents.increment({pending:!0});let d=new WebTransport(`${i}/.well-known/libp2p-webtransport?type=noise`,{serverCertificateHashes:s.map(p=>({algorithm:"sha-256",value:p.digest}))});if(l=p=>{if(!u)try{this.metrics?.dialerEvents.increment({[p]:!0}),d.close()}catch(m){ln.error("error closing wt session",m)}finally{c!=null&&(c.timeline.close=Date.now()),u=!0}},a=()=>{l(f?"noise_timeout":"ready_timeout")},t.signal?.addEventListener("abort",a,{once:!0}),await Promise.race([d.closed,d.ready]),f=!0,this.metrics?.dialerEvents.increment({ready:!0}),d.closed.catch(p=>{ln.error("error on remote wt session close",p)}).finally(()=>{l("remote_close")}),!await this.authenticateWebTransport(d,n,o,s))throw new Error("Failed to authenticate webtransport");return this.metrics?.dialerEvents.increment({open:!0}),c={close:async()=>{ln("Closing webtransport"),l("close")},abort:p=>{ln("aborting webtransport due to passed err",p),l("abort")},remoteAddr:e,timeline:{open:Date.now()},...Hg()},h=!0,await t.upgrader.upgradeOutbound(c,{skipEncryption:!0,muxerFactory:this.webtransportMuxer(d),skipProtection:!0})}catch(d){throw ln.error("caught wt session err",d),l(h?"upgrade_error":f?"noise_error":"ready_error"),d}finally{a!=null&&t.signal?.removeEventListener("abort",a)}}async authenticateWebTransport(e,t,n,i){let s=await e.createBidirectionalStream(),o=s.writable.getWriter(),a=s.readable.getReader();await o.ready;let c={source:async function*(){for(;;){let f=await a.read();if(f.value!=null&&(yield f.value),f.done)break}}(),sink:async function(f){for await(let h of f)await o.write(h)}},l=gc()(),{remoteExtensions:u}=await l.secureOutbound(t,c,n);if(o.close().catch(f=>{ln.error(`Failed to close authentication stream writer: ${f.message}`)}),a.cancel().catch(f=>{ln.error(`Failed to close authentication stream reader: ${f.message}`)}),!RA(u?.webtransportCerthashes??[],i.map(f=>f.bytes)))throw new Error("Our certhashes are not a subset of the remote's reported certhashes");return!0}webtransportMuxer(e){let t=0,n=this.config;return{protocol:"webtransport",createStreamMuxer:i=>{typeof i=="function"&&(i={onIncomingStream:i});let s=[];return async function(){let a=e.incomingBidirectionalStreams.getReader();for(;;){let{done:c,value:l}=await a.read();if(c)break;if(s.length>=n.maxInboundStreams)l.writable.close().catch(u=>{ln.error(`Failed to close inbound stream that crossed our maxInboundStream limit: ${u.message}`)}),l.readable.cancel().catch(u=>{ln.error(`Failed to close inbound stream that crossed our maxInboundStream limit: ${u.message}`)});else{let u=await $g(l,String(t++),"inbound",s,i?.onStreamEnd);s.push(u),i?.onIncomingStream?.(u)}}}().catch(()=>{ln.error("WebTransport failed to receive incoming stream")}),{protocol:"webtransport",streams:s,newStream:async a=>{let c=await e.createBidirectionalStream(),l=await $g(c,String(t++),i?.direction??"outbound",s,i?.onStreamEnd);return s.push(l),l},close:async a=>{ln("Closing webtransport muxer"),await Promise.all(s.map(async c=>c.close(a)))},abort:a=>{ln("Aborting webtransport muxer with err:",a);for(let c of s)c.abort(a)},...Hg()}}}}createListener(e){throw new Error("Webtransport servers are not supported in Node or the browser")}filter(e){return e.filter(ih.exactMatch)}};function AA(r={}){return e=>new Wg(e,r)}function TA(r,e){let t=e.map((n,i)=>({record:_i(n),index:i}));return t.sort((n,i)=>{let s=n.record.sequence,o=i.record.sequence;if(s>o)return-1;if(s<o)return 1;let a=n.record.validity.toDate(),c=i.record.validity.toDate();return a.getTime()>c.getTime()?-1:a.getTime()<c.getTime()?1:0}),t[0].index}var DA="libp2p",CA="autonat",PA="1.0.0";var De;(function(r){let e;(function(l){l.DIAL="DIAL",l.DIAL_RESPONSE="DIAL_RESPONSE"})(e=r.MessageType||(r.MessageType={}));let t;(function(l){l[l.DIAL=0]="DIAL",l[l.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(t||(t={})),function(l){l.codec=()=>ht(t)}(e=r.MessageType||(r.MessageType={}));let n;(function(l){l.OK="OK",l.E_DIAL_ERROR="E_DIAL_ERROR",l.E_DIAL_REFUSED="E_DIAL_REFUSED",l.E_BAD_REQUEST="E_BAD_REQUEST",l.E_INTERNAL_ERROR="E_INTERNAL_ERROR"})(n=r.ResponseStatus||(r.ResponseStatus={}));let i;(function(l){l[l.OK=0]="OK",l[l.E_DIAL_ERROR=100]="E_DIAL_ERROR",l[l.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",l[l.E_BAD_REQUEST=200]="E_BAD_REQUEST",l[l.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(i||(i={})),function(l){l.codec=()=>ht(i)}(n=r.ResponseStatus||(r.ResponseStatus={}));let s;(function(l){let u;l.codec=()=>(u==null&&(u=fe((f,h,d={})=>{if(d.lengthDelimited!==!1&&h.fork(),f.id!=null&&(h.uint32(10),h.bytes(f.id)),f.addrs!=null)for(let p of f.addrs)h.uint32(18),h.bytes(p);d.lengthDelimited!==!1&&h.ldelim()},(f,h)=>{let d={addrs:[]},p=h==null?f.len:f.pos+h;for(;f.pos<p;){let m=f.uint32();switch(m>>>3){case 1:d.id=f.bytes();break;case 2:d.addrs.push(f.bytes());break;default:f.skipType(m&7);break}}return d})),u),l.encode=f=>ue(f,l.codec()),l.decode=f=>le(f,l.codec())})(s=r.PeerInfo||(r.PeerInfo={}));let o;(function(l){let u;l.codec=()=>(u==null&&(u=fe((f,h,d={})=>{d.lengthDelimited!==!1&&h.fork(),f.peer!=null&&(h.uint32(10),r.PeerInfo.codec().encode(f.peer,h)),d.lengthDelimited!==!1&&h.ldelim()},(f,h)=>{let d={},p=h==null?f.len:f.pos+h;for(;f.pos<p;){let m=f.uint32();switch(m>>>3){case 1:d.peer=r.PeerInfo.codec().decode(f,f.uint32());break;default:f.skipType(m&7);break}}return d})),u),l.encode=f=>ue(f,l.codec()),l.decode=f=>le(f,l.codec())})(o=r.Dial||(r.Dial={}));let a;(function(l){let u;l.codec=()=>(u==null&&(u=fe((f,h,d={})=>{d.lengthDelimited!==!1&&h.fork(),f.status!=null&&(h.uint32(8),r.ResponseStatus.codec().encode(f.status,h)),f.statusText!=null&&(h.uint32(18),h.string(f.statusText)),f.addr!=null&&(h.uint32(26),h.bytes(f.addr)),d.lengthDelimited!==!1&&h.ldelim()},(f,h)=>{let d={},p=h==null?f.len:f.pos+h;for(;f.pos<p;){let m=f.uint32();switch(m>>>3){case 1:d.status=r.ResponseStatus.codec().decode(f);break;case 2:d.statusText=f.string();break;case 3:d.addr=f.bytes();break;default:f.skipType(m&7);break}}return d})),u),l.encode=f=>ue(f,l.codec()),l.decode=f=>le(f,l.codec())})(a=r.DialResponse||(r.DialResponse={}));let c;r.codec=()=>(c==null&&(c=fe((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.type!=null&&(u.uint32(8),r.MessageType.codec().encode(l.type,u)),l.dial!=null&&(u.uint32(18),r.Dial.codec().encode(l.dial,u)),l.dialResponse!=null&&(u.uint32(26),r.DialResponse.codec().encode(l.dialResponse,u)),f.lengthDelimited!==!1&&u.ldelim()},(l,u)=>{let f={},h=u==null?l.len:l.pos+u;for(;l.pos<h;){let d=l.uint32();switch(d>>>3){case 1:f.type=r.MessageType.codec().decode(l);break;case 2:f.dial=r.Dial.codec().decode(l,l.uint32());break;case 3:f.dialResponse=r.DialResponse.codec().decode(l,l.uint32());break;default:l.skipType(d&7);break}}return f})),c),r.encode=l=>ue(l,r.codec()),r.decode=l=>le(l,r.codec())})(De||(De={}));var qe=D("libp2p:autonat"),Gg=4,Yg=class{components;startupDelay;refreshInterval;protocol;timeout;maxInboundStreams;maxOutboundStreams;verifyAddressTimeout;started;constructor(e,t){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix??DA}/${CA}/${PA}`,this.timeout=t.timeout??3e4,this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1,this.startupDelay=t.startupDelay??5e3,this.refreshInterval=t.refreshInterval??6e4,this._verifyExternalAddresses=this._verifyExternalAddresses.bind(this)}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{qe.error("error handling incoming autonat stream",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.startupDelay),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),clearTimeout(this.verifyAddressTimeout),this.started=!1}async handleIncomingAutonatStream(e){let t=AbortSignal.timeout(this.timeout),n=()=>{e.stream.abort(new b("handleIncomingAutonatStream timeout",$.ERR_TIMEOUT))};t.addEventListener("abort",n,{once:!0}),nt(1/0,t);let i=this.components.addressManager.getAddresses().map(s=>s.toOptions().host);try{let s=this;await Te(e.stream,o=>vt(o),async function*(o){let a=await rn(o);if(a==null){qe("no message received"),yield De.encode({type:De.MessageType.DIAL_RESPONSE,dialResponse:{status:De.ResponseStatus.E_BAD_REQUEST,statusText:"No message was sent"}});return}let c;try{c=De.decode(a)}catch(m){qe.error("could not decode message",m),yield De.encode({type:De.MessageType.DIAL_RESPONSE,dialResponse:{status:De.ResponseStatus.E_BAD_REQUEST,statusText:"Could not decode message"}});return}let l=c.dial;if(l==null){qe.error("dial was missing from message"),yield De.encode({type:De.MessageType.DIAL_RESPONSE,dialResponse:{status:De.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}});return}let u,f=l.peer;if(f==null||f.id==null){qe.error("PeerId missing from message"),yield De.encode({type:De.MessageType.DIAL_RESPONSE,dialResponse:{status:De.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}});return}try{u=it(f.id)}catch(m){qe.error("invalid PeerId",m),yield De.encode({type:De.MessageType.DIAL_RESPONSE,dialResponse:{status:De.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}});return}if(qe("incoming request from %p",u),!e.connection.remotePeer.equals(u)){qe("target peer %p did not equal sending peer %p",u,e.connection.remotePeer),yield De.encode({type:De.MessageType.DIAL_RESPONSE,dialResponse:{status:De.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}});return}let h=f.addrs.map(m=>se(m)).filter(m=>{let g=m.toOptions().host===e.connection.remoteAddr.toOptions().host;return qe.trace("request to dial %a was sent from %a is same host %s",m,e.connection.remoteAddr,g),g}).filter(m=>{let g=m.toOptions().host,y=!(Br(g)??!1);return qe.trace("host %s was public %s",g,y),y}).filter(m=>{let g=m.toOptions().host,y=!i.includes(g);return qe.trace("host %s was not our host %s",g,y),y}).filter(m=>{let g=!!s.components.transportManager.transportForMultiaddr(m);return qe.trace("transport for %a is supported %s",m,g),g}).map(m=>(m.getPeerId()==null&&(m=m.encapsulate(`/p2p/${u.toString()}`)),m));if(h.length===0){qe("no valid multiaddrs for %p in message",u),yield De.encode({type:De.MessageType.DIAL_RESPONSE,dialResponse:{status:De.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}});return}qe("dial multiaddrs %s for peer %p",h.map(m=>m.toString()).join(", "),u);let d="",p=h[0];for await(let m of h){let g;p=m;try{if(g=await s.components.connectionManager.openConnection(m,{signal:t}),!g.remoteAddr.equals(m))throw qe.error("tried to dial %a but dialed %a",m,g.remoteAddr),new Error("Unexpected remote address");qe("Success %p",u),yield De.encode({type:De.MessageType.DIAL_RESPONSE,dialResponse:{status:De.ResponseStatus.OK,addr:g.remoteAddr.decapsulateCode(ye("p2p").code).bytes}});return}catch(y){qe("could not dial %p",u,y),d=y.message}finally{g!=null&&await g.close()}}yield De.encode({type:De.MessageType.DIAL_RESPONSE,dialResponse:{status:De.ResponseStatus.E_DIAL_ERROR,statusText:d,addr:p.bytes}})},o=>Rt(o),e.stream)}catch(s){qe.error("error handling incoming autonat stream",s)}finally{t.removeEventListener("abort",n)}}_verifyExternalAddresses(){this.verifyExternalAddresses().catch(e=>{qe.error("error verifying external address",e)})}async verifyExternalAddresses(){if(clearTimeout(this.verifyAddressTimeout),!this.isStarted())return;let e=this.components.addressManager,t=e.getObservedAddrs().filter(s=>{let o=s.toOptions();return!(Br(o.host)??!1)});if(t.length===0){qe("no public addresses found, not requesting verification"),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval);return}let n=AbortSignal.timeout(this.timeout);nt(1/0,n);let i=this;try{qe("verify multiaddrs %s",t.map(f=>f.toString()).join(", "));let s=De.encode({type:De.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toBytes(),addrs:t.map(f=>f.bytes)}}}),a=(await Bf()).toBytes(),c={},l=[],u=async f=>{let h=()=>{};try{qe("asking %p to verify multiaddr",f.id);let d=await i.components.connectionManager.openConnection(f.id,{signal:n}),p=await d.newStream(this.protocol,{signal:n});h=()=>{p.abort(new b("verifyAddress timeout",$.ERR_TIMEOUT))},n.addEventListener("abort",h,{once:!0});let m=await Te([s],y=>Rt(y),p,y=>vt(y),async y=>rn(y));if(m==null){qe("no response received from %p",d.remotePeer);return}let g=De.decode(m);if(g.type!==De.MessageType.DIAL_RESPONSE||g.dialResponse==null){qe("invalid autonat response from %p",d.remotePeer);return}if(g.dialResponse.status===De.ResponseStatus.OK){let y=d.remoteAddr.toOptions(),w;if(y.family===4)w=y.host.split(".")[0];else if(y.family===6)w=y.host.split(":")[0];else{qe('remote address "%s" was not IP4 or IP6?',y.host);return}if(l.includes(w)){qe("already have response from network segment %d - %s",w,y.host);return}l.push(w)}return g.dialResponse}catch(d){qe.error("error asking remote to verify multiaddr",d)}finally{n.removeEventListener("abort",h)}};for await(let f of jo(zr(this.components.peerRouting.getClosestPeers(a,{signal:n}),h=>async()=>u(h)),{concurrency:Gg}))try{if(f==null)continue;let h=f.addr==null?t[0]:se(f.addr);if(qe("autonat response for %a is %s",h,f.status),f.status===De.ResponseStatus.E_BAD_REQUEST||f.status===De.ResponseStatus.E_DIAL_REFUSED||f.addr==null&&t.length>1)continue;if(!t.some(p=>p.equals(h))){qe("peer reported %a as %s but it was not in our observed address list",h,f.status);continue}let d=h.toString();if(c[d]==null&&(c[d]={success:0,failure:0}),f.status===De.ResponseStatus.OK?c[d].success++:f.status===De.ResponseStatus.E_DIAL_ERROR&&c[d].failure++,c[d].success===Gg){qe("%a is externally dialable",h),e.confirmObservedAddr(h);return}if(c[d].failure===Gg){qe("%a is not externally dialable",h),e.removeObservedAddr(h);return}}catch(h){qe.error("could not verify external address",h)}}finally{this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval)}}};function kA(r={}){return e=>new Yg(e,r)}var Qg="/libp2p/relay";var NA="circuit-relay-relay";var T$=BigInt(131072),js="/libp2p/circuit/relay/0.2.0/hop",d1="/libp2p/circuit/relay/0.2.0/stop",D$=30*1e3,C$=30*1e3;var ns;(function(r){let e;(function(i){i.RESERVE="RESERVE",i.CONNECT="CONNECT",i.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(i){i[i.RESERVE=0]="RESERVE",i[i.CONNECT=1]="CONNECT",i[i.STATUS=2]="STATUS"})(t||(t={})),function(i){i.codec=()=>ht(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=fe((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.type!=null&&(s.uint32(8),r.Type.codec().encode(i.type,s)),i.peer!=null&&(s.uint32(18),Mc.codec().encode(i.peer,s)),i.reservation!=null&&(s.uint32(26),p1.codec().encode(i.reservation,s)),i.limit!=null&&(s.uint32(34),Uc.codec().encode(i.limit,s)),i.status!=null&&(s.uint32(40),qt.codec().encode(i.status,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{let o={},a=s==null?i.len:i.pos+s;for(;i.pos<a;){let c=i.uint32();switch(c>>>3){case 1:o.type=r.Type.codec().decode(i);break;case 2:o.peer=Mc.codec().decode(i,i.uint32());break;case 3:o.reservation=p1.codec().decode(i,i.uint32());break;case 4:o.limit=Uc.codec().decode(i,i.uint32());break;case 5:o.status=qt.codec().decode(i);break;default:i.skipType(c&7);break}}return o})),n),r.encode=i=>ue(i,r.codec()),r.decode=i=>le(i,r.codec())})(ns||(ns={}));var ii;(function(r){let e;(function(i){i.CONNECT="CONNECT",i.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(i){i[i.CONNECT=0]="CONNECT",i[i.STATUS=1]="STATUS"})(t||(t={})),function(i){i.codec=()=>ht(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=fe((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.type!=null&&(s.uint32(8),r.Type.codec().encode(i.type,s)),i.peer!=null&&(s.uint32(18),Mc.codec().encode(i.peer,s)),i.limit!=null&&(s.uint32(26),Uc.codec().encode(i.limit,s)),i.status!=null&&(s.uint32(32),qt.codec().encode(i.status,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{let o={},a=s==null?i.len:i.pos+s;for(;i.pos<a;){let c=i.uint32();switch(c>>>3){case 1:o.type=r.Type.codec().decode(i);break;case 2:o.peer=Mc.codec().decode(i,i.uint32());break;case 3:o.limit=Uc.codec().decode(i,i.uint32());break;case 4:o.status=qt.codec().decode(i);break;default:i.skipType(c&7);break}}return o})),n),r.encode=i=>ue(i,r.codec()),r.decode=i=>le(i,r.codec())})(ii||(ii={}));var Mc;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(let s of t.addrs)n.uint32(18),n.bytes(s);i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={id:new Uint8Array(0),addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.id=t.bytes();break;case 2:i.addrs.push(t.bytes());break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(Mc||(Mc={}));var p1;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(let s of t.addrs)n.uint32(18),n.bytes(s);t.voucher!=null&&(n.uint32(26),n.bytes(t.voucher)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={expire:0n,addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.expire=t.uint64();break;case 2:i.addrs.push(t.bytes());break;case 3:i.voucher=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(p1||(p1={}));var Uc;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.duration=t.uint32();break;case 2:i.data=t.uint64();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(Uc||(Uc={}));var qt;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(qt||(qt={}));var Xg;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(Xg||(Xg={}));(function(r){r.codec=()=>ht(Xg)})(qt||(qt={}));var jg;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={relay:new Uint8Array(0),peer:new Uint8Array(0),expiration:0n},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.relay=t.bytes();break;case 2:i.peer=t.bytes();break;case 3:i.expiration=t.uint64();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(jg||(jg={}));var w9e=D("libp2p:circuit-relay:utils");async function Zg(r){let e=new TextEncoder().encode(r),t=await Oe.digest(e);return be.createV0(t)}function Jg(r){let e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}var k$=de(UA(),1);var L9e=D("libp2p:circuit-relay:advert-service");var hbe=D("libp2p:circuit-relay:server");var N$=D("libp2p:stream:converter");function e8(r){let{stream:e,remoteAddr:t}=r,{sink:n,source:i}=e,s=async function*(){for await(let c of i)c instanceof Uint8Array?yield c:yield*c}(),o={async sink(c){try{await n(c),a()}catch(l){l.type!=="aborted"&&N$(l)}},source:s,remoteAddr:t,timeline:{open:Date.now(),close:void 0},async close(c){a(),await e.close(c)},abort(c){a(),e.abort(c)}};function a(){o.timeline.close==null&&(o.timeline.close=Date.now())}return o}var Zs=D("libp2p:circuit-relay:discover-relays"),m1=class extends Fe{peerId;peerStore;contentRouting;registrar;started;topologyId;constructor(e){super(),this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.contentRouting=e.contentRouting,this.registrar=e.registrar}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(js,{notifyOnTransient:!0,onConnect:e=>{this.safeDispatchEvent("relay:discover",{detail:e})}}),this.discover().catch(e=>{Zs.error("error listening on relays",e)}),this.started=!0}stop(){this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async discover(){Zs("searching peer store for relays");let e=await this.peerStore.all({filters:[t=>t.protocols.includes(js)],orders:[()=>Math.random()<.5?1:-1]});for(let t of e)Zs("found relay peer %p in content peer store",t.id),this.safeDispatchEvent("relay:discover",{detail:t.id});Zs("found %d relay peers in peer store",e.length);try{Zs("searching content routing for relays");let t=await Zg(Qg),n=0;for await(let i of this.contentRouting.findProviders(t))if(i.multiaddrs.length>0&&!i.id.equals(this.peerId)){let s=i.id;n++,await this.peerStore.merge(s,{multiaddrs:i.multiaddrs}),Zs("found relay peer %p in content routing",s),this.safeDispatchEvent("relay:discover",{detail:s})}Zs("found %d relay peers in content routing",n)}catch(t){Zs.error("failed when finding relays on the network",t)}}};var g1=D("libp2p:circuit-relay:transport:listener"),t8=class extends Fe{connectionManager;relayStore;listeningAddrs;constructor(e){super(),this.connectionManager=e.connectionManager,this.relayStore=e.relayStore,this.listeningAddrs=new Xt,this.relayStore.addEventListener("relay:removed",this._onRemoveRelayPeer)}_onRemoveRelayPeer=e=>{this.#e(e.detail)};async listen(e){g1("listen on %a",e);let t=e.decapsulate("/p2p-circuit"),n=await this.connectionManager.openConnection(t);if(!this.relayStore.hasReservation(n.remotePeer)){await this.relayStore.addRelay(n.remotePeer,"configured");return}let i=this.relayStore.getReservation(n.remotePeer);if(i==null)throw new b("Did not have reservation after making reservation","ERR_NO_RESERVATION");if(this.listeningAddrs.has(n.remotePeer)){g1("already listening on relay %p",n.remotePeer);return}this.listeningAddrs.set(n.remotePeer,i.addrs.map(s=>se(s).encapsulate("/p2p-circuit"))),this.safeDispatchEvent("listening",{})}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){}#e(e){let t=this.listeningAddrs.has(e);g1("relay peer removed %p - had reservation",e,t),this.listeningAddrs.delete(e),t&&(g1.trace("removing relay event listener for peer %p",e),this.relayStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),this.safeDispatchEvent("close",{}))}};function KA(r){return new t8(r)}var Dr=D("libp2p:circuit-relay:transport:reservation-store"),L$=60*1e3*10,B$=60*1e3*5,M$=30*1e3,y1=class extends Fe{peerId;connectionManager;transportManager;peerStore;events;reserveQueue;reservations;maxDiscoveredRelays;maxReservationQueueLength;reservationCompletionTimeout;started;constructor(e,t){super(),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Xt,this.maxDiscoveredRelays=t?.discoverRelays??0,this.maxReservationQueueLength=t?.maxReservationQueueLength??100,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??1e4,this.started=!1,this.reserveQueue=new nc({concurrency:t?.reservationConcurrency??1}),this.events.addEventListener("peer:disconnect",n=>{this.#t(n.detail)})}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}async addRelay(e,t){if(this.peerId.equals(e)){Dr("not trying to use self as relay");return}if(this.reserveQueue.size>this.maxReservationQueueLength){Dr("not adding relay as the queue is full");return}if(this.reserveQueue.hasJob(e)){Dr("relay peer is already in the reservation queue");return}Dr("add relay %p",e),await this.reserveQueue.add(async()=>{try{let n=this.reservations.get(e);if(n!=null){if(Jg(n.reservation.expire)>L$){Dr("already have reservation on relay peer %p and it expires in more than 10 minutes",e);return}clearTimeout(n.timeout),this.reservations.delete(e)}if(t==="discovered"&&[...this.reservations.values()].reduce((u,f)=>(f.type==="discovered"&&u++,u),0)>=this.maxDiscoveredRelays){Dr("already have enough discovered relays");return}let i=AbortSignal.timeout(this.reservationCompletionTimeout),s=await this.connectionManager.openConnection(e,{signal:i});if(s.remoteAddr.protoNames().includes("p2p-circuit")){Dr("not creating reservation over relayed connection");return}let o=await this.#e(s,{signal:i});Dr("created reservation on relay peer %p",e);let a=Jg(o.expire),c=Math.min(Math.max(a-B$,M$),Math.pow(2,31)-1),l=setTimeout(()=>{this.addRelay(e,t).catch(u=>{Dr.error("could not refresh reservation to relay %p",e,u)})},c);this.reservations.set(e,{timeout:l,reservation:o,type:t}),await this.peerStore.merge(e,{tags:{[NA]:{value:1,ttl:a}}}),await this.transportManager.listen([se(`/p2p/${e.toString()}/p2p-circuit`)])}catch(n){Dr.error("could not reserve slot on %p",e,n);let i=this.reservations.get(e);i!=null&&clearTimeout(i.timeout),this.reservations.delete(e)}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}async#e(e,t){t.signal?.throwIfAborted(),Dr("requesting reservation from %p",e.remotePeer);let n=await e.newStream(js,t),s=rr(n).pb(ns);await s.write({type:ns.Type.RESERVE},t);let o;try{o=await s.read(t)}catch(c){throw Dr.error("error parsing reserve message response from %p because",e.remotePeer,c),c}finally{await n.close()}if(o.status===qt.OK&&o.reservation!=null)return o.reservation;let a=`reservation failed with status ${o.status??"undefined"}`;throw Dr.error(a),new Error(a)}#t(e){let t=this.reservations.get(e);t!=null&&(Dr("connection to relay %p closed, removing reservation from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),this.safeDispatchEvent("relay:removed",{detail:e}),this.reservations.size<this.maxDiscoveredRelays&&(Dr("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))}};var br=D("libp2p:circuit-relay:transport"),U$=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(se)}catch{return!1}return!0},r8={maxInboundStopStreams:Os,maxOutboundStopStreams:Os,stopTimeout:3e4},n8=class{discovery;registrar;peerStore;connectionManager;peerId;upgrader;addressManager;connectionGater;reservationStore;maxInboundStopStreams;maxOutboundStopStreams;stopTimeout;started;constructor(e,t){this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??r8.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??r8.maxOutboundStopStreams,this.stopTimeout=t.stopTimeout??r8.stopTimeout,t.discoverRelays!=null&&t.discoverRelays>0&&(this.discovery=new m1(e),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(i=>{br.error("could not add discovered relay %p",n.detail,i)})})),this.reservationStore=new y1(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.discover().catch(n=>{br.error("could not discover relays",n)})}),this.started=!1}isStarted(){return this.started}async start(){await this.reservationStore.start(),await this.discovery?.start(),await this.registrar.handle(d1,e=>{this.onStop(e).catch(t=>{br.error("error while handling STOP protocol",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnTransientConnection:!0}),this.started=!0}async stop(){this.discovery?.stop(),await this.reservationStore.stop(),await this.registrar.unhandle(d1),this.started=!1}[yi]=!0;[Symbol.toStringTag]="libp2p/circuit-relay-v2";async dial(e,t={}){if(e.protoCodes().filter(p=>p===290).length!==1){let p="Invalid circuit relay address";throw br.error(p,e),new b(p,$.ERR_RELAYED_DIAL)}let n=e.toString().split("/p2p-circuit"),i=se(n[0]),s=se(n[n.length-1]),o=i.getPeerId(),a=s.getPeerId();if(o==null||a==null){let p=`Circuit relay dial to ${e.toString()} failed as address did not have peer ids`;throw br.error(p),new b(p,$.ERR_RELAYED_DIAL)}let c=ae(o),l=ae(a),u=!1,h=this.connectionManager.getConnections(c)[0];h==null&&(await this.peerStore.merge(c,{multiaddrs:[i]}),h=await this.connectionManager.openConnection(c,t),u=!0);let d;try{return d=await h.newStream([js]),await this.connectV2({stream:d,connection:h,destinationPeer:l,destinationAddr:s,relayAddr:i,ma:e,disconnectOnFailure:u})}catch(p){throw br.error("circuit relay dial to destination %p via relay %p failed",l,c,p),d?.abort(p),u&&await h.close(),p}}async connectV2({stream:e,connection:t,destinationPeer:n,destinationAddr:i,relayAddr:s,ma:o,disconnectOnFailure:a}){try{let c=rr(e),l=c.pb(ns);await l.write({type:ns.Type.CONNECT,peer:{id:n.toBytes(),addrs:[se(i).bytes]}});let u=await l.read();if(u.status!==qt.OK)throw new b(`failed to connect via relay with status ${u?.status?.toString()??"undefined"}`,$.ERR_HOP_REQUEST_FAILED);let f=e8({stream:c.unwrap(),remoteAddr:o,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`)});return br("new outbound transient connection %a",f.remoteAddr),await this.upgrader.upgradeOutbound(f,{transient:!0})}catch(c){throw br.error(`Circuit relay dial to destination ${n.toString()} via relay ${t.remotePeer.toString()} failed`,c),a&&await t.close(),c}}createListener(e){return KA({connectionManager:this.connectionManager,relayStore:this.reservationStore})}filter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>ti.matches(t))}async onStop({connection:e,stream:t}){let n=AbortSignal.timeout(this.stopTimeout),i=rr(t).pb(ii),s=await i.read({signal:n});if(br("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,s.type),s?.type===void 0){br.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await i.write({type:ii.Type.STATUS,status:qt.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(s.type!==ii.Type.CONNECT){br.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:ii.Type.STATUS,status:qt.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!U$(s)){br.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:ii.Type.STATUS,status:qt.MALFORMED_MESSAGE},{signal:n}),await t.close();return}let o=it(s.peer.id);if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,o)===!0){br.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await i.write({type:ii.Type.STATUS,status:qt.PERMISSION_DENIED},{signal:n}),await t.close();return}br.trace("sending success response to %p",e.remotePeer),await i.write({type:ii.Type.STATUS,status:qt.OK},{signal:n});let a=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`),c=this.addressManager.getAddresses()[0],l=e8({stream:i.unwrap().unwrap(),remoteAddr:a,localAddr:c});br("new inbound transient connection %a",l.remoteAddr),await this.upgrader.upgradeInbound(l,{transient:!0}),br("%s connection %a upgraded","inbound",l.remoteAddr)}};function i8(r={}){return e=>new n8(e,r)}var VA=()=>{let r=new Error("Delay aborted");return r.name="AbortError",r},F$=new WeakMap;function K$({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:i}={})=>{if(i?.aborted)return Promise.reject(VA());let s,o,a,c=r??clearTimeout,l=()=>{c(s),a(VA())},u=()=>{i&&i.removeEventListener("abort",l)},f=new Promise((h,d)=>{o=()=>{u(),h(n)},a=d,s=(e??setTimeout)(o,t)});return i&&i.addEventListener("abort",l,{once:!0}),F$.set(f,()=>{c(s),s=null,o()}),f}}var V$=K$(),qA=V$;var si;(function(r){let e;(function(i){i.UNUSED="UNUSED",i.CONNECT="CONNECT",i.SYNC="SYNC"})(e=r.Type||(r.Type={}));let t;(function(i){i[i.UNUSED=0]="UNUSED",i[i.CONNECT=100]="CONNECT",i[i.SYNC=300]="SYNC"})(t||(t={})),function(i){i.codec=()=>ht(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=fe((i,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),i.type!=null&&(s.uint32(8),r.Type.codec().encode(i.type,s)),i.observedAddresses!=null)for(let a of i.observedAddresses)s.uint32(18),s.bytes(a);o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{let o={observedAddresses:[]},a=s==null?i.len:i.pos+s;for(;i.pos<a;){let c=i.uint32();switch(c>>>3){case 1:o.type=r.Type.codec().decode(i);break;case 2:o.observedAddresses.push(i.bytes());break;default:i.skipType(c&7);break}}return o})),n),r.encode=i=>ue(i,r.codec()),r.decode=i=>le(i,r.codec())})(si||(si={}));function s8(r,e){return Yl.matches(r)||e.transportForMultiaddr(r)==null?!1:zw.matches(r)?!0:Gw.matches(r)?Br(r.toOptions().host)===!1:!1}var mt=D("libp2p:dcutr"),zA=1024*4,$A=100,b1={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1},w1=class{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;constructor(e,t){this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??b1.timeout,this.retries=t.retries??b1.retries,this.maxInboundStreams=t.maxInboundStreams??b1.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??b1.maxOutboundStreams}isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(Uu,{notifyOnTransient:!0,onConnect:(e,t)=>{t.transient&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{mt.error("error during outgoing DCUtR attempt",n)})}}),await this.registrar.handle(Uu,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{mt.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(Uu),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){let i={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([Uu],{signal:i.signal,runOnTransientConnection:!0});let s=rr(t,{maxDataLength:zA}).pb(si);mt("B sending connect to %p",e.remotePeer);let o=Date.now();await s.write({type:si.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(f=>f.bytes)},i),mt("B receiving connect from %p",e.remotePeer);let a=await s.read(i);if(a.type!==si.Type.CONNECT)throw mt("A sent wrong message type"),new b("DCUtR message type was incorrect",$.ERR_INVALID_MESSAGE);let c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw mt("A did not have any dialable multiaddrs"),new b("DCUtR connect message had no multiaddrs",$.ERR_INVALID_MESSAGE);let l=Date.now()-o;mt("A sending sync, rtt %dms",l),await s.write({type:si.Type.SYNC,observedAddresses:[]},i),mt("A waiting for half RTT"),await qA(l/2),mt("B dialing",c);let u=await this.connectionManager.openConnection(c,{signal:i.signal,priority:$A});mt("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,u.remoteAddr),await e.close(i);break}catch(s){if(mt.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,s),t?.abort(s),n===this.retries)throw s}finally{t!=null&&await t.close(i)}}}async attemptUnilateralConnectionUpgrade(e){let n=(await this.peerStore.get(e.remotePeer)).addresses.map(i=>{let s=i.multiaddr;return s.getPeerId()==null?s.encapsulate(`/p2p/${e.remotePeer}`):s}).filter(i=>s8(i,this.transportManager));if(n.length>0){let i=AbortSignal.timeout(this.timeout);try{mt("attempting unilateral connection upgrade to %a",n);let s=await this.connectionManager.openConnection(n,{signal:i,force:!0});if(s.transient)throw new Error("Could not open a new, non-transient, connection");return mt("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,s.remoteAddr),await e.close({signal:i}),!0}catch(s){mt.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,n,s)}}else mt("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){let n={signal:AbortSignal.timeout(this.timeout)};try{let i=rr(e,{maxDataLength:zA}).pb(si);mt("A receiving connect");let s=await i.read(n);if(s.type!==si.Type.CONNECT)throw mt("B sent wrong message type"),new b("DCUtR message type was incorrect",$.ERR_INVALID_MESSAGE);if(s.observedAddresses.length===0)throw mt("B sent no multiaddrs"),new b("DCUtR connect message had no multiaddrs",$.ERR_INVALID_MESSAGE);let o=this.getDialableMultiaddrs(s.observedAddresses);if(o.length===0)throw mt("B had no dialable multiaddrs"),new b("DCUtR connect message had no dialable multiaddrs",$.ERR_INVALID_MESSAGE);if(mt("A sending connect"),await i.write({type:si.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),mt("A receiving sync"),(await i.read(n)).type!==si.Type.SYNC)throw new b("DCUtR message type was incorrect",$.ERR_INVALID_MESSAGE);mt("A dialing",o);let c=await this.connectionManager.openConnection(o,{signal:n.signal,priority:$A,force:!0});mt("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n)}catch(i){mt.error("incoming DCUtR from %p failed",t.remotePeer,i),e.abort(i)}finally{await e.close(n)}}getDialableMultiaddrs(e){let t=[];for(let n of e)if(!(n==null||n.length===0))try{let i=se(n);if(!s8(i,this.transportManager))continue;t.push(i)}catch{}return t}};var Uu="/libp2p/dcutr";function HA(r={}){return e=>new w1(e,r)}var WA="0.46.17";var o8=`js-libp2p/${WA}`;var GA="0.1.0",YA="id",QA="id/push",XA="1.0.0",jA="1.0.0";var Js;(function(r){let e;r.codec=()=>(e==null&&(e=fe((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(let s of t.listenAddrs)n.uint32(18),n.bytes(s);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(let s of t.protocols)n.uint32(26),n.string(s);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={listenAddrs:[],protocols:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 5:i.protocolVersion=t.string();break;case 6:i.agentVersion=t.string();break;case 1:i.publicKey=t.bytes();break;case 2:i.listenAddrs.push(t.bytes());break;case 4:i.observedAddr=t.bytes();break;case 3:i.protocols.push(t.string());break;case 8:i.signedPeerRecord=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ue(t,r.codec()),r.decode=t=>le(t,r.codec())})(Js||(Js={}));var nr=D("libp2p:identify"),a8=1024*8,un={protocolPrefix:"ipfs",agentVersion:o8,timeout:6e4,maxInboundStreams:1,maxOutboundStreams:1,maxPushIncomingStreams:1,maxPushOutgoingStreams:1,maxObservedAddresses:10,maxIdentifyMessageSize:8192,runOnConnectionOpen:!0,runOnTransientConnection:!0},E1=class{identifyProtocolStr;identifyPushProtocolStr;host;started;timeout;peerId;peerStore;registrar;connectionManager;addressManager;maxInboundStreams;maxOutboundStreams;maxPushIncomingStreams;maxPushOutgoingStreams;maxIdentifyMessageSize;maxObservedAddresses;events;runOnTransientConnection;constructor(e,t){this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.events=e.events,this.identifyProtocolStr=`/${t.protocolPrefix??un.protocolPrefix}/${YA}/${XA}`,this.identifyPushProtocolStr=`/${t.protocolPrefix??un.protocolPrefix}/${QA}/${jA}`,this.timeout=t.timeout??un.timeout,this.maxInboundStreams=t.maxInboundStreams??un.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??un.maxOutboundStreams,this.maxPushIncomingStreams=t.maxPushIncomingStreams??un.maxPushIncomingStreams,this.maxPushOutgoingStreams=t.maxPushOutgoingStreams??un.maxPushOutgoingStreams,this.maxIdentifyMessageSize=t.maxIdentifyMessageSize??un.maxIdentifyMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??un.maxObservedAddresses,this.runOnTransientConnection=t.runOnTransientConnection??un.runOnTransientConnection,this.host={protocolVersion:`${t.protocolPrefix??un.protocolPrefix}/${GA}`,agentVersion:t.agentVersion??un.agentVersion},(t.runOnConnectionOpen??un.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{let i=n.detail;this.identify(i).catch(s=>{nr.error("error during identify trigged by connection:open",s)})}),e.events.addEventListener("self:peer:update",n=>{this.push().catch(i=>{nr.error(i)})}),this.host.agentVersion===o8&&(gA||pA?this.host.agentVersion+=` UserAgent=${globalThis.process.version}`:(u1||f1||mA||yA)&&(this.host.agentVersion+=` UserAgent=${globalThis.navigator.userAgent}`))}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:Y(this.host.agentVersion),ProtocolVersion:Y(this.host.protocolVersion)}}),await this.registrar.handle(this.identifyProtocolStr,e=>{this._handleIdentify(e).catch(t=>{nr.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),await this.registrar.handle(this.identifyPushProtocolStr,e=>{this._handlePush(e).catch(t=>{nr.error(t)})},{maxInboundStreams:this.maxPushIncomingStreams,maxOutboundStreams:this.maxPushOutgoingStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.identifyProtocolStr),await this.registrar.unhandle(this.identifyPushProtocolStr),this.started=!1}async pushToConnections(e){let t=this.addressManager.getAddresses().map(u=>u.decapsulateCode(ye("p2p").code)),n=new Jr({peerId:this.peerId,multiaddrs:t}),i=await Sn.seal(n,this.peerId),s=this.registrar.getProtocols(),o=await this.peerStore.get(this.peerId),a=H(o.metadata.get("AgentVersion")??Y(this.host.agentVersion)),c=H(o.metadata.get("ProtocolVersion")??Y(this.host.protocolVersion)),l=e.map(async u=>{let f,h=AbortSignal.timeout(this.timeout);nt(1/0,h);try{f=await u.newStream([this.identifyPushProtocolStr],{signal:h,runOnTransientConnection:this.runOnTransientConnection}),await rr(f,{maxDataLength:this.maxIdentifyMessageSize??a8}).pb(Js).write({listenAddrs:t.map(p=>p.bytes),signedPeerRecord:i.marshal(),protocols:s,agentVersion:a,protocolVersion:c},{signal:h}),await f.close({signal:h})}catch(d){nr.error("could not push identify update to peer",d),f?.abort(d)}});await Promise.all(l)}async push(){if(!this.isStarted())return;let e=[];await Promise.all(this.connectionManager.getConnections().map(async t=>{try{if(!(await this.peerStore.get(t.remotePeer)).protocols.includes(this.identifyPushProtocolStr))return;e.push(t)}catch(n){if(n.code!==$.ERR_NOT_FOUND)throw n}})),await this.pushToConnections(e)}async _identify(e,t={}){let n;t.signal=t.signal??AbortSignal.timeout(this.timeout);try{n=await e.newStream([this.identifyProtocolStr],{...t,runOnTransientConnection:this.runOnTransientConnection});let s=await rr(n,{maxDataLength:this.maxIdentifyMessageSize??a8}).pb(Js).read(t);return await n.close(t),s}catch(i){throw nr.error("error while reading identify message",i),n?.abort(i),i}}async identify(e,t={}){let n=await this._identify(e,t),{publicKey:i,protocols:s,observedAddr:o}=n;if(i==null)throw new b("public key was missing from identify message",$.ERR_MISSING_PUBLIC_KEY);let a=await ar(i);if(!e.remotePeer.equals(a))throw new b("identified peer does not match the expected peer",$.ERR_INVALID_PEER);if(this.peerId.equals(a))throw new b("identified peer is our own peer id?",$.ERR_INVALID_PEER);let c=q$(o);return nr("identify completed for peer %p and protocols %o",a,s),nr("our observed address is %a",c),c!=null&&this.addressManager.getObservedAddrs().length<(this.maxObservedAddresses??1/0)&&(nr("storing our observed address %a",c),this.addressManager.addObservedAddr(c)),this.#e(e,n)}async _handleIdentify(e){let{connection:t,stream:n}=e,i=AbortSignal.timeout(this.timeout);nt(1/0,i);try{let s=this.peerId.publicKey??new Uint8Array(0),o=await this.peerStore.get(this.peerId),a=this.addressManager.getAddresses().map(u=>u.decapsulateCode(ye("p2p").code)),c=o.peerRecordEnvelope;if(a.length>0&&c==null){let u=new Jr({peerId:this.peerId,multiaddrs:a});c=(await Sn.seal(u,this.peerId)).marshal().subarray()}await rr(n).pb(Js).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:s,listenAddrs:a.map(u=>u.bytes),signedPeerRecord:c,observedAddr:t.remoteAddr.bytes,protocols:o.protocols},{signal:i}),await n.close({signal:i})}catch(s){nr.error("could not respond to identify request",s),n.abort(s)}}async _handlePush(e){let{connection:t,stream:n}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");let i={signal:AbortSignal.timeout(this.timeout)},o=await rr(n,{maxDataLength:this.maxIdentifyMessageSize??a8}).pb(Js).read(i);await n.close(i),await this.#e(t,o)}catch(i){nr.error("received invalid message",i),n.abort(i);return}nr("handled push from %p",t.remotePeer)}async#e(e,t){if(nr("received identify from %p",e.remotePeer),t==null)throw new b("message was null or undefined","ERR_INVALID_MESSAGE");let n={};if(t.listenAddrs.length>0&&(n.addresses=t.listenAddrs.map(o=>({isCertified:!1,multiaddr:se(o)}))),t.protocols.length>0&&(n.protocols=t.protocols),t.publicKey!=null&&(n.publicKey=t.publicKey,!(await ar(t.publicKey)).equals(e.remotePeer)))throw new b("public key did not match remote PeerId","ERR_INVALID_PUBLIC_KEY");let i;if(t.signedPeerRecord!=null){nr("received signedPeerRecord in push from %p",e.remotePeer);let o=t.signedPeerRecord,a=await Sn.openAndCertify(o,Jr.DOMAIN),c=Jr.createFromProtobuf(a.payload);if(!c.peerId.equals(a.peerId))throw new b("signing key does not match PeerId in the PeerRecord","ERR_INVALID_SIGNING_KEY");if(!e.remotePeer.equals(c.peerId))throw new b("signing key does not match remote PeerId","ERR_INVALID_PEER_RECORD_KEY");let l;try{l=await this.peerStore.get(c.peerId)}catch(u){if(u.code!=="ERR_NOT_FOUND")throw u}if(l!=null&&(n.metadata=l.metadata,l.peerRecordEnvelope!=null)){let u=await Sn.createFromProtobuf(l.peerRecordEnvelope),f=Jr.createFromProtobuf(u.payload);f.seqNumber>=c.seqNumber&&(nr("sequence number was lower or equal to existing sequence number - stored: %d received: %d",f.seqNumber,c.seqNumber),c=f,o=l.peerRecordEnvelope)}n.peerRecordEnvelope=o,n.addresses=c.multiaddrs.map(u=>({isCertified:!0,multiaddr:u})),i={seq:c.seqNumber,addresses:c.multiaddrs}}else nr("%p did not send a signed peer record",e.remotePeer);if(nr("patching %p with",n),await this.peerStore.patch(e.remotePeer,n),t.agentVersion!=null||t.protocolVersion!=null){let o={};t.agentVersion!=null&&(o.AgentVersion=Y(t.agentVersion)),t.protocolVersion!=null&&(o.ProtocolVersion=Y(t.protocolVersion)),nr("updating %p metadata",n),await this.peerStore.merge(e.remotePeer,{metadata:o})}let s={peerId:e.remotePeer,protocolVersion:t.protocolVersion,agentVersion:t.agentVersion,publicKey:t.publicKey,listenAddrs:t.listenAddrs.map(o=>se(o)),observedAddr:t.observedAddr==null?void 0:se(t.observedAddr),protocols:t.protocols,signedPeerRecord:i,connection:e};return this.events.safeDispatchEvent("peer:identify",{detail:s}),s}};function q$(r){if(r!=null&&r.length>0)try{return se(r)}catch{}}function ZA(r={}){return e=>new E1(e,r)}var JA="1.0.0",eT="ping",tT="ipfs";var Fc=D("libp2p:ping"),c8=class{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnTransientConnection;constructor(e,t){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix??tT}/${eT}/${JA}`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnTransientConnection=t.runOnTransientConnection??!0}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){Fc("incoming ping from %p",e.connection.remotePeer);let{stream:t}=e,n=Date.now();Te(t,t).catch(i=>{Fc.error("incoming ping from %p failed with error",e.connection.remotePeer,i)}).finally(()=>{let i=Date.now()-n;Fc("incoming ping from %p complete in %dms",e.connection.remotePeer,i)})}async ping(e,t={}){Fc("pinging %p",e);let n=Date.now(),i=Or(32),s=await this.components.connectionManager.openConnection(e,t),o,a=()=>{};t.signal=t.signal??AbortSignal.timeout(this.timeout);try{o=await s.newStream(this.protocol,{...t,runOnTransientConnection:this.runOnTransientConnection}),a=()=>{o?.abort(new b("ping timeout",$.ERR_TIMEOUT))},t.signal.addEventListener("abort",a,{once:!0});let c=await Te([i],o,async u=>rn(u)),l=Date.now()-n;if(c==null)throw new b(`Did not receive a ping ack after ${l}ms`,$.ERR_WRONG_PING_ACK);if(!ce(i,c.subarray()))throw new b(`Received wrong ping ack after ${l}ms`,$.ERR_WRONG_PING_ACK);return Fc("ping %p complete in %dms",s.remotePeer,l),l}catch(c){throw Fc.error("error while pinging %p",s.remotePeer,c),o?.abort(c),c}finally{t.signal.removeEventListener("abort",a),o!=null&&await o.close()}}};function rT(r={}){return e=>new c8(e,r)}var nT={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function iT(){return{addresses:{listen:["/webrtc"]},transports:[i8({discoverRelays:1}),VI(),KI(),AA(),SA()],connectionEncryption:[gc()],streamMuxers:[N_(),YS()],peerDiscovery:[sS(nT)],services:{identify:ZA(),autoNAT:kA(),pubsub:qv(),dcutr:HA(),delegatedRouting:()=>G_("https://delegated-ipfs.dev"),dht:MS({clientMode:!0,validators:{ipns:rd},selectors:{ipns:TA}}),ping:rT()}}}async function sT(r,e){let t=iT();return e=e??{},gx({datastore:r,...t,...e,start:!1})}var oT="2.1.0",aT="helia";var G$=D("helia");async function Y$(r={}){let e=r.datastore??new so,t=r.blockstore??new Hc,n;Q$(r.libp2p)?n=r.libp2p:n=await sT(e,r.libp2p);let i=new W0({...r,datastore:e,blockstore:t,libp2p:n});return r.start!==!1&&await i.start(),X$(i),i}function Q$(r){return r==null?!1:["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(t=>typeof r[t]=="function")}function X$(r){try{if(r.libp2p.services.identify.host.agentVersion.match(/js-libp2p\/\d+\.\d+\.\d+\sUserAgent=/)==null)return;r.libp2p.services.identify.host.agentVersion=`${aT}/${oT} ${r.libp2p.services.identify.host.agentVersion}`}catch(e){G$.error("could not add Helia to agent version",e)}}return Ku(j$);})();
/*! Bundled license information:

@noble/hashes/esm/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/utils.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/modular.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/curve.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/edwards.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/montgomery.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/ed25519.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/weierstrass.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/_shortw_utils.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/ciphers/esm/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)

@libp2p/webtransport/dist/src/index.js:
  (*! TODO unclear how to add backpressure here? *)
*/
return Helia}));
